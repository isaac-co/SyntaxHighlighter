<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">json</span>
<span class="keyword">import</span> <span class="identifier">timeit</span>
<span class="keyword">import</span> <span class="identifier">pickle</span>
<span class="keyword">import</span> <span class="identifier">itertools</span>
<span class="keyword">from</span> <span class="identifier">abc</span> <span class="keyword">import</span> <span class="identifier">ABC</span><span class="punctuation">,</span> <span class="identifier">abstractmethod</span>
<span class="keyword">from</span> <span class="identifier">pathlib</span> <span class="keyword">import</span> <span class="identifier">Path</span>
<span class="keyword">from</span> <span class="identifier">multiprocessing</span> <span class="keyword">import</span> <span class="identifier">cpu_count</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>


<span class="keyword">def</span> <span class="identifier">get_from_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Get benchmarks configuration from the config.json file"""</span>
    <span class="identifier">current_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Path</span><span class="grouping">(</span><span class="identifier">__file__</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">resolve</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">parent</span>

    <span class="identifier">config_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">current_path</span> <span class="arithmetic-operator">/</span> <span class="string-literal">'config.json'</span>
    <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">config_path</span><span class="punctuation">,</span> <span class="string-literal">'r'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">config_file</span><span class="punctuation">:</span>
        <span class="identifier">config_file</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">''</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">line</span> <span class="keyword">for</span> <span class="identifier">line</span> <span class="relational-operator">in</span> <span class="identifier">config_file</span>
                              <span class="keyword">if</span> <span class="identifier">line</span> <span class="logical-operator">and</span> <span class="string-literal">'//'</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">line</span><span class="grouping">)</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">json</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">config_file</span><span class="grouping">)</span>

    <span class="identifier">profile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">getenv</span><span class="grouping">(</span><span class="string-literal">'SKLBENCH_PROFILE', config['profile'</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">n_jobs_vals_env</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">getenv</span><span class="grouping">(</span><span class="string-literal">'SKLBENCH_NJOBS'</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">n_jobs_vals_env</span><span class="punctuation">:</span>
        <span class="identifier">n_jobs_vals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">eval</span><span class="grouping">(</span><span class="identifier">n_jobs_vals_env</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">n_jobs_vals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">'n_jobs_vals'</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">n_jobs_vals</span><span class="punctuation">:</span>
        <span class="identifier">n_jobs_vals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">cpu_count</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">cache_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">current_path</span> <span class="arithmetic-operator">/</span> <span class="string-literal">'cache'</span>
    <span class="identifier">cache_path</span><span class="punctuation">.</span><span class="identifier">mkdir</span><span class="grouping">(</span><span class="identifier">exist_ok</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="grouping">(</span><span class="identifier">cache_path</span> <span class="arithmetic-operator">/</span> <span class="string-literal">'estimators'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mkdir</span><span class="grouping">(</span><span class="identifier">exist_ok</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="grouping">(</span><span class="identifier">cache_path</span> <span class="arithmetic-operator">/</span> <span class="string-literal">'tmp'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mkdir</span><span class="grouping">(</span><span class="identifier">exist_ok</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">save_estimators</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">getenv</span><span class="grouping">(</span><span class="string-literal">'SKLBENCH_SAVE_ESTIMATORS'</span><span class="punctuation">,</span>
                                <span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">'save_estimators'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">save_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">getenv</span><span class="grouping">(</span><span class="string-literal">'ASV_COMMIT', 'new'</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">8</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="identifier">save_estimators</span><span class="punctuation">:</span>
        <span class="grouping">(</span><span class="identifier">cache_path</span> <span class="arithmetic-operator">/</span> <span class="string-literal">'estimators'</span> <span class="arithmetic-operator">/</span> <span class="identifier">save_dir</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mkdir</span><span class="grouping">(</span><span class="identifier">exist_ok</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">base_commit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">getenv</span><span class="grouping">(</span><span class="string-literal">'SKLBENCH_BASE_COMMIT', config['base_commit'</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">bench_predict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">getenv</span><span class="grouping">(</span><span class="string-literal">'SKLBENCH_PREDICT', config['bench_predict'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">bench_transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">getenv</span><span class="grouping">(</span><span class="string-literal">'SKLBENCH_TRANSFORM'</span><span class="punctuation">,</span>
                                <span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">'bench_transform'</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">profile</span><span class="punctuation">,</span> <span class="identifier">n_jobs_vals</span><span class="punctuation">,</span> <span class="identifier">save_estimators</span><span class="punctuation">,</span> <span class="identifier">save_dir</span><span class="punctuation">,</span> <span class="identifier">base_commit</span><span class="punctuation">,</span>
            <span class="identifier">bench_predict</span><span class="punctuation">,</span> <span class="identifier">bench_transform</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">get_estimator_path</span><span class="grouping">(</span><span class="identifier">benchmark</span><span class="punctuation">,</span> <span class="identifier">directory</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">save</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Get path of pickled fitted estimator"""</span>
    <span class="identifier">path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Path</span><span class="grouping">(</span><span class="identifier">__file__</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">resolve</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">parent</span> <span class="arithmetic-operator">/</span> <span class="string-literal">'cache'</span>
    <span class="identifier">path</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">path</span> <span class="arithmetic-operator">/</span> <span class="string-literal">'estimators' / directory) if save else (path / 'tmp'</span><span class="grouping">)</span>

    <span class="identifier">filename</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">benchmark</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
                <span class="arithmetic-operator">+</span> <span class="string-literal">'_estimator_' + '_'.join(list(map(str, params))) + '.pkl'</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">path</span> <span class="arithmetic-operator">/</span> <span class="identifier">filename</span>


<span class="keyword">def</span> <span class="identifier">clear_tmp</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Clean the tmp directory"""</span>
    <span class="identifier">path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Path</span><span class="grouping">(</span><span class="identifier">__file__</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">resolve</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">parent</span> <span class="arithmetic-operator">/</span> <span class="string-literal">'cache' / 'tmp'</span>
    <span class="keyword">for</span> <span class="identifier">child</span> <span class="relational-operator">in</span> <span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">iterdir</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">child</span><span class="punctuation">.</span><span class="identifier">unlink</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">Benchmark</span><span class="grouping">(</span><span class="identifier">ABC</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Abstract base class for all the benchmarks"""</span>
    <span class="identifier">timer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">timeit</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">r</span>  <span class="comment"># wall time</span>
    <span class="identifier">processes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">timeout</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span>

    <span class="grouping">(</span><span class="identifier">profile</span><span class="punctuation">,</span> <span class="identifier">n_jobs_vals</span><span class="punctuation">,</span> <span class="identifier">save_estimators</span><span class="punctuation">,</span> <span class="identifier">save_dir</span><span class="punctuation">,</span> <span class="identifier">base_commit</span><span class="punctuation">,</span>
     <span class="identifier">bench_predict</span><span class="punctuation">,</span> <span class="identifier">bench_transform</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_from_config</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">profile</span> <span class="relational-operator">==</span> <span class="string-literal">'fast'</span><span class="punctuation">:</span>
        <span class="identifier">warmup_time</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">repeat</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">number</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">min_run_count</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">data_size</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'small'</span>
    <span class="keyword">elif</span> <span class="identifier">profile</span> <span class="relational-operator">==</span> <span class="string-literal">'regular'</span><span class="punctuation">:</span>
        <span class="identifier">warmup_time</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">repeat</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span>
        <span class="identifier">data_size</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'small'</span>
    <span class="keyword">elif</span> <span class="identifier">profile</span> <span class="relational-operator">==</span> <span class="string-literal">'large_scale'</span><span class="punctuation">:</span>
        <span class="identifier">warmup_time</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">repeat</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
        <span class="identifier">number</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">data_size</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'large'</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="punctuation">@</span><span class="identifier">abstractmethod</span>
    <span class="keyword">def</span> <span class="identifier">params</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">pass</span>


<span class="keyword">class</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">ABC</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Abstract base class for all benchmarks of estimators"""</span>
    <span class="punctuation">@</span><span class="identifier">abstractmethod</span>
    <span class="keyword">def</span> <span class="identifier">make_data</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Return the dataset for a combination of parameters"""</span>
        <span class="comment"># The datasets are cached using joblib.Memory so it's fast and can be</span>
        <span class="comment"># called for each repeat</span>
        <span class="keyword">pass</span>

    <span class="punctuation">@</span><span class="identifier">abstractmethod</span>
    <span class="keyword">def</span> <span class="identifier">make_estimator</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Return an instance of the estimator for a combination of parameters
        """</span>
        <span class="keyword">pass</span>

    <span class="keyword">def</span> <span class="identifier">skip</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Return True if the benchmark should be skipped for these params"""</span>
        <span class="keyword">return</span> <span class="bool-literal">False</span>

    <span class="keyword">def</span> <span class="identifier">setup_cache</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Pickle a fitted estimator for all combinations of parameters"""</span>
        <span class="comment"># This is run once per benchmark class.</span>

        <span class="identifier">clear_tmp</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">itertools</span><span class="punctuation">.</span><span class="identifier">product</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">params</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">params</span> <span class="relational-operator">in</span> <span class="identifier">param_grid</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">skip</span><span class="grouping">(</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>

            <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">make_estimator</span><span class="grouping">(</span><span class="identifier">params</span><span class="grouping">)</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">make_data</span><span class="grouping">(</span><span class="identifier">params</span><span class="grouping">)</span>

            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

            <span class="identifier">est_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_estimator_path</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">Benchmark</span><span class="punctuation">.</span><span class="identifier">save_dir</span><span class="punctuation">,</span>
                                          <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">Benchmark</span><span class="punctuation">.</span><span class="identifier">save_estimators</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">est_path</span><span class="punctuation">.</span><span class="identifier">open</span><span class="grouping">(</span><span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'wb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dump</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">setup</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Generate dataset and load the fitted estimator"""</span>
        <span class="comment"># This is run once per combination of parameters and per repeat so we</span>
        <span class="comment"># need to avoid doing expensive operations there.</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">skip</span><span class="grouping">(</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">NotImplementedError</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X_val</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y_val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">make_data</span><span class="grouping">(</span><span class="identifier">params</span><span class="grouping">)</span>

        <span class="identifier">est_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_estimator_path</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">Benchmark</span><span class="punctuation">.</span><span class="identifier">save_dir</span><span class="punctuation">,</span>
                                      <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">Benchmark</span><span class="punctuation">.</span><span class="identifier">save_estimators</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">est_path</span><span class="punctuation">.</span><span class="identifier">open</span><span class="grouping">(</span><span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="identifier">f</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">make_scorers</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">time_fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">peakmem_fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">track_train_score</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'predict'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="keyword">return</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_scorer</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">track_test_score</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'predict'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">y_val_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X_val</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">y_val_pred</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="keyword">return</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">test_scorer</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y_val</span><span class="punctuation">,</span> <span class="identifier">y_val_pred</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">Predictor</span><span class="grouping">(</span><span class="identifier">ABC</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Abstract base class for benchmarks of estimators implementing predict"""</span>
    <span class="keyword">if</span> <span class="identifier">Benchmark</span><span class="punctuation">.</span><span class="identifier">bench_predict</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">time_predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="keyword">def</span> <span class="identifier">peakmem_predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">Benchmark</span><span class="punctuation">.</span><span class="identifier">base_commit</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">def</span> <span class="identifier">track_same_prediction</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">est_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_estimator_path</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">Benchmark</span><span class="punctuation">.</span><span class="identifier">base_commit</span><span class="punctuation">,</span>
                                              <span class="identifier">args</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
                <span class="keyword">with</span> <span class="identifier">est_path</span><span class="punctuation">.</span><span class="identifier">open</span><span class="grouping">(</span><span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                    <span class="identifier">estimator_base</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="identifier">f</span><span class="grouping">)</span>

                <span class="identifier">y_val_pred_base</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_base</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X_val</span><span class="grouping">)</span>
                <span class="identifier">y_val_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X_val</span><span class="grouping">)</span>

                <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">y_val_pred_base</span><span class="punctuation">,</span> <span class="identifier">y_val_pred</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="punctuation">@</span><span class="identifier">abstractmethod</span>
    <span class="keyword">def</span> <span class="identifier">params</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">pass</span>


<span class="keyword">class</span> <span class="identifier">Transformer</span><span class="grouping">(</span><span class="identifier">ABC</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Abstract base class for benchmarks of estimators implementing transform
    """</span>
    <span class="keyword">if</span> <span class="identifier">Benchmark</span><span class="punctuation">.</span><span class="identifier">bench_transform</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">time_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="keyword">def</span> <span class="identifier">peakmem_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">Benchmark</span><span class="punctuation">.</span><span class="identifier">base_commit</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">def</span> <span class="identifier">track_same_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">est_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_estimator_path</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">Benchmark</span><span class="punctuation">.</span><span class="identifier">base_commit</span><span class="punctuation">,</span>
                                              <span class="identifier">args</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
                <span class="keyword">with</span> <span class="identifier">est_path</span><span class="punctuation">.</span><span class="identifier">open</span><span class="grouping">(</span><span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                    <span class="identifier">estimator_base</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="identifier">f</span><span class="grouping">)</span>

                <span class="identifier">X_val_t_base</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_base</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X_val</span><span class="grouping">)</span>
                <span class="identifier">X_val_t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X_val</span><span class="grouping">)</span>

                <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">X_val_t_base</span><span class="punctuation">,</span> <span class="identifier">X_val_t</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="punctuation">@</span><span class="identifier">abstractmethod</span>
    <span class="keyword">def</span> <span class="identifier">params</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">pass</span>

    </pre>
  </body>
</html>