<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">pickle</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">_quad_tree</span> <span class="keyword">import</span> <span class="identifier">_QuadTree</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>


<span class="keyword">def</span> <span class="identifier">test_quadtree_boundary_computation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Introduce a point into a quad tree with boundaries not easy to compute.</span>
    <span class="identifier">Xs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

    <span class="comment"># check a random case</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># check the case where only 0 are inserted</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># check the case where only negative are inserted</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># check the case where only small numbers are inserted</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="float-literal">1e-6</span><span class="punctuation">,</span> <span class="float-literal">1e-6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="float-literal">4e-6</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="float-literal">1e-6</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">X</span> <span class="relational-operator">in</span> <span class="identifier">Xs</span><span class="punctuation">:</span>
        <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_QuadTree</span><span class="grouping">(</span><span class="identifier">n_dimensions</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">build_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_check_coherence</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_quadtree_similar_point</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Introduce a point into a quad tree where a similar point already exists.</span>
    <span class="comment"># Test will hang if it doesn't complete.</span>
    <span class="identifier">Xs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

    <span class="comment"># check the case where points are actually different</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># check the case where points are the same on X axis</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># check the case where points are arbitrarily close on X axis</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.00001</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.00002</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># check the case where points are the same on Y axis</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">3.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># check the case where points are arbitrarily close on Y axis</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">2.00001</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">3.0</span><span class="punctuation">,</span> <span class="float-literal">2.00002</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># check the case where points are arbitrarily close on both axes</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.00001</span><span class="punctuation">,</span> <span class="float-literal">2.00001</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.00002</span><span class="punctuation">,</span> <span class="float-literal">2.00002</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># check the case where points are arbitrarily close on both axes</span>
    <span class="comment"># close to machine epsilon - x axis</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">0.0003817754041</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="float-literal">0.0003817753750</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># check the case where points are arbitrarily close on both axes</span>
    <span class="comment"># close to machine epsilon - y axis</span>
    <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.0003817754041</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0003817753750</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">X</span> <span class="relational-operator">in</span> <span class="identifier">Xs</span><span class="punctuation">:</span>
        <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_QuadTree</span><span class="grouping">(</span><span class="identifier">n_dimensions</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">build_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_check_coherence</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_dimensions'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'protocol'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_quad_tree_pickle</span><span class="grouping">(</span><span class="identifier">n_dimensions</span><span class="punctuation">,</span> <span class="identifier">protocol</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_dimensions</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_QuadTree</span><span class="grouping">(</span><span class="identifier">n_dimensions</span><span class="arithmetic-assignment">=</span><span class="identifier">n_dimensions</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">build_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">protocol</span><span class="arithmetic-assignment">=</span><span class="identifier">protocol</span><span class="grouping">)</span>
    <span class="identifier">bt2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="punctuation">:</span>
        <span class="identifier">cell_x_tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">get_cell</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>
        <span class="identifier">cell_x_bt2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bt2</span><span class="punctuation">.</span><span class="identifier">get_cell</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">cell_x_tree</span> <span class="relational-operator">==</span> <span class="identifier">cell_x_bt2</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_dimensions'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_qt_insert_duplicate</span><span class="grouping">(</span><span class="identifier">n_dimensions</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_dimensions</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Xd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_QuadTree</span><span class="grouping">(</span><span class="identifier">n_dimensions</span><span class="arithmetic-assignment">=</span><span class="identifier">n_dimensions</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">build_tree</span><span class="grouping">(</span><span class="identifier">Xd</span><span class="grouping">)</span>

    <span class="identifier">cumulative_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">cumulative_size</span>
    <span class="identifier">leafs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">leafs</span>

    <span class="comment"># Assert that the first 5 are indeed duplicated and that the next</span>
    <span class="comment"># ones are single point leaf</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cell_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">get_cell</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">leafs</span><span class="grouping">[</span><span class="identifier">cell_id</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">cumulative_size</span><span class="grouping">[</span><span class="identifier">cell_id</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="relational-operator">&lt;</span> <span class="int-literal">5</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_summarize</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Simple check for quad tree's summarize</span>

    <span class="identifier">angle</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.9</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">9</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                 <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">query_pt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">n_dimensions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_dimensions</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span>

    <span class="identifier">qt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_QuadTree</span><span class="grouping">(</span><span class="identifier">n_dimensions</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">qt</span><span class="punctuation">.</span><span class="identifier">build_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">summary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">qt</span><span class="punctuation">.</span><span class="identifier">_py_summarize</span><span class="grouping">(</span><span class="identifier">query_pt</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">angle</span><span class="grouping">)</span>

    <span class="identifier">node_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">summary</span><span class="grouping">[</span><span class="identifier">n_dimensions</span><span class="grouping">]</span>
    <span class="identifier">node_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">summary</span><span class="grouping">[</span><span class="identifier">n_dimensions</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>

    <span class="comment"># Summary should contain only 1 node with size 3 and distance to</span>
    <span class="comment"># X[1:] barycenter</span>
    <span class="identifier">barycenter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">ds2c</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">barycenter</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">idx</span> <span class="relational-operator">==</span> <span class="identifier">offset</span>
    <span class="keyword">assert</span> <span class="identifier">node_size</span> <span class="relational-operator">==</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="string-literal">"summary size = {}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">node_size</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isclose</span><span class="grouping">(</span><span class="identifier">node_dist</span><span class="punctuation">,</span> <span class="identifier">ds2c</span><span class="grouping">)</span>

    <span class="comment"># Summary should contain all 3 node with size 1 and distance to</span>
    <span class="comment"># each point in X[1:] for ``angle=0``</span>
    <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">summary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">qt</span><span class="punctuation">.</span><span class="identifier">_py_summarize</span><span class="grouping">(</span><span class="identifier">query_pt</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="identifier">barycenter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">ds2c</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">barycenter</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">idx</span> <span class="relational-operator">==</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">offset</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">node_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">summary</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="identifier">offset</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_dimensions</span><span class="grouping">]</span>
        <span class="identifier">node_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">summary</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="identifier">offset</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_dimensions</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>

        <span class="identifier">ds2c</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">node_size</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="string-literal">"summary size = {}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">node_size</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isclose</span><span class="grouping">(</span><span class="identifier">node_dist</span><span class="punctuation">,</span> <span class="identifier">ds2c</span><span class="grouping">)</span>

    </pre>
  </body>
</html>