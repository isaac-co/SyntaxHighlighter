<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
Testing for the partial dependence module.
"""</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">import</span> <span class="identifier">sklearn</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">inspection</span> <span class="keyword">import</span> <span class="identifier">partial_dependence</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">inspection</span><span class="punctuation">.</span><span class="identifier">_partial_dependence</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">_grid_from_X</span><span class="punctuation">,</span>
    <span class="identifier">_partial_dependence_brute</span><span class="punctuation">,</span>
    <span class="identifier">_partial_dependence_recursion</span>
<span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">GradientBoostingClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">GradientBoostingRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">RandomForestRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">HistGradientBoostingClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">HistGradientBoostingRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LinearRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LogisticRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">MultiTaskLasso</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span> <span class="keyword">import</span> <span class="identifier">DecisionTreeRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_iris</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span><span class="punctuation">,</span> <span class="identifier">make_regression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">KMeans</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">compose</span> <span class="keyword">import</span> <span class="identifier">make_column_transformer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">r2_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">PolynomialFeatures</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">StandardScaler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">RobustScaler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">scale</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">dummy</span> <span class="keyword">import</span> <span class="identifier">DummyClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">M</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">i</span><span class="invalid">n</span><span class="punctuation">,</span> <span class="identifier">clone</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">NotFittedError</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">_IS_32BIT</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">tests</span><span class="punctuation">.</span><span class="identifier">test_tree</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">b</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span>


<span class="comment"># toy sample</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>


<span class="comment"># (X, y), n_targets  &lt;-- as expected in the output of partial_dep()</span>
<span class="identifier">binary_classification_data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span>
                                                  <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
<span class="identifier">multiclass_classification_data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span>
                                                      <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                                      <span class="identifier">n_clusters_per_class</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
<span class="identifier">regression_data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
<span class="identifier">multioutput_regression_data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

<span class="comment"># iris</span>
<span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore:A Bunch will be returned"</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Estimator, method, data'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">GradientBoostingClassifier</span><span class="punctuation">,</span> <span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="identifier">binary_classification_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">GradientBoostingClassifier</span><span class="punctuation">,</span> <span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="identifier">multiclass_classification_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">GradientBoostingClassifier</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="punctuation">,</span> <span class="identifier">binary_classification_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">GradientBoostingClassifier</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="punctuation">,</span> <span class="identifier">multiclass_classification_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">GradientBoostingRegressor</span><span class="punctuation">,</span> <span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="identifier">regression_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">GradientBoostingRegressor</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="punctuation">,</span> <span class="identifier">regression_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">DecisionTreeRegressor</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="punctuation">,</span> <span class="identifier">regression_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">LinearRegression</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="punctuation">,</span> <span class="identifier">regression_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">LinearRegression</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="punctuation">,</span> <span class="identifier">multioutput_regression_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="punctuation">,</span> <span class="identifier">binary_classification_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="punctuation">,</span> <span class="identifier">multiclass_classification_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">MultiTaskLasso</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="punctuation">,</span> <span class="identifier">multioutput_regression_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'grid_resolution'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'features'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kind', ('legacy', 'average', 'individual', 'both'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_output_shape</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="punctuation">,</span>
                      <span class="identifier">features</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that partial_dependence has consistent output shape for different</span>
    <span class="comment"># kinds of estimators:</span>
    <span class="comment"># - classifiers with binary and multiclass settings</span>
    <span class="comment"># - regressors</span>
    <span class="comment"># - multi-task regressors</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># n_target corresponds to the number of classes (1 for binary classif) or</span>
    <span class="comment"># the number of tasks / outputs in multi task settings. It's equal to 1 for</span>
    <span class="comment"># classical regression_data.</span>
    <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>
    <span class="identifier">n_instances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span>
        <span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="identifier">features</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="identifier">kind</span><span class="punctuation">,</span>
        <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="identifier">grid_resolution</span>
    <span class="grouping">)</span>
    <span class="comment"># FIXME: Remove 'legacy' support in 1.1</span>
    <span class="identifier">pdp</span><span class="punctuation">,</span> <span class="identifier">axes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">result</span> <span class="keyword">if</span> <span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'legacy'</span> <span class="keyword">else</span> <span class="grouping">(</span><span class="identifier">result</span><span class="punctuation">,</span> <span class="identifier">result</span><span class="grouping">[</span><span class="string-literal">"values"</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_pdp_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">n_targets</span><span class="punctuation">,</span>
                          <span class="arithmetic-operator">*</span><span class="grouping">[</span><span class="identifier">grid_resolution</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">features</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">expected_ice_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">n_targets</span><span class="punctuation">,</span> <span class="identifier">n_instances</span><span class="punctuation">,</span>
                          <span class="arithmetic-operator">*</span><span class="grouping">[</span><span class="identifier">grid_resolution</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">features</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'legacy'</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">pdp</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">expected_pdp_shape</span>
    <span class="keyword">elif</span> <span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'average'</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">pdp</span><span class="punctuation">.</span><span class="identifier">average</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">expected_pdp_shape</span>
    <span class="keyword">elif</span> <span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'individual'</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">pdp</span><span class="punctuation">.</span><span class="identifier">individual</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">expected_ice_shape</span>
    <span class="keyword">else</span><span class="punctuation">:</span>  <span class="comment"># 'both'</span>
        <span class="keyword">assert</span> <span class="identifier">pdp</span><span class="punctuation">.</span><span class="identifier">average</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">expected_pdp_shape</span>
        <span class="keyword">assert</span> <span class="identifier">pdp</span><span class="punctuation">.</span><span class="identifier">individual</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">expected_ice_shape</span>

    <span class="identifier">expected_axes_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">features</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">axes</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">axes</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">expected_axes_shape</span>


<span class="keyword">def</span> <span class="identifier">test_grid_from_X</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># tests for _grid_from_X: sanity check for output, and for shapes.</span>

    <span class="comment"># Make sure that the grid is a cartesian product of the input (it will use</span>
    <span class="comment"># the unique values instead of the percentiles)</span>
    <span class="identifier">percentiles</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="float-literal">.05</span><span class="punctuation">,</span> <span class="float-literal">.95</span><span class="grouping">)</span>
    <span class="identifier">grid_resolution</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">axes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_grid_from_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">percentiles</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">grid</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                              <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
                              <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                              <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">axes</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="comment"># test shapes of returned objects depending on the number of unique values</span>
    <span class="comment"># for a feature.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">grid_resolution</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">15</span>

    <span class="comment"># n_unique_values &gt; grid_resolution</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">axes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_grid_from_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">percentiles</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="identifier">grid_resolution</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">grid</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">grid_resolution</span> <span class="arithmetic-operator">*</span> <span class="identifier">grid_resolution</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">axes</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="grouping">)</span>

    <span class="comment"># n_unique_values &lt; grid_resolution, will use actual values</span>
    <span class="identifier">n_unique_values</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">12</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">n_unique_values</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">12345</span>
    <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>  <span class="comment"># just to make sure the order is irrelevant</span>
    <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">axes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_grid_from_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">percentiles</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="identifier">grid_resolution</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">grid</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_unique_values</span> <span class="arithmetic-operator">*</span> <span class="identifier">grid_resolution</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="comment"># axes is a list of arrays of different shapes</span>
    <span class="keyword">assert</span> <span class="identifier">axes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_unique_values</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">axes</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">grid_resolution</span><span class="punctuation">,</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"grid_resolution, percentiles, err_msg"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.0001</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">"percentiles are too close"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">"'percentiles' must be a sequence of 2 elements"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">12345</span><span class="punctuation">,</span> <span class="string-literal">"'percentiles' must be a sequence of 2 elements"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">.95</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="string-literal">"'percentiles' values must be in \[0, 1\]"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.05</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="string-literal">"'percentiles' values must be in \[0, 1\]"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.9</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="string-literal">"percentiles\[0\] must be strictly less than"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="float-literal">0.95</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">"'grid_resolution' must be strictly greater than 1"</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_grid_from_X_error</span><span class="grouping">(</span><span class="identifier">grid_resolution</span><span class="punctuation">,</span> <span class="identifier">percentiles</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_grid_from_X</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="identifier">grid_resolution</span><span class="punctuation">,</span> <span class="identifier">percentiles</span><span class="arithmetic-assignment">=</span><span class="identifier">percentiles</span>
        <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'target_feature'</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'est, method'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">GradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">GradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'recursion'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'brute'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'recursion'</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_dependence_helpers</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="punctuation">,</span> <span class="identifier">target_feature</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that what is returned by _partial_dependence_brute or</span>
    <span class="comment"># _partial_dependence_recursion is equivalent to manually setting a target</span>
    <span class="comment"># feature to a given value, and computing the average prediction over all</span>
    <span class="comment"># samples.</span>
    <span class="comment"># This also checks that the brute and recursion methods give the same</span>
    <span class="comment"># output.</span>
    <span class="comment"># Note that even on the trainset, the brute and the recursion methods</span>
    <span class="comment"># aren't always strictly equivalent, in particular when the slow method</span>
    <span class="comment"># generates unrealistic samples that have low mass in the joint</span>
    <span class="comment"># distribution of the input features, and when some of the features are</span>
    <span class="comment"># dependent. Hence the high tolerance on the checks.</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="comment"># The 'init' estimator for GBDT (here the average prediction) isn't taken</span>
    <span class="comment"># into account with the recursion method, for technical reasons. We set</span>
    <span class="comment"># the mean to 0 to that this 'bug' doesn't have any effect.</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># target feature will be set to .5 and then to 123</span>
    <span class="identifier">features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">target_feature</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="grouping">)</span>
    <span class="identifier">grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">.5</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">123</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'brute'</span><span class="punctuation">:</span>
        <span class="identifier">pdp</span><span class="punctuation">,</span> <span class="identifier">predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_partial_dependence_brute</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span>
                                                     <span class="identifier">response_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">pdp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_partial_dependence_recursion</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="grouping">)</span>

    <span class="identifier">mean_predictions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="float-literal">.5</span><span class="punctuation">,</span> <span class="int-literal">123</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">target_feature</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">val</span>
        <span class="identifier">mean_predictions</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">pdp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pdp</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>  <span class="comment"># (shape is (1, 2) so make it (2,))</span>

    <span class="comment"># allow for greater margin for error with recursion method</span>
    <span class="identifier">rtol</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-1</span> <span class="keyword">if</span> <span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'recursion'</span> <span class="keyword">else</span> <span class="float-literal">1e-3</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">pdp</span><span class="punctuation">,</span> <span class="identifier">mean_predictions</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="identifier">rtol</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'seed'</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_recursion_decision_tree_vs_forest_and_gbdt</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure that the recursion method gives the same results on a</span>
    <span class="comment"># DecisionTreeRegressor and a GradientBoostingRegressor or a</span>
    <span class="comment"># RandomForestRegressor with 1 tree and equivalent parameters.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>

    <span class="comment"># Purely random dataset to avoid correlated features</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">10</span>

    <span class="comment"># The 'init' estimator for GBDT (here the average prediction) isn't taken</span>
    <span class="comment"># into account with the recursion method, for technical reasons. We set</span>
    <span class="comment"># the mean to 0 to that this 'bug' doesn't have any effect.</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># set max_depth not too high to avoid splits with same gain but different</span>
    <span class="comment"># features</span>
    <span class="identifier">max_depth</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>

    <span class="identifier">tree_seed</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestRegressor</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                   <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="identifier">max_depth</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">tree_seed</span><span class="grouping">)</span>
    <span class="comment"># The forest will use ensemble.base._set_random_states to set the</span>
    <span class="comment"># random_state of the tree sub-estimator. We simulate this here to have</span>
    <span class="comment"># equivalent estimators.</span>
    <span class="identifier">equiv_random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">tree_seed</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">iinfo</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">)</span>
    <span class="identifier">gbdt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                     <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_error'</span><span class="punctuation">,</span>
                                     <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="identifier">max_depth</span><span class="punctuation">,</span>
                                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">equiv_random_state</span><span class="grouping">)</span>
    <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="identifier">max_depth</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">equiv_random_state</span><span class="grouping">)</span>

    <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">gbdt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># sanity check: if the trees aren't the same, the PD values won't be equal</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">b</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">gbdt</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">b</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="grouping">)</span>
    <span class="keyword">except</span> <span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
        <span class="comment"># For some reason the trees aren't exactly equal on 32bits, so the PDs</span>
        <span class="comment"># cannot be equal either. See</span>
        <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/8853</span>
        <span class="keyword">assert</span> <span class="identifier">_IS_32BIT</span><span class="punctuation">,</span> <span class="string-literal">"this should only fail on 32 bit platforms"</span>
        <span class="keyword">return</span>

    <span class="identifier">grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">50</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">f</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">f</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="grouping">)</span>

        <span class="identifier">pdp_forest</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_partial_dependence_recursion</span><span class="grouping">(</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="grouping">)</span>
        <span class="identifier">pdp_gbdt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_partial_dependence_recursion</span><span class="grouping">(</span><span class="identifier">gbdt</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="grouping">)</span>
        <span class="identifier">pdp_tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_partial_dependence_recursion</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="grouping">)</span>

        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pdp_gbdt</span><span class="punctuation">,</span> <span class="identifier">pdp_tree</span><span class="grouping">)</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pdp_forest</span><span class="punctuation">,</span> <span class="identifier">pdp_tree</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'est'</span><span class="punctuation">,</span> <span class="grouping">(</span>
    <span class="identifier">GradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'target_feature'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_recursion_decision_function</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">target_feature</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure the recursion method (implicitly uses decision_function) has</span>
    <span class="comment"># the same result as using brute method with</span>
    <span class="comment"># response_method=decision_function</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_clusters_per_class</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="float-literal">.5</span>  <span class="comment"># make sure the init estimator predicts 0 anyway</span>

    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">preds_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span>
        <span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">target_feature</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">response_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'decision_function'</span><span class="punctuation">,</span>
        <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'recursion', kind='average'</span>
    <span class="grouping">)</span>
    <span class="identifier">preds_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span>
        <span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">target_feature</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">response_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'decision_function'</span><span class="punctuation">,</span>
        <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'brute', kind='average'</span>
    <span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">preds_1</span><span class="grouping">[</span><span class="string-literal">'average'], preds_2['average'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'est'</span><span class="punctuation">,</span> <span class="grouping">(</span>
    <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="identifier">GradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                  <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'power'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_dependence_easy_target</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">power</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># If the target y only depends on one feature in an obvious way (linear or</span>
    <span class="comment"># quadratic) then the partial dependence for that feature should reflect</span>
    <span class="comment"># it.</span>
    <span class="comment"># We here fit a linear regression_data model (with polynomial features if</span>
    <span class="comment"># needed) and compute r_squared to check that the partial dependence</span>
    <span class="comment"># correctly reflects the target.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">200</span>
    <span class="identifier">target_variable</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">target_variable</span><span class="grouping">]</span><span class="arithmetic-operator">**</span><span class="identifier">power</span>

    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">pdp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span>
        <span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">target_variable</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span>
        <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'average'</span>
    <span class="grouping">)</span>

    <span class="identifier">new_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pdp</span><span class="grouping">[</span><span class="string-literal">"values"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">new_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pdp</span><span class="grouping">[</span><span class="string-literal">'average'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="comment"># add polynomial features if needed</span>
    <span class="identifier">new_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">power</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">new_X</span><span class="grouping">)</span>

    <span class="identifier">lr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">new_X</span><span class="punctuation">,</span> <span class="identifier">new_y</span><span class="grouping">)</span>
    <span class="identifier">r2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r2_score</span><span class="grouping">(</span><span class="identifier">new_y</span><span class="punctuation">,</span> <span class="identifier">lr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">new_X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">r2</span> <span class="relational-operator">&gt;</span> <span class="float-literal">.99</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Estimator'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">DecisionTreeClassifier</span><span class="punctuation">,</span>
                          <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">ExtraTreeClassifier</span><span class="punctuation">,</span>
                          <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">ExtraTreesClassifier</span><span class="punctuation">,</span>
                          <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="punctuation">,</span>
                          <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="punctuation">,</span>
                          <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">RandomForestClassifier</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_multiclass_multioutput</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure error is raised for multiclass-multioutput classifiers</span>

    <span class="comment"># make multiclass-multioutput dataset</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_clusters_per_class</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
            <span class="identifier">ValueError</span><span class="punctuation">,</span>
            <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Multiclass-multioutput estimators are not supported"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">NoPredictProbaNoDecisionFunction</span><span class="grouping">(</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">M</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">i</span><span class="invalid">n</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># simulate that we have some classes</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">self</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore:A Bunch will be returned"</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"estimator, params, err_msg"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">KMeans</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">"'estimator' must be a fitted regressor or classifier"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': [0], 'response_method': 'predict_proba'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">'The response_method parameter is ignored for regressors'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">GradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': [0], 'response_method': 'predict_proba'</span><span class="punctuation">,</span>
       <span class="string-literal">'method': 'recursion'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">"'recursion' method, the response_method must be 'decision_function'"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">GradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': [0], 'response_method': 'predict_proba', 'method': 'auto'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">"'recursion' method, the response_method must be 'decision_function'"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">GradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': [0], 'response_method': 'blahblah'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">'response_method blahblah is invalid. Accepted response_method'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">NoPredictProbaNoDecisionFunction</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': [0], 'response_method': 'auto'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">'The estimator has no predict_proba and no decision_function method'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">NoPredictProbaNoDecisionFunction</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': [0], 'response_method': 'predict_proba'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">'The estimator has no predict_proba method.'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">NoPredictProbaNoDecisionFunction</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': [0], 'response_method': 'decision_function'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">'The estimator has no decision_function method.'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': [0], 'method': 'blahblah'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">'blahblah is invalid. Accepted method names are brute, recursion, auto'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': [0], 'method': 'recursion', 'kind': 'individual'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">"The 'recursion' method only applies when 'kind' is set to 'average'"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': [0], 'method': 'recursion', 'kind': 'both'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">"The 'recursion' method only applies when 'kind' is set to 'average'"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': [0], 'method': 'recursion'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">"Only the following estimators support the 'recursion' method:"</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_dependence_error</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"with_dataframe, err_msg"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="string-literal">"Only array-like or scalar are supported"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="string-literal">"Only array-like or scalar are supported"</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_dependence_slice_error</span><span class="grouping">(</span><span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="punctuation">:</span>
        <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="identifier">slice</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'estimator'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">GradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'features'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10000</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_dependence_unknown_feature_indices</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'all features must be in'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">features</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'estimator'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">GradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_dependence_unknown_feature_string</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">"pandas"</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">df</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">features</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'random'</span><span class="grouping">]</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'A given column is not a column of the dataframe'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">df</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'estimator'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">GradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_dependence_X_list</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that array-like objects are accepted</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'average'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_warning_recursion_non_constant_init</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># make sure that passing a non-constant init parameter to a GBDT and using</span>
    <span class="comment"># recursion method yields a warning.</span>

    <span class="identifier">gbc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">DummyClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">gbc</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span>
            <span class="identifier">UserWarning</span><span class="punctuation">,</span>
            <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Using recursion method with a non-constant init predictor'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">gbc</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'recursion', kind='average'</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span>
            <span class="identifier">UserWarning</span><span class="punctuation">,</span>
            <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Using recursion method with a non-constant init predictor'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">gbc</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'recursion', kind='average'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_partial_dependence_sample_weight</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test near perfect correlation between partial dependence and diagonal</span>
    <span class="comment"># when sample weights emphasize y = x predictions</span>
    <span class="comment"># non-regression test for #13193</span>
    <span class="comment"># TODO: extend to HistGradientBoosting once sample_weight is supported</span>
    <span class="identifier">N</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">123456</span><span class="grouping">)</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>

    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">N</span><span class="grouping">)</span>
    <span class="comment"># set y = x on mask and y = -x outside</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">y</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">mask</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="grouping">]</span>
    <span class="comment"># sample weights to emphasize data points where y = x</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">N</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span><span class="punctuation">.</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>

    <span class="identifier">pdp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'average'</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">corrcoef</span><span class="grouping">(</span><span class="identifier">pdp</span><span class="grouping">[</span><span class="string-literal">'average'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pdp</span><span class="grouping">[</span><span class="string-literal">"values"</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.99</span>


<span class="keyword">def</span> <span class="identifier">test_hist_gbdt_sw_not_supported</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># TODO: remove/fix when PDP supports HGBT with sample weights</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotImplementedError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"does not support partial dependence"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_partial_dependence_pipeline</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that the partial dependence support pipeline</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">scaler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DummyClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">scaler</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">scaler</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>

    <span class="identifier">features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">pdp_pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span>
        <span class="identifier">pipe</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">features</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
        <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'average'</span>
    <span class="grouping">)</span>
    <span class="identifier">pdp_clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span>
        <span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">scaler</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">features</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'average'</span>
    <span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pdp_pipe</span><span class="grouping">[</span><span class="string-literal">'average'], pdp_clf['average'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
        <span class="identifier">pdp_pipe</span><span class="grouping">[</span><span class="string-literal">"values"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">pdp_clf</span><span class="grouping">[</span><span class="string-literal">"values"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">scaler</span><span class="punctuation">.</span><span class="identifier">scale_</span><span class="grouping">[</span><span class="identifier">features</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">scaler</span><span class="punctuation">.</span><span class="identifier">mean_</span><span class="grouping">[</span><span class="identifier">features</span><span class="grouping">]</span>
    <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"estimator"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="identifier">GradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'estimator-brute', 'estimator-recursion'</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"preprocessor"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span>
     <span class="identifier">make_column_transformer</span><span class="grouping">(</span>
         <span class="grouping">(</span><span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="identifier">RobustScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="identifier">make_column_transformer</span><span class="grouping">(</span>
         <span class="grouping">(</span><span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="identifier">remainder</span><span class="arithmetic-assignment">=</span><span class="string-literal">'passthrough'</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'None', 'column-transformer', 'column-transformer-passthrough'</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"features"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'features-integer', 'features-string'</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_dependence_dataframe</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">preprocessor</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that the partial dependence support dataframe and pipeline</span>
    <span class="comment"># including a column transformer</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">"pandas"</span><span class="grouping">)</span>
    <span class="identifier">df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">columns</span><span class="arithmetic-assignment">=</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">)</span>

    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">preprocessor</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">df</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">pdp_pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span>
        <span class="identifier">pipe</span><span class="punctuation">,</span> <span class="identifier">df</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="identifier">features</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'average'</span>
    <span class="grouping">)</span>

    <span class="comment"># the column transformer will reorder the column when transforming</span>
    <span class="comment"># we mixed the index to be sure that we are computing the partial</span>
    <span class="comment"># dependence of the right columns</span>
    <span class="keyword">if</span> <span class="identifier">preprocessor</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">X_proc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">preprocessor</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">df</span><span class="grouping">)</span>
        <span class="identifier">features_clf</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">X_proc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">df</span>
        <span class="identifier">features_clf</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_proc</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">pdp_clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span>
        <span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_proc</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="identifier">features_clf</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'brute'</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
        <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'average'</span>
    <span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pdp_pipe</span><span class="grouping">[</span><span class="string-literal">'average'], pdp_clf['average'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">preprocessor</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">scaler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">preprocessor</span><span class="punctuation">.</span><span class="identifier">named_transformers_</span><span class="grouping">[</span><span class="string-literal">'standardscaler'</span><span class="grouping">]</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
            <span class="identifier">pdp_pipe</span><span class="grouping">[</span><span class="string-literal">"values"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="identifier">pdp_clf</span><span class="grouping">[</span><span class="string-literal">"values"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">scaler</span><span class="punctuation">.</span><span class="identifier">scale_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">scaler</span><span class="punctuation">.</span><span class="identifier">mean_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pdp_pipe</span><span class="grouping">[</span><span class="string-literal">"values"][1], pdp_clf["values"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"features, expected_pd_shape"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'scalar-int', 'scalar-str', 'list-int', 'list-str', 'mask'</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_dependence_feature_type</span><span class="grouping">(</span><span class="identifier">features</span><span class="punctuation">,</span> <span class="identifier">expected_pd_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check all possible features type supported in PDP</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">"pandas"</span><span class="grouping">)</span>
    <span class="identifier">df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">columns</span><span class="arithmetic-assignment">=</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">)</span>

    <span class="identifier">preprocessor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_column_transformer</span><span class="grouping">(</span>
        <span class="grouping">(</span><span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="identifier">RobustScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span>
        <span class="identifier">preprocessor</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">df</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">pdp_pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span>
        <span class="identifier">pipe</span><span class="punctuation">,</span> <span class="identifier">df</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="identifier">features</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'average'</span>
    <span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pdp_pipe</span><span class="grouping">[</span><span class="string-literal">'average'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">expected_pd_shape</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">pdp_pipe</span><span class="grouping">[</span><span class="string-literal">"values"</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">pdp_pipe</span><span class="grouping">[</span><span class="string-literal">'average'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"estimator"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="identifier">GradientBoostingRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">GradientBoostingClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_dependence_unfitted</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">preprocessor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_column_transformer</span><span class="grouping">(</span>
        <span class="grouping">(</span><span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">RobustScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">preprocessor</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"is not fitted yet"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"is not fitted yet"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">grid_resolution</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Estimator, data'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">LinearRegression</span><span class="punctuation">,</span> <span class="identifier">multioutput_regression_data</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="punctuation">,</span> <span class="identifier">binary_classification_data</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kind_average_and_average_of_individual</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">pdp_avg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span>
            <span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'average'</span>
    <span class="grouping">)</span>
    <span class="identifier">pdp_ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial_dependence</span><span class="grouping">(</span>
        <span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'individual'</span>
    <span class="grouping">)</span>
    <span class="identifier">avg_ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">pdp_ind</span><span class="grouping">[</span><span class="string-literal">'individual'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">avg_ind</span><span class="punctuation">,</span> <span class="identifier">pdp_avg</span><span class="grouping">[</span><span class="string-literal">'average'</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_warning_for_kind_legacy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="identifier">binary_classification_data</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"A Bunch will be returned in place of 'predictions' from "</span>
               <span class="string-literal">"version 1.1"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">partial_dependence</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'legacy'</span><span class="grouping">)</span>

    </pre>
  </body>
</html>