<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Tools for manipulating the alignments serialized file """</span>

<span class="keyword">import</span> <span class="identifier">logging</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">from</span> <span class="identifier">datetime</span> <span class="keyword">import</span> <span class="identifier">datetime</span>

<span class="keyword">import</span> <span class="identifier">cv2</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">signal</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">decomposition</span>
<span class="keyword">from</span> <span class="identifier">tqdm</span> <span class="keyword">import</span> <span class="identifier">tqdm</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">align</span> <span class="keyword">import</span> <span class="identifier">DetectedFace</span><span class="punctuation">,</span> <span class="identifier">_EXTRACT_RATIOS</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">align</span><span class="punctuation">.</span><span class="identifier">alignments</span> <span class="keyword">import</span> <span class="identifier">_VERSION</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">image</span> <span class="keyword">import</span> <span class="identifier">encode_image</span><span class="punctuation">,</span> <span class="identifier">generate_thumbnail</span><span class="punctuation">,</span> <span class="identifier">ImagesSaver</span><span class="punctuation">,</span> <span class="identifier">update_existing_metadata</span>
<span class="keyword">from</span> <span class="identifier">plugins</span><span class="punctuation">.</span><span class="identifier">extract</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">Extractor</span><span class="punctuation">,</span> <span class="identifier">ExtractMedia</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">media</span> <span class="keyword">import</span> <span class="identifier">ExtractedFaces</span><span class="punctuation">,</span> <span class="identifier">Faces</span><span class="punctuation">,</span> <span class="identifier">Frames</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>


<span class="keyword">class</span> <span class="identifier">Check</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Frames and faces checking tasks.

    Parameters
    ---------
    alignments: :class:`tools.alignments.media.AlignmentsData`
        The loaded alignments corresponding to the frames to be annotated
    arguments: :class:`argparse.Namespace`
        The command line arguments that have called this job
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">alignments</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (arguments: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alignments</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_job</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">job</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_video</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>  <span class="comment"># Set when getting items</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">output</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_source_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_source_dir</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_items</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">""</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_source_dir</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the correct source folder """</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="string-literal">"faces_dir"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">faces_dir</span> <span class="logical-operator">and</span>
                <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="string-literal">"frames_dir"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">frames_dir</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"Only select a source frames (-fr) or source faces (-fc) folder"</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="string-literal">"faces_dir"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">faces_dir</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"faces"</span>
            <span class="identifier">source_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">faces_dir</span>
        <span class="keyword">elif</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="string-literal">"frames_dir"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">frames_dir</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"frames"</span>
            <span class="identifier">source_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">frames_dir</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"No source folder (-fr or -fc) was provided"</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"type: '%s', source_dir: '%s'"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span><span class="punctuation">,</span> <span class="identifier">source_dir</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">source_dir</span>

    <span class="keyword">def</span> <span class="identifier">_get_items</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the correct items to process """</span>
        <span class="identifier">items</span> <span class="arithmetic-assignment">=</span> <span class="invalid">g</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">b</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">s</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_source_dir</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_video</span> <span class="arithmetic-assignment">=</span> <span class="identifier">items</span><span class="punctuation">.</span><span class="identifier">is_video</span>
        <span class="keyword">return</span> <span class="identifier">items</span><span class="punctuation">.</span><span class="identifier">file_list_sorted</span>

    <span class="keyword">def</span> <span class="identifier">process</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Process the frames check against the alignments file """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"[CHECK %s]"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span><span class="punctuation">.</span><span class="identifier">upper</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">items_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_compile_output</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output_results</span><span class="grouping">(</span><span class="identifier">items_output</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_validate</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check that the selected type is valid for
            selected task and job """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_job</span> <span class="relational-operator">==</span> <span class="string-literal">"missing-frames" and self._output == "move"</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">warning</span><span class="grouping">(</span><span class="string-literal">"Missing_frames was selected with move output, but there will "</span>
                           <span class="string-literal">"be nothing to move. Defaulting to output: console"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"console"</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span> <span class="relational-operator">==</span> <span class="string-literal">"faces" and self._job != "multi-faces"</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"The selected folder is not valid. Faces folder (-fc) is only "</span>
                         <span class="string-literal">"supported for 'multi-faces'"</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_compile_output</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Compile list of frames that meet criteria """</span>
        <span class="identifier">action</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_job</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">"-", "_"</span><span class="grouping">)</span>
        <span class="identifier">processor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">"_get_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">action</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Processor: %s"</span><span class="punctuation">,</span> <span class="identifier">processor</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="grouping">[</span><span class="identifier">item</span> <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">processor</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>  <span class="comment"># pylint:disable=unnecessary-comprehension</span>

    <span class="keyword">def</span> <span class="identifier">_get_no_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" yield each frame that has no face match in alignments file """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Frames with no faces"</span>
        <span class="keyword">for</span> <span class="identifier">frame</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="identifier">frame</span><span class="grouping">)</span>
            <span class="identifier">frame_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">frame</span><span class="grouping">[</span><span class="string-literal">"frame_fullname"</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">frame_has_faces</span><span class="grouping">(</span><span class="identifier">frame_name</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Returning: '%s'"</span><span class="punctuation">,</span> <span class="identifier">frame_name</span><span class="grouping">)</span>
                <span class="keyword">yield</span> <span class="identifier">frame_name</span>

    <span class="keyword">def</span> <span class="identifier">_get_multi_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" yield each frame or face that has multiple faces
            matched in alignments file """</span>
        <span class="identifier">process_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">"_get_multi_faces_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">process_type</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">yield</span> <span class="identifier">item</span>

    <span class="keyword">def</span> <span class="identifier">_get_multi_faces_frames</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return Frames that contain multiple faces """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Frames with multiple faces"</span>
        <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">filename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">item</span><span class="grouping">[</span><span class="string-literal">"frame_fullname"</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">frame_has_multiple_faces</span><span class="grouping">(</span><span class="identifier">filename</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Returning: '%s'"</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
            <span class="keyword">yield</span> <span class="identifier">filename</span>

    <span class="keyword">def</span> <span class="identifier">_get_multi_faces_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return Faces when there are multiple faces in a frame """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Multiple faces in frame"</span>
        <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">frame_has_multiple_faces</span><span class="grouping">(</span><span class="identifier">item</span><span class="grouping">[</span><span class="string-literal">"source_filename"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">item</span><span class="grouping">[</span><span class="string-literal">"current_filename"], item["face_index"</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Returning: '%s'"</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="grouping">)</span>
            <span class="keyword">yield</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">_get_missing_alignments</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" yield each frame that does not exist in alignments file """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Frames missing from alignments file"</span>
        <span class="identifier">exclude_filetypes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"yaml", "yml", "p", "json", "txt"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">frame</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">frame_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">frame</span><span class="grouping">[</span><span class="string-literal">"frame_fullname"</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">frame</span><span class="grouping">[</span><span class="string-literal">"frame_extension"</span><span class="grouping">]</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">exclude_filetypes</span>
                    <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">frame_exists</span><span class="grouping">(</span><span class="identifier">frame_name</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Returning: '%s'"</span><span class="punctuation">,</span> <span class="identifier">frame_name</span><span class="grouping">)</span>
                <span class="keyword">yield</span> <span class="identifier">frame_name</span>

    <span class="keyword">def</span> <span class="identifier">_get_missing_frames</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" yield each frame in alignments that does
            not have a matching file """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Missing frames that are in alignments file"</span>
        <span class="identifier">frames</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">item</span><span class="grouping">[</span><span class="string-literal">"frame_fullname"</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">frame</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">frame</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">frames</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Returning: '%s'"</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="grouping">)</span>
                <span class="keyword">yield</span> <span class="identifier">frame</span>

    <span class="keyword">def</span> <span class="identifier">_output_results</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">items_output</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Output the results in the requested format """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"items_output: %s"</span><span class="punctuation">,</span> <span class="identifier">items_output</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output</span> <span class="relational-operator">==</span> <span class="string-literal">"move" and self._is_video and self._type == "frames"</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">warning</span><span class="grouping">(</span><span class="string-literal">"Move was selected with an input video. This is not possible so "</span>
                           <span class="string-literal">"falling back to console output"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"console"</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">items_output</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"No %s were found meeting the criteria"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span><span class="grouping">)</span>
            <span class="keyword">return</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output</span> <span class="relational-operator">==</span> <span class="string-literal">"move"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_move_file</span><span class="grouping">(</span><span class="identifier">items_output</span><span class="grouping">)</span>
            <span class="keyword">return</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_job</span> <span class="relational-operator">==</span> <span class="string-literal">"multi-faces" and self._type == "faces"</span><span class="punctuation">:</span>
            <span class="comment"># Strip the index for printed/file output</span>
            <span class="identifier">items_output</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">item</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">items_output</span><span class="grouping">]</span>
        <span class="identifier">output_message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"-----------------------------------------------\r\n"</span>
        <span class="identifier">output_message</span> <span class="arithmetic-assignment">+=</span> <span class="string-literal">" {} ({})\r\n"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span><span class="punctuation">,</span>
                                                <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">items_output</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">output_message</span> <span class="arithmetic-assignment">+=</span> <span class="string-literal">"-----------------------------------------------\r\n"</span>
        <span class="identifier">output_message</span> <span class="arithmetic-assignment">+=</span> <span class="string-literal">"\r\n"</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">items_output</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output</span> <span class="relational-operator">==</span> <span class="string-literal">"console"</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">line</span> <span class="relational-operator">in</span> <span class="identifier">output_message</span><span class="punctuation">.</span><span class="identifier">splitlines</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="identifier">line</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output</span> <span class="relational-operator">==</span> <span class="string-literal">"file"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_file</span><span class="grouping">(</span><span class="identifier">output_message</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">items_output</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_output_folder</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return output folder. Needs to be in the root if input is a
            video and processing frames """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_video</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span> <span class="relational-operator">==</span> <span class="string-literal">"frames"</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">dirname</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_source_dir</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_source_dir</span>

    <span class="keyword">def</span> <span class="identifier">_get_filename_prefix</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Video name needs to be prefixed to filename if input is a
            video and processing frames """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_video</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span> <span class="relational-operator">==</span> <span class="string-literal">"frames"</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="string-literal">"{}_"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">basename</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_source_dir</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="string-literal">""</span>

    <span class="keyword">def</span> <span class="identifier">output_file</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">output_message</span><span class="punctuation">,</span> <span class="identifier">items_discovered</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Save the output to a text file in the frames directory """</span>
        <span class="identifier">now</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datetime</span><span class="punctuation">.</span><span class="identifier">now</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">strftime</span><span class="grouping">(</span><span class="string-literal">"%Y%m%d_%H%M%S"</span><span class="grouping">)</span>
        <span class="identifier">dst_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_output_folder</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">filename</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{}{}_{}.txt"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_filename_prefix</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">" ", "_"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                        <span class="identifier">now</span><span class="grouping">)</span>
        <span class="identifier">output_file</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">dst_dir</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Saving %s result(s) to '%s'"</span><span class="punctuation">,</span> <span class="identifier">items_discovered</span><span class="punctuation">,</span> <span class="identifier">output_file</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">output_file</span><span class="punctuation">,</span> <span class="string-literal">"w"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f_output</span><span class="punctuation">:</span>
            <span class="identifier">f_output</span><span class="punctuation">.</span><span class="identifier">write</span><span class="grouping">(</span><span class="identifier">output_message</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_move_file</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">items_output</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Move the identified frames to a new sub folder """</span>
        <span class="identifier">now</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datetime</span><span class="punctuation">.</span><span class="identifier">now</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">strftime</span><span class="grouping">(</span><span class="string-literal">"%Y%m%d_%H%M%S"</span><span class="grouping">)</span>
        <span class="identifier">folder_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{}{}_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_filename_prefix</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                       <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output_message</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">" ", "_"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">now</span><span class="grouping">)</span>
        <span class="identifier">dst_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_output_folder</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">output_folder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">dst_dir</span><span class="punctuation">,</span> <span class="identifier">folder_name</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Creating folder: '%s'"</span><span class="punctuation">,</span> <span class="identifier">output_folder</span><span class="grouping">)</span>
        <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">makedirs</span><span class="grouping">(</span><span class="identifier">output_folder</span><span class="grouping">)</span>
        <span class="identifier">move</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">"_move_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_type</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Move function: %s"</span><span class="punctuation">,</span> <span class="identifier">move</span><span class="grouping">)</span>
        <span class="identifier">move</span><span class="grouping">(</span><span class="identifier">output_folder</span><span class="punctuation">,</span> <span class="identifier">items_output</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_move_frames</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">output_folder</span><span class="punctuation">,</span> <span class="identifier">items_output</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Move frames into single sub folder """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Moving %s frame(s) to '%s'"</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">items_output</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">output_folder</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">frame</span> <span class="relational-operator">in</span> <span class="identifier">items_output</span><span class="punctuation">:</span>
            <span class="identifier">src</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_source_dir</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="grouping">)</span>
            <span class="identifier">dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">output_folder</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Moving: '%s' to '%s'"</span><span class="punctuation">,</span> <span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
            <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">rename</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_move_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">output_folder</span><span class="punctuation">,</span> <span class="identifier">items_output</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Make additional sub folders for each face that appears
            Enables easier manual sorting """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Moving %s faces(s) to '%s'"</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">items_output</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">output_folder</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">items_output</span><span class="punctuation">:</span>
            <span class="identifier">src</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_source_dir</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="grouping">)</span>
            <span class="identifier">dst_folder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">output_folder</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">idx</span> <span class="relational-operator">!=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="keyword">else</span> <span class="identifier">output_folder</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">isdir</span><span class="grouping">(</span><span class="identifier">dst_folder</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Creating folder: '%s'"</span><span class="punctuation">,</span> <span class="identifier">dst_folder</span><span class="grouping">)</span>
                <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">makedirs</span><span class="grouping">(</span><span class="identifier">dst_folder</span><span class="grouping">)</span>
            <span class="identifier">dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">dst_folder</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Moving: '%s' to '%s'"</span><span class="punctuation">,</span> <span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
            <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">rename</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">Draw</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-few-public-methods</span>
    <span class="comment">""" Draws annotations onto original frames and saves into a sub-folder next to the original
    frames.

    Parameters
    ---------
    alignments: :class:`tools.alignments.media.AlignmentsData`
        The loaded alignments corresponding to the frames to be annotated
    arguments: :class:`argparse.Namespace`
        The command line arguments that have called this job
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">alignments</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (arguments: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alignments</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Frames</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">frames_dir</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output_folder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_output</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mesh_areas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">mouth</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">48</span><span class="punctuation">,</span> <span class="int-literal">68</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">right_eyebrow</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">17</span><span class="punctuation">,</span> <span class="int-literal">22</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">left_eyebrow</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">22</span><span class="punctuation">,</span> <span class="int-literal">27</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">right_eye</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">36</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">left_eye</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">48</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">nose</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">27</span><span class="punctuation">,</span> <span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">jaw</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">17</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">chin</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_set_output</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the output folder path.

        If annotating a folder of frames, output will be placed in a sub folder within the frames
        folder. If annotating a video, output will be a folder next to the original video.

        Returns
        -------
        str
            Full path to the output folder

        """</span>
        <span class="identifier">now</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datetime</span><span class="punctuation">.</span><span class="identifier">now</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">strftime</span><span class="grouping">(</span><span class="string-literal">"%Y%m%d_%H%M%S"</span><span class="grouping">)</span>
        <span class="identifier">folder_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"drawn_landmarks_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">now</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">.</span><span class="identifier">is_video</span><span class="punctuation">:</span>
            <span class="identifier">dest_folder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">dirname</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">.</span><span class="identifier">folder</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">dest_folder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">.</span><span class="identifier">folder</span>
        <span class="identifier">output_folder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">dest_folder</span><span class="punctuation">,</span> <span class="identifier">folder_name</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Creating folder: '%s'"</span><span class="punctuation">,</span> <span class="identifier">output_folder</span><span class="grouping">)</span>
        <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">makedirs</span><span class="grouping">(</span><span class="identifier">output_folder</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">output_folder</span>

    <span class="keyword">def</span> <span class="identifier">process</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Runs the process to draw face annotations onto original source frames. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"[DRAW LANDMARKS]"</span><span class="grouping">)</span>  <span class="comment"># Tidy up cli output</span>
        <span class="identifier">frames_drawn</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="keyword">for</span> <span class="identifier">frame</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">.</span><span class="identifier">file_list_sorted</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Drawing landmarks"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">frame_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">frame</span><span class="grouping">[</span><span class="string-literal">"frame_fullname"</span><span class="grouping">]</span>

            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">frame_exists</span><span class="grouping">(</span><span class="identifier">frame_name</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Skipping '%s' - Alignments not found"</span><span class="punctuation">,</span> <span class="identifier">frame_name</span><span class="grouping">)</span>
                <span class="keyword">continue</span>

            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_annotate_image</span><span class="grouping">(</span><span class="identifier">frame_name</span><span class="grouping">)</span>
            <span class="identifier">frames_drawn</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"%s Frame(s) output"</span><span class="punctuation">,</span> <span class="identifier">frames_drawn</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_annotate_image</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">frame_name</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Annotate the frame with each face that appears in the alignments file.

        Parameters
        ----------
        frame_name: str
            The full path to the original frame
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Annotating frame: '%s'"</span><span class="punctuation">,</span> <span class="identifier">frame_name</span><span class="grouping">)</span>
        <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">.</span><span class="identifier">load_image</span><span class="grouping">(</span><span class="identifier">frame_name</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">alignment</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">get_faces_in_frame</span><span class="grouping">(</span><span class="identifier">frame_name</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DetectedFace</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">face</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">n</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">alignment</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">image</span><span class="grouping">)</span>
            <span class="comment"># Bounding Box</span>
            <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">rectangle</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">left</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">top</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">right</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">bottom</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_annotate_landmarks</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"int32"</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_annotate_extract_boxes</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_annotate_pose</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="grouping">)</span>  <span class="comment"># Pose (head is still loaded)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">.</span><span class="identifier">save_image</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output_folder</span><span class="punctuation">,</span> <span class="identifier">frame_name</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_annotate_landmarks</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Annotate the extract boxes onto the frame.

        Parameters
        ----------
        image: :class:`numpy.ndarray`
            The frame that extract boxes are to be annotated on to
        landmarks: :class:`numpy.ndarray`
            The 68 point landmarks that are to be annotated onto the frame
        index: int
            The face index for the given face
        """</span>
        <span class="comment"># Mesh</span>
        <span class="keyword">for</span> <span class="identifier">area</span><span class="punctuation">,</span> <span class="identifier">indices</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mesh_areas</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">fill</span> <span class="arithmetic-assignment">=</span> <span class="identifier">area</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"right_eye", "left_eye", "mouth"</span><span class="grouping">)</span>
            <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">polylines</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">landmarks</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span><span class="identifier">indices</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="comment"># Landmarks</span>
        <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">pos_x</span><span class="punctuation">,</span> <span class="identifier">pos_y</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">landmarks</span><span class="punctuation">:</span>
            <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">circle</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">pos_x</span><span class="punctuation">,</span> <span class="identifier">pos_y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_annotate_extract_boxes</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">index</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Annotate the mesh and landmarks boxes onto the frame.

        Parameters
        ----------
        image: :class:`numpy.ndarray`
            The frame that mesh and landmarks are to be annotated on to
        face: :class:`lib.align.AlignedFace`
            The aligned face
        """</span>
        <span class="keyword">for</span> <span class="identifier">area</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"face", "head"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">load_aligned</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="identifier">area</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
            <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">area</span> <span class="relational-operator">==</span> <span class="string-literal">"face"</span> <span class="keyword">else</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="grouping">)</span>
            <span class="identifier">top_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">original_roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>  <span class="comment"># pylint:disable=unsubscriptable-object</span>
            <span class="identifier">top_left</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">top_left</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">top_left</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">10</span><span class="grouping">)</span>
            <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">putText</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">index</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">top_left</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">FONT_HERSHEY_DUPLEX</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">polylines</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">original_roi</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_annotate_pose</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Annotate the pose onto the frame.

        Parameters
        ----------
        image: :class:`numpy.ndarray`
            The frame that pose is to be annotated on to
        face: :class:`lib.align.AlignedFace`
            The aligned face loaded for head centering
        """</span>
        <span class="identifier">center</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">center</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">transform_points</span><span class="grouping">(</span><span class="identifier">center</span><span class="punctuation">,</span> <span class="identifier">invert</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"int32"</span><span class="grouping">)</span>
        <span class="identifier">points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">pose</span><span class="punctuation">.</span><span class="identifier">xyz_2d</span> <span class="arithmetic-operator">*</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">size</span>
        <span class="identifier">points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">transform_points</span><span class="grouping">(</span><span class="identifier">points</span><span class="punctuation">,</span> <span class="identifier">invert</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"int32"</span><span class="grouping">)</span>
        <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">line</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">center</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">points</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">line</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">center</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">points</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">line</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">center</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">points</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">Extract</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-few-public-methods</span>
    <span class="comment">""" Re-extract faces from source frames based on Alignment data

    Parameters
    ----------
    alignments: :class:`tools.lib_alignments.media.AlignmentData`
        The alignments data loaded from an alignments file for this rename job
    arguments: :class:`argparse.Namespace`
        The :mod:`argparse` arguments as passed in from :mod:`tools.py`
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">alignments</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (arguments: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_arguments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arguments</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alignments</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_legacy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">version</span> <span class="relational-operator">==</span> <span class="float-literal">1.0</span>  <span class="comment"># pylint:disable=protected-access</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_pipeline</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">faces_dir</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Frames</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">frames_dir</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_extracted_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ExtractedFaces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">,</span>
                                               <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">,</span>
                                               <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_saver</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">process</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Run the re-extraction from Alignments file process"""</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"[EXTRACT FACES]"</span><span class="grouping">)</span>  <span class="comment"># Tidy up cli output</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_folder</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_legacy</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_legacy_check</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_saver</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ImagesSaver</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dir</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">b</span><span class="invalid">y</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_export_faces</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_check_folder</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check that the faces folder doesn't pre-exist and create. """</span>
        <span class="identifier">err</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dir</span><span class="punctuation">:</span>
            <span class="identifier">err</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"ERROR: Output faces folder not provided."</span>
        <span class="keyword">elif</span> <span class="logical-operator">not</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">isdir</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dir</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Creating folder: '%s'"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dir</span><span class="grouping">)</span>
            <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">makedirs</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dir</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">listdir</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dir</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">err</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"ERROR: Output faces folder should be empty: '{}'"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dir</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">err</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="identifier">err</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Creating output folder at '%s'"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dir</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_legacy_check</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check whether the alignments file was created with the legacy extraction method.

        If so, force user to re-extract all faces if any options have been specified, otherwise
        raise the appropriate warnings and set the legacy options.
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_arguments</span><span class="punctuation">.</span><span class="identifier">large</span> <span class="logical-operator">or</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_arguments</span><span class="punctuation">.</span><span class="identifier">extract_every_n</span> <span class="relational-operator">!=</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">warning</span><span class="grouping">(</span><span class="string-literal">"This alignments file was generated with the legacy extraction method."</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">warning</span><span class="grouping">(</span><span class="string-literal">"You should run this extraction job, but with 'large' deselected and "</span>
                           <span class="string-literal">"'extract-every-n' set to 1 to update the alignments file."</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">warning</span><span class="grouping">(</span><span class="string-literal">"You can then re-run this extraction job with your chosen options."</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="identifier">maskers</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"components", "extended"</span><span class="grouping">]</span>
        <span class="identifier">nn_masks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">mask</span> <span class="keyword">for</span> <span class="identifier">mask</span> <span class="relational-operator">in</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">mask_summary</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">mask</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">maskers</span><span class="grouping">]</span>
        <span class="identifier">logtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">warning</span> <span class="keyword">if</span> <span class="identifier">nn_masks</span> <span class="keyword">else</span> <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span>
        <span class="identifier">logtype</span><span class="grouping">(</span><span class="string-literal">"This alignments file was created with the legacy extraction method and will be "</span>
                <span class="string-literal">"updated."</span><span class="grouping">)</span>
        <span class="identifier">logtype</span><span class="grouping">(</span><span class="string-literal">"Faces will be extracted using the new method and landmarks based masks will be "</span>
                <span class="string-literal">"regenerated."</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">nn_masks</span><span class="punctuation">:</span>
            <span class="identifier">logtype</span><span class="grouping">(</span><span class="string-literal">"However, the NN based masks '%s' will be cropped to the legacy extraction "</span>
                    <span class="string-literal">"method, so you may want to run the mask tool to regenerate these "</span>
                    <span class="string-literal">"masks.", "', '"</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">nn_masks</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Extractor</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">maskers</span><span class="punctuation">,</span> <span class="identifier">multiprocess</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_pipeline</span><span class="punctuation">.</span><span class="identifier">launch</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="comment"># Update alignments versioning</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">_version</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_VERSION</span>  <span class="comment"># pylint:disable=protected-access</span>

    <span class="keyword">def</span> <span class="identifier">_export_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Export the faces to the output folder. """</span>
        <span class="identifier">extracted_faces</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">skip_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_skip_list</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">.</span><span class="identifier">count</span> <span class="keyword">if</span> <span class="identifier">skip_list</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">.</span><span class="identifier">count</span> <span class="arithmetic-operator">-</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">skip_list</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">.</span><span class="identifier">stream</span><span class="grouping">(</span><span class="identifier">skip_list</span><span class="arithmetic-assignment">=</span><span class="identifier">skip_list</span><span class="grouping">)</span><span class="punctuation">,</span>
                                    <span class="identifier">total</span><span class="arithmetic-assignment">=</span><span class="identifier">count</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Saving extracted faces"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">frame_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">basename</span><span class="grouping">(</span><span class="identifier">filename</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">frame_exists</span><span class="grouping">(</span><span class="identifier">frame_name</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Skipping '%s' - Alignments not found"</span><span class="punctuation">,</span> <span class="identifier">frame_name</span><span class="grouping">)</span>
                <span class="keyword">continue</span>
            <span class="identifier">extracted_faces</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output_faces</span><span class="grouping">(</span><span class="identifier">frame_name</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_legacy</span> <span class="logical-operator">and</span> <span class="identifier">extracted_faces</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_arguments</span><span class="punctuation">.</span><span class="identifier">large</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">save</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"%s face(s) extracted"</span><span class="punctuation">,</span> <span class="identifier">extracted_faces</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_set_skip_list</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the indices for frames that should be skipped based on the `extract_every_n`
        command line option.

        Returns
        -------
        list or ``None``
            A list of indices to be skipped if extract_every_n is not `1` otherwise
            returns ``None``
        """</span>
        <span class="identifier">skip_num</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_arguments</span><span class="punctuation">.</span><span class="identifier">extract_every_n</span>
        <span class="keyword">if</span> <span class="identifier">skip_num</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Not skipping any frames"</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="none-literal">None</span>
        <span class="identifier">skip_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">.</span><span class="identifier">file_list_sorted</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">idx</span> <span class="arithmetic-operator">%</span> <span class="identifier">skip_num</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Adding image '%s' to skip list due to extract_every_n = %s"</span><span class="punctuation">,</span>
                             <span class="identifier">item</span><span class="grouping">[</span><span class="string-literal">"frame_fullname"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">skip_num</span><span class="grouping">)</span>
                <span class="identifier">skip_list</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Adding skip list: %s"</span><span class="punctuation">,</span> <span class="identifier">skip_list</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">skip_list</span>

    <span class="keyword">def</span> <span class="identifier">_output_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" For each frame save out the faces

        Parameters
        ----------
        filename: str
            The filename (without the full path) of the current frame
        image: :class:`numpy.ndarray`
            The full frame that faces are to be extracted from

        Returns
        -------
        int
            The total number of faces that have been extracted
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Outputting frame: %s"</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
        <span class="identifier">face_count</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">frame_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">splitext</span><span class="grouping">(</span><span class="identifier">filename</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_select_valid_faces</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">faces</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">face_count</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_legacy</span><span class="punctuation">:</span>
            <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_process_legacy</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">faces</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">face</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">output</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{}_{}.png"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">frame_name</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">meta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">alignments</span><span class="arithmetic-assignment">=</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">to_png_meta</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">source</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">alignments_version</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">version</span><span class="punctuation">,</span>
                                    <span class="identifier">original_filename</span><span class="arithmetic-assignment">=</span><span class="identifier">output</span><span class="punctuation">,</span>
                                    <span class="identifier">face_index</span><span class="arithmetic-assignment">=</span><span class="identifier">idx</span><span class="punctuation">,</span>
                                    <span class="identifier">source_filename</span><span class="arithmetic-assignment">=</span><span class="identifier">filename</span><span class="punctuation">,</span>
                                    <span class="identifier">source_is_video</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames</span><span class="punctuation">.</span><span class="identifier">is_video</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_saver</span><span class="punctuation">.</span><span class="identifier">save</span><span class="grouping">(</span><span class="identifier">output</span><span class="punctuation">,</span> <span class="identifier">encode_image</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="string-literal">".png"</span><span class="punctuation">,</span> <span class="identifier">metadata</span><span class="arithmetic-assignment">=</span><span class="identifier">meta</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_arguments</span><span class="punctuation">.</span><span class="identifier">large</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_legacy</span><span class="punctuation">:</span>
                <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">thumbnail</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generate_thumbnail</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">96</span><span class="punctuation">,</span> <span class="identifier">quality</span><span class="arithmetic-assignment">=</span><span class="int-literal">60</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">filename</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"faces"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">to_alignment</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">face_count</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_saver</span><span class="punctuation">.</span><span class="identifier">close</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">face_count</span>

    <span class="keyword">def</span> <span class="identifier">_select_valid_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return the aligned faces from a frame that meet the selection criteria,

        Parameters
        ----------
        frame: str
            The filename (without the full path) of the current frame
        image: :class:`numpy.ndarray`
            The full frame that faces are to be extracted from

        Returns
        -------
        list:
            List of valid :class:`lib,align.DetectedFace` objects
        """</span>
        <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_extracted_faces</span><span class="punctuation">.</span><span class="identifier">get_faces_in_frame</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">image</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_arguments</span><span class="punctuation">.</span><span class="identifier">large</span><span class="punctuation">:</span>
            <span class="identifier">valid_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">faces</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">sizes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_extracted_faces</span><span class="punctuation">.</span><span class="identifier">get_roi_size_for_frame</span><span class="grouping">(</span><span class="identifier">frame</span><span class="grouping">)</span>
            <span class="identifier">valid_faces</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">faces</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">size</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">sizes</span><span class="grouping">)</span>
                           <span class="keyword">if</span> <span class="identifier">size</span> <span class="relational-operator">&gt;=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_extracted_faces</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"frame: '%s', total_faces: %s, valid_faces: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">valid_faces</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">valid_faces</span>

    <span class="keyword">def</span> <span class="identifier">_process_legacy</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Process legacy face extractions to new extraction method.

        Updates stored masks to new extract size

        Parameters
        ----------
        filename: str
            The current frame filename
        image: :class:`numpy.ndarray`
            The current image the contains the faces
        detected_faces: list
            list of :class:`lib.align.DetectedFace` objects for the current frame
        """</span>
        <span class="comment"># Update landmarks based masks for face centering</span>
        <span class="identifier">mask_item</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ExtractMedia</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="arithmetic-assignment">=</span><span class="identifier">detected_faces</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_pipeline</span><span class="punctuation">.</span><span class="identifier">input_queue</span><span class="punctuation">.</span><span class="identifier">put</span><span class="grouping">(</span><span class="identifier">mask_item</span><span class="grouping">)</span>
        <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_pipeline</span><span class="punctuation">.</span><span class="identifier">detected_faces</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">detected_faces</span>

        <span class="comment"># Pad and shift Neural Network based masks to face centering</span>
        <span class="keyword">for</span> <span class="identifier">face</span> <span class="relational-operator">in</span> <span class="identifier">faces</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pad_legacy_masks</span><span class="grouping">(</span><span class="identifier">face</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">faces</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_pad_legacy_masks</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">detected_face</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Recenter legacy Neural Network based masks from legacy centering to face centering
        and pad accordingly.

        Update the masks back into the detected face objects.

        Parameters
        ----------
        detected_face: :class:`lib.align.DetectedFace`
            The detected face to update the masks for
        """</span>
        <span class="identifier">offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">detected_face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">pose</span><span class="punctuation">.</span><span class="identifier">offset</span><span class="grouping">[</span><span class="string-literal">"face"</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">mask</span> <span class="relational-operator">in</span> <span class="identifier">detected_face</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># Re-center mask and pad to face size</span>
            <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"components", "extended"</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
            <span class="identifier">old_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">255.0</span>
            <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">old_mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">new_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">size</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">size</span> <span class="arithmetic-operator">*</span> <span class="identifier">_EXTRACT_RATIOS</span><span class="grouping">[</span><span class="string-literal">"face"</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span>

            <span class="identifier">shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="identifier">offset</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">size</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">size</span> <span class="arithmetic-operator">*</span> <span class="identifier">_EXTRACT_RATIOS</span><span class="grouping">[</span><span class="string-literal">"face"]))).astype("int32"</span><span class="grouping">)</span>
            <span class="identifier">pos</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">new_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span> <span class="arithmetic-operator">-</span> <span class="identifier">size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">shift</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">(</span><span class="identifier">new_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">shift</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">(</span><span class="identifier">new_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span> <span class="arithmetic-operator">-</span> <span class="identifier">size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">shift</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">(</span><span class="identifier">new_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">shift</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">bounds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">pos</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">new_size</span><span class="punctuation">,</span> <span class="identifier">pos</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                               <span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">pos</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">new_size</span><span class="punctuation">,</span> <span class="identifier">pos</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

            <span class="identifier">slice_in</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">slice</span><span class="grouping">(</span><span class="int-literal">0</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">pos</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">bounds</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">size</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">pos</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">bounds</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">slice</span><span class="grouping">(</span><span class="int-literal">0</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">pos</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">bounds</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">size</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">pos</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">bounds</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
            <span class="identifier">slice_out</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">bounds</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">bounds</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">bounds</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">bounds</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>

            <span class="identifier">new_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">new_size</span><span class="punctuation">,</span> <span class="identifier">new_size</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
            <span class="identifier">new_mask</span><span class="grouping">[</span><span class="identifier">slice_out</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">slice_out</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">old_mask</span><span class="grouping">[</span><span class="identifier">slice_in</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">slice_in</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>

            <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">replace_mask</span><span class="grouping">(</span><span class="identifier">new_mask</span><span class="grouping">)</span>
            <span class="comment"># Get the affine matrix from recently generated components mask</span>
            <span class="comment"># pylint:disable=protected-access</span>
            <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">_affine_matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">detected_face</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="string-literal">"components"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">affine_matrix</span>


<span class="keyword">class</span> <span class="identifier">RemoveFaces</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-few-public-methods</span>
    <span class="comment">""" Remove items from alignments file.

    Parameters
    ---------
    alignments: :class:`tools.alignments.media.AlignmentsData`
        The loaded alignments containing faces to be removed
    arguments: :class:`argparse.Namespace`
        The command line arguments that have called this job
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">alignments</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (arguments: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alignments</span>

        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">alignments</span><span class="punctuation">.</span><span class="identifier">version</span> <span class="relational-operator">&lt;</span> <span class="float-literal">2.1</span><span class="punctuation">:</span>
            <span class="comment"># Update headers of faces generated with hash based alignments</span>
            <span class="identifier">kwargs</span><span class="grouping">[</span><span class="string-literal">"alignments"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alignments</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Faces</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">faces_dir</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">process</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Run the job to remove faces from an alignments file that do not exist within a faces
        folder. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"[REMOVE FACES FROM ALIGNMENTS]"</span><span class="grouping">)</span>  <span class="comment"># Tidy up cli output</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span><span class="punctuation">.</span><span class="identifier">items</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"No matching faces found in your faces folder. This would remove all "</span>
                         <span class="string-literal">"faces from your alignments file. Process aborted."</span><span class="grouping">)</span>
            <span class="keyword">return</span>

        <span class="identifier">pre_face_count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">faces_count</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">filter_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span><span class="punctuation">.</span><span class="identifier">items</span><span class="punctuation">,</span> <span class="identifier">filter_out</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pre_face_count</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">faces_count</span>
        <span class="keyword">if</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"No changes made to alignments file. Exiting"</span><span class="grouping">)</span>
            <span class="keyword">return</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"%s alignment(s) were removed from alignments file"</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">t</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_png_headers</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">save</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">rename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Rename</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span><span class="grouping">)</span>
        <span class="identifier">rename</span><span class="punctuation">.</span><span class="identifier">process</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_png_headers</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the EXIF iTXt field of any face PNGs that have had their face index changed.

        Notes
        -----
        This could be quicker if parellizing in threads, however, Windows (at least) does not seem
        to like this and has a tendency to throw permission errors, so this remains single threaded
        for now.
        """</span>
        <span class="identifier">to_update</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>  <span class="comment"># Items whose face index has changed</span>
            <span class="identifier">x</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span><span class="punctuation">.</span><span class="identifier">file_list_sorted</span>
            <span class="keyword">if</span> <span class="identifier">x</span><span class="grouping">[</span><span class="string-literal">"face_index"] != self._items.items[x["source_filename"]].index(x["face_index"</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>

        <span class="keyword">for</span> <span class="identifier">file_info</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">to_update</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Updating PNG Headers"</span><span class="punctuation">,</span> <span class="identifier">leave</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">file_info</span><span class="grouping">[</span><span class="string-literal">"source_filename"</span><span class="grouping">]</span>
            <span class="identifier">face_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">file_info</span><span class="grouping">[</span><span class="string-literal">"face_index"</span><span class="grouping">]</span>
            <span class="identifier">new_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">[</span><span class="identifier">frame</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">(</span><span class="identifier">face_index</span><span class="grouping">)</span>

            <span class="identifier">fullpath</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_items</span><span class="punctuation">.</span><span class="identifier">folder</span><span class="punctuation">,</span> <span class="identifier">file_info</span><span class="grouping">[</span><span class="string-literal">"current_filename"</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Updating png header for '%s': face index from %s to %s"</span><span class="punctuation">,</span>
                         <span class="identifier">fullpath</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">new_index</span><span class="grouping">)</span>

            <span class="comment"># Update file_list_sorted for rename task</span>
            <span class="identifier">orig_filename</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{}_{}.png"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">splitext</span><span class="grouping">(</span><span class="identifier">frame</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">new_index</span><span class="grouping">)</span>
            <span class="identifier">file_info</span><span class="grouping">[</span><span class="string-literal">"face_index"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">new_index</span>
            <span class="identifier">file_info</span><span class="grouping">[</span><span class="string-literal">"original_filename"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">orig_filename</span>

            <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DetectedFace</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">face</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">n</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">get_faces_in_frame</span><span class="grouping">(</span><span class="identifier">frame</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">new_index</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">meta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">alignments</span><span class="arithmetic-assignment">=</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">to_png_meta</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">source</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">alignments_version</span><span class="arithmetic-assignment">=</span><span class="identifier">file_info</span><span class="grouping">[</span><span class="string-literal">"alignments_version"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">original_filename</span><span class="arithmetic-assignment">=</span><span class="identifier">orig_filename</span><span class="punctuation">,</span>
                                    <span class="identifier">face_index</span><span class="arithmetic-assignment">=</span><span class="identifier">new_index</span><span class="punctuation">,</span>
                                    <span class="identifier">source_filename</span><span class="arithmetic-assignment">=</span><span class="identifier">frame</span><span class="punctuation">,</span>
                                    <span class="identifier">source_is_video</span><span class="arithmetic-assignment">=</span><span class="identifier">file_info</span><span class="grouping">[</span><span class="string-literal">"source_is_video"</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">update_existing_metadata</span><span class="grouping">(</span><span class="identifier">fullpath</span><span class="punctuation">,</span> <span class="identifier">meta</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"%s Extracted face(s) had their header information updated"</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">to_update</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">Rename</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-few-public-methods</span>
    <span class="comment">""" Rename faces in a folder to match their filename as stored in an alignments file.

    Parameters
    ----------
    alignments: :class:`tools.lib_alignments.media.AlignmentData`
        The alignments data loaded from an alignments file for this rename job
    arguments: :class:`argparse.Namespace`
        The :mod:`argparse` arguments as passed in from :mod:`tools.py`
    faces: :class:`tools.lib_alignments.media.Faces`, Optional
        An optional faces object, if the rename task is being called by another job.
        Default: ``None``
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">alignments</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">,</span> <span class="identifier">faces</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (arguments: %s, faces: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">,</span> <span class="identifier">faces</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alignments</span>

        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">alignments</span><span class="punctuation">.</span><span class="identifier">version</span> <span class="relational-operator">&lt;</span> <span class="float-literal">2.1</span><span class="punctuation">:</span>
            <span class="comment"># Update headers of faces generated with hash based alignments</span>
            <span class="identifier">kwargs</span><span class="grouping">[</span><span class="string-literal">"alignments"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alignments</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">faces</span> <span class="keyword">if</span> <span class="identifier">faces</span> <span class="keyword">else</span> <span class="identifier">Faces</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">faces_dir</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">process</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Process the face renaming """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"[RENAME FACES]"</span><span class="grouping">)</span>  <span class="comment"># Tidy up cli output</span>
        <span class="identifier">rename_mappings</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">face</span><span class="grouping">[</span><span class="string-literal">"current_filename"], face["original_filename"</span><span class="grouping">]</span><span class="grouping">)</span>
                                  <span class="keyword">for</span> <span class="identifier">face</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="punctuation">.</span><span class="identifier">file_list_sorted</span>
                                  <span class="keyword">if</span> <span class="identifier">face</span><span class="grouping">[</span><span class="string-literal">"current_filename"] != face["original_filename"</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                                 <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">rename_count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_rename_faces</span><span class="grouping">(</span><span class="identifier">rename_mappings</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"%s faces renamed"</span><span class="punctuation">,</span> <span class="identifier">rename_count</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_rename_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">filename_mappings</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Rename faces back to their original name as exists in the alignments file.

        If the source and destination filename are the same then skip that file.

        Parameters
        ----------
        filename_mappings: list
            List of tuples of (`source filename`, `destination filename`) ordered by destination
            filename

        Returns
        -------
        int
            The number of faces that have been renamed
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">filename_mappings</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="int-literal">0</span>

        <span class="identifier">rename_count</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">conflicts</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">filename_mappings</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Renaming Faces"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">old</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="punctuation">.</span><span class="identifier">folder</span><span class="punctuation">,</span> <span class="identifier">src</span><span class="grouping">)</span>
            <span class="identifier">new</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="punctuation">.</span><span class="identifier">folder</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">new</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># Interim add .tmp extension to files that will cause a rename conflict, to</span>
                <span class="comment"># process afterwards</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"interim renaming file to avoid conflict: (src: '%s', dst: '%s')"</span><span class="punctuation">,</span>
                             <span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
                <span class="identifier">new</span> <span class="arithmetic-assignment">=</span> <span class="identifier">new</span> <span class="arithmetic-operator">+</span> <span class="string-literal">".tmp"</span>
                <span class="identifier">conflicts</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">new</span><span class="grouping">)</span>

            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Renaming '%s' to '%s'"</span><span class="punctuation">,</span> <span class="identifier">old</span><span class="punctuation">,</span> <span class="identifier">new</span><span class="grouping">)</span>
            <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">rename</span><span class="grouping">(</span><span class="identifier">old</span><span class="punctuation">,</span> <span class="identifier">new</span><span class="grouping">)</span>
            <span class="identifier">rename_count</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
        <span class="keyword">if</span> <span class="identifier">conflicts</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">old</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">conflicts</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Renaming Faces"</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">new</span> <span class="arithmetic-assignment">=</span> <span class="identifier">old</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="grouping">]</span>  <span class="comment"># Remove .tmp extension</span>
                <span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">new</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="comment"># This should only be running on faces. If there is still a conflict</span>
                    <span class="comment"># then the user has done something stupid, so we will delete the file and</span>
                    <span class="comment"># replace. They can always re-extract :/</span>
                    <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">remove</span><span class="grouping">(</span><span class="identifier">new</span><span class="grouping">)</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Renaming '%s' to '%s'"</span><span class="punctuation">,</span> <span class="identifier">old</span><span class="punctuation">,</span> <span class="identifier">new</span><span class="grouping">)</span>
                <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">rename</span><span class="grouping">(</span><span class="identifier">old</span><span class="punctuation">,</span> <span class="identifier">new</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">rename_count</span>


<span class="keyword">class</span> <span class="identifier">Sort</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Sort alignments' index by the order they appear in an image in left to right order.

    Parameters
    ----------
    alignments: :class:`tools.lib_alignments.media.AlignmentData`
        The alignments data loaded from an alignments file for this rename job
    arguments: :class:`argparse.Namespace`
        The :mod:`argparse` arguments as passed in from :mod:`tools.py`
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">alignments</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (arguments: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alignments</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">process</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Execute the sort process """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"[SORT INDEXES]"</span><span class="grouping">)</span>  <span class="comment"># Tidy up cli output</span>
        <span class="identifier">reindexed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">reindex_faces</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">reindexed</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">save</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">warning</span><span class="grouping">(</span><span class="string-literal">"If you have a face-set corresponding to the alignment file you "</span>
                           <span class="string-literal">"processed then you should run the 'Extract' job to regenerate it."</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">reindex_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Re-Index the faces """</span>
        <span class="identifier">reindexed</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="keyword">for</span> <span class="identifier">alignment</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="invalid">y</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Sort alignment indexes"</span><span class="punctuation">,</span> <span class="identifier">total</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">frames_count</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">alignments</span><span class="punctuation">,</span> <span class="identifier">count</span><span class="punctuation">,</span> <span class="identifier">key</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alignment</span>
            <span class="keyword">if</span> <span class="identifier">count</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">1</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"0 or 1 face in frame. Not sorting: '%s'"</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="grouping">)</span>
                <span class="keyword">continue</span>
            <span class="identifier">sorted_alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">alignments</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">x</span><span class="grouping">[</span><span class="string-literal">"x"</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">sorted_alignments</span> <span class="relational-operator">==</span> <span class="identifier">alignments</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Alignments already in correct order. Not sorting: '%s'"</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="grouping">)</span>
                <span class="keyword">continue</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Sorting alignments for frame: '%s'"</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"faces"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sorted_alignments</span>
            <span class="identifier">reindexed</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"%s Frames had their faces reindexed"</span><span class="punctuation">,</span> <span class="identifier">reindexed</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">reindexed</span>


<span class="keyword">class</span> <span class="identifier">Spatial</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Apply spatial temporal filtering to landmarks
        Adapted from:
        https://www.kaggle.com/selfishgene/animating-and-smoothing-3d-facial-keypoints/notebook """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">alignments</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (arguments: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">arguments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arguments</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alignments</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mappings</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalized</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">shapes_model</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">process</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Perform spatial filtering """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"[SPATIO-TEMPORAL FILTERING]"</span><span class="grouping">)</span>  <span class="comment"># Tidy up cli output</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"NB: The process only processes the alignments for the first "</span>
                    <span class="string-literal">"face it finds for any given frame. For best results only run this when "</span>
                    <span class="string-literal">"there is only a single face in the alignments file and all false positives "</span>
                    <span class="string-literal">"have been removed"</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalize</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">shape_model</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">spatially_filter</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">temporally_smooth</span><span class="grouping">(</span><span class="identifier">landmarks</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">update_alignments</span><span class="grouping">(</span><span class="identifier">landmarks</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">save</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">warning</span><span class="grouping">(</span><span class="string-literal">"If you have a face-set corresponding to the alignment file you "</span>
                       <span class="string-literal">"processed then you should run the 'Extract' job to regenerate it."</span><span class="grouping">)</span>

    <span class="comment"># Define shape normalization utility functions</span>
    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">normalize_shapes</span><span class="grouping">(</span><span class="identifier">shapes_im_coords</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Normalize a 2D or 3D shape """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Normalize shapes"</span><span class="grouping">)</span>
        <span class="grouping">(</span><span class="identifier">num_pts</span><span class="punctuation">,</span> <span class="identifier">num_dims</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shapes_im_coords</span><span class="punctuation">.</span><span class="identifier">shape</span>

        <span class="comment"># Calculate mean coordinates and subtract from shapes</span>
        <span class="identifier">mean_coords</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shapes_im_coords</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">shapes_centered</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shapes_im_coords</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="identifier">shapes_centered</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shapes_im_coords</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">mean_coords</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">num_pts</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Calculate scale factors and divide shapes</span>
        <span class="identifier">scale_factors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">shapes_centered</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">shapes_normalized</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shapes_centered</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="identifier">shapes_normalized</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shapes_centered</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">scale_factors</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">num_pts</span><span class="punctuation">,</span> <span class="identifier">num_dims</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Normalized shapes: (shapes_normalized: %s, scale_factors: %s, mean_coords: "</span>
                     <span class="string-literal">"%s"</span><span class="punctuation">,</span> <span class="identifier">shapes_normalized</span><span class="punctuation">,</span> <span class="identifier">scale_factors</span><span class="punctuation">,</span> <span class="identifier">mean_coords</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">shapes_normalized</span><span class="punctuation">,</span> <span class="identifier">scale_factors</span><span class="punctuation">,</span> <span class="identifier">mean_coords</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">normalized_to_original</span><span class="grouping">(</span><span class="identifier">shapes_normalized</span><span class="punctuation">,</span> <span class="identifier">scale_factors</span><span class="punctuation">,</span> <span class="identifier">mean_coords</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Transform a normalized shape back to original image coordinates """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Normalize to original"</span><span class="grouping">)</span>
        <span class="grouping">(</span><span class="identifier">num_pts</span><span class="punctuation">,</span> <span class="identifier">num_dims</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shapes_normalized</span><span class="punctuation">.</span><span class="identifier">shape</span>

        <span class="comment"># move back to the correct scale</span>
        <span class="identifier">shapes_centered</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shapes_normalized</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">scale_factors</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">num_pts</span><span class="punctuation">,</span> <span class="identifier">num_dims</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="comment"># move back to the correct location</span>
        <span class="identifier">shapes_im_coords</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shapes_centered</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">mean_coords</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">num_pts</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Normalized to original: %s"</span><span class="punctuation">,</span> <span class="identifier">shapes_im_coords</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">shapes_im_coords</span>

    <span class="keyword">def</span> <span class="identifier">normalize</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Compile all original and normalized alignments """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Normalize"</span><span class="grouping">)</span>
        <span class="identifier">count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">1</span> <span class="keyword">for</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">val</span><span class="grouping">[</span><span class="string-literal">"faces"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">landmarks_all</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">68</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">count</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">end</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Compiling"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"faces"</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">val</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
            <span class="comment"># We should only be normalizing a single face, so just take</span>
            <span class="comment"># the first landmarks found</span>
            <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">val</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"landmarks_xy"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">68</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">end</span>
            <span class="identifier">end</span> <span class="arithmetic-assignment">=</span> <span class="identifier">start</span> <span class="arithmetic-operator">+</span> <span class="identifier">landmarks</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span>
            <span class="comment"># Store in one big array</span>
            <span class="identifier">landmarks_all</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">start</span><span class="punctuation">:</span><span class="identifier">end</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">landmarks</span>
            <span class="comment"># Make sure we keep track of the mapping to the original frame</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mappings</span><span class="grouping">[</span><span class="identifier">start</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">key</span>

        <span class="comment"># Normalize shapes</span>
        <span class="identifier">normalized_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalize_shapes</span><span class="grouping">(</span><span class="identifier">landmarks_all</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalized</span><span class="grouping">[</span><span class="string-literal">"landmarks"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">normalized_shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalized</span><span class="grouping">[</span><span class="string-literal">"scale_factors"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">normalized_shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalized</span><span class="grouping">[</span><span class="string-literal">"mean_coords"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">normalized_shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Normalized: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalized</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">shape_model</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" build 2D shape model """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Shape model"</span><span class="grouping">)</span>
        <span class="identifier">landmarks_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalized</span><span class="grouping">[</span><span class="string-literal">"landmarks"</span><span class="grouping">]</span>
        <span class="identifier">num_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>
        <span class="identifier">normalized_shapes_tbl</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">landmarks_norm</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">68</span><span class="arithmetic-operator">*</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">landmarks_norm</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">shapes_model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">decomposition</span><span class="punctuation">.</span><span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">num_components</span><span class="punctuation">,</span>
                                              <span class="identifier">whiten</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                              <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">normalized_shapes_tbl</span><span class="grouping">)</span>
        <span class="identifier">explained</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">shapes_model</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Total explained percent by PCA model with %s components is %s%%"</span><span class="punctuation">,</span>
                    <span class="identifier">num_components</span><span class="punctuation">,</span> <span class="identifier">round</span><span class="grouping">(</span><span class="int-literal">100</span> <span class="arithmetic-operator">*</span> <span class="identifier">explained</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Shaped model"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">spatially_filter</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" interpret the shapes using our shape model
            (project and reconstruct) """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Spatially Filter"</span><span class="grouping">)</span>
        <span class="identifier">landmarks_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalized</span><span class="grouping">[</span><span class="string-literal">"landmarks"</span><span class="grouping">]</span>
        <span class="comment"># Convert to matrix form</span>
        <span class="identifier">landmarks_norm_table</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">landmarks_norm</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">68</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">landmarks_norm</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="comment"># Project onto shapes model and reconstruct</span>
        <span class="identifier">landmarks_norm_table_rec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">shapes_model</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">shapes_model</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">landmarks_norm_table</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># Convert back to shapes (numKeypoint, num_dims, numFrames)</span>
        <span class="identifier">landmarks_norm_rec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">landmarks_norm_table_rec</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span>
                                        <span class="grouping">[</span><span class="int-literal">68</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">landmarks_norm</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="comment"># Transform back to image co-ordinates</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalized_to_original</span><span class="grouping">(</span><span class="identifier">landmarks_norm_rec</span><span class="punctuation">,</span>
                                             <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalized</span><span class="grouping">[</span><span class="string-literal">"scale_factors"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                             <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalized</span><span class="grouping">[</span><span class="string-literal">"mean_coords"</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Spatially Filtered: %s"</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">temporally_smooth</span><span class="grouping">(</span><span class="identifier">landmarks</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" apply temporal filtering on the 2D points """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Temporally Smooth"</span><span class="grouping">)</span>
        <span class="identifier">filter_half_length</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
        <span class="identifier">temporal_filter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">filter_half_length</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">temporal_filter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">temporal_filter</span> <span class="arithmetic-operator">/</span> <span class="identifier">temporal_filter</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">start_tileblock</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">landmarks</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">filter_half_length</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">end_tileblock</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">landmarks</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">filter_half_length</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">landmarks_padded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">start_tileblock</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="punctuation">,</span> <span class="identifier">end_tileblock</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">signal</span><span class="punctuation">.</span><span class="identifier">convolve</span><span class="grouping">(</span><span class="identifier">landmarks_padded</span><span class="punctuation">,</span> <span class="identifier">temporal_filter</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'valid', method='fft'</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Temporally Smoothed: %s"</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">update_alignments</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update smoothed landmarks back to alignments """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Update alignments"</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">frame</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mappings</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Updating"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Updating: (frame: %s)"</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="grouping">)</span>
            <span class="identifier">landmarks_update</span> <span class="arithmetic-assignment">=</span> <span class="identifier">landmarks</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span>
            <span class="identifier">landmarks_xy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">landmarks_update</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">68</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">frame</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"faces"][0]["landmarks_xy"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">landmarks_xy</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Updated: (frame: '%s', landmarks: %s)"</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">landmarks_xy</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Updated alignments"</span><span class="grouping">)</span>

    </pre>
  </body>
</html>