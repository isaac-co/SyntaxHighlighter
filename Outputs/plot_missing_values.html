<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
====================================================
Imputing missing values before building an estimator
====================================================

Missing values can be replaced by the mean, the median or the most frequent
value using the basic :class:`~sklearn.impute.SimpleImputer`.

In this example we will investigate different imputation techniques:

- imputation by the constant value 0
- imputation by the mean value of each feature combined with a missing-ness
  indicator auxiliary variable
- k nearest neighbor imputation
- iterative imputation

We will use two datasets: Diabetes dataset which consists of 10 feature
variables collected from diabetes patients with an aim to predict disease
progression and California Housing dataset for which the target is the median
house value for California districts.

As neither of these datasets have missing values, we will remove some
values to create new versions with artificially missing data. The performance
of
:class:`~sklearn.ensemble.RandomForestRegressor` on the full original dataset
is then compared the performance on the altered datasets with the artificially
missing values imputed using different techniques.

"""</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>

<span class="comment"># Authors: Maria Telenczuk  &lt;https://github.com/maikia&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="comment"># %%</span>
<span class="comment"># Download the data and make missing values sets</span>
<span class="comment">################################################</span>
<span class="comment">#</span>
<span class="comment"># First we download the two datasets. Diabetes dataset is shipped with</span>
<span class="comment"># scikit-learn. It has 442 entries, each with 10 features. California Housing</span>
<span class="comment"># dataset is much larger with 20640 entries and 8 features. It needs to be</span>
<span class="comment"># downloaded. We will only use the first 400 entries for the sake of speeding</span>
<span class="comment"># up the calculations but feel free to use the whole dataset.</span>
<span class="comment">#</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">fetch_california_housing</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_diabetes</span>


<span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>

<span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_diabetes</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="identifier">X_california</span><span class="punctuation">,</span> <span class="identifier">y_california</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_california_housing</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="identifier">X_california</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_california</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">400</span><span class="grouping">]</span>
<span class="identifier">y_california</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_california</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">400</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">add_missing_values</span><span class="grouping">(</span><span class="identifier">X_full</span><span class="punctuation">,</span> <span class="identifier">y_full</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_full</span><span class="punctuation">.</span><span class="identifier">shape</span>

    <span class="comment"># Add missing values in 75% of the lines</span>
    <span class="identifier">missing_rate</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.75</span>
    <span class="identifier">n_missing_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="identifier">missing_rate</span><span class="grouping">)</span>

    <span class="identifier">missing_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">missing_samples</span><span class="grouping">[</span><span class="punctuation">:</span> <span class="identifier">n_missing_samples</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>

    <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">missing_samples</span><span class="grouping">)</span>
    <span class="identifier">missing_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_missing_samples</span><span class="grouping">)</span>
    <span class="identifier">X_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_full</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_missing</span><span class="grouping">[</span><span class="identifier">missing_samples</span><span class="punctuation">,</span> <span class="identifier">missing_features</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">y_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_full</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">X_missing</span><span class="punctuation">,</span> <span class="identifier">y_missing</span>


<span class="identifier">X_miss_california</span><span class="punctuation">,</span> <span class="identifier">y_miss_california</span> <span class="arithmetic-assignment">=</span> <span class="identifier">add_missing_values</span><span class="grouping">(</span>
    <span class="identifier">X_california</span><span class="punctuation">,</span> <span class="identifier">y_california</span><span class="grouping">)</span>

<span class="identifier">X_miss_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_miss_diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">add_missing_values</span><span class="grouping">(</span>
    <span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>


<span class="comment"># %%</span>
<span class="comment"># Impute the missing data and score</span>
<span class="comment"># #################################</span>
<span class="comment"># Now we will write a function which will score the results on the differently</span>
<span class="comment"># imputed data. Let's look at each imputer separately:</span>
<span class="comment">#</span>

<span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">RandomForestRegressor</span>

<span class="comment"># To use the experimental IterativeImputer, we need to explicitly ask for it:</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">experimental</span> <span class="keyword">import</span> <span class="identifier">enable_iterative_imputer</span>  <span class="comment"># noqa</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">impute</span> <span class="keyword">import</span> <span class="identifier">SimpleImputer</span><span class="punctuation">,</span> <span class="identifier">KNNImputer</span><span class="punctuation">,</span> <span class="identifier">IterativeImputer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">cross_val_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_pipeline</span>


<span class="identifier">N_SPLITS</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
<span class="identifier">regressor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Missing information</span>
<span class="comment"># -------------------</span>
<span class="comment"># In addition to imputing the missing values, the imputers have an</span>
<span class="comment"># `add_indicator` parameter that marks the values that were missing, which</span>
<span class="comment"># might carry some information.</span>
<span class="comment">#</span>


<span class="keyword">def</span> <span class="identifier">get_scores_for_imputer</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">,</span> <span class="identifier">X_missing</span><span class="punctuation">,</span> <span class="identifier">y_missing</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">,</span> <span class="identifier">regressor</span><span class="grouping">)</span>
    <span class="identifier">impute_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X_missing</span><span class="punctuation">,</span> <span class="identifier">y_missing</span><span class="punctuation">,</span>
                                    <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'neg_mean_squared_error'</span><span class="punctuation">,</span>
                                    <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">N_SPLITS</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">impute_scores</span>


<span class="identifier">x_labels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

<span class="identifier">mses_california</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>
<span class="identifier">stds_california</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>
<span class="identifier">mses_diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>
<span class="identifier">stds_diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Estimate the score</span>
<span class="comment"># ------------------</span>
<span class="comment"># First, we want to estimate the score on the original data:</span>
<span class="comment">#</span>


<span class="keyword">def</span> <span class="identifier">get_full_score</span><span class="grouping">(</span><span class="identifier">X_full</span><span class="punctuation">,</span> <span class="identifier">y_full</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">full_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="identifier">X_full</span><span class="punctuation">,</span> <span class="identifier">y_full</span><span class="punctuation">,</span>
                                  <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'neg_mean_squared_error'</span><span class="punctuation">,</span>
                                  <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">N_SPLITS</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">full_scores</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">full_scores</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="identifier">mses_california</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">stds_california</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_full_score</span><span class="grouping">(</span><span class="identifier">X_california</span><span class="punctuation">,</span>
                                                        <span class="identifier">y_california</span><span class="grouping">)</span>
<span class="identifier">mses_diabetes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">stds_diabetes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_full_score</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
<span class="identifier">x_labels</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="string-literal">'Full data'</span><span class="grouping">)</span>


<span class="comment"># %%</span>
<span class="comment"># Replace missing values by 0</span>
<span class="comment"># ---------------------------</span>
<span class="comment">#</span>
<span class="comment"># Now we will estimate the score on the data where the missing values are</span>
<span class="comment"># replaced by 0:</span>
<span class="comment">#</span>


<span class="keyword">def</span> <span class="identifier">get_impute_zero_score</span><span class="grouping">(</span><span class="identifier">X_missing</span><span class="punctuation">,</span> <span class="identifier">y_missing</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">add_indicator</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                            <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span> <span class="identifier">fill_value</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">zero_impute_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scores_for_imputer</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">,</span> <span class="identifier">X_missing</span><span class="punctuation">,</span> <span class="identifier">y_missing</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">zero_impute_scores</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">zero_impute_scores</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="identifier">mses_california</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">stds_california</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_impute_zero_score</span><span class="grouping">(</span>
    <span class="identifier">X_miss_california</span><span class="punctuation">,</span> <span class="identifier">y_miss_california</span><span class="grouping">)</span>
<span class="identifier">mses_diabetes</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">stds_diabetes</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_impute_zero_score</span><span class="grouping">(</span><span class="identifier">X_miss_diabetes</span><span class="punctuation">,</span>
                                                           <span class="identifier">y_miss_diabetes</span><span class="grouping">)</span>
<span class="identifier">x_labels</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="string-literal">'Zero imputation'</span><span class="grouping">)</span>


<span class="comment"># %%</span>
<span class="comment"># kNN-imputation of the missing values</span>
<span class="comment"># ------------------------------------</span>
<span class="comment">#</span>
<span class="comment"># :class:`~sklearn.impute.KNNImputer` imputes missing values using the weighted</span>
<span class="comment"># or unweighted mean of the desired number of nearest neighbors.</span>

<span class="keyword">def</span> <span class="identifier">get_impute_knn_score</span><span class="grouping">(</span><span class="identifier">X_missing</span><span class="punctuation">,</span> <span class="identifier">y_missing</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KNNImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">add_indicator</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">knn_impute_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scores_for_imputer</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">,</span> <span class="identifier">X_missing</span><span class="punctuation">,</span> <span class="identifier">y_missing</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">knn_impute_scores</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">knn_impute_scores</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="identifier">mses_california</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">stds_california</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_impute_knn_score</span><span class="grouping">(</span>
    <span class="identifier">X_miss_california</span><span class="punctuation">,</span> <span class="identifier">y_miss_california</span><span class="grouping">)</span>
<span class="identifier">mses_diabetes</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">stds_diabetes</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_impute_knn_score</span><span class="grouping">(</span><span class="identifier">X_miss_diabetes</span><span class="punctuation">,</span>
                                                          <span class="identifier">y_miss_diabetes</span><span class="grouping">)</span>
<span class="identifier">x_labels</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="string-literal">'KNN Imputation'</span><span class="grouping">)</span>


<span class="comment"># %%</span>
<span class="comment"># Impute missing values with mean</span>
<span class="comment"># -------------------------------</span>
<span class="comment">#</span>

<span class="keyword">def</span> <span class="identifier">get_impute_mean</span><span class="grouping">(</span><span class="identifier">X_missing</span><span class="punctuation">,</span> <span class="identifier">y_missing</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"mean"</span><span class="punctuation">,</span>
                            <span class="identifier">add_indicator</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">mean_impute_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scores_for_imputer</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">,</span> <span class="identifier">X_missing</span><span class="punctuation">,</span> <span class="identifier">y_missing</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">mean_impute_scores</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">mean_impute_scores</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="identifier">mses_california</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">stds_california</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_impute_mean</span><span class="grouping">(</span><span class="identifier">X_miss_california</span><span class="punctuation">,</span>
                                                         <span class="identifier">y_miss_california</span><span class="grouping">)</span>
<span class="identifier">mses_diabetes</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">stds_diabetes</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_impute_mean</span><span class="grouping">(</span><span class="identifier">X_miss_diabetes</span><span class="punctuation">,</span>
                                                     <span class="identifier">y_miss_diabetes</span><span class="grouping">)</span>
<span class="identifier">x_labels</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="string-literal">'Mean Imputation'</span><span class="grouping">)</span>


<span class="comment"># %%</span>
<span class="comment"># Iterative imputation of the missing values</span>
<span class="comment"># ------------------------------------------</span>
<span class="comment">#</span>
<span class="comment"># Another option is the :class:`~sklearn.impute.IterativeImputer`. This uses</span>
<span class="comment"># round-robin linear regression, modeling each feature with missing values as a</span>
<span class="comment"># function of other features, in turn.</span>
<span class="comment"># The version implemented assumes Gaussian (output) variables. If your features</span>
<span class="comment"># are obviously non-normal, consider transforming them to look more normal</span>
<span class="comment"># to potentially improve performance.</span>
<span class="comment">#</span>

<span class="keyword">def</span> <span class="identifier">get_impute_iterative</span><span class="grouping">(</span><span class="identifier">X_missing</span><span class="punctuation">,</span> <span class="identifier">y_missing</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">add_indicator</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_nearest_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                               <span class="identifier">sample_posterior</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">iterative_impute_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scores_for_imputer</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">,</span>
                                                     <span class="identifier">X_missing</span><span class="punctuation">,</span>
                                                     <span class="identifier">y_missing</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">iterative_impute_scores</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">iterative_impute_scores</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="identifier">mses_california</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">stds_california</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_impute_iterative</span><span class="grouping">(</span>
    <span class="identifier">X_miss_california</span><span class="punctuation">,</span> <span class="identifier">y_miss_california</span><span class="grouping">)</span>
<span class="identifier">mses_diabetes</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">stds_diabetes</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_impute_iterative</span><span class="grouping">(</span><span class="identifier">X_miss_diabetes</span><span class="punctuation">,</span>
                                                          <span class="identifier">y_miss_diabetes</span><span class="grouping">)</span>
<span class="identifier">x_labels</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="string-literal">'Iterative Imputation'</span><span class="grouping">)</span>

<span class="identifier">mses_diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mses_diabetes</span> <span class="arithmetic-operator">*</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
<span class="identifier">mses_california</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mses_california</span> <span class="arithmetic-operator">*</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>

<span class="comment"># %%</span>
<span class="comment"># Plot the results</span>
<span class="comment"># ################</span>
<span class="comment">#</span>
<span class="comment"># Finally we are going to visualize the score:</span>
<span class="comment">#</span>

<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>


<span class="identifier">n_bars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">mses_diabetes</span><span class="grouping">)</span>
<span class="identifier">xval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_bars</span><span class="grouping">)</span>

<span class="identifier">colors</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'r', 'g', 'b', 'orange', 'black'</span><span class="grouping">]</span>

<span class="comment"># plot diabetes results</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">ax1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">121</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">xval</span><span class="punctuation">:</span>
    <span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">barh</span><span class="grouping">(</span><span class="identifier">j</span><span class="punctuation">,</span> <span class="identifier">mses_diabetes</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">xerr</span><span class="arithmetic-assignment">=</span><span class="identifier">stds_diabetes</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="punctuation">,</span>
             <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">colors</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.6</span><span class="punctuation">,</span> <span class="identifier">align</span><span class="arithmetic-assignment">=</span><span class="string-literal">'center'</span><span class="grouping">)</span>

<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'Imputation Techniques with Diabetes Data'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_xlim</span><span class="grouping">(</span><span class="identifier">left</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">mses_diabetes</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.9</span><span class="punctuation">,</span>
             <span class="identifier">right</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">mses_diabetes</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">1.1</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_yticks</span><span class="grouping">(</span><span class="identifier">xval</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'MSE'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">invert_yaxis</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_yticklabels</span><span class="grouping">(</span><span class="identifier">x_labels</span><span class="grouping">)</span>

<span class="comment"># plot california dataset results</span>
<span class="identifier">ax2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">122</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">xval</span><span class="punctuation">:</span>
    <span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">barh</span><span class="grouping">(</span><span class="identifier">j</span><span class="punctuation">,</span> <span class="identifier">mses_california</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">xerr</span><span class="arithmetic-assignment">=</span><span class="identifier">stds_california</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="punctuation">,</span>
             <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">colors</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.6</span><span class="punctuation">,</span> <span class="identifier">align</span><span class="arithmetic-assignment">=</span><span class="string-literal">'center'</span><span class="grouping">)</span>

<span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'Imputation Techniques with California Data'</span><span class="grouping">)</span>
<span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">set_yticks</span><span class="grouping">(</span><span class="identifier">xval</span><span class="grouping">)</span>
<span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'MSE'</span><span class="grouping">)</span>
<span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">invert_yaxis</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">set_yticklabels</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">''</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_bars</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="comment"># You can also try different techniques. For instance, the median is a more</span>
<span class="comment"># robust estimator for data with high magnitude variables which could dominate</span>
<span class="comment"># results (otherwise known as a 'long tail').</span>

    </pre>
  </body>
</html>