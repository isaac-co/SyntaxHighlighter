<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
Testing for the gradient boosting loss functions and initial estimators.
"""</span>
<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">product</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">from</span> <span class="identifier">pytest</span> <span class="keyword">import</span> <span class="identifier">approx</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">mean_pinball_loss</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_gb_losses</span> <span class="keyword">import</span> <span class="identifier">RegressionLossFunction</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_gb_losses</span> <span class="keyword">import</span> <span class="identifier">LeastSquaresError</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_gb_losses</span> <span class="keyword">import</span> <span class="identifier">LeastAbsoluteError</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_gb_losses</span> <span class="keyword">import</span> <span class="identifier">HuberLossFunction</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_gb_losses</span> <span class="keyword">import</span> <span class="identifier">QuantileLossFunction</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_gb_losses</span> <span class="keyword">import</span> <span class="identifier">BinomialDeviance</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_gb_losses</span> <span class="keyword">import</span> <span class="identifier">MultinomialDeviance</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_gb_losses</span> <span class="keyword">import</span> <span class="identifier">ExponentialLoss</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_gb_losses</span> <span class="keyword">import</span> <span class="identifier">LOSS_FUNCTIONS</span>


<span class="keyword">def</span> <span class="identifier">test_binomial_deviance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check binomial deviance loss.</span>
    <span class="comment"># Check against alternative definitions in ESLII.</span>
    <span class="identifier">bd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BinomialDeviance</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span>

    <span class="comment"># pred has the same BD for y in {0, 1}</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">bd</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span>
            <span class="identifier">bd</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">bd</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bd</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">100</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># check if same results as alternative definition of deviance, from ESLII</span>
    <span class="comment"># Eq. (10.18): -loglike = log(1 + exp(-2*z*f))</span>
    <span class="comment"># Note:</span>
    <span class="comment"># - We use y = {0, 1}, ESL (10.18) uses z in {-1, 1}, hence y=2*y-1</span>
    <span class="comment"># - ESL 2*f = pred_raw, hence the factor 2 of ESL disappears.</span>
    <span class="comment"># - Deviance = -2*loglike + .., hence a factor of 2 in front.</span>
    <span class="keyword">def</span> <span class="identifier">alt_dev</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_pred</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">z</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
        <span class="keyword">return</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">z</span> <span class="arithmetic-operator">*</span> <span class="identifier">raw_pred</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">test_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">product</span><span class="grouping">(</span>
        <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">datum</span> <span class="relational-operator">in</span> <span class="identifier">test_data</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">bd</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">datum</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">alt_dev</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">datum</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># check the negative gradient against altenative formula from ESLII</span>
    <span class="comment"># Note: negative_gradient is half the negative gradient.</span>
    <span class="keyword">def</span> <span class="identifier">alt_ng</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_pred</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">z</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
        <span class="keyword">return</span> <span class="identifier">z</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">z</span> <span class="arithmetic-operator">*</span> <span class="identifier">raw_pred</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">datum</span> <span class="relational-operator">in</span> <span class="identifier">test_data</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">bd</span><span class="punctuation">.</span><span class="identifier">negative_gradient</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">datum</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">alt_ng</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">datum</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sample_weight_smoke</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">13</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>

    <span class="comment"># least squares</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LeastSquaresError</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">loss_wo_sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">pred</span><span class="grouping">)</span>
    <span class="identifier">loss_w_sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">loss_wo_sw</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">loss_w_sw</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sample_weight_init_estimators</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Smoke test for init estimators with sample weights.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">13</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">reg_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>

    <span class="identifier">clf_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">Loss</span> <span class="relational-operator">in</span> <span class="identifier">LOSS_FUNCTIONS</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">Loss</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">continue</span>
        <span class="keyword">if</span> <span class="identifier">issubclass</span><span class="grouping">(</span><span class="identifier">Loss</span><span class="punctuation">,</span> <span class="identifier">RegressionLossFunction</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg_y</span>
            <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Loss</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">k</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
            <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf_y</span>
            <span class="keyword">if</span> <span class="identifier">Loss</span><span class="punctuation">.</span><span class="identifier">is_multi_class</span><span class="punctuation">:</span>
                <span class="comment"># skip multiclass</span>
                <span class="keyword">continue</span>
            <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Loss</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span>

        <span class="identifier">init_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_estimator</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">init_est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">init_est</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">out</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">sw_init_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_estimator</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">sw_init_est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
        <span class="identifier">sw_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sw_init_est</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">sw_out</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

        <span class="comment"># check if predictions match</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">out</span><span class="punctuation">,</span> <span class="identifier">sw_out</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_quantile_loss_function</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non regression test for the QuantileLossFunction object</span>
    <span class="comment"># There was a sign problem when evaluating the function</span>
    <span class="comment"># for negative values of 'ytrue - ypred'</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y_found</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuantileLossFunction</span><span class="grouping">(</span><span class="float-literal">0.9</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y_expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.9</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_found</span><span class="punctuation">,</span> <span class="identifier">y_expected</span><span class="grouping">)</span>
    <span class="identifier">y_found_p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mean_pinball_loss</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.9</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_found</span><span class="punctuation">,</span> <span class="identifier">y_found_p</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sample_weight_deviance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if deviance supports sample weights.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">13</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">reg_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">clf_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">mclf_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">Loss</span> <span class="relational-operator">in</span> <span class="identifier">LOSS_FUNCTIONS</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">Loss</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">continue</span>
        <span class="keyword">if</span> <span class="identifier">issubclass</span><span class="grouping">(</span><span class="identifier">Loss</span><span class="punctuation">,</span> <span class="identifier">RegressionLossFunction</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg_y</span>
            <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg_y</span>
            <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Loss</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">k</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
            <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf_y</span>
            <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf_y</span>
            <span class="keyword">if</span> <span class="identifier">Loss</span><span class="punctuation">.</span><span class="identifier">is_multi_class</span><span class="punctuation">:</span>
                <span class="identifier">k</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
                <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mclf_y</span>
                <span class="comment"># one-hot encoding</span>
                <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
                <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">p</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="relational-operator">==</span> <span class="identifier">i</span>
            <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Loss</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span>

        <span class="identifier">deviance_w_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>
        <span class="identifier">deviance_wo_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">deviance_wo_w</span> <span class="relational-operator">==</span> <span class="identifier">deviance_w_w</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'n_classes, n_samples'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">57</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">13</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_multinomial_deviance</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check multinomial deviance with and without sample weights.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">13</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">y_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">klass</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y_pred</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">klass</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_true</span> <span class="relational-operator">==</span> <span class="identifier">klass</span>

    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MultinomialDeviance</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span>
    <span class="identifier">loss_wo_sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">loss_wo_sw</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>
    <span class="identifier">loss_w_sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">loss_wo_sw</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">loss_w_sw</span><span class="grouping">)</span>

    <span class="comment"># Multinomial deviance uses weighted average loss rather than</span>
    <span class="comment"># weighted sum loss, so we make sure that the value remains the same</span>
    <span class="comment"># when we device the weight by 2.</span>
    <span class="identifier">loss_w_sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">loss_wo_sw</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">loss_w_sw</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_mdl_computation_weighted</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">-.1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">expected_loss</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0909323</span>
    <span class="comment"># MultinomialDeviance loss computation with weights.</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MultinomialDeviance</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">loss</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">expected_loss</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_mdl_exception</span><span class="grouping">(</span><span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that MultinomialDeviance throws an exception when n_classes &lt;= 2</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'MultinomialDeviance requires more than 2 classes.'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">MultinomialDeviance</span><span class="grouping">(</span><span class="identifier">n</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_init_raw_predictions_shapes</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure get_init_raw_predictions returns float64 arrays with shape</span>
    <span class="comment"># (n_samples, K) where K is 1 for binary classification and regression, and</span>
    <span class="comment"># K = n_classes for multiclass classification</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">loss</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">LeastSquaresError</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">LeastAbsoluteError</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">QuantileLossFunction</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">HuberLossFunction</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">init_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init_estimator</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>

    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">loss</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">BinomialDeviance</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">ExponentialLoss</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">init_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init_estimator</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>

    <span class="keyword">for</span> <span class="identifier">n_classes</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MultinomialDeviance</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_classes</span><span class="grouping">)</span>
        <span class="identifier">init_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init_estimator</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>


<span class="keyword">def</span> <span class="identifier">test_init_raw_predictions_values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure the get_init_raw_predictions() returns the expected values for</span>
    <span class="comment"># each loss.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>

    <span class="comment"># Least squares loss</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LeastSquaresError</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">init_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init_estimator</span><span class="grouping">)</span>
    <span class="comment"># Make sure baseline prediction is the mean of all targets</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Least absolute and huber loss</span>
    <span class="keyword">for</span> <span class="identifier">Loss</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">LeastAbsoluteError</span><span class="punctuation">,</span> <span class="identifier">HuberLossFunction</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Loss</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">init_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init_estimator</span><span class="grouping">)</span>
        <span class="comment"># Make sure baseline prediction is the median of all targets</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">median</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Quantile loss</span>
    <span class="keyword">for</span> <span class="identifier">alpha</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="float-literal">.5</span><span class="punctuation">,</span> <span class="float-literal">.9</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuantileLossFunction</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="grouping">)</span>
        <span class="identifier">init_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init_estimator</span><span class="grouping">)</span>
        <span class="comment"># Make sure baseline prediction is the alpha-quantile of all targets</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>

    <span class="comment"># Binomial deviance</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BinomialDeviance</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">init_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># Make sure baseline prediction is equal to link_function(p), where p</span>
    <span class="comment"># is the proba of the positive class. We want predict_proba() to return p,</span>
    <span class="comment"># and by definition</span>
    <span class="comment"># p = inverse_link_function(raw_prediction) = sigmoid(raw_prediction)</span>
    <span class="comment"># So we want raw_prediction = link_function(p) = log(p / (1 - p))</span>
    <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init_estimator</span><span class="grouping">)</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">p</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">p</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Exponential loss</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ExponentialLoss</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">init_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init_estimator</span><span class="grouping">)</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="float-literal">.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">p</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">p</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Multinomial deviance loss</span>
    <span class="keyword">for</span> <span class="identifier">n_classes</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MultinomialDeviance</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_classes</span><span class="grouping">)</span>
        <span class="identifier">init_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init_estimator</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'seed'</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'alpha'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.4</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.6</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lad_equals_quantiles</span><span class="grouping">(</span><span class="identifier">seed</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure quantile loss with alpha = .5 is equivalent to LAD</span>
    <span class="identifier">lad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LeastAbsoluteError</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">ql</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuantileLossFunction</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">lad_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lad</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span>
    <span class="identifier">ql_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ql</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">alpha</span> <span class="relational-operator">==</span> <span class="float-literal">0.5</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">lad_loss</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">ql_loss</span><span class="grouping">)</span>

    <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span>
    <span class="identifier">lad_weighted_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lad</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="grouping">)</span>
    <span class="identifier">ql_weighted_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ql</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">alpha</span> <span class="relational-operator">==</span> <span class="float-literal">0.5</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">lad_weighted_loss</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">ql_weighted_loss</span><span class="grouping">)</span>
    <span class="identifier">pbl_weighted_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mean_pinball_loss</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span>
                                          <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                          <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pbl_weighted_loss</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">ql_weighted_loss</span><span class="grouping">)</span>

    </pre>
  </body>
</html>