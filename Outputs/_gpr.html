<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Gaussian processes regression."""</span>

<span class="comment"># Authors: Jan Hendrik Metzen &lt;jhm@informatik.uni-bremen.de&gt;</span>
<span class="comment"># Modified by: Pete Green &lt;p.l.green@liverpool.ac.uk&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">warnings</span>
<span class="keyword">from</span> <span class="identifier">operator</span> <span class="keyword">import</span> <span class="identifier">itemgetter</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">linalg</span> <span class="keyword">import</span> <span class="identifier">cholesky</span><span class="punctuation">,</span> <span class="identifier">cho_solve</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">optimize</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="identifier">RegressorMixin</span><span class="punctuation">,</span> <span class="identifier">clone</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">MultiOutputMixin</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">kernels</span> <span class="keyword">import</span> <span class="identifier">RBF</span><span class="punctuation">,</span> <span class="identifier">ConstantKernel</span> <span class="keyword">as</span> <span class="identifier">C</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">preprocessing</span><span class="punctuation">.</span><span class="identifier">_data</span> <span class="keyword">import</span> <span class="identifier">_handle_zeros_in_scale</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">optimize</span> <span class="keyword">import</span> <span class="identifier">_check_optimize_result</span>


<span class="keyword">class</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">MultiOutputMixin</span><span class="punctuation">,</span>
                               <span class="identifier">RegressorMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Gaussian process regression (GPR).

    The implementation is based on Algorithm 2.1 of Gaussian Processes
    for Machine Learning (GPML) by Rasmussen and Williams.

    In addition to standard scikit-learn estimator API,
    GaussianProcessRegressor:

       * allows prediction without prior fitting (based on the GP prior)
       * provides an additional method `sample_y(X)`, which evaluates samples
         drawn from the GPR (prior or posterior) at given inputs
       * exposes a method `log_marginal_likelihood(theta)`, which can be used
         externally for other ways of selecting hyperparameters, e.g., via
         Markov chain Monte Carlo.

    Read more in the :ref:`User Guide &lt;gaussian_process&gt;`.

    .. versionadded:: 0.18

    Parameters
    ----------
    kernel : kernel instance, default=None
        The kernel specifying the covariance function of the GP. If None is
        passed, the kernel ``ConstantKernel(1.0, constant_value_bounds="fixed"
        * RBF(1.0, length_scale_bounds="fixed")`` is used as default. Note that
        the kernel hyperparameters are optimized during fitting unless the
        bounds are marked as "fixed".

    alpha : float or ndarray of shape (n_samples,), default=1e-10
        Value added to the diagonal of the kernel matrix during fitting.
        This can prevent a potential numerical issue during fitting, by
        ensuring that the calculated values form a positive definite matrix.
        It can also be interpreted as the variance of additional Gaussian
        measurement noise on the training observations. Note that this is
        different from using a `WhiteKernel`. If an array is passed, it must
        have the same number of entries as the data used for fitting and is
        used as datapoint-dependent noise level. Allowing to specify the
        noise level directly as a parameter is mainly for convenience and
        for consistency with Ridge.

    optimizer : "fmin_l_bfgs_b" or callable, default="fmin_l_bfgs_b"
        Can either be one of the internally supported optimizers for optimizing
        the kernel's parameters, specified by a string, or an externally
        defined optimizer passed as a callable. If a callable is passed, it
        must have the signature::

            def optimizer(obj_func, initial_theta, bounds):
                # * 'obj_func': the objective function to be minimized, which
                #   takes the hyperparameters theta as a parameter and an
                #   optional flag eval_gradient, which determines if the
                #   gradient is returned additionally to the function value
                # * 'initial_theta': the initial value for theta, which can be
                #   used by local optimizers
                # * 'bounds': the bounds on the values of theta
                ....
                # Returned are the best found hyperparameters theta and
                # the corresponding value of the target function.
                return theta_opt, func_min

        Per default, the 'L-BFGS-B' algorithm from scipy.optimize.minimize
        is used. If None is passed, the kernel's parameters are kept fixed.
        Available internal optimizers are::

            'fmin_l_bfgs_b'

    n_restarts_optimizer : int, default=0
        The number of restarts of the optimizer for finding the kernel's
        parameters which maximize the log-marginal likelihood. The first run
        of the optimizer is performed from the kernel's initial parameters,
        the remaining ones (if any) from thetas sampled log-uniform randomly
        from the space of allowed theta-values. If greater than 0, all bounds
        must be finite. Note that n_restarts_optimizer == 0 implies that one
        run is performed.

    normalize_y : bool, default=False
        Whether the target values y are normalized, the mean and variance of
        the target values are set equal to 0 and 1 respectively. This is
        recommended for cases where zero-mean, unit-variance priors are used.
        Note that, in this implementation, the normalisation is reversed
        before the GP predictions are reported.

        .. versionchanged:: 0.23

    copy_X_train : bool, default=True
        If True, a persistent copy of the training data is stored in the
        object. Otherwise, just a reference to the training data is stored,
        which might cause predictions to change if the data is modified
        externally.

    random_state : int, RandomState instance or None, default=None
        Determines random number generation used to initialize the centers.
        Pass an int for reproducible results across multiple function calls.
        See :term:`Glossary &lt;random_state&gt;`.

    Attributes
    ----------
    X_train_ : array-like of shape (n_samples, n_features) or list of object
        Feature vectors or other representations of training data (also
        required for prediction).

    y_train_ : array-like of shape (n_samples,) or (n_samples, n_targets)
        Target values in training data (also required for prediction)

    kernel_ : kernel instance
        The kernel used for prediction. The structure of the kernel is the
        same as the one passed as parameter but with optimized hyperparameters

    L_ : array-like of shape (n_samples, n_samples)
        Lower-triangular Cholesky decomposition of the kernel in ``X_train_``

    alpha_ : array-like of shape (n_samples,)
        Dual coefficients of training data points in kernel space

    log_marginal_likelihood_value_ : float
        The log-marginal-likelihood of ``self.kernel_.theta``

    Examples
    --------
    &gt;&gt;&gt; from sklearn.datasets import make_friedman2
    &gt;&gt;&gt; from sklearn.gaussian_process import GaussianProcessRegressor
    &gt;&gt;&gt; from sklearn.gaussian_process.kernels import DotProduct, WhiteKernel
    &gt;&gt;&gt; X, y = make_friedman2(n_samples=500, noise=0, random_state=0)
    &gt;&gt;&gt; kernel = DotProduct() + WhiteKernel()
    &gt;&gt;&gt; gpr = GaussianProcessRegressor(kernel=kernel,
    ...         random_state=0).fit(X, y)
    &gt;&gt;&gt; gpr.score(X, y)
    0.3680...
    &gt;&gt;&gt; gpr.predict(X[:2,:], return_std=True)
    (array([653.0..., 592.1...]), array([316.6..., 316.6...]))

    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-10</span><span class="punctuation">,</span>
                 <span class="identifier">optimizer</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fmin_l_bfgs_b"</span><span class="punctuation">,</span> <span class="identifier">n_restarts_optimizer</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                 <span class="identifier">normalize_y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">copy_X_train</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">optimizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">optimizer</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_restarts_optimizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_restarts_optimizer</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalize_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">normalize_y</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">copy_X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">copy_X_train</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Fit Gaussian process regression model.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features) or list of object
            Feature vectors or other representations of training data.

        y : array-like of shape (n_samples,) or (n_samples, n_targets)
            Target values

        Returns
        -------
        self : returns an instance of self.
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>  <span class="comment"># Use an RBF kernel as default</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">C</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">constant_value_bounds</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fixed"</span><span class="grouping">)</span> <span class="invalid">\</span>
                <span class="arithmetic-operator">*</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fixed"</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">requires_vector_input</span><span class="punctuation">:</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">multi_output</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">y_numeric</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                       <span class="identifier">ensure_2d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"numeric"</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">multi_output</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">y_numeric</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                       <span class="identifier">ensure_2d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>

        <span class="comment"># Normalize target value</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalize_y</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_y_train_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_y_train_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_handle_zeros_in_scale</span><span class="grouping">(</span>
                <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span>
            <span class="grouping">)</span>

            <span class="comment"># Remove mean and make unit variance</span>
            <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_y_train_mean</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_y_train_std</span>

        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_y_train_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_y_train_std</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

        <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">iterable</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="grouping">)</span> <span class="invalid">\</span>
           <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"alpha must be a scalar or an array "</span>
                                 <span class="string-literal">"with same number of entries as y. (%d != %d)"</span>
                                 <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X_train_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">copy_X_train</span> <span class="keyword">else</span> <span class="identifier">X</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y_train_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">copy_X_train</span> <span class="keyword">else</span> <span class="identifier">y</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">optimizer</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">n_dims</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="comment"># Choose hyperparameters based on maximizing the log-marginal</span>
            <span class="comment"># likelihood (potentially starting from several initial values)</span>
            <span class="keyword">def</span> <span class="identifier">obj_func</span><span class="grouping">(</span><span class="identifier">theta</span><span class="punctuation">,</span> <span class="identifier">eval_gradient</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">eval_gradient</span><span class="punctuation">:</span>
                    <span class="identifier">lml</span><span class="punctuation">,</span> <span class="identifier">grad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span>
                        <span class="identifier">theta</span><span class="punctuation">,</span> <span class="identifier">eval_gradient</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">clone_kernel</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
                    <span class="keyword">return</span> <span class="arithmetic-operator">-</span><span class="identifier">lml</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">grad</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="keyword">return</span> <span class="arithmetic-operator">-</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">theta</span><span class="punctuation">,</span>
                                                         <span class="identifier">clone_kernel</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

            <span class="comment"># First optimize starting from theta specified in kernel</span>
            <span class="identifier">optima</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constrained_optimization</span><span class="grouping">(</span><span class="identifier">obj_func</span><span class="punctuation">,</span>
                                                      <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">,</span>
                                                      <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">bounds</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>

            <span class="comment"># Additional runs are performed from log-uniform chosen initial</span>
            <span class="comment"># theta</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_restarts_optimizer</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">bounds</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                        <span class="string-literal">"Multiple optimizer restarts (n_restarts_optimizer&gt;0) "</span>
                        <span class="string-literal">"requires that all bounds are finite."</span><span class="grouping">)</span>
                <span class="identifier">bounds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">bounds</span>
                <span class="keyword">for</span> <span class="identifier">iteration</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_restarts_optimizer</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">theta_initial</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">bounds</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">bounds</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
                    <span class="identifier">optima</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span>
                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constrained_optimization</span><span class="grouping">(</span><span class="identifier">obj_func</span><span class="punctuation">,</span> <span class="identifier">theta_initial</span><span class="punctuation">,</span>
                                                       <span class="identifier">bounds</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="comment"># Select result from run with minimal (negative) log-marginal</span>
            <span class="comment"># likelihood</span>
            <span class="identifier">lml_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">map</span><span class="grouping">(</span><span class="identifier">itemgetter</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">optima</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">optima</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmin</span><span class="grouping">(</span><span class="identifier">lml_values</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">_check_bounds_params</span><span class="grouping">(</span><span class="grouping">)</span>

            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood_value_</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">lml_values</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood_value_</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">,</span>
                                             <span class="identifier">clone_kernel</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

        <span class="comment"># Precompute quantities required for predictions which are independent</span>
        <span class="comment"># of actual query points</span>
        <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X_train_</span><span class="grouping">)</span>
        <span class="identifier">K</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag_indices_from</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">L_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cholesky</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">lower</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>  <span class="comment"># Line 2</span>
        <span class="keyword">except</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">LinAlgError</span> <span class="keyword">as</span> <span class="identifier">exc</span><span class="punctuation">:</span>
            <span class="identifier">exc</span><span class="punctuation">.</span><span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"The kernel, %s, is not returning a "</span>
                        <span class="string-literal">"positive definite matrix. Try gradually "</span>
                        <span class="string-literal">"increasing the 'alpha' parameter of your "</span>
                        <span class="string-literal">"GaussianProcessRegressor estimator."</span>
                        <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">,</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">exc</span><span class="punctuation">.</span><span class="identifier">args</span>
            <span class="keyword">raise</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cho_solve</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">L_</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y_train_</span><span class="grouping">)</span>  <span class="comment"># Line 3</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Predict using the Gaussian process regression model

        We can also predict based on an unfitted model by using the GP prior.
        In addition to the mean of the predictive distribution, optionally also
        returns its standard deviation (`return_std=True`) or covariance
        (`return_cov=True`). Note that at most one of the two can be requested.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features) or list of object
            Query points where the GP is evaluated.

        return_std : bool, default=False
            If True, the standard-deviation of the predictive distribution at
            the query points is returned along with the mean.

        return_cov : bool, default=False
            If True, the covariance of the joint predictive distribution at
            the query points is returned along with the mean.

        Returns
        -------
        y_mean : ndarray of shape (n_samples,) or (n_samples, n_targets)
            Mean of predictive distribution a query points.

        y_std : ndarray of shape (n_samples,), optional
            Standard deviation of predictive distribution at query points.
            Only returned when `return_std` is True.

        y_cov : ndarray of shape (n_samples, n_samples), optional
            Covariance of joint predictive distribution a query points.
            Only returned when `return_cov` is True.
        """</span>
        <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span> <span class="logical-operator">and</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">RuntimeError</span><span class="grouping">(</span>
                <span class="string-literal">"At most one of return_std or return_cov can be requested."</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">or</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">requires_vector_input</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">ensure_2d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"numeric"</span><span class="punctuation">,</span>
                                    <span class="identifier">reset</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">ensure_2d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                    <span class="identifier">reset</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">"X_train_"</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># Unfitted;predict based on GP prior</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">C</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">constant_value_bounds</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fixed"</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span>
                          <span class="identifier">RBF</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fixed"</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel</span>
            <span class="identifier">y_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="punctuation">:</span>
                <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
                <span class="keyword">return</span> <span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">y_cov</span>
            <span class="keyword">elif</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="punctuation">:</span>
                <span class="identifier">y_var</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
                <span class="keyword">return</span> <span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">y_var</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">return</span> <span class="identifier">y_mean</span>
        <span class="keyword">else</span><span class="punctuation">:</span>  <span class="comment"># Predict based on GP posterior</span>
            <span class="identifier">K_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X_train_</span><span class="grouping">)</span>
            <span class="identifier">y_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K_trans</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span>  <span class="comment"># Line 4 (y_mean = f_star)</span>
            <span class="comment"># undo normalisation</span>
            <span class="identifier">y_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_y_train_std</span> <span class="arithmetic-operator">*</span> <span class="identifier">y_mean</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_y_train_mean</span>

            <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="punctuation">:</span>
                <span class="comment"># Solve K @ V = K_trans.T</span>
                <span class="identifier">V</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cho_solve</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">L_</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">K_trans</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>  <span class="comment"># Line 5</span>
                <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">K_trans</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">)</span>  <span class="comment"># Line 6</span>

                <span class="comment"># undo normalisation</span>
                <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_cov</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_y_train_std</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span>

                <span class="keyword">return</span> <span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">y_cov</span>
            <span class="keyword">elif</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="punctuation">:</span>
                <span class="comment"># Solve K @ V = K_trans.T</span>
                <span class="identifier">V</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cho_solve</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">L_</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">K_trans</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>  <span class="comment"># Line 5</span>

                <span class="comment"># Compute variance of predictive distribution</span>
                <span class="comment"># Use einsum to avoid explicitly forming the large matrix</span>
                <span class="comment"># K_trans @ V just to extract its diagonal afterward.</span>
                <span class="identifier">y_var</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
                <span class="identifier">y_var</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">einsum</span><span class="grouping">(</span><span class="string-literal">"ij,ji-&gt;i"</span><span class="punctuation">,</span> <span class="identifier">K_trans</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="grouping">)</span>

                <span class="comment"># Check if any of the variances is negative because of</span>
                <span class="comment"># numerical issues. If yes: set the variance to 0.</span>
                <span class="identifier">y_var_negative</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_var</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span>
                <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">y_var_negative</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"Predicted variances smaller than 0. "</span>
                                  <span class="string-literal">"Setting those variances to 0."</span><span class="grouping">)</span>
                    <span class="identifier">y_var</span><span class="grouping">[</span><span class="identifier">y_var_negative</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>

                <span class="comment"># undo normalisation</span>
                <span class="identifier">y_var</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_var</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_y_train_std</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span>

                <span class="keyword">return</span> <span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">y_var</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">return</span> <span class="identifier">y_mean</span>

    <span class="keyword">def</span> <span class="identifier">sample_y</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Draw samples from Gaussian process and evaluate at X.

        Parameters
        ----------
        X : array-like of shape (n_samples_X, n_features) or list of object
            Query points where the GP is evaluated.

        n_samples : int, default=1
            Number of samples drawn from the Gaussian process per query point

        random_state : int, RandomState instance or None, default=0
            Determines random number generation to randomly draw samples.
            Pass an int for reproducible results across multiple function
            calls.
            See :term:`Glossary &lt;random_state&gt;`.

        Returns
        -------
        y_samples : ndarray of shape (n_samples_X, n_samples), or \
            (n_samples_X, n_targets, n_samples)
            Values of n_samples samples drawn from Gaussian process and
            evaluated at query points.
        """</span>
        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>

        <span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">y_mean</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">y_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">multivariate_normal</span><span class="grouping">(</span><span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">y_cov</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">y_samples</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
                <span class="grouping">[</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">multivariate_normal</span><span class="grouping">(</span><span class="identifier">y_mean</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_cov</span><span class="punctuation">,</span>
                                         <span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
                 <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">y_mean</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
            <span class="identifier">y_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="identifier">y_samples</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">y_samples</span>

    <span class="keyword">def</span> <span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">theta</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">eval_gradient</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                <span class="identifier">clone_kernel</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns log-marginal likelihood of theta for training data.

        Parameters
        ----------
        theta : array-like of shape (n_kernel_params,) default=None
            Kernel hyperparameters for which the log-marginal likelihood is
            evaluated. If None, the precomputed log_marginal_likelihood
            of ``self.kernel_.theta`` is returned.

        eval_gradient : bool, default=False
            If True, the gradient of the log-marginal likelihood with respect
            to the kernel hyperparameters at position theta is returned
            additionally. If True, theta must not be None.

        clone_kernel : bool, default=True
            If True, the kernel attribute is copied. If False, the kernel
            attribute is modified, but may result in a performance improvement.

        Returns
        -------
        log_likelihood : float
            Log-marginal likelihood of theta for training data.

        log_likelihood_gradient : ndarray of shape (n_kernel_params,), optional
            Gradient of the log-marginal likelihood with respect to the kernel
            hyperparameters at position theta.
            Only returned when eval_gradient is True.
        """</span>
        <span class="keyword">if</span> <span class="identifier">theta</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">eval_gradient</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                    <span class="string-literal">"Gradient can only be evaluated for theta!=None"</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood_value_</span>

        <span class="keyword">if</span> <span class="identifier">clone_kernel</span><span class="punctuation">:</span>
            <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">clone_with_theta</span><span class="grouping">(</span><span class="identifier">theta</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_</span>
            <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">theta</span>

        <span class="keyword">if</span> <span class="identifier">eval_gradient</span><span class="punctuation">:</span>
            <span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K_gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X_train_</span><span class="punctuation">,</span> <span class="identifier">eval_gradient</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X_train_</span><span class="grouping">)</span>

        <span class="identifier">K</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag_indices_from</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">L</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cholesky</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">lower</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>  <span class="comment"># Line 2</span>
        <span class="keyword">except</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">LinAlgError</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">theta</span><span class="grouping">)</span><span class="grouping">)</span> <span class="invalid">\</span>
                <span class="keyword">if</span> <span class="identifier">eval_gradient</span> <span class="keyword">else</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span>

        <span class="comment"># Support multi-dimensional output of self.y_train_</span>
        <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y_train_</span>
        <span class="keyword">if</span> <span class="identifier">y_train</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>

        <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cho_solve</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">L</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>  <span class="comment"># Line 3</span>

        <span class="comment"># Compute log-likelihood (compare line 7)</span>
        <span class="identifier">log_likelihood_dims</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">-0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">einsum</span><span class="grouping">(</span><span class="string-literal">"ik,ik-&gt;k"</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span>
        <span class="identifier">log_likelihood_dims</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">L</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">log_likelihood_dims</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span><span class="grouping">)</span>
        <span class="identifier">log_likelihood</span> <span class="arithmetic-assignment">=</span> <span class="identifier">log_likelihood_dims</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>  <span class="comment"># sum over dimensions</span>

        <span class="keyword">if</span> <span class="identifier">eval_gradient</span><span class="punctuation">:</span>  <span class="comment"># compare Equation 5.9 from GPML</span>
            <span class="identifier">tmp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">einsum</span><span class="grouping">(</span><span class="string-literal">"ik,jk-&gt;ijk"</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span>  <span class="comment"># k: output-dimension</span>
            <span class="identifier">tmp</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">cho_solve</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">L</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
            <span class="comment"># Compute "0.5 * trace(tmp.dot(K_gradient))" without</span>
            <span class="comment"># constructing the full matrix tmp.dot(K_gradient) since only</span>
            <span class="comment"># its diagonal is required</span>
            <span class="identifier">log_likelihood_gradient_dims</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
                <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">einsum</span><span class="grouping">(</span><span class="string-literal">"ijl,jik-&gt;kl"</span><span class="punctuation">,</span> <span class="identifier">tmp</span><span class="punctuation">,</span> <span class="identifier">K_gradient</span><span class="grouping">)</span>
            <span class="identifier">log_likelihood_gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">log_likelihood_gradient_dims</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">eval_gradient</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">log_likelihood</span><span class="punctuation">,</span> <span class="identifier">log_likelihood_gradient</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">log_likelihood</span>

    <span class="keyword">def</span> <span class="identifier">_constrained_optimization</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">obj_func</span><span class="punctuation">,</span> <span class="identifier">initial_theta</span><span class="punctuation">,</span> <span class="identifier">bounds</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">optimizer</span> <span class="relational-operator">==</span> <span class="string-literal">"fmin_l_bfgs_b"</span><span class="punctuation">:</span>
            <span class="identifier">opt_res</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">optimize</span><span class="punctuation">.</span><span class="identifier">minimize</span><span class="grouping">(</span>
                <span class="identifier">obj_func</span><span class="punctuation">,</span> <span class="identifier">initial_theta</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">"L-BFGS-B"</span><span class="punctuation">,</span> <span class="identifier">jac</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">bounds</span><span class="arithmetic-assignment">=</span><span class="identifier">bounds</span><span class="grouping">)</span>
            <span class="identifier">_check_optimize_result</span><span class="grouping">(</span><span class="string-literal">"lbfgs"</span><span class="punctuation">,</span> <span class="identifier">opt_res</span><span class="grouping">)</span>
            <span class="identifier">theta_opt</span><span class="punctuation">,</span> <span class="identifier">func_min</span> <span class="arithmetic-assignment">=</span> <span class="identifier">opt_res</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">opt_res</span><span class="punctuation">.</span><span class="identifier">fun</span>
        <span class="keyword">elif</span> <span class="identifier">callable</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">optimizer</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">theta_opt</span><span class="punctuation">,</span> <span class="identifier">func_min</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">optimizer</span><span class="grouping">(</span><span class="identifier">obj_func</span><span class="punctuation">,</span> <span class="identifier">initial_theta</span><span class="punctuation">,</span> <span class="identifier">bounds</span><span class="arithmetic-assignment">=</span><span class="identifier">bounds</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Unknown optimizer %s."</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">optimizer</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">theta_opt</span><span class="punctuation">,</span> <span class="identifier">func_min</span>

    <span class="keyword">def</span> <span class="identifier">_more_tags</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'requires_fit'</span><span class="punctuation">:</span> <span class="bool-literal">False</span><span class="grouping">}</span>

    </pre>
  </body>
</html>