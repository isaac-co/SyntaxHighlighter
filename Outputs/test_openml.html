<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Test the openml loader.
"""</span>
<span class="keyword">import</span> <span class="identifier">gzip</span>
<span class="keyword">import</span> <span class="identifier">warnings</span>
<span class="keyword">import</span> <span class="identifier">json</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">re</span>
<span class="keyword">from</span> <span class="identifier">io</span> <span class="keyword">import</span> <span class="identifier">BytesIO</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span>
<span class="keyword">import</span> <span class="identifier">sklearn</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">config_context</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">fetch_openml</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">_openml</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">_open_openml_url</span><span class="punctuation">,</span>
                                      <span class="identifier">_arff</span><span class="punctuation">,</span>
                                      <span class="identifier">_DATA_FILE</span><span class="punctuation">,</span>
                                      <span class="identifier">_convert_arff_data</span><span class="punctuation">,</span>
                                      <span class="identifier">_convert_arff_data_dataframe</span><span class="punctuation">,</span>
                                      <span class="identifier">_get_data_description_by_id</span><span class="punctuation">,</span>
                                      <span class="identifier">_get_local_path</span><span class="punctuation">,</span>
                                      <span class="identifier">_retry_with_clean_cache</span><span class="punctuation">,</span>
                                      <span class="identifier">_feature_to_dtype</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">is_scalar_nan</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">urllib</span><span class="punctuation">.</span><span class="identifier">error</span> <span class="keyword">import</span> <span class="identifier">HTTPError</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">tests</span><span class="punctuation">.</span><span class="identifier">test_common</span> <span class="keyword">import</span> <span class="identifier">check_return_X_y</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">externals</span><span class="punctuation">.</span><span class="identifier">_arff</span> <span class="keyword">import</span> <span class="identifier">ArffContainerType</span>
<span class="keyword">from</span> <span class="identifier">functools</span> <span class="keyword">import</span> <span class="identifier">partial</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">fails_if_pypy</span>


<span class="identifier">currdir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">dirname</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">abspath</span><span class="grouping">(</span><span class="identifier">__file__</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="comment"># if True, urlopen will be monkey patched to only use local files</span>
<span class="identifier">test_offline</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>


<span class="keyword">def</span> <span class="identifier">_test_features_list</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># XXX Test is intended to verify/ensure correct decoding behavior</span>
    <span class="comment"># Not usable with sparse data or datasets that have columns marked as</span>
    <span class="comment"># {row_identifier, ignore}</span>
    <span class="keyword">def</span> <span class="identifier">decode_column</span><span class="grouping">(</span><span class="identifier">data_bunch</span><span class="punctuation">,</span> <span class="identifier">col_idx</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">col_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data_bunch</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">[</span><span class="identifier">col_idx</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">col_name</span> <span class="relational-operator">in</span> <span class="identifier">data_bunch</span><span class="punctuation">.</span><span class="identifier">categories</span><span class="punctuation">:</span>
            <span class="comment"># XXX: This would be faster with np.take, although it does not</span>
            <span class="comment"># handle missing values fast (also not with mode='wrap')</span>
            <span class="identifier">cat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data_bunch</span><span class="punctuation">.</span><span class="identifier">categories</span><span class="grouping">[</span><span class="identifier">col_name</span><span class="grouping">]</span>
            <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="none-literal">None</span> <span class="keyword">if</span> <span class="identifier">is_scalar_nan</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">cat</span><span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span><span class="grouping">]</span>
                      <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">data_bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">col_idx</span><span class="grouping">]</span><span class="grouping">]</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">result</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'O'</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="comment"># non-nominal attribute</span>
            <span class="keyword">return</span> <span class="identifier">data_bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">col_idx</span><span class="grouping">]</span>

    <span class="identifier">data_bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                              <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="comment"># also obtain decoded arff</span>
    <span class="identifier">data_description</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_data_description_by_id</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data_description</span><span class="grouping">[</span><span class="string-literal">'format'].lower() == 'sparse_arff'</span>
    <span class="keyword">if</span> <span class="identifier">sparse</span> <span class="relational-operator">is</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'This test is not intended for sparse data, to keep '</span>
                         <span class="string-literal">'code relatively simple'</span><span class="grouping">)</span>
    <span class="identifier">url</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_DATA_FILE</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">data_description</span><span class="grouping">[</span><span class="string-literal">'file_id'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">_open_openml_url</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="identifier">data_home</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
        <span class="identifier">data_arff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_arff</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">line</span><span class="punctuation">.</span><span class="identifier">decode</span><span class="grouping">(</span><span class="string-literal">'utf-8'</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">line</span> <span class="relational-operator">in</span> <span class="identifier">f</span><span class="grouping">)</span><span class="punctuation">,</span>
                               <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">_arff</span><span class="punctuation">.</span><span class="identifier">COO</span> <span class="keyword">if</span> <span class="identifier">sparse</span>
                                            <span class="keyword">else</span> <span class="identifier">_arff</span><span class="punctuation">.</span><span class="identifier">DENSE_GEN</span><span class="grouping">)</span><span class="punctuation">,</span>
                               <span class="identifier">encode_nominal</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">data_downloaded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">data_arff</span><span class="grouping">[</span><span class="string-literal">'data']), dtype='O'</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data_bunch</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># XXX: Test per column, as this makes it easier to avoid problems with</span>
        <span class="comment"># missing values</span>

        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">data_downloaded</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span>
                                      <span class="identifier">decode_column</span><span class="grouping">(</span><span class="identifier">data_bunch</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_fetch_dataset_from_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">data_name</span><span class="punctuation">,</span> <span class="identifier">data_version</span><span class="punctuation">,</span>
                               <span class="identifier">target_column</span><span class="punctuation">,</span>
                               <span class="identifier">expected_observations</span><span class="punctuation">,</span> <span class="identifier">expected_features</span><span class="punctuation">,</span>
                               <span class="identifier">expected_missing</span><span class="punctuation">,</span>
                               <span class="identifier">expected_data_dtype</span><span class="punctuation">,</span> <span class="identifier">expected_target_dtype</span><span class="punctuation">,</span>
                               <span class="identifier">expect_sparse</span><span class="punctuation">,</span> <span class="identifier">compare_default_target</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># fetches a dataset in three various ways from OpenML, using the</span>
    <span class="comment"># fetch_openml function, and does various checks on the validity of the</span>
    <span class="comment"># result. Note that this function can be mocked (by invoking</span>
    <span class="comment"># _monkey_patch_webbased_functions before invoking this function)</span>
    <span class="identifier">data_by_name_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="identifier">data_name</span><span class="punctuation">,</span> <span class="identifier">version</span><span class="arithmetic-assignment">=</span><span class="identifier">data_version</span><span class="punctuation">,</span>
                                   <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">data_by_name_id</span><span class="punctuation">.</span><span class="identifier">details</span><span class="grouping">[</span><span class="string-literal">'id'</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">data_id</span>

    <span class="comment"># Please note that cache=False is crucial, as the monkey patched files are</span>
    <span class="comment"># not consistent with reality</span>
    <span class="keyword">with</span> <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">catch_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># See discussion in PR #19373</span>
        <span class="comment"># Catching UserWarnings about multiple versions of dataset</span>
        <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">simplefilter</span><span class="grouping">(</span><span class="string-literal">"ignore"</span><span class="punctuation">,</span> <span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">UserWarning</span><span class="grouping">)</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="identifier">data_name</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="comment"># without specifying the version, there is no guarantee that the data id</span>
    <span class="comment"># will be the same</span>

    <span class="comment"># fetch with dataset id</span>
    <span class="identifier">data_by_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                              <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="identifier">target_column</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">details</span><span class="grouping">[</span><span class="string-literal">'name'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">data_name</span>
    <span class="keyword">assert</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_observations</span><span class="punctuation">,</span> <span class="identifier">expected_features</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target_column</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># single target, so target is vector</span>
        <span class="keyword">assert</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_observations</span><span class="punctuation">,</span> <span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">target_names</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="identifier">target_column</span><span class="grouping">]</span>
    <span class="keyword">elif</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target_column</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># multi target, so target is array</span>
        <span class="keyword">assert</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_observations</span><span class="punctuation">,</span>
                                           <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">target_column</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">target_names</span> <span class="relational-operator">==</span> <span class="identifier">target_column</span>
    <span class="keyword">assert</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">expected_data_dtype</span>
    <span class="keyword">assert</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">expected_target_dtype</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected_features</span>
    <span class="keyword">for</span> <span class="identifier">feature</span> <span class="relational-operator">in</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">feature</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">)</span>

    <span class="comment"># TODO: pass in a list of expected nominal features</span>
    <span class="keyword">for</span> <span class="identifier">feature</span><span class="punctuation">,</span> <span class="identifier">categories</span> <span class="relational-operator">in</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">categories</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">feature_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">(</span><span class="identifier">feature</span><span class="grouping">)</span>
        <span class="identifier">values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">feature_idx</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">values</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">values</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">values</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">categories</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">compare_default_target</span><span class="punctuation">:</span>
        <span class="comment"># check whether the data by id and data by id target are equal</span>
        <span class="identifier">data_by_id_default</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                          <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">data_by_id_default</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">:</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                       <span class="identifier">data_by_id_default</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array_equal</span><span class="grouping">(</span><span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">data_by_id_default</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">expect_sparse</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
        <span class="comment"># np.isnan doesn't work on CSR matrix</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">count_nonzero</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">data_by_id</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span>
                <span class="identifier">expected_missing</span><span class="grouping">)</span>

    <span class="comment"># test return_X_y option</span>
    <span class="identifier">fetch_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">fetch_openml</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                         <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="identifier">target_column</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">check_return_X_y</span><span class="grouping">(</span><span class="identifier">data_by_id</span><span class="punctuation">,</span> <span class="identifier">fetch_func</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">data_by_id</span>


<span class="keyword">class</span> <span class="identifier">_MockHTTPResponse</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">is_gzip</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_gzip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">is_gzip</span>

    <span class="keyword">def</span> <span class="identifier">read</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">amt</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="identifier">amt</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">close</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">close</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">info</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_gzip</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'Content-Encoding': 'gzip'</span><span class="grouping">}</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="grouping">}</span>

    <span class="keyword">def</span> <span class="identifier">__iter__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">iter</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">__enter__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">__exit__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">exc_type</span><span class="punctuation">,</span> <span class="identifier">exc_val</span><span class="punctuation">,</span> <span class="identifier">exc_tb</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="bool-literal">False</span>


<span class="keyword">def</span> <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">context</span><span class="punctuation">,</span>
                                     <span class="identifier">data_id</span><span class="punctuation">,</span>
                                     <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># monkey patches the urlopen function. Important note: Do NOT use this</span>
    <span class="comment"># in combination with a regular cache directory, as the files that are</span>
    <span class="comment"># stored as cache should not be mixed up with real openml datasets</span>
    <span class="identifier">url_prefix_data_description</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"https://openml.org/api/v1/json/data/"</span>
    <span class="identifier">url_prefix_data_features</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"https://openml.org/api/v1/json/data/features/"</span>
    <span class="identifier">url_prefix_download_data</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"https://openml.org/data/v1/"</span>
    <span class="identifier">url_prefix_data_list</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"https://openml.org/api/v1/json/data/list/"</span>

    <span class="identifier">path_suffix</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'.gz'</span>
    <span class="identifier">read_fn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gzip</span><span class="punctuation">.</span><span class="identifier">open</span>

    <span class="keyword">def</span> <span class="identifier">_file_name</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="identifier">suffix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">sub</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">'\W', '-'</span><span class="punctuation">,</span> <span class="identifier">url</span><span class="grouping">[</span><span class="identifier">len</span><span class="grouping">(</span><span class="string-literal">"https://openml.org/"</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="arithmetic-operator">+</span> <span class="identifier">suffix</span> <span class="arithmetic-operator">+</span> <span class="identifier">path_suffix</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_mock_urlopen_data_description</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="identifier">has_gzip_header</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">url</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="identifier">url_prefix_data_description</span><span class="grouping">)</span>

        <span class="identifier">path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">currdir</span><span class="punctuation">,</span> <span class="string-literal">'data', 'openml'</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">_file_name</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="string-literal">'.json'</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">has_gzip_header</span> <span class="logical-operator">and</span> <span class="identifier">gzip_response</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">path</span><span class="punctuation">,</span> <span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                <span class="identifier">fp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">_MockHTTPResponse</span><span class="grouping">(</span><span class="identifier">fp</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">read_fn</span><span class="grouping">(</span><span class="identifier">path</span><span class="punctuation">,</span> <span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                <span class="identifier">fp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">_MockHTTPResponse</span><span class="grouping">(</span><span class="identifier">fp</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_mock_urlopen_data_features</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="identifier">has_gzip_header</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">url</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="identifier">url_prefix_data_features</span><span class="grouping">)</span>
        <span class="identifier">path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">currdir</span><span class="punctuation">,</span> <span class="string-literal">'data', 'openml'</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">_file_name</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="string-literal">'.json'</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">has_gzip_header</span> <span class="logical-operator">and</span> <span class="identifier">gzip_response</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">path</span><span class="punctuation">,</span> <span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                <span class="identifier">fp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">_MockHTTPResponse</span><span class="grouping">(</span><span class="identifier">fp</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">read_fn</span><span class="grouping">(</span><span class="identifier">path</span><span class="punctuation">,</span> <span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                <span class="identifier">fp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">_MockHTTPResponse</span><span class="grouping">(</span><span class="identifier">fp</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_mock_urlopen_download_data</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="identifier">has_gzip_header</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="identifier">url_prefix_download_data</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">currdir</span><span class="punctuation">,</span> <span class="string-literal">'data', 'openml'</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">_file_name</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="string-literal">'.arff'</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">has_gzip_header</span> <span class="logical-operator">and</span> <span class="identifier">gzip_response</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">path</span><span class="punctuation">,</span> <span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                <span class="identifier">fp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">_MockHTTPResponse</span><span class="grouping">(</span><span class="identifier">fp</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">read_fn</span><span class="grouping">(</span><span class="identifier">path</span><span class="punctuation">,</span> <span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                <span class="identifier">fp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">_MockHTTPResponse</span><span class="grouping">(</span><span class="identifier">fp</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_mock_urlopen_data_list</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="identifier">has_gzip_header</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">url</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="identifier">url_prefix_data_list</span><span class="grouping">)</span>

        <span class="identifier">json_file_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">currdir</span><span class="punctuation">,</span> <span class="string-literal">'data', 'openml'</span><span class="punctuation">,</span>
                                      <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">_file_name</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="string-literal">'.json'</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># load the file itself, to simulate a http error</span>
        <span class="identifier">json_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">json</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">read_fn</span><span class="grouping">(</span><span class="identifier">json_file_path</span><span class="punctuation">,</span> <span class="string-literal">'rb'</span><span class="grouping">)</span><span class="punctuation">.</span>
                               <span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">decode</span><span class="grouping">(</span><span class="string-literal">'utf-8'</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="string-literal">'error'</span> <span class="relational-operator">in</span> <span class="identifier">json_data</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">HTTPError</span><span class="grouping">(</span><span class="identifier">url</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">code</span><span class="arithmetic-assignment">=</span><span class="int-literal">412</span><span class="punctuation">,</span>
                            <span class="identifier">msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Simulated mock error'</span><span class="punctuation">,</span>
                            <span class="identifier">hdrs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">fp</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">has_gzip_header</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">json_file_path</span><span class="punctuation">,</span> <span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                <span class="identifier">fp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">_MockHTTPResponse</span><span class="grouping">(</span><span class="identifier">fp</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">read_fn</span><span class="grouping">(</span><span class="identifier">json_file_path</span><span class="punctuation">,</span> <span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                <span class="identifier">fp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">_MockHTTPResponse</span><span class="grouping">(</span><span class="identifier">fp</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_mock_urlopen</span><span class="grouping">(</span><span class="identifier">request</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">url</span> <span class="arithmetic-assignment">=</span> <span class="identifier">request</span><span class="punctuation">.</span><span class="identifier">get_full_url</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">has_gzip_header</span> <span class="arithmetic-assignment">=</span> <span class="identifier">request</span><span class="punctuation">.</span><span class="identifier">get_header</span><span class="grouping">(</span><span class="string-literal">'Accept-encoding'</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"gzip"</span>
        <span class="keyword">if</span> <span class="identifier">url</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="identifier">url_prefix_data_list</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">_mock_urlopen_data_list</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="identifier">has_gzip_header</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">url</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="identifier">url_prefix_data_features</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">_mock_urlopen_data_features</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="identifier">has_gzip_header</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">url</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="identifier">url_prefix_download_data</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">_mock_urlopen_download_data</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="identifier">has_gzip_header</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">url</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="identifier">url_prefix_data_description</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">_mock_urlopen_data_description</span><span class="grouping">(</span><span class="identifier">url</span><span class="punctuation">,</span> <span class="identifier">has_gzip_header</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Unknown mocking URL pattern: %s'</span> <span class="arithmetic-operator">%</span> <span class="identifier">url</span><span class="grouping">)</span>

    <span class="comment"># XXX: Global variable</span>
    <span class="keyword">if</span> <span class="identifier">test_offline</span><span class="punctuation">:</span>
        <span class="identifier">context</span><span class="punctuation">.</span><span class="identifier">setattr</span><span class="grouping">(</span><span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">_openml</span><span class="punctuation">,</span> <span class="string-literal">'urlopen'</span><span class="punctuation">,</span> <span class="identifier">_mock_urlopen</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'feature, expected_dtype'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'data_type': 'string', 'number_of_missing_values': '0'</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">object</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'data_type': 'string', 'number_of_missing_values': '1'</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">object</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'data_type': 'numeric', 'number_of_missing_values': '0'</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'data_type': 'numeric', 'number_of_missing_values': '1'</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'data_type': 'real', 'number_of_missing_values': '0'</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'data_type': 'real', 'number_of_missing_values': '1'</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'data_type': 'integer', 'number_of_missing_values': '0'</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'data_type': 'integer', 'number_of_missing_values': '1'</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'data_type': 'nominal', 'number_of_missing_values': '0'}, 'category'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'data_type': 'nominal', 'number_of_missing_values': '1'}, 'category'</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_feature_to_dtype</span><span class="grouping">(</span><span class="identifier">feature</span><span class="punctuation">,</span> <span class="identifier">expected_dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">assert</span> <span class="identifier">_feature_to_dtype</span><span class="grouping">(</span><span class="identifier">feature</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected_dtype</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'feature'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">{</span><span class="string-literal">'data_type': 'datatime', 'number_of_missing_values': '0'</span><span class="grouping">}</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_feature_to_dtype_error</span><span class="grouping">(</span><span class="identifier">feature</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Unsupported feature: {}'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">feature</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_feature_to_dtype</span><span class="grouping">(</span><span class="identifier">feature</span><span class="grouping">)</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_iris_pandas</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># classification dataset with numeric only columns</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>
    <span class="identifier">CategoricalDtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">api</span><span class="punctuation">.</span><span class="identifier">types</span><span class="punctuation">.</span><span class="identifier">CategoricalDtype</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>
    <span class="identifier">data_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">150</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
    <span class="identifier">target_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">150</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="identifier">frame_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">150</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>

    <span class="identifier">target_dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CategoricalDtype</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'Iris-setosa', 'Iris-versicolor'</span><span class="punctuation">,</span>
                                     <span class="string-literal">'Iris-virginica'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">data_dtypes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">4</span>
    <span class="identifier">data_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'sepallength', 'sepalwidth', 'petallength', 'petalwidth'</span><span class="grouping">]</span>
    <span class="identifier">target_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'class'</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">frame</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="relational-operator">==</span> <span class="identifier">data_dtypes</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">data_shape</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">columns</span> <span class="relational-operator">==</span> <span class="identifier">data_names</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">feature_names</span> <span class="relational-operator">==</span> <span class="identifier">data_names</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target_names</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="identifier">target_name</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">Series</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">target_dtype</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">target_shape</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="identifier">target_name</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">index</span><span class="punctuation">.</span><span class="identifier">is_unique</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">frame_shape</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="relational-operator">==</span> <span class="identifier">data_dtypes</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="identifier">target_dtype</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">index</span><span class="punctuation">.</span><span class="identifier">is_unique</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_iris_pandas_equal_to_no_frame</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># as_frame = True returns the same underlying data as as_frame = False</span>
    <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">frame_bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">frame_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">frame_bunch</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">frame_target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">frame_bunch</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="identifier">norm_bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">norm_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">norm_bunch</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">norm_target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">norm_bunch</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">norm_data</span><span class="punctuation">,</span> <span class="identifier">frame_data</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">norm_target</span><span class="punctuation">,</span> <span class="identifier">frame_target</span><span class="grouping">)</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_iris_multitarget_pandas</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># classification dataset with numeric only columns</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>
    <span class="identifier">CategoricalDtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">api</span><span class="punctuation">.</span><span class="identifier">types</span><span class="punctuation">.</span><span class="identifier">CategoricalDtype</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>
    <span class="identifier">data_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">150</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">target_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">150</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">frame_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">150</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'petalwidth', 'petallength'</span><span class="grouping">]</span>

    <span class="identifier">cat_dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CategoricalDtype</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'Iris-setosa', 'Iris-versicolor'</span><span class="punctuation">,</span>
                                  <span class="string-literal">'Iris-virginica'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">data_dtypes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="identifier">cat_dtype</span><span class="grouping">]</span>
    <span class="identifier">data_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'sepallength', 'sepalwidth', 'class'</span><span class="grouping">]</span>
    <span class="identifier">target_dtypes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span>
    <span class="identifier">target_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'petalwidth', 'petallength'</span><span class="grouping">]</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                         <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="identifier">target_column</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">frame</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="relational-operator">==</span> <span class="identifier">data_dtypes</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">data_shape</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">columns</span> <span class="relational-operator">==</span> <span class="identifier">data_names</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">feature_names</span> <span class="relational-operator">==</span> <span class="identifier">data_names</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target_names</span> <span class="relational-operator">==</span> <span class="identifier">target_names</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="relational-operator">==</span> <span class="identifier">target_dtypes</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">target_shape</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">columns</span> <span class="relational-operator">==</span> <span class="identifier">target_names</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">frame_shape</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">4</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="identifier">cat_dtype</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_anneal_pandas</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># classification dataset with numeric and categorical columns</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>
    <span class="identifier">CategoricalDtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">api</span><span class="punctuation">.</span><span class="identifier">types</span><span class="punctuation">.</span><span class="identifier">CategoricalDtype</span>

    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'class'</span>
    <span class="identifier">data_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">38</span><span class="grouping">)</span>
    <span class="identifier">target_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="identifier">frame_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">39</span><span class="grouping">)</span>
    <span class="identifier">expected_data_categories</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">32</span>
    <span class="identifier">expected_data_floats</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                         <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="identifier">target_column</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">frame</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">data_shape</span>
    <span class="identifier">n_categories</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">dtype</span> <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtypes</span>
                       <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">CategoricalDtype</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">n_floats</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">dtype</span> <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="keyword">if</span> <span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'f'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">expected_data_categories</span> <span class="relational-operator">==</span> <span class="identifier">n_categories</span>
    <span class="keyword">assert</span> <span class="identifier">expected_data_floats</span> <span class="relational-operator">==</span> <span class="identifier">n_floats</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">Series</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">target_shape</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">CategoricalDtype</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">frame_shape</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_cpu_pandas</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># regression dataset with numeric and categorical columns</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>
    <span class="identifier">CategoricalDtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">api</span><span class="punctuation">.</span><span class="identifier">types</span><span class="punctuation">.</span><span class="identifier">CategoricalDtype</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">561</span>
    <span class="identifier">data_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">209</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">target_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">209</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="identifier">frame_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">209</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span>

    <span class="identifier">cat_dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CategoricalDtype</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'adviser', 'amdahl', 'apollo', 'basf'</span><span class="punctuation">,</span>
                                  <span class="string-literal">'bti', 'burroughs', 'c.r.d', 'cdc'</span><span class="punctuation">,</span>
                                  <span class="string-literal">'cambex', 'dec', 'dg', 'formation'</span><span class="punctuation">,</span>
                                  <span class="string-literal">'four-phase', 'gould', 'hp', 'harris'</span><span class="punctuation">,</span>
                                  <span class="string-literal">'honeywell', 'ibm', 'ipl', 'magnuson'</span><span class="punctuation">,</span>
                                  <span class="string-literal">'microdata', 'nas', 'ncr', 'nixdorf'</span><span class="punctuation">,</span>
                                  <span class="string-literal">'perkin-elmer', 'prime', 'siemens'</span><span class="punctuation">,</span>
                                  <span class="string-literal">'sperry', 'sratus', 'wang'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">data_dtypes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">cat_dtype</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">6</span>
    <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'vendor', 'MYCT', 'MMIN', 'MMAX', 'CACH'</span><span class="punctuation">,</span>
                     <span class="string-literal">'CHMIN', 'CHMAX'</span><span class="grouping">]</span>
    <span class="identifier">target_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'class'</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">frame</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">data_shape</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="relational-operator">==</span> <span class="identifier">data_dtypes</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">columns</span> <span class="relational-operator">==</span> <span class="identifier">feature_names</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">feature_names</span> <span class="relational-operator">==</span> <span class="identifier">feature_names</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target_names</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="identifier">target_name</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">Series</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">target_shape</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="identifier">target_name</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">frame_shape</span>


<span class="keyword">def</span> <span class="identifier">test_fetch_openml_australian_pandas_error_sparse</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">292</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Cannot return dataframe with sparse data'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_as_frame_auto</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>

    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>  <span class="comment"># iris dataset version 1</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>

    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">292</span>  <span class="comment"># Australian dataset version 1</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_convert_arff_data_dataframe_warning_low_memory_pandas</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>

    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1119</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Could not adhere to working_memory config.'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">config_context</span><span class="grouping">(</span><span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_adultcensus_pandas_return_X_y</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>
    <span class="identifier">CategoricalDtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">api</span><span class="punctuation">.</span><span class="identifier">types</span><span class="punctuation">.</span><span class="identifier">CategoricalDtype</span>

    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1119</span>
    <span class="identifier">data_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">14</span><span class="grouping">)</span>
    <span class="identifier">target_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="grouping">)</span>

    <span class="identifier">expected_data_categories</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">8</span>
    <span class="identifier">expected_data_floats</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'class'</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                        <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">data_shape</span>
    <span class="identifier">n_categories</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">dtype</span> <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtypes</span>
                       <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">CategoricalDtype</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">n_floats</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">dtype</span> <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="keyword">if</span> <span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'f'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">expected_data_categories</span> <span class="relational-operator">==</span> <span class="identifier">n_categories</span>
    <span class="keyword">assert</span> <span class="identifier">expected_data_floats</span> <span class="relational-operator">==</span> <span class="identifier">n_floats</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">Series</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">target_shape</span>
    <span class="keyword">assert</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="identifier">target_column</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_adultcensus_pandas</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>
    <span class="identifier">CategoricalDtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">api</span><span class="punctuation">.</span><span class="identifier">types</span><span class="punctuation">.</span><span class="identifier">CategoricalDtype</span>

    <span class="comment"># Check because of the numeric row attribute (issue #12329)</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1119</span>
    <span class="identifier">data_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">14</span><span class="grouping">)</span>
    <span class="identifier">target_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="identifier">frame_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span>

    <span class="identifier">expected_data_categories</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">8</span>
    <span class="identifier">expected_data_floats</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'class'</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">frame</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">data_shape</span>
    <span class="identifier">n_categories</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">dtype</span> <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtypes</span>
                       <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">CategoricalDtype</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">n_floats</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">dtype</span> <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="keyword">if</span> <span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'f'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">expected_data_categories</span> <span class="relational-operator">==</span> <span class="identifier">n_categories</span>
    <span class="keyword">assert</span> <span class="identifier">expected_data_floats</span> <span class="relational-operator">==</span> <span class="identifier">n_floats</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">Series</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">target_shape</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="identifier">target_column</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">frame_shape</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_miceprotein_pandas</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># JvR: very important check, as this dataset defined several row ids</span>
    <span class="comment"># and ignore attributes. Note that data_features json has 82 attributes,</span>
    <span class="comment"># and row id (1), ignore attributes (3) have been removed.</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>
    <span class="identifier">CategoricalDtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">api</span><span class="punctuation">.</span><span class="identifier">types</span><span class="punctuation">.</span><span class="identifier">CategoricalDtype</span>

    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40966</span>
    <span class="identifier">data_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">77</span><span class="grouping">)</span>
    <span class="identifier">target_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="identifier">frame_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">78</span><span class="grouping">)</span>

    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'class'</span>
    <span class="identifier">frame_n_categories</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">frame_n_floats</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">77</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">frame</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">data_shape</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">Series</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">CategoricalDtype</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">target_shape</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="identifier">target_column</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">frame_shape</span>
    <span class="identifier">n_categories</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">dtype</span> <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">dtypes</span>
                       <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">CategoricalDtype</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">n_floats</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">dtype</span> <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="keyword">if</span> <span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'f'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">frame_n_categories</span> <span class="relational-operator">==</span> <span class="identifier">n_categories</span>
    <span class="keyword">assert</span> <span class="identifier">frame_n_floats</span> <span class="relational-operator">==</span> <span class="identifier">n_floats</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_emotions_pandas</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># classification dataset with multiple targets (natively)</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>
    <span class="identifier">CategoricalDtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">api</span><span class="punctuation">.</span><span class="identifier">types</span><span class="punctuation">.</span><span class="identifier">CategoricalDtype</span>

    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40589</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'amazed.suprised', 'happy.pleased', 'relaxing.calm'</span><span class="punctuation">,</span>
                     <span class="string-literal">'quiet.still', 'sad.lonely', 'angry.aggresive'</span><span class="grouping">]</span>
    <span class="identifier">data_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">13</span><span class="punctuation">,</span> <span class="int-literal">72</span><span class="grouping">)</span>
    <span class="identifier">target_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">13</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span>
    <span class="identifier">frame_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">13</span><span class="punctuation">,</span> <span class="int-literal">78</span><span class="grouping">)</span>

    <span class="identifier">expected_frame_categories</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span>
    <span class="identifier">expected_frame_floats</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">72</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                         <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="identifier">target_column</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">frame</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">data_shape</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">target_shape</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">columns</span> <span class="relational-operator">==</span> <span class="identifier">target_column</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">frame_shape</span>
    <span class="identifier">n_categories</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">dtype</span> <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">dtypes</span>
                       <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">CategoricalDtype</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">n_floats</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">dtype</span> <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="keyword">if</span> <span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'f'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">expected_frame_categories</span> <span class="relational-operator">==</span> <span class="identifier">n_categories</span>
    <span class="keyword">assert</span> <span class="identifier">expected_frame_floats</span> <span class="relational-operator">==</span> <span class="identifier">n_floats</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_titanic_pandas</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># dataset with strings</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>
    <span class="identifier">CategoricalDtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">api</span><span class="punctuation">.</span><span class="identifier">types</span><span class="punctuation">.</span><span class="identifier">CategoricalDtype</span>

    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40945</span>
    <span class="identifier">data_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">1309</span><span class="punctuation">,</span> <span class="int-literal">13</span><span class="grouping">)</span>
    <span class="identifier">target_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">1309</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="identifier">frame_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">1309</span><span class="punctuation">,</span> <span class="int-literal">14</span><span class="grouping">)</span>
    <span class="identifier">name_to_dtype</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'pclass'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span>
        <span class="string-literal">'name'</span><span class="punctuation">:</span> <span class="identifier">object</span><span class="punctuation">,</span>
        <span class="string-literal">'sex': CategoricalDtype(['female', 'male'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'age'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span>
        <span class="string-literal">'sibsp'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span>
        <span class="string-literal">'parch'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span>
        <span class="string-literal">'ticket'</span><span class="punctuation">:</span> <span class="identifier">object</span><span class="punctuation">,</span>
        <span class="string-literal">'fare'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span>
        <span class="string-literal">'cabin'</span><span class="punctuation">:</span> <span class="identifier">object</span><span class="punctuation">,</span>
        <span class="string-literal">'embarked': CategoricalDtype(['C', 'Q', 'S'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'boat'</span><span class="punctuation">:</span> <span class="identifier">object</span><span class="punctuation">,</span>
        <span class="string-literal">'body'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span>
        <span class="string-literal">'home.dest'</span><span class="punctuation">:</span> <span class="identifier">object</span><span class="punctuation">,</span>
        <span class="string-literal">'survived': CategoricalDtype(['0', '1'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="grouping">}</span>

    <span class="identifier">frame_columns</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'pclass', 'survived', 'name', 'sex', 'age', 'sibsp'</span><span class="punctuation">,</span>
                     <span class="string-literal">'parch', 'ticket', 'fare', 'cabin', 'embarked'</span><span class="punctuation">,</span>
                     <span class="string-literal">'boat', 'body', 'home.dest'</span><span class="grouping">]</span>
    <span class="identifier">frame_dtypes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">name_to_dtype</span><span class="grouping">[</span><span class="identifier">col</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">col</span> <span class="relational-operator">in</span> <span class="identifier">frame_columns</span><span class="grouping">]</span>
    <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'pclass', 'name', 'sex', 'age', 'sibsp'</span><span class="punctuation">,</span>
                     <span class="string-literal">'parch', 'ticket', 'fare', 'cabin', 'embarked'</span><span class="punctuation">,</span>
                     <span class="string-literal">'boat', 'body', 'home.dest'</span><span class="grouping">]</span>
    <span class="identifier">target_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'survived'</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">frame</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">data_shape</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">columns</span> <span class="relational-operator">==</span> <span class="identifier">feature_names</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target_names</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="identifier">target_name</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">Series</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">target_shape</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="identifier">target_name</span>
    <span class="keyword">assert</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">name_to_dtype</span><span class="grouping">[</span><span class="identifier">target_name</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">frame_shape</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">dtypes</span> <span class="relational-operator">==</span> <span class="identifier">frame_dtypes</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_iris</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># classification dataset with numeric only columns</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>
    <span class="identifier">data_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'iris'</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Multiple active versions of the dataset matching the name"</span>
           <span class="string-literal">" iris exist. Versions may be fundamentally different, "</span>
           <span class="string-literal">"returning version 1."</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="identifier">data_name</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_decode_iris</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">_test_features_list</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_iris_multitarget</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># classification dataset with numeric only columns</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>
    <span class="identifier">data_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'iris'</span>
    <span class="identifier">data_version</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'sepallength', 'sepalwidth'</span><span class="grouping">]</span>
    <span class="identifier">expected_observations</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">150</span>
    <span class="identifier">expected_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">expected_missing</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">_fetch_dataset_from_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">data_name</span><span class="punctuation">,</span> <span class="identifier">data_version</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="punctuation">,</span>
                               <span class="identifier">expected_observations</span><span class="punctuation">,</span> <span class="identifier">expected_features</span><span class="punctuation">,</span>
                               <span class="identifier">expected_missing</span><span class="punctuation">,</span>
                               <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">expect_sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">compare_default_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_anneal</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># classification dataset with numeric and categorical columns</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">data_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'anneal'</span>
    <span class="identifier">data_version</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'class'</span>
    <span class="comment"># Not all original instances included for space reasons</span>
    <span class="identifier">expected_observations</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">11</span>
    <span class="identifier">expected_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">38</span>
    <span class="identifier">expected_missing</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">267</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">_fetch_dataset_from_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">data_name</span><span class="punctuation">,</span> <span class="identifier">data_version</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="punctuation">,</span>
                               <span class="identifier">expected_observations</span><span class="punctuation">,</span> <span class="identifier">expected_features</span><span class="punctuation">,</span>
                               <span class="identifier">expected_missing</span><span class="punctuation">,</span>
                               <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">object</span><span class="punctuation">,</span> <span class="identifier">expect_sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">compare_default_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_decode_anneal</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">_test_features_list</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_anneal_multitarget</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># classification dataset with numeric and categorical columns</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">data_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'anneal'</span>
    <span class="identifier">data_version</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'class', 'product-type', 'shape'</span><span class="grouping">]</span>
    <span class="comment"># Not all original instances included for space reasons</span>
    <span class="identifier">expected_observations</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">11</span>
    <span class="identifier">expected_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">36</span>
    <span class="identifier">expected_missing</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">267</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">_fetch_dataset_from_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">data_name</span><span class="punctuation">,</span> <span class="identifier">data_version</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="punctuation">,</span>
                               <span class="identifier">expected_observations</span><span class="punctuation">,</span> <span class="identifier">expected_features</span><span class="punctuation">,</span>
                               <span class="identifier">expected_missing</span><span class="punctuation">,</span>
                               <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">object</span><span class="punctuation">,</span> <span class="identifier">expect_sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">compare_default_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_cpu</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># regression dataset with numeric and categorical columns</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">561</span>
    <span class="identifier">data_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'cpu'</span>
    <span class="identifier">data_version</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'class'</span>
    <span class="identifier">expected_observations</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">209</span>
    <span class="identifier">expected_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">7</span>
    <span class="identifier">expected_missing</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">_fetch_dataset_from_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">data_name</span><span class="punctuation">,</span> <span class="identifier">data_version</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="punctuation">,</span>
                               <span class="identifier">expected_observations</span><span class="punctuation">,</span> <span class="identifier">expected_features</span><span class="punctuation">,</span>
                               <span class="identifier">expected_missing</span><span class="punctuation">,</span>
                               <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">expect_sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">compare_default_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_decode_cpu</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">561</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">_test_features_list</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_australian</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># sparse dataset</span>
    <span class="comment"># Australian is the only sparse dataset that is reasonably small</span>
    <span class="comment"># as it is inactive, we need to catch the warning. Due to mocking</span>
    <span class="comment"># framework, it is not deactivated in our tests</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">292</span>
    <span class="identifier">data_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Australian'</span>
    <span class="identifier">data_version</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Y'</span>
    <span class="comment"># Not all original instances included for space reasons</span>
    <span class="identifier">expected_observations</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">85</span>
    <span class="identifier">expected_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">14</span>
    <span class="identifier">expected_missing</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Version 1 of dataset Australian is inactive,"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_fetch_dataset_from_openml</span><span class="grouping">(</span>
            <span class="arithmetic-operator">**</span><span class="grouping">{</span><span class="string-literal">'data_id': data_id, 'data_name'</span><span class="punctuation">:</span> <span class="identifier">data_name</span><span class="punctuation">,</span>
               <span class="string-literal">'data_version'</span><span class="punctuation">:</span> <span class="identifier">data_version</span><span class="punctuation">,</span>
               <span class="string-literal">'target_column'</span><span class="punctuation">:</span> <span class="identifier">target_column</span><span class="punctuation">,</span>
               <span class="string-literal">'expected_observations'</span><span class="punctuation">:</span> <span class="identifier">expected_observations</span><span class="punctuation">,</span>
               <span class="string-literal">'expected_features'</span><span class="punctuation">:</span> <span class="identifier">expected_features</span><span class="punctuation">,</span>
               <span class="string-literal">'expected_missing'</span><span class="punctuation">:</span> <span class="identifier">expected_missing</span><span class="punctuation">,</span>
               <span class="string-literal">'expect_sparse'</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="punctuation">,</span>
               <span class="string-literal">'expected_data_dtype'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span>
               <span class="string-literal">'expected_target_dtype'</span><span class="punctuation">:</span> <span class="identifier">object</span><span class="punctuation">,</span>
               <span class="string-literal">'compare_default_target'</span><span class="punctuation">:</span> <span class="bool-literal">False</span><span class="grouping">}</span>  <span class="comment"># numpy specific check</span>
        <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_adultcensus</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check because of the numeric row attribute (issue #12329)</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1119</span>
    <span class="identifier">data_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'adult-census'</span>
    <span class="identifier">data_version</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'class'</span>
    <span class="comment"># Not all original instances included for space reasons</span>
    <span class="identifier">expected_observations</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">expected_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">14</span>
    <span class="identifier">expected_missing</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">_fetch_dataset_from_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">data_name</span><span class="punctuation">,</span> <span class="identifier">data_version</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="punctuation">,</span>
                               <span class="identifier">expected_observations</span><span class="punctuation">,</span> <span class="identifier">expected_features</span><span class="punctuation">,</span>
                               <span class="identifier">expected_missing</span><span class="punctuation">,</span>
                               <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">object</span><span class="punctuation">,</span> <span class="identifier">expect_sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">compare_default_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_miceprotein</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># JvR: very important check, as this dataset defined several row ids</span>
    <span class="comment"># and ignore attributes. Note that data_features json has 82 attributes,</span>
    <span class="comment"># and row id (1), ignore attributes (3) have been removed (and target is</span>
    <span class="comment"># stored in data.target)</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40966</span>
    <span class="identifier">data_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'MiceProtein'</span>
    <span class="identifier">data_version</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'class'</span>
    <span class="comment"># Not all original instances included for space reasons</span>
    <span class="identifier">expected_observations</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">7</span>
    <span class="identifier">expected_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">77</span>
    <span class="identifier">expected_missing</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">7</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">_fetch_dataset_from_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">data_name</span><span class="punctuation">,</span> <span class="identifier">data_version</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="punctuation">,</span>
                               <span class="identifier">expected_observations</span><span class="punctuation">,</span> <span class="identifier">expected_features</span><span class="punctuation">,</span>
                               <span class="identifier">expected_missing</span><span class="punctuation">,</span>
                               <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">object</span><span class="punctuation">,</span> <span class="identifier">expect_sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">compare_default_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_emotions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># classification dataset with multiple targets (natively)</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40589</span>
    <span class="identifier">data_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'emotions'</span>
    <span class="identifier">data_version</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'amazed.suprised', 'happy.pleased', 'relaxing.calm'</span><span class="punctuation">,</span>
                     <span class="string-literal">'quiet.still', 'sad.lonely', 'angry.aggresive'</span><span class="grouping">]</span>
    <span class="identifier">expected_observations</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">13</span>
    <span class="identifier">expected_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">72</span>
    <span class="identifier">expected_missing</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>

    <span class="identifier">_fetch_dataset_from_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">data_name</span><span class="punctuation">,</span> <span class="identifier">data_version</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="punctuation">,</span>
                               <span class="identifier">expected_observations</span><span class="punctuation">,</span> <span class="identifier">expected_features</span><span class="punctuation">,</span>
                               <span class="identifier">expected_missing</span><span class="punctuation">,</span>
                               <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">object</span><span class="punctuation">,</span> <span class="identifier">expect_sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">compare_default_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_decode_emotions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40589</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">_test_features_list</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_open_openml_url_cache</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="punctuation">,</span> <span class="identifier">tmpdir</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span>
        <span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">openml_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">_openml</span><span class="punctuation">.</span><span class="identifier">_DATA_FILE</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span>
    <span class="identifier">cache_directory</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">tmpdir</span><span class="punctuation">.</span><span class="identifier">mkdir</span><span class="grouping">(</span><span class="string-literal">'scikit_learn_data'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># first fill the cache</span>
    <span class="identifier">response1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_open_openml_url</span><span class="grouping">(</span><span class="identifier">openml_path</span><span class="punctuation">,</span> <span class="identifier">cache_directory</span><span class="grouping">)</span>
    <span class="comment"># assert file exists</span>
    <span class="identifier">location</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_local_path</span><span class="grouping">(</span><span class="identifier">openml_path</span><span class="punctuation">,</span> <span class="identifier">cache_directory</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">isfile</span><span class="grouping">(</span><span class="identifier">location</span><span class="grouping">)</span>
    <span class="comment"># redownload, to utilize cache</span>
    <span class="identifier">response2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_open_openml_url</span><span class="grouping">(</span><span class="identifier">openml_path</span><span class="punctuation">,</span> <span class="identifier">cache_directory</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">response1</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">response2</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'write_to_disk'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_open_openml_url_unlinks_local_path</span><span class="grouping">(</span>
        <span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="punctuation">,</span> <span class="identifier">tmpdir</span><span class="punctuation">,</span> <span class="identifier">write_to_disk</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>
    <span class="identifier">openml_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">_openml</span><span class="punctuation">.</span><span class="identifier">_DATA_FILE</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span>
    <span class="identifier">cache_directory</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">tmpdir</span><span class="punctuation">.</span><span class="identifier">mkdir</span><span class="grouping">(</span><span class="string-literal">'scikit_learn_data'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">location</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_local_path</span><span class="grouping">(</span><span class="identifier">openml_path</span><span class="punctuation">,</span> <span class="identifier">cache_directory</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_mock_urlopen</span><span class="grouping">(</span><span class="identifier">request</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">write_to_disk</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">location</span><span class="punctuation">,</span> <span class="string-literal">"w"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">write</span><span class="grouping">(</span><span class="string-literal">""</span><span class="grouping">)</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Invalid request"</span><span class="grouping">)</span>

    <span class="identifier">monkeypatch</span><span class="punctuation">.</span><span class="identifier">setattr</span><span class="grouping">(</span><span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">_openml</span><span class="punctuation">,</span> <span class="string-literal">'urlopen'</span><span class="punctuation">,</span> <span class="identifier">_mock_urlopen</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Invalid request"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_open_openml_url</span><span class="grouping">(</span><span class="identifier">openml_path</span><span class="punctuation">,</span> <span class="identifier">cache_directory</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">location</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_retry_with_clean_cache</span><span class="grouping">(</span><span class="identifier">tmpdir</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>
    <span class="identifier">openml_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">_openml</span><span class="punctuation">.</span><span class="identifier">_DATA_FILE</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span>
    <span class="identifier">cache_directory</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">tmpdir</span><span class="punctuation">.</span><span class="identifier">mkdir</span><span class="grouping">(</span><span class="string-literal">'scikit_learn_data'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">location</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_local_path</span><span class="grouping">(</span><span class="identifier">openml_path</span><span class="punctuation">,</span> <span class="identifier">cache_directory</span><span class="grouping">)</span>
    <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">makedirs</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">dirname</span><span class="grouping">(</span><span class="identifier">location</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">location</span><span class="punctuation">,</span> <span class="string-literal">'w'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
        <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">write</span><span class="grouping">(</span><span class="string-literal">""</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">_retry_with_clean_cache</span><span class="grouping">(</span><span class="identifier">openml_path</span><span class="punctuation">,</span> <span class="identifier">cache_directory</span><span class="grouping">)</span>
    <span class="keyword">def</span> <span class="identifier">_load_data</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># The first call will raise an error since location exists</span>
        <span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">location</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="invalid">E</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="grouping">(</span><span class="string-literal">"File exist!"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="int-literal">1</span>

    <span class="identifier">warn_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Invalid cache, redownloading file"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">RuntimeWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warn_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_load_data</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">result</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="keyword">def</span> <span class="identifier">test_retry_with_clean_cache_http_error</span><span class="grouping">(</span><span class="identifier">tmpdir</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>
    <span class="identifier">openml_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">_openml</span><span class="punctuation">.</span><span class="identifier">_DATA_FILE</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span>
    <span class="identifier">cache_directory</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">tmpdir</span><span class="punctuation">.</span><span class="identifier">mkdir</span><span class="grouping">(</span><span class="string-literal">'scikit_learn_data'</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">_retry_with_clean_cache</span><span class="grouping">(</span><span class="identifier">openml_path</span><span class="punctuation">,</span> <span class="identifier">cache_directory</span><span class="grouping">)</span>
    <span class="keyword">def</span> <span class="identifier">_load_data</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">HTTPError</span><span class="grouping">(</span><span class="identifier">url</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">code</span><span class="arithmetic-assignment">=</span><span class="int-literal">412</span><span class="punctuation">,</span>
                        <span class="identifier">msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Simulated mock error'</span><span class="punctuation">,</span>
                        <span class="identifier">hdrs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">fp</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>

    <span class="identifier">error_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Simulated mock error"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">HTTPError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_load_data</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_cache</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="punctuation">,</span> <span class="identifier">tmpdir</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">_mock_urlopen_raise</span><span class="grouping">(</span><span class="identifier">request</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'This mechanism intends to test correct cache'</span>
                         <span class="string-literal">'handling. As such, urlopen should never be '</span>
                         <span class="string-literal">'accessed. URL: %s'</span> <span class="arithmetic-operator">%</span> <span class="identifier">request</span><span class="punctuation">.</span><span class="identifier">get_full_url</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">cache_directory</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">tmpdir</span><span class="punctuation">.</span><span class="identifier">mkdir</span><span class="grouping">(</span><span class="string-literal">'scikit_learn_data'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span>
        <span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">X_fetched</span><span class="punctuation">,</span> <span class="identifier">y_fetched</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                        <span class="identifier">data_home</span><span class="arithmetic-assignment">=</span><span class="identifier">cache_directory</span><span class="punctuation">,</span>
                                        <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">monkeypatch</span><span class="punctuation">.</span><span class="identifier">setattr</span><span class="grouping">(</span><span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">_openml</span><span class="punctuation">,</span> <span class="string-literal">'urlopen'</span><span class="punctuation">,</span>
                        <span class="identifier">_mock_urlopen_raise</span><span class="grouping">)</span>

    <span class="identifier">X_cached</span><span class="punctuation">,</span> <span class="identifier">y_cached</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                      <span class="identifier">data_home</span><span class="arithmetic-assignment">=</span><span class="identifier">cache_directory</span><span class="punctuation">,</span>
                                      <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_fetched</span><span class="punctuation">,</span> <span class="identifier">X_cached</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_fetched</span><span class="punctuation">,</span> <span class="identifier">y_cached</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_notarget</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>
    <span class="identifier">target_column</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="identifier">expected_observations</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">150</span>
    <span class="identifier">expected_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>

    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="identifier">target_column</span><span class="punctuation">,</span>
                        <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_observations</span><span class="punctuation">,</span> <span class="identifier">expected_features</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_inactive</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># fetch inactive dataset by id</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40675</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Version 1 of dataset glass2 is inactive,"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">glas2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="comment"># fetch inactive dataset by name and version</span>
    <span class="keyword">assert</span> <span class="identifier">glas2</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">163</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">glas2_by_version</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'glass2'</span><span class="punctuation">,</span>
                                        <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">version</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">glas2_by_version</span><span class="punctuation">.</span><span class="identifier">details</span><span class="grouping">[</span><span class="string-literal">'id'</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">data_id</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_nonexiting</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># there is no active version of glass2</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40675</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="comment"># Note that we only want to search by name (not data id)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"No active dataset glass2 found"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'glass2'</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_raises_illegal_multitarget</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>
    <span class="identifier">targets</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'sepalwidth', 'class'</span><span class="grouping">]</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="comment"># Note that we only want to search by name (not data id)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Can only handle homogeneous multi-target datasets,"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="identifier">targets</span><span class="punctuation">,</span>
                     <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_warn_ignore_attribute</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40966</span>
    <span class="identifier">expected_row_id_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"target_column={} has flag is_row_identifier."</span>
    <span class="identifier">expected_ignore_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"target_column={} has flag is_ignore."</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="comment"># single column test</span>
    <span class="identifier">target_col</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'MouseID'</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected_row_id_msg</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">target_col</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="identifier">target_col</span><span class="punctuation">,</span>
                     <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">target_col</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Genotype'</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected_ignore_msg</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">target_col</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="identifier">target_col</span><span class="punctuation">,</span>
                     <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="comment"># multi column test</span>
    <span class="identifier">target_col</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'MouseID'</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected_row_id_msg</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">target_col</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">target_col</span><span class="punctuation">,</span> <span class="string-literal">'class'</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">target_col</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Genotype'</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected_ignore_msg</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">target_col</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">target_col</span><span class="punctuation">,</span> <span class="string-literal">'class'</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_string_attribute_without_dataframe</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40945</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="comment"># single column test</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">'STRING attributes are not supported for '</span>
        <span class="string-literal">'array representation. Try as_frame=True'</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_dataset_with_openml_error</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"OpenML registered a problem with the dataset. It might be unusable. "</span>
        <span class="string-literal">"Error:"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_dataset_with_openml_warning</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"OpenML raised a warning on the dataset. It might be unusable. "</span>
        <span class="string-literal">"Warning:"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_illegal_column</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">61</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Could not find target_column="</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">KeyError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="string-literal">'undefined'</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">KeyError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'undefined', 'class'</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_raises_missing_values_target</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Target column '</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">target_column</span><span class="arithmetic-assignment">=</span><span class="string-literal">'family'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_fetch_openml_raises_illegal_argument</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Dataset data_id='</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"name"</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">version</span><span class="arithmetic-assignment">=</span><span class="string-literal">"version"</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"name", version="version"</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"Neither name nor data_id are provided. "</span>
        <span class="string-literal">"Please provide name or data_id."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gzip_response'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_with_ignored_feature</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Regression test for #14340</span>
    <span class="comment"># 62 is the ID of the ZOO dataset</span>
    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">62</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">gzip_response</span><span class="grouping">)</span>

    <span class="identifier">dataset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">dataset</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span>
    <span class="comment"># The dataset has 17 features, including 1 ignored (animal),</span>
    <span class="comment"># so we assert that we don't have the ignored feature in the final Bunch</span>
    <span class="keyword">assert</span> <span class="identifier">dataset</span><span class="grouping">[</span><span class="string-literal">'data'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">101</span><span class="punctuation">,</span> <span class="int-literal">16</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="string-literal">'animal' not in dataset['feature_names'</span><span class="grouping">]</span>


<span class="comment"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'as_frame'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fetch_openml_verify_checksum</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="punctuation">,</span> <span class="identifier">tmpdir</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="punctuation">:</span>
        <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>

    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="comment"># create a temporary modified arff file</span>
    <span class="identifier">dataset_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">currdir</span><span class="punctuation">,</span> <span class="string-literal">'data', 'openml'</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">original_data_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">dataset_dir</span><span class="punctuation">,</span>
                                      <span class="string-literal">'data-v1-download-1666876.arff.gz'</span><span class="grouping">)</span>
    <span class="identifier">corrupt_copy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">tmpdir</span><span class="punctuation">,</span> <span class="string-literal">"test_invalid_checksum.arff"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">gzip</span><span class="punctuation">.</span><span class="identifier">GzipFile</span><span class="grouping">(</span><span class="identifier">original_data_path</span><span class="punctuation">,</span> <span class="string-literal">"rb"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">orig_gzip</span><span class="punctuation">,</span> <span class="invalid">\</span>
            <span class="identifier">gzip</span><span class="punctuation">.</span><span class="identifier">GzipFile</span><span class="grouping">(</span><span class="identifier">corrupt_copy</span><span class="punctuation">,</span> <span class="string-literal">"wb"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">modified_gzip</span><span class="punctuation">:</span>
        <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bytearray</span><span class="grouping">(</span><span class="identifier">orig_gzip</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">data</span><span class="grouping">[</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">37</span>
        <span class="identifier">modified_gzip</span><span class="punctuation">.</span><span class="identifier">write</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="comment"># Requests are already mocked by monkey_patch_webbased_functions.</span>
    <span class="comment"># We want to re-use that mock for all requests except file download,</span>
    <span class="comment"># hence creating a thin mock over the original mock</span>
    <span class="identifier">mocked_openml_url</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">_openml</span><span class="punctuation">.</span><span class="identifier">urlopen</span>

    <span class="keyword">def</span> <span class="identifier">swap_file_mock</span><span class="grouping">(</span><span class="identifier">request</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">url</span> <span class="arithmetic-assignment">=</span> <span class="identifier">request</span><span class="punctuation">.</span><span class="identifier">get_full_url</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">url</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="string-literal">'data/v1/download/1666876'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">_MockHTTPResponse</span><span class="grouping">(</span><span class="identifier">open</span><span class="grouping">(</span><span class="identifier">corrupt_copy</span><span class="punctuation">,</span> <span class="string-literal">"rb"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">is_gzip</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">mocked_openml_url</span><span class="grouping">(</span><span class="identifier">request</span><span class="grouping">)</span>

    <span class="identifier">monkeypatch</span><span class="punctuation">.</span><span class="identifier">setattr</span><span class="grouping">(</span><span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">_openml</span><span class="punctuation">,</span> <span class="string-literal">'urlopen'</span><span class="punctuation">,</span> <span class="identifier">swap_file_mock</span><span class="grouping">)</span>

    <span class="comment"># validate failed checksum</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">exc</span><span class="punctuation">:</span>
        <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                      <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="grouping">)</span>
    <span class="comment"># exception message should have file-path</span>
    <span class="keyword">assert</span> <span class="identifier">exc</span><span class="punctuation">.</span><span class="identifier">match</span><span class="grouping">(</span><span class="string-literal">"1666876"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_convert_arff_data_type</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>

    <span class="identifier">arff</span><span class="punctuation">:</span> <span class="identifier">ArffContainerType</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
            <span class="string-literal">'data'</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">el</span> <span class="keyword">for</span> <span class="identifier">el</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">'description': ''</span><span class="punctuation">,</span>
            <span class="string-literal">'relation': ''</span><span class="punctuation">,</span>
            <span class="string-literal">'attributes'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="grouping">}</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"shape must be provided when arr\['data'\] is a Generator"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_convert_arff_data</span><span class="grouping">(</span><span class="identifier">arff</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>

    <span class="identifier">arff</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
            <span class="string-literal">'data'</span><span class="punctuation">:</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">'description': ''</span><span class="punctuation">,</span>
            <span class="string-literal">'relation': ''</span><span class="punctuation">,</span>
            <span class="string-literal">'attributes'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="grouping">}</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"arff\['data'\] must be a generator when converting to pd.DataFrame"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_convert_arff_data_dataframe</span><span class="grouping">(</span><span class="identifier">arff</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'a'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="grouping">}</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_missing_values_pandas</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""check that missing values in categories are compatible with pandas
    categorical"""</span>
    <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>

    <span class="identifier">data_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">42585</span>
    <span class="identifier">_monkey_patch_webbased_functions</span><span class="grouping">(</span><span class="identifier">monkeypatch</span><span class="punctuation">,</span> <span class="identifier">data_id</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">penguins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">data_id</span><span class="arithmetic-assignment">=</span><span class="identifier">data_id</span><span class="punctuation">,</span> <span class="identifier">cache</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">cat_dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">penguins</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtypes</span><span class="grouping">[</span><span class="string-literal">'sex'</span><span class="grouping">]</span>
    <span class="comment"># there are nans in the categorical</span>
    <span class="keyword">assert</span> <span class="identifier">penguins</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="string-literal">'sex'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">isna</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">cat_dtype</span><span class="punctuation">.</span><span class="identifier">categories</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'FEMALE', 'MALE', '_'</span><span class="grouping">]</span><span class="grouping">)</span>

    </pre>
  </body>
</html>