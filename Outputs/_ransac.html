<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># coding: utf-8</span>

<span class="comment"># Author: Johannes Sch√∂nberger</span>
<span class="comment">#</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">warnings</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="identifier">MetaEstimatorMixin</span><span class="punctuation">,</span> <span class="identifier">RegressorMixin</span><span class="punctuation">,</span> <span class="identifier">clone</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">MultiOutputMixin</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span><span class="punctuation">,</span> <span class="identifier">check_consistent_length</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">random</span> <span class="keyword">import</span> <span class="identifier">sample_without_replacement</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_is_fitted</span><span class="punctuation">,</span> <span class="identifier">_check_sample_weight</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">LinearRegression</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">has_fit_parameter</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>

<span class="identifier">_EPSILON</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">spacing</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_dynamic_max_trials</span><span class="grouping">(</span><span class="identifier">n_inliers</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">min_samples</span><span class="punctuation">,</span> <span class="identifier">probability</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Determine number trials such that at least one outlier-free subset is
    sampled for the given inlier/outlier ratio.

    Parameters
    ----------
    n_inliers : int
        Number of inliers in the data.

    n_samples : int
        Total number of samples in the data.

    min_samples : int
        Minimum number of samples chosen randomly from original data.

    probability : float
        Probability (confidence) that one outlier-free sample is generated.

    Returns
    -------
    trials : int
        Number of trials.

    """</span>
    <span class="identifier">inlier_ratio</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_inliers</span> <span class="arithmetic-operator">/</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">nom</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">_EPSILON</span><span class="punctuation">,</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">probability</span><span class="grouping">)</span>
    <span class="identifier">denom</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">_EPSILON</span><span class="punctuation">,</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">inlier_ratio</span> <span class="arithmetic-operator">**</span> <span class="identifier">min_samples</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">nom</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="int-literal">0</span>
    <span class="keyword">if</span> <span class="identifier">denom</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">float</span><span class="grouping">(</span><span class="string-literal">'inf'</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">float</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ceil</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">nom</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">denom</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">RANSACRegressor</span><span class="grouping">(</span><span class="identifier">MetaEstimatorMixin</span><span class="punctuation">,</span> <span class="identifier">RegressorMixin</span><span class="punctuation">,</span>
                      <span class="identifier">MultiOutputMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""RANSAC (RANdom SAmple Consensus) algorithm.

    RANSAC is an iterative algorithm for the robust estimation of parameters
    from a subset of inliers from the complete data set.

    Read more in the :ref:`User Guide &lt;ransac_regression&gt;`.

    Parameters
    ----------
    base_estimator : object, default=None
        Base estimator object which implements the following methods:

         * `fit(X, y)`: Fit model to given training data and target values.
         * `score(X, y)`: Returns the mean accuracy on the given test data,
           which is used for the stop criterion defined by `stop_score`.
           Additionally, the score is used to decide which of two equally
           large consensus sets is chosen as the better one.
         * `predict(X)`: Returns predicted values using the linear model,
           which is used to compute residual error using loss function.

        If `base_estimator` is None, then
        :class:`~sklearn.linear_model.LinearRegression` is used for
        target values of dtype float.

        Note that the current implementation only supports regression
        estimators.

    min_samples : int (&gt;= 1) or float ([0, 1]), default=None
        Minimum number of samples chosen randomly from original data. Treated
        as an absolute number of samples for `min_samples &gt;= 1`, treated as a
        relative number `ceil(min_samples * X.shape[0]`) for
        `min_samples &lt; 1`. This is typically chosen as the minimal number of
        samples necessary to estimate the given `base_estimator`. By default a
        ``sklearn.linear_model.LinearRegression()`` estimator is assumed and
        `min_samples` is chosen as ``X.shape[1] + 1``.

    residual_threshold : float, default=None
        Maximum residual for a data sample to be classified as an inlier.
        By default the threshold is chosen as the MAD (median absolute
        deviation) of the target values `y`.

    is_data_valid : callable, default=None
        This function is called with the randomly selected data before the
        model is fitted to it: `is_data_valid(X, y)`. If its return value is
        False the current randomly chosen sub-sample is skipped.

    is_model_valid : callable, default=None
        This function is called with the estimated model and the randomly
        selected data: `is_model_valid(model, X, y)`. If its return value is
        False the current randomly chosen sub-sample is skipped.
        Rejecting samples with this function is computationally costlier than
        with `is_data_valid`. `is_model_valid` should therefore only be used if
        the estimated model is needed for making the rejection decision.

    max_trials : int, default=100
        Maximum number of iterations for random sample selection.

    max_skips : int, default=np.inf
        Maximum number of iterations that can be skipped due to finding zero
        inliers or invalid data defined by ``is_data_valid`` or invalid models
        defined by ``is_model_valid``.

        .. versionadded:: 0.19

    stop_n_inliers : int, default=np.inf
        Stop iteration if at least this number of inliers are found.

    stop_score : float, default=np.inf
        Stop iteration if score is greater equal than this threshold.

    stop_probability : float in range [0, 1], default=0.99
        RANSAC iteration stops if at least one outlier-free set of the training
        data is sampled in RANSAC. This requires to generate at least N
        samples (iterations)::

            N &gt;= log(1 - probability) / log(1 - e**m)

        where the probability (confidence) is typically set to high value such
        as 0.99 (the default) and e is the current fraction of inliers w.r.t.
        the total number of samples.

    loss : string, callable, default='absolute_error'
        String inputs, 'absolute_error' and 'squared_error' are supported which
        find the absolute error and squared error per sample respectively.

        If ``loss`` is a callable, then it should be a function that takes
        two arrays as inputs, the true and predicted value and returns a 1-D
        array with the i-th value of the array corresponding to the loss
        on ``X[i]``.

        If the loss on a sample is greater than the ``residual_threshold``,
        then this sample is classified as an outlier.

        .. versionadded:: 0.18

        .. deprecated:: 1.0
            The loss 'squared_loss' was deprecated in v1.0 and will be removed
            in version 1.2. Use `loss='squared_error'` which is equivalent.

        .. deprecated:: 1.0
            The loss 'absolute_loss' was deprecated in v1.0 and will be removed
            in version 1.2. Use `loss='absolute_error'` which is equivalent.

    random_state : int, RandomState instance, default=None
        The generator used to initialize the centers.
        Pass an int for reproducible output across multiple function calls.
        See :term:`Glossary &lt;random_state&gt;`.

    Attributes
    ----------
    estimator_ : object
        Best fitted model (copy of the `base_estimator` object).

    n_trials_ : int
        Number of random selection trials until one of the stop criteria is
        met. It is always ``&lt;= max_trials``.

    inlier_mask_ : bool array of shape [n_samples]
        Boolean mask of inliers classified as ``True``.

    n_skips_no_inliers_ : int
        Number of iterations skipped due to finding zero inliers.

        .. versionadded:: 0.19

    n_skips_invalid_data_ : int
        Number of iterations skipped due to invalid data defined by
        ``is_data_valid``.

        .. versionadded:: 0.19

    n_skips_invalid_model_ : int
        Number of iterations skipped due to an invalid model defined by
        ``is_model_valid``.

        .. versionadded:: 0.19

    Examples
    --------
    &gt;&gt;&gt; from sklearn.linear_model import RANSACRegressor
    &gt;&gt;&gt; from sklearn.datasets import make_regression
    &gt;&gt;&gt; X, y = make_regression(
    ...     n_samples=200, n_features=2, noise=4.0, random_state=0)
    &gt;&gt;&gt; reg = RANSACRegressor(random_state=0).fit(X, y)
    &gt;&gt;&gt; reg.score(X, y)
    0.9885...
    &gt;&gt;&gt; reg.predict(X[:1,])
    array([-31.9417...])

    References
    ----------
    .. [1] https://en.wikipedia.org/wiki/RANSAC
    .. [2] https://www.sri.com/sites/default/files/publications/ransac-publication.pdf
    .. [3] http://www.bmva.org/bmvc/2009/Papers/Paper355/Paper355.pdf
    """</span>  <span class="comment"># noqa: E501</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">min_samples</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">residual_threshold</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">is_data_valid</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">is_model_valid</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_trials</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">max_skips</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span>
                 <span class="identifier">stop_n_inliers</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">stop_score</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span>
                 <span class="identifier">stop_probability</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.99</span><span class="punctuation">,</span> <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'absolute_error'</span><span class="punctuation">,</span>
                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">base_estimator</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">min_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min_samples</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">residual_threshold</span> <span class="arithmetic-assignment">=</span> <span class="identifier">residual_threshold</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_data_valid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">is_data_valid</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_model_valid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">is_model_valid</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_trials</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_trials</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_skips</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_skips</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stop_n_inliers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stop_n_inliers</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stop_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stop_score</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stop_probability</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stop_probability</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Fit estimator using RANSAC algorithm.

        Parameters
        ----------
        X : array-like or sparse matrix, shape [n_samples, n_features]
            Training data.

        y : array-like of shape (n_samples,) or (n_samples, n_targets)
            Target values.

        sample_weight : array-like of shape (n_samples,), default=None
            Individual weights for each sample
            raises error if sample_weight is passed and base_estimator
            fit method does not support it.

            .. versionadded:: 0.18

        Raises
        ------
        ValueError
            If no valid consensus set could be found. This occurs if
            `is_data_valid` and `is_model_valid` return False for all
            `max_trials` randomly chosen sub-samples.

        """</span>
        <span class="comment"># Need to validate separately here.</span>
        <span class="comment"># We can't pass multi_ouput=True because that would allow y to be csr.</span>
        <span class="identifier">check_X_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="string-literal">'csr'</span><span class="grouping">)</span>
        <span class="identifier">check_y_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">ensure_2d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">validate_separately</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">check_X_params</span><span class="punctuation">,</span>
                                                              <span class="identifier">check_y_params</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">check_consistent_length</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">base_estimator</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">base_estimator</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">min_samples</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="comment"># assume linear model by default</span>
            <span class="identifier">min_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="keyword">elif</span> <span class="int-literal">0</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">min_samples</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">min_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ceil</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">min_samples</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">min_samples</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">min_samples</span> <span class="arithmetic-operator">%</span> <span class="int-literal">1</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Absolute number of samples must be an "</span>
                                 <span class="string-literal">"integer value."</span><span class="grouping">)</span>
            <span class="identifier">min_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">min_samples</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Value for `min_samples` must be scalar and "</span>
                             <span class="string-literal">"positive."</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">min_samples</span> <span class="relational-operator">&gt;</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"`min_samples` may not be larger than number "</span>
                             <span class="string-literal">"of samples: n_samples = %d."</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stop_probability</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span> <span class="logical-operator">or</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stop_probability</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"`stop_probability` must be in range [0, 1]."</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">residual_threshold</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="comment"># MAD (median absolute deviation)</span>
            <span class="identifier">residual_threshold</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">median</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">median</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">residual_threshold</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">residual_threshold</span>

        <span class="comment"># TODO: Remove absolute_loss in v1.2.</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"absolute_error", "absolute_loss"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss</span> <span class="relational-operator">==</span> <span class="string-literal">"absolute_loss"</span><span class="punctuation">:</span>
                <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span>
                    <span class="string-literal">"The loss 'absolute_loss' was deprecated in v1.0 and will "</span>
                    <span class="string-literal">"be removed in version 1.2. Use `loss='absolute_error'` "</span>
                    <span class="string-literal">"which is equivalent."</span><span class="punctuation">,</span>
                    <span class="identifier">FutureWarning</span>
                <span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
                <span class="identifier">loss_function</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span> <span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y_true</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">loss_function</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span> <span class="invalid">\</span>
                    <span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y_true</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="comment"># TODO: Remove squared_loss in v1.2.</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"squared_error", "squared_loss"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss</span> <span class="relational-operator">==</span> <span class="string-literal">"squared_loss"</span><span class="punctuation">:</span>
                <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span>
                    <span class="string-literal">"The loss 'squared_loss' was deprecated in v1.0 and will "</span>
                    <span class="string-literal">"be removed in version 1.2. Use `loss='squared_error'` "</span>
                    <span class="string-literal">"which is equivalent."</span><span class="punctuation">,</span>
                    <span class="identifier">FutureWarning</span>
                <span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
                <span class="identifier">loss_function</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span> <span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">y_true</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_pred</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">loss_function</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span> <span class="invalid">\</span>
                    <span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y_true</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_pred</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="keyword">elif</span> <span class="identifier">callable</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">loss_function</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss</span>

        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                <span class="string-literal">"loss should be 'absolute_error', 'squared_error' or a "</span>
                <span class="string-literal">"callable. Got %s. "</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss</span><span class="grouping">)</span>

        <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="grouping">)</span>

        <span class="keyword">try</span><span class="punctuation">:</span>  <span class="comment"># Not all estimator accept a random_state</span>
            <span class="identifier">base_estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="keyword">except</span> <span class="identifier">ValueError</span><span class="punctuation">:</span>
            <span class="keyword">pass</span>

        <span class="identifier">estimator_fit_has_sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">has_fit_parameter</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span>
                                                            <span class="string-literal">"sample_weight"</span><span class="grouping">)</span>
        <span class="identifier">estimator_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__name__</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span>
                <span class="identifier">estimator_fit_has_sample_weight</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"%s does not support sample_weight. Samples"</span>
                             <span class="string-literal">" weights are only used for the calibration"</span>
                             <span class="string-literal">" itself."</span> <span class="arithmetic-operator">%</span> <span class="identifier">estimator_name</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_check_sample_weight</span><span class="grouping">(</span><span class="identifier">sample_weight</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">n_inliers_best</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">score_best</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span>
        <span class="identifier">inlier_mask_best</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">X_inlier_best</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">y_inlier_best</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">inlier_best_idxs_subset</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_no_inliers_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_invalid_data_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_invalid_model_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

        <span class="comment"># number of data samples</span>
        <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">sample_idxs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_trials_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">max_trials</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_trials</span>
        <span class="keyword">while</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_trials_</span> <span class="relational-operator">&lt;</span> <span class="identifier">max_trials</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_trials_</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_no_inliers_</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_invalid_data_</span> <span class="arithmetic-operator">+</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_invalid_model_</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_skips</span><span class="punctuation">:</span>
                <span class="keyword">break</span>

            <span class="comment"># choose random sample set</span>
            <span class="identifier">subset_idxs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_without_replacement</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">min_samples</span><span class="punctuation">,</span>
                                                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
            <span class="identifier">X_subset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">subset_idxs</span><span class="grouping">]</span>
            <span class="identifier">y_subset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">subset_idxs</span><span class="grouping">]</span>

            <span class="comment"># check if random sample set is valid</span>
            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_data_valid</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span>
                    <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_data_valid</span><span class="grouping">(</span><span class="identifier">X_subset</span><span class="punctuation">,</span> <span class="identifier">y_subset</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_invalid_data_</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
                <span class="keyword">continue</span>

            <span class="comment"># fit model for current random sample set</span>
            <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">base_estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_subset</span><span class="punctuation">,</span> <span class="identifier">y_subset</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">base_estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_subset</span><span class="punctuation">,</span> <span class="identifier">y_subset</span><span class="punctuation">,</span>
                                   <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">subset_idxs</span><span class="grouping">]</span><span class="grouping">)</span>

            <span class="comment"># check if estimated model is valid</span>
            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_model_valid</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_model_valid</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">X_subset</span><span class="punctuation">,</span> <span class="identifier">y_subset</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_invalid_model_</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
                <span class="keyword">continue</span>

            <span class="comment"># residuals of all data for current random sample model</span>
            <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">base_estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">residuals_subset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss_function</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>

            <span class="comment"># classify data into inliers and outliers</span>
            <span class="identifier">inlier_mask_subset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">residuals_subset</span> <span class="relational-operator">&lt;</span> <span class="identifier">residual_threshold</span>
            <span class="identifier">n_inliers_subset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">inlier_mask_subset</span><span class="grouping">)</span>

            <span class="comment"># less inliers -&gt; skip current random sample</span>
            <span class="keyword">if</span> <span class="identifier">n_inliers_subset</span> <span class="relational-operator">&lt;</span> <span class="identifier">n_inliers_best</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_no_inliers_</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
                <span class="keyword">continue</span>

            <span class="comment"># extract inlier data set</span>
            <span class="identifier">inlier_idxs_subset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_idxs</span><span class="grouping">[</span><span class="identifier">inlier_mask_subset</span><span class="grouping">]</span>
            <span class="identifier">X_inlier_subset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">inlier_idxs_subset</span><span class="grouping">]</span>
            <span class="identifier">y_inlier_subset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">inlier_idxs_subset</span><span class="grouping">]</span>

            <span class="comment"># score of inlier data set</span>
            <span class="identifier">score_subset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">base_estimator</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_inlier_subset</span><span class="punctuation">,</span>
                                                <span class="identifier">y_inlier_subset</span><span class="grouping">)</span>

            <span class="comment"># same number of inliers but worse score -&gt; skip current random</span>
            <span class="comment"># sample</span>
            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">n_inliers_subset</span> <span class="relational-operator">==</span> <span class="identifier">n_inliers_best</span>
                    <span class="logical-operator">and</span> <span class="identifier">score_subset</span> <span class="relational-operator">&lt;</span> <span class="identifier">score_best</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>

            <span class="comment"># save current random sample as best sample</span>
            <span class="identifier">n_inliers_best</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_inliers_subset</span>
            <span class="identifier">score_best</span> <span class="arithmetic-assignment">=</span> <span class="identifier">score_subset</span>
            <span class="identifier">inlier_mask_best</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inlier_mask_subset</span>
            <span class="identifier">X_inlier_best</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_inlier_subset</span>
            <span class="identifier">y_inlier_best</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_inlier_subset</span>
            <span class="identifier">inlier_best_idxs_subset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inlier_idxs_subset</span>

            <span class="identifier">max_trials</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min</span><span class="grouping">(</span>
                <span class="identifier">max_trials</span><span class="punctuation">,</span>
                <span class="identifier">_dynamic_max_trials</span><span class="grouping">(</span><span class="identifier">n_inliers_best</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="punctuation">,</span>
                                    <span class="identifier">min_samples</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stop_probability</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="comment"># break if sufficient number of inliers or score is reached</span>
            <span class="keyword">if</span> <span class="identifier">n_inliers_best</span> <span class="relational-operator">&gt;=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stop_n_inliers</span> <span class="logical-operator">or</span> <span class="invalid">\</span>
                            <span class="identifier">score_best</span> <span class="relational-operator">&gt;=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stop_score</span><span class="punctuation">:</span>
                <span class="keyword">break</span>

        <span class="comment"># if none of the iterations met the required criteria</span>
        <span class="keyword">if</span> <span class="identifier">inlier_mask_best</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_no_inliers_</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_invalid_data_</span> <span class="arithmetic-operator">+</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_invalid_model_</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_skips</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                    <span class="string-literal">"RANSAC skipped more iterations than `max_skips` without"</span>
                    <span class="string-literal">" finding a valid consensus set. Iterations were skipped"</span>
                    <span class="string-literal">" because each randomly chosen sub-sample failed the"</span>
                    <span class="string-literal">" passing criteria. See estimator attributes for"</span>
                    <span class="string-literal">" diagnostics (n_skips*)."</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                    <span class="string-literal">"RANSAC could not find a valid consensus set. All"</span>
                    <span class="string-literal">" `max_trials` iterations were skipped because each"</span>
                    <span class="string-literal">" randomly chosen sub-sample failed the passing criteria."</span>
                    <span class="string-literal">" See estimator attributes for diagnostics (n_skips*)."</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_no_inliers_</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_invalid_data_</span> <span class="arithmetic-operator">+</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_skips_invalid_model_</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_skips</span><span class="punctuation">:</span>
                <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"RANSAC found a valid consensus set but exited"</span>
                              <span class="string-literal">" early due to skipping more iterations than"</span>
                              <span class="string-literal">" `max_skips`. See estimator attributes for"</span>
                              <span class="string-literal">" diagnostics (n_skips*)."</span><span class="punctuation">,</span>
                              <span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>

        <span class="comment"># estimate final model using all inliers</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">base_estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_inlier_best</span><span class="punctuation">,</span> <span class="identifier">y_inlier_best</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">base_estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span>
                <span class="identifier">X_inlier_best</span><span class="punctuation">,</span>
                <span class="identifier">y_inlier_best</span><span class="punctuation">,</span>
                <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">inlier_best_idxs_subset</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">base_estimator</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">inlier_mask_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inlier_mask_best</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Predict using the estimated model.

        This is a wrapper for `estimator_.predict(X)`.

        Parameters
        ----------
        X : numpy array of shape [n_samples, n_features]

        Returns
        -------
        y : array, shape = [n_samples] or [n_samples, n_targets]
            Returns predicted values.
        """</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator_</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">score</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns the score of the prediction.

        This is a wrapper for `estimator_.score(X, y)`.

        Parameters
        ----------
        X : numpy array or sparse matrix of shape [n_samples, n_features]
            Training data.

        y : array, shape = [n_samples] or [n_samples, n_targets]
            Target values.

        Returns
        -------
        z : float
            Score of the prediction.
        """</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimator_</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_more_tags</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span>
            <span class="string-literal">'_xfail_checks'</span><span class="punctuation">:</span> <span class="grouping">{</span>
                <span class="string-literal">'check_sample_weights_invariance'</span><span class="punctuation">:</span>
                <span class="string-literal">'zero sample_weight is not equivalent to removing samples'</span><span class="punctuation">,</span>
            <span class="grouping">}</span>
        <span class="grouping">}</span>

    </pre>
  </body>
</html>