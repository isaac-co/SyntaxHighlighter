<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
=================================================
Novelty detection with Local Outlier Factor (LOF)
=================================================

The Local Outlier Factor (LOF) algorithm is an unsupervised anomaly detection
method which computes the local density deviation of a given data point with
respect to its neighbors. It considers as outliers the samples that have a
substantially lower density than their neighbors. This example shows how to
use LOF for novelty detection. Note that when LOF is used for novelty
detection you MUST not use predict, decision_function and score_samples on the
training set as this would lead to wrong results. You must only use these
methods on new unseen data (which are not in the training set). See
:ref:`User Guide &lt;outlier_detection&gt;`: for details on the difference between
outlier detection and novelty detection and how to use LOF for outlier
detection.

The number of neighbors considered, (parameter n_neighbors) is typically
set 1) greater than the minimum number of samples a cluster has to contain,
so that other samples can be local outliers relative to this cluster, and 2)
smaller than the maximum number of close by samples that can potentially be
local outliers.
In practice, such informations are generally not available, and taking
n_neighbors=20 appears to work well in general.
"""</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">LocalOutlierFactor</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>

<span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">seed</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>

<span class="identifier">xx</span><span class="punctuation">,</span> <span class="identifier">yy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">meshgrid</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">500</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">500</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="comment"># Generate normal (not abnormal) training observations</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.3</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
<span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">X</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="grouping">]</span>
<span class="comment"># Generate new normal (not abnormal) observations</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.3</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
<span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">X</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="grouping">]</span>
<span class="comment"># Generate some abnormal novel observations</span>
<span class="identifier">X_outliers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="comment"># fit the model for novelty detection (novelty=True)</span>
<span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LocalOutlierFactor</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">novelty</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">contamination</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
<span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
<span class="comment"># DO NOT use predict, decision_function and score_samples on X_train as this</span>
<span class="comment"># would give wrong results but only on new unseen data (not used in X_train),</span>
<span class="comment"># e.g. X_test, X_outliers or the meshgrid</span>
<span class="identifier">y_pred_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
<span class="identifier">y_pred_outliers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_outliers</span><span class="grouping">)</span>
<span class="identifier">n_error_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_pred_test</span><span class="grouping">[</span><span class="identifier">y_pred_test</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">size</span>
<span class="identifier">n_error_outliers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_pred_outliers</span><span class="grouping">[</span><span class="identifier">y_pred_outliers</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">size</span>

<span class="comment"># plot the learned frontier, the points, and the nearest vectors to the plane</span>
<span class="identifier">Z</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">xx</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">yy</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">Z</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Z</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">xx</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Novelty Detection with LOF"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">contourf</span><span class="grouping">(</span><span class="identifier">xx</span><span class="punctuation">,</span> <span class="identifier">yy</span><span class="punctuation">,</span> <span class="identifier">Z</span><span class="punctuation">,</span> <span class="identifier">levels</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="identifier">Z</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">PuBu</span><span class="grouping">)</span>
<span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">contour</span><span class="grouping">(</span><span class="identifier">xx</span><span class="punctuation">,</span> <span class="identifier">yy</span><span class="punctuation">,</span> <span class="identifier">Z</span><span class="punctuation">,</span> <span class="identifier">levels</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">linewidths</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">colors</span><span class="arithmetic-assignment">=</span><span class="string-literal">'darkred'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">contourf</span><span class="grouping">(</span><span class="identifier">xx</span><span class="punctuation">,</span> <span class="identifier">yy</span><span class="punctuation">,</span> <span class="identifier">Z</span><span class="punctuation">,</span> <span class="identifier">levels</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">Z</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">colors</span><span class="arithmetic-assignment">=</span><span class="string-literal">'palevioletred'</span><span class="grouping">)</span>

<span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40</span>
<span class="identifier">b1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">c</span><span class="arithmetic-assignment">=</span><span class="string-literal">'white', s=s, edgecolors='k'</span><span class="grouping">)</span>
<span class="identifier">b2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">c</span><span class="arithmetic-assignment">=</span><span class="string-literal">'blueviolet'</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="identifier">s</span><span class="punctuation">,</span>
                 <span class="identifier">edgecolors</span><span class="arithmetic-assignment">=</span><span class="string-literal">'k'</span><span class="grouping">)</span>
<span class="identifier">c</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">X_outliers</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X_outliers</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">c</span><span class="arithmetic-assignment">=</span><span class="string-literal">'gold'</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="identifier">s</span><span class="punctuation">,</span>
                <span class="identifier">edgecolors</span><span class="arithmetic-assignment">=</span><span class="string-literal">'k'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="grouping">(</span><span class="string-literal">'tight'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlim</span><span class="grouping">(</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylim</span><span class="grouping">(</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">a</span><span class="punctuation">.</span><span class="identifier">collections</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">b1</span><span class="punctuation">,</span> <span class="identifier">b2</span><span class="punctuation">,</span> <span class="identifier">c</span><span class="grouping">]</span><span class="punctuation">,</span>
           <span class="grouping">[</span><span class="string-literal">"learned frontier", "training observations"</span><span class="punctuation">,</span>
            <span class="string-literal">"new regular observations", "new abnormal observations"</span><span class="grouping">]</span><span class="punctuation">,</span>
           <span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"upper left"</span><span class="punctuation">,</span>
           <span class="identifier">prop</span><span class="arithmetic-assignment">=</span><span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">font_manager</span><span class="punctuation">.</span><span class="identifier">FontProperties</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">11</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span>
    <span class="string-literal">"errors novel regular: %d/40 ; errors novel abnormal: %d/40"</span>
    <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">n_error_test</span><span class="punctuation">,</span> <span class="identifier">n_error_outliers</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>