<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Landmarks Editor and Landmarks Mesh viewer for the manual adjustments tool """</span>
<span class="keyword">import</span> <span class="identifier">gettext</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">align</span> <span class="keyword">import</span> <span class="identifier">AlignedFace</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">Editor</span><span class="punctuation">,</span> <span class="identifier">logger</span>

<span class="comment"># LOCALES</span>
<span class="identifier">_LANG</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gettext</span><span class="punctuation">.</span><span class="identifier">translation</span><span class="grouping">(</span><span class="string-literal">"tools.manual", localedir="locales"</span><span class="punctuation">,</span> <span class="identifier">fallback</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_LANG</span><span class="punctuation">.</span><span class="identifier">gettext</span>


<span class="keyword">class</span> <span class="identifier">Landmarks</span><span class="grouping">(</span><span class="identifier">Editor</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" The Landmarks Editor.

    Adjust individual landmark points and re-generate Extract Box.

    Parameters
    ----------
    canvas: :class:`tkinter.Canvas`
        The canvas that holds the image and annotations
    detected_faces: :class:`~tools.manual.detected_faces.DetectedFaces`
        The _detected_faces data for this manual session
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">control_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Landmark Point Editor\nEdit the individual landmark points.\n\n"</span>
                         <span class="string-literal">" - Click and drag individual points to relocate.\n"</span>
                         <span class="string-literal">" - Draw a box to select multiple points to relocate."</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">canvas</span><span class="punctuation">.</span><span class="identifier">create_rectangle</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span>
                                                      <span class="identifier">dash</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                      <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hidden"</span><span class="punctuation">,</span>
                                                      <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="string-literal">"gray"</span><span class="punctuation">,</span>
                                                      <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="string-literal">"blue"</span><span class="punctuation">,</span>
                                                      <span class="identifier">stipple</span><span class="arithmetic-assignment">=</span><span class="string-literal">"gray12"</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="punctuation">,</span> <span class="identifier">control_text</span><span class="grouping">)</span>
        <span class="comment"># Clear selection box on an editor or frame change</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">_tk_action_var</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_reset_selection</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_frame_index</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_reset_selection</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_add_actions</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add the optional action buttons to the viewer. Current actions are Point, Select
        and Zoom. """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_action</span><span class="grouping">(</span><span class="string-literal">"magnify", "zoom", _("Magnify/Demagnify the View"</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="identifier">group</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">hotkey</span><span class="arithmetic-assignment">=</span><span class="string-literal">"M"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_actions</span><span class="grouping">[</span><span class="string-literal">"magnify"]["tk_var"].trace("w"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_toggle_zoom</span><span class="grouping">)</span>

    <span class="comment"># CALLBACKS</span>
    <span class="keyword">def</span> <span class="identifier">_toggle_zoom</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
        <span class="comment">""" Clear any selections when switching mode and perform an update.

        Parameters
        ----------
        args: tuple
            tkinter callback arguments. Required but unused.
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_reset_selection</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_update</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_reset_selection</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
        <span class="comment">""" Reset the selection box and the selected landmark annotations. """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"lm_selected"</span><span class="punctuation">,</span> <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_color</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">dtag</span><span class="grouping">(</span><span class="string-literal">"lm_selected"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_box</span><span class="punctuation">,</span>
                                <span class="identifier">stipple</span><span class="arithmetic-assignment">=</span><span class="string-literal">"gray12"</span><span class="punctuation">,</span>
                                <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="string-literal">"blue"</span><span class="punctuation">,</span>
                                <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="string-literal">"gray"</span><span class="punctuation">,</span>
                                <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hidden"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_box</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">event</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_start</span><span class="grouping">(</span><span class="identifier">event</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">update_annotation</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get the latest Landmarks points and update. """</span>
        <span class="identifier">zoomed_offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_zoomed_roi</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">face</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_iterator</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">face_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">face_index</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span> <span class="keyword">else</span> <span class="identifier">face_idx</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="punctuation">:</span>
                <span class="identifier">aligned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span><span class="punctuation">,</span>
                                      <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"face"</span><span class="punctuation">,</span>
                                      <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_display_dims</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">landmarks</span> <span class="arithmetic-operator">+</span> <span class="identifier">zoomed_offset</span>
                <span class="comment"># Hide all landmarks and only display selected</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"lm_dsp", state="hidden"</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"lm_dsp_face_{}".format(face_index), state="normal"</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scale_to_display</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">lm_idx</span><span class="punctuation">,</span> <span class="identifier">landmark</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">landmarks</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_landmark</span><span class="grouping">(</span><span class="identifier">landmark</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">lm_idx</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_label_landmark</span><span class="grouping">(</span><span class="identifier">landmark</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">lm_idx</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grab_landmark</span><span class="grouping">(</span><span class="identifier">landmark</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">lm_idx</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Updated landmark annotations"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_display_landmark</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">bounding_box</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">landmark_index</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add an individual landmark display annotation to the canvas.

        Parameters
        ----------
        bounding_box: :class:`numpy.ndarray`
            The (left, top), (right, bottom) (x, y) coordinates of the oval bounding box for this
            landmark
        face_index: int
            The index of the face within the current frame
        landmark_index: int
            The index point of this landmark
        """</span>
        <span class="identifier">radius</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_color</span>
        <span class="identifier">bbox</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">bounding_box</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">bounding_box</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">radius</span><span class="punctuation">,</span>
                <span class="identifier">bounding_box</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">bounding_box</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">radius</span><span class="grouping">)</span>
        <span class="identifier">key</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"lm_dsp_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">landmark_index</span><span class="grouping">)</span>
        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="identifier">key</span><span class="punctuation">,</span> <span class="string-literal">"oval"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">bbox</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_label_landmark</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">bounding_box</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">landmark_index</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add a text label for a landmark to the canvas.

        Parameters
        ----------
        bounding_box: :class:`numpy.ndarray`
            The (left, top), (right, bottom) (x, y) coordinates of the oval bounding box for this
            landmark
        face_index: int
            The index of the face within the current frame
        landmark_index: int
            The index point of this landmark
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_active</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">top_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">bounding_box</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">20</span>
        <span class="comment"># NB The text must be visible to be able to get the bounding box, so set to hidden</span>
        <span class="comment"># after the bounding box has been retrieved</span>

        <span class="identifier">keys</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"lm_lbl_{}".format(landmark_index), "lm_lbl_bg_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">landmark_index</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">text_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black", font=("Default"</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">text</span><span class="arithmetic-assignment">=</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">landmark_index</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">bg_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="string-literal">"#ffffea", outline="black"</span><span class="grouping">)</span>

        <span class="identifier">text_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="identifier">keys</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">"text"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">top_left</span><span class="punctuation">,</span> <span class="identifier">text_kwargs</span><span class="grouping">)</span>
        <span class="identifier">bbox</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bbox</span><span class="grouping">(</span><span class="identifier">text_id</span><span class="grouping">)</span>
        <span class="identifier">bbox</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="grouping">]</span>
        <span class="identifier">bg_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="identifier">keys</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">"rectangle"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">bbox</span><span class="punctuation">,</span> <span class="identifier">bg_kwargs</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">tag_lower</span><span class="grouping">(</span><span class="identifier">bg_id</span><span class="punctuation">,</span> <span class="identifier">text_id</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">text_id</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hidden"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">bg_id</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hidden"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_grab_landmark</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">bounding_box</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">landmark_index</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add an individual landmark grab anchor to the canvas.

        Parameters
        ----------
        bounding_box: :class:`numpy.ndarray`
            The (left, top), (right, bottom) (x, y) coordinates of the oval bounding box for this
            landmark
        face_index: int
            The index of the face within the current frame
        landmark_index: int
            The index point of this landmark
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_active</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">radius</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">7</span>
        <span class="identifier">bbox</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">bounding_box</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">bounding_box</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">radius</span><span class="punctuation">,</span>
                <span class="identifier">bounding_box</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">bounding_box</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">radius</span><span class="grouping">)</span>
        <span class="identifier">key</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"lm_grb_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">landmark_index</span><span class="grouping">)</span>
        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="punctuation">,</span>
                      <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="punctuation">,</span>
                      <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                      <span class="identifier">dash</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="identifier">key</span><span class="punctuation">,</span> <span class="string-literal">"oval"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">bbox</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="grouping">)</span>

    <span class="comment"># &lt;&lt; MOUSE HANDLING &gt;&gt;</span>
    <span class="comment"># Mouse cursor display</span>
    <span class="keyword">def</span> <span class="identifier">_update_cursor</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the cursor action.

        Launch the cursor update action for the currently selected edit mode.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The current tkinter mouse event
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_hide_labels</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_cursor_select_mode</span><span class="grouping">(</span><span class="identifier">event</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">objs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_withtag</span><span class="grouping">(</span><span class="string-literal">"lm_grb_face_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">face_index</span><span class="grouping">)</span>
                                             <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span> <span class="keyword">else</span> <span class="string-literal">"lm_grb"</span><span class="grouping">)</span>
            <span class="identifier">item_ids</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_overlapping</span><span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">-</span> <span class="int-literal">6</span><span class="punctuation">,</span>
                                                         <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="int-literal">6</span><span class="punctuation">,</span>
                                                         <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="int-literal">6</span><span class="punctuation">,</span>
                                                         <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">intersection</span><span class="grouping">(</span><span class="identifier">objs</span><span class="grouping">)</span>
            <span class="identifier">bboxes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bbox</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">item_ids</span><span class="grouping">]</span>
            <span class="identifier">item_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">next</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">idx</span> <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">bbox</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">item_ids</span><span class="punctuation">,</span> <span class="identifier">bboxes</span><span class="grouping">)</span>
                            <span class="keyword">if</span> <span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="relational-operator">&lt;=</span> <span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="logical-operator">and</span> <span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="relational-operator">&lt;=</span> <span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="none-literal">None</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">item_id</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_cursor_point_mode</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
                <span class="keyword">return</span>

    <span class="keyword">def</span> <span class="identifier">_hide_labels</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Clear all landmark text labels from display """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"lm_lbl", state="hidden"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"lm_lbl_bg", state="hidden"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"lm_grb", fill="", outline=""</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_cursor_point_mode</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">item_id</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the cursor when the mouse is over an individual landmark's grab anchor. Displays
        the landmark label for the landmark under the cursor. Updates :attr:`_mouse_location` with
        the current cursor position.

        Parameters
        ----------
        item_id: int
            The tkinter canvas object id for the landmark point that the cursor is over
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="punctuation">,</span> <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="string-literal">"yellow"</span><span class="grouping">)</span>
        <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">gettags</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="grouping">)</span>
        <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">next</span><span class="grouping">(</span><span class="identifier">tag</span> <span class="keyword">for</span> <span class="identifier">tag</span> <span class="relational-operator">in</span> <span class="identifier">tags</span> <span class="keyword">if</span> <span class="identifier">tag</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"face_")).split("_"</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">lm_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">next</span><span class="grouping">(</span><span class="identifier">tag</span> <span class="keyword">for</span> <span class="identifier">tag</span> <span class="relational-operator">in</span> <span class="identifier">tags</span> <span class="keyword">if</span> <span class="identifier">tag</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"lm_grb_")).split("_"</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">obj_idx</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">lm_idx</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">"none"</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">prefix</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"lm_lbl_", "lm_lbl_bg_"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">tag</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{}{}_face_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">prefix</span><span class="punctuation">,</span> <span class="identifier">lm_idx</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Displaying: %s tag: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">type</span><span class="grouping">(</span><span class="identifier">tag</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">tag</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">tag</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"normal"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="arithmetic-assignment">=</span> <span class="identifier">obj_idx</span>

    <span class="keyword">def</span> <span class="identifier">_update_cursor_select_mode</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the mouse cursor when in select mode.

        Standard cursor returned when creating a new selection box. Move cursor returned when over
        an existing selection box

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The current tkinter mouse event
        """</span>
        <span class="identifier">bbox</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_box</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="relational-operator">&lt;=</span> <span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="logical-operator">and</span> <span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="relational-operator">&lt;=</span> <span class="identifier">bbox</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fleur"</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="grouping">)</span>

    <span class="comment"># Mouse actions</span>
    <span class="keyword">def</span> <span class="identifier">_drag_start</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" The action to perform when the user starts clicking and dragging the mouse.

        The underlying Detected Face's landmark is updated for the point being edited.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event.
        """</span>
        <span class="identifier">sel_box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_box</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>  <span class="comment"># Point edit mode</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"start_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_callback</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_move_point</span>
        <span class="keyword">elif</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="punctuation">:</span>  <span class="comment"># Initial point selection box</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"start_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_callback</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_select</span>
        <span class="keyword">elif</span> <span class="identifier">sel_box</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="relational-operator">&lt;=</span> <span class="identifier">sel_box</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="logical-operator">and</span> <span class="identifier">sel_box</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="relational-operator">&lt;=</span> <span class="identifier">sel_box</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="comment"># Move point selection box</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"start_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_callback</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_move_selection</span>
        <span class="keyword">else</span><span class="punctuation">:</span>  <span class="comment"># Reset</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_callback</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_reset_selection</span><span class="grouping">(</span><span class="identifier">event</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_drag_stop</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint: disable=unused-argument</span>
        <span class="comment">""" In select mode, call the select mode callback.

        In point mode: trigger a viewport thumbnail update on click + drag release

        If there is drag data, and there are selected points in the drag data then
        trigger the selected points stop code.

        Otherwise reset the selection box and return

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event. Required but unused.
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>  <span class="comment"># Point edit mode</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_det_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="identifier">post_edit_trigger</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span>
                                                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"selected"</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_stop_selected</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"No selected data. Clearing. drag_data: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_reset_selection</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_drag_stop_selected</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Action to perform when mouse drag is stopped in selected points editor mode.

        If there is already a selection, update the viewport thumbnail

        If this is a new selection, then obtain the selected points and track
        """</span>
        <span class="keyword">if</span> <span class="string-literal">"face_index"</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="punctuation">:</span>  <span class="comment"># Selected data has been moved</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_det_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="identifier">post_edit_trigger</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span>
                                                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"face_index"</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="keyword">return</span>

        <span class="comment"># This is a new selection</span>
        <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">landmark_indices</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

        <span class="keyword">for</span> <span class="identifier">item_id</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_withtag</span><span class="grouping">(</span><span class="string-literal">"lm_selected"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">gettags</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="grouping">)</span>
            <span class="identifier">face_idx</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">next</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">tag</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="string-literal">"_"</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
                              <span class="keyword">for</span> <span class="identifier">tag</span> <span class="relational-operator">in</span> <span class="identifier">tags</span> <span class="keyword">if</span> <span class="identifier">tag</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"face_"</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">landmark_indices</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">next</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">tag</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="string-literal">"_"</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
                                         <span class="keyword">for</span> <span class="identifier">tag</span> <span class="relational-operator">in</span> <span class="identifier">tags</span>
                                         <span class="keyword">if</span> <span class="identifier">tag</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"lm_dsp_") and "face"</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">tag</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">face_idx</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Not exactly 1 face in selection. Aborting. Face indices: %s"</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_reset_selection</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="keyword">return</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"face_index"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_idx</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"landmarks"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">landmark_indices</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_box</span><span class="punctuation">,</span> <span class="identifier">stipple</span><span class="arithmetic-assignment">=</span><span class="string-literal">"", fill="", outline="#ffff00"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_snap_selection_to_points</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_snap_selection_to_points</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Snap the selection box to the selected points.

        As the landmarks are calculated and redrawn, the selection box can drift. This is
        particularly true in zoomed mode. The selection box is therefore redrawn to bind just
        outside of the selected points.
        """</span>
        <span class="identifier">all_coords</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="grouping">)</span>
                               <span class="keyword">for</span> <span class="identifier">item_id</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_withtag</span><span class="grouping">(</span><span class="string-literal">"lm_selected"</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">mins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">all_coords</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">maxes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">all_coords</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">box_coords</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">mins</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">mins</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">maxes</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">maxes</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">5</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_box</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">box_coords</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_move_point</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Moves the selected landmark point box and updates the underlying landmark on a point
        drag event.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event.
        """</span>
        <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">lm_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span>
        <span class="identifier">shift_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"start_location"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">shift_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"start_location"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="punctuation">:</span>
            <span class="identifier">scaled_shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">shift_x</span><span class="punctuation">,</span> <span class="identifier">shift_y</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">scaled_shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_from_display</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">shift_x</span><span class="punctuation">,</span> <span class="identifier">shift_y</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">do_offset</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_det_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="identifier">landmark</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span>
                                        <span class="identifier">face_idx</span><span class="punctuation">,</span>
                                        <span class="identifier">lm_idx</span><span class="punctuation">,</span>
                                        <span class="arithmetic-operator">*</span><span class="identifier">scaled_shift</span><span class="punctuation">,</span>
                                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"start_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_select</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Create a selection box on mouse drag event when in "select" mode

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event.
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemcget</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_box</span><span class="punctuation">,</span> <span class="string-literal">"state") == "hidden"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_box</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"normal"</span><span class="grouping">)</span>
        <span class="identifier">coords</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"start_location"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_box</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">coords</span><span class="grouping">)</span>
        <span class="identifier">enclosed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_enclosed</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">coords</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_withtag</span><span class="grouping">(</span><span class="string-literal">"lm_dsp"</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">item_id</span> <span class="relational-operator">in</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">enclosed</span><span class="punctuation">.</span><span class="identifier">intersection</span><span class="grouping">(</span><span class="identifier">landmarks</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">addtag_withtag</span><span class="grouping">(</span><span class="string-literal">"lm_selected"</span><span class="punctuation">,</span> <span class="identifier">item_id</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"lm_selected", outline="#ffff00"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"selected"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>

    <span class="keyword">def</span> <span class="identifier">_move_selection</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Move a selection box and the landmarks contained when in "select" mode and a selection
        box has been drawn. """</span>
        <span class="identifier">shift_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"start_location"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">shift_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"start_location"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="punctuation">:</span>
            <span class="identifier">scaled_shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">shift_x</span><span class="punctuation">,</span> <span class="identifier">shift_y</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">scaled_shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_from_display</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">shift_x</span><span class="punctuation">,</span> <span class="identifier">shift_y</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">do_offset</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">move</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_box</span><span class="punctuation">,</span> <span class="identifier">shift_x</span><span class="punctuation">,</span> <span class="identifier">shift_y</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_det_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="identifier">landmark</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span>
                                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"face_index"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"landmarks"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                        <span class="arithmetic-operator">*</span><span class="identifier">scaled_shift</span><span class="punctuation">,</span>
                                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_snap_selection_to_points</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"start_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">Mesh</span><span class="grouping">(</span><span class="identifier">Editor</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" The Landmarks Mesh Display.

    There are no editing options for Mesh editor. It is purely aesthetic and updated when other
    editors are used.

    Parameters
    ----------
    canvas: :class:`tkinter.Canvas`
        The canvas that holds the image and annotations
    detected_faces: :class:`~tools.manual.detected_faces.DetectedFaces`
        The _detected_faces data for this manual session
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_landmark_mapping</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">mouth_inner</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">60</span><span class="punctuation">,</span> <span class="int-literal">68</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">mouth_outer</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">48</span><span class="punctuation">,</span> <span class="int-literal">60</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">right_eyebrow</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">17</span><span class="punctuation">,</span> <span class="int-literal">22</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">left_eyebrow</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">22</span><span class="punctuation">,</span> <span class="int-literal">27</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">right_eye</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">36</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">left_eye</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">48</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">nose</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">27</span><span class="punctuation">,</span> <span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">jaw</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">17</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">chin</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">update_annotation</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get the latest Landmarks and update the mesh."""</span>
        <span class="identifier">key</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"mesh"</span>
        <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_color</span>
        <span class="identifier">zoomed_offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_zoomed_roi</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">face</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_iterator</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">face_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">face_index</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span> <span class="keyword">else</span> <span class="identifier">face_idx</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="punctuation">:</span>
                <span class="identifier">aligned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span><span class="punctuation">,</span>
                                      <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"face"</span><span class="punctuation">,</span>
                                      <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_display_dims</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">landmarks</span> <span class="arithmetic-operator">+</span> <span class="identifier">zoomed_offset</span>
                <span class="comment"># Hide all meshes and only display selected</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"Mesh", state="hidden"</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"Mesh_face_{}".format(face_index), state="normal"</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scale_to_display</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Drawing Landmarks Mesh: (landmarks: %s, color: %s)"</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">segment</span><span class="punctuation">,</span> <span class="identifier">val</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_landmark_mapping</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">key</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"mesh_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span>
                <span class="identifier">pts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">landmarks</span><span class="grouping">[</span><span class="identifier">val</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span><span class="identifier">val</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">segment</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"right_eye", "left_eye", "mouth_inner", "mouth_outer"</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="punctuation">,</span> <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="identifier">key</span><span class="punctuation">,</span> <span class="string-literal">"polygon"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">pts</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="grouping">)</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="identifier">key</span><span class="punctuation">,</span> <span class="string-literal">"line"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">pts</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># Place mesh as bottom annotation</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">tag_raise</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="string-literal">"main_image"</span><span class="grouping">)</span>

    </pre>
  </body>
</html>