<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Losses and corresponding default initial estimators for gradient boosting
decision trees.
"""</span>

<span class="keyword">from</span> <span class="identifier">abc</span> <span class="keyword">import</span> <span class="identifier">ABCMeta</span>
<span class="keyword">from</span> <span class="identifier">abc</span> <span class="keyword">import</span> <span class="identifier">abstractmethod</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">special</span> <span class="keyword">import</span> <span class="identifier">expit</span><span class="punctuation">,</span> <span class="identifier">logsumexp</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_tree</span> <span class="keyword">import</span> <span class="identifier">TREE_LEAF</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">stats</span> <span class="keyword">import</span> <span class="identifier">_weighted_percentile</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">dummy</span> <span class="keyword">import</span> <span class="identifier">DummyClassifier</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">dummy</span> <span class="keyword">import</span> <span class="identifier">DummyRegressor</span>


<span class="keyword">class</span> <span class="identifier">LossFunction</span><span class="grouping">(</span><span class="identifier">metaclass</span><span class="arithmetic-assignment">=</span><span class="identifier">ABCMeta</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Abstract base class for various loss functions.

    Parameters
    ----------
    n_classes : int
        Number of classes.

    Attributes
    ----------
    K : int
        The number of regression trees to be induced;
        1 for regression and binary classification;
        ``n_classes`` for multi-class classification.
    """</span>

    <span class="identifier">is_multi_class</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_classes</span>

    <span class="keyword">def</span> <span class="identifier">init_estimator</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Default ``init`` estimator for loss function. """</span>
        <span class="keyword">raise</span> <span class="identifier">NotImplementedError</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">abstractmethod</span>
    <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the loss.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            True labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves).

        sample_weight : ndarray of shape (n_samples,), default=None
            Sample weights.
        """</span>

    <span class="punctuation">@</span><span class="identifier">abstractmethod</span>
    <span class="keyword">def</span> <span class="identifier">negative_gradient</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the negative gradient.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            The target labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble at iteration ``i - 1``.
        """</span>

    <span class="keyword">def</span> <span class="identifier">update_terminal_regions</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">residual</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span>
                                <span class="identifier">sample_weight</span><span class="punctuation">,</span> <span class="identifier">sample_mask</span><span class="punctuation">,</span>
                                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Update the terminal regions (=leaves) of the given tree and
        updates the current predictions of the model. Traverses tree
        and invokes template method `_update_terminal_region`.

        Parameters
        ----------
        tree : tree.Tree
            The tree object.
        X : ndarray of shape (n_samples, n_features)
            The data array.
        y : ndarray of shape (n_samples,)
            The target labels.
        residual : ndarray of shape (n_samples,)
            The residuals (usually the negative gradient).
        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble at iteration ``i - 1``.
        sample_weight : ndarray of shape (n_samples,)
            The weight of each sample.
        sample_mask : ndarray of shape (n_samples,)
            The sample mask to be used.
        learning_rate : float, default=0.1
            Learning rate shrinks the contribution of each tree by
             ``learning_rate``.
        k : int, default=0
            The index of the estimator being updated.

        """</span>
        <span class="comment"># compute leaf for each sample in ``X``.</span>
        <span class="identifier">terminal_regions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="comment"># mask all which are not in sample mask.</span>
        <span class="identifier">masked_terminal_regions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">terminal_regions</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">masked_terminal_regions</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">sample_mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>

        <span class="comment"># update each leaf (= perform line search)</span>
        <span class="keyword">for</span> <span class="identifier">leaf</span> <span class="relational-operator">in</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">children_left</span> <span class="relational-operator">==</span> <span class="identifier">TREE_LEAF</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_terminal_region</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">masked_terminal_regions</span><span class="punctuation">,</span>
                                         <span class="identifier">leaf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">residual</span><span class="punctuation">,</span>
                                         <span class="identifier">raw_predictions</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>

        <span class="comment"># update predictions (both in-bag and out-of-bag)</span>
        <span class="identifier">raw_predictions</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="invalid">\</span>
            <span class="identifier">learning_rate</span> <span class="arithmetic-operator">*</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_regions</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">abstractmethod</span>
    <span class="keyword">def</span> <span class="identifier">_update_terminal_region</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">terminal_regions</span><span class="punctuation">,</span> <span class="identifier">leaf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                <span class="identifier">residual</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Template method for updating terminal regions (i.e., leaves)."""</span>

    <span class="punctuation">@</span><span class="identifier">abstractmethod</span>
    <span class="keyword">def</span> <span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Return the initial raw predictions.

        Parameters
        ----------
        X : ndarray of shape (n_samples, n_features)
            The data array.
        estimator : object
            The estimator to use to compute the predictions.

        Returns
        -------
        raw_predictions : ndarray of shape (n_samples, K)
            The initial raw predictions. K is equal to 1 for binary
            classification and regression, and equal to the number of classes
            for multiclass classification. ``raw_predictions`` is casted
            into float64.
        """</span>
        <span class="keyword">pass</span>


<span class="keyword">class</span> <span class="identifier">RegressionLossFunction</span><span class="grouping">(</span><span class="identifier">LossFunction</span><span class="punctuation">,</span> <span class="identifier">metaclass</span><span class="arithmetic-assignment">=</span><span class="identifier">ABCMeta</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Base class for regression loss functions."""</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">check_init_estimator</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Make sure estimator has the required fit and predict methods.

        Parameters
        ----------
        estimator : object
            The init estimator to check.
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="grouping">(</span><span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'fit') and hasattr(estimator, 'predict'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                <span class="string-literal">"The init parameter must be a valid estimator and "</span>
                <span class="string-literal">"support both fit and predict."</span>
            <span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">predictions</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">LeastSquaresError</span><span class="grouping">(</span><span class="identifier">RegressionLossFunction</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Loss function for least squares (LS) estimation.
    Terminal regions do not need to be updated for least squares.

    Parameters
    ----------
    n_classes : int
        Number of classes.
    """</span>

    <span class="keyword">def</span> <span class="identifier">init_estimator</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">DummyRegressor</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'mean'</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the least squares loss.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            True labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves).

        sample_weight : ndarray of shape (n_samples,), default=None
            Sample weights.
        """</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">/</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span>
                <span class="identifier">sample_weight</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">negative_gradient</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute half of the negative gradient.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            The target labels.

        raw_predictions : ndarray of shape (n_samples,)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble at iteration ``i - 1``.
        """</span>
        <span class="keyword">return</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">update_terminal_regions</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">residual</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span>
                                <span class="identifier">sample_weight</span><span class="punctuation">,</span> <span class="identifier">sample_mask</span><span class="punctuation">,</span>
                                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Least squares does not need to update terminal regions.

        But it has to update the predictions.

        Parameters
        ----------
        tree : tree.Tree
            The tree object.
        X : ndarray of shape (n_samples, n_features)
            The data array.
        y : ndarray of shape (n_samples,)
            The target labels.
        residual : ndarray of shape (n_samples,)
            The residuals (usually the negative gradient).
        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble at iteration ``i - 1``.
        sample_weight : ndarray of shape (n,)
            The weight of each sample.
        sample_mask : ndarray of shape (n,)
            The sample mask to be used.
        learning_rate : float, default=0.1
            Learning rate shrinks the contribution of each tree by
             ``learning_rate``.
        k : int, default=0
            The index of the estimator being updated.
        """</span>
        <span class="comment"># update predictions</span>
        <span class="identifier">raw_predictions</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">learning_rate</span> <span class="arithmetic-operator">*</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_terminal_region</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">terminal_regions</span><span class="punctuation">,</span> <span class="identifier">leaf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                <span class="identifier">residual</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">pass</span>


<span class="keyword">class</span> <span class="identifier">LeastAbsoluteError</span><span class="grouping">(</span><span class="identifier">RegressionLossFunction</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Loss function for least absolute deviation (LAD) regression.

    Parameters
    ----------
    n_classes : int
        Number of classes
    """</span>
    <span class="keyword">def</span> <span class="identifier">init_estimator</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">DummyRegressor</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'quantile'</span><span class="punctuation">,</span> <span class="identifier">quantile</span><span class="arithmetic-assignment">=</span><span class="float-literal">.5</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the least absolute error.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            True labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves).

        sample_weight : ndarray of shape (n_samples,), default=None
            Sample weights.
        """</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">/</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span>
                <span class="identifier">sample_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">negative_gradient</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the negative gradient.

        1.0 if y - raw_predictions &gt; 0.0 else -1.0

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            The target labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble at iteration ``i - 1``.
        """</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">raw_predictions</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

    <span class="keyword">def</span> <span class="identifier">_update_terminal_region</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">terminal_regions</span><span class="punctuation">,</span> <span class="identifier">leaf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                <span class="identifier">residual</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""LAD updates terminal regions to median estimates."""</span>
        <span class="identifier">terminal_region</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">terminal_regions</span> <span class="relational-operator">==</span> <span class="identifier">leaf</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
                <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">leaf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weighted_percentile</span><span class="grouping">(</span><span class="identifier">diff</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="punctuation">,</span>
                                                      <span class="identifier">percentile</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">HuberLossFunction</span><span class="grouping">(</span><span class="identifier">RegressionLossFunction</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Huber loss function for robust regression.

    M-Regression proposed in Friedman 2001.

    Parameters
    ----------
    alpha : float, default=0.9
        Percentile at which to extract score.

    References
    ----------
    J. Friedman, Greedy Function Approximation: A Gradient Boosting
    Machine, The Annals of Statistics, Vol. 29, No. 5, 2001.
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.9</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

    <span class="keyword">def</span> <span class="identifier">init_estimator</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">DummyRegressor</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'quantile'</span><span class="punctuation">,</span> <span class="identifier">quantile</span><span class="arithmetic-assignment">=</span><span class="float-literal">.5</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the Huber loss.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            True labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble.

        sample_weight : ndarray of shape (n_samples,), default=None
            Sample weights.
        """</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">raw_predictions</span>
        <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span>
        <span class="keyword">if</span> <span class="identifier">gamma</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">diff</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="int-literal">100</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weighted_percentile</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">diff</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="punctuation">,</span>
                                             <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="int-literal">100</span><span class="grouping">)</span>

        <span class="identifier">gamma_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">diff</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="identifier">gamma</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">sq_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">diff</span><span class="grouping">[</span><span class="identifier">gamma_mask</span><span class="grouping">]</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
            <span class="identifier">lin_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">gamma</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">diff</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">gamma_mask</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
                                       <span class="identifier">gamma</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">sq_loss</span> <span class="arithmetic-operator">+</span> <span class="identifier">lin_loss</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">sq_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">gamma_mask</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span>
                             <span class="identifier">diff</span><span class="grouping">[</span><span class="identifier">gamma_mask</span><span class="grouping">]</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
            <span class="identifier">lin_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">gamma</span> <span class="arithmetic-operator">*</span> <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">gamma_mask</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span>
                              <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">diff</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">gamma_mask</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">gamma</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">sq_loss</span> <span class="arithmetic-operator">+</span> <span class="identifier">lin_loss</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">loss</span>

    <span class="keyword">def</span> <span class="identifier">negative_gradient</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                          <span class="arithmetic-operator">**</span><span class="identifier">kargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the negative gradient.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            The target labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble at iteration ``i - 1``.

        sample_weight : ndarray of shape (n_samples,), default=None
            Sample weights.
        """</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">raw_predictions</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">diff</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="int-literal">100</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weighted_percentile</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">diff</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="punctuation">,</span>
                                         <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="int-literal">100</span><span class="grouping">)</span>
        <span class="identifier">gamma_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">diff</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="identifier">gamma</span>
        <span class="identifier">residual</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
        <span class="identifier">residual</span><span class="grouping">[</span><span class="identifier">gamma_mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diff</span><span class="grouping">[</span><span class="identifier">gamma_mask</span><span class="grouping">]</span>
        <span class="identifier">residual</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">gamma_mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gamma</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">diff</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">gamma_mask</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gamma</span>
        <span class="keyword">return</span> <span class="identifier">residual</span>

    <span class="keyword">def</span> <span class="identifier">_update_terminal_region</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">terminal_regions</span><span class="punctuation">,</span> <span class="identifier">leaf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                <span class="identifier">residual</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">terminal_region</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">terminal_regions</span> <span class="relational-operator">==</span> <span class="identifier">leaf</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span>
        <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
                <span class="arithmetic-operator">-</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">median</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weighted_percentile</span><span class="grouping">(</span><span class="identifier">diff</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="punctuation">,</span> <span class="identifier">percentile</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="grouping">)</span>
        <span class="identifier">diff_minus_median</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diff</span> <span class="arithmetic-operator">-</span> <span class="identifier">median</span>
        <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">leaf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">median</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">diff_minus_median</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">diff_minus_median</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">QuantileLossFunction</span><span class="grouping">(</span><span class="identifier">RegressionLossFunction</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Loss function for quantile regression.

    Quantile regression allows to estimate the percentiles
    of the conditional distribution of the target.

    Parameters
    ----------
    alpha : float, default=0.9
        The percentile.
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.9</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">percentile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="int-literal">100</span>

    <span class="keyword">def</span> <span class="identifier">init_estimator</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">DummyRegressor</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'quantile'</span><span class="punctuation">,</span> <span class="identifier">quantile</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the Quantile loss.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            True labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble.

        sample_weight : ndarray of shape (n_samples,), default=None
            Sample weights.
        """</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">raw_predictions</span>
        <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span>

        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="relational-operator">&gt;</span> <span class="identifier">raw_predictions</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="identifier">diff</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
                    <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">alpha</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">diff</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">mask</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">diff</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
                    <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">alpha</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">sample_weight</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span>
                                         <span class="identifier">diff</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">mask</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">loss</span>

    <span class="keyword">def</span> <span class="identifier">negative_gradient</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the negative gradient.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            The target labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble at iteration ``i - 1``.
        """</span>
        <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="relational-operator">&gt;</span> <span class="identifier">raw_predictions</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="identifier">mask</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">alpha</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="bitwise-operator">~</span><span class="identifier">mask</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_terminal_region</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">terminal_regions</span><span class="punctuation">,</span> <span class="identifier">leaf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                <span class="identifier">residual</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">terminal_region</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">terminal_regions</span> <span class="relational-operator">==</span> <span class="identifier">leaf</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
                <span class="arithmetic-operator">-</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="identifier">val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weighted_percentile</span><span class="grouping">(</span><span class="identifier">diff</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">)</span>
        <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">leaf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">val</span>


<span class="keyword">class</span> <span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">L</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">F</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="grouping">(</span><span class="identifier">LossFunction</span><span class="punctuation">,</span> <span class="identifier">metaclass</span><span class="arithmetic-assignment">=</span><span class="identifier">ABCMeta</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Base class for classification loss functions. """</span>

    <span class="keyword">def</span> <span class="identifier">_raw_prediction_to_proba</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Template method to convert raw predictions into probabilities.

        Parameters
        ----------
        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble.

        Returns
        -------
        probas : ndarray of shape (n_samples, K)
            The predicted probabilities.
        """</span>

    <span class="punctuation">@</span><span class="identifier">abstractmethod</span>
    <span class="keyword">def</span> <span class="identifier">_raw_prediction_to_decision</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Template method to convert raw predictions to decisions.

        Parameters
        ----------
        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble.

        Returns
        -------
        encoded_predictions : ndarray of shape (n_samples, K)
            The predicted encoded labels.
        """</span>

    <span class="keyword">def</span> <span class="identifier">check_init_estimator</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Make sure estimator has fit and predict_proba methods.

        Parameters
        ----------
        estimator : object
            The init estimator to check.
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="grouping">(</span><span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'fit'</span><span class="grouping">)</span> <span class="logical-operator">and</span>
                <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'predict_proba'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                <span class="string-literal">"The init parameter must be a valid estimator "</span>
                <span class="string-literal">"and support both fit and predict_proba."</span>
            <span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">BinomialDeviance</span><span class="grouping">(</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">L</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">F</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Binomial deviance loss function for binary classification.

    Binary classification is a special case; here, we only need to
    fit one tree instead of ``n_classes`` trees.

    Parameters
    ----------
    n_classes : int
        Number of classes.
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">n_classes</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"{0:s} requires 2 classes; got {1:d} class(es)"</span>
                             <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># we only need to fit one tree for binary clf.</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">init_estimator</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># return the most common class, taking into account the samples</span>
        <span class="comment"># weights</span>
        <span class="keyword">return</span> <span class="identifier">DummyClassifier</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prior'</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the deviance (= 2 * negative log-likelihood).

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            True labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble.

        sample_weight : ndarray of shape (n_samples,), default=None
            Sample weights.
        """</span>
        <span class="comment"># logaddexp(0, v) == log(1.0 + exp(v))</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">*</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
                                <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logaddexp</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span> <span class="arithmetic-operator">/</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span>
                <span class="identifier">sample_weight</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">*</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
                                 <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logaddexp</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">negative_gradient</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute half of the negative gradient.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            True labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble at iteration ``i - 1``.
        """</span>
        <span class="keyword">return</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">expit</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_terminal_region</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">terminal_regions</span><span class="punctuation">,</span> <span class="identifier">leaf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                <span class="identifier">residual</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Make a single Newton-Raphson step.

        our node estimate is given by:

            sum(w * (y - prob)) / sum(w * prob * (1 - prob))

        we take advantage that: y - prob = residual
        """</span>
        <span class="identifier">terminal_region</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">terminal_regions</span> <span class="relational-operator">==</span> <span class="identifier">leaf</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">residual</span> <span class="arithmetic-assignment">=</span> <span class="identifier">residual</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="identifier">numerator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">sample_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">residual</span><span class="grouping">)</span>
        <span class="identifier">denominator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">sample_weight</span> <span class="arithmetic-operator">*</span>
                             <span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">residual</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="identifier">residual</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># prevents overflow and division by zero</span>
        <span class="keyword">if</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">denominator</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">1e-150</span><span class="punctuation">:</span>
            <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">leaf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">leaf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">numerator</span> <span class="arithmetic-operator">/</span> <span class="identifier">denominator</span>

    <span class="keyword">def</span> <span class="identifier">_raw_prediction_to_proba</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
        <span class="identifier">proba</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expit</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">proba</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">proba</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">proba</span>

    <span class="keyword">def</span> <span class="identifier">_raw_prediction_to_decision</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_raw_prediction_to_proba</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">proba</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">probas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">proba_pos_class</span> <span class="arithmetic-assignment">=</span> <span class="identifier">probas</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">eps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span>
        <span class="identifier">proba_pos_class</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">proba_pos_class</span><span class="punctuation">,</span> <span class="identifier">eps</span><span class="punctuation">,</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">eps</span><span class="grouping">)</span>
        <span class="comment"># log(x / (1 - x)) is the inverse of the sigmoid (expit) function</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">proba_pos_class</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">proba_pos_class</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">MultinomialDeviance</span><span class="grouping">(</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">L</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">F</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Multinomial deviance loss function for multi-class classification.

    For multi-class classification we need to fit ``n_classes`` trees at
    each stage.

    Parameters
    ----------
    n_classes : int
        Number of classes.
    """</span>

    <span class="identifier">is_multi_class</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">n_classes</span> <span class="relational-operator">&lt;</span> <span class="int-literal">3</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"{0:s} requires more than 2 classes."</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">init_estimator</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">DummyClassifier</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prior'</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the Multinomial deviance.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            True labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble.

        sample_weight : ndarray of shape (n_samples,), default=None
            Sample weights.
        """</span>
        <span class="comment"># create one-hot label encoding</span>
        <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">K</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">K</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">Y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="relational-operator">==</span> <span class="identifier">k</span>

        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">average</span><span class="grouping">(</span>
            <span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">Y</span> <span class="arithmetic-operator">*</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
            <span class="identifier">logsumexp</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span>
        <span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">negative_gradient</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute negative gradient for the ``k``-th class.

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            The target labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble at iteration ``i - 1``.

        k : int, default=0
            The index of the class.
        """</span>
        <span class="keyword">return</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan_to_num</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span>
                                        <span class="identifier">logsumexp</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_terminal_region</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">terminal_regions</span><span class="punctuation">,</span> <span class="identifier">leaf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                <span class="identifier">residual</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Make a single Newton-Raphson step. """</span>
        <span class="identifier">terminal_region</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">terminal_regions</span> <span class="relational-operator">==</span> <span class="identifier">leaf</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">residual</span> <span class="arithmetic-assignment">=</span> <span class="identifier">residual</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="identifier">numerator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">sample_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">residual</span><span class="grouping">)</span>
        <span class="identifier">numerator</span> <span class="arithmetic-assignment">*=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">K</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">K</span>

        <span class="identifier">denominator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">sample_weight</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">residual</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span>
                             <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="identifier">residual</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># prevents overflow and division by zero</span>
        <span class="keyword">if</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">denominator</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">1e-150</span><span class="punctuation">:</span>
            <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">leaf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">leaf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">numerator</span> <span class="arithmetic-operator">/</span> <span class="identifier">denominator</span>

    <span class="keyword">def</span> <span class="identifier">_raw_prediction_to_proba</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan_to_num</span><span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">raw_predictions</span> <span class="arithmetic-operator">-</span>
                   <span class="grouping">(</span><span class="identifier">logsumexp</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_raw_prediction_to_decision</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_raw_prediction_to_proba</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">proba</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">probas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">eps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span>
        <span class="identifier">probas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">probas</span><span class="punctuation">,</span> <span class="identifier">eps</span><span class="punctuation">,</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">eps</span><span class="grouping">)</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">probas</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">raw_predictions</span>


<span class="keyword">class</span> <span class="identifier">ExponentialLoss</span><span class="grouping">(</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">L</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">F</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Exponential loss function for binary classification.

    Same loss as AdaBoost.

    Parameters
    ----------
    n_classes : int
        Number of classes.

    References
    ----------
    Greg Ridgeway, Generalized Boosted Models: A guide to the gbm package, 2007
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">n_classes</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"{0:s} requires 2 classes; got {1:d} class(es)"</span>
                             <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># we only need to fit one tree for binary clf.</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">init_estimator</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">DummyClassifier</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prior'</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the exponential loss

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            True labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble.

        sample_weight : ndarray of shape (n_samples,), default=None
            Sample weights.
        """</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="grouping">(</span><span class="float-literal">1.0</span> <span class="arithmetic-operator">/</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span>
                <span class="identifier">sample_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">negative_gradient</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the residual (= negative gradient).

        Parameters
        ----------
        y : ndarray of shape (n_samples,)
            True labels.

        raw_predictions : ndarray of shape (n_samples, K)
            The raw predictions (i.e. values from the tree leaves) of the
            tree ensemble at iteration ``i - 1``.
        """</span>
        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">y_</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">y_</span> <span class="arithmetic-operator">*</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_terminal_region</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">terminal_regions</span><span class="punctuation">,</span> <span class="identifier">leaf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                <span class="identifier">residual</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">terminal_region</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">terminal_regions</span> <span class="relational-operator">==</span> <span class="identifier">leaf</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">terminal_region</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">.</span>

        <span class="identifier">numerator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">y_</span> <span class="arithmetic-operator">*</span> <span class="identifier">sample_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">y_</span> <span class="arithmetic-operator">*</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">denominator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">sample_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">y_</span> <span class="arithmetic-operator">*</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># prevents overflow and division by zero</span>
        <span class="keyword">if</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">denominator</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">1e-150</span><span class="punctuation">:</span>
            <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">leaf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">leaf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">numerator</span> <span class="arithmetic-operator">/</span> <span class="identifier">denominator</span>

    <span class="keyword">def</span> <span class="identifier">_raw_prediction_to_proba</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
        <span class="identifier">proba</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expit</span><span class="grouping">(</span><span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">proba</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">proba</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">proba</span>

    <span class="keyword">def</span> <span class="identifier">_raw_prediction_to_decision</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">raw_predictions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">get_init_raw_predictions</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">probas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">proba_pos_class</span> <span class="arithmetic-assignment">=</span> <span class="identifier">probas</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">eps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span>
        <span class="identifier">proba_pos_class</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">proba_pos_class</span><span class="punctuation">,</span> <span class="identifier">eps</span><span class="punctuation">,</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">eps</span><span class="grouping">)</span>
        <span class="comment"># according to The Elements of Statistical Learning sec. 10.5, the</span>
        <span class="comment"># minimizer of the exponential loss is .5 * log odds ratio. So this is</span>
        <span class="comment"># the equivalent to .5 * binomial_deviance.get_init_raw_predictions()</span>
        <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">proba_pos_class</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">proba_pos_class</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">raw_predictions</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>


<span class="comment"># TODO: Remove entry 'ls' and 'lad' in version 1.2.</span>
<span class="identifier">LOSS_FUNCTIONS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
    <span class="string-literal">"squared_error"</span><span class="punctuation">:</span> <span class="identifier">LeastSquaresError</span><span class="punctuation">,</span>
    <span class="string-literal">'ls'</span><span class="punctuation">:</span> <span class="identifier">LeastSquaresError</span><span class="punctuation">,</span>
    <span class="string-literal">"absolute_error"</span><span class="punctuation">:</span> <span class="identifier">LeastAbsoluteError</span><span class="punctuation">,</span>
    <span class="string-literal">'lad'</span><span class="punctuation">:</span> <span class="identifier">LeastAbsoluteError</span><span class="punctuation">,</span>
    <span class="string-literal">'huber'</span><span class="punctuation">:</span> <span class="identifier">HuberLossFunction</span><span class="punctuation">,</span>
    <span class="string-literal">'quantile'</span><span class="punctuation">:</span> <span class="identifier">QuantileLossFunction</span><span class="punctuation">,</span>
    <span class="string-literal">'deviance'</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="punctuation">,</span>  <span class="comment"># for both, multinomial and binomial</span>
    <span class="string-literal">'exponential'</span><span class="punctuation">:</span> <span class="identifier">ExponentialLoss</span><span class="punctuation">,</span>
<span class="grouping">}</span>

    </pre>
  </body>
</html>