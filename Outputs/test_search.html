<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Test the search module"""</span>

<span class="keyword">from</span> <span class="identifier">collections</span><span class="punctuation">.</span><span class="identifier">abc</span> <span class="keyword">import</span> <span class="identifier">Iterable</span><span class="punctuation">,</span> <span class="identifier">Sized</span>
<span class="keyword">from</span> <span class="identifier">io</span> <span class="keyword">import</span> <span class="identifier">StringIO</span>
<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">chain</span><span class="punctuation">,</span> <span class="identifier">product</span>
<span class="keyword">from</span> <span class="identifier">functools</span> <span class="keyword">import</span> <span class="identifier">partial</span>
<span class="keyword">import</span> <span class="identifier">pickle</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">from</span> <span class="identifier">types</span> <span class="keyword">import</span> <span class="identifier">GeneratorType</span>
<span class="keyword">import</span> <span class="identifier">re</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">as</span> <span class="identifier">sp</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="punctuation">,</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
    <span class="identifier">ignore_warnings</span><span class="punctuation">,</span>
    <span class="identifier">MinimalClassifier</span><span class="punctuation">,</span>
    <span class="identifier">MinimalRegressor</span><span class="punctuation">,</span>
    <span class="identifier">MinimalTransformer</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_mocking</span> <span class="keyword">import</span> <span class="identifier">CheckingClassifier</span><span class="punctuation">,</span> <span class="identifier">MockDataFrame</span>

<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">stats</span> <span class="keyword">import</span> <span class="identifier">bernoulli</span><span class="punctuation">,</span> <span class="identifier">expon</span><span class="punctuation">,</span> <span class="identifier">uniform</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">M</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">i</span><span class="invalid">n</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">is_classifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">NotFittedError</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_blobs</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_multilabel_classification</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">KFold</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">StratifiedKFold</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">StratifiedShuffleSplit</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">LeaveOneGroupOut</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">LeavePGroupsOut</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GroupKFold</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GroupShuffleSplit</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GridSearchCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">RandomizedSearchCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">ParameterGrid</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">ParameterSampler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span><span class="punctuation">.</span><span class="identifier">_search</span> <span class="keyword">import</span> <span class="identifier">BaseSearchCV</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span><span class="punctuation">.</span><span class="identifier">_validation</span> <span class="keyword">import</span> <span class="identifier">FitFailedWarning</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">LinearSVC</span><span class="punctuation">,</span> <span class="identifier">SVC</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span> <span class="keyword">import</span> <span class="identifier">DecisionTreeRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span> <span class="keyword">import</span> <span class="identifier">DecisionTreeClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">KMeans</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">KernelDensity</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">LocalOutlierFactor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">KNeighborsClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">f1_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">recall_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">accuracy_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">make_scorer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">roc_auc_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">confusion_matrix</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">r2_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">euclidean_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">impute</span> <span class="keyword">import</span> <span class="identifier">SimpleImputer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">Pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">Ridge</span><span class="punctuation">,</span> <span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">HistGradientBoostingClassifier</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span><span class="punctuation">.</span><span class="identifier">tests</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">OneTimeSplitter</span>


<span class="comment"># Neither of the following two estimators inherit from BaseEstimator,</span>
<span class="comment"># to test hyperparameter search on user-defined classifiers.</span>
<span class="keyword">class</span> <span class="identifier">MockClassifier</span><span class="punctuation">:</span>
    <span class="comment">"""Dummy classifier to test the parameter search algorithms"""</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">foo_param</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">foo_param</span> <span class="arithmetic-assignment">=</span> <span class="identifier">foo_param</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">T</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">X</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">foo_param</span>

    <span class="keyword">def</span> <span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">foo_param</span>

    <span class="identifier">predict_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predict</span>
    <span class="identifier">predict_log_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predict</span>
    <span class="identifier">decision_function</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predict</span>

    <span class="keyword">def</span> <span class="identifier">score</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">foo_param</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
        <span class="keyword">return</span> <span class="identifier">score</span>

    <span class="keyword">def</span> <span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">foo_param</span><span class="grouping">}</span>

    <span class="keyword">def</span> <span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">foo_param</span> <span class="arithmetic-assignment">=</span> <span class="identifier">params</span><span class="grouping">[</span><span class="string-literal">'foo_param'</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">self</span>


<span class="keyword">class</span> <span class="identifier">LinearSVCNoScore</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""An LinearSVC classifier that has no score method."""</span>
    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">score</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">AttributeError</span>


<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">m</span><span class="grouping">(</span><span class="identifier">grid</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">assert</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">grid</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="identifier">grid</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">grid</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"klass"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">ParameterGrid</span><span class="punctuation">,</span>
                                   <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">ParameterSampler</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"input, error_type, error_message"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="string-literal">'Parameter .* is not a dict or a list \(0\)'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'foo': [0]}, 0], TypeError, r'Parameter .* is not a dict \(0\)'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'foo'</span><span class="punctuation">:</span> <span class="int-literal">0</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="string-literal">"Parameter.* value is not iterable .*"</span>
      <span class="identifier">r</span><span class="string-literal">"\(key='foo', value=0\)"</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_validate_parameter_input</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">input</span><span class="punctuation">,</span> <span class="identifier">error_type</span><span class="punctuation">,</span> <span class="identifier">error_message</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">error_type</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">input</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_parameter_grid</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="comment"># Test basic properties of ParameterGrid.</span>
    <span class="identifier">params1</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"foo"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">grid1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterGrid</span><span class="grouping">(</span><span class="identifier">params1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">grid1</span><span class="punctuation">,</span> <span class="identifier">Iterable</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">grid1</span><span class="punctuation">,</span> <span class="identifier">Sized</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">grid1</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">m</span><span class="grouping">(</span><span class="identifier">grid1</span><span class="grouping">)</span>

    <span class="identifier">params2</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"foo"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="string-literal">"bar": ["ham", "spam", "eggs"</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">grid2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterGrid</span><span class="grouping">(</span><span class="identifier">params2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">grid2</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">6</span>

    <span class="comment"># loop to assert we can iterate over the grid multiple times</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># tuple + chain transforms {"a": 1, "b": 2} to ("a", 1, "b", 2)</span>
        <span class="identifier">points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">chain</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">p</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">grid2</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">points</span> <span class="relational-operator">==</span>
                <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">"bar", x, "foo"</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
                    <span class="keyword">for</span> <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="identifier">params2</span><span class="grouping">[</span><span class="string-literal">"bar"], params2["foo"</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">m</span><span class="grouping">(</span><span class="identifier">grid2</span><span class="grouping">)</span>

    <span class="comment"># Special case: empty grid (useful to get default estimator settings)</span>
    <span class="identifier">empty</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterGrid</span><span class="grouping">(</span><span class="grouping">{</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">empty</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">empty</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="grouping">{</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">m</span><span class="grouping">(</span><span class="identifier">empty</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">IndexError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">empty</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="identifier">has_empty</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterGrid</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'C': [1, 10]}, {}, {'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">.5</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">has_empty</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">4</span>
    <span class="keyword">assert</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">has_empty</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'C': 1}, {'C': 10}, {}, {'C'</span><span class="punctuation">:</span> <span class="float-literal">.5</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">m</span><span class="grouping">(</span><span class="identifier">has_empty</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the best estimator contains the right value for foo_param</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MockClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="comment"># make sure it selects the smallest parameter in case of ties</span>
    <span class="identifier">old_stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span>
    <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StringIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">old_stdout</span>
    <span class="keyword">assert</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">foo_param</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">"param_foo_param"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Smoke test the score etc:</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Test exception handling on scoring</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">scoring</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'sklearn'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_pipeline_steps</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that parameters that are estimators are cloned before fitting</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'regressor'</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'regressor'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">regressor_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'param_regressor'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">regressor_results</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">regressor_results</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Ridge</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">regressor_results</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'coef_'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">regressor_results</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'coef_'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">regressor_results</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span>
    <span class="keyword">assert</span> <span class="identifier">regressor_results</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span>
    <span class="comment"># check that we didn't modify the parameter grid that was passed</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">param_grid</span><span class="grouping">[</span><span class="string-literal">'regressor'][0], 'coef_'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">param_grid</span><span class="grouping">[</span><span class="string-literal">'regressor'][1], 'coef_'</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"SearchCV"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">GridSearchCV</span><span class="punctuation">,</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_SearchCV_with_fit_params</span><span class="grouping">(</span><span class="identifier">SearchCV</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CheckingClassifier</span><span class="grouping">(</span><span class="identifier">expected_fit_params</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'spam', 'eggs'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">searcher</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SearchCV</span><span class="grouping">(</span>
        <span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">error_score</span><span class="arithmetic-assignment">=</span><span class="string-literal">"raise"</span>
    <span class="grouping">)</span>

    <span class="comment"># The CheckingClassifier generates an assertion error if</span>
    <span class="comment"># a parameter is missing or has length != len(X).</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"Expected fit parameter\(s\) \['eggs'\] not seen."</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">searcher</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">spam</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Fit parameter spam has length 1; expected"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">searcher</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">spam</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">eggs</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">searcher</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">spam</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">eggs</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">test_grid_search_no_score</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test grid-search on classifier that has no score function.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">Cs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span>
    <span class="identifier">clf_no_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVCNoScore</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C': Cs}, scoring='accuracy'</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">grid_search_no_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf_no_score</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="identifier">Cs</span><span class="grouping">}</span><span class="punctuation">,</span>
                                        <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'accuracy'</span><span class="grouping">)</span>
    <span class="comment"># smoketest grid search</span>
    <span class="identifier">grid_search_no_score</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># check that best params are equal</span>
    <span class="keyword">assert</span> <span class="identifier">grid_search_no_score</span><span class="punctuation">.</span><span class="identifier">best_params_</span> <span class="relational-operator">==</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_params_</span>
    <span class="comment"># check that we can call score and that it gives the correct result</span>
    <span class="keyword">assert</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">grid_search_no_score</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># giving no scoring function raises an error</span>
    <span class="identifier">grid_search_no_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf_no_score</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="identifier">Cs</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"no scoring"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">grid_search_no_score</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_score_method</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">flip_y</span><span class="arithmetic-assignment">=</span><span class="float-literal">.2</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">.1</span><span class="grouping">]</span><span class="grouping">}</span>

    <span class="identifier">search_no_scoring</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">search_accuracy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'accuracy'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">search_no_score_method_auc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVCNoScore</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span>
                                              <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'roc_auc'</span>
                                              <span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">search_auc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'roc_auc'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Check warning only occurs in situation where behavior changed:</span>
    <span class="comment"># estimator requires score method to compete with scoring parameter</span>
    <span class="identifier">score_no_scoring</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search_no_scoring</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">score_accuracy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search_accuracy</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">score_no_score_auc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search_no_score_method_auc</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">score_auc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search_auc</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># ensure the test is sane</span>
    <span class="keyword">assert</span> <span class="identifier">score_auc</span> <span class="relational-operator">&lt;</span> <span class="float-literal">1.0</span>
    <span class="keyword">assert</span> <span class="identifier">score_accuracy</span> <span class="relational-operator">&lt;</span> <span class="float-literal">1.0</span>
    <span class="keyword">assert</span> <span class="identifier">score_auc</span> <span class="relational-operator">!=</span> <span class="identifier">score_accuracy</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score_accuracy</span><span class="punctuation">,</span> <span class="identifier">score_no_scoring</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score_auc</span><span class="punctuation">,</span> <span class="identifier">score_no_score_auc</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_groups</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check if ValueError (when groups is None) propagates to GridSearchCV</span>
    <span class="comment"># And also check if groups is correctly passed to the cv object</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">15</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">groups</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span>

    <span class="identifier">group_cvs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">LeaveOneGroupOut</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">LeavePGroupsOut</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">GroupKFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">GroupShuffleSplit</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">error_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"The 'groups' parameter should not be None."</span>
    <span class="keyword">for</span> <span class="identifier">cv</span> <span class="relational-operator">in</span> <span class="identifier">group_cvs</span><span class="punctuation">:</span>
        <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">groups</span><span class="arithmetic-assignment">=</span><span class="identifier">groups</span><span class="grouping">)</span>

    <span class="identifier">non_group_cvs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">StratifiedKFold</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">StratifiedShuffleSplit</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">cv</span> <span class="relational-operator">in</span> <span class="identifier">non_group_cvs</span><span class="punctuation">:</span>
        <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
        <span class="comment"># Should not raise an error</span>
        <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_classes__property</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that classes_ property matches best_estimator_.classes_</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">Cs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span>

    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="identifier">Cs</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">,</span>
                       <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">)</span>

    <span class="comment"># Test that regressors do not have a classes_ attribute</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">Ridge</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'alpha'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">'classes_'</span><span class="grouping">)</span>

    <span class="comment"># Test that the grid searcher has no classes_ attribute before it's fit</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="identifier">Cs</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">'classes_'</span><span class="grouping">)</span>

    <span class="comment"># Test that the grid searcher has no classes_ attribute without a refit</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                               <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="identifier">Cs</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">'classes_'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_trivial_cv_results_attr</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test search over a "grid" with only one point.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MockClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">"cv_results_"</span><span class="grouping">)</span>

    <span class="identifier">random_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">random_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">"cv_results_"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_no_refit</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that GSCV can be used for model selection alone without refitting</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MockClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">scoring</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'accuracy', 'precision'</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span>
            <span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span>
        <span class="grouping">)</span>
        <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">"best_estimator_"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="invalid">\</span>
            <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">"best_index_"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="invalid">\</span>
            <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">"best_params_"</span><span class="grouping">)</span>

        <span class="comment"># Make sure the functions predict/transform etc raise meaningful</span>
        <span class="comment"># error messages</span>
        <span class="keyword">for</span> <span class="identifier">fn_name</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'predict', 'predict_proba', 'predict_log_proba'</span><span class="punctuation">,</span>
                        <span class="string-literal">'transform', 'inverse_transform'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">error_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"refit=False. {fn_name} is available only after "</span>
                         <span class="identifier">f</span><span class="string-literal">"refitting on the best parameters"</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="identifier">fn_name</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Test that an invalid refit param raises appropriate error messages</span>
    <span class="identifier">error_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"For multi-metric scoring, the parameter refit must be set to"</span>
                 <span class="string-literal">" a scorer key"</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">refit</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">""</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="string-literal">'recall', 'accuracy'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">GridSearchCV</span><span class="grouping">(</span>
                <span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="grouping">}</span><span class="punctuation">,</span>
                <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="identifier">refit</span><span class="punctuation">,</span>
                <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'acc': 'accuracy', 'prec': 'precision'</span><span class="grouping">}</span>
            <span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that grid search will capture errors on data with different length</span>
    <span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_one_grid_point</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">param_dict</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"C": [1.0], "kernel": ["rbf"], "gamma"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="grouping">]</span><span class="grouping">}</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">param_dict</span><span class="grouping">)</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"rbf"</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">dual_coef_</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">dual_coef_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_when_param_grid_includes_range</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the best estimator contains the right value for foo_param</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MockClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">foo_param</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_bad_param_grid</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">param_dict</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"C"</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="grouping">)</span>
    <span class="identifier">error_msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"Parameter grid for parameter (C) needs to"</span>
        <span class="string-literal">" be a list or numpy array, but got (&lt;class 'int'&gt;)."</span>
        <span class="string-literal">" Single values need to be wrapped in a list"</span>
        <span class="string-literal">" with one element."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">param_dict</span><span class="grouping">)</span>

    <span class="identifier">param_dict</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"C"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">error_msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"Parameter values for parameter (C) need to be a non-empty sequence."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">param_dict</span><span class="grouping">)</span>

    <span class="identifier">param_dict</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"C": "1,2,3"</span><span class="grouping">}</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="grouping">)</span>
    <span class="identifier">error_msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"Parameter grid for parameter (C) needs to"</span>
        <span class="string-literal">" be a list or numpy array, but got (&lt;class 'str'&gt;)."</span>
        <span class="string-literal">" Single values need to be wrapped in a list"</span>
        <span class="string-literal">" with one element."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">param_dict</span><span class="grouping">)</span>

    <span class="identifier">param_dict</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"C"</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">param_dict</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_sparse</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that grid search works with both dense and sparse matrices</span>
    <span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="int-literal">180</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">C</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">C</span>

    <span class="identifier">X_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tocoo</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="int-literal">180</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">C2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">C</span>

    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="relational-operator">==</span> <span class="identifier">y_pred2</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="float-literal">.9</span>
    <span class="keyword">assert</span> <span class="identifier">C</span> <span class="relational-operator">==</span> <span class="identifier">C2</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_sparse_scoring</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">"f1"</span><span class="grouping">)</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="int-literal">180</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">C</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">C</span>

    <span class="identifier">X_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">"f1"</span><span class="grouping">)</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="int-literal">180</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">C2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">C</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">C</span> <span class="relational-operator">==</span> <span class="identifier">C2</span>
    <span class="comment"># Smoke test the score</span>
    <span class="comment"># np.testing.assert_allclose(f1_score(cv.predict(X_[:180]), y[:180]),</span>
    <span class="comment">#                            cv.score(X_[:180], y[:180]))</span>

    <span class="comment"># test loss where greater is worse</span>
    <span class="keyword">def</span> <span class="identifier">f1_loss</span><span class="grouping">(</span><span class="identifier">y_true_</span><span class="punctuation">,</span> <span class="identifier">y_pred_</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="arithmetic-operator">-</span><span class="identifier">f1_score</span><span class="grouping">(</span><span class="identifier">y_true_</span><span class="punctuation">,</span> <span class="identifier">y_pred_</span><span class="grouping">)</span>
    <span class="identifier">F1Loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">f1_loss</span><span class="punctuation">,</span> <span class="identifier">greater_is_better</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">F1Loss</span><span class="grouping">)</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y_pred3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="int-literal">180</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">C3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">C</span>

    <span class="keyword">assert</span> <span class="identifier">C</span> <span class="relational-operator">==</span> <span class="identifier">C3</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_precomputed_kernel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that grid search works when the input features are given in the</span>
    <span class="comment"># form of a precomputed kernel matrix</span>
    <span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># compute the training kernel matrix corresponding to the linear kernel</span>
    <span class="identifier">K_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">K_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">best_score_</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span>

    <span class="comment"># compute the test kernel matrix</span>
    <span class="identifier">K_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="int-literal">180</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">180</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_</span><span class="grouping">[</span><span class="int-literal">180</span><span class="punctuation">:</span><span class="grouping">]</span>

    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">K_test</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="relational-operator">==</span> <span class="identifier">y_test</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span>

    <span class="comment"># test error is raised when the precomputed kernel is not array-like</span>
    <span class="comment"># or sparse</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">K_train</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_precomputed_kernel_error_nonsquare</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that grid search returns an error with a non-square precomputed</span>
    <span class="comment"># training kernel matrix</span>
    <span class="identifier">K_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">K_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">BrokenClassifier</span><span class="grouping">(</span><span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Broken classifier that cannot be fit twice"""</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parameter</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">parameter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parameter</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">'has_been_fit_'</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">has_been_fit_</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">test_refit</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Regression test for bug in refitting</span>
    <span class="comment"># Simulates re-fitting a broken estimator; this used to break with</span>
    <span class="comment"># sparse SVMs.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">BrokenClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'parameter'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">"precision"</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_refit_callable</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Test refit=callable, which adds flexibility in identifying the
    "best" estimator.
    """</span>
    <span class="keyword">def</span> <span class="identifier">refit_callable</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        A dummy function tests `refit=callable` interface.
        Return the index of a model that has the least
        `mean_test_score`.
        """</span>
        <span class="comment"># Fit a dummy clf with `refit=True` to get a list of keys in</span>
        <span class="comment"># clf.cv_results_.</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                           <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precision'</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="comment"># Ensure that `best_index_ != 0` for this dummy clf</span>
        <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">best_index_</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span>

        <span class="comment"># Assert every key matches those in `cv_results`</span>
        <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">cv_results</span>

        <span class="keyword">return</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'mean_test_score'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">argmin</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                       <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precision'</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="identifier">refit_callable</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">best_index_</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="comment"># Ensure `best_score_` is disabled when using `refit=callable`</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'best_score_'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_refit_callable_invalid_type</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Test implementation catches the errors when 'best_index_' returns an
    invalid result.
    """</span>
    <span class="keyword">def</span> <span class="identifier">refit_callable_invalid_type</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        A dummy function tests when returned 'best_index_' is not integer.
        """</span>
        <span class="keyword">return</span> <span class="none-literal">None</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                       <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precision'</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="identifier">refit_callable_invalid_type</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'best_index_ returned is not an integer'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'out_bound_value'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'search_cv'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">RandomizedSearchCV</span><span class="punctuation">,</span> <span class="identifier">GridSearchCV</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_refit_callable_out_bound</span><span class="grouping">(</span><span class="identifier">out_bound_value</span><span class="punctuation">,</span> <span class="identifier">search_cv</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Test implementation catches the errors when 'best_index_' returns an
    out of bound result.
    """</span>
    <span class="keyword">def</span> <span class="identifier">refit_callable_out_bound</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        A dummy function tests when returned 'best_index_' is out of bounds.
        """</span>
        <span class="keyword">return</span> <span class="identifier">out_bound_value</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search_cv</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                    <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precision'</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="identifier">refit_callable_out_bound</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">IndexError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'best_index_ index out of range'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_refit_callable_multi_metric</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Test refit=callable in multiple metric evaluation setting
    """</span>
    <span class="keyword">def</span> <span class="identifier">refit_callable</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        A dummy function tests `refit=callable` interface.
        Return the index of a model that has the least
        `mean_test_prec`.
        """</span>
        <span class="keyword">assert</span> <span class="string-literal">'mean_test_prec'</span> <span class="relational-operator">in</span> <span class="identifier">cv_results</span>
        <span class="keyword">return</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'mean_test_prec'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">argmin</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">scoring</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'Accuracy': make_scorer(accuracy_score), 'prec': 'precision'</span><span class="grouping">}</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                       <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="identifier">refit_callable</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">best_index_</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="comment"># Ensure `best_score_` is disabled when using `refit=callable`</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'best_score_'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gridsearch_nd</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Pass X as list in GridSearchCV</span>
    <span class="identifier">X_4d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">y_3d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span> <span class="arithmetic-operator">*</span> <span class="int-literal">7</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span>
    <span class="keyword">def</span> <span class="identifier">check_X</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">:</span> <span class="keyword">return</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">def</span> <span class="identifier">check_y</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">:</span> <span class="keyword">return</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CheckingClassifier</span><span class="grouping">(</span>
        <span class="identifier">check_X</span><span class="arithmetic-assignment">=</span><span class="identifier">check_X</span><span class="punctuation">,</span> <span class="identifier">check_y</span><span class="arithmetic-assignment">=</span><span class="identifier">check_y</span><span class="punctuation">,</span> <span class="identifier">methods_to_check</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"fit"</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_4d</span><span class="punctuation">,</span> <span class="identifier">y_3d</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">"cv_results_"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_X_as_list</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Pass X as list in GridSearchCV</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CheckingClassifier</span><span class="grouping">(</span>
        <span class="identifier">check_X</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">methods_to_check</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"fit"</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">"cv_results_"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_y_as_list</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Pass y as list in GridSearchCV</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CheckingClassifier</span><span class="grouping">(</span>
        <span class="identifier">check_y</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">methods_to_check</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"fit"</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">"cv_results_"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">test_pandas_input</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check cross_val_score doesn't destroy pandas dataframe</span>
    <span class="identifier">types</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">MockDataFrame</span><span class="punctuation">,</span> <span class="identifier">MockDataFrame</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="keyword">from</span> <span class="identifier">pandas</span> <span class="keyword">import</span> <span class="identifier">Series</span><span class="punctuation">,</span> <span class="identifier">DataFrame</span>
        <span class="identifier">types</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">DataFrame</span><span class="punctuation">,</span> <span class="identifier">Series</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
        <span class="keyword">pass</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">InputFeatureType</span><span class="punctuation">,</span> <span class="identifier">TargetType</span> <span class="relational-operator">in</span> <span class="identifier">types</span><span class="punctuation">:</span>
        <span class="comment"># X dataframe, y series</span>
        <span class="identifier">X_df</span><span class="punctuation">,</span> <span class="identifier">y_ser</span> <span class="arithmetic-assignment">=</span> <span class="identifier">InputFeatureType</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">TargetType</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">def</span> <span class="identifier">check_df</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">InputFeatureType</span><span class="grouping">)</span>

        <span class="keyword">def</span> <span class="identifier">check_series</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">TargetType</span><span class="grouping">)</span>

        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CheckingClassifier</span><span class="grouping">(</span><span class="identifier">check_X</span><span class="arithmetic-assignment">=</span><span class="identifier">check_df</span><span class="punctuation">,</span> <span class="identifier">check_y</span><span class="arithmetic-assignment">=</span><span class="identifier">check_series</span><span class="grouping">)</span>

        <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
        <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_df</span><span class="punctuation">,</span> <span class="identifier">y_ser</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_df</span><span class="punctuation">,</span> <span class="identifier">y_ser</span><span class="grouping">)</span>
        <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_df</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="string-literal">"cv_results_"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_unsupervised_grid_search</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test grid-search with unsupervised estimator</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">km</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KMeans</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">"random"</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># Multi-metric evaluation unsupervised</span>
    <span class="identifier">scoring</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'adjusted_rand_score', 'fowlkes_mallows_score'</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">refit</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'adjusted_rand_score', 'fowlkes_mallows_score'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">km</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                   <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="identifier">refit</span><span class="grouping">)</span>
        <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="comment"># Both ARI and FMS can find the right number :)</span>
        <span class="keyword">assert</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_params_</span><span class="grouping">[</span><span class="string-literal">"n_clusters"</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>

    <span class="comment"># Single metric evaluation unsupervised</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">km</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                               <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'fowlkes_mallows_score'</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_params_</span><span class="grouping">[</span><span class="string-literal">"n_clusters"</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>

    <span class="comment"># Now without a score, and without y</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">km</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_params_</span><span class="grouping">[</span><span class="string-literal">"n_clusters"</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">4</span>


<span class="keyword">def</span> <span class="identifier">test_gridsearch_no_predict</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test grid-search with an estimator without predict.</span>
    <span class="comment"># slight duplication of a test from KDE</span>
    <span class="keyword">def</span> <span class="identifier">custom_scoring</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="int-literal">42</span> <span class="keyword">if</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">bandwidth</span> <span class="relational-operator">==</span> <span class="float-literal">.1</span> <span class="keyword">else</span> <span class="int-literal">0</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                      <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">KernelDensity</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">bandwidth</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">.01</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">custom_scoring</span><span class="grouping">)</span>
    <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">best_params_</span><span class="grouping">[</span><span class="string-literal">'bandwidth'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="float-literal">.1</span>
    <span class="keyword">assert</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">best_score_</span> <span class="relational-operator">==</span> <span class="int-literal">42</span>


<span class="keyword">def</span> <span class="identifier">test_param_sampler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test basic properties of param sampler</span>
    <span class="identifier">param_distributions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"kernel": ["rbf", "linear"</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="string-literal">"C"</span><span class="punctuation">:</span> <span class="identifier">uniform</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="identifier">sampler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterSampler</span><span class="grouping">(</span><span class="identifier">param_distributions</span><span class="arithmetic-assignment">=</span><span class="identifier">param_distributions</span><span class="punctuation">,</span>
                               <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">samples</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">x</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">sampler</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">samples</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">10</span>
    <span class="keyword">for</span> <span class="identifier">sample</span> <span class="relational-operator">in</span> <span class="identifier">samples</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">sample</span><span class="grouping">[</span><span class="string-literal">"kernel"] in ["rbf", "linear"</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="int-literal">0</span> <span class="relational-operator">&lt;=</span> <span class="identifier">sample</span><span class="grouping">[</span><span class="string-literal">"C"</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">1</span>

    <span class="comment"># test that repeated calls yield identical parameters</span>
    <span class="identifier">param_distributions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"C"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">sampler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterSampler</span><span class="grouping">(</span><span class="identifier">param_distributions</span><span class="arithmetic-assignment">=</span><span class="identifier">param_distributions</span><span class="punctuation">,</span>
                               <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="identifier">x</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">sampler</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="identifier">x</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">sampler</span><span class="grouping">]</span>

    <span class="identifier">param_distributions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"C"</span><span class="punctuation">:</span> <span class="identifier">uniform</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="identifier">sampler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterSampler</span><span class="grouping">(</span><span class="identifier">param_distributions</span><span class="arithmetic-assignment">=</span><span class="identifier">param_distributions</span><span class="punctuation">,</span>
                               <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="identifier">x</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">sampler</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="identifier">x</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">sampler</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">check_cv_results_array_types</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">,</span> <span class="identifier">param_keys</span><span class="punctuation">,</span> <span class="identifier">score_keys</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check if the search `cv_results`'s array are of correct types</span>
    <span class="identifier">cv_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="identifier">param</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ma</span><span class="punctuation">.</span><span class="identifier">MaskedArray</span><span class="grouping">)</span>
               <span class="keyword">for</span> <span class="identifier">param</span> <span class="relational-operator">in</span> <span class="identifier">param_keys</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">object</span> <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">param_keys</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">any</span><span class="grouping">(</span><span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ma</span><span class="punctuation">.</span><span class="identifier">MaskedArray</span><span class="grouping">)</span>
                   <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">score_keys</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>
               <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">score_keys</span> <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">key</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">'rank'</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">scorer_keys</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">scorer_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">multimetric_</span> <span class="keyword">else</span> <span class="grouping">[</span><span class="string-literal">'score'</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">scorer_keys</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'rank_test_%s'</span> <span class="arithmetic-operator">%</span> <span class="identifier">key</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span>


<span class="keyword">def</span> <span class="identifier">check_cv_results_keys</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="punctuation">,</span> <span class="identifier">param_keys</span><span class="punctuation">,</span> <span class="identifier">score_keys</span><span class="punctuation">,</span> <span class="identifier">n_cand</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the search.cv_results_ contains all the required results</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">param_keys</span> <span class="arithmetic-operator">+</span> <span class="identifier">score_keys</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="string-literal">'params'</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_cand</span><span class="punctuation">,</span><span class="grouping">)</span>
               <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">param_keys</span> <span class="arithmetic-operator">+</span> <span class="identifier">score_keys</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_cv_results</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">n_splits</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">n_grid_points</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'rbf'</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
              <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'poly'</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">param_keys</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'param_C', 'param_degree', 'param_gamma', 'param_kernel'</span><span class="grouping">)</span>
    <span class="identifier">score_keys</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'mean_test_score', 'mean_train_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'rank_test_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'split0_test_score', 'split1_test_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'split2_test_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'split0_train_score', 'split1_train_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'split2_train_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'std_test_score', 'std_train_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'mean_fit_time', 'std_fit_time'</span><span class="punctuation">,</span>
                  <span class="string-literal">'mean_score_time', 'std_score_time'</span><span class="grouping">)</span>
    <span class="identifier">n_candidates</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_grid_points</span>

    <span class="identifier">search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="identifier">params</span><span class="punctuation">,</span>
                          <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">cv_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span>
    <span class="comment"># Check if score and timing are reasonable</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'rank_test_score'</span><span class="grouping">]</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">score_keys</span>
            <span class="keyword">if</span> <span class="identifier">k</span> <span class="relational-operator">!=</span> <span class="string-literal">'rank_test_score'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">score_keys</span>
            <span class="keyword">if</span> <span class="string-literal">'time'</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">k</span> <span class="logical-operator">and</span>
            <span class="identifier">k</span> <span class="relational-operator">!=</span> <span class="string-literal">'rank_test_score'</span><span class="grouping">)</span>
    <span class="comment"># Check cv_results structure</span>
    <span class="identifier">check_cv_results_array_types</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">,</span> <span class="identifier">param_keys</span><span class="punctuation">,</span> <span class="identifier">score_keys</span><span class="grouping">)</span>
    <span class="identifier">check_cv_results_keys</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="punctuation">,</span> <span class="identifier">param_keys</span><span class="punctuation">,</span> <span class="identifier">score_keys</span><span class="punctuation">,</span> <span class="identifier">n_candidates</span><span class="grouping">)</span>
    <span class="comment"># Check masking</span>
    <span class="identifier">cv_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span>
    <span class="identifier">n_candidates</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'params'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_C'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="logical-operator">and</span>
                <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_gamma'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="logical-operator">and</span>
                <span class="logical-operator">not</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_degree'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
               <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_candidates</span><span class="grouping">)</span>
               <span class="keyword">if</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_kernel'][i] == 'linear'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="grouping">(</span><span class="logical-operator">not</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_C'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="logical-operator">and</span>
                <span class="logical-operator">not</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_gamma'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="logical-operator">and</span>
                <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_degree'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
               <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_candidates</span><span class="grouping">)</span>
               <span class="keyword">if</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_kernel'][i] == 'rbf'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_random_search_cv_results</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">n_splits</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">n_search_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">30</span>

    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'kernel': ['rbf'], 'C'</span><span class="punctuation">:</span> <span class="identifier">expon</span><span class="grouping">(</span><span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="string-literal">'gamma'</span><span class="punctuation">:</span> <span class="identifier">expon</span><span class="grouping">(</span><span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span>
              <span class="grouping">{</span><span class="string-literal">'kernel': ['poly'], 'degree'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="identifier">param_keys</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'param_C', 'param_degree', 'param_gamma', 'param_kernel'</span><span class="grouping">)</span>
    <span class="identifier">score_keys</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'mean_test_score', 'mean_train_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'rank_test_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'split0_test_score', 'split1_test_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'split2_test_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'split0_train_score', 'split1_train_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'split2_train_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'std_test_score', 'std_train_score'</span><span class="punctuation">,</span>
                  <span class="string-literal">'mean_fit_time', 'std_fit_time'</span><span class="punctuation">,</span>
                  <span class="string-literal">'mean_score_time', 'std_score_time'</span><span class="grouping">)</span>
    <span class="identifier">n_cand</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_search_iter</span>

    <span class="identifier">search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">n_search_iter</span><span class="punctuation">,</span>
                                <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="punctuation">,</span>
                                <span class="identifier">param_distributions</span><span class="arithmetic-assignment">=</span><span class="identifier">params</span><span class="punctuation">,</span>
                                <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">cv_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span>
    <span class="comment"># Check results structure</span>
    <span class="identifier">check_cv_results_array_types</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">,</span> <span class="identifier">param_keys</span><span class="punctuation">,</span> <span class="identifier">score_keys</span><span class="grouping">)</span>
    <span class="identifier">check_cv_results_keys</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="punctuation">,</span> <span class="identifier">param_keys</span><span class="punctuation">,</span> <span class="identifier">score_keys</span><span class="punctuation">,</span> <span class="identifier">n_cand</span><span class="grouping">)</span>
    <span class="identifier">n_candidates</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'params'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_C'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="logical-operator">and</span>
                <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_gamma'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="logical-operator">and</span>
                <span class="logical-operator">not</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_degree'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
               <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_candidates</span><span class="grouping">)</span>
               <span class="keyword">if</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_kernel'][i] == 'linear'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="grouping">(</span><span class="logical-operator">not</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_C'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="logical-operator">and</span>
                <span class="logical-operator">not</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_gamma'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="logical-operator">and</span>
                <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_degree'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
               <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_candidates</span><span class="grouping">)</span>
               <span class="keyword">if</span> <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'param_kernel'][i] == 'rbf'</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"SearchCV, specialized_params"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">GridSearchCV</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'param_grid': {'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">RandomizedSearchCV</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'param_distributions': {'C': [1, 10]}, 'n_iter'</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_search_default_iid</span><span class="grouping">(</span><span class="identifier">SearchCV</span><span class="punctuation">,</span> <span class="identifier">specialized_params</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the IID parameter  TODO: Clearly this test does something else???</span>
    <span class="comment"># noise-free simple 2d-data</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                      <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">80</span><span class="grouping">)</span>
    <span class="comment"># split dataset into two folds that are not iid</span>
    <span class="comment"># first one contains data of all 4 blobs, second only from two.</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="comment"># this leads to perfect classification on one fold and a score of 1/3 on</span>
    <span class="comment"># the other</span>
    <span class="comment"># create "cv" for splits</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="bitwise-operator">~</span><span class="identifier">mask</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">common_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'estimator': SVC(), 'cv'</span><span class="punctuation">:</span> <span class="identifier">cv</span><span class="punctuation">,</span>
                     <span class="string-literal">'return_train_score'</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span>
    <span class="identifier">search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SearchCV</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">common_params</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">specialized_params</span><span class="grouping">)</span>
    <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">test_cv_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'split%d_test_score'</span> <span class="arithmetic-operator">%</span> <span class="identifier">s</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
         <span class="keyword">for</span> <span class="identifier">s</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">n_splits_</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="grouping">)</span>
    <span class="identifier">test_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'mean_test_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">test_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'std_test_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">train_cv_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'split%d_train_score'</span> <span class="arithmetic-operator">%</span> <span class="identifier">s</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
         <span class="keyword">for</span> <span class="identifier">s</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">n_splits_</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="grouping">)</span>
    <span class="identifier">train_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'mean_train_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">train_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'std_train_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'param_C'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="comment"># scores are the same as above</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">test_cv_scores</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">train_cv_scores</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="comment"># Unweighted mean/std is used</span>
    <span class="keyword">assert</span> <span class="identifier">test_mean</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">test_cv_scores</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">test_std</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">test_cv_scores</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># For the train scores, we do not take a weighted mean irrespective of</span>
    <span class="comment"># i.i.d. or not</span>
    <span class="keyword">assert</span> <span class="identifier">train_mean</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">train_std</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_cv_results_multimetric</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">n_splits</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'rbf'</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
              <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'poly'</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">grid_searches</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">scoring</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'accuracy'</span><span class="punctuation">:</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">accuracy_score</span><span class="grouping">)</span><span class="punctuation">,</span>
                     <span class="string-literal">'recall'</span><span class="punctuation">:</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">recall_score</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span>
                    <span class="string-literal">'accuracy', 'recall'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="punctuation">,</span>
                                   <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="identifier">params</span><span class="punctuation">,</span>
                                   <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">grid_searches</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="grouping">)</span>

    <span class="identifier">compare_cv_results_multimetric_with_single</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">grid_searches</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_random_search_cv_results_multimetric</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">n_splits</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">n_search_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">30</span>

    <span class="comment"># Scipy 0.12's stats dists do not accept seed, hence we use param grid</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">base</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">refit</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">random_searches</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">scoring</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">'accuracy', 'recall'), 'accuracy', 'recall'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># If True, for multi-metric pass refit='accuracy'</span>
            <span class="keyword">if</span> <span class="identifier">refit</span><span class="punctuation">:</span>
                <span class="identifier">probability</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
                <span class="identifier">refit</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'accuracy'</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">refit</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">probability</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
            <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">probability</span><span class="arithmetic-assignment">=</span><span class="identifier">probability</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
            <span class="identifier">random_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">n_search_iter</span><span class="punctuation">,</span>
                                               <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="punctuation">,</span>
                                               <span class="identifier">param_distributions</span><span class="arithmetic-assignment">=</span><span class="identifier">params</span><span class="punctuation">,</span>
                                               <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="punctuation">,</span>
                                               <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="identifier">refit</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">random_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">random_searches</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">random_search</span><span class="grouping">)</span>

        <span class="identifier">compare_cv_results_multimetric_with_single</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">random_searches</span><span class="grouping">)</span>
        <span class="identifier">compare_refit_methods_when_refit_with_acc</span><span class="grouping">(</span>
            <span class="identifier">random_searches</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">random_searches</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">compare_cv_results_multimetric_with_single</span><span class="grouping">(</span>
        <span class="identifier">search_multi</span><span class="punctuation">,</span> <span class="identifier">search_acc</span><span class="punctuation">,</span> <span class="identifier">search_rec</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compare multi-metric cv_results with the ensemble of multiple
    single metric cv_results from single metric grid/random search"""</span>

    <span class="keyword">assert</span> <span class="identifier">search_multi</span><span class="punctuation">.</span><span class="identifier">multimetric_</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">search_multi</span><span class="punctuation">.</span><span class="identifier">scorer_</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="grouping">(</span><span class="string-literal">'accuracy', 'recall'</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">cv_results_multi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search_multi</span><span class="punctuation">.</span><span class="identifier">cv_results_</span>
    <span class="identifier">cv_results_acc_rec</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">sub</span><span class="grouping">(</span><span class="string-literal">'_score$', '_accuracy'</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">:</span> <span class="identifier">v</span>
                          <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">search_acc</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="identifier">cv_results_acc_rec</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">{</span><span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">sub</span><span class="grouping">(</span><span class="string-literal">'_score$', '_recall'</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">:</span> <span class="identifier">v</span>
                               <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">search_rec</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>

    <span class="comment"># Check if score and timing are reasonable, also checks if the keys</span>
    <span class="comment"># are present</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">cv_results_multi</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="grouping">(</span>
                    <span class="string-literal">'mean_score_time', 'std_score_time', 'mean_fit_time'</span><span class="punctuation">,</span>
                    <span class="string-literal">'std_fit_time'</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Compare the keys, other than time keys, among multi-metric and</span>
    <span class="comment"># single metric grid search results. np.testing.assert_equal performs a</span>
    <span class="comment"># deep nested comparison of the two cv_results dicts</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">{</span><span class="identifier">k</span><span class="punctuation">:</span> <span class="identifier">v</span> <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">cv_results_multi</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span>
                             <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">k</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="string-literal">'_time'</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span>
                            <span class="grouping">{</span><span class="identifier">k</span><span class="punctuation">:</span> <span class="identifier">v</span> <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">cv_results_acc_rec</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span>
                             <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">k</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="string-literal">'_time'</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">compare_refit_methods_when_refit_with_acc</span><span class="grouping">(</span><span class="identifier">search_multi</span><span class="punctuation">,</span> <span class="identifier">search_acc</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compare refit multi-metric search methods with single metric methods"""</span>
    <span class="keyword">assert</span> <span class="identifier">search_acc</span><span class="punctuation">.</span><span class="identifier">refit</span> <span class="relational-operator">==</span> <span class="identifier">refit</span>
    <span class="keyword">if</span> <span class="identifier">refit</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">search_multi</span><span class="punctuation">.</span><span class="identifier">refit</span> <span class="relational-operator">==</span> <span class="string-literal">'accuracy'</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">search_multi</span><span class="punctuation">.</span><span class="identifier">refit</span>
        <span class="keyword">return</span>  <span class="comment"># search cannot predict/score without refit</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'predict', 'predict_proba', 'predict_log_proba'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">search_multi</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">search_acc</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">search_multi</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">search_acc</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'best_index_', 'best_score_', 'best_params_'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">search_multi</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">search_acc</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'search_cv'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">param_distributions</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'max_depth'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'max_depth'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_search_cv_score_samples_error</span><span class="grouping">(</span><span class="identifier">search_cv</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">search_cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Make sure to error out when underlying estimator does not implement</span>
    <span class="comment"># the method `score_samples`</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"'DecisionTreeClassifier' object has no attribute "</span>
               <span class="string-literal">"'score_samples'"</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">search_cv</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'search_cv'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">LocalOutlierFactor</span><span class="grouping">(</span><span class="identifier">novelty</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">param_distributions</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'n_neighbors'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                       <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">"precision"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">LocalOutlierFactor</span><span class="grouping">(</span><span class="identifier">novelty</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'n_neighbors'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                 <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">"precision"</span><span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_search_cv_score_samples_method</span><span class="grouping">(</span><span class="identifier">search_cv</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Set parameters</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">300</span>
    <span class="identifier">outliers_fraction</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.15</span>
    <span class="identifier">n_outliers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">outliers_fraction</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">n_inliers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_outliers</span>

    <span class="comment"># Create dataset</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_inliers</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                   <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="comment"># Add some noisy points</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span>
                                       <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_outliers</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Define labels to be able to score the estimator with `search_cv`</span>
    <span class="identifier">y_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">y_true</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">n_outliers</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>

    <span class="comment"># Fit on data</span>
    <span class="identifier">search_cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_true</span><span class="grouping">)</span>

    <span class="comment"># Verify that the stand alone estimator yields the same results</span>
    <span class="comment"># as the ones obtained with *SearchCV</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">search_cv</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">search_cv</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_search_cv_results_rank_tie_breaking</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="comment"># The two C values are close enough to give similar models</span>
    <span class="comment"># which would result in a tie of their mean cv-scores</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">1.001</span><span class="punctuation">,</span> <span class="float-literal">0.001</span><span class="grouping">]</span><span class="grouping">}</span>

    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="identifier">param_grid</span><span class="punctuation">,</span>
                               <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">random_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                       <span class="identifier">param_distributions</span><span class="arithmetic-assignment">=</span><span class="identifier">param_grid</span><span class="punctuation">,</span>
                                       <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">search</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">,</span> <span class="identifier">random_search</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">cv_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span>
        <span class="comment"># Check tie breaking strategy -</span>
        <span class="comment"># Check that there is a tie in the mean scores between</span>
        <span class="comment"># candidates 1 and 2 alone</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'mean_test_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'mean_test_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'mean_train_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'mean_train_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'mean_test_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'mean_test_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'mean_train_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="identifier">cv_results</span><span class="grouping">[</span><span class="string-literal">'mean_train_score'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="comment"># 'min' rank should be assigned to the tied candidates</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'rank_test_score'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_search_cv_results_none_param</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">est_parameters</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"random_state"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">est</span> <span class="relational-operator">in</span> <span class="identifier">estimators</span><span class="punctuation">:</span>
        <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">est_parameters</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="punctuation">,</span>
                                   <span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'param_random_state'</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_search_cv_timing</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">svc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">svc</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">error_score</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">svc</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">error_score</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">search</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">gs</span><span class="punctuation">,</span> <span class="identifier">rs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'mean_fit_time', 'std_fit_time'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="comment"># NOTE The precision of time.time in windows is not high</span>
            <span class="comment"># enough for the fit/score times to be non-zero for trivial X and y</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'mean_score_time', 'std_score_time'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span>
            <span class="keyword">assert</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="float-literal">0.0</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">,</span> <span class="string-literal">"refit_time_"</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">refit_time_</span><span class="punctuation">,</span> <span class="identifier">float</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">refit_time_</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_correct_score_results</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that correct scores are used</span>
    <span class="identifier">n_splits</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">Cs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">score</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'f1', 'roc_auc'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="identifier">Cs</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">score</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="grouping">)</span>
        <span class="identifier">cv_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">cv_results_</span>

        <span class="comment"># Test scorer names</span>
        <span class="identifier">result_keys</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">expected_keys</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">"mean_test_score", "rank_test_score"</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                         <span class="identifier">tuple</span><span class="grouping">(</span><span class="string-literal">"split%d_test_score"</span> <span class="arithmetic-operator">%</span> <span class="identifier">cv_i</span>
                               <span class="keyword">for</span> <span class="identifier">cv_i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">in1d</span><span class="grouping">(</span><span class="identifier">expected_keys</span><span class="punctuation">,</span> <span class="identifier">result_keys</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StratifiedKFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="grouping">)</span>
        <span class="identifier">n_splits</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">n_splits_</span>
        <span class="keyword">for</span> <span class="identifier">candidate_i</span><span class="punctuation">,</span> <span class="identifier">C</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">Cs</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="identifier">C</span><span class="grouping">)</span>
            <span class="identifier">cv_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
                <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'split%d_test_score'</span>
                                             <span class="arithmetic-operator">%</span> <span class="identifier">s</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">candidate_i</span><span class="grouping">]</span>
                     <span class="keyword">for</span> <span class="identifier">s</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">train</span><span class="punctuation">,</span> <span class="identifier">test</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">train</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">train</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">score</span> <span class="relational-operator">==</span> <span class="string-literal">"f1"</span><span class="punctuation">:</span>
                    <span class="identifier">correct_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f1_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">elif</span> <span class="identifier">score</span> <span class="relational-operator">==</span> <span class="string-literal">"roc_auc"</span><span class="punctuation">:</span>
                    <span class="identifier">dec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="grouping">)</span>
                    <span class="identifier">correct_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_auc_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dec</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">correct_score</span><span class="punctuation">,</span> <span class="identifier">cv_scores</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pickle</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that a fit search can be pickled</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MockClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">grid_search_pickled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">grid_search_pickled</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">random_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                                       <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">random_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">random_search_pickled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">random_search</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">random_search</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">random_search_pickled</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_with_multioutput_data</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test search with multi-output estimator</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_multilabel_classification</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">est_parameters</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"max_depth"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="comment"># Test with grid search cv</span>
    <span class="keyword">for</span> <span class="identifier">est</span> <span class="relational-operator">in</span> <span class="identifier">estimators</span><span class="punctuation">:</span>
        <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">est_parameters</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
        <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">res_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'params'</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">cand_i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">res_params</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">res_params</span><span class="grouping">[</span><span class="identifier">cand_i</span><span class="grouping">]</span><span class="grouping">)</span>

            <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">train</span><span class="punctuation">,</span> <span class="identifier">test</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">train</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">train</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">correct_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                    <span class="identifier">correct_score</span><span class="punctuation">,</span>
                    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'split%d_test_score'</span> <span class="arithmetic-operator">%</span> <span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">cand_i</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Test with a randomized search</span>
    <span class="keyword">for</span> <span class="identifier">est</span> <span class="relational-operator">in</span> <span class="identifier">estimators</span><span class="punctuation">:</span>
        <span class="identifier">random_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">est_parameters</span><span class="punctuation">,</span>
                                           <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">random_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">res_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'params'</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">cand_i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">res_params</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">res_params</span><span class="grouping">[</span><span class="identifier">cand_i</span><span class="grouping">]</span><span class="grouping">)</span>

            <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">train</span><span class="punctuation">,</span> <span class="identifier">test</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">train</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">train</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">correct_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                    <span class="identifier">correct_score</span><span class="punctuation">,</span>
                    <span class="identifier">random_search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'split%d_test_score'</span>
                                              <span class="arithmetic-operator">%</span> <span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">cand_i</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_predict_proba_disabled</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test predict_proba when disabled on estimator.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">probability</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">gs</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_allows_nans</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test GridSearchCV with SimpleImputer</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'imputer', SimpleImputer(strategy='mean'</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'classifier'</span><span class="punctuation">,</span> <span class="identifier">MockClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">p</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'classifier__foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">FailingClassifier</span><span class="grouping">(</span><span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Classifier that raises a ValueError on fit()"""</span>

    <span class="identifier">FAILING_PARAMETER</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parameter</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">parameter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parameter</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">parameter</span> <span class="relational-operator">==</span> <span class="identifier">FailingClassifier</span><span class="punctuation">.</span><span class="identifier">FAILING_PARAMETER</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Failing classifier failed as required"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">score</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="int-literal">0</span><span class="punctuation">.</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_failing_classifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># GridSearchCV with on_error != 'raise'</span>
    <span class="comment"># Ensures that a warning is raised and score reset where appropriate.</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FailingClassifier</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># refit=False because we only want to check that errors caused by fits</span>
    <span class="comment"># to individual folds will be caught and warnings raised instead. If</span>
    <span class="comment"># refit was done, then an exception would be raised on refit and not</span>
    <span class="comment"># caught by grid_search (expected behavior), and this would cause an</span>
    <span class="comment"># error in this test.</span>
    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'parameter': [0, 1, 2]}], scoring='accuracy'</span><span class="punctuation">,</span>
                      <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">error_score</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="grouping">)</span>
    <span class="identifier">warning_message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"Estimator fit failed. The score on this train-test partition "</span>
        <span class="string-literal">"for these parameters will be set to 0.0.*."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FitFailedWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warning_message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">n_candidates</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'params'</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Ensure that grid scores were set to zero as required for those fits</span>
    <span class="comment"># that are expected to fail.</span>
    <span class="keyword">def</span> <span class="identifier">get_cand_scores</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'split%d_test_score'</span> <span class="arithmetic-operator">%</span> <span class="identifier">s</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span>
                             <span class="keyword">for</span> <span class="identifier">s</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">n_splits_</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">get_cand_scores</span><span class="grouping">(</span><span class="identifier">cand_i</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="float-literal">0.0</span><span class="grouping">)</span>
                <span class="keyword">for</span> <span class="identifier">cand_i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_candidates</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'param_parameter'</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">cand_i</span><span class="grouping">]</span> <span class="relational-operator">==</span>
                <span class="identifier">FailingClassifier</span><span class="punctuation">.</span><span class="identifier">FAILING_PARAMETER</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'parameter': [0, 1, 2]}], scoring='accuracy'</span><span class="punctuation">,</span>
                      <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">error_score</span><span class="arithmetic-assignment">=</span><span class="identifier">float</span><span class="grouping">(</span><span class="string-literal">'nan'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">warning_message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"Estimator fit failed. The score on this train-test partition "</span>
        <span class="string-literal">"for these parameters will be set to nan."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FitFailedWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warning_message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">n_candidates</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'params'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">get_cand_scores</span><span class="grouping">(</span><span class="identifier">cand_i</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
               <span class="keyword">for</span> <span class="identifier">cand_i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_candidates</span><span class="grouping">)</span>
               <span class="keyword">if</span> <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'param_parameter'</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">cand_i</span><span class="grouping">]</span> <span class="relational-operator">==</span>
               <span class="identifier">FailingClassifier</span><span class="punctuation">.</span><span class="identifier">FAILING_PARAMETER</span><span class="grouping">)</span>

    <span class="identifier">ranks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'rank_test_score'</span><span class="grouping">]</span>

    <span class="comment"># Check that succeeded estimators have lower ranks</span>
    <span class="keyword">assert</span> <span class="identifier">ranks</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">2</span> <span class="logical-operator">and</span> <span class="identifier">ranks</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">2</span>
    <span class="comment"># Check that failed estimator has the highest rank</span>
    <span class="keyword">assert</span> <span class="identifier">ranks</span><span class="grouping">[</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">FAILING_PARAMETER</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>
    <span class="keyword">assert</span> <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">best_index_</span> <span class="relational-operator">!=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">FAILING_PARAMETER</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_failing_classifier_raise</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># GridSearchCV with on_error == 'raise' raises the error</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FailingClassifier</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># refit=False because we want to test the behaviour of the grid search part</span>
    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'parameter': [0, 1, 2]}], scoring='accuracy'</span><span class="punctuation">,</span>
                      <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">error_score</span><span class="arithmetic-assignment">=</span><span class="string-literal">'raise'</span><span class="grouping">)</span>

    <span class="comment"># FailingClassifier issues a ValueError so this is what we look for.</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_parameters_sampler_replacement</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># raise warning if n_iter is bigger than total parameter space</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'first': [0, 1], 'second': ['a', 'b', 'c'</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
              <span class="grouping">{</span><span class="string-literal">'third': ['two', 'values'</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="identifier">sampler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterSampler</span><span class="grouping">(</span><span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">9</span><span class="grouping">)</span>
    <span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">9</span>
    <span class="identifier">grid_size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">8</span>
    <span class="identifier">expected_warning</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'The total space of parameters %d is smaller '</span>
                        <span class="string-literal">'than n_iter=%d. Running %d iterations. For '</span>
                        <span class="string-literal">'exhaustive searches, use GridSearchCV.'</span>
                        <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">grid_size</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="punctuation">,</span> <span class="identifier">grid_size</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">expected_warning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">sampler</span><span class="grouping">)</span>

    <span class="comment"># degenerates to GridSearchCV if n_iter the same as grid_size</span>
    <span class="identifier">sampler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterSampler</span><span class="grouping">(</span><span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">8</span><span class="grouping">)</span>
    <span class="identifier">samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">sampler</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">samples</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">8</span>
    <span class="keyword">for</span> <span class="identifier">values</span> <span class="relational-operator">in</span> <span class="identifier">ParameterGrid</span><span class="grouping">(</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">values</span> <span class="relational-operator">in</span> <span class="identifier">samples</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">ParameterSampler</span><span class="grouping">(</span><span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">8</span>

    <span class="comment"># test sampling without replacement in a large grid</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a': range(10), 'b': range(10), 'c'</span><span class="punctuation">:</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="identifier">sampler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterSampler</span><span class="grouping">(</span><span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">99</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">sampler</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">samples</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">99</span>
    <span class="identifier">hashable_samples</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"a%db%dc%d"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">p</span><span class="grouping">[</span><span class="string-literal">'a'], p['b'], p['c'</span><span class="grouping">]</span><span class="grouping">)</span>
                        <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">samples</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">hashable_samples</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">99</span>

    <span class="comment"># doesn't go into infinite loops</span>
    <span class="identifier">params_distribution</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'first': bernoulli(.5), 'second': ['a', 'b', 'c'</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">sampler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterSampler</span><span class="grouping">(</span><span class="identifier">params_distribution</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">sampler</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">samples</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">7</span>


<span class="keyword">def</span> <span class="identifier">test_stochastic_gradient_loss_param</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure the predict_proba works when loss is specified</span>
    <span class="comment"># as one of the parameters in the param_grid.</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'loss': ['log'</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">}</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">24</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'hinge'</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>

    <span class="comment"># When the estimator is not fitted, `predict_proba` is not available as the</span>
    <span class="comment"># loss is 'hinge'.</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Make sure `predict_proba` is not available when setting loss=['hinge']</span>
    <span class="comment"># in param_grid</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'loss': ['hinge'</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">}</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'hinge'</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_search_train_scores_set_to_false</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">6</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_search_cv_splits_consistency</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check if a one time iterable is accepted as a cv parameter.</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">n_splits</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                      <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">OneTimeSplitter</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="punctuation">,</span>
                                         <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">gs2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                       <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">gs2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Give generator as a cv parameter</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="punctuation">,</span>
                            <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">GeneratorType</span><span class="grouping">)</span>
    <span class="identifier">gs3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                       <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">gs3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">gs4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                       <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">gs4</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_pop_time_keys</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'mean_fit_time', 'std_fit_time'</span><span class="punctuation">,</span>
                    <span class="string-literal">'mean_score_time', 'std_score_time'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">cv_results</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="identifier">key</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">cv_results</span>

    <span class="comment"># Check if generators are supported as cv and</span>
    <span class="comment"># that the splits are consistent</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">_pop_time_keys</span><span class="grouping">(</span><span class="identifier">gs3</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">_pop_time_keys</span><span class="grouping">(</span><span class="identifier">gs4</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># OneTimeSplitter is a non-re-entrant cv where split can be called only</span>
    <span class="comment"># once if ``cv.split`` is called once per param setting in GridSearchCV.fit</span>
    <span class="comment"># the 2nd and 3rd parameter will not be evaluated as no train/test indices</span>
    <span class="comment"># will be generated for the 2nd and subsequent cv.split calls.</span>
    <span class="comment"># This is a check to make sure cv.split is not called once per param</span>
    <span class="comment"># setting.</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">{</span><span class="identifier">k</span><span class="punctuation">:</span> <span class="identifier">v</span> <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span>
                             <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">k</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="string-literal">'_time'</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span>
                            <span class="grouping">{</span><span class="identifier">k</span><span class="punctuation">:</span> <span class="identifier">v</span> <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">gs2</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span>
                             <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">k</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="string-literal">'_time'</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>

    <span class="comment"># Check consistency of folds across the parameters</span>
    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                      <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># As the first two param settings (C=0.1) and the next two param</span>
    <span class="comment"># settings (C=0.2) are same, the test and train scores must also be</span>
    <span class="comment"># same as long as the same train/test indices are generated for all</span>
    <span class="comment"># the cv splits, for both param setting</span>
    <span class="keyword">for</span> <span class="identifier">score_type</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'train', 'test'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">per_param_scores</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">}</span>
        <span class="keyword">for</span> <span class="identifier">param_i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">per_param_scores</span><span class="grouping">[</span><span class="identifier">param_i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span>
                <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'split%d_%s_score'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">score_type</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">param_i</span><span class="grouping">]</span>
                <span class="keyword">for</span> <span class="identifier">s</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">per_param_scores</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="identifier">per_param_scores</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">per_param_scores</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="identifier">per_param_scores</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_transform_inverse_transform_round_trip</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MockClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>

    <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_round_trip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_round_trip</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_custom_run_search</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">check_results</span><span class="grouping">(</span><span class="identifier">results</span><span class="punctuation">,</span> <span class="identifier">gscv</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">exp_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gscv</span><span class="punctuation">.</span><span class="identifier">cv_results_</span>
        <span class="keyword">assert</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">results</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">exp_results</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">results</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">k</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="string-literal">'_time'</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># XXX: results['params'] is a list :|</span>
                <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">y</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'O'</span><span class="punctuation">:</span>
                    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">exp_results</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span>
                                       <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Checking '</span> <span class="arithmetic-operator">+</span> <span class="identifier">k</span><span class="grouping">)</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">exp_results</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Checking '</span> <span class="arithmetic-operator">+</span> <span class="identifier">k</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">fit_grid</span><span class="grouping">(</span><span class="identifier">param_grid</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span>
                            <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">class</span> <span class="identifier">CustomSearchCV</span><span class="grouping">(</span><span class="identifier">BaseSearchCV</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>

        <span class="keyword">def</span> <span class="identifier">_run_search</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">evaluate</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">evaluate</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'max_depth': 1}, {'max_depth'</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">check_results</span><span class="grouping">(</span><span class="identifier">results</span><span class="punctuation">,</span> <span class="identifier">fit_grid</span><span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'max_depth'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">evaluate</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'min_samples_split'</span><span class="punctuation">:</span> <span class="int-literal">5</span><span class="grouping">}</span><span class="punctuation">,</span>
                                <span class="grouping">{</span><span class="string-literal">'min_samples_split'</span><span class="punctuation">:</span> <span class="int-literal">10</span><span class="grouping">}</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">check_results</span><span class="grouping">(</span><span class="identifier">results</span><span class="punctuation">,</span> <span class="identifier">fit_grid</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'max_depth'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                                             <span class="grouping">{</span><span class="string-literal">'min_samples_split'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Using regressor to make sure each score differs</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">mycv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CustomSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">gscv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fit_grid</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'max_depth'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                     <span class="grouping">{</span><span class="string-literal">'min_samples_split'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mycv</span><span class="punctuation">.</span><span class="identifier">cv_results_</span>
    <span class="identifier">check_results</span><span class="grouping">(</span><span class="identifier">results</span><span class="punctuation">,</span> <span class="identifier">gscv</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">attr</span> <span class="relational-operator">in</span> <span class="identifier">dir</span><span class="grouping">(</span><span class="identifier">gscv</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">attr</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">islower</span><span class="grouping">(</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">attr</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="string-literal">'_'</span> <span class="logical-operator">and</span>
                <span class="identifier">attr</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">{</span><span class="string-literal">'cv_results_', 'best_estimator_'</span><span class="punctuation">,</span>
                             <span class="string-literal">'refit_time_', 'classes_'</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">gscv</span><span class="punctuation">,</span> <span class="identifier">attr</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">mycv</span><span class="punctuation">,</span> <span class="identifier">attr</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="invalid">\</span>
                <span class="string-literal">"Attribute %s not equal"</span> <span class="arithmetic-operator">%</span> <span class="identifier">attr</span>


<span class="keyword">def</span> <span class="identifier">test__custom_fit_no_run_search</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">class</span> <span class="identifier">NoRunSearchSearchCV</span><span class="grouping">(</span><span class="identifier">BaseSearchCV</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>

        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">groups</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">fit_params</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="comment"># this should not raise any exceptions</span>
    <span class="identifier">NoRunSearchSearchCV</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">class</span> <span class="identifier">BadSearchCV</span><span class="grouping">(</span><span class="identifier">BaseSearchCV</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotImplementedError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"_run_search not implemented."</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># this should raise a NotImplementedError</span>
        <span class="identifier">BadSearchCV</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_empty_cv_iterator_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Use global X, y</span>

    <span class="comment"># create cv</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># pop all of it, this should cause the expected ValueError</span>
    <span class="grouping">[</span><span class="identifier">u</span> <span class="keyword">for</span> <span class="identifier">u</span> <span class="relational-operator">in</span> <span class="identifier">cv</span><span class="grouping">]</span>
    <span class="comment"># cv is empty now</span>

    <span class="identifier">train_size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">Ridge</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'alpha'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="float-literal">1e-2</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                               <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>

    <span class="comment"># assert that this raises an error</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'No fits were performed. '</span>
                             <span class="string-literal">'Was the CV iterator empty\\? '</span>
                             <span class="string-literal">'Were there no candidates\\?'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">train_size</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">train_size</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_random_search_bad_cv</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Use global X, y</span>

    <span class="keyword">class</span> <span class="identifier">BrokenKFold</span><span class="grouping">(</span><span class="identifier">KFold</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">get_n_splits</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="int-literal">1</span>

    <span class="comment"># create bad cv</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BrokenKFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>

    <span class="identifier">train_size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">Ridge</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'alpha'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="float-literal">1e-2</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                               <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>

    <span class="comment"># assert that this raises an error</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cv.split and cv.get_n_splits returned '</span>
                             <span class="string-literal">'inconsistent results. Expected \\d+ '</span>
                             <span class="string-literal">'splits, got \\d+'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">train_size</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">train_size</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"return_train_score"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"SearchCV, specialized_params"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">GridSearchCV</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">"param_grid": {"max_depth"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">RandomizedSearchCV</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">"param_distributions": {"max_depth": [2, 3]}, "n_iter"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_searchcv_raise_warning_with_non_finite_score</span><span class="grouping">(</span>
        <span class="identifier">SearchCV</span><span class="punctuation">,</span> <span class="identifier">specialized_params</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non-regression test for:</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/10529</span>
    <span class="comment"># Check that we raise a UserWarning when a non-finite score is</span>
    <span class="comment"># computed in the SearchCV</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="keyword">class</span> <span class="identifier">FailingScorer</span><span class="punctuation">:</span>
        <span class="comment">"""Scorer that will fail for some split but not all."""</span>

        <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_counts</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

        <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_counts</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_counts</span> <span class="arithmetic-operator">%</span> <span class="int-literal">5</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
            <span class="keyword">return</span> <span class="int-literal">1</span>

    <span class="identifier">grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SearchCV</span><span class="grouping">(</span>
        <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">FailingScorer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
        <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="punctuation">,</span>
        <span class="arithmetic-operator">**</span><span class="identifier">specialized_params</span>
    <span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">warn_msg</span><span class="punctuation">:</span>
        <span class="identifier">grid</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">set_with_warning</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"test", "train"] if return_train_score else ["test"</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">warn_msg</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">set_with_warning</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">msg</span><span class="punctuation">,</span> <span class="identifier">dataset</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">warn_msg</span><span class="punctuation">,</span> <span class="identifier">set_with_warning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"One or more of the {dataset} scores are non-finite"</span> <span class="relational-operator">in</span>
                <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">msg</span><span class="punctuation">.</span><span class="identifier">message</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_callable_multimetric_confusion_matrix</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test callable with many metrics inserts the correct names and metrics</span>
    <span class="comment"># into the search cv object</span>
    <span class="keyword">def</span> <span class="identifier">custom_scorer</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confusion_matrix</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'tn': cm[0, 0], 'fp': cm[0, 1], 'fn': cm[1, 0], 'tp'</span><span class="punctuation">:</span> <span class="identifier">cm</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">custom_scorer</span><span class="punctuation">,</span>
                          <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="string-literal">'fp'</span><span class="grouping">)</span>

    <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">score_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'tn', 'fp', 'fn', 'tp'</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">score_names</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="string-literal">"mean_test_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span>

    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confusion_matrix</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">cm</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_callable_multimetric_same_as_list_of_strings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test callable multimetric is the same as a list of strings</span>
    <span class="keyword">def</span> <span class="identifier">custom_scorer</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'recall'</span><span class="punctuation">:</span> <span class="identifier">recall_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="string-literal">'accuracy'</span><span class="punctuation">:</span> <span class="identifier">accuracy_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">}</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">search_callable</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                                   <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">custom_scorer</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="string-literal">'recall'</span><span class="grouping">)</span>
    <span class="identifier">search_str</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                              <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'recall', 'accuracy'], refit='recall'</span><span class="grouping">)</span>

    <span class="identifier">search_callable</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">search_str</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">search_callable</span><span class="punctuation">.</span><span class="identifier">best_score_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">search_str</span><span class="punctuation">.</span><span class="identifier">best_score_</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">search_callable</span><span class="punctuation">.</span><span class="identifier">best_index_</span> <span class="relational-operator">==</span> <span class="identifier">search_str</span><span class="punctuation">.</span><span class="identifier">best_index_</span>
    <span class="keyword">assert</span> <span class="identifier">search_callable</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">search_str</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_callable_single_metric_same_as_single_string</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Tests callable scorer is the same as scoring with a single string</span>
    <span class="keyword">def</span> <span class="identifier">custom_scorer</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">recall_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">search_callable</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                                   <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">custom_scorer</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">search_str</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                              <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'recall', refit='recall'</span><span class="grouping">)</span>
    <span class="identifier">search_list_str</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                                   <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'recall'], refit='recall'</span><span class="grouping">)</span>
    <span class="identifier">search_callable</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">search_str</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">search_list_str</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">search_callable</span><span class="punctuation">.</span><span class="identifier">best_score_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">search_str</span><span class="punctuation">.</span><span class="identifier">best_score_</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">search_callable</span><span class="punctuation">.</span><span class="identifier">best_index_</span> <span class="relational-operator">==</span> <span class="identifier">search_str</span><span class="punctuation">.</span><span class="identifier">best_index_</span>
    <span class="keyword">assert</span> <span class="identifier">search_callable</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">search_str</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">search_list_str</span><span class="punctuation">.</span><span class="identifier">best_score_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">search_str</span><span class="punctuation">.</span><span class="identifier">best_score_</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">search_list_str</span><span class="punctuation">.</span><span class="identifier">best_index_</span> <span class="relational-operator">==</span> <span class="identifier">search_str</span><span class="punctuation">.</span><span class="identifier">best_index_</span>
    <span class="keyword">assert</span> <span class="identifier">search_list_str</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">search_str</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_callable_multimetric_error_on_invalid_key</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Raises when the callable scorer does not return a dict with `refit` key.</span>
    <span class="keyword">def</span> <span class="identifier">bad_scorer</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'bad_name'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
                       <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">bad_scorer</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="string-literal">'good_name'</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'For multi-metric scoring, the parameter refit must be set to a '</span>
           <span class="string-literal">'scorer key or a callable to refit'</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_callable_multimetric_error_failing_clf</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Warns when there is an estimator the fails to fit with a float</span>
    <span class="comment"># error_score</span>
    <span class="keyword">def</span> <span class="identifier">custom_scorer</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'acc'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FailingClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'parameter'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">custom_scorer</span><span class="punctuation">,</span>
                      <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">error_score</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FitFailedWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Estimator fit failed'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'mean_test_acc'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_callable_multimetric_clf_all_fails</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Warns and raises when all estimator fails to fit.</span>
    <span class="keyword">def</span> <span class="identifier">custom_scorer</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'acc'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FailingClassifier</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'parameter'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">custom_scorer</span><span class="punctuation">,</span>
                      <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">error_score</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FitFailedWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Estimator fit failed'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="invalid">\</span>
            <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="punctuation">,</span>
                          <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"All estimators failed to fit"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_n_features_in</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># make sure grid search and random search delegate n_features_in to the</span>
    <span class="comment"># best estimator</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">gbdt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'max_iter'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">gbdt</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="grouping">)</span>
    <span class="identifier">rs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">gbdt</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">gs</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">rs</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span>
    <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">rs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="identifier">n_features</span>
    <span class="keyword">assert</span> <span class="identifier">rs</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="identifier">n_features</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"pairwise"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_search_cv_pairwise_property_delegated_to_base_estimator</span><span class="grouping">(</span><span class="identifier">pairwise</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Test implementation of BaseSearchCV has the pairwise tag
    which matches the pairwise tag of its estimator.
    This test make sure pairwise tag is delegated to the base estimator.

    Non-regression test for issue #13920.
    """</span>
    <span class="keyword">class</span> <span class="identifier">TestEstimator</span><span class="grouping">(</span><span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">_more_tags</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'pairwise'</span><span class="punctuation">:</span> <span class="identifier">pairwise</span><span class="grouping">}</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TestEstimator</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">attr_message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"BaseSearchCV pairwise tag must match estimator"</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'n_neighbors'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pairwise</span> <span class="relational-operator">==</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">_get_tags</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="string-literal">'pairwise'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">attr_message</span>


<span class="comment"># TODO: Remove in 1.1</span>
<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_search_cv__pairwise_property_delegated_to_base_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Test implementation of BaseSearchCV has the _pairwise property
    which matches the _pairwise property of its estimator.
    This test make sure _pairwise is delegated to the base estimator.

    Non-regression test for issue #13920.
    """</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaseEstimator</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">attr_message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"BaseSearchCV _pairwise property must match estimator"</span>

    <span class="keyword">for</span> <span class="identifier">_pairwise_setting</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">setattr</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="string-literal">'_pairwise'</span><span class="punctuation">,</span> <span class="identifier">_pairwise_setting</span><span class="grouping">)</span>
        <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'n_neighbors'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">_pairwise_setting</span> <span class="relational-operator">==</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">_pairwise</span><span class="punctuation">,</span> <span class="identifier">attr_message</span>


<span class="keyword">def</span> <span class="identifier">test_search_cv_pairwise_property_equivalence_of_precomputed</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Test implementation of BaseSearchCV has the pairwise tag
    which matches the pairwise tag of its estimator.
    This test ensures the equivalence of 'precomputed'.

    Non-regression test for issue #13920.
    """</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span>
    <span class="identifier">n_splits</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">grid_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'n_neighbors'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span>

    <span class="comment"># defaults to euclidean metric (minkowski p = 2)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">grid_params</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="grouping">)</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">preds_original</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># precompute euclidean metric to validate pairwise is working</span>
    <span class="identifier">X_precomputed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">grid_params</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="grouping">)</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_precomputed</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">preds_precomputed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_precomputed</span><span class="grouping">)</span>

    <span class="identifier">attr_message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"GridSearchCV not identical with precomputed metric"</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">preds_original</span> <span class="relational-operator">==</span> <span class="identifier">preds_precomputed</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">attr_message</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"SearchCV, param_search"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">GridSearchCV</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'a'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">RandomizedSearchCV</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'a'</span><span class="punctuation">:</span> <span class="identifier">uniform</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_scalar_fit_param</span><span class="grouping">(</span><span class="identifier">SearchCV</span><span class="punctuation">,</span> <span class="identifier">param_search</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># unofficially sanctioned tolerance for scalar values in fit_params</span>
    <span class="comment"># non-regression test for:</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/15805</span>
    <span class="keyword">class</span> <span class="identifier">TestEstimator</span><span class="grouping">(</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">M</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">i</span><span class="invalid">n</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">a</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">a</span>

        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">r_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span>

        <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SearchCV</span><span class="grouping">(</span><span class="identifier">TestEstimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">param_search</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">r_</span> <span class="relational-operator">==</span> <span class="int-literal">42</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"SearchCV, param_search"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">GridSearchCV</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'alpha'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">RandomizedSearchCV</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'alpha'</span><span class="punctuation">:</span> <span class="identifier">uniform</span><span class="grouping">(</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_scalar_fit_param_compat</span><span class="grouping">(</span><span class="identifier">SearchCV</span><span class="punctuation">,</span> <span class="identifier">param_search</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check support for scalar values in fit_params, for instance in LightGBM</span>
    <span class="comment"># that do not exactly respect the scikit-learn API contract but that we do</span>
    <span class="comment"># not want to break without an explicit deprecation cycle and API</span>
    <span class="comment"># recommendations for implementing early stopping with a user provided</span>
    <span class="comment"># validation set. non-regression test for:</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/15805</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_valid</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_valid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="arithmetic-operator">*</span><span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span>
    <span class="grouping">)</span>

    <span class="keyword">class</span> <span class="identifier">_FitParamClassifier</span><span class="grouping">(</span><span class="identifier">SGDClassifier</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">tuple_of_arrays</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                <span class="identifier">scalar_param</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">callable_param</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">scalar_param</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>
            <span class="keyword">assert</span> <span class="identifier">callable</span><span class="grouping">(</span><span class="identifier">callable_param</span><span class="grouping">)</span>

            <span class="comment"># The tuple of arrays should be preserved as tuple.</span>
            <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">tuple_of_arrays</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">tuple_of_arrays</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
            <span class="keyword">assert</span> <span class="identifier">tuple_of_arrays</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
            <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">_fit_param_callable</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">pass</span>

    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SearchCV</span><span class="grouping">(</span>
        <span class="identifier">_FitParamClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">param_search</span>
    <span class="grouping">)</span>

    <span class="comment"># NOTE: `fit_params` should be data dependent (e.g. `sample_weight`) which</span>
    <span class="comment"># is not the case for the following parameters. But this abuse is common in</span>
    <span class="comment"># popular third-party libraries and we should tolerate this behavior for</span>
    <span class="comment"># now and be careful not to break support for those without following</span>
    <span class="comment"># proper deprecation cycle.</span>
    <span class="identifier">fit_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'tuple_of_arrays'</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">X_valid</span><span class="punctuation">,</span> <span class="identifier">y_valid</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'callable_param'</span><span class="punctuation">:</span> <span class="identifier">_fit_param_callable</span><span class="punctuation">,</span>
        <span class="string-literal">'scalar_param'</span><span class="punctuation">:</span> <span class="int-literal">42</span><span class="punctuation">,</span>
    <span class="grouping">}</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">fit_params</span><span class="grouping">)</span>


<span class="comment"># FIXME: Replace this test with a full `check_estimator` once we have API only</span>
<span class="comment"># checks.</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore:The total space of parameters 4 is"</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"SearchCV"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">GridSearchCV</span><span class="punctuation">,</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"Predictor"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">MinimalRegressor</span><span class="punctuation">,</span> <span class="identifier">MinimalClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_search_cv_using_minimal_compatible_estimator</span><span class="grouping">(</span><span class="identifier">SearchCV</span><span class="punctuation">,</span> <span class="identifier">Predictor</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that third-party library can run tests without inheriting from</span>
    <span class="comment"># BaseEstimator.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">25</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">20</span><span class="grouping">)</span>

    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">"transformer", MinimalTransformer()), ("predictor"</span><span class="punctuation">,</span> <span class="identifier">Predictor</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">"transformer__param": [1, 10], "predictor__parama"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">}</span>
    <span class="identifier">search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SearchCV</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">error_score</span><span class="arithmetic-assignment">=</span><span class="string-literal">"raise"</span><span class="grouping">)</span>
    <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">best_params_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">params</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">is_classifier</span><span class="grouping">(</span><span class="identifier">search</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">accuracy_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">r2_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"return_train_score"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_search_cv_verbose_3</span><span class="grouping">(</span><span class="identifier">capsys</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that search cv with verbose&gt;2 shows the score for single
    metrics. non-regression test fo #19658."""</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">flip_y</span><span class="arithmetic-assignment">=</span><span class="float-literal">.2</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">.1</span><span class="grouping">]</span><span class="grouping">}</span>

    <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'accuracy'</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                 <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">captured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">capsys</span><span class="punctuation">.</span><span class="identifier">readouterr</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">out</span>
    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="punctuation">:</span>
        <span class="identifier">match</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">findall</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"score=\(train=[\d\.]+, test=[\d.]+\)"</span><span class="punctuation">,</span> <span class="identifier">captured</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">match</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">findall</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"score=[\d\.]+"</span><span class="punctuation">,</span> <span class="identifier">captured</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">match</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>

    </pre>
  </body>
</html>