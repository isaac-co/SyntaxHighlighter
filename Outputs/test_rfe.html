<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
Testing Recursive feature elimination
"""</span>

<span class="keyword">from</span> <span class="identifier">operator</span> <span class="keyword">import</span> <span class="identifier">attrgetter</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">sparse</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_selection</span> <span class="keyword">import</span> <span class="identifier">RFE</span><span class="punctuation">,</span> <span class="identifier">RFECV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_iris</span><span class="punctuation">,</span> <span class="identifier">make_friedman1</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">zero_one_loss</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">SVC</span><span class="punctuation">,</span> <span class="identifier">SVR</span><span class="punctuation">,</span> <span class="identifier">LinearSVR</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LogisticRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">RandomForestClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">cross_val_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GroupKFold</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">compose</span> <span class="keyword">import</span> <span class="identifier">TransformedTargetRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">StandardScaler</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">make_scorer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">get_scorer</span>


<span class="keyword">class</span> <span class="identifier">MockClassifier</span><span class="punctuation">:</span>
    <span class="comment">"""
    Dummy classifier to test recursive feature elimination
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">foo_param</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">foo_param</span> <span class="arithmetic-assignment">=</span> <span class="identifier">foo_param</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">coef_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">T</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">predict_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predict</span>
    <span class="identifier">decision_function</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predict</span>
    <span class="identifier">transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predict</span>

    <span class="keyword">def</span> <span class="identifier">score</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="int-literal">0</span><span class="punctuation">.</span>

    <span class="keyword">def</span> <span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'foo_param'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">foo_param</span><span class="grouping">}</span>

    <span class="keyword">def</span> <span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">_more_tags</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">"allow_nan"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span>


<span class="keyword">def</span> <span class="identifier">test_rfe_features_importance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">generator</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">rfe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="identifier">clf_svc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span>
    <span class="identifier">rfe_svc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">clf_svc</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">rfe_svc</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Check if the supports are equal</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">get_support</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">rfe_svc</span><span class="punctuation">.</span><span class="identifier">get_support</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_rfe</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="comment"># dense model</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span>
    <span class="identifier">rfe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_r</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="comment"># sparse model</span>
    <span class="identifier">clf_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span>
    <span class="identifier">rfe_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">clf_sparse</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">rfe_sparse</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_r_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfe_sparse</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">X_r</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_r</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_r</span><span class="punctuation">,</span> <span class="identifier">X_r_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"n_features_to_select"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">2.1</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_rfe_invalid_n_features_errors</span><span class="grouping">(</span><span class="identifier">n_features_to_select</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span>

    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">rfe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features_to_select</span><span class="punctuation">,</span>
              <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="string-literal">"n_features_to_select must be .+ Got {n_features_to_select}"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_rfe_percent_n_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that the results are the same</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="comment"># there are 10 features in the data. We select 40%.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span>
    <span class="identifier">rfe_num</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">rfe_num</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">rfe_perc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.4</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">rfe_perc</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rfe_perc</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="punctuation">,</span> <span class="identifier">rfe_num</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rfe_perc</span><span class="punctuation">.</span><span class="identifier">support_</span><span class="punctuation">,</span> <span class="identifier">rfe_num</span><span class="punctuation">.</span><span class="identifier">support_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_rfe_mockclassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="comment"># dense model</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MockClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">rfe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_r</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">X_r</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span>


<span class="keyword">def</span> <span class="identifier">test_rfecv</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>   <span class="comment"># regression test: list should be supported</span>

    <span class="comment"># Test using the score function</span>
    <span class="identifier">rfecv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># non-regression test for missing worst feature:</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">grid_scores_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">X_r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># All the noisy variable were filtered out</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_r</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="comment"># same in sparse</span>
    <span class="identifier">rfecv_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">rfecv_sparse</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_r_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfecv_sparse</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_r_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="comment"># Test using a customized loss function</span>
    <span class="identifier">scoring</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">zero_one_loss</span><span class="punctuation">,</span> <span class="identifier">greater_is_better</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">rfecv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="grouping">)</span>
    <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_r</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="comment"># Test using a scorer</span>
    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'accuracy'</span><span class="grouping">)</span>
    <span class="identifier">rfecv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scorer</span><span class="grouping">)</span>
    <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_r</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="comment"># Test fix on grid_scores</span>
    <span class="keyword">def</span> <span class="identifier">test_scorer</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="float-literal">1.0</span>
    <span class="identifier">rfecv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">test_scorer</span><span class="grouping">)</span>
    <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">grid_scores_</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">grid_scores_</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># In the event of cross validation score ties, the expected behavior of</span>
    <span class="comment"># RFECV is to return the FEWEST features that maximize the CV score.</span>
    <span class="comment"># Because test_scorer always returns 1.0 in this example, RFECV should</span>
    <span class="comment"># reduce the dimensionality to a single feature (i.e. n_features_ = 1)</span>
    <span class="keyword">assert</span> <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">n_features_</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

    <span class="comment"># Same as the first two tests, but with step=2</span>
    <span class="identifier">rfecv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">grid_scores_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">6</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">X_r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_r</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="identifier">rfecv_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">rfecv_sparse</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_r_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfecv_sparse</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_r_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="comment"># Verifying that steps &lt; 1 don't blow up.</span>
    <span class="identifier">rfecv_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="float-literal">.2</span><span class="grouping">)</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">rfecv_sparse</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_r_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfecv_sparse</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_r_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_rfecv_mockclassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>   <span class="comment"># regression test: list should be supported</span>

    <span class="comment"># Test using the score function</span>
    <span class="identifier">rfecv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">MockClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># non-regression test for missing worst feature:</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">grid_scores_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_rfecv_verbose_output</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check verbose=1 is producing an output.</span>
    <span class="keyword">from</span> <span class="identifier">io</span> <span class="keyword">import</span> <span class="identifier">StringIO</span>
    <span class="keyword">import</span> <span class="identifier">sys</span>
    <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StringIO</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>

    <span class="identifier">rfecv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">verbose_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span>
    <span class="identifier">verbose_output</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">verbose_output</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>


<span class="keyword">def</span> <span class="identifier">test_rfecv_grid_scores_size</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>   <span class="comment"># regression test: list should be supported</span>

    <span class="comment"># Non-regression test for varying combinations of step and</span>
    <span class="comment"># min_features_to_select.</span>
    <span class="keyword">for</span> <span class="identifier">step</span><span class="punctuation">,</span> <span class="identifier">min_features_to_select</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">rfecv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">MockClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="identifier">step</span><span class="punctuation">,</span>
                      <span class="identifier">min_features_to_select</span><span class="arithmetic-assignment">=</span><span class="identifier">min_features_to_select</span><span class="grouping">)</span>
        <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">score_len</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ceil</span><span class="grouping">(</span>
            <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">min_features_to_select</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">step</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">grid_scores_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">score_len</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">n_features_</span> <span class="relational-operator">&gt;=</span> <span class="identifier">min_features_to_select</span>


<span class="keyword">def</span> <span class="identifier">test_rfe_estimator_tags</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rfe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">'linear'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">_estimator_type</span> <span class="relational-operator">==</span> <span class="string-literal">"classifier"</span>
    <span class="comment"># make sure that cross-validation is stratified</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">rfe</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">.7</span>


<span class="keyword">def</span> <span class="identifier">test_rfe_min_step</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_friedman1</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVR</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span>

    <span class="comment"># Test when floor(step * n_features) &lt;= 0</span>
    <span class="identifier">selector</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span>
    <span class="identifier">sel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">selector</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sel</span><span class="punctuation">.</span><span class="identifier">support_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>

    <span class="comment"># Test when step is between (0,1) and floor(step * n_features) &gt; 0</span>
    <span class="identifier">selector</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.20</span><span class="grouping">)</span>
    <span class="identifier">sel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">selector</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sel</span><span class="punctuation">.</span><span class="identifier">support_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>

    <span class="comment"># Test when step is an integer</span>
    <span class="identifier">selector</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">sel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">selector</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sel</span><span class="punctuation">.</span><span class="identifier">support_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>


<span class="keyword">def</span> <span class="identifier">test_number_of_subsets_of_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># In RFE, 'number_of_subsets_of_features'</span>
    <span class="comment"># = the number of iterations in '_fit'</span>
    <span class="comment"># = max(ranking_)</span>
    <span class="comment"># = 1 + (n_features + step - n_features_to_select - 1) // step</span>
    <span class="comment"># After optimization #4534, this number</span>
    <span class="comment"># = 1 + np.ceil((n_features - n_features_to_select) / float(step))</span>
    <span class="comment"># This test case is to test their equivalence, refer to #4534 and #3824</span>

    <span class="keyword">def</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">a</span><span class="int-literal">1</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="identifier">step</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_features_to_select</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="identifier">step</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">a</span><span class="int-literal">2</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ceil</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_features</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_features_to_select</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">step</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># RFE</span>
    <span class="comment"># Case 1, n_features - n_features_to_select is divisible by step</span>
    <span class="comment"># Case 2, n_features - n_features_to_select is not divisible by step</span>
    <span class="identifier">n_features_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">]</span>
    <span class="identifier">n_features_to_select_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">step_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="punctuation">,</span> <span class="identifier">step</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span>
            <span class="identifier">n_features_list</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select_list</span><span class="punctuation">,</span> <span class="identifier">step_list</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">43</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">rfe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="identifier">n_features_to_select</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features_to_select</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="identifier">step</span><span class="grouping">)</span>
        <span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="comment"># this number also equals to the maximum of ranking_</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="grouping">)</span> <span class="relational-operator">==</span>
                <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">a</span><span class="int-literal">1</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="grouping">)</span> <span class="relational-operator">==</span>
                <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">a</span><span class="int-literal">2</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># In RFECV, 'fit' calls 'RFE._fit'</span>
    <span class="comment"># 'number_of_subsets_of_features' of RFE</span>
    <span class="comment"># = the size of 'grid_scores' of RFECV</span>
    <span class="comment"># = the number of iterations of the for loop before optimization #4534</span>

    <span class="comment"># RFECV, n_features_to_select = 1</span>
    <span class="comment"># Case 1, n_features - 1 is divisible by step</span>
    <span class="comment"># Case 2, n_features - 1 is not divisible by step</span>

    <span class="identifier">n_features_to_select</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">n_features_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span>
    <span class="identifier">step_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">step</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">n_features_list</span><span class="punctuation">,</span> <span class="identifier">step_list</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">43</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">rfecv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="identifier">step</span><span class="grouping">)</span>
        <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">grid_scores_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span>
                <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">a</span><span class="int-literal">1</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">grid_scores_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span>
                <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">a</span><span class="int-literal">2</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="punctuation">,</span> <span class="identifier">step</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_rfe_cv_n_jobs</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="identifier">rfecv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">'linear'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">rfecv_ranking</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">ranking_</span>
    <span class="identifier">rfecv_grid_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">grid_scores_</span>

    <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">ranking_</span><span class="punctuation">,</span> <span class="identifier">rfecv_ranking</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rfecv</span><span class="punctuation">.</span><span class="identifier">grid_scores_</span><span class="punctuation">,</span> <span class="identifier">rfecv_grid_scores</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_rfe_cv_groups</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">number_groups</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>
    <span class="identifier">groups</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">floor</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">number_groups</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="identifier">est_groups</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span>
        <span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">generator</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">step</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
        <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'accuracy'</span><span class="punctuation">,</span>
        <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">GroupKFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">est_groups</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">groups</span><span class="arithmetic-assignment">=</span><span class="identifier">groups</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_groups</span><span class="punctuation">.</span><span class="identifier">n_features_</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'importance_getter'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">attrgetter</span><span class="grouping">(</span><span class="string-literal">'regressor_.coef_'), 'regressor_.coef_'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'selector, expected_n_features'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">RFE</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">RFECV</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_rfe_wrapped_estimator</span><span class="grouping">(</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">selector</span><span class="punctuation">,</span>
                               <span class="identifier">expected_n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non-regression test for</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/15312</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_friedman1</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">log_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TransformedTargetRegressor</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="arithmetic-assignment">=</span><span class="identifier">estimator</span><span class="punctuation">,</span>
                                               <span class="identifier">func</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="punctuation">,</span>
                                               <span class="identifier">inverse_func</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">)</span>

    <span class="identifier">selector</span> <span class="arithmetic-assignment">=</span> <span class="identifier">selector</span><span class="grouping">(</span><span class="identifier">log_estimator</span><span class="punctuation">,</span> <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span>
    <span class="identifier">sel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">selector</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sel</span><span class="punctuation">.</span><span class="identifier">support_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_features</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"importance_getter, err_type"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"auto"</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">"random"</span><span class="punctuation">,</span> <span class="identifier">AttributeError</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="punctuation">,</span> <span class="identifier">AttributeError</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"Selector"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">RFE</span><span class="punctuation">,</span> <span class="identifier">RFECV</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_rfe_importance_getter_validation</span><span class="grouping">(</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">err_type</span><span class="punctuation">,</span>
                                          <span class="identifier">Selector</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_friedman1</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">log_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TransformedTargetRegressor</span><span class="grouping">(</span>
        <span class="identifier">regressor</span><span class="arithmetic-assignment">=</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">func</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="punctuation">,</span> <span class="identifier">inverse_func</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span>
    <span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">err_type</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Selector</span><span class="grouping">(</span><span class="identifier">log_estimator</span><span class="punctuation">,</span> <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span>
        <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"cv"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_rfe_allow_nan_inf_in_x</span><span class="grouping">(</span><span class="identifier">cv</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="comment"># add nan and inf value to X</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">NaN</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">Inf</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MockClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">cv</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">rfe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFECV</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">rfe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="grouping">)</span>
    <span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">rfe</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_w_pipeline_2d_coef_</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">sfm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RFE</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="identifier">n_features_to_select</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
              <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">g</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="string-literal">'named_steps.logisticregression.coef_'</span><span class="grouping">)</span>

    <span class="identifier">sfm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sfm</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'ClsRFE'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="identifier">RFE</span><span class="punctuation">,</span>
    <span class="identifier">RFECV</span>
    <span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_multioutput</span><span class="grouping">(</span><span class="identifier">ClsRFE</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">rfe_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ClsRFE</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span>
    <span class="identifier">rfe_test</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    </pre>
  </body>
</html>