<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
Test the fastica algorithm.
"""</span>
<span class="keyword">import</span> <span class="identifier">itertools</span>
<span class="keyword">import</span> <span class="identifier">warnings</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">stats</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">s</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">FastICA</span><span class="punctuation">,</span> <span class="identifier">fastica</span><span class="punctuation">,</span> <span class="identifier">PCA</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span><span class="punctuation">.</span><span class="identifier">_fastica</span> <span class="keyword">import</span> <span class="identifier">_gs_decorrelation</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>


<span class="keyword">def</span> <span class="identifier">center_and_norm</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Centers and norms x **in place**

        Parameters
        -----------
        x: ndarray
            Array with an axis of observations (statistical units) measured on
            random variables.
        axis: int, optional
            Axis along which the mean and variance are calculated.
    """</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rollaxis</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="grouping">)</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gs</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test gram schmidt orthonormalization</span>
    <span class="comment"># generate a random orthogonal  matrix</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">svd</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">_gs_decorrelation</span><span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">w</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="identifier">e</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span>
    <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">u</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_gs_decorrelation</span><span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">tmp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">u</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">tmp</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="identifier">e</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"add_noise"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"seed"</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fastica_simple</span><span class="grouping">(</span><span class="identifier">add_noise</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the FastICA algorithm on very simple data.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="comment"># scipy.stats uses the global RNG:</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="comment"># Generate two sources:</span>
    <span class="identifier">s1</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">s2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stats</span><span class="punctuation">.</span><span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">rvs</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">s1</span><span class="punctuation">,</span> <span class="identifier">s2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">center_and_norm</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span>
    <span class="identifier">s1</span><span class="punctuation">,</span> <span class="identifier">s2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s</span>

    <span class="comment"># Mixing angle</span>
    <span class="identifier">phi</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.6</span>
    <span class="identifier">mixing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cos</span><span class="grouping">(</span><span class="identifier">phi</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">phi</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">phi</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cos</span><span class="grouping">(</span><span class="identifier">phi</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">mixing</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">add_noise</span><span class="punctuation">:</span>
        <span class="identifier">m</span> <span class="arithmetic-assignment">+=</span> <span class="float-literal">0.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span>

    <span class="identifier">center_and_norm</span><span class="grouping">(</span><span class="identifier">m</span><span class="grouping">)</span>

    <span class="comment"># function as fun arg</span>
    <span class="keyword">def</span> <span class="identifier">g_test</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">x</span> <span class="arithmetic-operator">**</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">x</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">algos</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'parallel', 'deflation'</span><span class="grouping">]</span>
    <span class="identifier">nls</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'logcosh', 'exp', 'cube'</span><span class="punctuation">,</span> <span class="identifier">g_test</span><span class="grouping">]</span>
    <span class="identifier">whitening</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">algo</span><span class="punctuation">,</span> <span class="identifier">nl</span><span class="punctuation">,</span> <span class="identifier">whiten</span> <span class="relational-operator">in</span> <span class="identifier">itertools</span><span class="punctuation">.</span><span class="identifier">product</span><span class="grouping">(</span><span class="identifier">algos</span><span class="punctuation">,</span> <span class="identifier">nls</span><span class="punctuation">,</span> <span class="identifier">whitening</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">whiten</span><span class="punctuation">:</span>
            <span class="identifier">k_</span><span class="punctuation">,</span> <span class="identifier">mixing_</span><span class="punctuation">,</span> <span class="identifier">s_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fastica</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">fun</span><span class="arithmetic-assignment">=</span><span class="identifier">nl</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algo</span><span class="punctuation">,</span>
                                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">fastica</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">fun</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tanh</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algo</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">whiten</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
            <span class="identifier">k_</span><span class="punctuation">,</span> <span class="identifier">mixing_</span><span class="punctuation">,</span> <span class="identifier">s_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fastica</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">fun</span><span class="arithmetic-assignment">=</span><span class="identifier">nl</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algo</span><span class="punctuation">,</span> <span class="identifier">whiten</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">fastica</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">fun</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tanh</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algo</span><span class="grouping">)</span>
        <span class="identifier">s_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s_</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="comment"># Check that the mixing model described in the docstring holds:</span>
        <span class="keyword">if</span> <span class="identifier">whiten</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s_</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">mixing_</span><span class="punctuation">,</span> <span class="identifier">k_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">center_and_norm</span><span class="grouping">(</span><span class="identifier">s_</span><span class="grouping">)</span>
        <span class="identifier">s1_</span><span class="punctuation">,</span> <span class="identifier">s2_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s_</span>
        <span class="comment"># Check to see if the sources have been estimated</span>
        <span class="comment"># in the wrong order</span>
        <span class="keyword">if</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s1_</span><span class="punctuation">,</span> <span class="identifier">s2</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s1_</span><span class="punctuation">,</span> <span class="identifier">s1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">s2_</span><span class="punctuation">,</span> <span class="identifier">s1_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s_</span>
        <span class="identifier">s1_</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s1_</span><span class="punctuation">,</span> <span class="identifier">s1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">s2_</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s2_</span><span class="punctuation">,</span> <span class="identifier">s2</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Check that we have estimated the original sources</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">add_noise</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s1_</span><span class="punctuation">,</span> <span class="identifier">s1</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s2_</span><span class="punctuation">,</span> <span class="identifier">s2</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s1_</span><span class="punctuation">,</span> <span class="identifier">s1</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s2_</span><span class="punctuation">,</span> <span class="identifier">s2</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># Test FastICA class</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">sources_fun</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fastica</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">fun</span><span class="arithmetic-assignment">=</span><span class="identifier">nl</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algo</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">ica</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastICA</span><span class="grouping">(</span><span class="identifier">fun</span><span class="arithmetic-assignment">=</span><span class="identifier">nl</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algo</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">sources</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sources</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sources_fun</span><span class="punctuation">,</span> <span class="identifier">sources</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sources</span><span class="punctuation">,</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">mixing_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">fn</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tanh</span><span class="punctuation">,</span> <span class="string-literal">"exp(-.5(x^2))"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">ica</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastICA</span><span class="grouping">(</span><span class="identifier">fun</span><span class="arithmetic-assignment">=</span><span class="identifier">fn</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algo</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">FastICA</span><span class="grouping">(</span><span class="identifier">fun</span><span class="arithmetic-assignment">=</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_fastica_nowhiten</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="comment"># test for issue #697</span>
    <span class="identifier">ica</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastICA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">whiten</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">ica</span><span class="punctuation">,</span> <span class="string-literal">'mixing_'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_fastica_convergence_fail</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the FastICA algorithm on very simple data</span>
    <span class="comment"># (see test_non_square_fastica).</span>
    <span class="comment"># Ensure a ConvergenceWarning raised if the tolerance is sufficiently low.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="comment"># Generate two sources:</span>
    <span class="identifier">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">s1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">t</span><span class="grouping">)</span>
    <span class="identifier">s2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ceil</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span> <span class="arithmetic-operator">*</span> <span class="identifier">t</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">s1</span><span class="punctuation">,</span> <span class="identifier">s2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">center_and_norm</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span>

    <span class="comment"># Mixing matrix</span>
    <span class="identifier">mixing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">mixing</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="grouping">)</span>

    <span class="comment"># Do fastICA with tolerance 0. to ensure failing convergence</span>
    <span class="identifier">ica</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastICA</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">"parallel"</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                  <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ConvergenceWarning</span><span class="punctuation">,</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'add_noise'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_non_square_fastica</span><span class="grouping">(</span><span class="identifier">add_noise</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the FastICA algorithm on very simple data.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="comment"># Generate two sources:</span>
    <span class="identifier">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">s1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">t</span><span class="grouping">)</span>
    <span class="identifier">s2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ceil</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span> <span class="arithmetic-operator">*</span> <span class="identifier">t</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">s1</span><span class="punctuation">,</span> <span class="identifier">s2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">center_and_norm</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span>
    <span class="identifier">s1</span><span class="punctuation">,</span> <span class="identifier">s2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s</span>

    <span class="comment"># Mixing matrix</span>
    <span class="identifier">mixing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">mixing</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">add_noise</span><span class="punctuation">:</span>
        <span class="identifier">m</span> <span class="arithmetic-assignment">+=</span> <span class="float-literal">0.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span>

    <span class="identifier">center_and_norm</span><span class="grouping">(</span><span class="identifier">m</span><span class="grouping">)</span>

    <span class="identifier">k_</span><span class="punctuation">,</span> <span class="identifier">mixing_</span><span class="punctuation">,</span> <span class="identifier">s_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fastica</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">s_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s_</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="comment"># Check that the mixing model described in the docstring holds:</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s_</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">mixing_</span><span class="punctuation">,</span> <span class="identifier">k_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">center_and_norm</span><span class="grouping">(</span><span class="identifier">s_</span><span class="grouping">)</span>
    <span class="identifier">s1_</span><span class="punctuation">,</span> <span class="identifier">s2_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s_</span>
    <span class="comment"># Check to see if the sources have been estimated</span>
    <span class="comment"># in the wrong order</span>
    <span class="keyword">if</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s1_</span><span class="punctuation">,</span> <span class="identifier">s2</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s1_</span><span class="punctuation">,</span> <span class="identifier">s1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">s2_</span><span class="punctuation">,</span> <span class="identifier">s1_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s_</span>
    <span class="identifier">s1_</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s1_</span><span class="punctuation">,</span> <span class="identifier">s1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">s2_</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s2_</span><span class="punctuation">,</span> <span class="identifier">s2</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Check that we have estimated the original sources</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">add_noise</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s1_</span><span class="punctuation">,</span> <span class="identifier">s1</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">s2_</span><span class="punctuation">,</span> <span class="identifier">s2</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_fit_transform</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test FastICA.fit_transform</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">whiten</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">n_components_</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">n_components</span> <span class="keyword">if</span> <span class="identifier">n_components</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="keyword">else</span>
                         <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">ica</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastICA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">whiten</span><span class="arithmetic-assignment">=</span><span class="identifier">whiten</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_components_</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_components_</span><span class="grouping">)</span>

        <span class="identifier">ica</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastICA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">whiten</span><span class="arithmetic-assignment">=</span><span class="identifier">whiten</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_components_</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
        <span class="identifier">Xt2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="punctuation">,</span> <span class="identifier">Xt2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_inverse_transform</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test FastICA.inverse_transform</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">n1</span><span class="punctuation">,</span> <span class="identifier">n2</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">n1</span><span class="grouping">)</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n1</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">n2</span><span class="grouping">)</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n2</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">n1</span><span class="grouping">)</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n2</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">n2</span><span class="grouping">)</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n2</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="keyword">for</span> <span class="identifier">whiten</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">n_components</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">n1</span><span class="punctuation">,</span> <span class="identifier">n2</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">n_components_</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">n_components</span> <span class="keyword">if</span> <span class="identifier">n_components</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="keyword">else</span>
                             <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">ica</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastICA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                          <span class="identifier">whiten</span><span class="arithmetic-assignment">=</span><span class="identifier">whiten</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">catch_warnings</span><span class="grouping">(</span><span class="identifier">record</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># catch "n_components ignored" warning</span>
                <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">expected_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">whiten</span><span class="punctuation">,</span> <span class="identifier">n_components_</span><span class="grouping">)</span><span class="grouping">]</span>
            <span class="keyword">assert</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">mixing_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">expected_shape</span>
            <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ica</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">shape</span>

            <span class="comment"># reversibility test in non-reduction case</span>
            <span class="keyword">if</span> <span class="identifier">n_components</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_fastica_errors</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">w_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'max_iter should be greater than 1'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">FastICA</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">r</span><span class="string-literal">'alpha must be in \[1,2\]'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fastica</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">fun_args</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'alpha'</span><span class="punctuation">:</span> <span class="int-literal">0</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'w_init has invalid shape.+'</span>
                       <span class="identifier">r</span><span class="string-literal">'should be \(3L?, 3L?\)'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fastica</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">w_init</span><span class="arithmetic-assignment">=</span><span class="identifier">w_init</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Invalid algorithm.+must '</span>
                       <span class="string-literal">'be.+parallel.+or.+deflation'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fastica</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'pizza'</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'whiten'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'return_X_mean'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'return_n_iter'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fastica_output_shape</span><span class="grouping">(</span><span class="identifier">whiten</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">a</span><span class="invalid">n</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">expected_len</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">+</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">a</span><span class="invalid">n</span> <span class="arithmetic-operator">+</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span>

    <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fastica</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">whiten</span><span class="arithmetic-assignment">=</span><span class="identifier">whiten</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span>
                  <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">a</span><span class="invalid">n</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">a</span><span class="invalid">n</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">out</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected_len</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">whiten</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">out</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>

    </pre>
  </body>
</html>