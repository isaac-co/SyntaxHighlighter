<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">sys</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">linalg</span> <span class="keyword">import</span> <span class="identifier">block_diag</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csr_matrix</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">special</span> <span class="keyword">import</span> <span class="identifier">psi</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">LatentDirichletAllocation</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span><span class="punctuation">.</span><span class="identifier">_lda</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">_dirichlet_expectation_1d</span><span class="punctuation">,</span>
                                        <span class="identifier">_dirichlet_expectation_2d</span><span class="grouping">)</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">i</span><span class="invalid">f</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">f</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">b</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">NotFittedError</span>
<span class="keyword">from</span> <span class="identifier">io</span> <span class="keyword">import</span> <span class="identifier">StringIO</span>


<span class="keyword">def</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Create 3 topics and each topic has 3 distinct words.</span>
    <span class="comment"># (Each word only belongs to a single topic.)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">block</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">blocks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">block</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_components</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">block_diag</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">blocks</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_default_prior_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># default prior parameter should be `1 / topics`</span>
    <span class="comment"># and verbose params should not affect result</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">prior</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_components</span>
    <span class="identifier">lda_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                      <span class="identifier">doc_topic_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">prior</span><span class="punctuation">,</span>
                                      <span class="identifier">topic_word_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">prior</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">lda_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">topic_distr_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda_1</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">topic_distr_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda_2</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">topic_distr_1</span><span class="punctuation">,</span> <span class="identifier">topic_distr_2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_fit_batch</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA batch learning_offset (`fit` method with 'batch' learning)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                    <span class="identifier">evaluate_every</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'batch'</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">correct_idx_grps</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">component</span> <span class="relational-operator">in</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">:</span>
        <span class="comment"># Find top 3 words in each LDA component</span>
        <span class="identifier">top_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">component</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">top_idx</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">correct_idx_grps</span>


<span class="keyword">def</span> <span class="identifier">test_lda_fit_online</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA online learning (`fit` method with 'online' learning)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                    <span class="identifier">learning_offset</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">evaluate_every</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                    <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'online'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">correct_idx_grps</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">component</span> <span class="relational-operator">in</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">:</span>
        <span class="comment"># Find top 3 words in each LDA component</span>
        <span class="identifier">top_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">component</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">top_idx</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">correct_idx_grps</span>


<span class="keyword">def</span> <span class="identifier">test_lda_partial_fit</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA online learning (`partial_fit` method)</span>
    <span class="comment"># (same as test_lda_batch)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                    <span class="identifier">learning_offset</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">total_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">correct_idx_grps</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">c</span> <span class="relational-operator">in</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">:</span>
        <span class="identifier">top_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">c</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">top_idx</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">correct_idx_grps</span>


<span class="keyword">def</span> <span class="identifier">test_lda_dense_input</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA with dense input.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                    <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'batch'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">correct_idx_grps</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">component</span> <span class="relational-operator">in</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">:</span>
        <span class="comment"># Find top 3 words in each LDA component</span>
        <span class="identifier">top_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">component</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">top_idx</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">correct_idx_grps</span>


<span class="keyword">def</span> <span class="identifier">test_lda_transform</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA transform.</span>
    <span class="comment"># Transform result cannot be negative and should be normalized</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">X_trans</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'method', ('online', 'batch'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lda_fit_transform</span><span class="grouping">(</span><span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA fit_transform & transform</span>
    <span class="comment"># fit_transform and transform result should be the same</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">X_fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_fit</span><span class="punctuation">,</span> <span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_invalid_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test `_check_params` method</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">invalid_models</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="grouping">(</span><span class="string-literal">'n_components'</span><span class="punctuation">,</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'learning_method'</span><span class="punctuation">,</span>
         <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'unknown'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'total_samples'</span><span class="punctuation">,</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">total_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'learning_offset'</span><span class="punctuation">,</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">learning_offset</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">param</span><span class="punctuation">,</span> <span class="identifier">model</span> <span class="relational-operator">in</span> <span class="identifier">invalid_models</span><span class="punctuation">:</span>
        <span class="identifier">regex</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"^Invalid %r parameter"</span> <span class="arithmetic-operator">%</span> <span class="identifier">param</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">regex</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_negative_input</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test pass dense matrix with sparse negative input.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">regex</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"^Negative values in data passed"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">regex</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_no_component_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test `perplexity` before `fit`</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">regex</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"This LatentDirichletAllocation instance is not fitted yet. "</span>
             <span class="string-literal">"Call 'fit' with appropriate arguments before using this "</span>
             <span class="string-literal">"estimator."</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">regex</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">f</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">b</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'method', ('online', 'batch'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lda_multi_jobs</span><span class="grouping">(</span><span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="comment"># Test LDA batch training with multi CPU</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                    <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span>
                                    <span class="identifier">evaluate_every</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">correct_idx_grps</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">c</span> <span class="relational-operator">in</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">:</span>
        <span class="identifier">top_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">c</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">top_idx</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">correct_idx_grps</span>


<span class="punctuation">@</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">f</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">b</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span>
<span class="keyword">def</span> <span class="identifier">test_lda_partial_fit_multi_jobs</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA online training with multi CPU</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                    <span class="identifier">learning_offset</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">total_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">correct_idx_grps</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">c</span> <span class="relational-operator">in</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">:</span>
        <span class="identifier">top_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">c</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">top_idx</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">correct_idx_grps</span>


<span class="keyword">def</span> <span class="identifier">test_lda_preplexity_mismatch</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test dimension mismatch in `perplexity` method</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                    <span class="identifier">learning_offset</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">total_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># invalid samples</span>
    <span class="identifier">invalid_n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">r</span><span class="string-literal">'Number of samples'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">_perplexity_precomp_distr</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">invalid_n_samples</span><span class="grouping">)</span>
    <span class="comment"># invalid topic number</span>
    <span class="identifier">invalid_n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">r</span><span class="string-literal">'Number of topics'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">_perplexity_precomp_distr</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">invalid_n_components</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'method', ('online', 'batch'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lda_perplexity</span><span class="grouping">(</span><span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA perplexity for batch training</span>
    <span class="comment"># perplexity should be lower after each iteration</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">lda_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                      <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span>
                                      <span class="identifier">total_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">lda_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                      <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span>
                                      <span class="identifier">total_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">lda_1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">perp_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda_1</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sub_sampling</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">lda_2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">perp_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda_2</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sub_sampling</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">perp_1</span> <span class="relational-operator">&gt;=</span> <span class="identifier">perp_2</span>

    <span class="identifier">perp_1_subsampling</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda_1</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sub_sampling</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">perp_2_subsampling</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda_2</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sub_sampling</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">perp_1_subsampling</span> <span class="relational-operator">&gt;=</span> <span class="identifier">perp_2_subsampling</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'method', ('online', 'batch'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lda_score</span><span class="grouping">(</span><span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA score for batch training</span>
    <span class="comment"># score should be higher after each iteration</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">lda_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                      <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span>
                                      <span class="identifier">total_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">lda_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                      <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span>
                                      <span class="identifier">total_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">lda_1</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">score_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda_1</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">lda_2</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">score_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda_2</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score_2</span> <span class="relational-operator">&gt;=</span> <span class="identifier">score_1</span>


<span class="keyword">def</span> <span class="identifier">test_perplexity_input_format</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA perplexity for sparse and dense input</span>
    <span class="comment"># score should be the same for both dense and sparse input</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                    <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'batch'</span><span class="punctuation">,</span>
                                    <span class="identifier">total_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">perp_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">perp_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">perp_1</span><span class="punctuation">,</span> <span class="identifier">perp_2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_score_perplexity</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the relationship between LDA score and perplexity</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">perplexity_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sub_sampling</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">perplexity_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">score</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">perplexity_1</span><span class="punctuation">,</span> <span class="identifier">perplexity_2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_fit_perplexity</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the perplexity computed during fit is consistent with what is</span>
    <span class="comment"># returned by the perplexity method</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                    <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'batch'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                    <span class="identifier">evaluate_every</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Perplexity computed at end of fit method</span>
    <span class="identifier">perplexity1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">bound_</span>

    <span class="comment"># Result of perplexity method on the train set</span>
    <span class="identifier">perplexity2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">perplexity1</span><span class="punctuation">,</span> <span class="identifier">perplexity2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_empty_docs</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test LDA on empty document (all-zero rows)."""</span>
    <span class="identifier">Z</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">X</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">Z</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">Z</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">750</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_dirichlet_expectation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test Cython version of Dirichlet expectation calculation."""</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10000</span><span class="grouping">)</span>
    <span class="identifier">expectation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty_like</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>
    <span class="identifier">_dirichlet_expectation_1d</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">expectation</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">expectation</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">psi</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">psi</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-19</span><span class="grouping">)</span>

    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">_dirichlet_expectation_2d</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">psi</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">psi</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-11</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">3e-9</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_verbosity</span><span class="grouping">(</span><span class="identifier">verbose</span><span class="punctuation">,</span> <span class="identifier">evaluate_every</span><span class="punctuation">,</span> <span class="identifier">expected_lines</span><span class="punctuation">,</span>
                    <span class="identifier">expected_perplexities</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_build_sparse_mtx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LatentDirichletAllocation</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                    <span class="identifier">learning_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'batch'</span><span class="punctuation">,</span>
                                    <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="punctuation">,</span>
                                    <span class="identifier">evaluate_every</span><span class="arithmetic-assignment">=</span><span class="identifier">evaluate_every</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StringIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">old_out</span><span class="punctuation">,</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="punctuation">,</span> <span class="identifier">out</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">finally</span><span class="punctuation">:</span>
        <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">old_out</span>

    <span class="identifier">n_lines</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out</span><span class="punctuation">.</span><span class="identifier">getvalue</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">count</span><span class="grouping">(</span><span class="string-literal">'\n'</span><span class="grouping">)</span>
    <span class="identifier">n_perplexity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out</span><span class="punctuation">.</span><span class="identifier">getvalue</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">count</span><span class="grouping">(</span><span class="string-literal">'perplexity'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">expected_lines</span> <span class="relational-operator">==</span> <span class="identifier">n_lines</span>
    <span class="keyword">assert</span> <span class="identifier">expected_perplexities</span> <span class="relational-operator">==</span> <span class="identifier">n_perplexity</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">'verbose,evaluate_every,expected_lines,expected_perplexities'</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_verbosity</span><span class="grouping">(</span><span class="identifier">verbose</span><span class="punctuation">,</span> <span class="identifier">evaluate_every</span><span class="punctuation">,</span> <span class="identifier">expected_lines</span><span class="punctuation">,</span>
                   <span class="identifier">expected_perplexities</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_verbosity</span><span class="grouping">(</span><span class="identifier">verbose</span><span class="punctuation">,</span> <span class="identifier">evaluate_every</span><span class="punctuation">,</span> <span class="identifier">expected_lines</span><span class="punctuation">,</span>
                    <span class="identifier">expected_perplexities</span><span class="grouping">)</span>

    </pre>
  </body>
</html>