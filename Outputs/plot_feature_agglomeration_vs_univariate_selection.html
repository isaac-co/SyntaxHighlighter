<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
==============================================
Feature agglomeration vs. univariate selection
==============================================

This example compares 2 dimensionality reduction strategies:

- univariate feature selection with Anova

- feature agglomeration with Ward hierarchical clustering

Both methods are compared in a regression problem using
a BayesianRidge as supervised estimator.
"""</span>

<span class="comment"># Author: Alexandre Gramfort &lt;alexandre.gramfort@inria.fr&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>

<span class="keyword">import</span> <span class="identifier">shutil</span>
<span class="keyword">import</span> <span class="identifier">tempfile</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">linalg</span><span class="punctuation">,</span> <span class="identifier">ndimage</span>
<span class="keyword">from</span> <span class="identifier">joblib</span> <span class="keyword">import</span> <span class="identifier">Memory</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">image</span> <span class="keyword">import</span> <span class="identifier">grid_to_graph</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">feature_selection</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">FeatureAgglomeration</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">BayesianRidge</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">Pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GridSearchCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">KFold</span>

<span class="comment"># #############################################################################</span>
<span class="comment"># Generate data</span>
<span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">200</span>
<span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40</span>  <span class="comment"># image size</span>
<span class="identifier">roi_size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">15</span>
<span class="identifier">snr</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span><span class="punctuation">.</span>
<span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">seed</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>

<span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">coef</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="identifier">roi_size</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="identifier">roi_size</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span>
<span class="identifier">coef</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">roi_size</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">roi_size</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span>

<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">size</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="punctuation">:</span>  <span class="comment"># smooth data</span>
    <span class="identifier">x</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ndimage</span><span class="punctuation">.</span><span class="identifier">gaussian_filter</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">sigma</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">coef</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">noise</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">noise_coef</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">snr</span> <span class="arithmetic-operator">/</span> <span class="int-literal">20</span><span class="punctuation">.</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">noise</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">noise_coef</span> <span class="arithmetic-operator">*</span> <span class="identifier">noise</span>  <span class="comment"># add noise</span>

<span class="comment"># #############################################################################</span>
<span class="comment"># Compute the coefs of a Bayesian Ridge with GridSearch</span>
<span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span>  <span class="comment"># cross-validation generator for model selection</span>
<span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">cachedir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tempfile</span><span class="punctuation">.</span><span class="identifier">mkdtemp</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">mem</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">location</span><span class="arithmetic-assignment">=</span><span class="identifier">cachedir</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

<span class="comment"># Ward agglomeration followed by BayesianRidge</span>
<span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="grouping">)</span>
<span class="identifier">ward</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureAgglomeration</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">,</span>
                            <span class="identifier">memory</span><span class="arithmetic-assignment">=</span><span class="identifier">mem</span><span class="grouping">)</span>
<span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'ward', ward), ('ridge'</span><span class="punctuation">,</span> <span class="identifier">ridge</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="comment"># Select the optimal number of parcels with grid search</span>
<span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'ward__n_clusters'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
<span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>  <span class="comment"># set the best parameters</span>
<span class="identifier">coef_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">coef_</span>
<span class="identifier">coef_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">coef_</span><span class="grouping">)</span>
<span class="identifier">coef_agglomeration_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span>

<span class="comment"># Anova univariate feature selection followed by BayesianRidge</span>
<span class="identifier">f_regression</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mem</span><span class="punctuation">.</span><span class="identifier">cache</span><span class="grouping">(</span><span class="identifier">feature_selection</span><span class="punctuation">.</span><span class="identifier">f_regression</span><span class="grouping">)</span>  <span class="comment"># caching function</span>
<span class="identifier">anova</span> <span class="arithmetic-assignment">=</span> <span class="identifier">feature_selection</span><span class="punctuation">.</span><span class="identifier">SelectPercentile</span><span class="grouping">(</span><span class="identifier">f_regression</span><span class="grouping">)</span>
<span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'anova', anova), ('ridge'</span><span class="punctuation">,</span> <span class="identifier">ridge</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="comment"># Select the optimal percentage of features with grid search</span>
<span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'anova__percentile'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
<span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>  <span class="comment"># set the best parameters</span>
<span class="identifier">coef_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">coef_</span>
<span class="identifier">coef_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">coef_selection_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span>

<span class="comment"># #############################################################################</span>
<span class="comment"># Inverse the transformation to plot the results on an image</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">close</span><span class="grouping">(</span><span class="string-literal">'all'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">7.3</span><span class="punctuation">,</span> <span class="float-literal">2.7</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">imshow</span><span class="grouping">(</span><span class="identifier">coef</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"nearest"</span><span class="punctuation">,</span> <span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">RdBu_r</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"True weights"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">imshow</span><span class="grouping">(</span><span class="identifier">coef_selection_</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"nearest"</span><span class="punctuation">,</span> <span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">RdBu_r</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Feature Selection"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">imshow</span><span class="grouping">(</span><span class="identifier">coef_agglomeration_</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"nearest"</span><span class="punctuation">,</span> <span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">RdBu_r</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Feature Agglomeration"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots_adjust</span><span class="grouping">(</span><span class="float-literal">0.04</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.98</span><span class="punctuation">,</span> <span class="float-literal">0.94</span><span class="punctuation">,</span> <span class="float-literal">0.16</span><span class="punctuation">,</span> <span class="float-literal">0.26</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="comment"># Attempt to remove the temporary cachedir, but don't worry if it fails</span>
<span class="identifier">shutil</span><span class="punctuation">.</span><span class="identifier">rmtree</span><span class="grouping">(</span><span class="identifier">cachedir</span><span class="punctuation">,</span> <span class="identifier">ignore_errors</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    </pre>
  </body>
</html>