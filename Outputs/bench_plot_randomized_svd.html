<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
Benchmarks on the power iterations phase in randomized SVD.

We test on various synthetic and real datasets the effect of increasing
the number of power iterations in terms of quality of approximation
and running time. A number greater than 0 should help with noisy matrices,
which are characterized by a slow spectral decay.

We test several policy for normalizing the power iterations. Normalization
is crucial to avoid numerical issues.

The quality of the approximation is measured by the spectral norm discrepancy
between the original input matrix and the reconstructed one (by multiplying
the randomized_svd's outputs). The spectral norm is always equivalent to the
largest singular value of a matrix. (3) justifies this choice. However, one can
notice in these experiments that Frobenius and spectral norms behave
very similarly in a qualitative sense. Therefore, we suggest to run these
benchmarks with `enable_spectral_norm = False`, as Frobenius' is MUCH faster to
compute.

The benchmarks follow.

(a) plot: time vs norm, varying number of power iterations
    data: many datasets
    goal: compare normalization policies and study how the number of power
    iterations affect time and norm

(b) plot: n_iter vs norm, varying rank of data and number of components for
    randomized_SVD
    data: low-rank matrices on which we control the rank
    goal: study whether the rank of the matrix and the number of components
    extracted by randomized SVD affect "the optimal" number of power iterations

(c) plot: time vs norm, varying datasets
    data: many datasets
    goal: compare default configurations

We compare the following algorithms:
-   randomized_svd(..., power_iteration_normalizer='none')
-   randomized_svd(..., power_iteration_normalizer='LU')
-   randomized_svd(..., power_iteration_normalizer='QR')
-   randomized_svd(..., power_iteration_normalizer='auto')
-   fbpca.pca() from https://github.com/facebook/fbpca (if installed)

Conclusion
----------
- n_iter=2 appears to be a good default value
- power_iteration_normalizer='none' is OK if n_iter is small, otherwise LU
  gives similar errors to QR but is cheaper. That's what 'auto' implements.

References
----------
(1) Finding structure with randomness: Stochastic algorithms for constructing
    approximate matrix decompositions
    Halko, et al., 2009 https://arxiv.org/abs/0909.4061

(2) A randomized algorithm for the decomposition of matrices
    Per-Gunnar Martinsson, Vladimir Rokhlin and Mark Tygert

(3) An implementation of a randomized algorithm for principal component
    analysis
    A. Szlam et al. 2014
"""</span>

<span class="comment"># Author: Giorgio Patrini</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span> <span class="keyword">as</span> <span class="identifier">sp</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>

<span class="keyword">import</span> <span class="identifier">gc</span>
<span class="keyword">import</span> <span class="identifier">pickle</span>
<span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">time</span>
<span class="keyword">from</span> <span class="identifier">collections</span> <span class="keyword">import</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span>
<span class="keyword">import</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_arpack</span> <span class="keyword">import</span> <span class="identifier">_init_arpack_v0</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">gen_batches</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">extmath</span> <span class="keyword">import</span> <span class="identifier">randomized_svd</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_low_rank_matrix</span><span class="punctuation">,</span> <span class="identifier">make_sparse_uncorrelated</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">fetch_lfw_people</span><span class="punctuation">,</span>
                              <span class="identifier">fetch_openml</span><span class="punctuation">,</span>
                              <span class="identifier">fetch_20newsgroups_vectorized</span><span class="punctuation">,</span>
                              <span class="identifier">fetch_olivetti_faces</span><span class="punctuation">,</span>
                              <span class="identifier">fetch_rcv1</span><span class="grouping">)</span>

<span class="keyword">try</span><span class="punctuation">:</span>
    <span class="keyword">import</span> <span class="identifier">fbpca</span>
    <span class="identifier">fbpca_available</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
<span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
    <span class="identifier">fbpca_available</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>

<span class="comment"># If this is enabled, tests are much slower and will crash with the large data</span>
<span class="identifier">enable_spectral_norm</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>

<span class="comment"># TODO: compute approximate spectral norms with the power method as in</span>
<span class="comment"># Estimating the largest eigenvalues by the power and Lanczos methods with</span>
<span class="comment"># a random start, Jacek Kuczynski and Henryk Wozniakowski, SIAM Journal on</span>
<span class="comment"># Matrix Analysis and Applications, 13 (4): 1094-1122, 1992.</span>
<span class="comment"># This approximation is a very fast estimate of the spectral norm, but depends</span>
<span class="comment"># on starting random vectors.</span>

<span class="comment"># Determine when to switch to batch computation for matrix norms,</span>
<span class="comment"># in case the reconstructed (dense) matrix is too large</span>
<span class="identifier">MAX_MEMORY</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">2e9</span><span class="grouping">)</span>

<span class="comment"># The following datasets can be downloaded manually from:</span>
<span class="comment"># CIFAR 10: https://www.cs.toronto.edu/~kriz/cifar-10-python.tar.gz</span>
<span class="comment"># SVHN: http://ufldl.stanford.edu/housenumbers/train_32x32.mat</span>
<span class="identifier">CIFAR_FOLDER</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"./cifar-10-batches-py/"</span>
<span class="identifier">SVHN_FOLDER</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"./SVHN/"</span>

<span class="identifier">datasets</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'low rank matrix', 'lfw_people', 'olivetti_faces', '20newsgroups'</span><span class="punctuation">,</span>
            <span class="string-literal">'mnist_784', 'CIFAR', 'a3a', 'SVHN', 'uncorrelated matrix'</span><span class="grouping">]</span>

<span class="identifier">big_sparse_datasets</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'big sparse matrix', 'rcv1'</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">unpickle</span><span class="grouping">(</span><span class="identifier">file_name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">file_name</span><span class="punctuation">,</span> <span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">fo</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="identifier">fo</span><span class="punctuation">,</span> <span class="identifier">encoding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'latin1'</span><span class="grouping">)</span><span class="grouping">[</span><span class="string-literal">"data"</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">handle_missing_dataset</span><span class="grouping">(</span><span class="identifier">file_folder</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">isdir</span><span class="grouping">(</span><span class="identifier">file_folder</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"%s file folder not found. Test skipped."</span> <span class="arithmetic-operator">%</span> <span class="identifier">file_folder</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="int-literal">0</span>


<span class="keyword">def</span> <span class="identifier">get_data</span><span class="grouping">(</span><span class="identifier">dataset_name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Getting dataset: %s"</span> <span class="arithmetic-operator">%</span> <span class="identifier">dataset_name</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'lfw_people'</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_lfw_people</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="keyword">elif</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'20newsgroups'</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups_vectorized</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">100000</span><span class="grouping">]</span>
    <span class="keyword">elif</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'olivetti_faces'</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_olivetti_faces</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="keyword">elif</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'rcv1'</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_rcv1</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="keyword">elif</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'CIFAR'</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">handle_missing_dataset</span><span class="grouping">(</span><span class="identifier">CIFAR_FOLDER</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"skip"</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">X1</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">unpickle</span><span class="grouping">(</span><span class="string-literal">"%sdata_batch_%d"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">CIFAR_FOLDER</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
              <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span>
        <span class="keyword">del</span> <span class="identifier">X1</span>
    <span class="keyword">elif</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'SVHN'</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">handle_missing_dataset</span><span class="grouping">(</span><span class="identifier">SVHN_FOLDER</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">X1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">io</span><span class="punctuation">.</span><span class="identifier">loadmat</span><span class="grouping">(</span><span class="string-literal">"%strain_32x32.mat"</span> <span class="arithmetic-operator">%</span> <span class="identifier">SVHN_FOLDER</span><span class="grouping">)</span><span class="grouping">[</span><span class="string-literal">'X'</span><span class="grouping">]</span>
        <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">X1</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">32</span> <span class="arithmetic-operator">*</span> <span class="int-literal">32</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">X1</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span>
        <span class="keyword">del</span> <span class="identifier">X1</span>
        <span class="keyword">del</span> <span class="identifier">X2</span>
    <span class="keyword">elif</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'low rank matrix'</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_low_rank_matrix</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e4</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">effective_rank</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">tail_strength</span><span class="arithmetic-assignment">=</span><span class="float-literal">.5</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'uncorrelated matrix'</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_sparse_uncorrelated</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10000</span><span class="punctuation">,</span>
                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'big sparse matrix'</span><span class="punctuation">:</span>
        <span class="identifier">sparsity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e6</span><span class="grouping">)</span>
        <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e6</span><span class="grouping">)</span>
        <span class="identifier">small_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e4</span><span class="grouping">)</span>
        <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">sparsity</span><span class="arithmetic-operator">/</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
        <span class="identifier">row</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">small_size</span><span class="punctuation">,</span> <span class="identifier">sparsity</span><span class="grouping">)</span>
        <span class="identifier">col</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">small_size</span><span class="punctuation">,</span> <span class="identifier">sparsity</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">row</span><span class="punctuation">,</span> <span class="identifier">col</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">small_size</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">del</span> <span class="identifier">data</span>
        <span class="keyword">del</span> <span class="identifier">row</span>
        <span class="keyword">del</span> <span class="identifier">col</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">dataset_name</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="keyword">return</span> <span class="identifier">X</span>


<span class="keyword">def</span> <span class="identifier">plot_time_vs_s</span><span class="grouping">(</span><span class="identifier">time</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="punctuation">,</span> <span class="identifier">point_labels</span><span class="punctuation">,</span> <span class="identifier">title</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">colors</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'g', 'b', 'y'</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">l</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">norm</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">l</span> <span class="relational-operator">!=</span> <span class="string-literal">"fbpca"</span><span class="punctuation">:</span>
            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">time</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">l</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="arithmetic-assignment">=</span><span class="string-literal">'o'</span><span class="punctuation">,</span> <span class="identifier">c</span><span class="arithmetic-assignment">=</span><span class="identifier">colors</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">time</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">l</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="arithmetic-assignment">=</span><span class="string-literal">'^', c='red'</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">label</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">point_labels</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">time</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">norm</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">annotate</span><span class="grouping">(</span><span class="identifier">label</span><span class="punctuation">,</span> <span class="identifier">xy</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xytext</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="identifier">textcoords</span><span class="arithmetic-assignment">=</span><span class="string-literal">'offset points', ha='right', va='bottom'</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"upper right"</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">suptitle</span><span class="grouping">(</span><span class="identifier">title</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"norm discrepancy"</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"running time [s]"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">scatter_time_vs_s</span><span class="grouping">(</span><span class="identifier">time</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="punctuation">,</span> <span class="identifier">point_labels</span><span class="punctuation">,</span> <span class="identifier">title</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">l</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">norm</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">l</span> <span class="relational-operator">!=</span> <span class="string-literal">"fbpca"</span><span class="punctuation">:</span>
            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">time</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">l</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="arithmetic-assignment">=</span><span class="string-literal">'o', c='b'</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">label</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">point_labels</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">time</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">norm</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">annotate</span><span class="grouping">(</span><span class="identifier">label</span><span class="punctuation">,</span> <span class="identifier">xy</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xytext</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">80</span><span class="grouping">)</span><span class="punctuation">,</span>
                             <span class="identifier">textcoords</span><span class="arithmetic-assignment">=</span><span class="string-literal">'offset points', ha='right'</span><span class="punctuation">,</span>
                             <span class="identifier">arrowprops</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">arrowstyle</span><span class="arithmetic-assignment">=</span><span class="string-literal">"-&gt;"</span><span class="punctuation">,</span>
                                             <span class="identifier">connectionstyle</span><span class="arithmetic-assignment">=</span><span class="string-literal">"arc3"</span><span class="grouping">)</span><span class="punctuation">,</span>
                             <span class="identifier">va</span><span class="arithmetic-assignment">=</span><span class="string-literal">'bottom'</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="identifier">rotation</span><span class="arithmetic-assignment">=</span><span class="int-literal">90</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">time</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">l</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="arithmetic-assignment">=</span><span class="string-literal">'^', c='red'</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">label</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">point_labels</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">time</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">norm</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">annotate</span><span class="grouping">(</span><span class="identifier">label</span><span class="punctuation">,</span> <span class="identifier">xy</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xytext</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span><span class="punctuation">,</span>
                             <span class="identifier">textcoords</span><span class="arithmetic-assignment">=</span><span class="string-literal">'offset points', ha='right'</span><span class="punctuation">,</span>
                             <span class="identifier">arrowprops</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">arrowstyle</span><span class="arithmetic-assignment">=</span><span class="string-literal">"-&gt;"</span><span class="punctuation">,</span>
                                             <span class="identifier">connectionstyle</span><span class="arithmetic-assignment">=</span><span class="string-literal">"arc3"</span><span class="grouping">)</span><span class="punctuation">,</span>
                             <span class="identifier">va</span><span class="arithmetic-assignment">=</span><span class="string-literal">'bottom'</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="identifier">rotation</span><span class="arithmetic-assignment">=</span><span class="int-literal">90</span><span class="grouping">)</span>

    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"best"</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">suptitle</span><span class="grouping">(</span><span class="identifier">title</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"norm discrepancy"</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"running time [s]"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">plot_power_iter_vs_s</span><span class="grouping">(</span><span class="identifier">power_iter</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">title</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">l</span> <span class="relational-operator">in</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">power_iter</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="grouping">[</span><span class="identifier">l</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">l</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="arithmetic-assignment">=</span><span class="string-literal">'o'</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lower right"</span><span class="punctuation">,</span> <span class="identifier">prop</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'size'</span><span class="punctuation">:</span> <span class="int-literal">10</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">suptitle</span><span class="grouping">(</span><span class="identifier">title</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"norm discrepancy"</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"n_iter"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">svd_timing</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_comps</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="punctuation">,</span> <span class="identifier">n_oversamples</span><span class="punctuation">,</span>
               <span class="identifier">power_iteration_normalizer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Measure time for decomposition
    """</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"... running SVD ..."</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">method</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="string-literal">'fbpca'</span><span class="punctuation">:</span>
        <span class="identifier">gc</span><span class="punctuation">.</span><span class="identifier">collect</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">mu</span><span class="punctuation">,</span> <span class="identifier">V</span> <span class="arithmetic-assignment">=</span> <span class="identifier">randomized_svd</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_comps</span><span class="punctuation">,</span> <span class="identifier">n_oversamples</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="punctuation">,</span>
                                  <span class="identifier">power_iteration_normalizer</span><span class="punctuation">,</span>
                                  <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span> <span class="identifier">transpose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">call_time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">gc</span><span class="punctuation">.</span><span class="identifier">collect</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="comment"># There is a different convention for l here</span>
        <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">mu</span><span class="punctuation">,</span> <span class="identifier">V</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fbpca</span><span class="punctuation">.</span><span class="identifier">pca</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_comps</span><span class="punctuation">,</span> <span class="identifier">raw</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">n_iter</span><span class="punctuation">,</span>
                             <span class="identifier">l</span><span class="arithmetic-assignment">=</span><span class="identifier">n_oversamples</span><span class="arithmetic-operator">+</span><span class="identifier">n_comps</span><span class="grouping">)</span>
        <span class="identifier">call_time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span>

    <span class="keyword">return</span> <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">mu</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="punctuation">,</span> <span class="identifier">call_time</span>


<span class="keyword">def</span> <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">msg</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Compute the norm diff with the original matrix, when randomized
    SVD is called with *params.

    norm: 2 =&gt; spectral; 'fro' =&gt; Frobenius
    """</span>

    <span class="keyword">if</span> <span class="identifier">msg</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"... computing %s norm ..."</span> <span class="arithmetic-operator">%</span> <span class="identifier">norm</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">norm</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="punctuation">:</span>
        <span class="comment"># s = sp.linalg.norm(A, ord=2)  # slow</span>
        <span class="identifier">v0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_init_arpack_v0</span><span class="grouping">(</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">svds</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span>
                                      <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                      <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">v</span><span class="invalid">e</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                      <span class="identifier">v0</span><span class="arithmetic-assignment">=</span><span class="identifier">v0</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">ord</span><span class="arithmetic-assignment">=</span><span class="identifier">norm</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">ord</span><span class="arithmetic-assignment">=</span><span class="identifier">norm</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">value</span>


<span class="keyword">def</span> <span class="identifier">scalable_frobenius_norm_discrepancy</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># if the input is not too big, just call scipy</span>
    <span class="keyword">if</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">MAX_MEMORY</span><span class="punctuation">:</span>
        <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">U</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'fro'</span><span class="grouping">)</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"... computing fro norm by batches..."</span><span class="grouping">)</span>
    <span class="identifier">batch_size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">Vhat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">)</span>
    <span class="identifier">cum_norm</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.0</span>
    <span class="keyword">for</span> <span class="identifier">batch</span> <span class="relational-operator">in</span> <span class="identifier">gen_batches</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">batch_size</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">U</span><span class="grouping">[</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">Vhat</span><span class="grouping">)</span>
        <span class="identifier">cum_norm</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">M</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'fro'</span><span class="punctuation">,</span> <span class="identifier">msg</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">cum_norm</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">bench_a</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dataset_name</span><span class="punctuation">,</span> <span class="identifier">power_iter</span><span class="punctuation">,</span> <span class="identifier">n_oversamples</span><span class="punctuation">,</span> <span class="identifier">n_comps</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">all_time</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
        <span class="identifier">all_spectral</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">)</span>
        <span class="identifier">X_spectral_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">msg</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">all_frobenius</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">)</span>
    <span class="identifier">X_fro_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'fro'</span><span class="punctuation">,</span> <span class="identifier">msg</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">pi</span> <span class="relational-operator">in</span> <span class="identifier">power_iter</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">pm</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'none', 'LU', 'QR'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"n_iter = %d on sklearn - %s"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">pi</span><span class="punctuation">,</span> <span class="identifier">pm</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="punctuation">,</span> <span class="identifier">time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd_timing</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_comps</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">pi</span><span class="punctuation">,</span>
                                       <span class="identifier">power_iteration_normalizer</span><span class="arithmetic-assignment">=</span><span class="identifier">pm</span><span class="punctuation">,</span>
                                       <span class="identifier">n_oversamples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_oversamples</span><span class="grouping">)</span>
            <span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"sklearn - %s"</span> <span class="arithmetic-operator">%</span> <span class="identifier">pm</span>
            <span class="identifier">all_time</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">time</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
                <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">all_spectral</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span>
                    <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">X_spectral_norm</span>
                <span class="grouping">)</span>
            <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scalable_frobenius_norm_discrepancy</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="grouping">)</span>
            <span class="identifier">all_frobenius</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">f</span> <span class="arithmetic-operator">/</span> <span class="identifier">X_fro_norm</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">fbpca_available</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"n_iter = %d on fbca"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">pi</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="punctuation">,</span> <span class="identifier">time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd_timing</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_comps</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">pi</span><span class="punctuation">,</span>
                                       <span class="identifier">power_iteration_normalizer</span><span class="arithmetic-assignment">=</span><span class="identifier">pm</span><span class="punctuation">,</span>
                                       <span class="identifier">n_oversamples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_oversamples</span><span class="punctuation">,</span>
                                       <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'fbpca'</span><span class="grouping">)</span>
            <span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"fbpca"</span>
            <span class="identifier">all_time</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">time</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
                <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">all_spectral</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span>
                    <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">X_spectral_norm</span>
                <span class="grouping">)</span>
            <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scalable_frobenius_norm_discrepancy</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="grouping">)</span>
            <span class="identifier">all_frobenius</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">f</span> <span class="arithmetic-operator">/</span> <span class="identifier">X_fro_norm</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
        <span class="identifier">title</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"%s: spectral norm diff vs running time"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">dataset_name</span><span class="grouping">)</span>
        <span class="identifier">plot_time_vs_s</span><span class="grouping">(</span><span class="identifier">all_time</span><span class="punctuation">,</span> <span class="identifier">all_spectral</span><span class="punctuation">,</span> <span class="identifier">power_iter</span><span class="punctuation">,</span> <span class="identifier">title</span><span class="grouping">)</span>
    <span class="identifier">title</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"%s: Frobenius norm diff vs running time"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">dataset_name</span><span class="grouping">)</span>
    <span class="identifier">plot_time_vs_s</span><span class="grouping">(</span><span class="identifier">all_time</span><span class="punctuation">,</span> <span class="identifier">all_frobenius</span><span class="punctuation">,</span> <span class="identifier">power_iter</span><span class="punctuation">,</span> <span class="identifier">title</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">bench_b</span><span class="grouping">(</span><span class="identifier">power_list</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">10000</span>
    <span class="identifier">data_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'n_samples': n_samples, 'n_features'</span><span class="punctuation">:</span> <span class="identifier">n_features</span><span class="punctuation">,</span>
                   <span class="string-literal">'tail_strength': .7, 'random_state'</span><span class="punctuation">:</span> <span class="identifier">random_state</span><span class="grouping">}</span>
    <span class="identifier">dataset_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"low rank matrix %d x %d"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">ranks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
        <span class="identifier">all_spectral</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">)</span>
    <span class="identifier">all_frobenius</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">rank</span> <span class="relational-operator">in</span> <span class="identifier">ranks</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_low_rank_matrix</span><span class="grouping">(</span><span class="identifier">effective_rank</span><span class="arithmetic-assignment">=</span><span class="identifier">rank</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">data_params</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
            <span class="identifier">X_spectral_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">msg</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">X_fro_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'fro'</span><span class="punctuation">,</span> <span class="identifier">msg</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">n_comp</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">rank</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">rank</span><span class="punctuation">,</span> <span class="identifier">rank</span><span class="arithmetic-operator">*</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"rank=%d, n_comp=%d"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">rank</span><span class="punctuation">,</span> <span class="identifier">n_comp</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">label</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">pi</span> <span class="relational-operator">in</span> <span class="identifier">power_list</span><span class="punctuation">:</span>
                <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd_timing</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_comp</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">pi</span><span class="punctuation">,</span> <span class="identifier">n_oversamples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                        <span class="identifier">power_iteration_normalizer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'LU'</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
                    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">)</span><span class="grouping">)</span>
                    <span class="identifier">all_spectral</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span>
                        <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span>
                        <span class="identifier">X_spectral_norm</span>
                    <span class="grouping">)</span>
                <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scalable_frobenius_norm_discrepancy</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="grouping">)</span>
                <span class="identifier">all_frobenius</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">f</span> <span class="arithmetic-operator">/</span> <span class="identifier">X_fro_norm</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
        <span class="identifier">title</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"%s: spectral norm diff vs n power iteration"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">dataset_name</span><span class="grouping">)</span>
        <span class="identifier">plot_power_iter_vs_s</span><span class="grouping">(</span><span class="identifier">power_iter</span><span class="punctuation">,</span> <span class="identifier">all_spectral</span><span class="punctuation">,</span> <span class="identifier">title</span><span class="grouping">)</span>
    <span class="identifier">title</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"%s: Frobenius norm diff vs n power iteration"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">dataset_name</span><span class="grouping">)</span>
    <span class="identifier">plot_power_iter_vs_s</span><span class="grouping">(</span><span class="identifier">power_iter</span><span class="punctuation">,</span> <span class="identifier">all_frobenius</span><span class="punctuation">,</span> <span class="identifier">title</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">bench_c</span><span class="grouping">(</span><span class="identifier">datasets</span><span class="punctuation">,</span> <span class="identifier">n_comps</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">all_time</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
        <span class="identifier">all_spectral</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">)</span>
    <span class="identifier">all_frobenius</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">dataset_name</span> <span class="relational-operator">in</span> <span class="identifier">datasets</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_data</span><span class="grouping">(</span><span class="identifier">dataset_name</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">X</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">continue</span>

        <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
            <span class="identifier">X_spectral_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">msg</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">X_fro_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'fro'</span><span class="punctuation">,</span> <span class="identifier">msg</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">n_comps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">n_comps</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"sklearn"</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"%s %d x %d - %s"</span> <span class="arithmetic-operator">%</span>
              <span class="grouping">(</span><span class="identifier">dataset_name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="punctuation">,</span> <span class="identifier">time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd_timing</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_comps</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_oversamples</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                   <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">label</span><span class="grouping">)</span>

        <span class="identifier">all_time</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">time</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
            <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">all_spectral</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span>
                <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">X_spectral_norm</span>
            <span class="grouping">)</span>
        <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scalable_frobenius_norm_discrepancy</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="grouping">)</span>
        <span class="identifier">all_frobenius</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">f</span> <span class="arithmetic-operator">/</span> <span class="identifier">X_fro_norm</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">fbpca_available</span><span class="punctuation">:</span>
            <span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"fbpca"</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"%s %d x %d - %s"</span> <span class="arithmetic-operator">%</span>
                  <span class="grouping">(</span><span class="identifier">dataset_name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="punctuation">,</span> <span class="identifier">time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd_timing</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_comps</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_oversamples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                       <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">label</span><span class="grouping">)</span>
            <span class="identifier">all_time</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">time</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
                <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">all_spectral</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span>
                    <span class="identifier">norm_diff</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">X_spectral_norm</span>
                <span class="grouping">)</span>
            <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scalable_frobenius_norm_discrepancy</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="grouping">)</span>
            <span class="identifier">all_frobenius</span><span class="grouping">[</span><span class="identifier">label</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">f</span> <span class="arithmetic-operator">/</span> <span class="identifier">X_fro_norm</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">all_time</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"No tests ran. Aborting."</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">enable_spectral_norm</span><span class="punctuation">:</span>
        <span class="identifier">title</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"normalized spectral norm diff vs running time"</span>
        <span class="identifier">scatter_time_vs_s</span><span class="grouping">(</span><span class="identifier">all_time</span><span class="punctuation">,</span> <span class="identifier">all_spectral</span><span class="punctuation">,</span> <span class="identifier">datasets</span><span class="punctuation">,</span> <span class="identifier">title</span><span class="grouping">)</span>
    <span class="identifier">title</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"normalized Frobenius norm diff vs running time"</span>
    <span class="identifier">scatter_time_vs_s</span><span class="grouping">(</span><span class="identifier">all_time</span><span class="punctuation">,</span> <span class="identifier">all_frobenius</span><span class="punctuation">,</span> <span class="identifier">datasets</span><span class="punctuation">,</span> <span class="identifier">title</span><span class="grouping">)</span>


<span class="keyword">if</span> <span class="identifier">__name__</span> <span class="relational-operator">==</span> <span class="string-literal">'__main__'</span><span class="punctuation">:</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">1234</span><span class="grouping">)</span>

    <span class="identifier">power_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">n_comps</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span>

    <span class="keyword">for</span> <span class="identifier">dataset_name</span> <span class="relational-operator">in</span> <span class="identifier">datasets</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_data</span><span class="grouping">(</span><span class="identifier">dataset_name</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">X</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">continue</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">" &gt;&gt;&gt;&gt;&gt;&gt; Benching sklearn and fbpca on %s %d x %d"</span> <span class="arithmetic-operator">%</span>
              <span class="grouping">(</span><span class="identifier">dataset_name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">bench_a</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dataset_name</span><span class="punctuation">,</span> <span class="identifier">power_iter</span><span class="punctuation">,</span> <span class="identifier">n_oversamples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                <span class="identifier">n_comps</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">n_comps</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">" &gt;&gt;&gt;&gt;&gt;&gt; Benching on simulated low rank matrix with variable rank"</span><span class="grouping">)</span>
    <span class="identifier">bench_b</span><span class="grouping">(</span><span class="identifier">power_iter</span><span class="grouping">)</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">" &gt;&gt;&gt;&gt;&gt;&gt; Benching sklearn and fbpca default configurations"</span><span class="grouping">)</span>
    <span class="identifier">bench_c</span><span class="grouping">(</span><span class="identifier">datasets</span> <span class="arithmetic-operator">+</span> <span class="identifier">big_sparse_datasets</span><span class="punctuation">,</span> <span class="identifier">n_comps</span><span class="grouping">)</span>

    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>