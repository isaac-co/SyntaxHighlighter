<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Custom Initializers for faceswap.py """</span>

<span class="keyword">import</span> <span class="identifier">logging</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">inspect</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">tensorflow</span> <span class="keyword">as</span> <span class="identifier">tf</span>
<span class="keyword">from</span> <span class="identifier">keras</span> <span class="keyword">import</span> <span class="identifier">backend</span> <span class="keyword">as</span> <span class="identifier">K</span>
<span class="keyword">from</span> <span class="identifier">keras</span> <span class="keyword">import</span> <span class="identifier">initializers</span>
<span class="keyword">from</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_custom_objects</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_backend</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>


<span class="keyword">def</span> <span class="identifier">compute_fans</span><span class="grouping">(</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">data_format</span><span class="arithmetic-assignment">=</span><span class="string-literal">'channels_last'</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Computes the number of input and output units for a weight shape.

    Ported directly from Keras as the location moves between keras and tensorflow-keras

    Parameters
    ----------
    shape: tuple
        shape tuple of integers
    data_format: str
        Image data format to use for convolution kernels. Note that all kernels in Keras are
        standardized on the `"channels_last"` ordering (even when inputs are set to
        `"channels_first"`).

    Returns
    -------
    tuple
            A tuple of scalars, `(fan_in, fan_out)`.

    Raises
    ------
    ValueError
        In case of invalid `data_format` argument.
    """</span>
    <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="punctuation">:</span>
        <span class="identifier">fan_in</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">fan_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">elif</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="grouping">{</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">}</span><span class="punctuation">:</span>
        <span class="comment"># Assuming convolution kernels (1D, 2D or 3D).</span>
        <span class="comment"># Theano kernel shape: (depth, input_depth, ...)</span>
        <span class="comment"># Tensorflow kernel shape: (..., input_depth, depth)</span>
        <span class="keyword">if</span> <span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_first'</span><span class="punctuation">:</span>
            <span class="identifier">receptive_field_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">prod</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">fan_in</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">receptive_field_size</span>
            <span class="identifier">fan_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">receptive_field_size</span>
        <span class="keyword">elif</span> <span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_last'</span><span class="punctuation">:</span>
            <span class="identifier">receptive_field_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">prod</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">fan_in</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">receptive_field_size</span>
            <span class="identifier">fan_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">receptive_field_size</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Invalid data_format: '</span> <span class="arithmetic-operator">+</span> <span class="identifier">data_format</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="comment"># No specific assumptions.</span>
        <span class="identifier">fan_in</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">prod</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">fan_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">prod</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">fan_in</span><span class="punctuation">,</span> <span class="identifier">fan_out</span>


<span class="keyword">class</span> <span class="identifier">ICNR</span><span class="grouping">(</span><span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">Initializer</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint: disable=invalid-name</span>
    <span class="comment">""" ICNR initializer for checkerboard artifact free sub pixel convolution

    Parameters
    ----------
    initializer: :class:`keras.initializers.Initializer`
        The initializer used for sub kernels (orthogonal, glorot uniform, etc.)
    scale: int, optional
        scaling factor of sub pixel convolution (up sampling from 8x8 to 16x16 is scale 2).
        Default: `2`

    Returns
    -------
    tensor
        The modified kernel weights

    Example
    -------
    &gt;&gt;&gt; x = conv2d(... weights_initializer=ICNR(initializer=he_uniform(), scale=2))

    References
    ----------
    Andrew Aitken et al. Checkerboard artifact free sub-pixel convolution
    https://arxiv.org/pdf/1707.02937.pdf,  https://distill.pub/2016/deconv-checkerboard/
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">initializer</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scale</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initializer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">initializer</span>

    <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"float32"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Call function for the ICNR initializer.

        Parameters
        ----------
        shape: tuple or list
            The required resized shape for the output tensor
        dtype: str
            The data type for the tensor

        Returns
        -------
        tensor
            The modified kernel weights
        """</span>
        <span class="identifier">shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initializer</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="identifier">new_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initializer</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initializer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">deserialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initializer</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initializer</span><span class="grouping">(</span><span class="identifier">new_shape</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">permute_dimensions</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">resize_images</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span>
                                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span><span class="punctuation">,</span>
                                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span><span class="punctuation">,</span>
                                <span class="string-literal">"channels_last"</span><span class="punctuation">,</span>
                                <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"nearest"</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_space_to_depth</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">permute_dimensions</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Output shape: %s"</span><span class="punctuation">,</span> <span class="identifier">var_x</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">var_x</span>

    <span class="keyword">def</span> <span class="identifier">_space_to_depth</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_tensor</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Space to depth implementation.

        PlaidML does not have a space to depth operation, so calculate if backend is amd
        otherwise returns the :func:`tensorflow.space_to_depth` operation.

        Parameters
        ----------
        input_tensor: tensor
            The tensor to be manipulated

        Returns
        -------
        tensor
            The manipulated input tensor
        """</span>
        <span class="keyword">if</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"amd"</span><span class="punctuation">:</span>
            <span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">depth</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_tensor</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">.</span><span class="identifier">dims</span>
            <span class="identifier">new_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">height</span> <span class="arithmetic-operator">//</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span>
            <span class="identifier">new_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">width</span> <span class="arithmetic-operator">//</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span>
            <span class="identifier">reshaped</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">input_tensor</span><span class="punctuation">,</span>
                                 <span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">new_height</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span><span class="punctuation">,</span> <span class="identifier">new_width</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span><span class="punctuation">,</span> <span class="identifier">depth</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">permute_dimensions</span><span class="grouping">(</span><span class="identifier">reshaped</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                               <span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">new_height</span><span class="punctuation">,</span> <span class="identifier">new_width</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">space_to_depth</span><span class="grouping">(</span><span class="identifier">input_tensor</span><span class="punctuation">,</span> <span class="identifier">block_size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span><span class="punctuation">,</span> <span class="identifier">data_format</span><span class="arithmetic-assignment">=</span><span class="string-literal">"NHWC"</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Input shape: %s, Output shape: %s"</span><span class="punctuation">,</span> <span class="identifier">input_tensor</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return the ICNR Initializer configuration.

        Returns
        -------
        dict
            The configuration for ICNR Initialization
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"scale"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span><span class="punctuation">,</span>
                  <span class="string-literal">"initializer"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initializer</span>
                  <span class="grouping">}</span>
        <span class="identifier">base_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="identifier">ICNR</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">base_config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">ConvolutionAware</span><span class="grouping">(</span><span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">Initializer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Initializer that generates orthogonal convolution filters in the Fourier space. If this
    initializer is passed a shape that is not 3D or 4D, orthogonal initialization will be used.

    Adapted, fixed and optimized from:
    https://github.com/keras-team/keras-contrib/blob/master/keras_contrib/initializers/convaware.py

    Parameters
    ----------
    eps_std: float, optional
        The Standard deviation for the random normal noise used to break symmetry in the inverse
        Fourier transform. Default: 0.05
    seed: int, optional
        Used to seed the random generator. Default: ``None``
    initialized: bool, optional
        This should always be set to ``False``. To avoid Keras re-calculating the values every time
        the model is loaded, this parameter is internally set on first time initialization.
        Default:``False``

    Returns
    -------
    tensor
        The modified kernel weights

    References
    ----------
    Armen Aghajanyan, https://arxiv.org/abs/1702.06295
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">eps_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">initialized</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">eps_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">eps_std</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">seed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">seed</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">orthogonal</span> <span class="arithmetic-assignment">=</span> <span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">Orthogonal</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">he_uniform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">he_uniform</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initialized</span> <span class="arithmetic-assignment">=</span> <span class="identifier">initialized</span>

    <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Call function for the ICNR initializer.

        Parameters
        ----------
        shape: tuple or list
            The required shape for the output tensor
        dtype: str
            The data type for the tensor

        Returns
        -------
        tensor
            The modified kernel weights
        """</span>
        <span class="comment"># TODO Tensorflow appears to pass in a :class:`tensorflow.python.framework.dtypes.DType`</span>
        <span class="comment"># object which causes this to error, so currently just reverts to default dtype if a string</span>
        <span class="comment"># is not passed in.</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initialized</span><span class="punctuation">:</span>   <span class="comment"># Avoid re-calculating initializer when loading a saved model</span>
            <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">he_uniform</span><span class="grouping">(</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">floatx</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">dtype</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Calculating Convolution Aware Initializer for shape: %s"</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="grouping">)</span>
        <span class="identifier">rank</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">seed</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">seed</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">seed</span><span class="grouping">)</span>

        <span class="identifier">fan_in</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_fans</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span>  <span class="comment"># pylint:disable=protected-access</span>
        <span class="identifier">variance</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">/</span> <span class="identifier">fan_in</span>

        <span class="keyword">if</span> <span class="identifier">rank</span> <span class="relational-operator">==</span> <span class="int-literal">3</span><span class="punctuation">:</span>
            <span class="identifier">row</span><span class="punctuation">,</span> <span class="identifier">stack_size</span><span class="punctuation">,</span> <span class="identifier">filters_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span>

            <span class="identifier">transpose_dimensions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">kernel_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">row</span><span class="punctuation">,</span><span class="grouping">)</span>
            <span class="identifier">correct_ifft</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span> <span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="none-literal">None</span><span class="grouping">]</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fft</span><span class="punctuation">.</span><span class="identifier">irfft</span><span class="grouping">(</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>  <span class="comment"># noqa</span>
            <span class="identifier">correct_fft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fft</span><span class="punctuation">.</span><span class="identifier">rfft</span>

        <span class="keyword">elif</span> <span class="identifier">rank</span> <span class="relational-operator">==</span> <span class="int-literal">4</span><span class="punctuation">:</span>
            <span class="identifier">row</span><span class="punctuation">,</span> <span class="identifier">column</span><span class="punctuation">,</span> <span class="identifier">stack_size</span><span class="punctuation">,</span> <span class="identifier">filters_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span>

            <span class="identifier">transpose_dimensions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">kernel_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">row</span><span class="punctuation">,</span> <span class="identifier">column</span><span class="grouping">)</span>
            <span class="identifier">correct_ifft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fft</span><span class="punctuation">.</span><span class="identifier">irfft2</span>
            <span class="identifier">correct_fft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fft</span><span class="punctuation">.</span><span class="identifier">rfft2</span>

        <span class="keyword">elif</span> <span class="identifier">rank</span> <span class="relational-operator">==</span> <span class="int-literal">5</span><span class="punctuation">:</span>
            <span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">var_y</span><span class="punctuation">,</span> <span class="identifier">var_z</span><span class="punctuation">,</span> <span class="identifier">stack_size</span><span class="punctuation">,</span> <span class="identifier">filters_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span>

            <span class="identifier">transpose_dimensions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
            <span class="identifier">kernel_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">var_y</span><span class="punctuation">,</span> <span class="identifier">var_z</span><span class="grouping">)</span>
            <span class="identifier">correct_fft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fft</span><span class="punctuation">.</span><span class="identifier">rfftn</span>
            <span class="identifier">correct_ifft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fft</span><span class="punctuation">.</span><span class="identifier">irfftn</span>

        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initialized</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
            <span class="keyword">return</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">variable</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">orthogonal</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>

        <span class="identifier">kernel_fourier_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">correct_fft</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">kernel_shape</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span>

        <span class="identifier">basis</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_create_basis</span><span class="grouping">(</span><span class="identifier">filters_size</span><span class="punctuation">,</span> <span class="identifier">stack_size</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">prod</span><span class="grouping">(</span><span class="identifier">kernel_fourier_shape</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">basis</span> <span class="arithmetic-assignment">=</span> <span class="identifier">basis</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">filters_size</span><span class="punctuation">,</span> <span class="identifier">stack_size</span><span class="punctuation">,</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">kernel_fourier_shape</span><span class="grouping">)</span>
        <span class="identifier">randoms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">eps_std</span><span class="punctuation">,</span> <span class="identifier">basis</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">kernel_shape</span><span class="grouping">)</span>
        <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">correct_ifft</span><span class="grouping">(</span><span class="identifier">basis</span><span class="punctuation">,</span> <span class="identifier">kernel_shape</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">randoms</span>
        <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scale_filters</span><span class="grouping">(</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">variance</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initialized</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="keyword">return</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">variable</span><span class="grouping">(</span><span class="identifier">init</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="identifier">transpose_dimensions</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv_aware"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_create_basis</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">filters_size</span><span class="punctuation">,</span> <span class="identifier">filters</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Create the basis for convolutional aware initialization """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"filters_size: %s, filters: %s, size: %s, dtype: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">filters_size</span><span class="punctuation">,</span> <span class="identifier">filters</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">size</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">eps_std</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">filters_size</span><span class="punctuation">,</span> <span class="identifier">filters</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">nbb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">filters</span> <span class="arithmetic-operator">//</span> <span class="identifier">size</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="identifier">var_a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">filters_size</span><span class="punctuation">,</span> <span class="identifier">nbb</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">var_a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_symmetrize</span><span class="grouping">(</span><span class="identifier">var_a</span><span class="grouping">)</span>
        <span class="identifier">var_u</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">svd</span><span class="grouping">(</span><span class="identifier">var_a</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">var_p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">var_u</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">filters_size</span><span class="punctuation">,</span> <span class="identifier">nbb</span> <span class="arithmetic-operator">*</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">filters</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">var_p</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_symmetrize</span><span class="grouping">(</span><span class="identifier">var_a</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Make the given tensor symmetrical. """</span>
        <span class="identifier">var_b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="identifier">var_a</span><span class="punctuation">,</span> <span class="identifier">axes</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">diag</span> <span class="arithmetic-assignment">=</span> <span class="identifier">var_a</span><span class="punctuation">.</span><span class="identifier">diagonal</span><span class="grouping">(</span><span class="identifier">axis1</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">axis2</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">var_c</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">arr</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">arr</span> <span class="relational-operator">in</span> <span class="identifier">batch</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">batch</span> <span class="relational-operator">in</span> <span class="identifier">diag</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">var_a</span> <span class="arithmetic-operator">+</span> <span class="identifier">var_b</span> <span class="arithmetic-operator">-</span> <span class="identifier">var_c</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_scale_filters</span><span class="grouping">(</span><span class="identifier">filters</span><span class="punctuation">,</span> <span class="identifier">variance</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Scale the given filters. """</span>
        <span class="identifier">c_var</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">filters</span><span class="grouping">)</span>
        <span class="identifier">var_p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">variance</span> <span class="arithmetic-operator">/</span> <span class="identifier">c_var</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">filters</span> <span class="arithmetic-operator">*</span> <span class="identifier">var_p</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return the Convolutional Aware Initializer configuration.

        Returns
        -------
        dict
            The configuration for ICNR Initialization
        """</span>
        <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">eps_std</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">eps_std</span><span class="punctuation">,</span>
                    <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">seed</span><span class="punctuation">,</span>
                    <span class="identifier">initialized</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initialized</span><span class="grouping">)</span>


<span class="comment"># Update initializers into Keras custom objects</span>
<span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">obj</span> <span class="relational-operator">in</span> <span class="identifier">inspect</span><span class="punctuation">.</span><span class="identifier">getmembers</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">modules</span><span class="grouping">[</span><span class="identifier">__name__</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">inspect</span><span class="punctuation">.</span><span class="identifier">isclass</span><span class="grouping">(</span><span class="identifier">obj</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">obj</span><span class="punctuation">.</span><span class="identifier">__module__</span> <span class="relational-operator">==</span> <span class="identifier">__name__</span><span class="punctuation">:</span>
        <span class="identifier">get_custom_objects</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">{</span><span class="identifier">name</span><span class="punctuation">:</span> <span class="identifier">obj</span><span class="grouping">}</span><span class="grouping">)</span>

    </pre>
  </body>
</html>