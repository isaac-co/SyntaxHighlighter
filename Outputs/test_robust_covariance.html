<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Author: Alexandre Gramfort &lt;alexandre.gramfort@inria.fr&gt;</span>
<span class="comment">#         Gael Varoquaux &lt;gael.varoquaux@normalesup.org&gt;</span>
<span class="comment">#         Virgile Fritsch &lt;virgile.fritsch@inria.fr&gt;</span>
<span class="comment">#</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">itertools</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">datasets</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">covariance</span> <span class="keyword">import</span> <span class="identifier">empirical_covariance</span><span class="punctuation">,</span> <span class="identifier">MinCovDet</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">covariance</span> <span class="keyword">import</span> <span class="identifier">fast_mcd</span>

<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span>
<span class="identifier">X_1d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
<span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>


<span class="keyword">def</span> <span class="identifier">test_mcd</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Tests the FastMCD algorithm implementation</span>
    <span class="comment"># Small data set</span>
    <span class="comment"># test without outliers (random independent normal data)</span>
    <span class="identifier">launch_mcd_on_dataset</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">80</span><span class="grouping">)</span>
    <span class="comment"># test with a contaminated data set (medium contamination)</span>
    <span class="identifier">launch_mcd_on_dataset</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="int-literal">70</span><span class="grouping">)</span>
    <span class="comment"># test with a contaminated data set (strong contamination)</span>
    <span class="identifier">launch_mcd_on_dataset</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">40</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span>

    <span class="comment"># Medium data set</span>
    <span class="identifier">launch_mcd_on_dataset</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">450</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">540</span><span class="grouping">)</span>

    <span class="comment"># Large data set</span>
    <span class="identifier">launch_mcd_on_dataset</span><span class="grouping">(</span><span class="int-literal">1700</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">800</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">870</span><span class="grouping">)</span>

    <span class="comment"># 1D data set</span>
    <span class="identifier">launch_mcd_on_dataset</span><span class="grouping">(</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="int-literal">350</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_fast_mcd_on_invalid_input</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Expected 2D array, got 1D array instead'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fast_mcd</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_mcd_class_on_invalid_input</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">mcd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MinCovDet</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Expected 2D array, got 1D array instead'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">mcd</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">launch_mcd_on_dataset</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_outliers</span><span class="punctuation">,</span> <span class="identifier">tol_loc</span><span class="punctuation">,</span> <span class="identifier">tol_cov</span><span class="punctuation">,</span>
                          <span class="identifier">tol_support</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">rand_gen</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_gen</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="comment"># add some outliers</span>
    <span class="identifier">outliers_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_gen</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_outliers</span><span class="grouping">]</span>
    <span class="identifier">outliers_offset</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="invalid">\</span>
        <span class="grouping">(</span><span class="identifier">rand_gen</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_outliers</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="float-literal">0.5</span><span class="grouping">)</span>
    <span class="identifier">data</span><span class="grouping">[</span><span class="identifier">outliers_index</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">outliers_offset</span>
    <span class="identifier">inliers_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">inliers_mask</span><span class="grouping">[</span><span class="identifier">outliers_index</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>

    <span class="identifier">pure_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="grouping">[</span><span class="identifier">inliers_mask</span><span class="grouping">]</span>
    <span class="comment"># compute MCD by fitting an object</span>
    <span class="identifier">mcd_fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MinCovDet</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rand_gen</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="identifier">T</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mcd_fit</span><span class="punctuation">.</span><span class="identifier">location_</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mcd_fit</span><span class="punctuation">.</span><span class="identifier">covariance_</span>
    <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mcd_fit</span><span class="punctuation">.</span><span class="identifier">support_</span>
    <span class="comment"># compare with the estimates learnt from the inliers</span>
    <span class="identifier">error_location</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">pure_data</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">T</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">assert</span><span class="grouping">(</span><span class="identifier">error_location</span> <span class="relational-operator">&lt;</span> <span class="identifier">tol_loc</span><span class="grouping">)</span>
    <span class="identifier">error_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">empirical_covariance</span><span class="grouping">(</span><span class="identifier">pure_data</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">S</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">assert</span><span class="grouping">(</span><span class="identifier">error_cov</span> <span class="relational-operator">&lt;</span> <span class="identifier">tol_cov</span><span class="grouping">)</span>
    <span class="keyword">assert</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">H</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="identifier">tol_support</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">mcd_fit</span><span class="punctuation">.</span><span class="identifier">mahalanobis</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">mcd_fit</span><span class="punctuation">.</span><span class="identifier">dist_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_mcd_issue1127</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that the code does not break with X.shape = (3, 1)</span>
    <span class="comment"># (i.e. n_support = n_samples)</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">mcd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MinCovDet</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">mcd</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_mcd_issue3367</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that MCD completes when the covariance matrix is singular</span>
    <span class="comment"># i.e. one of the rows and columns are all zeros</span>
    <span class="identifier">rand_gen</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Think of these as the values for X and Y -&gt; 10 values between -5 and 5</span>
    <span class="identifier">data_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="comment"># Get the cartesian product of all possible coordinate pairs from above set</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">itertools</span><span class="punctuation">.</span><span class="identifier">product</span><span class="grouping">(</span><span class="identifier">data_values</span><span class="punctuation">,</span> <span class="identifier">data_values</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Add a third column that's all zeros to make our data a set of point</span>
    <span class="comment"># within a plane, which means that the covariance matrix will be singular</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># The below line of code should raise an exception if the covariance matrix</span>
    <span class="comment"># is singular. As a further test, since we have points in XYZ, the</span>
    <span class="comment"># principle components (Eigenvectors) of these directly relate to the</span>
    <span class="comment"># geometry of the points. Since it's a plane, we should be able to test</span>
    <span class="comment"># that the Eigenvector that corresponds to the smallest Eigenvalue is the</span>
    <span class="comment"># plane normal, specifically [0, 0, 1], since everything is in the XY plane</span>
    <span class="comment"># (as I've set it up above). To do this one would start by:</span>
    <span class="comment">#</span>
    <span class="comment">#     evals, evecs = np.linalg.eigh(mcd_fit.covariance_)</span>
    <span class="comment">#     normal = evecs[:, np.argmin(evals)]</span>
    <span class="comment">#</span>
    <span class="comment"># After which we need to assert that our `normal` is equal to [0, 0, 1].</span>
    <span class="comment"># Do note that there is floating point error associated with this, so it's</span>
    <span class="comment"># best to subtract the two and then compare some small tolerance (e.g.</span>
    <span class="comment"># 1e-12).</span>
    <span class="identifier">MinCovDet</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rand_gen</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_mcd_support_covariance_is_zero</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that MCD returns a ValueError with informative message when the</span>
    <span class="comment"># covariance of the support data is equal to 0.</span>
    <span class="identifier">X_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.957</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.4285</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_1</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.957</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.4285</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_2</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'The covariance matrix of the support data is equal to 0, try to '</span>
           <span class="string-literal">'increase support_fraction'</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">X</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">X_1</span><span class="punctuation">,</span> <span class="identifier">X_2</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">MinCovDet</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_mcd_increasing_det_warning</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that a warning is raised if we observe increasing determinants</span>
    <span class="comment"># during the c_step. In theory the sequence of determinants should be</span>
    <span class="comment"># decreasing. Increasing determinants are likely due to ill-conditioned</span>
    <span class="comment"># covariance matrices that result in poor precision matrices.</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">5.1</span><span class="punctuation">,</span> <span class="float-literal">3.5</span><span class="punctuation">,</span> <span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">4.9</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="punctuation">,</span> <span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">4.7</span><span class="punctuation">,</span> <span class="float-literal">3.2</span><span class="punctuation">,</span> <span class="float-literal">1.3</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">4.6</span><span class="punctuation">,</span> <span class="float-literal">3.1</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">5.0</span><span class="punctuation">,</span> <span class="float-literal">3.6</span><span class="punctuation">,</span> <span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">4.6</span><span class="punctuation">,</span> <span class="float-literal">3.4</span><span class="punctuation">,</span> <span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">5.0</span><span class="punctuation">,</span> <span class="float-literal">3.4</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">4.4</span><span class="punctuation">,</span> <span class="float-literal">2.9</span><span class="punctuation">,</span> <span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">4.9</span><span class="punctuation">,</span> <span class="float-literal">3.1</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">5.4</span><span class="punctuation">,</span> <span class="float-literal">3.7</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">4.8</span><span class="punctuation">,</span> <span class="float-literal">3.4</span><span class="punctuation">,</span> <span class="float-literal">1.6</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">4.8</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="punctuation">,</span> <span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">4.3</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="punctuation">,</span> <span class="float-literal">1.1</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">5.1</span><span class="punctuation">,</span> <span class="float-literal">3.5</span><span class="punctuation">,</span> <span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">5.7</span><span class="punctuation">,</span> <span class="float-literal">3.8</span><span class="punctuation">,</span> <span class="float-literal">1.7</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">5.4</span><span class="punctuation">,</span> <span class="float-literal">3.4</span><span class="punctuation">,</span> <span class="float-literal">1.7</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">4.6</span><span class="punctuation">,</span> <span class="float-literal">3.6</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">5.0</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="punctuation">,</span> <span class="float-literal">1.6</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">5.2</span><span class="punctuation">,</span> <span class="float-literal">3.5</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">mcd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MinCovDet</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">warn_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Determinant has increased"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">RuntimeWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warn_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">mcd</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    </pre>
  </body>
</html>