<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Test the stacking classifier and regressor."""</span>

<span class="comment"># Authors: Guillaume Lemaitre &lt;g.lemaitre58@gmail.com&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">as</span> <span class="identifier">sparse</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">M</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">i</span><span class="invalid">n</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">RegressorMixin</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">clone</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_iris</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_diabetes</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_breast_cancer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_regression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">dummy</span> <span class="keyword">import</span> <span class="identifier">DummyClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">dummy</span> <span class="keyword">import</span> <span class="identifier">DummyRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LogisticRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LinearRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">LinearSVC</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">LinearSVR</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">SVC</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">RandomForestClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">RandomForestRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">scale</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">StackingClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">StackingRegressor</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">StratifiedKFold</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">KFold</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_mocking</span> <span class="keyword">import</span> <span class="identifier">CheckingClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>

<span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_diabetes</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="identifier">X_iris</span><span class="punctuation">,</span> <span class="identifier">y_iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"cv"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">StratifiedKFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"final_estimator"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"passthrough"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_classifier_iris</span><span class="grouping">(</span><span class="identifier">cv</span><span class="punctuation">,</span> <span class="identifier">final_estimator</span><span class="punctuation">,</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># prescale the data to avoid convergence warning without using a pipeline</span>
    <span class="comment"># for later assert</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_iris</span><span class="punctuation">,</span> <span class="identifier">stratify</span><span class="arithmetic-assignment">=</span><span class="identifier">y_iris</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span>
    <span class="grouping">)</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr', LogisticRegression()), ('svc'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingClassifier</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">estimators</span><span class="punctuation">,</span> <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">final_estimator</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="punctuation">,</span>
        <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span>
    <span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.8</span>

    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">expected_column_count</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span> <span class="keyword">if</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span> <span class="keyword">else</span> <span class="int-literal">6</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected_column_count</span>
    <span class="keyword">if</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">X_trans</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">lr</span><span class="arithmetic-assignment">=</span><span class="string-literal">'drop'</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">final_estimator</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="comment"># LogisticRegression has decision_function method</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">expected_column_count_drop</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">7</span> <span class="keyword">if</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span> <span class="keyword">else</span> <span class="int-literal">3</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected_column_count_drop</span>
    <span class="keyword">if</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">X_trans</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_stacking_classifier_drop_column_binary_classification</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that a column is dropped in binary classification</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_breast_cancer</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">stratify</span><span class="arithmetic-assignment">=</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span>
    <span class="grouping">)</span>

    <span class="comment"># both classifiers implement 'predict_proba' and will both drop one column</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="grouping">(</span><span class="string-literal">'rf'</span><span class="punctuation">,</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingClassifier</span><span class="grouping">(</span><span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">estimators</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>

    <span class="comment"># LinearSVC does not implement 'predict_proba' and will not drop one column</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr', LogisticRegression()), ('svc'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">estimators</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>


<span class="keyword">def</span> <span class="identifier">test_stacking_classifier_drop_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># prescale the data to avoid convergence warning without using a pipeline</span>
    <span class="comment"># for later assert</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_iris</span><span class="punctuation">,</span> <span class="identifier">stratify</span><span class="arithmetic-assignment">=</span><span class="identifier">y_iris</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span>
    <span class="grouping">)</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr', 'drop'), ('svc'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">rf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingClassifier</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'svc'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">rf</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span>
    <span class="grouping">)</span>
    <span class="identifier">clf_drop</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingClassifier</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">estimators</span><span class="punctuation">,</span> <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">rf</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span>
    <span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">clf_drop</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">clf_drop</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">clf_drop</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">clf_drop</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_stacking_regressor_drop_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># prescale the data to avoid convergence warning without using a pipeline</span>
    <span class="comment"># for later assert</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span>
    <span class="grouping">)</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr', 'drop'), ('svr'</span><span class="punctuation">,</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">rf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestRegressor</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingRegressor</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'svr'</span><span class="punctuation">,</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">rf</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span>
    <span class="grouping">)</span>
    <span class="identifier">reg_drop</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingRegressor</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">estimators</span><span class="punctuation">,</span> <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">rf</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span>
    <span class="grouping">)</span>

    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">reg_drop</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">reg_drop</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">reg_drop</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"cv"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"final_estimator, predict_params"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">RandomForestRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">DummyRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'return_std'</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"passthrough"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_regressor_diabetes</span><span class="grouping">(</span><span class="identifier">cv</span><span class="punctuation">,</span> <span class="identifier">final_estimator</span><span class="punctuation">,</span> <span class="identifier">predict_params</span><span class="punctuation">,</span>
                                     <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># prescale the data to avoid convergence warning without using a pipeline</span>
    <span class="comment"># for later assert</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span>
    <span class="grouping">)</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr', LinearRegression()), ('svr'</span><span class="punctuation">,</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingRegressor</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">estimators</span><span class="punctuation">,</span> <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">final_estimator</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="punctuation">,</span>
        <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span>
    <span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">predict_params</span><span class="grouping">)</span>
    <span class="identifier">expected_result_length</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="keyword">if</span> <span class="identifier">predict_params</span> <span class="keyword">else</span> <span class="int-literal">1</span>
    <span class="keyword">if</span> <span class="identifier">predict_params</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">result</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected_result_length</span>

    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">expected_column_count</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">12</span> <span class="keyword">if</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span> <span class="keyword">else</span> <span class="int-literal">2</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected_column_count</span>
    <span class="keyword">if</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">X_trans</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">lr</span><span class="arithmetic-assignment">=</span><span class="string-literal">'drop'</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">expected_column_count_drop</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">11</span> <span class="keyword">if</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span> <span class="keyword">else</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected_column_count_drop</span>
    <span class="keyword">if</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">X_trans</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'fmt', ['csc', 'csr', 'coo'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_regressor_sparse_passthrough</span><span class="grouping">(</span><span class="identifier">fmt</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check passthrough behavior on a sparse X matrix</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="grouping">(</span><span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">fmt</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">y_diabetes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span>
    <span class="grouping">)</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr', LinearRegression()), ('svr'</span><span class="punctuation">,</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">rf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestRegressor</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingRegressor</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">estimators</span><span class="punctuation">,</span> <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">rf</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span>
    <span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">X_trans</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_test</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'fmt', ['csc', 'csr', 'coo'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_classifier_sparse_passthrough</span><span class="grouping">(</span><span class="identifier">fmt</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check passthrough behavior on a sparse X matrix</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="grouping">(</span><span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">fmt</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">y_iris</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span>
    <span class="grouping">)</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr', LogisticRegression()), ('svc'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">rf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingClassifier</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">estimators</span><span class="punctuation">,</span> <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">rf</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span>
    <span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">X_trans</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_test</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span>


<span class="keyword">def</span> <span class="identifier">test_stacking_classifier_drop_binary_prob</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that classifier will drop one of the probability column for</span>
    <span class="comment"># binary classification problem</span>

    <span class="comment"># Select only the 2 first classes</span>
    <span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">100</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_iris</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">100</span><span class="grouping">]</span>

    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'lr', LogisticRegression()), ('rf'</span><span class="punctuation">,</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingClassifier</span><span class="grouping">(</span><span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">estimators</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>
    <span class="identifier">X_meta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_meta</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>


<span class="keyword">class</span> <span class="identifier">NoWeightRegressor</span><span class="grouping">(</span><span class="identifier">RegressorMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DummyRegressor</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">NoWeightClassifier</span><span class="grouping">(</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">M</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">i</span><span class="invalid">n</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DummyClassifier</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'stratified'</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"y, params, type_err, msg_err"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">y_iris</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'estimators'</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="string-literal">"Invalid 'estimators' attribute,"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">y_iris</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'estimators'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="string-literal">"Invalid 'estimators' attribute,"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">y_iris</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'estimators': [('lr'</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="string-literal">'svm'</span><span class="punctuation">,</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="float-literal">5e4</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
       <span class="string-literal">'stack_method': 'predict_proba'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="string-literal">'does not implement the method predict_proba'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">y_iris</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'estimators': [('lr'</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="string-literal">'cor'</span><span class="punctuation">,</span> <span class="identifier">NoWeightClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="string-literal">'does not support sample weight'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">y_iris</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'estimators': [('lr'</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="string-literal">'cor'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="float-literal">5e4</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
       <span class="string-literal">'final_estimator'</span><span class="punctuation">:</span> <span class="identifier">NoWeightClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="string-literal">'does not support sample weight'</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_classifier_error</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">type_err</span><span class="punctuation">,</span> <span class="identifier">msg_err</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">type_err</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg_err</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingClassifier</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span>
            <span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"y, params, type_err, msg_err"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">y_diabetes</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'estimators'</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="string-literal">"Invalid 'estimators' attribute,"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">y_diabetes</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'estimators'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="string-literal">"Invalid 'estimators' attribute,"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">y_diabetes</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'estimators': [('lr'</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="string-literal">'cor'</span><span class="punctuation">,</span> <span class="identifier">NoWeightRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="string-literal">'does not support sample weight'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">y_diabetes</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'estimators': [('lr'</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="string-literal">'cor'</span><span class="punctuation">,</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
       <span class="string-literal">'final_estimator'</span><span class="punctuation">:</span> <span class="identifier">NoWeightRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="string-literal">'does not support sample weight'</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_regressor_error</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">type_err</span><span class="punctuation">,</span> <span class="identifier">msg_err</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">type_err</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg_err</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingRegressor</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span>
            <span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"estimator, X, y"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">StackingClassifier</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">(</span><span class="string-literal">'svm'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">X_iris</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">100</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_iris</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">100</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># keep only classes 0 and 1</span>
     <span class="grouping">(</span><span class="identifier">StackingRegressor</span><span class="grouping">(</span>
         <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                     <span class="grouping">(</span><span class="string-literal">'svm'</span><span class="punctuation">,</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'StackingClassifier', 'StackingRegressor'</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_randomness</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># checking that fixing the random state of the CV will lead to the same</span>
    <span class="comment"># results</span>
    <span class="identifier">estimator_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">estimator_full</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span>
        <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">)</span>

    <span class="identifier">estimator_drop</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">estimator_drop</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">lr</span><span class="arithmetic-assignment">=</span><span class="string-literal">'drop'</span><span class="grouping">)</span>
    <span class="identifier">estimator_drop</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span>
        <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
        <span class="identifier">estimator_full</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">estimator_drop</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_stacking_classifier_stratify_default</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that we stratify the classes for the default CV</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingClassifier</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e4</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">(</span><span class="string-literal">'svm'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e4</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="grouping">)</span>
    <span class="comment"># since iris is not shuffled, a simple k-fold would not contain the</span>
    <span class="comment"># 3 classes during training</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="punctuation">,</span> <span class="identifier">y_iris</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"stacker, X, y"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">StackingClassifier</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">(</span><span class="string-literal">'svm'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="arithmetic-operator">*</span><span class="identifier">load_breast_cancer</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">StackingRegressor</span><span class="grouping">(</span>
         <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                     <span class="grouping">(</span><span class="string-literal">'svm'</span><span class="punctuation">,</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'StackingClassifier', 'StackingRegressor'</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_with_sample_weight</span><span class="grouping">(</span><span class="identifier">stacker</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that sample weights has an influence on the fitting</span>
    <span class="comment"># note: ConvergenceWarning are catch since we are not worrying about the</span>
    <span class="comment"># convergence here</span>
    <span class="identifier">n_half_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>
    <span class="identifier">total_sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="float-literal">0.1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_half_samples</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="float-literal">0.9</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_half_samples</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">sample_weight_train</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">total_sample_weight</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span>
    <span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">stacker</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">y_pred_no_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stacker</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">stacker</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y_pred_unit_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stacker</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_pred_no_weight</span><span class="punctuation">,</span> <span class="identifier">y_pred_unit_weight</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">stacker</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight_train</span><span class="grouping">)</span>
    <span class="identifier">y_pred_biased</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stacker</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y_pred_no_weight</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_pred_biased</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>


<span class="keyword">def</span> <span class="identifier">test_stacking_classifier_sample_weight_fit_param</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check sample_weight is passed to all invocations of fit</span>
    <span class="identifier">stacker</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingClassifier</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span>
            <span class="grouping">(</span><span class="string-literal">'lr', CheckingClassifier(expected_fit_params=['sample_weight'</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">CheckingClassifier</span><span class="grouping">(</span>
            <span class="identifier">expected_fit_params</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'sample_weight'</span><span class="grouping">]</span>
        <span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">stacker</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="punctuation">,</span> <span class="identifier">y_iris</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore::sklearn.exceptions.ConvergenceWarning"</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"stacker, X, y"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">StackingClassifier</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">(</span><span class="string-literal">'svm'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="arithmetic-operator">*</span><span class="identifier">load_breast_cancer</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">StackingRegressor</span><span class="grouping">(</span>
         <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                     <span class="grouping">(</span><span class="string-literal">'svm'</span><span class="punctuation">,</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'StackingClassifier', 'StackingRegressor'</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_cv_influence</span><span class="grouping">(</span><span class="identifier">stacker</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that the stacking affects the fit of the final estimator but not</span>
    <span class="comment"># the fit of the base estimators</span>
    <span class="comment"># note: ConvergenceWarning are catch since we are not worrying about the</span>
    <span class="comment"># convergence here</span>
    <span class="identifier">stacker_cv_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">stacker</span><span class="grouping">)</span>
    <span class="identifier">stacker_cv_5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">stacker</span><span class="grouping">)</span>

    <span class="identifier">stacker_cv_3</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">stacker_cv_5</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>

    <span class="identifier">stacker_cv_3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">stacker_cv_5</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># the base estimators should be identical</span>
    <span class="keyword">for</span> <span class="identifier">est_cv_3</span><span class="punctuation">,</span> <span class="identifier">est_cv_5</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">stacker_cv_3</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="punctuation">,</span>
                                  <span class="identifier">stacker_cv_5</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">est_cv_3</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">est_cv_5</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>

    <span class="comment"># the final estimator should be different</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Not equal'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">stacker_cv_3</span><span class="punctuation">.</span><span class="identifier">final_estimator_</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span>
                        <span class="identifier">stacker_cv_5</span><span class="punctuation">.</span><span class="identifier">final_estimator_</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"make_dataset, Stacking, Estimator"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">make_classification</span><span class="punctuation">,</span> <span class="identifier">StackingClassifier</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">make_regression</span><span class="punctuation">,</span> <span class="identifier">StackingRegressor</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_without_n_features_in</span><span class="grouping">(</span><span class="identifier">make_dataset</span><span class="punctuation">,</span> <span class="identifier">Stacking</span><span class="punctuation">,</span> <span class="identifier">Estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Stacking supports estimators without `n_features_in_`. Regression test</span>
    <span class="comment"># for #17353</span>

    <span class="keyword">class</span> <span class="identifier">MyEstimator</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Estimator without n_features_in_"""</span>
        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="keyword">del</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_dataset</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">stacker</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Stacking</span><span class="grouping">(</span><span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span> <span class="identifier">MyEstimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="string-literal">"{Stacking.__name__} object has no attribute n_features_in_"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">stacker</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span>

    <span class="comment"># Does not raise</span>
    <span class="identifier">stacker</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"'MyEstimator' object has no attribute 'n_features_in_'"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">stacker</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span>

    </pre>
  </body>
</html>