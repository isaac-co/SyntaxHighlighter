<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Univariate features selection."""</span>

<span class="comment"># Authors: V. Michel, B. Thirion, G. Varoquaux, A. Gramfort, E. Duchesnay.</span>
<span class="comment">#          L. Buitinck, A. Joly</span>
<span class="comment"># License: BSD 3 clause</span>


<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">warnings</span>

<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">special</span><span class="punctuation">,</span> <span class="identifier">stats</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">issparse</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">LabelBinarizer</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="punctuation">,</span> <span class="identifier">check_array</span><span class="punctuation">,</span> <span class="identifier">check_X_y</span><span class="punctuation">,</span> <span class="identifier">safe_sqr</span><span class="punctuation">,</span>
                     <span class="identifier">safe_mask</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">extmath</span> <span class="keyword">import</span> <span class="identifier">safe_sparse_dot</span><span class="punctuation">,</span> <span class="identifier">row_norms</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_is_fitted</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">SelectorMixin</span>


<span class="keyword">def</span> <span class="identifier">_clean_nans</span><span class="grouping">(</span><span class="identifier">scores</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Fixes Issue #1240: NaNs can't be properly compared, so change them to the
    smallest value of scores's dtype. -inf seems to be unreliable.
    """</span>
    <span class="comment"># XXX where should this function be called? fit? scoring functions</span>
    <span class="comment"># themselves?</span>
    <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">scores</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">scores</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">scores</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">scores</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">min</span>
    <span class="keyword">return</span> <span class="identifier">scores</span>


<span class="comment">######################################################################</span>
<span class="comment"># Scoring functions</span>


<span class="comment"># The following function is a rewriting of scipy.stats.f_oneway</span>
<span class="comment"># Contrary to the scipy.stats.f_oneway implementation it does not</span>
<span class="comment"># copy the data while keeping the inputs unchanged.</span>
<span class="keyword">def</span> <span class="identifier">f_oneway</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Performs a 1-way ANOVA.

    The one-way ANOVA tests the null hypothesis that 2 or more groups have
    the same population mean. The test is applied to samples from two or
    more groups, possibly with differing sizes.

    Read more in the :ref:`User Guide &lt;univariate_feature_selection&gt;`.

    Parameters
    ----------
    *args : {array-like, sparse matrix}
        sample1, sample2... The sample measurements should be given as
        arguments.

    Returns
    -------
    f_statistic : float
        The computed F-value of the test.
    p_value : float
        The associated p-value from the F-distribution.

    Notes
    -----
    The ANOVA test has important assumptions that must be satisfied in order
    for the associated p-value to be valid.

    1. The samples are independent
    2. Each sample is from a normally distributed population
    3. The population standard deviations of the groups are all equal. This
       property is known as homoscedasticity.

    If these assumptions are not true for a given set of data, it may still be
    possible to use the Kruskal-Wallis H-test (`scipy.stats.kruskal`_) although
    with some loss of power.

    The algorithm is from Heiman[2], pp.394-7.

    See ``scipy.stats.f_oneway`` that should give the same results while
    being less efficient.

    References
    ----------

    .. [1] Lowry, Richard.  "Concepts and Applications of Inferential
           Statistics". Chapter 14.
           http://faculty.vassar.edu/lowry/ch14pt1.html

    .. [2] Heiman, G.W.  Research Methods in Statistics. 2002.

    """</span>
    <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">args</span><span class="grouping">)</span>
    <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">a</span> <span class="relational-operator">in</span> <span class="identifier">args</span><span class="grouping">]</span>
    <span class="identifier">n_samples_per_class</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">a</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">a</span> <span class="relational-operator">in</span> <span class="identifier">args</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">n_samples_per_class</span><span class="grouping">)</span>
    <span class="identifier">ss_alldata</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">safe_sqr</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">a</span> <span class="relational-operator">in</span> <span class="identifier">args</span><span class="grouping">)</span>
    <span class="identifier">sums_args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">a</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">a</span> <span class="relational-operator">in</span> <span class="identifier">args</span><span class="grouping">]</span>
    <span class="identifier">square_of_sums_alldata</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">sums_args</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span>
    <span class="identifier">square_of_sums_args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">s</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="keyword">for</span> <span class="identifier">s</span> <span class="relational-operator">in</span> <span class="identifier">sums_args</span><span class="grouping">]</span>
    <span class="identifier">sstot</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ss_alldata</span> <span class="arithmetic-operator">-</span> <span class="identifier">square_of_sums_alldata</span> <span class="arithmetic-operator">/</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">ssbn</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ssbn</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">square_of_sums_args</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples_per_class</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span>
    <span class="identifier">ssbn</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">square_of_sums_alldata</span> <span class="arithmetic-operator">/</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">sswn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sstot</span> <span class="arithmetic-operator">-</span> <span class="identifier">ssbn</span>
    <span class="identifier">dfbn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_classes</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">dfwn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_classes</span>
    <span class="identifier">msb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ssbn</span> <span class="arithmetic-operator">/</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">dfbn</span><span class="grouping">)</span>
    <span class="identifier">msw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sswn</span> <span class="arithmetic-operator">/</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">dfwn</span><span class="grouping">)</span>
    <span class="identifier">constant_features_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">msw</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nonzero</span><span class="grouping">(</span><span class="identifier">msb</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="relational-operator">!=</span> <span class="identifier">msb</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="logical-operator">and</span> <span class="identifier">constant_features_idx</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"Features %s are constant."</span> <span class="arithmetic-operator">%</span> <span class="identifier">constant_features_idx</span><span class="punctuation">,</span>
                      <span class="identifier">UserWarning</span><span class="grouping">)</span>
    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">msb</span> <span class="arithmetic-operator">/</span> <span class="identifier">msw</span>
    <span class="comment"># flatten matrix to vector in sparse case</span>
    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">f</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">special</span><span class="punctuation">.</span><span class="identifier">fdtrc</span><span class="grouping">(</span><span class="identifier">dfbn</span><span class="punctuation">,</span> <span class="identifier">dfwn</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">prob</span>


<span class="keyword">def</span> <span class="identifier">f_classif</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute the ANOVA F-value for the provided sample.

    Read more in the :ref:`User Guide &lt;univariate_feature_selection&gt;`.

    Parameters
    ----------
    X : {array-like, sparse matrix} of shape (n_samples, n_features)
        The set of regressors that will be tested sequentially.

    y : ndarray of shape (n_samples,)
        The target vector.

    Returns
    -------
    f_statistic : ndarray of shape (n_features,)
        F-statistic for each feature.

    p_values : ndarray of shape (n_features,)
        P-values associated with the F-statistic.

    See Also
    --------
    chi2 : Chi-squared stats of non-negative features for classification tasks.
    f_regression : F-value between label/feature for regression tasks.
    """</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_X_y</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'csr', 'csc', 'coo'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">safe_mask</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="relational-operator">==</span> <span class="identifier">k</span><span class="grouping">)</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">return</span> <span class="identifier">f_oneway</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_chisquare</span><span class="grouping">(</span><span class="identifier">f_obs</span><span class="punctuation">,</span> <span class="identifier">f_exp</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Fast replacement for scipy.stats.chisquare.

    Version from https://github.com/scipy/scipy/pull/2525 with additional
    optimizations.
    """</span>
    <span class="identifier">f_obs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">f_obs</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>

    <span class="identifier">k</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">f_obs</span><span class="grouping">)</span>
    <span class="comment"># Reuse f_obs for chi-squared statistics</span>
    <span class="identifier">chisq</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f_obs</span>
    <span class="identifier">chisq</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">f_exp</span>
    <span class="identifier">chisq</span> <span class="arithmetic-assignment">**=</span> <span class="int-literal">2</span>
    <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="identifier">invalid</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ignore"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">chisq</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">f_exp</span>
    <span class="identifier">chisq</span> <span class="arithmetic-assignment">=</span> <span class="identifier">chisq</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">chisq</span><span class="punctuation">,</span> <span class="identifier">special</span><span class="punctuation">.</span><span class="identifier">chdtrc</span><span class="grouping">(</span><span class="identifier">k</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">chisq</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">chi2</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute chi-squared stats between each non-negative feature and class.

    This score can be used to select the n_features features with the
    highest values for the test chi-squared statistic from X, which must
    contain only non-negative features such as booleans or frequencies
    (e.g., term counts in document classification), relative to the classes.

    Recall that the chi-square test measures dependence between stochastic
    variables, so using this function "weeds out" the features that are the
    most likely to be independent of class and therefore irrelevant for
    classification.

    Read more in the :ref:`User Guide &lt;univariate_feature_selection&gt;`.

    Parameters
    ----------
    X : {array-like, sparse matrix} of shape (n_samples, n_features)
        Sample vectors.

    y : array-like of shape (n_samples,)
        Target vector (class labels).

    Returns
    -------
    chi2 : ndarray of shape (n_features,)
        Chi2 statistics for each feature.

    p_values : ndarray of shape (n_features,)
        P-values for each feature.

    Notes
    -----
    Complexity of this algorithm is O(n_classes * n_features).

    See Also
    --------
    f_classif : ANOVA F-value between label/feature for classification tasks.
    f_regression : F-value between label/feature for regression tasks.
    """</span>

    <span class="comment"># XXX: we might want to do some of the following in logspace instead for</span>
    <span class="comment"># numerical stability.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="string-literal">'csr'</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="keyword">if</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Input X must be non-negative."</span><span class="grouping">)</span>

    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LabelBinarizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">observed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">safe_sparse_dot</span><span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>          <span class="comment"># n_classes * n_features</span>

    <span class="identifier">feature_count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">b</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">feature_count</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">_chisquare</span><span class="grouping">(</span><span class="identifier">observed</span><span class="punctuation">,</span> <span class="identifier">expected</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">r_regression</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute Pearson's r for each features and the target.

    Pearson's r is also known as the Pearson correlation coefficient.

    .. versionadded:: 1.0

    Linear model for testing the individual effect of each of many regressors.
    This is a scoring function to be used in a feature selection procedure, not
    a free standing feature selection procedure.

    The cross correlation between each regressor and the target is computed
    as ((X[:, i] - mean(X[:, i])) * (y - mean_y)) / (std(X[:, i]) * std(y)).

    For more on usage see the :ref:`User Guide &lt;univariate_feature_selection&gt;`.

    Parameters
    ----------
    X : {array-like, sparse matrix} of shape (n_samples, n_features)
        The data matrix.

    y : array-like of shape (n_samples,)
        The target vector.

    center : bool, default=True
        Whether or not to center the data matrix `X` and the target vector `y`.
        By default, `X` and `y` will be centered.

    Returns
    -------
    correlation_coefficient : ndarray of shape (n_features,)
        Pearson's R correlation coefficients of features.

    See Also
    --------
    f_regression: Univariate linear regression tests returning f-statistic
        and p-values
    mutual_info_regression: Mutual information for a continuous target.
    f_classif: ANOVA F-value between label/feature for classification tasks.
    chi2: Chi-squared stats of non-negative features for classification tasks.
    """</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_X_y</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'csr', 'csc', 'coo'</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="comment"># Compute centered values</span>
    <span class="comment"># Note that E[(x - mean(x))*(y - mean(y))] = E[x*(y - mean(y))], so we</span>
    <span class="comment"># need not center X</span>
    <span class="keyword">if</span> <span class="identifier">center</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X_means</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">getA1</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">X_means</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="comment"># Compute the scaled standard deviations via moments</span>
        <span class="identifier">X_norms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">row_norms</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
                          <span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_means</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">X_norms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">row_norms</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="identifier">correlation_coefficient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">safe_sparse_dot</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">correlation_coefficient</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">X_norms</span>
    <span class="identifier">correlation_coefficient</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">correlation_coefficient</span>


<span class="keyword">def</span> <span class="identifier">f_regression</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Univariate linear regression tests returning F-statistic and p-values.

    Quick linear model for testing the effect of a single regressor,
    sequentially for many regressors.

    This is done in 2 steps:

    1. The cross correlation between each regressor and the target is computed,
       that is, ((X[:, i] - mean(X[:, i])) * (y - mean_y)) / (std(X[:, i]) *
       std(y)) using r_regression function.
    2. It is converted to an F score and then to a p-value.

    :func:`f_regression` is derived from :func:`r_regression` and will rank
    features in the same order if all the features are positively correlated
    with the target.

    Note however that contrary to :func:`f_regression`, :func:`r_regression`
    values lie in [-1, 1] and can thus be negative. :func:`f_regression` is
    therefore recommended as a feature selection criterion to identify
    potentially predictive feature for a downstream classifier, irrespective of
    the sign of the association with the target variable.

    Furthermore :func:`f_regression` returns p-values while
    :func:`r_regression` does not.

    Read more in the :ref:`User Guide &lt;univariate_feature_selection&gt;`.

    Parameters
    ----------
    X : {array-like, sparse matrix} of shape (n_samples, n_features)
        The data matrix.

    y : array-like of shape (n_samples,)
        The target vector.

    center : bool, default=True
        Whether or not to center the data matrix `X` and the target vector `y`.
        By default, `X` and `y` will be centered.

    Returns
    -------
    f_statistic : ndarray of shape (n_features,)
        F-statistic for each feature.

    p_values : ndarray of shape (n_features,)
        P-values associated with the F-statistic.

    See Also
    --------
    r_regression: Pearson's R between label/feature for regression tasks.
    f_classif: ANOVA F-value between label/feature for classification tasks.
    chi2: Chi-squared stats of non-negative features for classification tasks.
    SelectKBest: Select features based on the k highest scores.
    SelectFpr: Select features based on a false positive rate test.
    SelectFdr: Select features based on an estimated false discovery rate.
    SelectFwe: Select features based on family-wise error rate.
    SelectPercentile: Select features based on percentile of the highest
        scores.
    """</span>
    <span class="identifier">correlation_coefficient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r_regression</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="arithmetic-assignment">=</span><span class="identifier">center</span><span class="grouping">)</span>
    <span class="identifier">deg_of_freedom</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="keyword">if</span> <span class="identifier">center</span> <span class="keyword">else</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">corr_coef_squared</span> <span class="arithmetic-assignment">=</span> <span class="identifier">correlation_coefficient</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span>
    <span class="identifier">f_statistic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">corr_coef_squared</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">corr_coef_squared</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">deg_of_freedom</span>
    <span class="identifier">p_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stats</span><span class="punctuation">.</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">sf</span><span class="grouping">(</span><span class="identifier">f_statistic</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">deg_of_freedom</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">f_statistic</span><span class="punctuation">,</span> <span class="identifier">p_values</span>


<span class="comment">######################################################################</span>
<span class="comment"># Base classes</span>

<span class="keyword">class</span> <span class="identifier">_BaseFilter</span><span class="grouping">(</span><span class="identifier">SelectorMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Initialize the univariate feature selection.

    Parameters
    ----------
    score_func : callable
        Function taking two arrays X and y, and returning a pair of arrays
        (scores, pvalues) or a single array with scores.
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">score_func</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">score_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">score_func</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Run score function on (X, y) and get the appropriate features.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            The training input samples.

        y : array-like of shape (n_samples,)
            The target values (class labels in classification, real numbers in
            regression).

        Returns
        -------
        self : object
        """</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'csr', 'csc'</span><span class="grouping">]</span><span class="punctuation">,</span>
                                   <span class="identifier">multi_output</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">callable</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">score_func</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">TypeError</span><span class="grouping">(</span><span class="string-literal">"The score function should be a callable, %s (%s) "</span>
                            <span class="string-literal">"was passed."</span>
                            <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">score_func</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">score_func</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_params</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">score_func_ret</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">score_func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">score_func_ret</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">list</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scores_</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">score_func_ret</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scores_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">score_func_ret</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scores_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scores_</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">_check_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">pass</span>

    <span class="keyword">def</span> <span class="identifier">_more_tags</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'requires_y'</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span>


<span class="comment">######################################################################</span>
<span class="comment"># Specific filters</span>
<span class="comment">######################################################################</span>
<span class="keyword">class</span> <span class="identifier">SelectPercentile</span><span class="grouping">(</span><span class="identifier">_BaseFilter</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Select features according to a percentile of the highest scores.

    Read more in the :ref:`User Guide &lt;univariate_feature_selection&gt;`.

    Parameters
    ----------
    score_func : callable, default=f_classif
        Function taking two arrays X and y, and returning a pair of arrays
        (scores, pvalues) or a single array with scores.
        Default is f_classif (see below "See Also"). The default function only
        works with classification tasks.

        .. versionadded:: 0.18

    percentile : int, default=10
        Percent of features to keep.

    Attributes
    ----------
    scores_ : array-like of shape (n_features,)
        Scores of features.

    pvalues_ : array-like of shape (n_features,)
        p-values of feature scores, None if `score_func` returned only scores.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.datasets import load_digits
    &gt;&gt;&gt; from sklearn.feature_selection import SelectPercentile, chi2
    &gt;&gt;&gt; X, y = load_digits(return_X_y=True)
    &gt;&gt;&gt; X.shape
    (1797, 64)
    &gt;&gt;&gt; X_new = SelectPercentile(chi2, percentile=10).fit_transform(X, y)
    &gt;&gt;&gt; X_new.shape
    (1797, 7)

    Notes
    -----
    Ties between features with equal scores will be broken in an unspecified
    way.

    See Also
    --------
    f_classif : ANOVA F-value between label/feature for classification tasks.
    mutual_info_classif : Mutual information for a discrete target.
    chi2 : Chi-squared stats of non-negative features for classification tasks.
    f_regression : F-value between label/feature for regression tasks.
    mutual_info_regression : Mutual information for a continuous target.
    SelectKBest : Select features based on the k highest scores.
    SelectFpr : Select features based on a false positive rate test.
    SelectFdr : Select features based on an estimated false discovery rate.
    SelectFwe : Select features based on family-wise error rate.
    GenericUnivariateSelect : Univariate feature selector with configurable
        mode.
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">f_classif</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">percentile</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">score_func</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">percentile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">percentile</span>

    <span class="keyword">def</span> <span class="identifier">_check_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="int-literal">0</span> <span class="relational-operator">&lt;=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">percentile</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">100</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"percentile should be &gt;=0, &lt;=100; got %r"</span>
                             <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_support_mask</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="comment"># Cater for NaNs</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">percentile</span> <span class="relational-operator">==</span> <span class="int-literal">100</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scores_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">percentile</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scores_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>

        <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_clean_nans</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scores_</span><span class="grouping">)</span>
        <span class="identifier">threshold</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">(</span><span class="identifier">scores</span><span class="punctuation">,</span> <span class="int-literal">100</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">)</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scores</span> <span class="relational-operator">&gt;</span> <span class="identifier">threshold</span>
        <span class="identifier">ties</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">scores</span> <span class="relational-operator">==</span> <span class="identifier">threshold</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">ties</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">max_feats</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">scores</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">percentile</span> <span class="arithmetic-operator">/</span> <span class="int-literal">100</span><span class="grouping">)</span>
            <span class="identifier">kept_ties</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ties</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">max_feats</span> <span class="arithmetic-operator">-</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
            <span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">kept_ties</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="keyword">return</span> <span class="identifier">mask</span>


<span class="keyword">class</span> <span class="identifier">SelectKBest</span><span class="grouping">(</span><span class="identifier">_BaseFilter</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Select features according to the k highest scores.

    Read more in the :ref:`User Guide &lt;univariate_feature_selection&gt;`.

    Parameters
    ----------
    score_func : callable, default=f_classif
        Function taking two arrays X and y, and returning a pair of arrays
        (scores, pvalues) or a single array with scores.
        Default is f_classif (see below "See Also"). The default function only
        works with classification tasks.

        .. versionadded:: 0.18

    k : int or "all", default=10
        Number of top features to select.
        The "all" option bypasses selection, for use in a parameter search.

    Attributes
    ----------
    scores_ : array-like of shape (n_features,)
        Scores of features.

    pvalues_ : array-like of shape (n_features,)
        p-values of feature scores, None if `score_func` returned only scores.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.datasets import load_digits
    &gt;&gt;&gt; from sklearn.feature_selection import SelectKBest, chi2
    &gt;&gt;&gt; X, y = load_digits(return_X_y=True)
    &gt;&gt;&gt; X.shape
    (1797, 64)
    &gt;&gt;&gt; X_new = SelectKBest(chi2, k=20).fit_transform(X, y)
    &gt;&gt;&gt; X_new.shape
    (1797, 20)

    Notes
    -----
    Ties between features with equal scores will be broken in an unspecified
    way.

    See Also
    --------
    f_classif: ANOVA F-value between label/feature for classification tasks.
    mutual_info_classif: Mutual information for a discrete target.
    chi2: Chi-squared stats of non-negative features for classification tasks.
    f_regression: F-value between label/feature for regression tasks.
    mutual_info_regression: Mutual information for a continuous target.
    SelectPercentile: Select features based on percentile of the highest
        scores.
    SelectFpr : Select features based on a false positive rate test.
    SelectFdr : Select features based on an estimated false discovery rate.
    SelectFwe : Select features based on family-wise error rate.
    GenericUnivariateSelect : Univariate feature selector with configurable
        mode.
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">f_classif</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">score_func</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">k</span> <span class="arithmetic-assignment">=</span> <span class="identifier">k</span>

    <span class="keyword">def</span> <span class="identifier">_check_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">k</span> <span class="relational-operator">==</span> <span class="string-literal">"all"</span> <span class="logical-operator">or</span> <span class="int-literal">0</span> <span class="relational-operator">&lt;=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">k</span> <span class="relational-operator">&lt;=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"k should be &gt;=0, &lt;= n_features = %d; got %r. "</span>
                             <span class="string-literal">"Use k='all' to return all features."</span>
                             <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">k</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_support_mask</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">k</span> <span class="relational-operator">==</span> <span class="string-literal">'all'</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scores_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">k</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scores_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_clean_nans</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scores_</span><span class="grouping">)</span>
            <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">scores</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>

            <span class="comment"># Request a stable sort. Mergesort takes more memory (~40MB per</span>
            <span class="comment"># megafeature on x86-64).</span>
            <span class="identifier">mask</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">scores</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">"mergesort"</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">k</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
            <span class="keyword">return</span> <span class="identifier">mask</span>


<span class="keyword">class</span> <span class="identifier">SelectFpr</span><span class="grouping">(</span><span class="identifier">_BaseFilter</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Filter: Select the pvalues below alpha based on a FPR test.

    FPR test stands for False Positive Rate test. It controls the total
    amount of false detections.

    Read more in the :ref:`User Guide &lt;univariate_feature_selection&gt;`.

    Parameters
    ----------
    score_func : callable, default=f_classif
        Function taking two arrays X and y, and returning a pair of arrays
        (scores, pvalues).
        Default is f_classif (see below "See Also"). The default function only
        works with classification tasks.

    alpha : float, default=5e-2
        The highest p-value for features to be kept.

    Attributes
    ----------
    scores_ : array-like of shape (n_features,)
        Scores of features.

    pvalues_ : array-like of shape (n_features,)
        p-values of feature scores.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.datasets import load_breast_cancer
    &gt;&gt;&gt; from sklearn.feature_selection import SelectFpr, chi2
    &gt;&gt;&gt; X, y = load_breast_cancer(return_X_y=True)
    &gt;&gt;&gt; X.shape
    (569, 30)
    &gt;&gt;&gt; X_new = SelectFpr(chi2, alpha=0.01).fit_transform(X, y)
    &gt;&gt;&gt; X_new.shape
    (569, 16)

    See Also
    --------
    f_classif : ANOVA F-value between label/feature for classification tasks.
    chi2 : Chi-squared stats of non-negative features for classification tasks.
    mutual_info_classif: Mutual information for a discrete target.
    f_regression : F-value between label/feature for regression tasks.
    mutual_info_regression : Mutual information for a continuous target.
    SelectPercentile : Select features based on percentile of the highest
        scores.
    SelectKBest : Select features based on the k highest scores.
    SelectFdr : Select features based on an estimated false discovery rate.
    SelectFwe : Select features based on family-wise error rate.
    GenericUnivariateSelect : Univariate feature selector with configurable
        mode.
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">f_classif</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">5e-2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">score_func</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>

    <span class="keyword">def</span> <span class="identifier">_get_support_mask</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span>


<span class="keyword">class</span> <span class="identifier">SelectFdr</span><span class="grouping">(</span><span class="identifier">_BaseFilter</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Filter: Select the p-values for an estimated false discovery rate

    This uses the Benjamini-Hochberg procedure. ``alpha`` is an upper bound
    on the expected false discovery rate.

    Read more in the :ref:`User Guide &lt;univariate_feature_selection&gt;`.

    Parameters
    ----------
    score_func : callable, default=f_classif
        Function taking two arrays X and y, and returning a pair of arrays
        (scores, pvalues).
        Default is f_classif (see below "See Also"). The default function only
        works with classification tasks.

    alpha : float, default=5e-2
        The highest uncorrected p-value for features to keep.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.datasets import load_breast_cancer
    &gt;&gt;&gt; from sklearn.feature_selection import SelectFdr, chi2
    &gt;&gt;&gt; X, y = load_breast_cancer(return_X_y=True)
    &gt;&gt;&gt; X.shape
    (569, 30)
    &gt;&gt;&gt; X_new = SelectFdr(chi2, alpha=0.01).fit_transform(X, y)
    &gt;&gt;&gt; X_new.shape
    (569, 16)

    Attributes
    ----------
    scores_ : array-like of shape (n_features,)
        Scores of features.

    pvalues_ : array-like of shape (n_features,)
        p-values of feature scores.

    References
    ----------
    https://en.wikipedia.org/wiki/False_discovery_rate

    See Also
    --------
    f_classif : ANOVA F-value between label/feature for classification tasks.
    mutual_info_classif : Mutual information for a discrete target.
    chi2 : Chi-squared stats of non-negative features for classification tasks.
    f_regression : F-value between label/feature for regression tasks.
    mutual_info_regression : Mutual information for a contnuous target.
    SelectPercentile : Select features based on percentile of the highest
        scores.
    SelectKBest : Select features based on the k highest scores.
    SelectFpr : Select features based on a false positive rate test.
    SelectFwe : Select features based on family-wise error rate.
    GenericUnivariateSelect : Univariate feature selector with configurable
        mode.
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">f_classif</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">5e-2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">score_func</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>

    <span class="keyword">def</span> <span class="identifier">_get_support_mask</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span><span class="grouping">)</span>
        <span class="identifier">sv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span><span class="grouping">)</span>
        <span class="identifier">selected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sv</span><span class="grouping">[</span><span class="identifier">sv</span> <span class="relational-operator">&lt;=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">*</span>
                      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">selected</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span> <span class="relational-operator">&lt;=</span> <span class="identifier">selected</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">SelectFwe</span><span class="grouping">(</span><span class="identifier">_BaseFilter</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Filter: Select the p-values corresponding to Family-wise error rate

    Read more in the :ref:`User Guide &lt;univariate_feature_selection&gt;`.

    Parameters
    ----------
    score_func : callable, default=f_classif
        Function taking two arrays X and y, and returning a pair of arrays
        (scores, pvalues).
        Default is f_classif (see below "See Also"). The default function only
        works with classification tasks.

    alpha : float, default=5e-2
        The highest uncorrected p-value for features to keep.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.datasets import load_breast_cancer
    &gt;&gt;&gt; from sklearn.feature_selection import SelectFwe, chi2
    &gt;&gt;&gt; X, y = load_breast_cancer(return_X_y=True)
    &gt;&gt;&gt; X.shape
    (569, 30)
    &gt;&gt;&gt; X_new = SelectFwe(chi2, alpha=0.01).fit_transform(X, y)
    &gt;&gt;&gt; X_new.shape
    (569, 15)

    Attributes
    ----------
    scores_ : array-like of shape (n_features,)
        Scores of features.

    pvalues_ : array-like of shape (n_features,)
        p-values of feature scores.

    See Also
    --------
    f_classif : ANOVA F-value between label/feature for classification tasks.
    chi2 : Chi-squared stats of non-negative features for classification tasks.
    f_regression : F-value between label/feature for regression tasks.
    SelectPercentile : Select features based on percentile of the highest
        scores.
    SelectKBest : Select features based on the k highest scores.
    SelectFpr : Select features based on a false positive rate test.
    SelectFdr : Select features based on an estimated false discovery rate.
    GenericUnivariateSelect : Univariate feature selector with configurable
        mode.
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">f_classif</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">5e-2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">score_func</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>

    <span class="keyword">def</span> <span class="identifier">_get_support_mask</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-operator">/</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="comment">######################################################################</span>
<span class="comment"># Generic filter</span>
<span class="comment">######################################################################</span>

<span class="comment"># TODO this class should fit on either p-values or scores,</span>
<span class="comment"># depending on the mode.</span>
<span class="keyword">class</span> <span class="identifier">GenericUnivariateSelect</span><span class="grouping">(</span><span class="identifier">_BaseFilter</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Univariate feature selector with configurable strategy.

    Read more in the :ref:`User Guide &lt;univariate_feature_selection&gt;`.

    Parameters
    ----------
    score_func : callable, default=f_classif
        Function taking two arrays X and y, and returning a pair of arrays
        (scores, pvalues). For modes 'percentile' or 'kbest' it can return
        a single array scores.

    mode : {'percentile', 'k_best', 'fpr', 'fdr', 'fwe'}, default='percentile'
        Feature selection mode.

    param : float or int depending on the feature selection mode, default=1e-5
        Parameter of the corresponding mode.

    Attributes
    ----------
    scores_ : array-like of shape (n_features,)
        Scores of features.

    pvalues_ : array-like of shape (n_features,)
        p-values of feature scores, None if `score_func` returned scores only.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.datasets import load_breast_cancer
    &gt;&gt;&gt; from sklearn.feature_selection import GenericUnivariateSelect, chi2
    &gt;&gt;&gt; X, y = load_breast_cancer(return_X_y=True)
    &gt;&gt;&gt; X.shape
    (569, 30)
    &gt;&gt;&gt; transformer = GenericUnivariateSelect(chi2, mode='k_best', param=20)
    &gt;&gt;&gt; X_new = transformer.fit_transform(X, y)
    &gt;&gt;&gt; X_new.shape
    (569, 20)

    See Also
    --------
    f_classif : ANOVA F-value between label/feature for classification tasks.
    mutual_info_classif : Mutual information for a discrete target.
    chi2 : Chi-squared stats of non-negative features for classification tasks.
    f_regression : F-value between label/feature for regression tasks.
    mutual_info_regression : Mutual information for a continuous target.
    SelectPercentile : Select features based on percentile of the highest
        scores.
    SelectKBest : Select features based on the k highest scores.
    SelectFpr : Select features based on a false positive rate test.
    SelectFdr : Select features based on an estimated false discovery rate.
    SelectFwe : Select features based on family-wise error rate.
    """</span>

    <span class="identifier">_selection_modes</span><span class="punctuation">:</span> <span class="identifier">dict</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'percentile'</span><span class="punctuation">:</span> <span class="identifier">SelectPercentile</span><span class="punctuation">,</span>
                              <span class="string-literal">'k_best'</span><span class="punctuation">:</span> <span class="identifier">SelectKBest</span><span class="punctuation">,</span>
                              <span class="string-literal">'fpr'</span><span class="punctuation">:</span> <span class="identifier">SelectFpr</span><span class="punctuation">,</span>
                              <span class="string-literal">'fdr'</span><span class="punctuation">:</span> <span class="identifier">SelectFdr</span><span class="punctuation">,</span>
                              <span class="string-literal">'fwe'</span><span class="punctuation">:</span> <span class="identifier">SelectFwe</span><span class="grouping">}</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">f_classif</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'percentile'</span><span class="punctuation">,</span> <span class="identifier">param</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-5</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">score_func</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mode</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mode</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">param</span> <span class="arithmetic-assignment">=</span> <span class="identifier">param</span>

    <span class="keyword">def</span> <span class="identifier">_make_selector</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">selector</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_modes</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mode</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">score_func</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">score_func</span><span class="grouping">)</span>

        <span class="comment"># Now perform some acrobatics to set the right named parameter in</span>
        <span class="comment"># the selector</span>
        <span class="identifier">possible_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">selector</span><span class="punctuation">.</span><span class="identifier">_get_param_names</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">possible_params</span><span class="punctuation">.</span><span class="identifier">remove</span><span class="grouping">(</span><span class="string-literal">'score_func'</span><span class="grouping">)</span>
        <span class="identifier">selector</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="grouping">{</span><span class="identifier">possible_params</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">param</span><span class="grouping">}</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">selector</span>

    <span class="keyword">def</span> <span class="identifier">_check_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mode</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_modes</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"The mode passed should be one of %s, %r,"</span>
                             <span class="string-literal">" (type %s) was passed."</span>
                             <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_selection_modes</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mode</span><span class="punctuation">,</span>
                                <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mode</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_make_selector</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">_check_params</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_support_mask</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="identifier">selector</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_make_selector</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">selector</span><span class="punctuation">.</span><span class="identifier">pvalues_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pvalues_</span>
        <span class="identifier">selector</span><span class="punctuation">.</span><span class="identifier">scores_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scores_</span>
        <span class="keyword">return</span> <span class="identifier">selector</span><span class="punctuation">.</span><span class="identifier">_get_support_mask</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>