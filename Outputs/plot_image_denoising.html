<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
=========================================
Image denoising using dictionary learning
=========================================

An example comparing the effect of reconstructing noisy fragments
of a raccoon face image using firstly online :ref:`DictionaryLearning` and
various transform methods.

The dictionary is fitted on the distorted left half of the image, and
subsequently used to reconstruct the right half. Note that even better
performance could be achieved by fitting to an undistorted (i.e.
noiseless) image, but here we start from the assumption that it is not
available.

A common practice for evaluating the results of image denoising is by looking
at the difference between the reconstruction and the original image. If the
reconstruction is perfect this will look like Gaussian noise.

It can be seen from the plots that the results of :ref:`omp` with two
non-zero coefficients is a bit less biased than when keeping only one
(the edges look less prominent). It is in addition closer from the ground
truth in Frobenius norm.

The result of :ref:`least_angle_regression` is much more strongly biased: the
difference is reminiscent of the local intensity value of the original image.

Thresholding is clearly not useful for denoising, but it is here to show that
it can produce a suggestive output with very high speed, and thus be useful
for other tasks such as object classification, where performance is not
necessarily related to visualisation.

"""</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>

<span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">time</span>

<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span> <span class="keyword">as</span> <span class="identifier">sp</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">MiniBatchDictionaryLearning</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">image</span> <span class="keyword">import</span> <span class="identifier">extract_patches_2d</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">image</span> <span class="keyword">import</span> <span class="identifier">reconstruct_from_patches_2d</span>


<span class="keyword">try</span><span class="punctuation">:</span>  <span class="comment"># SciPy &gt;= 0.16 have face in misc</span>
    <span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">misc</span> <span class="keyword">import</span> <span class="identifier">face</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="grouping">(</span><span class="identifier">gray</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">face</span><span class="grouping">(</span><span class="identifier">gray</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

<span class="comment"># Convert from uint8 representation with values between 0 and 255 to</span>
<span class="comment"># a floating point representation with values between 0 and 1.</span>
<span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span> <span class="arithmetic-operator">/</span> <span class="int-literal">255</span><span class="punctuation">.</span>

<span class="comment"># downsample for higher speed</span>
<span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span>
<span class="identifier">face</span> <span class="arithmetic-assignment">/=</span> <span class="float-literal">4.0</span>
<span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span>

<span class="comment"># Distort the right half of the image</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'Distorting image...'</span><span class="grouping">)</span>
<span class="identifier">distorted</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">distorted</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="float-literal">0.075</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span>

<span class="comment"># Extract all reference patches from the left half of the image</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'Extracting reference patches...'</span><span class="grouping">)</span>
<span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">patch_size</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span>
<span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">distorted</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">width</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">patch_size</span><span class="grouping">)</span>
<span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
<span class="identifier">data</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">data</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'done in %.2fs.'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="comment"># #############################################################################</span>
<span class="comment"># Learn the dictionary from reference patches</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'Learning the dictionary...'</span><span class="grouping">)</span>
<span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">dico</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MiniBatchDictionaryLearning</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="grouping">)</span>
<span class="identifier">V</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dico</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">components_</span>
<span class="identifier">dt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'done in %.2fs.'</span> <span class="arithmetic-operator">%</span> <span class="identifier">dt</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">4.2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">comp</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">100</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">imshow</span><span class="grouping">(</span><span class="identifier">comp</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">patch_size</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">gray_r</span><span class="punctuation">,</span>
               <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nearest'</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xticks</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">yticks</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">suptitle</span><span class="grouping">(</span><span class="string-literal">'Dictionary learned from face patches\n'</span> <span class="arithmetic-operator">+</span>
             <span class="string-literal">'Train time %.1fs on %d patches'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">dt</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">fontsize</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots_adjust</span><span class="grouping">(</span><span class="float-literal">0.08</span><span class="punctuation">,</span> <span class="float-literal">0.02</span><span class="punctuation">,</span> <span class="float-literal">0.92</span><span class="punctuation">,</span> <span class="float-literal">0.85</span><span class="punctuation">,</span> <span class="float-literal">0.08</span><span class="punctuation">,</span> <span class="float-literal">0.23</span><span class="grouping">)</span>


<span class="comment"># #############################################################################</span>
<span class="comment"># Display the distorted image</span>

<span class="keyword">def</span> <span class="identifier">show_with_diff</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">reference</span><span class="punctuation">,</span> <span class="identifier">title</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Helper function to display denoising"""</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">3.3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">'Image'</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">imshow</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">vmin</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">vmax</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">gray</span><span class="punctuation">,</span>
               <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nearest'</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xticks</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">yticks</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">difference</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span> <span class="arithmetic-operator">-</span> <span class="identifier">reference</span>

    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">'Difference (norm: %.2f)'</span> <span class="arithmetic-operator">%</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">difference</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">imshow</span><span class="grouping">(</span><span class="identifier">difference</span><span class="punctuation">,</span> <span class="identifier">vmin</span><span class="arithmetic-assignment">=</span><span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="identifier">vmax</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">PuOr</span><span class="punctuation">,</span>
               <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nearest'</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xticks</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">yticks</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">suptitle</span><span class="grouping">(</span><span class="identifier">title</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots_adjust</span><span class="grouping">(</span><span class="float-literal">0.02</span><span class="punctuation">,</span> <span class="float-literal">0.02</span><span class="punctuation">,</span> <span class="float-literal">0.98</span><span class="punctuation">,</span> <span class="float-literal">0.79</span><span class="punctuation">,</span> <span class="float-literal">0.02</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">)</span>

<span class="identifier">show_with_diff</span><span class="grouping">(</span><span class="identifier">distorted</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">,</span> <span class="string-literal">'Distorted image'</span><span class="grouping">)</span>

<span class="comment"># #############################################################################</span>
<span class="comment"># Extract noisy patches and reconstruct them using the dictionary</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'Extracting noisy patches... '</span><span class="grouping">)</span>
<span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">distorted</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">patch_size</span><span class="grouping">)</span>
<span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
<span class="identifier">intercept</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">data</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">intercept</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'done in %.2fs.'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">transform_algorithms</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="string-literal">'Orthogonal Matching Pursuit\n1 atom', 'omp'</span><span class="punctuation">,</span>
     <span class="grouping">{</span><span class="string-literal">'transform_n_nonzero_coefs'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'Orthogonal Matching Pursuit\n2 atoms', 'omp'</span><span class="punctuation">,</span>
     <span class="grouping">{</span><span class="string-literal">'transform_n_nonzero_coefs'</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'Least-angle regression\n5 atoms', 'lars'</span><span class="punctuation">,</span>
     <span class="grouping">{</span><span class="string-literal">'transform_n_nonzero_coefs'</span><span class="punctuation">:</span> <span class="int-literal">5</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'Thresholding\n alpha=0.1', 'threshold', {'transform_alpha'</span><span class="punctuation">:</span> <span class="float-literal">.1</span><span class="grouping">}</span><span class="grouping">)</span><span class="grouping">]</span>

<span class="identifier">reconstructions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">}</span>
<span class="keyword">for</span> <span class="identifier">title</span><span class="punctuation">,</span> <span class="identifier">transform_algorithm</span><span class="punctuation">,</span> <span class="identifier">kwargs</span> <span class="relational-operator">in</span> <span class="identifier">transform_algorithms</span><span class="punctuation">:</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">title</span> <span class="arithmetic-operator">+</span> <span class="string-literal">'...'</span><span class="grouping">)</span>
    <span class="identifier">reconstructions</span><span class="grouping">[</span><span class="identifier">title</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">dico</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">transform_algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">transform_algorithm</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
    <span class="identifier">code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dico</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="grouping">)</span>

    <span class="identifier">patches</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">intercept</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">patch_size</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">transform_algorithm</span> <span class="relational-operator">==</span> <span class="string-literal">'threshold'</span><span class="punctuation">:</span>
        <span class="identifier">patches</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">patches</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">reconstructions</span><span class="grouping">[</span><span class="identifier">title</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reconstruct_from_patches_2d</span><span class="grouping">(</span>
        <span class="identifier">patches</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">dt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'done in %.2fs.'</span> <span class="arithmetic-operator">%</span> <span class="identifier">dt</span><span class="grouping">)</span>
    <span class="identifier">show_with_diff</span><span class="grouping">(</span><span class="identifier">reconstructions</span><span class="grouping">[</span><span class="identifier">title</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">,</span>
                   <span class="identifier">title</span> <span class="arithmetic-operator">+</span> <span class="string-literal">' (time: %.1fs)'</span> <span class="arithmetic-operator">%</span> <span class="identifier">dt</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>