<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">HISTOGRAM_DTYPE</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">G_H_DTYPE</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">X_BINNED_DTYPE</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">MonotonicConstraint</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">splitting</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">Splitter</span><span class="punctuation">,</span>
    <span class="identifier">compute_node_value</span>
<span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">histogram</span> <span class="keyword">import</span> <span class="identifier">HistogramBuilder</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">skip_if_32bit</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_bins'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">32</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_histogram_split</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">feature_idx</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">l2_regularization</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">min_hessian_to_split</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-3</span>
    <span class="identifier">min_samples_leaf</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">min_gain_to_split</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span>
        <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e4</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_BINNED_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">binned_feature</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="identifier">feature_idx</span><span class="grouping">]</span>
    <span class="identifier">sample_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">binned_feature</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">ordered_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones_like</span><span class="grouping">(</span><span class="identifier">binned_feature</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ordered_hessians</span>
    <span class="identifier">sum_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_hessians</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">hessians_are_constant</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>

    <span class="keyword">for</span> <span class="identifier">true_bin</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">sign</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">ordered_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full_like</span><span class="grouping">(</span><span class="identifier">binned_feature</span><span class="punctuation">,</span> <span class="identifier">sign</span><span class="punctuation">,</span>
                                             <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
            <span class="identifier">ordered_gradients</span><span class="grouping">[</span><span class="identifier">binned_feature</span> <span class="relational-operator">&lt;=</span> <span class="identifier">true_bin</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
            <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ordered_gradients</span>
            <span class="identifier">sum_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_gradients</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

            <span class="identifier">builder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistogramBuilder</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span>
                                       <span class="identifier">n_bins</span><span class="punctuation">,</span>
                                       <span class="identifier">all_gradients</span><span class="punctuation">,</span>
                                       <span class="identifier">all_hessians</span><span class="punctuation">,</span>
                                       <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>
            <span class="identifier">n_bins_non_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                          <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
            <span class="identifier">has_missing_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                          <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
            <span class="identifier">monotonic_cst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
                <span class="grouping">[</span><span class="identifier">MonotonicConstraint</span><span class="punctuation">.</span><span class="identifier">NO_CST</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int8</span><span class="grouping">)</span>
            <span class="identifier">is_categorical</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">monotonic_cst</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
            <span class="identifier">missing_values_bin_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
            <span class="identifier">splitter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Splitter</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span>
                                <span class="identifier">n_bins_non_missing</span><span class="punctuation">,</span>
                                <span class="identifier">missing_values_bin_idx</span><span class="punctuation">,</span>
                                <span class="identifier">has_missing_values</span><span class="punctuation">,</span>
                                <span class="identifier">is_categorical</span><span class="punctuation">,</span>
                                <span class="identifier">monotonic_cst</span><span class="punctuation">,</span>
                                <span class="identifier">l2_regularization</span><span class="punctuation">,</span>
                                <span class="identifier">min_hessian_to_split</span><span class="punctuation">,</span>
                                <span class="identifier">min_samples_leaf</span><span class="punctuation">,</span> <span class="identifier">min_gain_to_split</span><span class="punctuation">,</span>
                                <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>

            <span class="identifier">histograms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">builder</span><span class="punctuation">.</span><span class="identifier">compute_histograms_brute</span><span class="grouping">(</span><span class="identifier">sample_indices</span><span class="grouping">)</span>
            <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_node_value</span><span class="grouping">(</span><span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span>
                                       <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">l2_regularization</span><span class="grouping">)</span>
            <span class="identifier">split_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">find_node_split</span><span class="grouping">(</span>
                <span class="identifier">sample_indices</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">histograms</span><span class="punctuation">,</span> <span class="identifier">sum_gradients</span><span class="punctuation">,</span>
                <span class="identifier">sum_hessians</span><span class="punctuation">,</span> <span class="identifier">value</span><span class="grouping">)</span>

            <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">bin_idx</span> <span class="relational-operator">==</span> <span class="identifier">true_bin</span>
            <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">gain</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span>
            <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">feature_idx</span> <span class="relational-operator">==</span> <span class="identifier">feature_idx</span>
            <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">n_samples_left</span> <span class="arithmetic-operator">+</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">n_samples_right</span>
                    <span class="relational-operator">==</span> <span class="identifier">sample_indices</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="comment"># Constant hessian: 1. per sample.</span>
            <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">n_samples_left</span> <span class="relational-operator">==</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">sum_hessian_left</span>


<span class="punctuation">@</span><span class="identifier">skip_if_32bit</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'constant_hessian'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_gradient_and_hessian_sanity</span><span class="grouping">(</span><span class="identifier">constant_hessian</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># This test checks that the values of gradients and hessians are</span>
    <span class="comment"># consistent in different places:</span>
    <span class="comment"># - in split_info: si.sum_gradient_left + si.sum_gradient_right must be</span>
    <span class="comment">#   equal to the gradient at the node. Same for hessians.</span>
    <span class="comment"># - in the histograms: summing 'sum_gradients' over the bins must be</span>
    <span class="comment">#   constant across all features, and those sums must be equal to the</span>
    <span class="comment">#   node's gradient. Same for hessians.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span>
    <span class="identifier">l2_regularization</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="identifier">min_hessian_to_split</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-3</span>
    <span class="identifier">min_samples_leaf</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">min_gain_to_split</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>

    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_BINNED_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>
    <span class="identifier">sample_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">sum_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_gradients</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">constant_hessian</span><span class="punctuation">:</span>
        <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
        <span class="identifier">sum_hessians</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">lognormal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
        <span class="identifier">sum_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_hessians</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">builder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistogramBuilder</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span>
                               <span class="identifier">all_hessians</span><span class="punctuation">,</span> <span class="identifier">constant_hessian</span><span class="grouping">)</span>
    <span class="identifier">n_bins_non_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">has_missing_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">monotonic_cst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="identifier">MonotonicConstraint</span><span class="punctuation">.</span><span class="identifier">NO_CST</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int8</span><span class="grouping">)</span>
    <span class="identifier">is_categorical</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">monotonic_cst</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">missing_values_bin_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">splitter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Splitter</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins_non_missing</span><span class="punctuation">,</span> <span class="identifier">missing_values_bin_idx</span><span class="punctuation">,</span>
                        <span class="identifier">has_missing_values</span><span class="punctuation">,</span> <span class="identifier">is_categorical</span><span class="punctuation">,</span> <span class="identifier">monotonic_cst</span><span class="punctuation">,</span>
                        <span class="identifier">l2_regularization</span><span class="punctuation">,</span> <span class="identifier">min_hessian_to_split</span><span class="punctuation">,</span>
                        <span class="identifier">min_samples_leaf</span><span class="punctuation">,</span> <span class="identifier">min_gain_to_split</span><span class="punctuation">,</span> <span class="identifier">constant_hessian</span><span class="grouping">)</span>

    <span class="identifier">hists_parent</span> <span class="arithmetic-assignment">=</span> <span class="identifier">builder</span><span class="punctuation">.</span><span class="identifier">compute_histograms_brute</span><span class="grouping">(</span><span class="identifier">sample_indices</span><span class="grouping">)</span>
    <span class="identifier">value_parent</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_node_value</span><span class="grouping">(</span><span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span>
                                      <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">l2_regularization</span><span class="grouping">)</span>
    <span class="identifier">si_parent</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">find_node_split</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">hists_parent</span><span class="punctuation">,</span>
                                         <span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span>
                                         <span class="identifier">value_parent</span><span class="grouping">)</span>
    <span class="identifier">sample_indices_left</span><span class="punctuation">,</span> <span class="identifier">sample_indices_right</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">split_indices</span><span class="grouping">(</span>
        <span class="identifier">si_parent</span><span class="punctuation">,</span> <span class="identifier">sample_indices</span><span class="grouping">)</span>

    <span class="identifier">hists_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">builder</span><span class="punctuation">.</span><span class="identifier">compute_histograms_brute</span><span class="grouping">(</span><span class="identifier">sample_indices_left</span><span class="grouping">)</span>
    <span class="identifier">value_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_node_value</span><span class="grouping">(</span><span class="identifier">si_parent</span><span class="punctuation">.</span><span class="identifier">sum_gradient_left</span><span class="punctuation">,</span>
                                    <span class="identifier">si_parent</span><span class="punctuation">.</span><span class="identifier">sum_hessian_left</span><span class="punctuation">,</span>
                                    <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">l2_regularization</span><span class="grouping">)</span>
    <span class="identifier">hists_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">builder</span><span class="punctuation">.</span><span class="identifier">compute_histograms_brute</span><span class="grouping">(</span><span class="identifier">sample_indices_right</span><span class="grouping">)</span>
    <span class="identifier">value_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_node_value</span><span class="grouping">(</span><span class="identifier">si_parent</span><span class="punctuation">.</span><span class="identifier">sum_gradient_right</span><span class="punctuation">,</span>
                                     <span class="identifier">si_parent</span><span class="punctuation">.</span><span class="identifier">sum_hessian_right</span><span class="punctuation">,</span>
                                     <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">l2_regularization</span><span class="grouping">)</span>
    <span class="identifier">si_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">find_node_split</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">hists_left</span><span class="punctuation">,</span>
                                       <span class="identifier">si_parent</span><span class="punctuation">.</span><span class="identifier">sum_gradient_left</span><span class="punctuation">,</span>
                                       <span class="identifier">si_parent</span><span class="punctuation">.</span><span class="identifier">sum_hessian_left</span><span class="punctuation">,</span>
                                       <span class="identifier">value_left</span><span class="grouping">)</span>
    <span class="identifier">si_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">find_node_split</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">hists_right</span><span class="punctuation">,</span>
                                        <span class="identifier">si_parent</span><span class="punctuation">.</span><span class="identifier">sum_gradient_right</span><span class="punctuation">,</span>
                                        <span class="identifier">si_parent</span><span class="punctuation">.</span><span class="identifier">sum_hessian_right</span><span class="punctuation">,</span>
                                        <span class="identifier">value_right</span><span class="grouping">)</span>

    <span class="comment"># make sure that si.sum_gradient_left + si.sum_gradient_right have their</span>
    <span class="comment"># expected value, same for hessians</span>
    <span class="keyword">for</span> <span class="identifier">si</span><span class="punctuation">,</span> <span class="identifier">indices</span> <span class="relational-operator">in</span> <span class="grouping">(</span>
            <span class="grouping">(</span><span class="identifier">si_parent</span><span class="punctuation">,</span> <span class="identifier">sample_indices</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">si_left</span><span class="punctuation">,</span> <span class="identifier">sample_indices_left</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">si_right</span><span class="punctuation">,</span> <span class="identifier">sample_indices_right</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">si</span><span class="punctuation">.</span><span class="identifier">sum_gradient_right</span> <span class="arithmetic-operator">+</span> <span class="identifier">si</span><span class="punctuation">.</span><span class="identifier">sum_gradient_left</span>
        <span class="identifier">expected_gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_gradients</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">hessian</span> <span class="arithmetic-assignment">=</span> <span class="identifier">si</span><span class="punctuation">.</span><span class="identifier">sum_hessian_right</span> <span class="arithmetic-operator">+</span> <span class="identifier">si</span><span class="punctuation">.</span><span class="identifier">sum_hessian_left</span>
        <span class="keyword">if</span> <span class="identifier">constant_hessian</span><span class="punctuation">:</span>
            <span class="identifier">expected_hessian</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indices</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">all_hessians</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">expected_hessian</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_hessians</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isclose</span><span class="grouping">(</span><span class="identifier">gradient</span><span class="punctuation">,</span> <span class="identifier">expected_gradient</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isclose</span><span class="grouping">(</span><span class="identifier">hessian</span><span class="punctuation">,</span> <span class="identifier">expected_hessian</span><span class="grouping">)</span>

    <span class="comment"># make sure sum of gradients in histograms are the same for all features,</span>
    <span class="comment"># and make sure they're equal to their expected value</span>
    <span class="identifier">hists_parent</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">hists_parent</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">HISTOGRAM_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">hists_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">hists_left</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">HISTOGRAM_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">hists_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">hists_right</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">HISTOGRAM_DTYPE</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">hists</span><span class="punctuation">,</span> <span class="identifier">indices</span> <span class="relational-operator">in</span> <span class="grouping">(</span>
            <span class="grouping">(</span><span class="identifier">hists_parent</span><span class="punctuation">,</span> <span class="identifier">sample_indices</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">hists_left</span><span class="punctuation">,</span> <span class="identifier">sample_indices_left</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">hists_right</span><span class="punctuation">,</span> <span class="identifier">sample_indices_right</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># note: gradients and hessians have shape (n_features,),</span>
        <span class="comment"># we're comparing them to *scalars*. This has the benefit of also</span>
        <span class="comment"># making sure that all the entries are equal across features.</span>
        <span class="identifier">gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hists</span><span class="grouping">[</span><span class="string-literal">'sum_gradients'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>  <span class="comment"># shape = (n_features,)</span>
        <span class="identifier">expected_gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_gradients</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># scalar</span>
        <span class="identifier">hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hists</span><span class="grouping">[</span><span class="string-literal">'sum_hessians'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">constant_hessian</span><span class="punctuation">:</span>
            <span class="comment"># 0 is not the actual hessian, but it's not computed in this case</span>
            <span class="identifier">expected_hessian</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">expected_hessian</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_hessians</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">gradients</span><span class="punctuation">,</span> <span class="identifier">expected_gradient</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">hessians</span><span class="punctuation">,</span> <span class="identifier">expected_hessian</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_split_indices</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that split_indices returns the correct splits and that</span>
    <span class="comment"># splitter.partition is consistent with what is returned.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">421</span><span class="grouping">)</span>

    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">l2_regularization</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="identifier">min_hessian_to_split</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-3</span>
    <span class="identifier">min_samples_leaf</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">min_gain_to_split</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>

    <span class="comment"># split will happen on feature 1 and on bin 3</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_BINNED_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">sample_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">sum_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_gradients</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">sum_hessians</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span>
    <span class="identifier">hessians_are_constant</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>

    <span class="identifier">builder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistogramBuilder</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="punctuation">,</span>
                               <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="punctuation">,</span>
                               <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>
    <span class="identifier">n_bins_non_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">n_bins</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">has_missing_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">monotonic_cst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="identifier">MonotonicConstraint</span><span class="punctuation">.</span><span class="identifier">NO_CST</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int8</span><span class="grouping">)</span>
    <span class="identifier">is_categorical</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">monotonic_cst</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">missing_values_bin_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">splitter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Splitter</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins_non_missing</span><span class="punctuation">,</span> <span class="identifier">missing_values_bin_idx</span><span class="punctuation">,</span>
                        <span class="identifier">has_missing_values</span><span class="punctuation">,</span> <span class="identifier">is_categorical</span><span class="punctuation">,</span> <span class="identifier">monotonic_cst</span><span class="punctuation">,</span>
                        <span class="identifier">l2_regularization</span><span class="punctuation">,</span> <span class="identifier">min_hessian_to_split</span><span class="punctuation">,</span>
                        <span class="identifier">min_samples_leaf</span><span class="punctuation">,</span> <span class="identifier">min_gain_to_split</span><span class="punctuation">,</span>
                        <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">sample_indices</span> <span class="relational-operator">==</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">partition</span><span class="grouping">)</span>

    <span class="identifier">histograms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">builder</span><span class="punctuation">.</span><span class="identifier">compute_histograms_brute</span><span class="grouping">(</span><span class="identifier">sample_indices</span><span class="grouping">)</span>
    <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_node_value</span><span class="grouping">(</span><span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span>
                               <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">l2_regularization</span><span class="grouping">)</span>
    <span class="identifier">si_root</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">find_node_split</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">histograms</span><span class="punctuation">,</span>
                                       <span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span> <span class="identifier">value</span><span class="grouping">)</span>

    <span class="comment"># sanity checks for best split</span>
    <span class="keyword">assert</span> <span class="identifier">si_root</span><span class="punctuation">.</span><span class="identifier">feature_idx</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">si_root</span><span class="punctuation">.</span><span class="identifier">bin_idx</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>

    <span class="identifier">samples_left</span><span class="punctuation">,</span> <span class="identifier">samples_right</span><span class="punctuation">,</span> <span class="identifier">position_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">split_indices</span><span class="grouping">(</span>
        <span class="identifier">si_root</span><span class="punctuation">,</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">partition</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">samples_left</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">samples_right</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">samples_left</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">partition</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">position_right</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">samples_right</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">partition</span><span class="grouping">[</span><span class="identifier">position_right</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Check that the resulting split indices sizes are consistent with the</span>
    <span class="comment"># count statistics anticipated when looking for the best split.</span>
    <span class="keyword">assert</span> <span class="identifier">samples_left</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">si_root</span><span class="punctuation">.</span><span class="identifier">n_samples_left</span>
    <span class="keyword">assert</span> <span class="identifier">samples_right</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">si_root</span><span class="punctuation">.</span><span class="identifier">n_samples_right</span>


<span class="keyword">def</span> <span class="identifier">test_min_gain_to_split</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Try to split a pure node (all gradients are equal, same for hessians)</span>
    <span class="comment"># with min_gain_to_split = 0 and make sure that the node is not split (best</span>
    <span class="comment"># possible gain = -1). Note: before the strict inequality comparison, this</span>
    <span class="comment"># test would fail because the node would be split with a gain of 0.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">l2_regularization</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">min_hessian_to_split</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">min_samples_leaf</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">min_gain_to_split</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">255</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span>
        <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_BINNED_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">binned_feature</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_binned</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">sample_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones_like</span><span class="grouping">(</span><span class="identifier">binned_feature</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones_like</span><span class="grouping">(</span><span class="identifier">binned_feature</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">sum_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_gradients</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">sum_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_hessians</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">hessians_are_constant</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>

    <span class="identifier">builder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistogramBuilder</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span>
                               <span class="identifier">all_hessians</span><span class="punctuation">,</span> <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>
    <span class="identifier">n_bins_non_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">has_missing_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">monotonic_cst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="identifier">MonotonicConstraint</span><span class="punctuation">.</span><span class="identifier">NO_CST</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int8</span><span class="grouping">)</span>
    <span class="identifier">is_categorical</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">monotonic_cst</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">missing_values_bin_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">splitter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Splitter</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins_non_missing</span><span class="punctuation">,</span> <span class="identifier">missing_values_bin_idx</span><span class="punctuation">,</span>
                        <span class="identifier">has_missing_values</span><span class="punctuation">,</span> <span class="identifier">is_categorical</span><span class="punctuation">,</span>  <span class="identifier">monotonic_cst</span><span class="punctuation">,</span>
                        <span class="identifier">l2_regularization</span><span class="punctuation">,</span>
                        <span class="identifier">min_hessian_to_split</span><span class="punctuation">,</span> <span class="identifier">min_samples_leaf</span><span class="punctuation">,</span>
                        <span class="identifier">min_gain_to_split</span><span class="punctuation">,</span> <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>

    <span class="identifier">histograms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">builder</span><span class="punctuation">.</span><span class="identifier">compute_histograms_brute</span><span class="grouping">(</span><span class="identifier">sample_indices</span><span class="grouping">)</span>
    <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_node_value</span><span class="grouping">(</span><span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span>
                               <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">l2_regularization</span><span class="grouping">)</span>
    <span class="identifier">split_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">find_node_split</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">histograms</span><span class="punctuation">,</span>
                                          <span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span> <span class="identifier">value</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">gain</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'X_binned, all_gradients, has_missing_values, n_bins_non_missing, '</span>
    <span class="string-literal">' expected_split_on_nan, expected_bin_idx, expected_go_to_left'</span><span class="punctuation">,</span> <span class="grouping">[</span>

        <span class="comment"># basic sanity check with no missing values: given the gradient</span>
        <span class="comment"># values, the split must occur on bin_idx=3</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># X_binned</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># gradients</span>
         <span class="bool-literal">False</span><span class="punctuation">,</span>  <span class="comment"># no missing values</span>
         <span class="int-literal">10</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="bool-literal">False</span><span class="punctuation">,</span>  <span class="comment"># don't split on nans</span>
         <span class="int-literal">3</span><span class="punctuation">,</span>  <span class="comment"># expected_bin_idx</span>
         <span class="string-literal">'not_applicable'</span><span class="grouping">)</span><span class="punctuation">,</span>

        <span class="comment"># We replace 2 samples by NaNs (bin_idx=8)</span>
        <span class="comment"># These 2 samples were mapped to the left node before, so they should</span>
        <span class="comment"># be mapped to left node again</span>
        <span class="comment"># Notice how the bin_idx threshold changes from 3 to 1.</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 8 &lt;=&gt; missing</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># missing values</span>
         <span class="int-literal">8</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="bool-literal">False</span><span class="punctuation">,</span>  <span class="comment"># don't split on nans</span>
         <span class="int-literal">1</span><span class="punctuation">,</span>  <span class="comment"># cut on bin_idx=1</span>
         <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># missing values go to left</span>

        <span class="comment"># same as above, but with non-consecutive missing_values_bin</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 9 &lt;=&gt; missing</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># missing values</span>
         <span class="int-literal">8</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="bool-literal">False</span><span class="punctuation">,</span>  <span class="comment"># don't split on nans</span>
         <span class="int-literal">1</span><span class="punctuation">,</span>  <span class="comment"># cut on bin_idx=1</span>
         <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># missing values go to left</span>

        <span class="comment"># this time replacing 2 samples that were on the right.</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 8 &lt;=&gt; missing</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># missing values</span>
         <span class="int-literal">8</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="bool-literal">False</span><span class="punctuation">,</span>  <span class="comment"># don't split on nans</span>
         <span class="int-literal">3</span><span class="punctuation">,</span>  <span class="comment"># cut on bin_idx=3 (like in first case)</span>
         <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># missing values go to right</span>

        <span class="comment"># same as above, but with non-consecutive missing_values_bin</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 9 &lt;=&gt; missing</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># missing values</span>
         <span class="int-literal">8</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="bool-literal">False</span><span class="punctuation">,</span>  <span class="comment"># don't split on nans</span>
         <span class="int-literal">3</span><span class="punctuation">,</span>  <span class="comment"># cut on bin_idx=3 (like in first case)</span>
         <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># missing values go to right</span>

        <span class="comment"># For the following cases, split_on_nans is True (we replace all of</span>
        <span class="comment"># the samples with nans, instead of just 2).</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 4 &lt;=&gt; missing</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># missing values</span>
         <span class="int-literal">4</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># split on nans</span>
         <span class="int-literal">3</span><span class="punctuation">,</span>  <span class="comment"># cut on bin_idx=3</span>
         <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># missing values go to right</span>

        <span class="comment"># same as above, but with non-consecutive missing_values_bin</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 9 &lt;=&gt; missing</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># missing values</span>
         <span class="int-literal">4</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># split on nans</span>
         <span class="int-literal">3</span><span class="punctuation">,</span>  <span class="comment"># cut on bin_idx=3</span>
         <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># missing values go to right</span>

        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 6 &lt;=&gt; missing</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># missing values</span>
         <span class="int-literal">6</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># split on nans</span>
         <span class="int-literal">5</span><span class="punctuation">,</span>  <span class="comment"># cut on bin_idx=5</span>
         <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># missing values go to right</span>

        <span class="comment"># same as above, but with non-consecutive missing_values_bin</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 9 &lt;=&gt; missing</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># missing values</span>
         <span class="int-literal">6</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># split on nans</span>
         <span class="int-literal">5</span><span class="punctuation">,</span>  <span class="comment"># cut on bin_idx=5</span>
         <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># missing values go to right</span>
    <span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_splitting_missing_values</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span>
                                  <span class="identifier">has_missing_values</span><span class="punctuation">,</span> <span class="identifier">n_bins_non_missing</span><span class="punctuation">,</span>
                                  <span class="identifier">expected_split_on_nan</span><span class="punctuation">,</span> <span class="identifier">expected_bin_idx</span><span class="punctuation">,</span>
                                  <span class="identifier">expected_go_to_left</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure missing values are properly supported.</span>
    <span class="comment"># we build an artificial example with gradients such that the best split</span>
    <span class="comment"># is on bin_idx=3, when there are no missing values.</span>
    <span class="comment"># Then we introduce missing values and:</span>
    <span class="comment">#   - make sure the chosen bin is correct (find_best_bin()): it's</span>
    <span class="comment">#     still the same split, even though the index of the bin may change</span>
    <span class="comment">#   - make sure the missing values are mapped to the correct child</span>
    <span class="comment">#     (split_indices())</span>

    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>
    <span class="identifier">l2_regularization</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="identifier">min_hessian_to_split</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-3</span>
    <span class="identifier">min_samples_leaf</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">min_gain_to_split</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>

    <span class="identifier">sample_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_BINNED_DTYPE</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>
    <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">has_missing_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">has_missing_values</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">sum_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_gradients</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">sum_hessians</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span>
    <span class="identifier">hessians_are_constant</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>

    <span class="identifier">builder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistogramBuilder</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="punctuation">,</span>
                               <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="punctuation">,</span>
                               <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>

    <span class="identifier">n_bins_non_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">n_bins_non_missing</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">monotonic_cst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="identifier">MonotonicConstraint</span><span class="punctuation">.</span><span class="identifier">NO_CST</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int8</span><span class="grouping">)</span>
    <span class="identifier">is_categorical</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">monotonic_cst</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">missing_values_bin_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">splitter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Splitter</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins_non_missing</span><span class="punctuation">,</span>
                        <span class="identifier">missing_values_bin_idx</span><span class="punctuation">,</span> <span class="identifier">has_missing_values</span><span class="punctuation">,</span>
                        <span class="identifier">is_categorical</span><span class="punctuation">,</span> <span class="identifier">monotonic_cst</span><span class="punctuation">,</span>
                        <span class="identifier">l2_regularization</span><span class="punctuation">,</span> <span class="identifier">min_hessian_to_split</span><span class="punctuation">,</span>
                        <span class="identifier">min_samples_leaf</span><span class="punctuation">,</span> <span class="identifier">min_gain_to_split</span><span class="punctuation">,</span>
                        <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>

    <span class="identifier">histograms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">builder</span><span class="punctuation">.</span><span class="identifier">compute_histograms_brute</span><span class="grouping">(</span><span class="identifier">sample_indices</span><span class="grouping">)</span>
    <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_node_value</span><span class="grouping">(</span><span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span>
                               <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">l2_regularization</span><span class="grouping">)</span>
    <span class="identifier">split_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">find_node_split</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">histograms</span><span class="punctuation">,</span>
                                          <span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span> <span class="identifier">value</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">bin_idx</span> <span class="relational-operator">==</span> <span class="identifier">expected_bin_idx</span>
    <span class="keyword">if</span> <span class="identifier">has_missing_values</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">missing_go_to_left</span> <span class="relational-operator">==</span> <span class="identifier">expected_go_to_left</span>

    <span class="identifier">split_on_nan</span> <span class="arithmetic-assignment">=</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">bin_idx</span> <span class="relational-operator">==</span> <span class="identifier">n_bins_non_missing</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">split_on_nan</span> <span class="relational-operator">==</span> <span class="identifier">expected_split_on_nan</span>

    <span class="comment"># Make sure the split is properly computed.</span>
    <span class="comment"># This also make sure missing values are properly assigned to the correct</span>
    <span class="comment"># child in split_indices()</span>
    <span class="identifier">samples_left</span><span class="punctuation">,</span> <span class="identifier">samples_right</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">split_indices</span><span class="grouping">(</span>
        <span class="identifier">split_info</span><span class="punctuation">,</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">partition</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">expected_split_on_nan</span><span class="punctuation">:</span>
        <span class="comment"># When we don't split on nans, the split should always be the same.</span>
        <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">samples_left</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">samples_right</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="comment"># When we split on nans, samples with missing values are always mapped</span>
        <span class="comment"># to the right child.</span>
        <span class="identifier">missing_samples_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">flatnonzero</span><span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">missing_values_bin_idx</span><span class="grouping">)</span>
        <span class="identifier">non_missing_samples_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">flatnonzero</span><span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="identifier">missing_values_bin_idx</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">samples_right</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">missing_samples_indices</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">samples_left</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">non_missing_samples_indices</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'X_binned, has_missing_values, n_bins_non_missing, '</span><span class="punctuation">,</span> <span class="grouping">[</span>
        <span class="comment"># one category</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>

        <span class="comment"># all categories appear less than MIN_CAT_SUPPORT (hardcoded to 10)</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">9</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>

        <span class="comment"># only one category appears more than MIN_CAT_SUPPORT</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">12</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>

        <span class="comment"># missing values + category appear less than MIN_CAT_SUPPORT</span>
        <span class="comment"># 9 is missing</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">9</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">8</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">9</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>

        <span class="comment"># no non-missing category</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">9</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_splitting_categorical_cat_smooth</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">has_missing_values</span><span class="punctuation">,</span>
                                          <span class="identifier">n_bins_non_missing</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks categorical splits are correct when the MIN_CAT_SUPPORT constraint</span>
    <span class="comment"># isn't respected: there are no splits</span>

    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X_binned</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_BINNED_DTYPE</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>

    <span class="identifier">l2_regularization</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>
    <span class="identifier">min_hessian_to_split</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-3</span>
    <span class="identifier">min_samples_leaf</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">min_gain_to_split</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>

    <span class="identifier">sample_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">has_missing_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">has_missing_values</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">sum_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_gradients</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">sum_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span>
    <span class="identifier">hessians_are_constant</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>

    <span class="identifier">builder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistogramBuilder</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span>
                               <span class="identifier">all_hessians</span><span class="punctuation">,</span> <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>

    <span class="identifier">n_bins_non_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">n_bins_non_missing</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">monotonic_cst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">MonotonicConstraint</span><span class="punctuation">.</span><span class="identifier">NO_CST</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                             <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int8</span><span class="grouping">)</span>
    <span class="identifier">is_categorical</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones_like</span><span class="grouping">(</span><span class="identifier">monotonic_cst</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">missing_values_bin_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

    <span class="identifier">splitter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Splitter</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins_non_missing</span><span class="punctuation">,</span>
                        <span class="identifier">missing_values_bin_idx</span><span class="punctuation">,</span> <span class="identifier">has_missing_values</span><span class="punctuation">,</span>
                        <span class="identifier">is_categorical</span><span class="punctuation">,</span> <span class="identifier">monotonic_cst</span><span class="punctuation">,</span>
                        <span class="identifier">l2_regularization</span><span class="punctuation">,</span> <span class="identifier">min_hessian_to_split</span><span class="punctuation">,</span>
                        <span class="identifier">min_samples_leaf</span><span class="punctuation">,</span> <span class="identifier">min_gain_to_split</span><span class="punctuation">,</span>
                        <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>

    <span class="identifier">histograms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">builder</span><span class="punctuation">.</span><span class="identifier">compute_histograms_brute</span><span class="grouping">(</span><span class="identifier">sample_indices</span><span class="grouping">)</span>
    <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_node_value</span><span class="grouping">(</span><span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span>
                               <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">l2_regularization</span><span class="grouping">)</span>
    <span class="identifier">split_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">find_node_split</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">histograms</span><span class="punctuation">,</span>
                                          <span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span> <span class="identifier">value</span><span class="grouping">)</span>

    <span class="comment"># no split found</span>
    <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">gain</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>


<span class="keyword">def</span> <span class="identifier">_assert_categories_equals_bitset</span><span class="grouping">(</span><span class="identifier">categories</span><span class="punctuation">,</span> <span class="identifier">bitset</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># assert that the bitset exactly corresponds to the categories</span>
    <span class="comment"># bitset is assumed to be an array of 8 uint32 elements</span>

    <span class="comment"># form bitset from threshold</span>
    <span class="identifier">expected_bitset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">cat</span> <span class="relational-operator">in</span> <span class="identifier">categories</span><span class="punctuation">:</span>
        <span class="identifier">idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cat</span> <span class="arithmetic-operator">//</span> <span class="int-literal">32</span>
        <span class="identifier">shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cat</span> <span class="arithmetic-operator">%</span> <span class="int-literal">32</span>
        <span class="identifier">expected_bitset</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span> <span class="bitwise-assignment">|=</span> <span class="int-literal">1</span> <span class="bitwise-operator">&lt;&lt;</span> <span class="identifier">shift</span>

    <span class="comment"># check for equality</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_bitset</span><span class="punctuation">,</span> <span class="identifier">bitset</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"X_binned, all_gradients, expected_categories_left, n_bins_non_missing,"</span>
    <span class="string-literal">"missing_values_bin_idx, has_missing_values, expected_missing_go_to_left"</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="comment"># 4 categories</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span><span class="punctuation">,</span>  <span class="comment"># X_binned</span>
         <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span><span class="punctuation">,</span>  <span class="comment"># all_gradients</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># expected_categories_left</span>
         <span class="int-literal">4</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="int-literal">4</span><span class="punctuation">,</span>  <span class="comment"># missing_values_bin_idx</span>
         <span class="bool-literal">False</span><span class="punctuation">,</span>  <span class="comment"># has_missing_values</span>
         <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># expected_missing_go_to_left, unchecked</span>

        <span class="comment"># Make sure that the categories that are on the right (second half) of</span>
        <span class="comment"># the sorted categories array can still go in the left child. In this</span>
        <span class="comment"># case, the best split was found when scanning from right to left.</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span><span class="punctuation">,</span>  <span class="comment"># X_binned</span>
         <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span><span class="punctuation">,</span>  <span class="comment"># all_gradients</span>
         <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># expected_categories_left</span>
         <span class="int-literal">4</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="int-literal">4</span><span class="punctuation">,</span>  <span class="comment"># missing_values_bin_idx</span>
         <span class="bool-literal">False</span><span class="punctuation">,</span>  <span class="comment"># has_missing_values</span>
         <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># expected_missing_go_to_left, unchecked</span>

        <span class="comment"># categories that don't respect MIN_CAT_SUPPORT (cat 4) are always</span>
        <span class="comment"># mapped to the right child</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span><span class="punctuation">,</span>  <span class="comment"># X_binned</span>
         <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span><span class="punctuation">,</span>  <span class="comment"># all_gradients</span>
         <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># expected_categories_left</span>
         <span class="int-literal">4</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="int-literal">4</span><span class="punctuation">,</span>  <span class="comment"># missing_values_bin_idx</span>
         <span class="bool-literal">False</span><span class="punctuation">,</span>  <span class="comment"># has_missing_values</span>
         <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># expected_missing_go_to_left, unchecked</span>

        <span class="comment"># categories that don't respect MIN_CAT_SUPPORT are always mapped to</span>
        <span class="comment"># the right child: in this case a more sensible split could have been</span>
        <span class="comment"># 3, 4 - 0, 1, 2</span>
        <span class="comment"># But the split is still 3 - 0, 1, 2, 4. this is because we only scan</span>
        <span class="comment"># up to the middle of the sorted category array (0, 1, 2, 3), and</span>
        <span class="comment"># because we exclude cat 4 in this array.</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span><span class="punctuation">,</span>  <span class="comment"># X_binned</span>
         <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span><span class="punctuation">,</span>  <span class="comment"># all_gradients</span>
         <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># expected_categories_left</span>
         <span class="int-literal">4</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="int-literal">4</span><span class="punctuation">,</span>  <span class="comment"># missing_values_bin_idx</span>
         <span class="bool-literal">False</span><span class="punctuation">,</span>  <span class="comment"># has_missing_values</span>
         <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># expected_missing_go_to_left, unchecked</span>

        <span class="comment"># 4 categories with missing values that go to the right</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">9</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span><span class="punctuation">,</span>  <span class="comment"># X_binned</span>
         <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span><span class="punctuation">,</span>  <span class="comment"># all_gradients</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># expected_categories_left</span>
         <span class="int-literal">3</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="int-literal">9</span><span class="punctuation">,</span>  <span class="comment"># missing_values_bin_idx</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>   <span class="comment"># has_missing_values</span>
         <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># expected_missing_go_to_left</span>

        <span class="comment"># 4 categories with missing values that go to the left</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">9</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span><span class="punctuation">,</span>  <span class="comment"># X_binned</span>
         <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span><span class="punctuation">,</span>  <span class="comment"># all_gradients</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># expected_categories_left</span>
         <span class="int-literal">3</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="int-literal">9</span><span class="punctuation">,</span>  <span class="comment"># missing_values_bin_idx</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>   <span class="comment"># has_missing_values</span>
         <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># expected_missing_go_to_left</span>

        <span class="comment"># split is on the missing value</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">255</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">12</span><span class="punctuation">,</span>  <span class="comment"># X_binned</span>
         <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">12</span><span class="punctuation">,</span>  <span class="comment"># all_gradients</span>
         <span class="grouping">[</span><span class="int-literal">255</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># expected_categories_left</span>
         <span class="int-literal">5</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="int-literal">255</span><span class="punctuation">,</span>  <span class="comment"># missing_values_bin_idx</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>   <span class="comment"># has_missing_values</span>
         <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># expected_missing_go_to_left</span>

        <span class="comment"># split on even categories</span>
        <span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">60</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">12</span><span class="punctuation">,</span>  <span class="comment"># X_binned</span>
         <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">360</span><span class="punctuation">,</span>  <span class="comment"># all_gradients</span>
         <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">60</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># expected_categories_left</span>
         <span class="int-literal">59</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="int-literal">59</span><span class="punctuation">,</span>  <span class="comment"># missing_values_bin_idx</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># has_missing_values</span>
         <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># expected_missing_go_to_left</span>

        <span class="comment"># split on every 8 categories</span>
        <span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">256</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">12</span><span class="punctuation">,</span>  <span class="comment"># X_binned</span>
         <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">384</span><span class="punctuation">,</span>  <span class="comment"># all_gradients</span>
         <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># expected_categories_left</span>
         <span class="int-literal">255</span><span class="punctuation">,</span>  <span class="comment"># n_bins_non_missing</span>
         <span class="int-literal">255</span><span class="punctuation">,</span>  <span class="comment"># missing_values_bin_idx</span>
         <span class="bool-literal">True</span><span class="punctuation">,</span>  <span class="comment"># has_missing_values</span>
         <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># expected_missing_go_to_left</span>
     <span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_splitting_categorical_sanity</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span>
                                      <span class="identifier">expected_categories_left</span><span class="punctuation">,</span>
                                      <span class="identifier">n_bins_non_missing</span><span class="punctuation">,</span>
                                      <span class="identifier">missing_values_bin_idx</span><span class="punctuation">,</span>
                                      <span class="identifier">has_missing_values</span><span class="punctuation">,</span>
                                      <span class="identifier">expected_missing_go_to_left</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Tests various combinations of categorical splits</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>
    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>

    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_BINNED_DTYPE</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>

    <span class="identifier">l2_regularization</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>
    <span class="identifier">min_hessian_to_split</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-3</span>
    <span class="identifier">min_samples_leaf</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">min_gain_to_split</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>

    <span class="identifier">sample_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">has_missing_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">has_missing_values</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">sum_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_gradients</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">sum_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span>
    <span class="identifier">hessians_are_constant</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>

    <span class="identifier">builder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistogramBuilder</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span>
                               <span class="identifier">all_hessians</span><span class="punctuation">,</span> <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>

    <span class="identifier">n_bins_non_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">n_bins_non_missing</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">monotonic_cst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">MonotonicConstraint</span><span class="punctuation">.</span><span class="identifier">NO_CST</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                             <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int8</span><span class="grouping">)</span>
    <span class="identifier">is_categorical</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones_like</span><span class="grouping">(</span><span class="identifier">monotonic_cst</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>

    <span class="identifier">splitter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Splitter</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">n_bins_non_missing</span><span class="punctuation">,</span>
                        <span class="identifier">missing_values_bin_idx</span><span class="punctuation">,</span> <span class="identifier">has_missing_values</span><span class="punctuation">,</span>
                        <span class="identifier">is_categorical</span><span class="punctuation">,</span> <span class="identifier">monotonic_cst</span><span class="punctuation">,</span>
                        <span class="identifier">l2_regularization</span><span class="punctuation">,</span> <span class="identifier">min_hessian_to_split</span><span class="punctuation">,</span>
                        <span class="identifier">min_samples_leaf</span><span class="punctuation">,</span> <span class="identifier">min_gain_to_split</span><span class="punctuation">,</span>
                        <span class="identifier">hessians_are_constant</span><span class="grouping">)</span>

    <span class="identifier">histograms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">builder</span><span class="punctuation">.</span><span class="identifier">compute_histograms_brute</span><span class="grouping">(</span><span class="identifier">sample_indices</span><span class="grouping">)</span>

    <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_node_value</span><span class="grouping">(</span><span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span>
                               <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">l2_regularization</span><span class="grouping">)</span>
    <span class="identifier">split_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">find_node_split</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">histograms</span><span class="punctuation">,</span>
                                          <span class="identifier">sum_gradients</span><span class="punctuation">,</span> <span class="identifier">sum_hessians</span><span class="punctuation">,</span> <span class="identifier">value</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">is_categorical</span>
    <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">gain</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>
    <span class="identifier">_assert_categories_equals_bitset</span><span class="grouping">(</span><span class="identifier">expected_categories_left</span><span class="punctuation">,</span>
                                     <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">left_cat_bitset</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">has_missing_values</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">missing_go_to_left</span> <span class="relational-operator">==</span> <span class="identifier">expected_missing_go_to_left</span>
    <span class="comment"># If there is no missing value during training, the flag missing_go_to_left</span>
    <span class="comment"># is set later in the grower.</span>

    <span class="comment"># make sure samples are split correctly</span>
    <span class="identifier">samples_left</span><span class="punctuation">,</span> <span class="identifier">samples_right</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">split_indices</span><span class="grouping">(</span>
        <span class="identifier">split_info</span><span class="punctuation">,</span> <span class="identifier">splitter</span><span class="punctuation">.</span><span class="identifier">partition</span><span class="grouping">)</span>

    <span class="identifier">left_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isin</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">expected_categories_left</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sample_indices</span><span class="grouping">[</span><span class="identifier">left_mask</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">samples_left</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sample_indices</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">left_mask</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">samples_right</span><span class="grouping">)</span>

    </pre>
  </body>
</html>