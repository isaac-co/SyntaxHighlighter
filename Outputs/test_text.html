<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># -*- coding: utf-8 -*-</span>
<span class="keyword">from</span> <span class="identifier">collections</span><span class="punctuation">.</span><span class="identifier">abc</span> <span class="keyword">import</span> <span class="identifier">Mapping</span>
<span class="keyword">import</span> <span class="identifier">re</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">sparse</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">text</span> <span class="keyword">import</span> <span class="identifier">strip_tags</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">text</span> <span class="keyword">import</span> <span class="identifier">strip_accents_unicode</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">text</span> <span class="keyword">import</span> <span class="identifier">strip_accents_ascii</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">text</span> <span class="keyword">import</span> <span class="identifier">HashingVectorizer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">text</span> <span class="keyword">import</span> <span class="identifier">CountVectorizer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">text</span> <span class="keyword">import</span> <span class="identifier">TfidfTransformer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">text</span> <span class="keyword">import</span> <span class="identifier">TfidfVectorizer</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">text</span> <span class="keyword">import</span> <span class="identifier">ENGLISH_STOP_WORDS</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">cross_val_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GridSearchCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">Pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">LinearSVC</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">clone</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">IS_PYPY</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
                                    <span class="identifier">fails_if_pypy</span><span class="punctuation">,</span>
                                    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="punctuation">,</span>
                                    <span class="identifier">skip_if_32bit</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">collections</span> <span class="keyword">import</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span>
<span class="keyword">from</span> <span class="identifier">functools</span> <span class="keyword">import</span> <span class="identifier">partial</span>
<span class="keyword">import</span> <span class="identifier">pickle</span>
<span class="keyword">from</span> <span class="identifier">io</span> <span class="keyword">import</span> <span class="identifier">StringIO</span>

<span class="identifier">JUNK_FOOD_DOCS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
    <span class="string-literal">"the pizza pizza beer copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the pizza burger beer copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the the pizza beer beer copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the burger beer beer copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the coke burger coke copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the coke burger burger"</span><span class="punctuation">,</span>
<span class="grouping">)</span>

<span class="identifier">NOTJUNK_FOOD_DOCS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
    <span class="string-literal">"the salad celeri copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the salad salad sparkling water copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the the celeri celeri copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the tomato tomato salad water"</span><span class="punctuation">,</span>
    <span class="string-literal">"the tomato salad water copyright"</span><span class="punctuation">,</span>
<span class="grouping">)</span>

<span class="identifier">ALL_FOOD_DOCS</span> <span class="arithmetic-assignment">=</span> <span class="identifier">JUNK_FOOD_DOCS</span> <span class="arithmetic-operator">+</span> <span class="identifier">NOTJUNK_FOOD_DOCS</span>


<span class="keyword">def</span> <span class="identifier">uppercase</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="identifier">strip_accents_unicode</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">upper</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">strip_eacute</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">'é', 'e'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">split_tokenize</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">lazy_analyze</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="grouping">[</span><span class="string-literal">'the_ultimate_feature'</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_strip_accents</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check some classical latin accentuated symbols</span>
    <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'àáâãäåçèéêë'</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'aaaaaaceeee'</span>
    <span class="keyword">assert</span> <span class="identifier">strip_accents_unicode</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'ìíîïñòóôõöùúûüý'</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'iiiinooooouuuuy'</span>
    <span class="keyword">assert</span> <span class="identifier">strip_accents_unicode</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="comment"># check some arabic</span>
    <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'\u0625'</span>  <span class="comment"># alef with a hamza below: إ</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'\u0627'</span>  <span class="comment"># simple alef: ا</span>
    <span class="keyword">assert</span> <span class="identifier">strip_accents_unicode</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="comment"># mix letters accentuated and not</span>
    <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"this is à test"</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'this is a test'</span>
    <span class="keyword">assert</span> <span class="identifier">strip_accents_unicode</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="comment"># strings that are already decomposed</span>
    <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"o\u0308"</span>  <span class="comment"># o with diaresis</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"o"</span>
    <span class="keyword">assert</span> <span class="identifier">strip_accents_unicode</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="comment"># combining marks by themselves</span>
    <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"\u0300\u0301\u0302\u0303"</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">""</span>
    <span class="keyword">assert</span> <span class="identifier">strip_accents_unicode</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="comment"># Multiple combining marks on one character</span>
    <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"o\u0308\u0304"</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"o"</span>
    <span class="keyword">assert</span> <span class="identifier">strip_accents_unicode</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>


<span class="keyword">def</span> <span class="identifier">test_to_ascii</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check some classical latin accentuated symbols</span>
    <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'àáâãäåçèéêë'</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'aaaaaaceeee'</span>
    <span class="keyword">assert</span> <span class="identifier">strip_accents_ascii</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"ìíîïñòóôõöùúûüý"</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'iiiinooooouuuuy'</span>
    <span class="keyword">assert</span> <span class="identifier">strip_accents_ascii</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="comment"># check some arabic</span>
    <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'\u0625'</span>  <span class="comment"># halef with a hamza below</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">''</span>  <span class="comment"># halef has no direct ascii match</span>
    <span class="keyword">assert</span> <span class="identifier">strip_accents_ascii</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="comment"># mix letters accentuated and not</span>
    <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"this is à test"</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'this is a test'</span>
    <span class="keyword">assert</span> <span class="identifier">strip_accents_ascii</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Vectorizer'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">CountVectorizer</span><span class="punctuation">,</span> <span class="identifier">HashingVectorizer</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_word_analyzer_unigrams</span><span class="grouping">(</span><span class="identifier">Vectorizer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">wa</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Vectorizer</span><span class="grouping">(</span><span class="identifier">strip_accents</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ascii'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"J'ai mangé du kangourou  ce midi, "</span>
            <span class="string-literal">"c'était pas très bon."</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'ai', 'mange', 'du', 'kangourou', 'ce', 'midi'</span><span class="punctuation">,</span>
                <span class="string-literal">'etait', 'pas', 'tres', 'bon'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">wa</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"This is a test, really.\n\n I met Harry yesterday."</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'this', 'is', 'test', 'really', 'met', 'harry'</span><span class="punctuation">,</span>
                <span class="string-literal">'yesterday'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">wa</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="identifier">wa</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Vectorizer</span><span class="grouping">(</span><span class="identifier">input</span><span class="arithmetic-assignment">=</span><span class="string-literal">'file'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StringIO</span><span class="grouping">(</span><span class="string-literal">"This is a test with a file-like object!"</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'this', 'is', 'test', 'with', 'file', 'like'</span><span class="punctuation">,</span>
                <span class="string-literal">'object'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">wa</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="comment"># with custom preprocessor</span>
    <span class="identifier">wa</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Vectorizer</span><span class="grouping">(</span><span class="identifier">preprocessor</span><span class="arithmetic-assignment">=</span><span class="identifier">uppercase</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"J'ai mangé du kangourou  ce midi, "</span>
            <span class="string-literal">" c'était pas très bon."</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'AI', 'MANGE', 'DU', 'KANGOUROU', 'CE', 'MIDI'</span><span class="punctuation">,</span>
                <span class="string-literal">'ETAIT', 'PAS', 'TRES', 'BON'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">wa</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="comment"># with custom tokenizer</span>
    <span class="identifier">wa</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Vectorizer</span><span class="grouping">(</span><span class="identifier">tokenizer</span><span class="arithmetic-assignment">=</span><span class="identifier">split_tokenize</span><span class="punctuation">,</span>
                    <span class="identifier">strip_accents</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ascii'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"J'ai mangé du kangourou  ce midi, "</span>
            <span class="string-literal">"c'était pas très bon."</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"j'ai"</span><span class="punctuation">,</span> <span class="string-literal">'mange', 'du', 'kangourou', 'ce', 'midi,'</span><span class="punctuation">,</span>
                <span class="string-literal">"c'etait"</span><span class="punctuation">,</span> <span class="string-literal">'pas', 'tres', 'bon.'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">wa</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>


<span class="keyword">def</span> <span class="identifier">test_word_analyzer_unigrams_and_bigrams</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">wa</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">"word"</span><span class="punctuation">,</span> <span class="identifier">strip_accents</span><span class="arithmetic-assignment">=</span><span class="string-literal">'unicode'</span><span class="punctuation">,</span>
                         <span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"J'ai mangé du kangourou  ce midi, c'était pas très bon."</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'ai', 'mange', 'du', 'kangourou', 'ce', 'midi'</span><span class="punctuation">,</span>
                <span class="string-literal">'etait', 'pas', 'tres', 'bon', 'ai mange', 'mange du'</span><span class="punctuation">,</span>
                <span class="string-literal">'du kangourou', 'kangourou ce', 'ce midi', 'midi etait'</span><span class="punctuation">,</span>
                <span class="string-literal">'etait pas', 'pas tres', 'tres bon'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">wa</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>


<span class="keyword">def</span> <span class="identifier">test_unicode_decode_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># decode_error default to strict, so this should fail</span>
    <span class="comment"># First, encode (as bytes) a unicode string.</span>
    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"J'ai mangé du kangourou  ce midi, c'était pas très bon."</span>
    <span class="identifier">text_bytes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">text</span><span class="punctuation">.</span><span class="identifier">encode</span><span class="grouping">(</span><span class="string-literal">'utf-8'</span><span class="grouping">)</span>

    <span class="comment"># Then let the Analyzer try to decode it as ascii. It should fail,</span>
    <span class="comment"># because we have given it an incorrect encoding.</span>
    <span class="identifier">wa</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">encoding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ascii'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">UnicodeDecodeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">wa</span><span class="grouping">(</span><span class="identifier">text_bytes</span><span class="grouping">)</span>

    <span class="identifier">ca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="punctuation">,</span> <span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="identifier">encoding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ascii'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">UnicodeDecodeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ca</span><span class="grouping">(</span><span class="identifier">text_bytes</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_char_ngram_analyzer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">cnga</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char', strip_accents='unicode'</span><span class="punctuation">,</span>
                           <span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"J'ai mangé du kangourou  ce midi, c'était pas très bon"</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"j'a", "'ai"</span><span class="punctuation">,</span> <span class="string-literal">'ai ', 'i m', ' ma'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">cnga</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'s tres', ' tres ', 'tres b', 'res bo', 'es bon'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">cnga</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"This \n\tis a test, really.\n\n I met Harry yesterday"</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'thi', 'his', 'is ', 's i', ' is'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">cnga</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">' yeste', 'yester', 'esterd', 'sterda', 'terday'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">cnga</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="identifier">cnga</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">input</span><span class="arithmetic-assignment">=</span><span class="string-literal">'file', analyzer='char'</span><span class="punctuation">,</span>
                           <span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StringIO</span><span class="grouping">(</span><span class="string-literal">"This is a test with a file-like object!"</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'thi', 'his', 'is ', 's i', ' is'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">cnga</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>


<span class="keyword">def</span> <span class="identifier">test_char_wb_ngram_analyzer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">cnga</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char_wb', strip_accents='unicode'</span><span class="punctuation">,</span>
                           <span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"This \n\tis a test, really.\n\n I met Harry yesterday"</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">' th', 'thi', 'his', 'is ', ' thi'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">cnga</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'yester', 'esterd', 'sterda', 'terday', 'erday '</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">cnga</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="identifier">cnga</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">input</span><span class="arithmetic-assignment">=</span><span class="string-literal">'file', analyzer='char_wb'</span><span class="punctuation">,</span>
                           <span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StringIO</span><span class="grouping">(</span><span class="string-literal">"A test with a file-like object!"</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">' a ', ' te', 'tes', 'est', 'st ', ' tes'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">cnga</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">6</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>


<span class="keyword">def</span> <span class="identifier">test_word_ngram_analyzer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">cnga</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'word', strip_accents='unicode'</span><span class="punctuation">,</span>
                           <span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"This \n\tis a test, really.\n\n I met Harry yesterday"</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'this is test', 'is test really', 'test really met'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">cnga</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'test really met harry yesterday'</span><span class="punctuation">,</span>
                <span class="string-literal">'this is test really met harry'</span><span class="punctuation">,</span>
                <span class="string-literal">'is test really met harry yesterday'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">cnga</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>

    <span class="identifier">cnga_file</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">input</span><span class="arithmetic-assignment">=</span><span class="string-literal">'file', analyzer='word'</span><span class="punctuation">,</span>
                                <span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">file</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StringIO</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">cnga_file</span><span class="grouping">(</span><span class="identifier">file</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">cnga</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_countvectorizer_custom_vocabulary</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">vocab</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"pizza": 0, "beer"</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span>
    <span class="identifier">terms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">vocab</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Try a few of the supported types.</span>
    <span class="keyword">for</span> <span class="identifier">typ</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">dict</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="punctuation">,</span> <span class="identifier">iter</span><span class="punctuation">,</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">typ</span><span class="grouping">(</span><span class="identifier">vocab</span><span class="grouping">)</span>
        <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">v</span><span class="grouping">)</span>
        <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">Mapping</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span> <span class="relational-operator">==</span> <span class="identifier">vocab</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">terms</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">terms</span><span class="grouping">)</span>
        <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">typ</span><span class="grouping">(</span><span class="identifier">vocab</span><span class="grouping">)</span>
        <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">v</span><span class="grouping">)</span>
        <span class="identifier">inv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">inv</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_countvectorizer_custom_vocabulary_pipeline</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">what_we_like</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"pizza", "beer"</span><span class="grouping">]</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'count'</span><span class="punctuation">,</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">what_we_like</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'tfidf'</span><span class="punctuation">,</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'count'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="grouping">)</span> <span class="relational-operator">==</span>
            <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">what_we_like</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">what_we_like</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_countvectorizer_custom_vocabulary_repeated_indices</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">vocab</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"pizza": 0, "beer"</span><span class="punctuation">:</span> <span class="int-literal">0</span><span class="grouping">}</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Vocabulary contains repeated indices"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">vocab</span><span class="grouping">)</span>
        <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"pasta_siziliana"</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_countvectorizer_custom_vocabulary_gap_index</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">vocab</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"pizza": 1, "beer"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"doesn't contain index"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">vocab</span><span class="grouping">)</span>
        <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'pasta_verdura'</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_countvectorizer_stop_words</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="string-literal">'english'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">get_stop_words</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">ENGLISH_STOP_WORDS</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="string-literal">'_bad_str_stop_'</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">get_stop_words</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="string-literal">'_bad_unicode_stop_'</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">get_stop_words</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">stoplist</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'some', 'other', 'words'</span><span class="grouping">]</span>
    <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="identifier">stoplist</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">get_stop_words</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">stoplist</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_countvectorizer_empty_vocabulary</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"empty vocabulary"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"foo"</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"empty vocabulary"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">max_df</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="string-literal">"english"</span><span class="grouping">)</span>
        <span class="comment"># fit on stopwords only</span>
        <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"to be or not to be", "and me too", "and so do you"</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_fit_countvectorizer_twice</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X1</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_countvectorizer_custom_token_pattern</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check `get_feature_names()` when a custom token pattern is passed.
    Non-regression test for:
    https://github.com/scikit-learn/scikit-learn/issues/12971
    """</span>
    <span class="identifier">corpus</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="string-literal">'This is the 1st document in my corpus.'</span><span class="punctuation">,</span>
        <span class="string-literal">'This document is the 2nd sample.'</span><span class="punctuation">,</span>
        <span class="string-literal">'And this is the 3rd one.'</span><span class="punctuation">,</span>
        <span class="string-literal">'Is this the 4th document?'</span><span class="punctuation">,</span>
    <span class="grouping">]</span>
    <span class="identifier">token_pattern</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"[0-9]{1,3}(?:st|nd|rd|th)\s\b(\w{2,})\b"</span>
    <span class="identifier">vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">token_pattern</span><span class="arithmetic-assignment">=</span><span class="identifier">token_pattern</span><span class="grouping">)</span>
    <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">corpus</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'document', 'one', 'sample'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>


<span class="keyword">def</span> <span class="identifier">test_countvectorizer_custom_token_pattern_with_several_group</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that we raise an error if token pattern capture several groups.
    Non-regression test for:
    https://github.com/scikit-learn/scikit-learn/issues/12971
    """</span>
    <span class="identifier">corpus</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="string-literal">'This is the 1st document in my corpus.'</span><span class="punctuation">,</span>
        <span class="string-literal">'This document is the 2nd sample.'</span><span class="punctuation">,</span>
        <span class="string-literal">'And this is the 3rd one.'</span><span class="punctuation">,</span>
        <span class="string-literal">'Is this the 4th document?'</span><span class="punctuation">,</span>
    <span class="grouping">]</span>

    <span class="identifier">token_pattern</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"([0-9]{1,3}(?:st|nd|rd|th))\s\b(\w{2,})\b"</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"More than 1 capturing group in token pattern"</span>
    <span class="identifier">vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">token_pattern</span><span class="arithmetic-assignment">=</span><span class="identifier">token_pattern</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">corpus</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_countvectorizer_uppercase_in_vocab</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">vocabulary</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'Sample', 'Upper', 'Case' 'Vocabulary'</span><span class="grouping">]</span>
    <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Upper case characters found in"</span>
               <span class="string-literal">" vocabulary while 'lowercase'"</span>
               <span class="string-literal">" is True. These entries will not"</span>
               <span class="string-literal">" be matched with any documents"</span><span class="grouping">)</span>

    <span class="identifier">vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">lowercase</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">vocabulary</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_tf_idf_smoothing</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">tr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="identifier">smooth_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l2'</span><span class="grouping">)</span>
    <span class="identifier">tfidf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tr</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">tfidf</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># check normalization</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">tfidf</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># this is robust to features with only zeros</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">tr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="identifier">smooth_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l2'</span><span class="grouping">)</span>
    <span class="identifier">tfidf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tr</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">tfidf</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_tfidf_no_smoothing</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">tr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="identifier">smooth_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l2'</span><span class="grouping">)</span>
    <span class="identifier">tfidf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tr</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">tfidf</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># check normalization</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">tfidf</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># the lack of smoothing make IDF fragile in the presence of feature with</span>
    <span class="comment"># only zeros</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">tr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="identifier">smooth_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l2'</span><span class="grouping">)</span>

    <span class="identifier">in_warning_message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'divide by zero'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">RuntimeWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">in_warning_message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">tr</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sublinear_tf</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">tr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="identifier">sublinear_tf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">use_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">tfidf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tr</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">tfidf</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">tfidf</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="identifier">tfidf</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">tfidf</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="identifier">tfidf</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">tfidf</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="int-literal">2</span>
    <span class="keyword">assert</span> <span class="identifier">tfidf</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="int-literal">3</span>


<span class="keyword">def</span> <span class="identifier">test_vectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># raw documents as an iterator</span>
    <span class="identifier">train_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iter</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">test_data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">n_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

    <span class="comment"># test without vocabulary</span>
    <span class="identifier">v1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">max_df</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>
    <span class="identifier">counts_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v1</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">train_data</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">counts_train</span><span class="punctuation">,</span> <span class="string-literal">'tocsr'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">counts_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">counts_train</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">counts_train</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">v1</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="grouping">[</span><span class="string-literal">"pizza"</span><span class="grouping">]</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>

    <span class="comment"># build a vectorizer v1 with the same vocabulary as the one fitted by v1</span>
    <span class="identifier">v2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">v1</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="grouping">)</span>

    <span class="comment"># compare that the two vectorizer give the same output on the test sample</span>
    <span class="keyword">for</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">v1</span><span class="punctuation">,</span> <span class="identifier">v2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">counts_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">counts_test</span><span class="punctuation">,</span> <span class="string-literal">'tocsr'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">counts_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">counts_test</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">vocabulary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span>
        <span class="keyword">assert</span> <span class="identifier">counts_test</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">vocabulary</span><span class="grouping">[</span><span class="string-literal">"salad"</span><span class="grouping">]</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
        <span class="keyword">assert</span> <span class="identifier">counts_test</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">vocabulary</span><span class="grouping">[</span><span class="string-literal">"tomato"</span><span class="grouping">]</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
        <span class="keyword">assert</span> <span class="identifier">counts_test</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">vocabulary</span><span class="grouping">[</span><span class="string-literal">"water"</span><span class="grouping">]</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

        <span class="comment"># stop word from the fixed list</span>
        <span class="keyword">assert</span> <span class="string-literal">"the"</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">vocabulary</span>

        <span class="comment"># stop word found automatically by the vectorizer DF thresholding</span>
        <span class="comment"># words that are high frequent across the complete corpus are likely</span>
        <span class="comment"># to be not informative (either real stop words of extraction</span>
        <span class="comment"># artifacts)</span>
        <span class="keyword">assert</span> <span class="string-literal">"copyright"</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">vocabulary</span>

        <span class="comment"># not present in the sample</span>
        <span class="keyword">assert</span> <span class="identifier">counts_test</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">vocabulary</span><span class="grouping">[</span><span class="string-literal">"coke"</span><span class="grouping">]</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
        <span class="keyword">assert</span> <span class="identifier">counts_test</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">vocabulary</span><span class="grouping">[</span><span class="string-literal">"burger"</span><span class="grouping">]</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
        <span class="keyword">assert</span> <span class="identifier">counts_test</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">vocabulary</span><span class="grouping">[</span><span class="string-literal">"beer"</span><span class="grouping">]</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
        <span class="keyword">assert</span> <span class="identifier">counts_test</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">vocabulary</span><span class="grouping">[</span><span class="string-literal">"pizza"</span><span class="grouping">]</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>

    <span class="comment"># test tf-idf</span>
    <span class="identifier">t1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l1'</span><span class="grouping">)</span>
    <span class="identifier">tfidf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">t1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">counts_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">counts_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">t1</span><span class="punctuation">.</span><span class="identifier">idf_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">v1</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">tfidf</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">v1</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># test tf-idf with new data</span>
    <span class="identifier">tfidf_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">t1</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">counts_test</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">tfidf_test</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">v1</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># test tf alone</span>
    <span class="identifier">t2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l1'</span><span class="punctuation">,</span> <span class="identifier">use_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">tf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">t2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">counts_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">counts_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">t2</span><span class="punctuation">,</span> <span class="string-literal">"idf_"</span><span class="grouping">)</span>

    <span class="comment"># test idf transform with unlearned idf vector</span>
    <span class="identifier">t3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="identifier">use_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">t3</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">counts_train</span><span class="grouping">)</span>

    <span class="comment"># L1-normalized term frequencies sum to one</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">tf</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_train</span><span class="grouping">)</span>

    <span class="comment"># test the direct tfidf vectorizer</span>
    <span class="comment"># (equivalent to term count vectorizer + tfidf transformer)</span>
    <span class="identifier">train_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iter</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">tv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l1'</span><span class="grouping">)</span>

    <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">max_df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v1</span><span class="punctuation">.</span><span class="identifier">max_df</span>
    <span class="identifier">tfidf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">train_data</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">fixed_vocabulary_</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">tfidf</span><span class="punctuation">,</span> <span class="identifier">tfidf2</span><span class="grouping">)</span>

    <span class="comment"># test the direct tfidf vectorizer with new data</span>
    <span class="identifier">tfidf_test2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">tfidf_test</span><span class="punctuation">,</span> <span class="identifier">tfidf_test2</span><span class="grouping">)</span>

    <span class="comment"># test transform on unfitted vectorizer with empty vocabulary</span>
    <span class="identifier">v3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">v3</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">train_data</span><span class="grouping">)</span>

    <span class="comment"># ascii preprocessor?</span>
    <span class="identifier">v3</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">strip_accents</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ascii'</span><span class="punctuation">,</span> <span class="identifier">lowercase</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">processor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v3</span><span class="punctuation">.</span><span class="identifier">build_preprocessor</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"J'ai mangé du kangourou  ce midi, "</span>
            <span class="string-literal">"c'était pas très bon."</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">strip_accents_ascii</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span>
    <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">processor</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">expected</span> <span class="relational-operator">==</span> <span class="identifier">result</span>

    <span class="comment"># error on bad strip_accents param</span>
    <span class="identifier">v3</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">strip_accents</span><span class="arithmetic-assignment">=</span><span class="string-literal">'_gabbledegook_'</span><span class="punctuation">,</span> <span class="identifier">preprocessor</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">v3</span><span class="punctuation">.</span><span class="identifier">build_preprocessor</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># error with bad analyzer type</span>
    <span class="identifier">v3</span><span class="punctuation">.</span><span class="identifier">set_params</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'_invalid_analyzer_type_'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">v3</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_tfidf_vectorizer_setters</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">tv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l2'</span><span class="punctuation">,</span> <span class="identifier">use_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">smooth_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                         <span class="identifier">sublinear_tf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">norm</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'l1'</span>
    <span class="keyword">assert</span> <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">_tfidf</span><span class="punctuation">.</span><span class="identifier">norm</span> <span class="relational-operator">==</span> <span class="string-literal">'l1'</span>
    <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">use_idf</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
    <span class="keyword">assert</span> <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">_tfidf</span><span class="punctuation">.</span><span class="identifier">use_idf</span>
    <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">smooth_idf</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
    <span class="keyword">assert</span> <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">_tfidf</span><span class="punctuation">.</span><span class="identifier">smooth_idf</span>
    <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">sublinear_tf</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
    <span class="keyword">assert</span> <span class="identifier">tv</span><span class="punctuation">.</span><span class="identifier">_tfidf</span><span class="punctuation">.</span><span class="identifier">sublinear_tf</span>


<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_hashing_vectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="identifier">token_nnz</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">nnz</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">dtype</span>

    <span class="comment"># By default the hashed values receive a random sign and l2 normalization</span>
    <span class="comment"># makes the feature values bounded</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span>

    <span class="comment"># Check that the rows are normalized</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span>

    <span class="comment"># Check vectorization with some non-default parameters</span>
    <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l1'</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">dtype</span>

    <span class="comment"># ngrams generate more non zeros</span>
    <span class="identifier">ngrams_nnz</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">nnz</span>
    <span class="keyword">assert</span> <span class="identifier">ngrams_nnz</span> <span class="relational-operator">&gt;</span> <span class="identifier">token_nnz</span>
    <span class="keyword">assert</span> <span class="identifier">ngrams_nnz</span> <span class="relational-operator">&lt;</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">token_nnz</span>

    <span class="comment"># makes the feature values bounded</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span>

    <span class="comment"># Check that the rows are normalized</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_feature_names</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">max_df</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>

    <span class="comment"># test for Value error on unfitted/empty vocabulary</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fixed_vocabulary_</span>

    <span class="comment"># test for vocabulary learned from data</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_features</span>

    <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">feature_names</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_features</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'beer', 'burger', 'celeri', 'coke', 'pizza'</span><span class="punctuation">,</span>
                        <span class="string-literal">'salad', 'sparkling', 'tomato', 'water'</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="identifier">feature_names</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">feature_names</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">idx</span> <span class="relational-operator">==</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>

    <span class="comment"># test for custom vocabulary</span>
    <span class="identifier">vocab</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'beer', 'burger', 'celeri', 'coke', 'pizza'</span><span class="punctuation">,</span>
             <span class="string-literal">'salad', 'sparkling', 'tomato', 'water'</span><span class="grouping">]</span>

    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">vocab</span><span class="grouping">)</span>
    <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'beer', 'burger', 'celeri', 'coke', 'pizza', 'salad'</span><span class="punctuation">,</span>
                        <span class="string-literal">'sparkling', 'tomato', 'water'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">feature_names</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fixed_vocabulary_</span>

    <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">feature_names</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">idx</span> <span class="relational-operator">==</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Vectorizer'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">CountVectorizer</span><span class="punctuation">,</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_vectorizer_max_features</span><span class="grouping">(</span><span class="identifier">Vectorizer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">expected_vocabulary</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'burger', 'beer', 'salad', 'pizza'</span><span class="grouping">}</span>
    <span class="identifier">expected_stop_words</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'celeri', 'tomato', 'copyright', 'coke'</span><span class="punctuation">,</span>
                           <span class="string-literal">'sparkling', 'water', 'the'</span><span class="grouping">}</span>

    <span class="comment"># test bounded number of extracted features</span>
    <span class="identifier">vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Vectorizer</span><span class="grouping">(</span><span class="identifier">max_df</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.6</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>
    <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected_vocabulary</span>
    <span class="keyword">assert</span> <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">stop_words_</span> <span class="relational-operator">==</span> <span class="identifier">expected_stop_words</span>


<span class="keyword">def</span> <span class="identifier">test_count_vectorizer_max_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Regression test: max_features didn't work correctly in 0.14.</span>

    <span class="identifier">cv_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">cv_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">cv_None</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>

    <span class="identifier">counts_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv_1</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">counts_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv_3</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">counts_None</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv_None</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">features_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv_1</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">features_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv_3</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">features_None</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv_None</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># The most common feature is "the", with frequency 7.</span>
    <span class="keyword">assert</span> <span class="int-literal">7</span> <span class="relational-operator">==</span> <span class="identifier">counts_1</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="int-literal">7</span> <span class="relational-operator">==</span> <span class="identifier">counts_3</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="int-literal">7</span> <span class="relational-operator">==</span> <span class="identifier">counts_None</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># The most common feature should be the same</span>
    <span class="keyword">assert</span> <span class="string-literal">"the"</span> <span class="relational-operator">==</span> <span class="identifier">features_1</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">counts_1</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="string-literal">"the"</span> <span class="relational-operator">==</span> <span class="identifier">features_3</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">counts_3</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="string-literal">"the"</span> <span class="relational-operator">==</span> <span class="identifier">features_None</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">counts_None</span><span class="grouping">)</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_vectorizer_max_df</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">test_data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'abc', 'dea', 'eat'</span><span class="grouping">]</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="punctuation">,</span> <span class="identifier">max_df</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span>
    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="string-literal">'a'</span> <span class="relational-operator">in</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">6</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">stop_words_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>

    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">max_df</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span>  <span class="comment"># 0.5 * 3 documents -&gt; max_doc_count == 1.5</span>
    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="string-literal">'a'</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># {ae} ignored</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">4</span>    <span class="comment"># {bcdt} remain</span>
    <span class="keyword">assert</span> <span class="string-literal">'a'</span> <span class="relational-operator">in</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">stop_words_</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">stop_words_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>

    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">max_df</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="string-literal">'a'</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># {ae} ignored</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">4</span>    <span class="comment"># {bcdt} remain</span>
    <span class="keyword">assert</span> <span class="string-literal">'a'</span> <span class="relational-operator">in</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">stop_words_</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">stop_words_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>


<span class="keyword">def</span> <span class="identifier">test_vectorizer_min_df</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">test_data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'abc', 'dea', 'eat'</span><span class="grouping">]</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="punctuation">,</span> <span class="identifier">min_df</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="string-literal">'a'</span> <span class="relational-operator">in</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">6</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">stop_words_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>

    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">min_df</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="string-literal">'c'</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># {bcdt} ignored</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>    <span class="comment"># {ae} remain</span>
    <span class="keyword">assert</span> <span class="string-literal">'c'</span> <span class="relational-operator">in</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">stop_words_</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">stop_words_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">4</span>

    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">min_df</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.8</span>  <span class="comment"># 0.8 * 3 documents -&gt; min_doc_count == 2.4</span>
    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="string-literal">'c'</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># {bcdet} ignored</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>    <span class="comment"># {a} remains</span>
    <span class="keyword">assert</span> <span class="string-literal">'c'</span> <span class="relational-operator">in</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">stop_words_</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">stop_words_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>


<span class="keyword">def</span> <span class="identifier">test_count_binary_occurrences</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># by default multiple occurrences are counted as longs</span>
    <span class="identifier">test_data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'aaabc', 'abbde'</span><span class="grouping">]</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="punctuation">,</span> <span class="identifier">max_df</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'a', 'b', 'c', 'd', 'e'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># using boolean features, we can fetch the binary occurrence info</span>
    <span class="comment"># instead.</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="punctuation">,</span> <span class="identifier">max_df</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">binary</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># check the ability to change the dtype</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="punctuation">,</span> <span class="identifier">max_df</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span>
                           <span class="identifier">binary</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span>


<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_hashed_binary_occurrences</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># by default multiple occurrences are counted as longs</span>
    <span class="identifier">test_data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'aaabc', 'abbde'</span><span class="grouping">]</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="identifier">alternate_sign</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>

    <span class="comment"># using boolean features, we can fetch the binary occurrence info</span>
    <span class="comment"># instead.</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="punctuation">,</span> <span class="identifier">alternate_sign</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                             <span class="identifier">binary</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>

    <span class="comment"># check the ability to change the dtype</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="punctuation">,</span> <span class="identifier">alternate_sign</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                             <span class="identifier">binary</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Vectorizer'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">CountVectorizer</span><span class="punctuation">,</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_vectorizer_inverse_transform</span><span class="grouping">(</span><span class="identifier">Vectorizer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># raw documents</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_FOOD_DOCS</span>
    <span class="identifier">vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Vectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">transformed_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="identifier">inversed_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">transformed_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">inversed_data</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">)</span>

    <span class="identifier">analyze</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">doc</span><span class="punctuation">,</span> <span class="identifier">inversed_terms</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">inversed_data</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">terms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">analyze</span><span class="grouping">(</span><span class="identifier">doc</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">inversed_terms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">inversed_terms</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">terms</span><span class="punctuation">,</span> <span class="identifier">inversed_terms</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">transformed_data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">transformed_data</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="string-literal">"csr"</span>

    <span class="comment"># Test that inverse_transform also works with numpy arrays and</span>
    <span class="comment"># scipy</span>
    <span class="identifier">transformed_data2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformed_data</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">inversed_data2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">transformed_data2</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">terms</span><span class="punctuation">,</span> <span class="identifier">terms2</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">inversed_data</span><span class="punctuation">,</span> <span class="identifier">inversed_data2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">terms</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">terms2</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Check that inverse_transform also works on non CSR sparse data:</span>
    <span class="identifier">transformed_data3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformed_data</span><span class="punctuation">.</span><span class="identifier">tocsc</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">inversed_data3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">transformed_data3</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">terms</span><span class="punctuation">,</span> <span class="identifier">terms3</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">inversed_data</span><span class="punctuation">,</span> <span class="identifier">inversed_data3</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">terms</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">terms3</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_count_vectorizer_pipeline_grid_selection</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># raw documents</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">JUNK_FOOD_DOCS</span> <span class="arithmetic-operator">+</span> <span class="identifier">NOTJUNK_FOOD_DOCS</span>

    <span class="comment"># label junk food as -1, the others as +1</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">NOTJUNK_FOOD_DOCS</span><span class="grouping">)</span>

    <span class="comment"># split the dataset for model development and final evaluation</span>
    <span class="identifier">train_data</span><span class="punctuation">,</span> <span class="identifier">test_data</span><span class="punctuation">,</span> <span class="identifier">target_train</span><span class="punctuation">,</span> <span class="identifier">target_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="float-literal">.2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'vect'</span><span class="punctuation">,</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="string-literal">'svc'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">parameters</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'vect__ngram_range'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="string-literal">'svc__loss': ('hinge', 'squared_hinge'</span><span class="grouping">)</span>
    <span class="grouping">}</span>

    <span class="comment"># find the best parameters for both the feature extraction and the</span>
    <span class="comment"># classifier</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="identifier">parameters</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>

    <span class="comment"># Check that the best model found by grid search is 100% correct on the</span>
    <span class="comment"># held out evaluation set.</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">train_data</span><span class="punctuation">,</span> <span class="identifier">target_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">target_test</span><span class="grouping">)</span>

    <span class="comment"># on this toy dataset bigram representation which is used in the last of</span>
    <span class="comment"># the grid_search is considered the best estimator since they all converge</span>
    <span class="comment"># to 100% accuracy models</span>
    <span class="keyword">assert</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_score_</span> <span class="relational-operator">==</span> <span class="float-literal">1.0</span>
    <span class="identifier">best_vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'vect'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">best_vectorizer</span><span class="punctuation">.</span><span class="identifier">ngram_range</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_vectorizer_pipeline_grid_selection</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># raw documents</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">JUNK_FOOD_DOCS</span> <span class="arithmetic-operator">+</span> <span class="identifier">NOTJUNK_FOOD_DOCS</span>

    <span class="comment"># label junk food as -1, the others as +1</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">NOTJUNK_FOOD_DOCS</span><span class="grouping">)</span>

    <span class="comment"># split the dataset for model development and final evaluation</span>
    <span class="identifier">train_data</span><span class="punctuation">,</span> <span class="identifier">test_data</span><span class="punctuation">,</span> <span class="identifier">target_train</span><span class="punctuation">,</span> <span class="identifier">target_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'vect'</span><span class="punctuation">,</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="string-literal">'svc'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">parameters</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'vect__ngram_range'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="string-literal">'vect__norm': ('l1', 'l2'</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'svc__loss': ('hinge', 'squared_hinge'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">}</span>

    <span class="comment"># find the best parameters for both the feature extraction and the</span>
    <span class="comment"># classifier</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="identifier">parameters</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># Check that the best model found by grid search is 100% correct on the</span>
    <span class="comment"># held out evaluation set.</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">train_data</span><span class="punctuation">,</span> <span class="identifier">target_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">target_test</span><span class="grouping">)</span>

    <span class="comment"># on this toy dataset bigram representation which is used in the last of</span>
    <span class="comment"># the grid_search is considered the best estimator since they all converge</span>
    <span class="comment"># to 100% accuracy models</span>
    <span class="keyword">assert</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_score_</span> <span class="relational-operator">==</span> <span class="float-literal">1.0</span>
    <span class="identifier">best_vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'vect'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">best_vectorizer</span><span class="punctuation">.</span><span class="identifier">ngram_range</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">best_vectorizer</span><span class="punctuation">.</span><span class="identifier">norm</span> <span class="relational-operator">==</span> <span class="string-literal">'l2'</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">best_vectorizer</span><span class="punctuation">.</span><span class="identifier">fixed_vocabulary_</span>


<span class="keyword">def</span> <span class="identifier">test_vectorizer_pipeline_cross_validation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># raw documents</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">JUNK_FOOD_DOCS</span> <span class="arithmetic-operator">+</span> <span class="identifier">NOTJUNK_FOOD_DOCS</span>

    <span class="comment"># label junk food as -1, the others as +1</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">NOTJUNK_FOOD_DOCS</span><span class="grouping">)</span>

    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'vect'</span><span class="punctuation">,</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="string-literal">'svc'</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">cv_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">cv_scores</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_vectorizer_unicode</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># tests that the count vectorizer works with cyrillic.</span>
    <span class="identifier">document</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"Машинное обучение — обширный подраздел искусственного "</span>
        <span class="string-literal">"интеллекта, изучающий методы построения алгоритмов, "</span>
        <span class="string-literal">"способных обучаться."</span>
        <span class="grouping">)</span>

    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_counted</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">document</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_counted</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="grouping">)</span>

    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">alternate_sign</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">X_hashed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">document</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_hashed</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">20</span><span class="grouping">)</span>

    <span class="comment"># No collisions on such a small dataset</span>
    <span class="keyword">assert</span> <span class="identifier">X_counted</span><span class="punctuation">.</span><span class="identifier">nnz</span> <span class="relational-operator">==</span> <span class="identifier">X_hashed</span><span class="punctuation">.</span><span class="identifier">nnz</span>

    <span class="comment"># When norm is None and not alternate_sign, the tokens are counted up to</span>
    <span class="comment"># collisions</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">X_counted</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">X_hashed</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_tfidf_vectorizer_with_fixed_vocabulary</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># non regression smoke test for inheritance issues</span>
    <span class="identifier">vocabulary</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'pizza', 'celeri'</span><span class="grouping">]</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">vocabulary</span><span class="grouping">)</span>
    <span class="identifier">X_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="identifier">X_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_1</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_2</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fixed_vocabulary_</span>


<span class="keyword">def</span> <span class="identifier">test_pickling_vectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">instances</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l1'</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="identifier">binary</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">preprocessor</span><span class="arithmetic-assignment">=</span><span class="identifier">strip_tags</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="identifier">lazy_analyze</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">preprocessor</span><span class="arithmetic-assignment">=</span><span class="identifier">strip_tags</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">strip_accents</span><span class="arithmetic-assignment">=</span><span class="identifier">strip_eacute</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="identifier">lazy_analyze</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">orig</span> <span class="relational-operator">in</span> <span class="identifier">instances</span><span class="punctuation">:</span>
        <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">orig</span><span class="grouping">)</span>
        <span class="identifier">copy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">copy</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">orig</span><span class="punctuation">.</span><span class="identifier">__class__</span>
        <span class="keyword">assert</span> <span class="identifier">copy</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">orig</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">IS_PYPY</span> <span class="logical-operator">and</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">orig</span><span class="punctuation">,</span> <span class="identifier">HashingVectorizer</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">continue</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                <span class="identifier">copy</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">orig</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'factory'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="identifier">CountVectorizer</span><span class="punctuation">.</span><span class="identifier">build_analyzer</span><span class="punctuation">,</span>
    <span class="identifier">CountVectorizer</span><span class="punctuation">.</span><span class="identifier">build_preprocessor</span><span class="punctuation">,</span>
    <span class="identifier">CountVectorizer</span><span class="punctuation">.</span><span class="identifier">build_tokenizer</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pickling_built_processors</span><span class="grouping">(</span><span class="identifier">factory</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Tokenizers cannot be pickled
    https://github.com/scikit-learn/scikit-learn/issues/12833
    """</span>
    <span class="identifier">vec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">function</span> <span class="arithmetic-assignment">=</span> <span class="identifier">factory</span><span class="grouping">(</span><span class="identifier">vec</span><span class="grouping">)</span>
    <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"J'ai mangé du kangourou  ce midi, "</span>
            <span class="string-literal">"c'était pas très bon."</span><span class="grouping">)</span>
    <span class="identifier">roundtripped_function</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">function</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">function</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span>
    <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roundtripped_function</span><span class="grouping">(</span><span class="identifier">text</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">result</span> <span class="relational-operator">==</span> <span class="identifier">expected</span>


<span class="keyword">def</span> <span class="identifier">test_countvectorizer_vocab_sets_when_pickling</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># ensure that vocabulary of type set is coerced to a list to</span>
    <span class="comment"># preserve iteration ordering after deserialization</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">vocab_words</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'beer', 'burger', 'celeri', 'coke', 'pizza'</span><span class="punctuation">,</span>
                            <span class="string-literal">'salad', 'sparkling', 'tomato', 'water'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vocab_set</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">choice</span><span class="grouping">(</span><span class="identifier">vocab_words</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">replace</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">vocab_set</span><span class="grouping">)</span>
        <span class="identifier">unpickled_cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">cv</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
        <span class="identifier">unpickled_cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">unpickled_cv</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_countvectorizer_vocab_dicts_when_pickling</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">vocab_words</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'beer', 'burger', 'celeri', 'coke', 'pizza'</span><span class="punctuation">,</span>
                            <span class="string-literal">'salad', 'sparkling', 'tomato', 'water'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vocab_dict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">words</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">choice</span><span class="grouping">(</span><span class="identifier">vocab_words</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">replace</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">y</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">vocab_dict</span><span class="grouping">[</span><span class="identifier">words</span><span class="grouping">[</span><span class="identifier">y</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span>
        <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">vocab_dict</span><span class="grouping">)</span>
        <span class="identifier">unpickled_cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">cv</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
        <span class="identifier">unpickled_cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">unpickled_cv</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_stop_words_removal</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensure that deleting the stop_words_ attribute doesn't affect transform</span>

    <span class="identifier">fitted_vectorizers</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">preprocessor</span><span class="arithmetic-assignment">=</span><span class="identifier">strip_tags</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">strip_accents</span><span class="arithmetic-assignment">=</span><span class="identifier">strip_eacute</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">vect</span> <span class="relational-operator">in</span> <span class="identifier">fitted_vectorizers</span><span class="punctuation">:</span>
        <span class="identifier">vect_transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">stop_words_</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">stop_None_transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">t</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">,</span> <span class="string-literal">'stop_words_'</span><span class="grouping">)</span>
        <span class="identifier">stop_del_transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">stop_None_transform</span><span class="punctuation">,</span> <span class="identifier">vect_transform</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">stop_del_transform</span><span class="punctuation">,</span> <span class="identifier">vect_transform</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pickling_transformer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="identifier">orig</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">orig</span><span class="grouping">)</span>
    <span class="identifier">copy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">copy</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">orig</span><span class="punctuation">.</span><span class="identifier">__class__</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">copy</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">orig</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_transformer_idf_setter</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="identifier">orig</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">copy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">copy</span><span class="punctuation">.</span><span class="identifier">idf_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">orig</span><span class="punctuation">.</span><span class="identifier">idf_</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">copy</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">orig</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_tfidf_vectorizer_setter</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">orig</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">use_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">orig</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="identifier">copy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">orig</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">,</span> <span class="identifier">use_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">copy</span><span class="punctuation">.</span><span class="identifier">idf_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">orig</span><span class="punctuation">.</span><span class="identifier">idf_</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">copy</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">orig</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_tfidfvectorizer_invalid_idf_attr</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">use_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="identifier">copy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span><span class="punctuation">,</span> <span class="identifier">use_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">expected_idf_len</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">idf_</span><span class="grouping">)</span>
    <span class="identifier">invalid_idf</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">expected_idf_len</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">setattr</span><span class="grouping">(</span><span class="identifier">copy</span><span class="punctuation">,</span> <span class="string-literal">'idf_'</span><span class="punctuation">,</span> <span class="identifier">invalid_idf</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_non_unique_vocab</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">vocab</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'a', 'b', 'c', 'a', 'a'</span><span class="grouping">]</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="identifier">vocab</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_hashingvectorizer_nan_in_docs</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># np.nan can appear when using pandas to load text fields from a csv file</span>
    <span class="comment"># with missing values.</span>
    <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"np.nan is an invalid document, expected byte or unicode string."</span>
    <span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ValueError</span>

    <span class="keyword">def</span> <span class="identifier">func</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">hv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">hv</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'hello world', np.nan, 'hello hello'</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">func</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_tfidfvectorizer_binary</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non-regression test: TfidfVectorizer used to ignore its "binary" param.</span>
    <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">binary</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">use_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">binary</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'hello world', 'hello hello'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'hello world', 'hello hello'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_tfidfvectorizer_export_idf</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">use_idf</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">idf_</span><span class="punctuation">,</span> <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">_tfidf</span><span class="punctuation">.</span><span class="identifier">idf_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_vectorizer_vocab_clone</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">vect_vocab</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">vocabulary</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"the"</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">vect_vocab_clone</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">vect_vocab</span><span class="grouping">)</span>
    <span class="identifier">vect_vocab</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="identifier">vect_vocab_clone</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">ALL_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">vect_vocab_clone</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span> <span class="relational-operator">==</span> <span class="identifier">vect_vocab</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Vectorizer'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="identifier">CountVectorizer</span><span class="punctuation">,</span> <span class="identifier">TfidfVectorizer</span><span class="punctuation">,</span> <span class="identifier">HashingVectorizer</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_vectorizer_string_object_as_input</span><span class="grouping">(</span><span class="identifier">Vectorizer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Iterable over raw text documents expected, "</span>
               <span class="string-literal">"string object received."</span><span class="grouping">)</span>
    <span class="identifier">vec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Vectorizer</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="string-literal">"hello world!"</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="string-literal">"hello world!"</span><span class="grouping">)</span>
    <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"some text", "some other text"</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="string-literal">"hello world!"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"X_dtype"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_tfidf_transformer_type</span><span class="grouping">(</span><span class="identifier">X_dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20000</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_dtype</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span>


<span class="keyword">def</span> <span class="identifier">test_tfidf_transformer_sparse</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20000</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X_csc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">X_trans_csc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_csc</span><span class="grouping">)</span>
    <span class="identifier">X_trans_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfTransformer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_trans_csc</span><span class="punctuation">,</span> <span class="identifier">X_trans_csr</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans_csc</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="identifier">X_trans_csr</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"vectorizer_dtype, output_dtype, warning_expected"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_tfidf_vectorizer_type</span><span class="grouping">(</span><span class="identifier">vectorizer_dtype</span><span class="punctuation">,</span> <span class="identifier">output_dtype</span><span class="punctuation">,</span>
                               <span class="identifier">warning_expected</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"numpy", "scipy", "sklearn"</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">vectorizer_dtype</span><span class="grouping">)</span>

    <span class="identifier">warning_msg_match</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"'dtype' should be used."</span>
    <span class="identifier">warning_cls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">UserWarning</span>
    <span class="identifier">expected_warning_cls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">warning_cls</span> <span class="keyword">if</span> <span class="identifier">warning_expected</span> <span class="keyword">else</span> <span class="none-literal">None</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">expected_warning_cls</span><span class="punctuation">,</span>
                      <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warning_msg_match</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="identifier">X_idf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">expected_warning_cls</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">relevant_warnings</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">w</span> <span class="keyword">for</span> <span class="identifier">w</span> <span class="relational-operator">in</span> <span class="identifier">record</span>
                             <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">warning_cls</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">relevant_warnings</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">X_idf</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">output_dtype</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"vec"</span><span class="punctuation">,</span> <span class="grouping">[</span>
        <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_vectorizers_invalid_ngram_range</span><span class="grouping">(</span><span class="identifier">vec</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># vectorizers could be initialized with invalid ngram range</span>
    <span class="comment"># test for raising error message</span>
    <span class="identifier">invalid_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">ngram_range</span>
    <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Invalid value for ngram_range={invalid_range} "</span>
        <span class="string-literal">"lower boundary larger than the upper boundary."</span>
    <span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">vec</span><span class="punctuation">,</span> <span class="identifier">HashingVectorizer</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">IS_PYPY</span><span class="punctuation">:</span>
        <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">xfail</span><span class="grouping">(</span><span class="identifier">reason</span><span class="arithmetic-assignment">=</span><span class="string-literal">'HashingVectorizer is not supported on PyPy'</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'good news everyone'</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'good news everyone'</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">vec</span><span class="punctuation">,</span> <span class="identifier">HashingVectorizer</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'good news everyone'</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_check_stop_words_consistency</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">stop_words</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_stop_words</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">tokenize</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">build_tokenizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">preprocess</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">build_preprocessor</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">_check_stop_words_consistency</span><span class="grouping">(</span><span class="identifier">stop_words</span><span class="punctuation">,</span> <span class="identifier">preprocess</span><span class="punctuation">,</span>
                                                   <span class="identifier">tokenize</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_vectorizer_stop_words_inconsistent</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">lstr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"\['and', 'll', 've'\]"</span>
    <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'Your stop_words may be inconsistent with your '</span>
               <span class="string-literal">'preprocessing. Tokenizing the stop words generated '</span>
               <span class="string-literal">'tokens %s not in stop_words.'</span> <span class="arithmetic-operator">%</span> <span class="identifier">lstr</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">vec</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"you've", "you", "you'll"</span><span class="punctuation">,</span> <span class="string-literal">'AND'</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'hello world'</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="comment"># reset stop word validation</span>
        <span class="keyword">del</span> <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">_stop_words_id</span>
        <span class="keyword">assert</span> <span class="identifier">_check_stop_words_consistency</span><span class="grouping">(</span><span class="identifier">vec</span><span class="grouping">)</span> <span class="relational-operator">is</span> <span class="bool-literal">False</span>

    <span class="comment"># Only one warning per stop list</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'hello world'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">record</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_check_stop_words_consistency</span><span class="grouping">(</span><span class="identifier">vec</span><span class="grouping">)</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>

    <span class="comment"># Test caching of inconsistency assessment</span>
    <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"you've", "you", "you'll"</span><span class="punctuation">,</span> <span class="string-literal">'blah', 'AND'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'hello world'</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">skip_if_32bit</span>
<span class="keyword">def</span> <span class="identifier">test_countvectorizer_sort_features_64bit_sparse_indices</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Check that CountVectorizer._sort_features preserves the dtype of its sparse
    feature matrix.

    This test is skipped on 32bit platforms, see:
        https://github.com/scikit-learn/scikit-learn/pull/11295
    for more details.
    """</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span><span class="grouping">)</span>

    <span class="comment"># force indices and indptr to int64.</span>
    <span class="identifier">INDICES_DTYPE</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span>
    <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">INDICES_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">INDICES_DTYPE</span><span class="grouping">)</span>

    <span class="identifier">vocabulary</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
            <span class="string-literal">"scikit-learn"</span><span class="punctuation">:</span> <span class="int-literal">0</span><span class="punctuation">,</span>
            <span class="string-literal">"is"</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">,</span>
            <span class="string-literal">"great!"</span><span class="punctuation">:</span> <span class="int-literal">2</span>
            <span class="grouping">}</span>

    <span class="identifier">Xs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">_sort_features</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">vocabulary</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">INDICES_DTYPE</span> <span class="relational-operator">==</span> <span class="identifier">Xs</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">.</span><span class="identifier">dtype</span>


<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Estimator'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="identifier">CountVectorizer</span><span class="punctuation">,</span> <span class="identifier">TfidfVectorizer</span><span class="punctuation">,</span> <span class="identifier">HashingVectorizer</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stop_word_validation_custom_preprocessor</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'text': 'some text'</span><span class="grouping">}</span><span class="grouping">]</span>

    <span class="identifier">vec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_check_stop_words_consistency</span><span class="grouping">(</span><span class="identifier">vec</span><span class="grouping">)</span> <span class="relational-operator">is</span> <span class="bool-literal">True</span>

    <span class="identifier">vec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">preprocessor</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">x</span><span class="grouping">[</span><span class="string-literal">'text'</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'and'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_check_stop_words_consistency</span><span class="grouping">(</span><span class="identifier">vec</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">'error'</span>
    <span class="comment"># checks are cached</span>
    <span class="keyword">assert</span> <span class="identifier">_check_stop_words_consistency</span><span class="grouping">(</span><span class="identifier">vec</span><span class="grouping">)</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>
    <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="keyword">class</span> <span class="identifier">CustomEstimator</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">build_preprocessor</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">x</span><span class="grouping">[</span><span class="string-literal">'text'</span><span class="grouping">]</span>

    <span class="identifier">vec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CustomEstimator</span><span class="grouping">(</span><span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'and'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_check_stop_words_consistency</span><span class="grouping">(</span><span class="identifier">vec</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">'error'</span>

    <span class="identifier">vec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">tokenizer</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">doc</span><span class="punctuation">:</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">compile</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">'\w{1,}'</span><span class="grouping">)</span>
                                            <span class="punctuation">.</span><span class="identifier">findall</span><span class="grouping">(</span><span class="identifier">doc</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'and'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_check_stop_words_consistency</span><span class="grouping">(</span><span class="identifier">vec</span><span class="grouping">)</span> <span class="relational-operator">is</span> <span class="bool-literal">True</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'Estimator'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">CountVectorizer</span><span class="punctuation">,</span>
     <span class="identifier">TfidfVectorizer</span><span class="punctuation">,</span>
     <span class="identifier">HashingVectorizer</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'input_type, err_type, err_msg'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'filename', FileNotFoundError, ''</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">'file', AttributeError, "'str' object has no attribute 'read'</span><span class="invalid">"</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_callable_analyzer_error</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="identifier">input_type</span><span class="punctuation">,</span> <span class="identifier">err_type</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">issubclass</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="identifier">HashingVectorizer</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">xfail</span><span class="grouping">(</span><span class="string-literal">'HashingVectorizer is not supported on PyPy'</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'this is text, not file or filename'</span><span class="grouping">]</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">err_type</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="identifier">input</span><span class="arithmetic-assignment">=</span><span class="identifier">input_type</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'Estimator'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">CountVectorizer</span><span class="punctuation">,</span>
     <span class="identifier">TfidfVectorizer</span><span class="punctuation">,</span>
     <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">param</span><span class="grouping">(</span><span class="identifier">HashingVectorizer</span><span class="punctuation">,</span> <span class="identifier">marks</span><span class="arithmetic-assignment">=</span><span class="identifier">fails_if_pypy</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'analyzer', [lambda doc: open(doc, 'r'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="identifier">doc</span><span class="punctuation">:</span> <span class="identifier">doc</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'input_type', ['file', 'filename'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_callable_analyzer_change_behavior</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="identifier">analyzer</span><span class="punctuation">,</span> <span class="identifier">input_type</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'this is text, not file or filename'</span><span class="grouping">]</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">FileNotFoundError</span><span class="punctuation">,</span> <span class="identifier">AttributeError</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="identifier">analyzer</span><span class="punctuation">,</span> <span class="identifier">input</span><span class="arithmetic-assignment">=</span><span class="identifier">input_type</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'Estimator'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">CountVectorizer</span><span class="punctuation">,</span>
     <span class="identifier">TfidfVectorizer</span><span class="punctuation">,</span>
     <span class="identifier">HashingVectorizer</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_callable_analyzer_reraise_error</span><span class="grouping">(</span><span class="identifier">tmpdir</span><span class="punctuation">,</span> <span class="identifier">Estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check if a custom exception from the analyzer is shown to the user</span>
    <span class="keyword">def</span> <span class="identifier">analyzer</span><span class="grouping">(</span><span class="identifier">doc</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="invalid">E</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="grouping">(</span><span class="string-literal">"testing"</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">issubclass</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="identifier">HashingVectorizer</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">xfail</span><span class="grouping">(</span><span class="string-literal">'HashingVectorizer is not supported on PyPy'</span><span class="grouping">)</span>

    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tmpdir</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="string-literal">"file.txt"</span><span class="grouping">)</span>
    <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">write</span><span class="grouping">(</span><span class="string-literal">"sample content\n"</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">E</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"testing"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="identifier">analyzer</span><span class="punctuation">,</span> <span class="identifier">input</span><span class="arithmetic-assignment">=</span><span class="string-literal">'file'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">f</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'Vectorizer'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">CountVectorizer</span><span class="punctuation">,</span> <span class="identifier">HashingVectorizer</span><span class="punctuation">,</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'stop_words, tokenizer, preprocessor, ngram_range, token_pattern,'</span>
    <span class="string-literal">'analyzer, unused_name, ovrd_name, ovrd_msg'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"you've", "you'll"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'char'</span><span class="punctuation">,</span>
     <span class="string-literal">"'stop_words'", "'analyzer'", "!= 'word'"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="identifier">s</span><span class="punctuation">:</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'char'</span><span class="punctuation">,</span>
     <span class="string-literal">"'tokenizer'", "'analyzer'", "!= 'word'"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="identifier">s</span><span class="punctuation">:</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="string-literal">'\w+', 'word'</span><span class="punctuation">,</span>
      <span class="string-literal">"'token_pattern'", "'tokenizer'", "is not None"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="identifier">s</span><span class="punctuation">:</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">upper</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="string-literal">'\w+'</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="identifier">s</span><span class="punctuation">:</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">upper</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="string-literal">"'preprocessor'", "'analyzer'", "is callable"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="identifier">s</span><span class="punctuation">:</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">upper</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="string-literal">"'ngram_range'", "'analyzer'", "is callable"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="string-literal">'\w+', 'char'</span><span class="punctuation">,</span>
      <span class="string-literal">"'token_pattern'", "'analyzer'", "!= 'word'"</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_unused_parameters_warn</span><span class="grouping">(</span><span class="identifier">Vectorizer</span><span class="punctuation">,</span> <span class="identifier">stop_words</span><span class="punctuation">,</span>
                                <span class="identifier">tokenizer</span><span class="punctuation">,</span> <span class="identifier">preprocessor</span><span class="punctuation">,</span>
                                <span class="identifier">ngram_range</span><span class="punctuation">,</span> <span class="identifier">token_pattern</span><span class="punctuation">,</span>
                                <span class="identifier">analyzer</span><span class="punctuation">,</span> <span class="identifier">unused_name</span><span class="punctuation">,</span> <span class="identifier">ovrd_name</span><span class="punctuation">,</span>
                                <span class="identifier">ovrd_msg</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">train_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">JUNK_FOOD_DOCS</span>
    <span class="comment"># setting parameter and checking for corresponding warning messages</span>
    <span class="identifier">vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Vectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="identifier">stop_words</span><span class="punctuation">,</span> <span class="identifier">tokenizer</span><span class="arithmetic-assignment">=</span><span class="identifier">tokenizer</span><span class="punctuation">,</span>
                    <span class="identifier">preprocessor</span><span class="arithmetic-assignment">=</span><span class="identifier">preprocessor</span><span class="punctuation">,</span> <span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="identifier">ngram_range</span><span class="punctuation">,</span>
                    <span class="identifier">token_pattern</span><span class="arithmetic-assignment">=</span><span class="identifier">token_pattern</span><span class="punctuation">,</span> <span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="identifier">analyzer</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"The parameter %s will not be used"</span>
           <span class="string-literal">" since %s %s"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">unused_name</span><span class="punctuation">,</span> <span class="identifier">ovrd_name</span><span class="punctuation">,</span> <span class="identifier">ovrd_msg</span><span class="grouping">)</span>
           <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">vect</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">train_data</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Vectorizer, X'</span><span class="punctuation">,</span> <span class="grouping">(</span>
    <span class="grouping">(</span><span class="identifier">HashingVectorizer</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'foo': 1, 'bar': 2}, {'foo': 3, 'baz'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">CountVectorizer</span><span class="punctuation">,</span> <span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_n_features_in</span><span class="grouping">(</span><span class="identifier">Vectorizer</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># For vectorizers, n_features_in_ does not make sense</span>
    <span class="identifier">vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Vectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">vectorizer</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span>
    <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">vectorizer</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_tie_breaking_sample_order_invariance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks the sample order invariance when setting max_features</span>
    <span class="comment"># non-regression test for #17939</span>
    <span class="identifier">vec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">vocab1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'hello', 'world'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span>
    <span class="identifier">vocab2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vec</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'world', 'hello'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span>
    <span class="keyword">assert</span> <span class="identifier">vocab1</span> <span class="relational-operator">==</span> <span class="identifier">vocab2</span>


<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="keyword">def</span> <span class="identifier">test_nonnegative_hashing_vectorizer_result_indices</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># add test for pr 19035</span>
    <span class="identifier">hashing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HashingVectorizer</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000000</span><span class="punctuation">,</span> <span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hashing</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'22pcs efuture'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">indices</span>
    <span class="keyword">assert</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span>

    </pre>
  </body>
</html>