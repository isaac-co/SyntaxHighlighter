<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" The Manual Tool is a tkinter driven GUI app for editing alignments files with visual tools.
This module is the main entry point into the Manual Tool. """</span>
<span class="keyword">import</span> <span class="identifier">logging</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">tkinter</span> <span class="keyword">as</span> <span class="identifier">tk</span>
<span class="keyword">from</span> <span class="identifier">tkinter</span> <span class="keyword">import</span> <span class="identifier">ttk</span>
<span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">sleep</span>

<span class="keyword">import</span> <span class="identifier">cv2</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">gui</span><span class="punctuation">.</span><span class="identifier">control_helper</span> <span class="keyword">import</span> <span class="identifier">ControlPanel</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">gui</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_images</span><span class="punctuation">,</span> <span class="identifier">get_config</span><span class="punctuation">,</span> <span class="identifier">initialize_config</span><span class="punctuation">,</span> <span class="identifier">initialize_images</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">image</span> <span class="keyword">import</span> <span class="identifier">SingleFrameLoader</span><span class="punctuation">,</span> <span class="identifier">read_image_meta</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">multithreading</span> <span class="keyword">import</span> <span class="identifier">MultiThread</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">_video_extensions</span>
<span class="keyword">from</span> <span class="identifier">plugins</span><span class="punctuation">.</span><span class="identifier">extract</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">Extractor</span><span class="punctuation">,</span> <span class="identifier">ExtractMedia</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">detected_faces</span> <span class="keyword">import</span> <span class="identifier">DetectedFaces</span><span class="punctuation">,</span> <span class="identifier">ThumbsCreator</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">faceviewer</span><span class="punctuation">.</span><span class="identifier">frame</span> <span class="keyword">import</span> <span class="identifier">FacesFrame</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">frameviewer</span><span class="punctuation">.</span><span class="identifier">frame</span> <span class="keyword">import</span> <span class="identifier">DisplayFrame</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>


<span class="keyword">class</span> <span class="identifier">Manual</span><span class="grouping">(</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">Tk</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" The main entry point for Faceswap's Manual Editor Tool. This tool is part of the Faceswap
    Tools suite and should be called from ``python tools.py manual`` command.

    Allows for visual interaction with frames, faces and alignments file to perform various
    adjustments to the alignments file.

    Parameters
    ----------
    arguments: :class:`argparse.Namespace`
        The :mod:`argparse` arguments as passed in from :mod:`tools.py`
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (arguments: '%s')"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_non_faces</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">frames</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_initialize_tkinter</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TkGlobals</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">frames</span><span class="grouping">)</span>

        <span class="identifier">extractor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Aligner</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DetectedFaces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">,</span>
                                             <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">alignments_path</span><span class="punctuation">,</span>
                                             <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">frames</span><span class="punctuation">,</span>
                                             <span class="identifier">extractor</span><span class="grouping">)</span>

        <span class="identifier">video_meta_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">video_meta_data</span>
        <span class="identifier">valid_meta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">val</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="keyword">for</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">video_meta_data</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">loader</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FrameLoader</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">frames</span><span class="punctuation">,</span> <span class="identifier">video_meta_data</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">valid_meta</span><span class="punctuation">:</span>  <span class="comment"># Load the faces whilst other threads complete if we have valid meta data</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">load_faces</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_containers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_create_containers</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_wait_for_threads</span><span class="grouping">(</span><span class="identifier">extractor</span><span class="punctuation">,</span> <span class="identifier">loader</span><span class="punctuation">,</span> <span class="identifier">valid_meta</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">valid_meta</span><span class="punctuation">:</span>
            <span class="comment"># Load the faces after other threads complete if meta data required updating</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">load_faces</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_generate_thumbs</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">frames</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">thumb_regen</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">single_process</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DisplayFrame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_containers</span><span class="grouping">[</span><span class="string-literal">"top"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">,</span>
                                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="grouping">)</span>
        <span class="identifier">_Options</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_containers</span><span class="grouping">[</span><span class="string-literal">"top"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FacesFrame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_containers</span><span class="grouping">[</span><span class="string-literal">"bottom"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                       <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">,</span>
                                       <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">,</span>
                                       <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">tk_selected_action</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="string-literal">"View"</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;Key&gt;"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_handle_key_press</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_initial_layout</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_validate_non_faces</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">frames_folder</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Quick check on the input to make sure that a folder of extracted faces is not being
        passed in. """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">isdir</span><span class="grouping">(</span><span class="identifier">frames_folder</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Input '%s' is not a folder"</span><span class="punctuation">,</span> <span class="identifier">frames_folder</span><span class="grouping">)</span>
            <span class="keyword">return</span>
        <span class="identifier">test_file</span> <span class="arithmetic-assignment">=</span> <span class="identifier">next</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">fname</span>
                          <span class="keyword">for</span> <span class="identifier">fname</span> <span class="relational-operator">in</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">listdir</span><span class="grouping">(</span><span class="identifier">frames_folder</span><span class="grouping">)</span>
                          <span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">splitext</span><span class="grouping">(</span><span class="identifier">fname</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">".png"</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="none-literal">None</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">test_file</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Input '%s' does not contain any .pngs"</span><span class="punctuation">,</span> <span class="identifier">frames_folder</span><span class="grouping">)</span>
            <span class="keyword">return</span>
        <span class="identifier">test_file</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">frames_folder</span><span class="punctuation">,</span> <span class="identifier">test_file</span><span class="grouping">)</span>
        <span class="identifier">meta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">read_image_meta</span><span class="grouping">(</span><span class="identifier">test_file</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Test file: (filename: %s, metadata: %s)"</span><span class="punctuation">,</span> <span class="identifier">test_file</span><span class="punctuation">,</span> <span class="identifier">meta</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="string-literal">"itxt" in meta and "alignments" in meta["itxt"</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"The input folder '%s' contains extracted faces."</span><span class="punctuation">,</span> <span class="identifier">frames_folder</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"The Manual Tool works with source frames or a video file, not extracted "</span>
                         <span class="string-literal">"faces. Please update your input."</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Test input file '%s' does not contain Faceswap header data"</span><span class="punctuation">,</span> <span class="identifier">test_file</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_wait_for_threads</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">extractor</span><span class="punctuation">,</span> <span class="identifier">loader</span><span class="punctuation">,</span> <span class="identifier">valid_meta</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" The :class:`Aligner` and :class:`FramesLoader` are launched in background threads.
        Wait for them to be initialized prior to proceeding.

        Parameters
        ----------
        extractor: :class:`Aligner`
            The extraction pipeline for the Manual Tool
        loader: :class:`FramesLoader`
            The frames loader for the Manual Tool
        valid_meta: bool
            Whether the input video had valid meta-data on import, or if it had to be created.
            ``True`` if valid meta data existed previously, ``False`` if it needed to be created

        Notes
        -----
        Because some of the initialize checks perform extra work once their threads are complete,
        they should only return ``True`` once, and should not be queried again.
        """</span>
        <span class="identifier">extractor_init</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="identifier">frames_init</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="keyword">while</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
            <span class="identifier">extractor_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extractor_init</span> <span class="keyword">if</span> <span class="identifier">extractor_init</span> <span class="keyword">else</span> <span class="identifier">extractor</span><span class="punctuation">.</span><span class="identifier">is_initialized</span>
            <span class="identifier">frames_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">frames_init</span> <span class="keyword">if</span> <span class="identifier">frames_init</span> <span class="keyword">else</span> <span class="identifier">loader</span><span class="punctuation">.</span><span class="identifier">is_initialized</span>
            <span class="keyword">if</span> <span class="identifier">extractor_init</span> <span class="logical-operator">and</span> <span class="identifier">frames_init</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Threads inialized"</span><span class="grouping">)</span>
                <span class="keyword">break</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Threads not initialized. Waiting..."</span><span class="grouping">)</span>
            <span class="identifier">sleep</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">extractor</span><span class="punctuation">.</span><span class="identifier">link_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">valid_meta</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Saving video meta data to alignments file"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">save_video_meta_data</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">loader</span><span class="punctuation">.</span><span class="identifier">video_meta_data</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_generate_thumbs</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_location</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="punctuation">,</span> <span class="identifier">single_process</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check whether thumbnails are stored in the alignments file and if not generate them.

        Parameters
        ----------
        input_location: str
            The input video or folder of images
        force: bool
            ``True`` if the thumbnails should be regenerated even if they exist, otherwise
            ``False``
        single_process: bool
            ``True`` will extract thumbs from a video in a single process, ``False`` will run
            parallel threads
        """</span>
        <span class="identifier">thumbs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ThumbsCreator</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">,</span> <span class="identifier">input_location</span><span class="punctuation">,</span> <span class="identifier">single_process</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">thumbs</span><span class="punctuation">.</span><span class="identifier">has_thumbs</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Generating thumbnails cache"</span><span class="grouping">)</span>
        <span class="identifier">thumbs</span><span class="punctuation">.</span><span class="identifier">generate_cache</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Generated thumbnails cache"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_initialize_tkinter</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Initialize a standalone tkinter instance. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing tkinter"</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">widget</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"TButton", "TCheckbutton", "TRadiobutton"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">unbind_class</span><span class="grouping">(</span><span class="identifier">widget</span><span class="punctuation">,</span> <span class="string-literal">"&lt;Key-space&gt;"</span><span class="grouping">)</span>
        <span class="identifier">initialize_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
        <span class="identifier">initialize_images</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">set_geometry</span><span class="grouping">(</span><span class="int-literal">940</span><span class="punctuation">,</span> <span class="int-literal">600</span><span class="punctuation">,</span> <span class="identifier">fullscreen</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Faceswap.py - Visual Alignments"</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized tkinter"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_create_containers</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Create the paned window containers for various GUI elements

        Returns
        -------
        dict:
            The main containers of the manual tool.
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Creating containers"</span><span class="grouping">)</span>
        <span class="identifier">main</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">PanedWindow</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span>
                               <span class="identifier">orient</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">VERTICAL</span><span class="punctuation">,</span>
                               <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"pw_main"</span><span class="grouping">)</span>
        <span class="identifier">main</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

        <span class="identifier">top</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">main</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"frame_top"</span><span class="grouping">)</span>
        <span class="identifier">main</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">top</span><span class="grouping">)</span>

        <span class="identifier">bottom</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">main</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"frame_bottom"</span><span class="grouping">)</span>
        <span class="identifier">main</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">bottom</span><span class="grouping">)</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">main</span><span class="arithmetic-assignment">=</span><span class="identifier">main</span><span class="punctuation">,</span> <span class="identifier">top</span><span class="arithmetic-assignment">=</span><span class="identifier">top</span><span class="punctuation">,</span> <span class="identifier">bottom</span><span class="arithmetic-assignment">=</span><span class="identifier">bottom</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Created containers: %s"</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">_handle_key_press</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Keyboard shortcuts

        Parameters
        ----------
        event: :class:`tkinter.Event()`
            The tkinter key press event

        Notes
        -----
        The following keys are reserved for the :mod:`tools.lib_manual.editor` classes
            * Delete - Used for deleting faces
            * [] - decrease / increase brush size
            * B, D, E, M - Optional Actions (Brush, Drag, Erase, Zoom)
        """</span>
        <span class="comment"># Alt modifier appears to be broken in Windows so don't use it.</span>
        <span class="identifier">modifiers</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="int-literal">0</span><span class="invalid">x</span><span class="int-literal">0001</span><span class="punctuation">:</span> <span class="string-literal">'shift'</span><span class="punctuation">,</span>
                     <span class="int-literal">0</span><span class="invalid">x</span><span class="int-literal">0004</span><span class="punctuation">:</span> <span class="string-literal">'ctrl'</span><span class="grouping">}</span>

        <span class="identifier">tk_pos</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_frame_index</span>
        <span class="identifier">bindings</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
            <span class="string-literal">"z"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">navigation</span><span class="punctuation">.</span><span class="identifier">decrement_frame</span><span class="punctuation">,</span>
            <span class="string-literal">"x"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">navigation</span><span class="punctuation">.</span><span class="identifier">increment_frame</span><span class="punctuation">,</span>
            <span class="string-literal">"space"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">navigation</span><span class="punctuation">.</span><span class="identifier">handle_play_button</span><span class="punctuation">,</span>
            <span class="string-literal">"home"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">navigation</span><span class="punctuation">.</span><span class="identifier">goto_first_frame</span><span class="punctuation">,</span>
            <span class="string-literal">"end"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">navigation</span><span class="punctuation">.</span><span class="identifier">goto_last_frame</span><span class="punctuation">,</span>
            <span class="string-literal">"down": lambda d="down"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span><span class="punctuation">.</span><span class="identifier">canvas_scroll</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"up": lambda d="up"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span><span class="punctuation">.</span><span class="identifier">canvas_scroll</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"next": lambda d="page-down"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span><span class="punctuation">.</span><span class="identifier">canvas_scroll</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"prior": lambda d="page-up"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span><span class="punctuation">.</span><span class="identifier">canvas_scroll</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"f"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">cycle_filter_mode</span><span class="punctuation">,</span>
            <span class="string-literal">"f1"</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">keysym</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">set_action</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"f2"</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">keysym</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">set_action</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"f3"</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">keysym</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">set_action</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"f4"</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">keysym</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">set_action</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"f5"</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">keysym</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">set_action</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"f9"</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">keysym</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span><span class="punctuation">.</span><span class="identifier">set_annotation_display</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"f10"</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">keysym</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span><span class="punctuation">.</span><span class="identifier">set_annotation_display</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"c": lambda f=tk_pos.get(), d="prev"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"v": lambda f=tk_pos.get(), d="next"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"ctrl_s"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">save</span><span class="punctuation">,</span>
            <span class="string-literal">"r"</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="identifier">f</span><span class="arithmetic-assignment">=</span><span class="identifier">tk_pos</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">revert_to_saved</span><span class="grouping">(</span><span class="identifier">f</span><span class="grouping">)</span><span class="grouping">}</span>

        <span class="comment"># Allow keypad keys to be used for numbers</span>
        <span class="identifier">press</span> <span class="arithmetic-assignment">=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">keysym</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">"KP_", "") if event.keysym.startswith("KP_"</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">keysym</span>
        <span class="identifier">modifier</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"_"</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">val</span> <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">modifiers</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">state</span> <span class="bitwise-operator">&</span> <span class="identifier">key</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">key_press</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"_"</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">modifier</span><span class="punctuation">,</span> <span class="identifier">press</span><span class="grouping">]</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">modifier</span> <span class="keyword">else</span> <span class="identifier">press</span>
        <span class="keyword">if</span> <span class="identifier">key_press</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">bindings</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"key press: %s, action: %s"</span><span class="punctuation">,</span> <span class="identifier">key_press</span><span class="punctuation">,</span> <span class="identifier">bindings</span><span class="grouping">[</span><span class="identifier">key_press</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">focus_set</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">bindings</span><span class="grouping">[</span><span class="identifier">key_press</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_set_initial_layout</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the favicon and the bottom frame position to correct location to display full
        frame window.

        Notes
        -----
        The favicon pops the tkinter GUI (without loaded elements) as soon as it is called, so
        this is set last.
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting initial layout"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">call</span><span class="grouping">(</span><span class="string-literal">"wm"</span><span class="punctuation">,</span>
                     <span class="string-literal">"iconphoto"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_w</span><span class="punctuation">,</span> <span class="identifier">get_images</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">icons</span><span class="grouping">[</span><span class="string-literal">"favicon"</span><span class="grouping">]</span><span class="grouping">)</span>  <span class="comment"># pylint:disable=protected-access</span>
        <span class="identifier">location</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">winfo_screenheight</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="float-literal">1.5</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_containers</span><span class="grouping">[</span><span class="string-literal">"main"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sashpos</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">location</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">update_idletasks</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">process</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" The entry point for the Visual Alignments tool from :mod:`lib.tools.manual.cli`.

        Launch the tkinter Visual Alignments Window and run main loop.
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Launching mainloop"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mainloop</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">_Options</span><span class="grouping">(</span><span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-many-ancestors</span>
    <span class="comment">""" Control panel options for currently displayed Editor. This is the right hand panel of the
    GUI that holds editor specific settings and annotation display settings.

    parent: :class:`tkinter.ttk.Frame`
        The parent frame for the control panel options
    tk_globals: :class:`~tools.manual.manual.TkGlobals`
        The tkinter variables that apply to the whole of the GUI
    display_frame: :class:`DisplayFrame`
        The frame that holds the editors
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">tk_globals</span><span class="punctuation">,</span> <span class="identifier">display_frame</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (parent: %s, tk_globals: %s, display_frame: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">tk_globals</span><span class="punctuation">,</span> <span class="identifier">display_frame</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">parent</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk_globals</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">display_frame</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_panels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_initialize</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_tk_callbacks</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_options</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">RIGHT</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">Y</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_initialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Initialize all of the control panels, then display the default panel.

        Adds the control panel to :attr:`_control_panels` and sets the traceback to update
        display when a panel option has been changed.

        Notes
        -----
        All panels must be initialized at the beginning so that the global format options are not
        reset to default when the editor is first selected.

        The Traceback must be set after the panel has first been packed as otherwise it interferes
        with the loading of the faces pane.
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_initialize_face_options</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">TOP</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">panels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">editor</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">editors</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing control panel for '%s' editor"</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="grouping">)</span>
            <span class="identifier">controls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">editor</span><span class="punctuation">.</span><span class="identifier">controls</span>
            <span class="identifier">panel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ControlPanel</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">controls</span><span class="grouping">[</span><span class="string-literal">"controls"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                 <span class="identifier">option_columns</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                 <span class="identifier">columns</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                 <span class="identifier">max_columns</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                 <span class="identifier">header_text</span><span class="arithmetic-assignment">=</span><span class="identifier">controls</span><span class="grouping">[</span><span class="string-literal">"header"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                 <span class="identifier">blank_nones</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                 <span class="identifier">label_width</span><span class="arithmetic-assignment">=</span><span class="int-literal">18</span><span class="punctuation">,</span>
                                 <span class="identifier">style</span><span class="arithmetic-assignment">=</span><span class="string-literal">"CPanel"</span><span class="punctuation">,</span>
                                 <span class="identifier">scrollbar</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">panel</span><span class="punctuation">.</span><span class="identifier">pack_forget</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">panels</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">panel</span>
        <span class="keyword">return</span> <span class="identifier">panels</span>

    <span class="keyword">def</span> <span class="identifier">_initialize_face_options</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the Face Viewer options panel, beneath the standard control options. """</span>
        <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTTOM</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">padx</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">pady</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
        <span class="identifier">size_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">frame</span><span class="grouping">)</span>
        <span class="identifier">size_frame</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">RIGHT</span><span class="grouping">)</span>
        <span class="identifier">lbl</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Label</span><span class="grouping">(</span><span class="identifier">size_frame</span><span class="punctuation">,</span> <span class="identifier">text</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Face Size:"</span><span class="grouping">)</span>
        <span class="identifier">lbl</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">LEFT</span><span class="grouping">)</span>
        <span class="identifier">cmb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Combobox</span><span class="grouping">(</span><span class="identifier">size_frame</span><span class="punctuation">,</span>
                           <span class="identifier">value</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"Tiny", "Small", "Medium", "Large", "Extra Large"</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"readonly"</span><span class="punctuation">,</span>
                           <span class="identifier">textvariable</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_faces_size</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_faces_size</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="string-literal">"Medium"</span><span class="grouping">)</span>
        <span class="identifier">cmb</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">RIGHT</span><span class="punctuation">,</span> <span class="identifier">padx</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_set_tk_callbacks</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Sets the callback to change to the relevant control panel options when the selected
        editor is changed, and the display update on panel option change."""</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">tk_selected_action</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_options</span><span class="grouping">)</span>
        <span class="identifier">seen_controls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">editor</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">editors</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">ctl</span> <span class="relational-operator">in</span> <span class="identifier">editor</span><span class="punctuation">.</span><span class="identifier">controls</span><span class="grouping">[</span><span class="string-literal">"controls"</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">ctl</span> <span class="relational-operator">in</span> <span class="identifier">seen_controls</span><span class="punctuation">:</span>
                    <span class="comment"># Some controls are re-used (annotation format), so skip if trace has already</span>
                    <span class="comment"># been set</span>
                    <span class="keyword">continue</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Adding control update callback: (editor: %s, control: %s)"</span><span class="punctuation">,</span>
                             <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">ctl</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">)</span>
                <span class="identifier">seen_controls</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">ctl</span><span class="grouping">)</span>
                <span class="identifier">ctl</span><span class="punctuation">.</span><span class="identifier">tk_var</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_update</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_options</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
        <span class="comment">""" Update the control panel display for the current editor.

        If the options have not already been set, then adds the control panel to
        :attr:`_control_panels`. Displays the current editor's control panel

        Parameters
        ----------
        args: tuple
            Unused but required for tkinter variable callback
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_clear_options_frame</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">editor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">tk_selected_action</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Displaying control panel for editor: '%s'"</span><span class="punctuation">,</span> <span class="identifier">editor</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_panels</span><span class="grouping">[</span><span class="identifier">editor</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_clear_options_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Hides the currently displayed control panel """</span>
        <span class="keyword">for</span> <span class="identifier">editor</span><span class="punctuation">,</span> <span class="identifier">panel</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_panels</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">panel</span><span class="punctuation">.</span><span class="identifier">winfo_ismapped</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Hiding control panel for: %s"</span><span class="punctuation">,</span> <span class="identifier">editor</span><span class="grouping">)</span>
                <span class="identifier">panel</span><span class="punctuation">.</span><span class="identifier">pack_forget</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">TkGlobals</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Holds Tkinter Variables and other frame information that need to be accessible from all
    areas of the GUI.

    Parameters
    ----------
    input_location: str
        The location of the input folder of frames or video file
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_location</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (input_location: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">input_location</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_tk_vars</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_video</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_input</span><span class="grouping">(</span><span class="identifier">input_location</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_count</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>  <span class="comment"># set by FrameLoader</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_display_dims</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="int-literal">896</span> <span class="arithmetic-operator">*</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">scaling_factor</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                    <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="int-literal">504</span> <span class="arithmetic-operator">*</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">scaling_factor</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                   <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                   <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                   <span class="identifier">display_dims</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                   <span class="identifier">filename</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_get_tk_vars</span><span class="grouping">(</span><span class="identifier">cls</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Create and initialize the tkinter variables.

        Returns
        -------
        dict
            The variable name as key, the variable as value
        """</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"frame_index", "transport_index", "face_index"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">var</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">IntVar</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">var</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">retval</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">var</span>
        <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"update", "update_active_viewport", "is_zoomed"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">var</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BooleanVar</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">var</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">retval</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">var</span>
        <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"filter_mode", "faces_size"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">retval</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">StringVar</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">current_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: The currently displayed frame in the frame viewer with it's meta information. Key
        and Values are as follows:

            **image** (:class:`numpy.ndarry`): The currently displayed frame in original dimensions

            **scale** (`float`): The scaling factor to use to resize the image to the display
            window

            **interpolation** (`int`): The opencv interpolator ID to use for resizing the image to
            the display window

            **display_dims** (`tuple`): The size of the currently displayed frame, sized for the
            display window

            **filename** (`str`): The filename of the currently displayed frame
        """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">frame_count</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The total number of frames for the input location """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_count</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">tk_face_index</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`tkinter.IntVar`: The variable that holds the face index of the selected face
        within the current frame when in zoomed mode. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"face_index"</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">tk_update_active_viewport</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`tkinter.BooleanVar`: Boolean Variable that is traced by the viewport's active
        frame to update.. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"update_active_viewport"</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">face_index</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The currently displayed face index when in zoomed mode. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"face_index"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">frame_display_dims</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" tuple: The (`width`, `height`) of the video display frame in pixels. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_display_dims</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">frame_index</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The currently displayed frame index. NB This returns -1 if there are no frames
        that meet the currently selected filter criteria. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"frame_index"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">tk_frame_index</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`tkinter.IntVar`: The variable holding the current frame index. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"frame_index"</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">filter_mode</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" str: The currently selected navigation mode. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"filter_mode"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">tk_filter_mode</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`tkinter.StringVar`: The variable holding the currently selected navigation
        filter mode. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"filter_mode"</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">tk_faces_size</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`tkinter.StringVar`: The variable holding the currently selected Faces Viewer
        thumbnail size. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"faces_size"</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">is_video</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" bool: ``True`` if the input is a video file, ``False`` if it is a folder of images. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_video</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">tk_is_zoomed</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`tkinter.BooleanVar`: The variable holding the value indicating whether the
        frame viewer is zoomed into a face or zoomed out to the full frame. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"is_zoomed"</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">is_zoomed</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" bool: ``True`` if the frame viewer is zoomed into a face, ``False`` if the frame viewer
        is displaying a full frame. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"is_zoomed"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">tk_transport_index</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`tkinter.IntVar`: The current index of the display frame's transport slider. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"transport_index"</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">tk_update</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`tkinter.BooleanVar`: The variable holding the trigger that indicates that a
        full update needs to occur. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"update"</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_check_input</span><span class="grouping">(</span><span class="identifier">frames_location</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check whether the input is a video

        Parameters
        ----------
        frames_location: str
            The input location for video or images

        Returns
        -------
        bool: 'True' if input is a video 'False' if it is a folder.
        """</span>
        <span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">isdir</span><span class="grouping">(</span><span class="identifier">frames_location</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="keyword">elif</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">splitext</span><span class="grouping">(</span><span class="identifier">frames_location</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">_video_extensions</span><span class="punctuation">:</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"The input location '%s' is not valid"</span><span class="punctuation">,</span> <span class="identifier">frames_location</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Input '%s' is_video: %s"</span><span class="punctuation">,</span> <span class="identifier">frames_location</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">set_frame_count</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">count</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the count of total number of frames to :attr:`frame_count` when the
        :class:`FramesLoader` has completed loading.

        Parameters
        ----------
        count: int
            The number of frames that exist for this session
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting frame_count to : %s"</span><span class="punctuation">,</span> <span class="identifier">count</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">count</span>

    <span class="keyword">def</span> <span class="identifier">set_current_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the frame and meta information for the currently displayed frame. Populates the
        attribute :attr:`current_frame`

        Parameters
        ----------
        image: :class:`numpy.ndarray`
            The image used to display in the Frame Viewer
        filename: str
            The filename of the current frame
        """</span>
        <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_display_dims</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_display_dims</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span><span class="grouping">[</span><span class="string-literal">"image"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span><span class="grouping">[</span><span class="string-literal">"filename"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">filename</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span><span class="grouping">[</span><span class="string-literal">"scale"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scale</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span><span class="grouping">[</span><span class="string-literal">"interpolation"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span> <span class="keyword">if</span> <span class="identifier">scale</span> <span class="relational-operator">&gt;</span> <span class="float-literal">1.0</span> <span class="keyword">else</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span><span class="grouping">[</span><span class="string-literal">"display_dims"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                               <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="grouping">{</span><span class="identifier">k</span><span class="punctuation">:</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">v</span>
                      <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">set_frame_display_dims</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the size, in pixels, of the video frame display window and resize the displayed
        frame.

        Used on a frame resize callback, sets the :attr:frame_display_dims`.

        Parameters
        ----------
        width: int
            The width of the frame holding the video canvas in pixels
        height: int
            The height of the frame holding the video canvas in pixels
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_display_dims</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">width</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">height</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span><span class="grouping">[</span><span class="string-literal">"image"</span><span class="grouping">]</span>
        <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_display_dims</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_display_dims</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span><span class="grouping">[</span><span class="string-literal">"scale"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scale</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span><span class="grouping">[</span><span class="string-literal">"interpolation"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span> <span class="keyword">if</span> <span class="identifier">scale</span> <span class="relational-operator">&gt;</span> <span class="float-literal">1.0</span> <span class="keyword">else</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span><span class="grouping">[</span><span class="string-literal">"display_dims"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                               <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="grouping">{</span><span class="identifier">k</span><span class="punctuation">:</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">v</span>
                      <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">Aligner</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" The :class:`Aligner` class sets up an extraction pipeline for each of the current Faceswap
    Aligners, along with the Landmarks based Maskers. When new landmarks are required, the bounding
    boxes from the GUI are passed to this class for pushing through the pipeline. The resulting
    Landmarks and Masks are then returned.

    Parameters
    ----------
    tk_globals: :class:`~tools.manual.manual.TkGlobals`
        The tkinter variables that apply to the whole of the GUI
    exclude_gpus: list or ``None``
        A list of indices correlating to connected GPUs that Tensorflow should not use. Pass
        ``None`` to not exclude any GPUs.
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tk_globals</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing: %s (tk_globals: %s, exclude_gpus: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">tk_globals</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk_globals</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_aligners</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"cv2-dnn": None, "FAN": None, "mask"</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="grouping">}</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_aligner</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"FAN"</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_exclude_gpus</span> <span class="arithmetic-assignment">=</span> <span class="identifier">exclude_gpus</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_index</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_index</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init_thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_background_init_aligner</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_in_queue</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`queue.Queue` - The input queue to the extraction pipeline. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_aligners</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_aligner</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">input_queue</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_feed_face</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`plugins.extract.pipeline.ExtractMedia`: The current face for feeding into the
        aligner, formatted for the pipeline """</span>
        <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">current_faces</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_index</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_index</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">ExtractMedia</span><span class="grouping">(</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">current_frame</span><span class="grouping">[</span><span class="string-literal">"filename"</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">current_frame</span><span class="grouping">[</span><span class="string-literal">"image"</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="identifier">detected_faces</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">face</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">is_initialized</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" bool: The Aligners are initialized in a background thread so that other tasks can be
        performed whilst we wait for initialization. ``True`` is returned if the aligner has
        completed initialization otherwise ``False``."""</span>
        <span class="identifier">thread_is_alive</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init_thread</span><span class="punctuation">.</span><span class="identifier">is_alive</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">thread_is_alive</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Aligner not yet initialized"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init_thread</span><span class="punctuation">.</span><span class="identifier">check_and_raise_error</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Aligner initialized"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init_thread</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="logical-operator">not</span> <span class="identifier">thread_is_alive</span>

    <span class="keyword">def</span> <span class="identifier">_background_init_aligner</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Launch the aligner in a background thread so we can run other tasks whilst
        waiting for initialization """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Launching aligner initialization thread"</span><span class="grouping">)</span>
        <span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MultiThread</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init_aligner</span><span class="punctuation">,</span>
                             <span class="identifier">thread_count</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                             <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"{}.init_aligner"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">thread</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Launched aligner initialization thread"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">thread</span>

    <span class="keyword">def</span> <span class="identifier">_init_aligner</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Initialize Aligner in a background thread, and set it to :attr:`_aligner`. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialize Aligner"</span><span class="grouping">)</span>
        <span class="comment"># Make sure non-GPU aligner is allocated first</span>
        <span class="keyword">for</span> <span class="identifier">model</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"mask", "cv2-dnn", "FAN"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing aligner: %s"</span><span class="punctuation">,</span> <span class="identifier">model</span><span class="grouping">)</span>
            <span class="identifier">plugin</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span> <span class="keyword">if</span> <span class="identifier">model</span> <span class="relational-operator">==</span> <span class="string-literal">"mask"</span> <span class="keyword">else</span> <span class="identifier">model</span>
            <span class="identifier">exclude_gpus</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_exclude_gpus</span> <span class="keyword">if</span> <span class="identifier">model</span> <span class="relational-operator">==</span> <span class="string-literal">"FAN"</span> <span class="keyword">else</span> <span class="none-literal">None</span>
            <span class="identifier">aligner</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Extractor</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                <span class="identifier">plugin</span><span class="punctuation">,</span>
                                <span class="grouping">[</span><span class="string-literal">"components", "extended"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">exclude_gpus</span><span class="arithmetic-assignment">=</span><span class="identifier">exclude_gpus</span><span class="punctuation">,</span>
                                <span class="identifier">multiprocess</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                <span class="identifier">normalize_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hist"</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">plugin</span><span class="punctuation">:</span>
                <span class="identifier">aligner</span><span class="punctuation">.</span><span class="identifier">set_batchsize</span><span class="grouping">(</span><span class="string-literal">"align"</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>  <span class="comment"># Set the batchsize to 1</span>
            <span class="identifier">aligner</span><span class="punctuation">.</span><span class="identifier">launch</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s Extractor"</span><span class="punctuation">,</span> <span class="identifier">model</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_aligners</span><span class="grouping">[</span><span class="identifier">model</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">aligner</span>

    <span class="keyword">def</span> <span class="identifier">link_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" As the Aligner has the potential to take the longest to initialize, it is kicked off
        as early as possible. At this time :class:`~tools.manual.detected_faces.DetectedFaces` is
        not yet available.

        Once the Aligner has initialized, this function is called to add the
        :class:`~tools.manual.detected_faces.DetectedFaces` class as a property of the Aligner.

        Parameters
        ----------
        detected_faces: :class:`~tools.manual.detected_faces.DetectedFaces`
            The class that holds the :class:`~lib.align.DetectedFace` objects for the
            current Manual session
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Linking detected_faces: %s"</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">detected_faces</span>

    <span class="keyword">def</span> <span class="identifier">get_landmarks</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">aligner</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Feed the detected face into the alignment pipeline and retrieve the landmarks.

        The face to feed into the aligner is generated from the given frame and face indices.

        Parameters
        ----------
        frame_index: int
            The frame index to extract the aligned face for
        face_index: int
            The face index within the current frame to extract the face for
        aligner: ["FAN", "cv2-dnn"]
            The aligner to use to extract the face

        Returns
        -------
        :class:`numpy.ndarray`
            The 68 point landmark alignments
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"frame_index: %s, face_index: %s, aligner: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">aligner</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">frame_index</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_index</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_aligner</span> <span class="arithmetic-assignment">=</span> <span class="identifier">aligner</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_in_queue</span><span class="punctuation">.</span><span class="identifier">put</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_feed_face</span><span class="grouping">)</span>
        <span class="identifier">detected_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_aligners</span><span class="grouping">[</span><span class="identifier">aligner</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">detected_faces</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">detected_faces</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"landmarks: %s"</span><span class="punctuation">,</span> <span class="identifier">detected_face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">detected_face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span>

    <span class="keyword">def</span> <span class="identifier">get_masks</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Feed the aligned face into the mask pipeline and retrieve the updated masks.

        The face to feed into the aligner is generated from the given frame and face indices.
        This is to be called when a manual update is done on the landmarks, and new masks need
        generating

        Parameters
        ----------
        frame_index: int
            The frame index to extract the aligned face for
        face_index: int
            The face index within the current frame to extract the face for

        Returns
        -------
        dict
            The updated masks
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"frame_index: %s, face_index: %s"</span><span class="punctuation">,</span> <span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">frame_index</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_index</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_aligner</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"mask"</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_in_queue</span><span class="punctuation">.</span><span class="identifier">put</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_feed_face</span><span class="grouping">)</span>
        <span class="identifier">detected_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_aligners</span><span class="grouping">[</span><span class="string-literal">"mask"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">detected_faces</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">detected_faces</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"mask: %s"</span><span class="punctuation">,</span> <span class="identifier">detected_face</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">detected_face</span><span class="punctuation">.</span><span class="identifier">mask</span>

    <span class="keyword">def</span> <span class="identifier">set_normalization_method</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Change the normalization method for faces fed into the aligner.
        The normalization method is user adjustable from the GUI. When this method is triggered
        the method is updated for all aligner pipelines.

        Parameters
        ----------
        method: str
            The normalization method to use
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting normalization method to: '%s'"</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">plugin</span><span class="punctuation">,</span> <span class="identifier">aligner</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_aligners</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">plugin</span> <span class="relational-operator">==</span> <span class="string-literal">"mask"</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
            <span class="identifier">aligner</span><span class="punctuation">.</span><span class="identifier">set_aligner_normalization_method</span><span class="grouping">(</span><span class="identifier">method</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">FrameLoader</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Loads the frames, sets the frame count to :attr:`TkGlobals.frame_count` and handles the
    return of the correct frame for the GUI.

    Parameters
    ----------
    tk_globals: :class:`~tools.manual.manual.TkGlobals`
        The tkinter variables that apply to the whole of the GUI
    frames_location: str
        The path to the input frames
    video_meta_data: dict
        The meta data held within the alignments file, if it exists and the input is a video
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tk_globals</span><span class="punctuation">,</span> <span class="identifier">frames_location</span><span class="punctuation">,</span> <span class="identifier">video_meta_data</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (tk_globals: %s, frames_location: '%s', "</span>
                     <span class="string-literal">"video_meta_data: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">tk_globals</span><span class="punctuation">,</span> <span class="identifier">frames_location</span><span class="punctuation">,</span>
                     <span class="identifier">video_meta_data</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk_globals</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_idx</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init_thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_background_init_frames</span><span class="grouping">(</span><span class="identifier">frames_location</span><span class="punctuation">,</span> <span class="identifier">video_meta_data</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_frame_index</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_frame</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">is_initialized</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" bool: ``True`` if the Frame Loader has completed initialization otherwise
        ``False``. """</span>
        <span class="identifier">thread_is_alive</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init_thread</span><span class="punctuation">.</span><span class="identifier">is_alive</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">thread_is_alive</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init_thread</span><span class="punctuation">.</span><span class="identifier">check_and_raise_error</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init_thread</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="comment"># Setting the initial frame cannot be done in the thread, so set when queried from main</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_frame</span><span class="grouping">(</span><span class="identifier">initialize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="logical-operator">not</span> <span class="identifier">thread_is_alive</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">video_meta_data</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: The pts_time and key frames for the loader. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">video_meta_data</span>

    <span class="keyword">def</span> <span class="identifier">_background_init_frames</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">frames_location</span><span class="punctuation">,</span> <span class="identifier">video_meta_data</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Launch the images loader in a background thread so we can run other tasks whilst
        waiting for initialization. """</span>
        <span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MultiThread</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_load_images</span><span class="punctuation">,</span>
                             <span class="identifier">frames_location</span><span class="punctuation">,</span>
                             <span class="identifier">video_meta_data</span><span class="punctuation">,</span>
                             <span class="identifier">thread_count</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                             <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"{}.init_frames"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">thread</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">thread</span>

    <span class="keyword">def</span> <span class="identifier">_load_images</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">frames_location</span><span class="punctuation">,</span> <span class="identifier">video_meta_data</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Load the images in a background thread. """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SingleFrameLoader</span><span class="grouping">(</span><span class="identifier">frames_location</span><span class="punctuation">,</span> <span class="identifier">video_meta_data</span><span class="arithmetic-assignment">=</span><span class="identifier">video_meta_data</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">set_frame_count</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">count</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_set_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="identifier">initialize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
        <span class="comment">""" Set the currently loaded frame to :attr:`_current_frame` and trigger a full GUI update.

        If the loader has not been initialized, or the navigation position is the same as the
        current position and the face is not zoomed in, then this returns having done nothing.

        Parameters
        ----------
        args: tuple
            :class:`tkinter.Event` arguments. Required but not used.
        initialize: bool, optional
            ``True`` if initializing for the first frame to be displayed otherwise ``False``.
            Default: ``False``
        """</span>
        <span class="identifier">position</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">initialize</span> <span class="logical-operator">and</span> <span class="grouping">(</span><span class="identifier">position</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_idx</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Update criteria not met. Not updating: (initialize: %s, position: %s, "</span>
                         <span class="string-literal">"current_idx: %s, is_zoomed: %s)"</span><span class="punctuation">,</span> <span class="identifier">initialize</span><span class="punctuation">,</span> <span class="identifier">position</span><span class="punctuation">,</span>
                         <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_idx</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="grouping">)</span>
            <span class="keyword">return</span>
        <span class="keyword">if</span> <span class="identifier">position</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">filename</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"No Frame"</span>
            <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_display_dims</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"uint8"</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">image_from_index</span><span class="grouping">(</span><span class="identifier">position</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"filename: %s, frame: %s, position: %s"</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">position</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">set_current_frame</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">position</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_update</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_update_active_viewport</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>

    </pre>
  </body>
</html>