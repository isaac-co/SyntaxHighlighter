<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Handles the visible area of the :class:`~tools.manual.faceviewer.frame.FacesViewer` canvas. """</span>

<span class="keyword">import</span> <span class="identifier">logging</span>
<span class="keyword">import</span> <span class="identifier">tkinter</span> <span class="keyword">as</span> <span class="identifier">tk</span>

<span class="keyword">import</span> <span class="identifier">cv2</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">PIL</span> <span class="keyword">import</span> <span class="identifier">Image</span><span class="punctuation">,</span> <span class="identifier">ImageTk</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">align</span> <span class="keyword">import</span> <span class="identifier">AlignedFace</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>


<span class="keyword">class</span> <span class="identifier">Viewport</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Handles the display of faces and annotations in the currently viewable area of the canvas.

    Parameters
    ----------
    canvas: :class:`tkinter.Canvas`
        The :class:`~tools.manual.faceviewer.frame.FacesViewer` canvas
    tk_edited_variable: :class:`tkinter.BooleanVar`
        The variable that indicates that a face has been edited
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">tk_edited_variable</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing: %s: (canvas: %s, tk_edited_variable: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">tk_edited_variable</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">canvas</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">canvas</span><span class="punctuation">.</span><span class="identifier">grid</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"face"</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_selected_editor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">canvas</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">tk_selected_action</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_landmark_mapping</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">mouth_inner</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">60</span><span class="punctuation">,</span> <span class="int-literal">68</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">mouth_outer</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">48</span><span class="punctuation">,</span> <span class="int-literal">60</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">right_eyebrow</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">17</span><span class="punctuation">,</span> <span class="int-literal">22</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">left_eyebrow</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">22</span><span class="punctuation">,</span> <span class="int-literal">27</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">right_eye</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">36</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">left_eye</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">48</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">nose</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">27</span><span class="punctuation">,</span> <span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">jaw</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">17</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">chin</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span> <span class="arithmetic-assignment">=</span> <span class="identifier">VisibleObjects</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_hoverbox</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HoverBox</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_active_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ActiveFrame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tk_edited_variable</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_selected_editor</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span>
            <span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_active_frame</span><span class="punctuation">.</span><span class="identifier">reload_annotations</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">face_size</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The pixel size of each thumbnail """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">face_size</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">mesh_kwargs</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: The color and state keyword arguments for the objects that make up a single
        face's mesh annotation based on the current user selected options. Key is the object
        type (`polygon` or `line`), value are the keyword arguments for that type. """</span>
        <span class="identifier">state</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"normal" if self._canvas.optional_annotations["mesh"] else "hidden"</span>
        <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">control_colors</span><span class="grouping">[</span><span class="string-literal">"Mesh"</span><span class="grouping">]</span>
        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">polygon</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="punctuation">,</span> <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="identifier">state</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">line</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="identifier">state</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">kwargs</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">hover_box</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`HoverBox`: The hover box for the viewport. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_hoverbox</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">selected_editor</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" str: The currently selected editor. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_selected_editor</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">toggle_mesh</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Toggles the mesh optional annotations on and off.

        Parameters
        ----------
        state: ["hidden", "normal"]
            The state to set the mesh annotations to
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Toggling mesh annotations to: %s"</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"viewport_mesh"</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="identifier">state</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">toggle_mask</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="punctuation">,</span> <span class="identifier">mask_type</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Toggles the mask optional annotation on and off.

        Parameters
        ----------
        state: ["hidden", "normal"]
            Whether the mask should be displayed or hidden
        mask_type: str
            The type of mask to overlay onto the face
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Toggling mask annotations to: %s. mask_type: %s"</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="punctuation">,</span> <span class="identifier">mask_type</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">frame_idx</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">det_face</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">visible_grid</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">visible_faces</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">frame_idx</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>

            <span class="identifier">key</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"_"</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">frame_idx</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">face_idx</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span> <span class="keyword">if</span> <span class="identifier">state</span> <span class="relational-operator">==</span> <span class="string-literal">"hidden"</span> <span class="keyword">else</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_obtain_mask</span><span class="grouping">(</span><span class="identifier">det_face</span><span class="punctuation">,</span> <span class="identifier">mask_type</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">update_mask</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_obtain_mask</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">detected_face</span><span class="punctuation">,</span> <span class="identifier">mask_type</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain the mask for the correct "face" centering that is used in the thumbnail display.

        Parameters
        -----------
        detected_face: :class:`lib.align.DetectedFace`
            The Detected Face object to obtain the mask for
        mask_type: str
            The type of mask to obtain

        Returns
        -------
        :class:`numpy.ndarray` or ``None``
            The single channel mask of requested mask type, if it exists, otherwise ``None``
        """</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">detected_face</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">mask_type</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">mask</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="none-literal">None</span>
        <span class="keyword">if</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">stored_centering</span> <span class="relational-operator">!=</span> <span class="string-literal">"face"</span><span class="punctuation">:</span>
            <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">detected_face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span><span class="grouping">)</span>
            <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">set_sub_crop</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">pose</span><span class="punctuation">.</span><span class="identifier">offset</span><span class="grouping">[</span><span class="string-literal">"face"</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">pose</span><span class="punctuation">.</span><span class="identifier">offset</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">stored_centering</span><span class="grouping">]</span><span class="punctuation">,</span>
                              <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"face"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">reset</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Reset all the cached objects on a face size change. """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">update</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">refresh_annotations</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the viewport.

        Parameters
        ----------
        refresh_annotations: bool, optional
            ``True`` if mesh annotations should be re-calculated otherwise ``False``.
            Default: ``False``

        Obtains the objects that are currently visible. Updates the visible area of the canvas
        and reloads the active frame's annotations. """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_viewport</span><span class="grouping">(</span><span class="identifier">refresh_annotations</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_active_frame</span><span class="punctuation">.</span><span class="identifier">reload_annotations</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_viewport</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">refresh_annotations</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the viewport

        Parameters
        ----------
        refresh_annotations: bool
            ``True`` if mesh annotations should be re-calculated otherwise ``False``

        Clear out cached objects that are not currently in view. Populate the cache for any
        faces that are now in view. Populate the correct face image and annotations for each
        object in the viewport based on current location. If optional mesh annotations are
        enabled, then calculates newly displayed meshes. """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">is_valid</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_discard_tk_faces</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">optional_annotations</span><span class="grouping">[</span><span class="string-literal">"mesh"</span><span class="grouping">]</span><span class="punctuation">:</span>  <span class="comment"># Display any hidden end of row meshes</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"viewport_mesh", state="normal"</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">collection</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">visible_grid</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">images</span><span class="punctuation">,</span>
                              <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">meshes</span><span class="punctuation">,</span>
                              <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">visible_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">frame_idx</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">pnt_x</span><span class="punctuation">,</span> <span class="identifier">pnt_y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">image_id</span><span class="punctuation">,</span> <span class="identifier">mesh_ids</span><span class="punctuation">,</span> <span class="identifier">face</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">collection</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">top_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">pnt_x</span><span class="punctuation">,</span> <span class="identifier">pnt_y</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">frame_idx</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_active_frame</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">:</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Skipping active frame: %s"</span><span class="punctuation">,</span> <span class="identifier">frame_idx</span><span class="grouping">)</span>
                    <span class="keyword">continue</span>
                <span class="keyword">if</span> <span class="identifier">frame_idx</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Blanking non-existant face"</span><span class="grouping">)</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">image_id</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="grouping">)</span>
                    <span class="keyword">for</span> <span class="identifier">area</span> <span class="relational-operator">in</span> <span class="identifier">mesh_ids</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="keyword">for</span> <span class="identifier">mesh_id</span> <span class="relational-operator">in</span> <span class="identifier">area</span><span class="punctuation">:</span>
                            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">mesh_id</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hidden"</span><span class="grouping">)</span>
                    <span class="keyword">continue</span>

                <span class="identifier">tk_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">get_tk_face</span><span class="grouping">(</span><span class="identifier">frame_idx</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">image_id</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">tk_face</span><span class="punctuation">.</span><span class="identifier">photo</span><span class="grouping">)</span>

                <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">optional_annotations</span><span class="grouping">[</span><span class="string-literal">"mesh"</span><span class="grouping">]</span>
                        <span class="logical-operator">or</span> <span class="identifier">frame_idx</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_active_frame</span><span class="punctuation">.</span><span class="identifier">frame_index</span>
                        <span class="logical-operator">or</span> <span class="identifier">refresh_annotations</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">get_landmarks</span><span class="grouping">(</span><span class="identifier">frame_idx</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">top_left</span><span class="punctuation">,</span>
                                                   <span class="identifier">refresh</span><span class="arithmetic-assignment">=</span><span class="identifier">refresh_annotations</span><span class="grouping">)</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_locate_mesh</span><span class="grouping">(</span><span class="identifier">mesh_ids</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_discard_tk_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Remove any :class:`TKFace` objects from the cache that are not currently displayed. """</span>
        <span class="identifier">keys</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"{}_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">pnt_x</span><span class="punctuation">,</span> <span class="identifier">pnt_y</span><span class="grouping">)</span>
                <span class="keyword">for</span> <span class="identifier">pnt_x</span><span class="punctuation">,</span> <span class="identifier">pnt_y</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">visible_grid</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">key</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">keys</span><span class="punctuation">:</span>
                <span class="keyword">del</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"keys: %s allocated_faces: %s"</span><span class="punctuation">,</span> <span class="identifier">keys</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">get_tk_face</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain the :class:`TKFace` object for the given face from the cache. If the face does
        not exist in the cache, then it is generated and added prior to returning.

        Parameters
        ----------
        frame_index: int
            The frame index to obtain the face for
        face_index: int
            The face index of the face within the requested frame
        face: :class:`~lib.align.DetectedFace`
            The detected face object, containing the thumbnail jpg

        Returns
        -------
        :class:`TKFace`
            An object for displaying in the faces viewer canvas populated with the aligned mesh
            landmarks and face thumbnail
        """</span>
        <span class="identifier">is_active</span> <span class="arithmetic-assignment">=</span> <span class="identifier">frame_index</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_active_frame</span><span class="punctuation">.</span><span class="identifier">frame_index</span>
        <span class="identifier">key</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"_"</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">frame_index</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">face_index</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">key</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span> <span class="logical-operator">or</span> <span class="identifier">is_active</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"creating new tk_face: (key: %s, is_active: %s)"</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">is_active</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">is_active</span><span class="punctuation">:</span>
                <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span><span class="punctuation">,</span>
                                    <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_active_frame</span><span class="punctuation">.</span><span class="identifier">current_frame</span><span class="punctuation">,</span>
                                    <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="punctuation">,</span>
                                    <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">face_size</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">face</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span><span class="punctuation">,</span>
                                    <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">imdecode</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">thumbnail</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">IMREAD_UNCHANGED</span><span class="grouping">)</span><span class="punctuation">,</span>
                                    <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="punctuation">,</span>
                                    <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">face_size</span><span class="punctuation">,</span>
                                    <span class="identifier">is_aligned</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">face</span>
            <span class="identifier">tk_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_tk_face_object</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">is_active</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk_face</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"tk_face exists: %s"</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="grouping">)</span>
            <span class="identifier">tk_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">tk_face</span>

    <span class="keyword">def</span> <span class="identifier">_get_tk_face_object</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">is_active</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain an existing unallocated, or a newly created :class:`TKFace` and populate it with
        face information from the requested frame and face index.

        If the face is currently active, then the face is generated from the currently displayed
        frame, otherwise it is generated from the jpg thumbnail.

        Parameters
        ----------
        face: :class:`lib.align.DetectedFace`
            A detected face object to create the :class:`TKFace` from
        image: :class:`numpy.ndarray`
            The jpg thumbnail or the 3 channel image for the face
        is_active: bool
            ``True`` if the face in the currently active frame otherwise ``False``

        Returns
        -------
        :class:`TKFace`
            An object for displaying in the faces viewer canvas populated with the aligned face
            image with a mask applied, if required.
        """</span>
        <span class="identifier">get_mask</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">optional_annotations</span><span class="grouping">[</span><span class="string-literal">"mask"</span><span class="grouping">]</span> <span class="logical-operator">or</span>
                    <span class="grouping">(</span><span class="identifier">is_active</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">selected_editor</span> <span class="relational-operator">==</span> <span class="string-literal">"mask"</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_obtain_mask</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">selected_mask</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">get_mask</span> <span class="keyword">else</span> <span class="none-literal">None</span>
        <span class="identifier">tk_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TKFace</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">face_size</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">mask</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"face: %s, tk_face: %s"</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">tk_face</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">tk_face</span>

    <span class="keyword">def</span> <span class="identifier">get_landmarks</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">top_left</span><span class="punctuation">,</span> <span class="identifier">refresh</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain the landmark points for each mesh annotation.

        First tries to obtain the aligned landmarks from the cache. If the landmarks do not exist
        in the cache, or a refresh has been requested, then the landmarks are calculated from the
        detected face object.

        Parameters
        ----------
        frame_index: int
            The frame index to obtain the face for
        face_index: int
            The face index of the face within the requested frame
        face: :class:`lib.align.DetectedFace`
            The detected face object to obtain landmarks for
        top_left: tuple
            The top left (x, y) points of the face's bounding box within the viewport
        refresh: bool, optional
            Whether to force a reload of the face's aligned landmarks, even if they already exist
            within the cache. Default: ``False``

        Returns
        -------
        dict
            The key is the tkinter canvas object type for each part of the mesh annotation
            (`polygon`, `line`). The value is a list containing the (x, y) coordinates of each
            part of the mesh annotation, from the top left corner location.
        """</span>
        <span class="identifier">key</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{}_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="grouping">)</span>
        <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_landmarks</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">key</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">landmarks</span> <span class="logical-operator">or</span> <span class="identifier">refresh</span><span class="punctuation">:</span>
            <span class="identifier">aligned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span><span class="punctuation">,</span>
                                  <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="punctuation">,</span>
                                  <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">face_size</span><span class="grouping">)</span>
            <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">polygon</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">line</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">area</span><span class="punctuation">,</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_landmark_mapping</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">landmarks</span><span class="grouping">[</span><span class="identifier">val</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span><span class="identifier">val</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">top_left</span>
                <span class="identifier">shape</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"polygon" if area.endswith("eye") or area.startswith("mouth") else "line"</span>
                <span class="identifier">landmarks</span><span class="grouping">[</span><span class="identifier">shape</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">points</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_landmarks</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">landmarks</span>
        <span class="keyword">return</span> <span class="identifier">landmarks</span>

    <span class="keyword">def</span> <span class="identifier">_locate_mesh</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">mesh_ids</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Place the mesh annotation canvas objects in the correct location.

        Parameters
        ----------
        mesh_ids: list
            The list of mesh id objects to set coordinates for
        landmarks: dict
            The mesh point groupings and whether each group should be a line or a polygon
        """</span>
        <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">area</span> <span class="relational-operator">in</span> <span class="identifier">landmarks</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">coords</span><span class="punctuation">,</span> <span class="identifier">mesh_id</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">area</span><span class="punctuation">,</span> <span class="identifier">mesh_ids</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">mesh_id</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">coords</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">face_from_point</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">point_x</span><span class="punctuation">,</span> <span class="identifier">point_y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Given an (x, y) point on the :class:`Viewport`, obtain the face information at that
        location.

        Parameters
        ----------
        point_x: int
            The x position on the canvas of the point to retrieve the face for
        point_y: int
            The y position on the canvas of the point to retrieve the face for

        Returns
        -------
        :class:`numpy.ndarray`
            Array of shape (4, ) containing the (`frame index`, `face index`, `x_point of top left
            corner`, `y point of top left corner`) of the face at the given coordinates.

            If the given coordinates are not over a face, then the frame and face indices will be
            -1
        """</span>
        <span class="keyword">if</span> <span class="identifier">point_x</span> <span class="relational-operator">&gt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">dimensions</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">x_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">searchsorted</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">visible_grid</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">point_x</span><span class="punctuation">,</span> <span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="string-literal">"left"</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
            <span class="identifier">y_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">searchsorted</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">visible_grid</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">point_y</span><span class="punctuation">,</span> <span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="string-literal">"left"</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
            <span class="keyword">if</span> <span class="identifier">x_idx</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span> <span class="logical-operator">or</span> <span class="identifier">y_idx</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">visible_grid</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">y_idx</span><span class="punctuation">,</span> <span class="identifier">x_idx</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="identifier">retval</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">move_active_to_top</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check whether the active frame is going off the bottom of the viewport, if so: move it
        to the top of the viewport. """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_active_frame</span><span class="punctuation">.</span><span class="identifier">move_to_top</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">VisibleObjects</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Holds the objects from the :class:`~tools.manual.faceviewer.frame.Grid` that appear in the
    viewable area of the :class:`Viewport`.

    Parameters
    ----------
    viewport: :class:`Viewport`
        The viewport object for the :class:`~tools.manual.faceviewer.frame.FacesViewer` canvas
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">viewport</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_canvas</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_grid</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">face_size</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_visible_grid</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_visible_faces</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meshes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_recycled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">images</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">meshes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">visible_grid</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray`: The currently visible section of the
        :class:`~tools.manual.faceviewer.frame.Grid`

        A numpy array of shape (`4`, `rows`, `columns`) corresponding to the viewable area of the
        display grid. 1st dimension contains frame indices, 2nd dimension face indices. The 3rd and
        4th dimension contain the x and y position of the top left corner of the face respectively.

        Any locations that are not populated by a face will have a frame and face index of -1. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_visible_grid</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">visible_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray`: The currently visible :class:`~lib.align.DetectedFace`
        objects.

        A numpy array of shape (`rows`, `columns`) corresponding to the viewable area of the
        display grid and containing the detected faces at their currently viewable position.

        Any locations that are not populated by a face will have ``None`` in it's place. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_visible_faces</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">images</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray`: The viewport's tkinter canvas image objects.

        A numpy array of shape (`rows`, `columns`) corresponding to the viewable area of the
        display grid and containing the tkinter canvas image object for the face at the
        corresponding location. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">meshes</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray`: The viewport's tkinter canvas mesh annotation objects.

        A numpy array of shape (`rows`, `columns`) corresponding to the viewable area of the
        display grid and containing a dictionary of the corresponding tkinter polygon and line
        objects required to build a face's mesh annotation for the face at the corresponding
        location. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meshes</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_top_left</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray`: The canvas (`x`, `y`) position of the face currently in the
        viewable area's top left position. """</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"int"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">update</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Load and unload thumbnails in the visible area of the faces viewer. """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_visible_grid</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_visible_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">visible_area</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_visible_grid</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
                <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_visible_grid</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_recycle_objects</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">required_rows</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_visible_grid</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">is_valid</span> <span class="keyword">else</span> <span class="int-literal">0</span>
        <span class="identifier">existing_rows</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"existing_rows: %s. required_rows: %s"</span><span class="punctuation">,</span> <span class="identifier">existing_rows</span><span class="punctuation">,</span> <span class="identifier">required_rows</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">existing_rows</span> <span class="relational-operator">&gt;</span> <span class="identifier">required_rows</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">image_id</span><span class="punctuation">,</span> <span class="identifier">mesh_ids</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="grouping">[</span><span class="identifier">required_rows</span><span class="punctuation">:</span> <span class="identifier">existing_rows</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                          <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meshes</span><span class="grouping">[</span><span class="identifier">required_rows</span><span class="punctuation">:</span> <span class="identifier">existing_rows</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Hiding image id: %s"</span><span class="punctuation">,</span> <span class="identifier">image_id</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">image_id</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="grouping">)</span>
                <span class="keyword">for</span> <span class="identifier">ids</span> <span class="relational-operator">in</span> <span class="identifier">mesh_ids</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="keyword">for</span> <span class="identifier">mesh_id</span> <span class="relational-operator">in</span> <span class="identifier">ids</span><span class="punctuation">:</span>
                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">mesh_id</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hidden"</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">existing_rows</span> <span class="relational-operator">&lt;</span> <span class="identifier">required_rows</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_rows</span><span class="grouping">(</span><span class="identifier">existing_rows</span><span class="punctuation">,</span> <span class="identifier">required_rows</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_shift</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_recycle_objects</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""  On a column count change, place all existing objects into the recycle bin so that
        they can be used for the new grid shape and reset the objects size to the new size. """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">face_size</span>
        <span class="identifier">images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">meshes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meshes</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">image_id</span> <span class="relational-operator">in</span> <span class="identifier">images</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">image_id</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">image_id</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">mesh</span> <span class="relational-operator">in</span> <span class="identifier">meshes</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">mesh_ids</span> <span class="relational-operator">in</span> <span class="identifier">mesh</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">coords</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">key</span> <span class="relational-operator">==</span> <span class="string-literal">"line"</span> <span class="keyword">else</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
                <span class="keyword">for</span> <span class="identifier">mesh_id</span> <span class="relational-operator">in</span> <span class="identifier">mesh_ids</span><span class="punctuation">:</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">mesh_id</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">coords</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_recycled</span><span class="grouping">[</span><span class="string-literal">"images"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="identifier">images</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_recycled</span><span class="grouping">[</span><span class="string-literal">"meshes"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="identifier">meshes</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Recycled objects: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_recycled</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meshes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">_add_rows</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">existing_rows</span><span class="punctuation">,</span> <span class="identifier">required_rows</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add rows to the viewport.

        Parameters
        ----------
        existing_rows: int
            The number of existing rows within the viewport
        required_rows: int
            The number of rows required by the viewport
        """</span>
        <span class="identifier">columns</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">columns_rows</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">base_coords</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">col</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">col</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">columns</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">base_coords</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">item_id</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"existing rows: %s, required_rows: %s, base_coords: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">existing_rows</span><span class="punctuation">,</span> <span class="identifier">required_rows</span><span class="punctuation">,</span> <span class="identifier">base_coords</span><span class="grouping">)</span>
        <span class="identifier">images</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">meshes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">row</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">existing_rows</span><span class="punctuation">,</span> <span class="identifier">required_rows</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">y_coord</span> <span class="arithmetic-assignment">=</span> <span class="identifier">base_coords</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">row</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="grouping">)</span>
            <span class="identifier">images</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_image</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">coords</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_coord</span><span class="grouping">)</span><span class="grouping">)</span>
                                    <span class="keyword">for</span> <span class="identifier">coords</span> <span class="relational-operator">in</span> <span class="identifier">base_coords</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">meshes</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_mesh</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">columns</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">images</span><span class="grouping">)</span>
        <span class="identifier">meshes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">meshes</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Adding initial viewport objects: (image shapes: %s, mesh shapes: %s)"</span><span class="punctuation">,</span>
                         <span class="identifier">images</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">meshes</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">images</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meshes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">meshes</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Adding new viewport objects: (image shapes: %s, mesh shapes: %s)"</span><span class="punctuation">,</span>
                         <span class="identifier">images</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">meshes</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">,</span> <span class="identifier">images</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meshes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meshes</span><span class="punctuation">,</span> <span class="identifier">meshes</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"self._images: %s, self._meshes: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meshes</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_image</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">coordinates</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Create or recycle a tkinter canvas image object with the given coordinates.

        Parameters
        ----------
        coordinates: tuple
            The (`x`, `y`) coordinates for the top left corner of the image

        Returns
        -------
        int
            The canvas object id for the created image
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_recycled</span><span class="grouping">[</span><span class="string-literal">"images"</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">image_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_recycled</span><span class="grouping">[</span><span class="string-literal">"images"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">image_id</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">coordinates</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Recycled image: %s"</span><span class="punctuation">,</span> <span class="identifier">image_id</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">image_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">create_image</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">coordinates</span><span class="punctuation">,</span>
                                                 <span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">NW</span><span class="punctuation">,</span>
                                                 <span class="identifier">tags</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"viewport", "viewport_image"</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Created new image: %s"</span><span class="punctuation">,</span> <span class="identifier">image_id</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">image_id</span>

    <span class="keyword">def</span> <span class="identifier">_get_mesh</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get the mesh annotation for the landmarks. This is made up of a series of polygons
        or lines, depending on which part of the face is being annotated. Creates a new series of
        objects, or pulls existing objects from the recycled objects pool if they are available.

        Returns
        -------
        dict
            The dictionary of line and polygon tkinter canvas object ids for the mesh annotation
        """</span>
        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">mesh_kwargs</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"self.mesh_kwargs: %s"</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_recycled</span><span class="grouping">[</span><span class="string-literal">"meshes"</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">mesh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_recycled</span><span class="grouping">[</span><span class="string-literal">"meshes"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">mesh_ids</span> <span class="relational-operator">in</span> <span class="identifier">mesh</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">for</span> <span class="identifier">mesh_id</span> <span class="relational-operator">in</span> <span class="identifier">mesh_ids</span><span class="punctuation">:</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">mesh_id</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Recycled mesh: %s"</span><span class="punctuation">,</span> <span class="identifier">mesh</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"viewport", "viewport_mesh"</span><span class="grouping">]</span>
            <span class="identifier">mesh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">polygon</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">create_polygon</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span>
                                                             <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                                             <span class="identifier">tags</span><span class="arithmetic-assignment">=</span><span class="identifier">tags</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="string-literal">"viewport_polygon"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                             <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">[</span><span class="string-literal">"polygon"</span><span class="grouping">]</span><span class="grouping">)</span>
                                 <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="identifier">line</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">create_line</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span>
                                                       <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                                       <span class="identifier">tags</span><span class="arithmetic-assignment">=</span><span class="identifier">tags</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="string-literal">"viewport_line"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                       <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">[</span><span class="string-literal">"line"</span><span class="grouping">]</span><span class="grouping">)</span>
                              <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Created new mesh: %s"</span><span class="punctuation">,</span> <span class="identifier">mesh</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">mesh</span>

    <span class="keyword">def</span> <span class="identifier">_shift</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Shift the viewport in the y direction if required

        Returns
        -------
        bool
            ``True`` if the viewport was shifted otherwise ``False``
        """</span>
        <span class="identifier">current_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_top_left</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">required_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_visible_grid</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">is_valid</span> <span class="keyword">else</span> <span class="int-literal">0</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"current_y: %s, required_y: %s"</span><span class="punctuation">,</span> <span class="identifier">current_y</span><span class="punctuation">,</span> <span class="identifier">required_y</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">current_y</span> <span class="relational-operator">==</span> <span class="identifier">required_y</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"No move required"</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="bool-literal">False</span>
        <span class="identifier">shift_amount</span> <span class="arithmetic-assignment">=</span> <span class="identifier">required_y</span> <span class="arithmetic-operator">-</span> <span class="identifier">current_y</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Shifting viewport: %s"</span><span class="punctuation">,</span> <span class="identifier">shift_amount</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">move</span><span class="grouping">(</span><span class="string-literal">"viewport"</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">shift_amount</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="bool-literal">True</span>


<span class="keyword">class</span> <span class="identifier">HoverBox</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-few-public-methods</span>
    <span class="comment">""" Handle the current mouse location when over the :class:`Viewport`.

    Highlights the face currently underneath the cursor and handles actions when clicking
    on a face.

    Parameters
    ----------
    viewport: :class:`Viewport`
        The viewport object for the :class:`~tools.manual.faceviewer.frame.FacesViewer` canvas
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">viewport</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing: %s (viewport: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">viewport</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_canvas</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">grid</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">_globals</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_navigation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">navigation</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">create_rectangle</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">,</span>
                                                  <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="string-literal">"#0000ff"</span><span class="punctuation">,</span>
                                                  <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                                  <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hidden"</span><span class="punctuation">,</span>
                                                  <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="string-literal">"#0000ff"</span><span class="punctuation">,</span>
                                                  <span class="identifier">stipple</span><span class="arithmetic-assignment">=</span><span class="string-literal">"gray12"</span><span class="punctuation">,</span>
                                                  <span class="identifier">tags</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hover_box"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame_index</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_face_index</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;Leave&gt;"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_clear</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;Motion&gt;"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">on_hover</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;ButtonPress-1&gt;"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_select_frame</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_size</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: the currently set viewport face size in pixels. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">face_size</span>

    <span class="keyword">def</span> <span class="identifier">on_hover</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Highlight the face and set the mouse cursor for the mouse's current location.

        Parameters
        ----------
        event: :class:`tkinter.Event` or ``None``
            The tkinter mouse event. Provides the current location of the mouse cursor. If ``None``
            is passed as the event (for example when this function is being called outside of a
            mouse event) then the location of the cursor will be calculated
        """</span>
        <span class="keyword">if</span> <span class="identifier">event</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">pnts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">winfo_pointerx</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">winfo_pointery</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">pnts</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">winfo_rootx</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">winfo_rooty</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">pnts</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">coords</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">canvasx</span><span class="grouping">(</span><span class="identifier">pnts</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">canvasy</span><span class="grouping">(</span><span class="identifier">pnts</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">face_from_point</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">coords</span><span class="grouping">)</span>
        <span class="identifier">frame_idx</span><span class="punctuation">,</span> <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>

        <span class="keyword">if</span> <span class="identifier">frame_idx</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame_index</span> <span class="logical-operator">and</span> <span class="identifier">face_idx</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_face_index</span><span class="punctuation">:</span>
            <span class="keyword">return</span>

        <span class="identifier">is_zoomed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="relational-operator">in</span> <span class="identifier">face</span> <span class="logical-operator">or</span> <span class="grouping">(</span><span class="identifier">frame_idx</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span>
                           <span class="logical-operator">and</span> <span class="grouping">(</span><span class="logical-operator">not</span> <span class="identifier">is_zoomed</span> <span class="logical-operator">or</span>
                                <span class="grouping">(</span><span class="identifier">is_zoomed</span> <span class="logical-operator">and</span> <span class="identifier">face_idx</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_face_index</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_clear</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame_index</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_face_index</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="keyword">return</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Viewport hover: frame_idx: %s, face_idx: %s"</span><span class="punctuation">,</span> <span class="identifier">frame_idx</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hand2"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_highlight</span><span class="grouping">(</span><span class="identifier">face</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">frame_idx</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_face_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_idx</span>

    <span class="keyword">def</span> <span class="identifier">_clear</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Hide the hover box when the mouse is not over a face. """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemcget</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_box</span><span class="punctuation">,</span> <span class="string-literal">"state") != "hidden"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_box</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hidden"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_highlight</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">top_left</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Display the hover box around the face that the mouse is currently over.

        Parameters
        ----------
        top_left: tuple
            The top left point of the highlight box location
        """</span>
        <span class="identifier">coords</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">top_left</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">top_left</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_box</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">coords</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_box</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"normal"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">tag_raise</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_box</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_select_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Select the face and the subsequent frame (in the editor view) when a face is clicked
        on in the :class:`Viewport`.
        """</span>
        <span class="identifier">frame_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_frame_index</span>
        <span class="identifier">is_zoomed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Face clicked. Global frame index: %s, Current frame_id: %s, is_zoomed: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">frame_id</span><span class="punctuation">,</span> <span class="identifier">is_zoomed</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">frame_id</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">or</span> <span class="grouping">(</span><span class="identifier">frame_id</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">is_zoomed</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_current_face_index</span> <span class="keyword">if</span> <span class="identifier">is_zoomed</span> <span class="keyword">else</span> <span class="int-literal">0</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_face_index</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">face_idx</span><span class="grouping">)</span>
        <span class="identifier">transport_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">transport_index_from_frame</span><span class="grouping">(</span><span class="identifier">frame_id</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"frame_index: %s, transport_id: %s, face_idx: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">frame_id</span><span class="punctuation">,</span> <span class="identifier">transport_id</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">transport_id</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_navigation</span><span class="punctuation">.</span><span class="identifier">stop_playback</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_transport_index</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">transport_id</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">move_active_to_top</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">on_hover</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">ActiveFrame</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Handles the display of faces and annotations for the currently active frame.

    Parameters
    ----------
    canvas: :class:`tkinter.Canvas`
        The :class:`~tools.manual.faceviewer.frame.FacesViewer` canvas
    tk_edited_variable: :class:`tkinter.BooleanVar`
        The tkinter callback variable indicating that a face has been edited
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">viewport</span><span class="punctuation">,</span> <span class="identifier">tk_edited_variable</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing: %s (viewport: %s, tk_edited_variable: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">viewport</span><span class="punctuation">,</span> <span class="identifier">tk_edited_variable</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_objects</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_grid</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_canvas</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">_globals</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_navigation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">navigation</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_last_execution</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">frame_index</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">face_size</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">selected_editor</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">tk_selected_action</span><span class="punctuation">,</span>
                             <span class="identifier">edited</span><span class="arithmetic-assignment">=</span><span class="identifier">tk_edited_variable</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">images</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">meshes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">faces</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">boxes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_update_active_viewport</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_reload_callback</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">tk_edited_variable</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_on_edit</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">frame_index</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The frame index of the currently displayed frame. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">current_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray`: A BGR version of the frame currently being displayed. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">current_frame</span><span class="grouping">[</span><span class="string-literal">"image"</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_size</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The size of the thumbnails displayed in the viewport, in pixels. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">face_size</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_optional_annotations</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: The currently selected optional annotations """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">optional_annotations</span>

    <span class="keyword">def</span> <span class="identifier">_reload_callback</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" If a frame has changed, triggering the variable, then update the active frame. Return
        having done nothing if the variable is resetting. """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_update_active_viewport</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">reload_annotations</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">reload_annotations</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Handles the reloading of annotations for the currently active faces.

        Highlights the faces within the viewport of those faces that exist in the currently
        displaying frame. Applies annotations based on the optional annotations and current
        editor selections.
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Reloading annotations"</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"images"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_clear_previous</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_active_objects</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_active_in_view</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"images"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"No active faces. Returning"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_last_execution</span><span class="grouping">[</span><span class="string-literal">"frame_index"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_index</span>
            <span class="keyword">return</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_last_execution</span><span class="grouping">[</span><span class="string-literal">"frame_index"</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">move_to_top</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_create_new_boxes</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_face</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">tag_raise</span><span class="grouping">(</span><span class="string-literal">"active_highlighter"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_update_active_viewport</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_last_execution</span><span class="grouping">[</span><span class="string-literal">"frame_index"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_index</span>

    <span class="keyword">def</span> <span class="identifier">_clear_previous</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Reverts the previously selected annotations to their default state. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Clearing previous active frame"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"active_highlighter", state="hidden"</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"polygon", "line"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">tag</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"active_mesh_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">key</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">tag</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">mesh_kwargs</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">dtag</span><span class="grouping">(</span><span class="identifier">tag</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">selected_editor</span> <span class="relational-operator">==</span> <span class="string-literal">"mask" and not self._optional_annotations["mask"</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">tk_face</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">key</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"{}_".format(self._last_execution["frame_index"</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">tk_face</span><span class="punctuation">.</span><span class="identifier">update_mask</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_set_active_objects</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Collect the objects that exist in the currently active frame from the main grid. """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">is_valid</span><span class="punctuation">:</span>
            <span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">visible_grid</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Setting active objects: (rows: %s, columns: %s)"</span><span class="punctuation">,</span> <span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"images"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">images</span><span class="grouping">[</span><span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span><span class="grouping">]</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"meshes"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">meshes</span><span class="grouping">[</span><span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span><span class="grouping">]</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"faces"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_objects</span><span class="punctuation">.</span><span class="identifier">visible_faces</span><span class="grouping">[</span><span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span><span class="grouping">]</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"No valid grid. Clearing active objects"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"images"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"meshes"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"faces"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">_check_active_in_view</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""  If the frame has changed, there are faces in the frame, but they don't appear in the
        viewport, then bring the active faces to the top of the viewport. """</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"images"</span><span class="grouping">]</span><span class="grouping">)</span> <span class="logical-operator">and</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_last_execution</span><span class="grouping">[</span><span class="string-literal">"frame_index"</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_index</span> <span class="logical-operator">and</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">frame_has_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">y_coord</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">y_coord_from_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Active not in view. Moving to: %s"</span><span class="punctuation">,</span> <span class="identifier">y_coord</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">yview_moveto</span><span class="grouping">(</span><span class="identifier">y_coord</span> <span class="arithmetic-operator">/</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bbox</span><span class="grouping">(</span><span class="string-literal">"backdrop"</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">move_to_top</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Move the currently selected frame's faces to the top of the viewport if they are moving
        off the bottom of the viewer. """</span>
        <span class="identifier">height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bbox</span><span class="grouping">(</span><span class="string-literal">"backdrop"</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span>
        <span class="identifier">bot</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"images"</span><span class="grouping">]</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="grouping">)</span>

        <span class="identifier">y_top</span><span class="punctuation">,</span> <span class="identifier">y_bot</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">pnt</span> <span class="arithmetic-operator">*</span> <span class="identifier">height</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">pnt</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">yview</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">y_top</span> <span class="relational-operator">&lt;</span> <span class="identifier">bot</span> <span class="relational-operator">&lt;</span> <span class="identifier">y_bot</span><span class="punctuation">:</span>  <span class="comment"># bottom face is still in fully visible area</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Active faces in frame. Returning"</span><span class="grouping">)</span>
            <span class="keyword">return</span>

        <span class="identifier">top</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"images"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">y_top</span> <span class="relational-operator">==</span> <span class="identifier">top</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Top face already on top row. Returning"</span><span class="grouping">)</span>
            <span class="keyword">return</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">winfo_height</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Viewport taller than single face height. Moving Active faces to top: %s"</span><span class="punctuation">,</span>
                         <span class="identifier">top</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">yview_moveto</span><span class="grouping">(</span><span class="identifier">top</span> <span class="arithmetic-operator">/</span> <span class="identifier">height</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">winfo_height</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="logical-operator">and</span> <span class="identifier">y_top</span> <span class="relational-operator">!=</span> <span class="identifier">top</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Viewport shorter than single face height. Moving Active faces to "</span>
                         <span class="string-literal">"top: %s"</span><span class="punctuation">,</span> <span class="identifier">top</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">yview_moveto</span><span class="grouping">(</span><span class="identifier">top</span> <span class="arithmetic-operator">/</span> <span class="identifier">height</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_create_new_boxes</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" The highlight boxes (border around selected faces) are the only additional annotations
        that are required for the highlighter. If more faces are displayed in the current frame
        than highlight boxes are available, then new boxes are created to accommodate the
        additional faces. """</span>
        <span class="identifier">new_boxes_count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"images"]) - len(self._assets["boxes"</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">new_boxes_count</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"new_boxes_count: %s"</span><span class="punctuation">,</span> <span class="identifier">new_boxes_count</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">new_boxes_count</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">create_rectangle</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                                <span class="int-literal">0</span><span class="punctuation">,</span>
                                                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">face_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">face_size</span><span class="punctuation">,</span>
                                                <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="string-literal">"#00FF00"</span><span class="punctuation">,</span>
                                                <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                                <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hidden"</span><span class="punctuation">,</span>
                                                <span class="identifier">tags</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"active_highlighter"</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Created new highlight_box: %s"</span><span class="punctuation">,</span> <span class="identifier">box</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"boxes"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">box</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_on_edit</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the active faces on a frame edit. """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"edited"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_active_objects</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_face</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"edited"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_face</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the highlighted annotations for faces in the currently selected frame. """</span>
        <span class="keyword">for</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">image_id</span><span class="punctuation">,</span> <span class="identifier">mesh_ids</span><span class="punctuation">,</span> <span class="identifier">box_id</span><span class="punctuation">,</span> <span class="identifier">det_face</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span>
                <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"images"</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"meshes"</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"boxes"</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_assets</span><span class="grouping">[</span><span class="string-literal">"faces"</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">top_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">image_id</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">coords</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">top_left</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">top_left</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="grouping">)</span>
            <span class="identifier">tk_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">get_tk_face</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">det_face</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">image_id</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">tk_face</span><span class="punctuation">.</span><span class="identifier">photo</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_show_box</span><span class="grouping">(</span><span class="identifier">box_id</span><span class="punctuation">,</span> <span class="identifier">coords</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_show_mesh</span><span class="grouping">(</span><span class="identifier">mesh_ids</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">det_face</span><span class="punctuation">,</span> <span class="identifier">top_left</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_last_execution</span><span class="grouping">[</span><span class="string-literal">"size"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">face_size</span>

    <span class="keyword">def</span> <span class="identifier">_show_box</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">item_id</span><span class="punctuation">,</span> <span class="identifier">coordinates</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Display the highlight box around the given coordinates.

        Parameters
        ----------
        item_id: int
            The tkinter canvas object identifier for the highlight box
        coordinates: :class:`numpy.ndarray`
            The (x, y, x1, y1) coordinates of the top left corner of the box
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">coordinates</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"normal"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_show_mesh</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">mesh_ids</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">detected_face</span><span class="punctuation">,</span> <span class="identifier">top_left</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Display the mesh annotation for the given face, at the given location.

        Parameters
        ----------
        mesh_ids: dict
            Dictionary containing the `polygon` and `line` tkinter canvas identifiers that make up
            the mesh for the given face
        face_index: int
            The face index within the frame for the given face
        detected_face: :class:`~lib.align.DetectedFace`
            The detected face object that contains the landmarks for generating the mesh
        top_left: tuple
            The (x, y) top left co-ordinates of the mesh's bounding box
        """</span>
        <span class="identifier">state</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"normal" if (self._tk_vars["selected_editor"].get() != "Mask"</span> <span class="logical-operator">or</span>
                             <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_optional_annotations</span><span class="grouping">[</span><span class="string-literal">"mesh"]) else "hidden"</span>
        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">polygon</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="string-literal">"", width=2, outline=self._canvas.control_colors["Mesh"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">line</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">control_colors</span><span class="grouping">[</span><span class="string-literal">"Mesh"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">edited</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"edited"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span> <span class="logical-operator">and</span>
                  <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"selected_editor"].get() not in ("Mask", "View"</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_viewport</span><span class="punctuation">.</span><span class="identifier">get_landmarks</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span>
                                                 <span class="identifier">face_index</span><span class="punctuation">,</span>
                                                 <span class="identifier">detected_face</span><span class="punctuation">,</span>
                                                 <span class="identifier">top_left</span><span class="punctuation">,</span>
                                                 <span class="identifier">edited</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">kwarg</span> <span class="relational-operator">in</span> <span class="identifier">kwargs</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">mesh_id</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">mesh_ids</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">mesh_id</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">landmarks</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">mesh_id</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="identifier">state</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwarg</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">addtag_withtag</span><span class="grouping">(</span><span class="string-literal">"active_mesh_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">key</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">mesh_id</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">TKFace</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" An object that holds a single :class:`tkinter.PhotoImage` face, ready for placement in the
    :class:`Viewport`, Handles the placement of and removal of masks for the face as well as
    updates on any edits.

    Parameters
    ----------
    face: :class:`numpy.ndarray`
        The face, sized correctly as a 3 channel BGR image or an encoded jpg to create a
        :class:`tkinter.PhotoImage` from
    size: int, optional
        The pixel size of the face image. Default: `128`
    mask: :class:`numpy.ndarray` or ``None``, optional
        The mask to be applied to the face image. Pass ``None`` if no mask is to be used.
        Default ``None``
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">128</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (face: %s, size: %s, mask: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span>
                     <span class="identifier">face</span> <span class="keyword">if</span> <span class="identifier">face</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span>
                     <span class="identifier">size</span><span class="punctuation">,</span>
                     <span class="identifier">mask</span> <span class="keyword">if</span> <span class="identifier">mask</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">size</span>
        <span class="keyword">if</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">2</span> <span class="logical-operator">and</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_image_from_jpg</span><span class="grouping">(</span><span class="identifier">face</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_photo</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ImageTk</span><span class="punctuation">.</span><span class="identifier">PhotoImage</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_generate_tk_face_data</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="comment"># &lt;&lt; PUBLIC PROPERTIES &gt;&gt; #</span>
    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">photo</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`tkinter.PhotoImage`: The face in a format that can be placed on the
         :class:`~tools.manual.faceviewer.frame.FacesViewer` canvas. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_photo</span>

    <span class="comment"># &lt;&lt; PUBLIC METHODS &gt;&gt; #</span>
    <span class="keyword">def</span> <span class="identifier">update</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the :attr:`photo` with the given face and mask.

        Parameters
        ----------
        face: :class:`numpy.ndarray`
            The face, sized correctly as a 3 channel BGR image
        mask: :class:`numpy.ndarray` or ``None``
            The mask to be applied to the face image. Pass ``None`` if no mask is to be used
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_photo</span><span class="punctuation">.</span><span class="identifier">paste</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_generate_tk_face_data</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">update_mask</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the mask in the 4th channel of :attr:`photo` to the given mask.

        Parameters
        ----------
        mask: :class:`numpy.ndarray` or ``None``
            The mask to be applied to the face image. Pass ``None`` if no mask is to be used
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_photo</span><span class="punctuation">.</span><span class="identifier">paste</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_generate_tk_face_data</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># &lt;&lt; PRIVATE METHODS &gt;&gt; #</span>
    <span class="keyword">def</span> <span class="identifier">_image_from_jpg</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Convert an encoded jpg into 3 channel BGR image.

        Parameters
        ----------
        face: :class:`numpy.ndarray`
            The encoded jpg as a two dimension numpy array

        Returns
        -------
        :class:`numpy.ndarray`
            The decoded jpg as a 3 channel BGR image
        """</span>
        <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">imdecode</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">IMREAD_UNCHANGED</span><span class="grouping">)</span>
        <span class="identifier">interp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span> <span class="keyword">if</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="keyword">else</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span>
        <span class="keyword">if</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">:</span>
            <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="identifier">interp</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">_generate_tk_face_data</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Create the :class:`tkinter.PhotoImage` from the currant :attr:`_face`.

        Parameters
        ----------
        mask: :class:`numpy.ndarray` or ``None``
            The mask to add to the image. ``None`` if a mask is not being used

        Returns
        -------
        :class:`tkinter.PhotoImage`
            The face formatted for the  :class:`~tools.manual.faceviewer.frame.FacesViewer` canvas.
        """</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"uint8"</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">255</span> <span class="keyword">if</span> <span class="identifier">mask</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">mask</span>
        <span class="keyword">if</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">:</span>
            <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span><span class="grouping">)</span>
        <span class="identifier">img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">Image</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">img</span><span class="grouping">)</span>

    </pre>
  </body>
</html>