<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">from</span> <span class="identifier">__future__</span> <span class="keyword">import</span> <span class="identifier">division</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">sparse</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">stats</span> <span class="keyword">import</span> <span class="identifier">kstest</span>

<span class="keyword">import</span> <span class="identifier">io</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>

<span class="comment"># make IterativeImputer available</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">experimental</span> <span class="keyword">import</span> <span class="identifier">enable_iterative_imputer</span>  <span class="comment"># noqa</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_diabetes</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">impute</span> <span class="keyword">import</span> <span class="identifier">MissingIndicator</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">impute</span> <span class="keyword">import</span> <span class="identifier">SimpleImputer</span><span class="punctuation">,</span> <span class="identifier">IterativeImputer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">dummy</span> <span class="keyword">import</span> <span class="identifier">DummyRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">BayesianRidge</span><span class="punctuation">,</span> <span class="identifier">ARDRegression</span><span class="punctuation">,</span> <span class="identifier">RidgeCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">Pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_union</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GridSearchCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">tree</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">random_projection</span> <span class="keyword">import</span> <span class="identifier">_sparse_random_matrix</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">impute</span><span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">_most_frequent</span>


<span class="keyword">def</span> <span class="identifier">_check_statistics</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="punctuation">,</span>
                      <span class="identifier">strategy</span><span class="punctuation">,</span> <span class="identifier">statistics</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Utility function for testing imputation for a given strategy.

    Test with dense and sparse arrays

    Check that:
        - the statistics (mean, median, mode) are correct
        - the missing values are imputed correctly"""</span>

    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Parameters: strategy = %s, missing_values = %s, "</span> <span class="invalid">\</span>
              <span class="string-literal">"sparse = {0}"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">strategy</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">e</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>

    <span class="keyword">if</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'f' or X_true.dtype.kind == 'f'</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">e</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>

    <span class="comment"># Normal matrix</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">statistics_</span><span class="punctuation">,</span> <span class="identifier">statistics</span><span class="punctuation">,</span>
              <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Sparse matrix</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">statistics_</span><span class="punctuation">,</span> <span class="identifier">statistics</span><span class="punctuation">,</span>
              <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"strategy"</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="string-literal">'mean', 'median', 'most_frequent'</span><span class="punctuation">,</span> <span class="string-literal">"constant"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_shape</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Verify the shapes of the imputed matrix for different strategies.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="grouping">)</span>
    <span class="identifier">X_imputed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_imputed</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">X_imputed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_imputed</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="identifier">iterative_imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">initial_strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="grouping">)</span>
    <span class="identifier">X_imputed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iterative_imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_imputed</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"strategy", ["const"</span><span class="punctuation">,</span> <span class="int-literal">101</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_error_invalid_strategy</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="grouping">)</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"strategy", ["mean", "median", "most_frequent"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_deletion_warning</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Deleting"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"strategy", ["mean", "median"</span><span class="punctuation">,</span>
                                      <span class="string-literal">"most_frequent", "constant"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_error_sparse_0</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that error are raised when missing_values = 0 and input is sparse</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Provide a dense array"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Provide a dense array"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">safe_median</span><span class="grouping">(</span><span class="identifier">arr</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># np.median([]) raises a TypeError for numpy &gt;= 1.10.1</span>
    <span class="identifier">length</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">arr</span><span class="punctuation">,</span> <span class="string-literal">'size'</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">arr</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span> <span class="keyword">if</span> <span class="identifier">length</span> <span class="relational-operator">==</span> <span class="int-literal">0</span> <span class="keyword">else</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">median</span><span class="grouping">(</span><span class="identifier">arr</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">safe_mean</span><span class="grouping">(</span><span class="identifier">arr</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># np.mean([]) raises a RuntimeWarning for numpy &gt;= 1.10.1</span>
    <span class="identifier">length</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">arr</span><span class="punctuation">,</span> <span class="string-literal">'size'</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">arr</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span> <span class="keyword">if</span> <span class="identifier">length</span> <span class="relational-operator">==</span> <span class="int-literal">0</span> <span class="keyword">else</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">arr</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_imputation_mean_median</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test imputation using the mean and median strategies, when</span>
    <span class="comment"># missing_values != 0.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">dim</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">dec</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">dim</span> <span class="arithmetic-operator">*</span> <span class="identifier">dim</span><span class="punctuation">,</span> <span class="identifier">dim</span> <span class="arithmetic-operator">+</span> <span class="identifier">dec</span><span class="grouping">)</span>

    <span class="identifier">zeros</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">values</span><span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span> <span class="identifier">values</span><span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>

    <span class="identifier">tests</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"mean"</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="identifier">z</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="punctuation">:</span> <span class="identifier">safe_mean</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">z</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="grouping">(</span><span class="string-literal">"median"</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span>
              <span class="keyword">lambda</span> <span class="identifier">z</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="punctuation">:</span> <span class="identifier">safe_median</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">z</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">strategy</span><span class="punctuation">,</span> <span class="identifier">test_missing_values</span><span class="punctuation">,</span> <span class="identifier">true_value_fun</span> <span class="relational-operator">in</span> <span class="identifier">tests</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="identifier">true_statistics</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Create a matrix X with columns</span>
        <span class="comment">#    - with only zeros,</span>
        <span class="comment">#    - with only missing values</span>
        <span class="comment">#    - with zeros, missing values and values</span>
        <span class="comment"># And a matrix X_true containing all true values</span>
        <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">nb_zeros</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">j</span> <span class="arithmetic-operator">-</span> <span class="identifier">dec</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">j</span> <span class="arithmetic-operator">-</span> <span class="identifier">dec</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">j</span> <span class="arithmetic-operator">-</span> <span class="identifier">dec</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">nb_missing_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">dec</span> <span class="arithmetic-operator">*</span> <span class="identifier">dec</span>
                                    <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">j</span> <span class="arithmetic-operator">+</span> <span class="identifier">dec</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">j</span> <span class="arithmetic-operator">+</span> <span class="identifier">dec</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">nb_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">nb_zeros</span> <span class="arithmetic-operator">-</span> <span class="identifier">nb_missing_values</span>

            <span class="identifier">z</span> <span class="arithmetic-assignment">=</span> <span class="identifier">zeros</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">nb_zeros</span><span class="grouping">]</span>
            <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">test_missing_values</span><span class="punctuation">,</span> <span class="identifier">nb_missing_values</span><span class="grouping">)</span>
            <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">values</span><span class="grouping">[</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">values</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">nb_values</span><span class="grouping">]</span><span class="grouping">]</span>

            <span class="identifier">true_statistics</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">true_value_fun</span><span class="grouping">(</span><span class="identifier">z</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">)</span>

            <span class="comment"># Create the columns</span>
            <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">z</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="int-literal">0</span> <span class="relational-operator">==</span> <span class="identifier">test_missing_values</span><span class="punctuation">:</span>
                <span class="comment"># XXX unreached code as of v0.22</span>
                <span class="identifier">X_true</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span>
                                          <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span>
                                              <span class="identifier">true_statistics</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="punctuation">,</span>
                                              <span class="identifier">nb_missing_values</span> <span class="arithmetic-operator">+</span> <span class="identifier">nb_zeros</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">X_true</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span>
                                          <span class="identifier">z</span><span class="punctuation">,</span>
                                          <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">true_statistics</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                    <span class="identifier">nb_missing_values</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="comment"># Shuffle them the same way</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">j</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">j</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X_true</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Mean doesn't support columns containing NaNs, median does</span>
        <span class="keyword">if</span> <span class="identifier">strategy</span> <span class="relational-operator">==</span> <span class="string-literal">"median"</span><span class="punctuation">:</span>
            <span class="identifier">cols_to_keep</span> <span class="arithmetic-assignment">=</span> <span class="bitwise-operator">~</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">X_true</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">cols_to_keep</span> <span class="arithmetic-assignment">=</span> <span class="bitwise-operator">~</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">X_true</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_true</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">cols_to_keep</span><span class="grouping">]</span>

        <span class="identifier">_check_statistics</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="punctuation">,</span>
                          <span class="identifier">true_statistics</span><span class="punctuation">,</span> <span class="identifier">test_missing_values</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_imputation_median_special_cases</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test median imputation with sparse boundary cases</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># odd: implicit zero</span>
        <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># odd: explicit nonzero</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>    <span class="comment"># even: average two zeros</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>   <span class="comment"># even: avg zero and neg</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>    <span class="comment"># even: avg zero and pos</span>
        <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>    <span class="comment"># even: avg nonzeros</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># even: avg negatives</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>   <span class="comment"># even: crossing neg and pos</span>
    <span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">X_imputed_median</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-2.5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">2.5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">4.5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">-4.5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="float-literal">.5</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">statistics_median</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-2.5</span><span class="punctuation">,</span> <span class="float-literal">2.5</span><span class="punctuation">,</span> <span class="float-literal">4.5</span><span class="punctuation">,</span> <span class="float-literal">-4.5</span><span class="punctuation">,</span> <span class="float-literal">.5</span><span class="grouping">]</span>

    <span class="identifier">_check_statistics</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_imputed_median</span><span class="punctuation">,</span> <span class="string-literal">"median"</span><span class="punctuation">,</span>
                      <span class="identifier">statistics_median</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"strategy", ["mean", "median"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dtype"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">object</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_mean_median_error_invalid_type</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">"a", "b"</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="string-literal">"e"</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="string-literal">"g", "h"</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"non-numeric data:\ncould not convert string to float: '"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="grouping">)</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"strategy", ["mean", "median"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"type"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'list', 'dataframe'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_mean_median_error_invalid_type_list_pandas</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">"a", "b"</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="string-literal">"e"</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="string-literal">"g", "h"</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">type</span> <span class="relational-operator">==</span> <span class="string-literal">'dataframe'</span><span class="punctuation">:</span>
        <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">"pandas"</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"non-numeric data:\ncould not convert string to float: '"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="grouping">)</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"strategy", ["constant", "most_frequent"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dtype"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">str</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">(</span><span class="string-literal">'U'), np.dtype('S'</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_const_mostf_error_invalid_types</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test imputation on non-numeric data using "most_frequent" and "constant"</span>
    <span class="comment"># strategy</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="string-literal">"a", "f"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="string-literal">"c", np.nan, "d"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="string-literal">"b", "d"</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="string-literal">"c", "d", "h"</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"SimpleImputer does not support data"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="grouping">)</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_imputation_most_frequent</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test imputation using the most-frequent strategy.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># scipy.stats.mode, used in SimpleImputer, doesn't return the first most</span>
    <span class="comment"># frequent as promised in the doc but the lowest most frequent. When this</span>
    <span class="comment"># test will fail after an update of scipy, SimpleImputer will need to be</span>
    <span class="comment"># updated to be consistent with the new (correct) behaviour</span>
    <span class="identifier">_check_statistics</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="punctuation">,</span> <span class="string-literal">"most_frequent"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"marker", [None, np.nan, "NAN", ""</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_most_frequent_objects</span><span class="grouping">(</span><span class="identifier">marker</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test imputation using the most-frequent strategy.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="identifier">marker</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="punctuation">,</span> <span class="string-literal">"a", "f"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">marker</span><span class="punctuation">,</span> <span class="string-literal">"c", marker, "d"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">marker</span><span class="punctuation">,</span> <span class="string-literal">"b", "d"</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">marker</span><span class="punctuation">,</span> <span class="string-literal">"c", "d", "h"</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>

    <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="string-literal">"c", "a", "f"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"c", "d", "d"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"b", "d", "d"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"c", "d", "h"</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">marker</span><span class="punctuation">,</span>
                            <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"most_frequent"</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dtype", [object, "category"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_most_frequent_pandas</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test imputation using the most frequent strategy on pandas df</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">"pandas"</span><span class="grouping">)</span>

    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">io</span><span class="punctuation">.</span><span class="identifier">StringIO</span><span class="grouping">(</span><span class="string-literal">"Cat1,Cat2,Cat3,Cat4\n"</span>
                    <span class="string-literal">",i,x,\n"</span>
                    <span class="string-literal">"a,,y,\n"</span>
                    <span class="string-literal">"a,j,,\n"</span>
                    <span class="string-literal">"b,j,x,"</span><span class="grouping">)</span>

    <span class="identifier">df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">read_csv</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="string-literal">"a", "i", "x"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"a", "j", "y"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"a", "j", "x"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"b", "j", "x"</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"most_frequent"</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">df</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"X_data, missing_value"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_constant_error_invalid_type</span><span class="grouping">(</span><span class="identifier">X_data</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Verify that exceptions are raised on invalid fill_value type</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">float</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">missing_value</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"imputing numerical"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="punctuation">,</span>
                                <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span>
                                <span class="identifier">fill_value</span><span class="arithmetic-assignment">=</span><span class="string-literal">"x"</span><span class="grouping">)</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_imputation_constant_integer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test imputation using the constant strategy on integers</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span>
                            <span class="identifier">fill_value</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"array_constructor"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_constant_float</span><span class="grouping">(</span><span class="identifier">array_constructor</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test imputation using the constant strategy on floats</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="float-literal">1.1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">1.2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="float-literal">1.3</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">1.1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">1.2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">1.3</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">array_constructor</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">array_constructor</span><span class="grouping">(</span><span class="identifier">X_true</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span> <span class="identifier">fill_value</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"marker", [None, np.nan, "NAN", ""</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_constant_object</span><span class="grouping">(</span><span class="identifier">marker</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test imputation using the constant strategy on objects</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="identifier">marker</span><span class="punctuation">,</span> <span class="string-literal">"a", "b"</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"c", marker, "d"</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"e", "f"</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"g", "h", "i"</span><span class="punctuation">,</span> <span class="identifier">marker</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>

    <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="string-literal">"missing", "a", "b", "missing"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"c", "missing", "d", "missing"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"e", "f", "missing", "missing"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"g", "h", "i", "missing"</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">marker</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span>
                            <span class="identifier">fill_value</span><span class="arithmetic-assignment">=</span><span class="string-literal">"missing"</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dtype", [object, "category"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_constant_pandas</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test imputation using the constant strategy on pandas df</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">"pandas"</span><span class="grouping">)</span>

    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">io</span><span class="punctuation">.</span><span class="identifier">StringIO</span><span class="grouping">(</span><span class="string-literal">"Cat1,Cat2,Cat3,Cat4\n"</span>
                    <span class="string-literal">",i,x,\n"</span>
                    <span class="string-literal">"a,,y,\n"</span>
                    <span class="string-literal">"a,j,,\n"</span>
                    <span class="string-literal">"b,j,x,"</span><span class="grouping">)</span>

    <span class="identifier">df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">read_csv</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="string-literal">"missing_value", "i", "x", "missing_value"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"a", "missing_value", "y", "missing_value"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"a", "j", "missing_value", "missing_value"</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"b", "j", "x", "missing_value"</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">df</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"X"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_one_feature</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check we exit early when there is a single feature</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>


<span class="keyword">def</span> <span class="identifier">test_imputation_pipeline_grid_search</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test imputation within a pipeline + gridsearch.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_random_matrix</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.10</span><span class="grouping">)</span>
    <span class="identifier">missing_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'imputer'</span><span class="punctuation">,</span>
                          <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_values</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="string-literal">'tree'</span><span class="punctuation">,</span>
                          <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">parameters</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'imputer__strategy'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="string-literal">"mean", "median", "most_frequent"</span><span class="grouping">]</span>
    <span class="grouping">}</span>

    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_random_matrix</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="identifier">parameters</span><span class="grouping">)</span>
    <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_imputation_copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test imputation with copy</span>
    <span class="identifier">X_orig</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_random_matrix</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.75</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># copy=True, dense =&gt; copy</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_orig</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"mean"</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Xt</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">X</span> <span class="relational-operator">==</span> <span class="identifier">Xt</span><span class="grouping">)</span>

    <span class="comment"># copy=True, sparse csr =&gt; copy</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_orig</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"mean"</span><span class="punctuation">,</span>
                            <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="relational-operator">==</span> <span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="comment"># copy=False, dense =&gt; no copy</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_orig</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"mean"</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Xt</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Xt</span><span class="grouping">)</span>

    <span class="comment"># copy=False, sparse csc =&gt; no copy</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_orig</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tocsc</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"mean"</span><span class="punctuation">,</span>
                            <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="comment"># copy=False, sparse csr =&gt; copy</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_orig</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"mean"</span><span class="punctuation">,</span>
                            <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="relational-operator">==</span> <span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="comment"># Note: If X is sparse and if missing_values=0, then a (dense) copy of X is</span>
    <span class="comment"># made, even if copy=False.</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_zero_iters</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_random_matrix</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">missing_flag</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">missing_flag</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_imputed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># with max_iter=0, only initial imputation is performed</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_imputed</span><span class="punctuation">,</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">initial_imputer_</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># repeat but force n_iter_ to 0</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># transformed should not be equal to initial imputation</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span>
                      <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">initial_imputer_</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="comment"># now they should be equal as only initial imputation is done</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">initial_imputer_</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_verbose</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_random_matrix</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_all_missing</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_imputed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_imputed</span><span class="punctuation">,</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">initial_imputer_</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"imputation_order"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="string-literal">'random', 'roman', 'ascending', 'descending', 'arabic'</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_imputation_order</span><span class="grouping">(</span><span class="identifier">imputation_order</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_random_matrix</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>  <span class="comment"># this column should not be discarded by IterativeImputer</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span>
                               <span class="identifier">n_nearest_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                               <span class="identifier">sample_posterior</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">skip_complete</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                               <span class="identifier">min_value</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">max_value</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">imputation_order</span><span class="arithmetic-assignment">=</span><span class="identifier">imputation_order</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">ordered_idx</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">.</span><span class="identifier">feat_idx</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">imputation_sequence_</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">ordered_idx</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span>
            <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">n_features_with_missing_</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">imputation_order</span> <span class="relational-operator">==</span> <span class="string-literal">'roman'</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">ordered_idx</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">d</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">imputation_order</span> <span class="relational-operator">==</span> <span class="string-literal">'arabic'</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">ordered_idx</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">d</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">d</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">imputation_order</span> <span class="relational-operator">==</span> <span class="string-literal">'random'</span><span class="punctuation">:</span>
        <span class="identifier">ordered_idx_round_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ordered_idx</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">d</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">ordered_idx_round_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ordered_idx</span><span class="grouping">[</span><span class="identifier">d</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">ordered_idx_round_1</span> <span class="relational-operator">!=</span> <span class="identifier">ordered_idx_round_2</span>
    <span class="keyword">elif</span> <span class="string-literal">'ending'</span> <span class="relational-operator">in</span> <span class="identifier">imputation_order</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">ordered_idx</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">max_iter</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">d</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"estimator"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">DummyRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ARDRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_estimators</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_random_matrix</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">estimator</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># check that types are correct for estimators</span>
    <span class="identifier">hashes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">triplet</span> <span class="relational-operator">in</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">imputation_sequence_</span><span class="punctuation">:</span>
        <span class="identifier">expected_type</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">type</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">estimator</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span>
                         <span class="keyword">else</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">triplet</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">expected_type</span><span class="grouping">)</span>
        <span class="identifier">hashes</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">id</span><span class="grouping">(</span><span class="identifier">triplet</span><span class="punctuation">.</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># check that each estimator is unique</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">hashes</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">hashes</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_clip</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_random_matrix</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.10</span><span class="punctuation">,</span>
                             <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">min_value</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span>
                               <span class="identifier">max_value</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_clip_truncnorm</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_random_matrix</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                               <span class="identifier">n_nearest_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                               <span class="identifier">sample_posterior</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                               <span class="identifier">min_value</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span>
                               <span class="identifier">max_value</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="punctuation">,</span>
                               <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">imputation_order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'random'</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_truncated_normal_posterior</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">#  test that the values that are imputed using `sample_posterior=True`</span>
    <span class="comment">#  with boundaries (`min_value` and `max_value` are not None) are drawn</span>
    <span class="comment">#  from a distribution that looks gaussian via the Kolmogorov Smirnov test.</span>
    <span class="comment">#  note that starting from the wrong random seed will make this test fail</span>
    <span class="comment">#  because random sampling doesn't occur at all when the imputation</span>
    <span class="comment">#  is outside of the (min_value, max_value) range</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">min_value</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">max_value</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                               <span class="identifier">sample_posterior</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># generate multiple imputations for the single missing value</span>
    <span class="identifier">imputations</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">imputations</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">imputations</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">0.5</span><span class="grouping">)</span>

    <span class="identifier">mu</span><span class="punctuation">,</span> <span class="identifier">sigma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputations</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">imputations</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">ks_statistic</span><span class="punctuation">,</span> <span class="identifier">p_value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kstest</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">imputations</span> <span class="arithmetic-operator">-</span> <span class="identifier">mu</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">sigma</span><span class="punctuation">,</span> <span class="string-literal">'norm'</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">sigma</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">sigma</span> <span class="arithmetic-assignment">+=</span> <span class="float-literal">1e-12</span>
    <span class="identifier">ks_statistic</span><span class="punctuation">,</span> <span class="identifier">p_value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kstest</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">imputations</span> <span class="arithmetic-operator">-</span> <span class="identifier">mu</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">sigma</span><span class="punctuation">,</span> <span class="string-literal">'norm'</span><span class="grouping">)</span>
    <span class="comment"># we want to fail to reject null hypothesis</span>
    <span class="comment"># null hypothesis: distributions are the same</span>
    <span class="keyword">assert</span> <span class="identifier">ks_statistic</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.2</span> <span class="logical-operator">or</span> <span class="identifier">p_value</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="invalid">\</span>
        <span class="string-literal">"The posterior does appear to be normal"</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"strategy"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="string-literal">"mean", "median", "most_frequent"</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_missing_at_transform</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">X_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>  <span class="comment"># definitely no missing values in 0th column</span>
    <span class="identifier">X_test</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>  <span class="comment"># definitely missing value in 0th column</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">initial_strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="identifier">initial_imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                    <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>

    <span class="comment"># if there were no missing values at time of fit, then imputer will</span>
    <span class="comment"># only use the initial imputer for that feature at transform</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">initial_imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_transform_stochasticity</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rng2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_random_matrix</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.10</span><span class="punctuation">,</span>
                             <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># when sample_posterior=True, two transforms shouldn't be equal</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">sample_posterior</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng1</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">X_fitted_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_fitted_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># sufficient to assert that the means are not the same</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">X_fitted_1</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">X_fitted_2</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># when sample_posterior=False, and n_nearest_features=None</span>
    <span class="comment"># and imputation_order is not random</span>
    <span class="comment"># the two transforms should be identical even if rng are different</span>
    <span class="identifier">imputer1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                <span class="identifier">sample_posterior</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                <span class="identifier">n_nearest_features</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                <span class="identifier">imputation_order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ascending'</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng1</span><span class="grouping">)</span>

    <span class="identifier">imputer2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                <span class="identifier">sample_posterior</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                <span class="identifier">n_nearest_features</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                <span class="identifier">imputation_order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ascending'</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng2</span><span class="grouping">)</span>
    <span class="identifier">imputer1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">imputer2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">X_fitted_1a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer1</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_fitted_1b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer1</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_fitted_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer2</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_fitted_1a</span><span class="punctuation">,</span> <span class="identifier">X_fitted_1b</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_fitted_1a</span><span class="punctuation">,</span> <span class="identifier">X_fitted_2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_no_missing</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">m1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">m2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m2</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># should exclude the first column entirely</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pred1</span><span class="grouping">)</span>
    <span class="comment"># fit and fit_transform should both be identical</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pred1</span><span class="punctuation">,</span> <span class="identifier">pred2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_rank_one</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">B</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="grouping">)</span>
    <span class="identifier">nan_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.5</span>
    <span class="identifier">X_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_missing</span><span class="grouping">[</span><span class="identifier">nan_mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                               <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">X_filled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_missing</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_filled</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.02</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"rank"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_transform_recovery</span><span class="grouping">(</span><span class="identifier">rank</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">70</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">70</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">rank</span><span class="grouping">)</span>
    <span class="identifier">B</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">rank</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span>
    <span class="identifier">X_filled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="grouping">)</span>
    <span class="identifier">nan_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.5</span>
    <span class="identifier">X_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_filled</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_missing</span><span class="grouping">[</span><span class="identifier">nan_mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="comment"># split up data in half</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_missing</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n</span><span class="grouping">]</span>
    <span class="identifier">X_test_filled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_filled</span><span class="grouping">[</span><span class="identifier">n</span><span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_missing</span><span class="grouping">[</span><span class="identifier">n</span><span class="punctuation">:</span><span class="grouping">]</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                               <span class="identifier">imputation_order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'descending'</span><span class="punctuation">,</span>
                               <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="identifier">X_test_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_test_filled</span><span class="punctuation">,</span> <span class="identifier">X_test_est</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_additive_matrix</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span>
    <span class="identifier">B</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span>
    <span class="identifier">X_filled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X_filled</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">i</span><span class="arithmetic-operator">+</span><span class="identifier">j</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="identifier">d</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">(</span><span class="identifier">A</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">B</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span>
    <span class="comment"># a quarter is randomly missing</span>
    <span class="identifier">nan_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.25</span>
    <span class="identifier">X_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_filled</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_missing</span><span class="grouping">[</span><span class="identifier">nan_mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="comment"># split up data</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_missing</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n</span><span class="grouping">]</span>
    <span class="identifier">X_test_filled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_filled</span><span class="grouping">[</span><span class="identifier">n</span><span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_missing</span><span class="grouping">[</span><span class="identifier">n</span><span class="punctuation">:</span><span class="grouping">]</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                               <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="identifier">X_test_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_test_filled</span><span class="punctuation">,</span> <span class="identifier">X_test_est</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"max_iter, tol, error_type, warning"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="string-literal">'should be a positive integer'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="string-literal">'should be a non-negative float'</span><span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_error_param</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">error_type</span><span class="punctuation">,</span> <span class="identifier">warning</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">error_type</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_early_stopping</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">B</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="grouping">)</span>
    <span class="identifier">nan_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.5</span>
    <span class="identifier">X_missing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_missing</span><span class="grouping">[</span><span class="identifier">nan_mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span>
                               <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="punctuation">,</span>
                               <span class="identifier">sample_posterior</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">X_filled_100</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_missing</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">imputation_sequence_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">d</span> <span class="arithmetic-operator">*</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">n_iter_</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">n_iter_</span><span class="punctuation">,</span>
                               <span class="identifier">sample_posterior</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">X_filled_early</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_missing</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_filled_100</span><span class="punctuation">,</span> <span class="identifier">X_filled_early</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span>
                               <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">sample_posterior</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_missing</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">max_iter</span>


<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_catch_warning</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that we catch a RuntimeWarning due to a division by zero when a</span>
    <span class="comment"># feature is constant in the dataset</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_diabetes</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>

    <span class="comment"># simulate that a feature only contain one category during fit</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="comment"># add some missing values</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">missing_rate</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.15</span>
    <span class="keyword">for</span> <span class="identifier">feat</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">sample_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">choice</span><span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="identifier">missing_rate</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">replace</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span>
        <span class="grouping">)</span>
        <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">sample_idx</span><span class="punctuation">,</span> <span class="identifier">feat</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">n_nearest_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">sample_posterior</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="identifier">X_fill</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">record</span><span class="punctuation">.</span><span class="identifier">list</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">X_fill</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"min_value, max_value, correct_output"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">100</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">200</span><span class="punctuation">,</span> <span class="int-literal">300</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">200</span><span class="punctuation">,</span> <span class="int-literal">300</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span><span class="punctuation">,</span>
      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"scalars", "None-default", "inf", "lists", "lists-with-inf"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_min_max_array_like</span><span class="grouping">(</span><span class="identifier">min_value</span><span class="punctuation">,</span>
                                              <span class="identifier">max_value</span><span class="punctuation">,</span>
                                              <span class="identifier">correct_output</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that passing scalar or array-like</span>
    <span class="comment"># for min_value and max_value in IterativeImputer works</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">min_value</span><span class="arithmetic-assignment">=</span><span class="identifier">min_value</span><span class="punctuation">,</span> <span class="identifier">max_value</span><span class="arithmetic-assignment">=</span><span class="identifier">max_value</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">_min_value</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span> <span class="logical-operator">and</span>
            <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">_max_value</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">_min_value</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="logical-operator">and</span>
            <span class="grouping">(</span><span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">_max_value</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">correct_output</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">_min_value</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">correct_output</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">_max_value</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"min_value, max_value, err_msg"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="string-literal">"min_value &gt;= max_value."</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="string-literal">"min_value &gt;= max_value."</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">200</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">"_value' should be of shape"</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_catch_min_max_error</span><span class="grouping">(</span><span class="identifier">min_value</span><span class="punctuation">,</span> <span class="identifier">max_value</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that passing scalar or array-like</span>
    <span class="comment"># for min_value and max_value in IterativeImputer works</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">random</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">min_value</span><span class="arithmetic-assignment">=</span><span class="identifier">min_value</span><span class="punctuation">,</span> <span class="identifier">max_value</span><span class="arithmetic-assignment">=</span><span class="identifier">max_value</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"min_max_1, min_max_2"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"None-vs-inf", "Scalar-vs-vector"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_min_max_array_like_imputation</span><span class="grouping">(</span><span class="identifier">min_max_1</span><span class="punctuation">,</span> <span class="identifier">min_max_2</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that None/inf and scalar/vector give the same imputation</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">imputer1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">min_value</span><span class="arithmetic-assignment">=</span><span class="identifier">min_max_1</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">max_value</span><span class="arithmetic-assignment">=</span><span class="identifier">min_max_1</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">imputer2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">min_value</span><span class="arithmetic-assignment">=</span><span class="identifier">min_max_2</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">max_value</span><span class="arithmetic-assignment">=</span><span class="identifier">min_max_2</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_test_imputed1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">X_test_imputed2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_test_imputed1</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X_test_imputed2</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"skip_complete"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_skip_non_missing</span><span class="grouping">(</span><span class="identifier">skip_complete</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check the imputing strategy when missing data are present in the</span>
    <span class="comment"># testing set only.</span>
    <span class="comment"># taken from: https://github.com/scikit-learn/scikit-learn/issues/14383</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span>
        <span class="identifier">initial_strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'mean'</span><span class="punctuation">,</span> <span class="identifier">skip_complete</span><span class="arithmetic-assignment">=</span><span class="identifier">skip_complete</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span>
    <span class="grouping">)</span>
    <span class="identifier">X_test_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">skip_complete</span><span class="punctuation">:</span>
        <span class="comment"># impute with the initial strategy: 'mean'</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_test_est</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_test_est</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"rs_imputer"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"rs_estimator"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iterative_imputer_dont_set_random_state</span><span class="grouping">(</span><span class="identifier">rs_imputer</span><span class="punctuation">,</span> <span class="identifier">rs_estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">class</span> <span class="identifier">ZeroEstimator</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span>

        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kgards</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">self</span>

        <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ZeroEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rs_estimator</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rs_imputer</span><span class="grouping">)</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="relational-operator">==</span> <span class="identifier">rs_estimator</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"X_fit, X_trans, params, msg_err"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': 'missing-only', 'sparse': 'auto'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">'have missing values in transform but have no missing values in fit'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': 'random', 'sparse': 'auto'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">"'features' has to be either 'missing-only' or 'all'"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="string-literal">'features': 'all', 'sparse': 'random'</span><span class="grouping">}</span><span class="punctuation">,</span>
      <span class="string-literal">"'sparse' has to be a boolean or 'auto'"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">'a', 'b'], ['c', 'a'</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">str</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">'a', 'b'], ['c', 'a'</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">str</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="grouping">{</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="string-literal">"MissingIndicator does not support data with dtype"</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_missing_indicator_error</span><span class="grouping">(</span><span class="identifier">X_fit</span><span class="punctuation">,</span> <span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">msg_err</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">indicator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MissingIndicator</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg_err</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_fit</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"missing_values, dtype, arr_type"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span>      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="punctuation">,</span>   <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span>     <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="punctuation">,</span>   <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span>     <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="punctuation">,</span>   <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span>     <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="punctuation">,</span>   <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span>     <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="punctuation">,</span>   <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">lil_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span>     <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="punctuation">,</span>   <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">lil_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">bsr_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span>     <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="punctuation">,</span>   <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">bsr_matrix</span><span class="grouping">)</span>
     <span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"param_features, n_features, features_indices"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'missing-only'</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">'all'</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_missing_indicator_new</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="identifier">arr_type</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">param_features</span><span class="punctuation">,</span>
                               <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">features_indices</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_fit_expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_trans_expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># convert the input to the right array format and right dtype</span>
    <span class="identifier">X_fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr_type</span><span class="grouping">(</span><span class="identifier">X_fit</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr_type</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">X_fit_expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_fit_expected</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">X_trans_expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_trans_expected</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="identifier">indicator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MissingIndicator</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_values</span><span class="punctuation">,</span>
                                 <span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="identifier">param_features</span><span class="punctuation">,</span>
                                 <span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">X_fit_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_fit</span><span class="grouping">)</span>
    <span class="identifier">X_trans_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">X_fit_mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_features</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans_mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_features</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">features_</span><span class="punctuation">,</span> <span class="identifier">features_indices</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_fit_mask</span><span class="punctuation">,</span> <span class="identifier">X_fit_expected</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">features_indices</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_trans_mask</span><span class="punctuation">,</span> <span class="identifier">X_trans_expected</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">features_indices</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">X_fit_mask</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">bool</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans_mask</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">bool</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_fit_mask</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_trans_mask</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>

    <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">X_fit_mask_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_fit</span><span class="grouping">)</span>
    <span class="identifier">X_trans_mask_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">X_fit_mask_sparse</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">bool</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans_mask_sparse</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">bool</span>
    <span class="keyword">assert</span> <span class="identifier">X_fit_mask_sparse</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="string-literal">'csc'</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans_mask_sparse</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="string-literal">'csc'</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_fit_mask_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_fit_mask</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_trans_mask_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_trans_mask</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"arr_type"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="punctuation">,</span>
     <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">lil_matrix</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">bsr_matrix</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_missing_indicator_raise_on_sparse_with_missing_0</span><span class="grouping">(</span><span class="identifier">arr_type</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test for sparse input and missing_value == 0</span>

    <span class="identifier">missing_values</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">X_fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># convert the input to the right array format</span>
    <span class="identifier">X_fit_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr_type</span><span class="grouping">(</span><span class="identifier">X_fit</span><span class="grouping">)</span>
    <span class="identifier">X_trans_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr_type</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span>

    <span class="identifier">indicator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MissingIndicator</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_values</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Sparse input with missing_values=0"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_fit_sparse</span><span class="grouping">)</span>

    <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_fit</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Sparse input with missing_values=0"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_trans_sparse</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"param_sparse"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="string-literal">'auto'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"missing_values, arr_type"</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span>      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">lil_matrix</span><span class="grouping">)</span>
                          <span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_missing_indicator_sparse_param</span><span class="grouping">(</span><span class="identifier">arr_type</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="punctuation">,</span>
                                        <span class="identifier">param_sparse</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check the format of the output with different sparse parameter</span>
    <span class="identifier">X_fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr_type</span><span class="grouping">(</span><span class="identifier">X_fit</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr_type</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>

    <span class="identifier">indicator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MissingIndicator</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_values</span><span class="punctuation">,</span>
                                 <span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="identifier">param_sparse</span><span class="grouping">)</span>
    <span class="identifier">X_fit_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_fit</span><span class="grouping">)</span>
    <span class="identifier">X_trans_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">param_sparse</span> <span class="relational-operator">is</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">X_fit_mask</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="string-literal">'csc'</span>
        <span class="keyword">assert</span> <span class="identifier">X_trans_mask</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="string-literal">'csc'</span>
    <span class="keyword">elif</span> <span class="identifier">param_sparse</span> <span class="relational-operator">==</span> <span class="string-literal">'auto'</span> <span class="logical-operator">and</span> <span class="identifier">missing_values</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_fit_mask</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_trans_mask</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">param_sparse</span> <span class="relational-operator">is</span> <span class="bool-literal">False</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_fit_mask</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_trans_mask</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X_fit</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">X_fit_mask</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="string-literal">'csc'</span>
            <span class="keyword">assert</span> <span class="identifier">X_trans_mask</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="string-literal">'csc'</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_fit_mask</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_trans_mask</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_missing_indicator_string</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">'a', 'b', 'c'], ['b', 'c', 'a'</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>
    <span class="identifier">indicator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MissingIndicator</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="string-literal">'a', features='all'</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">,</span>
                                          <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"X, missing_values, X_trans_exp"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">'a', 'b'], ['b', 'a']], dtype=object), 'a'</span><span class="punctuation">,</span>
      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">'b', 'b', True, False], ['b', 'b'</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span>
      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="string-literal">'b'], ['b'</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span>
      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">'b', 'b', True, False], ['b', 'b'</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'b'], ['b'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span>
      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">'b', 'b', True, False], ['b', 'b'</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_missing_indicator_with_imputer</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="identifier">X_trans_exp</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_union</span><span class="grouping">(</span>
        <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_values</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'most_frequent'</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">MissingIndicator</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_values</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">trans</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_trans_exp</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"imputer_constructor"</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="identifier">SimpleImputer</span><span class="punctuation">,</span> <span class="identifier">IterativeImputer</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"imputer_missing_values, missing_value, err_msg"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"NaN", np.nan, "Input contains NaN"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">"-1", -1, "types are expected to be both numerical."</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_inconsistent_dtype_X_missing_values</span><span class="grouping">(</span><span class="identifier">imputer_constructor</span><span class="punctuation">,</span>
                                             <span class="identifier">imputer_missing_values</span><span class="punctuation">,</span>
                                             <span class="identifier">missing_value</span><span class="punctuation">,</span>
                                             <span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># regression test for issue #11390. Comparison between incoherent dtype</span>
    <span class="comment"># for X and missing_values was not raising a proper error.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">missing_value</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer_constructor</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">imputer_missing_values</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_missing_indicator_no_missing</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that all features are dropped if there are no missing values when</span>
    <span class="comment"># features='missing-only' (#13491)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">mi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MissingIndicator</span><span class="grouping">(</span><span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="string-literal">'missing-only'</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mi</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>


<span class="keyword">def</span> <span class="identifier">test_missing_indicator_sparse_no_explicit_zeros</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that non missing values don't become explicit zeros in the mask</span>
    <span class="comment"># generated by missing indicator when X is sparse. (#13491)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">mi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MissingIndicator</span><span class="grouping">(</span><span class="identifier">features</span><span class="arithmetic-assignment">=</span><span class="string-literal">'all'</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mi</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">getnnz</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"imputer_constructor"</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="identifier">SimpleImputer</span><span class="punctuation">,</span> <span class="identifier">IterativeImputer</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputer_without_indicator</span><span class="grouping">(</span><span class="identifier">imputer_constructor</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer_constructor</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">indicator_</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"arr_type"</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="punctuation">,</span>
        <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">lil_matrix</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">bsr_matrix</span>
    <span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_simple_imputation_add_indicator_sparse_matrix</span><span class="grouping">(</span><span class="identifier">arr_type</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr_type</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">add_indicator</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">X_true</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'strategy, expected'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'most_frequent', 'b'), ('constant', 'missing_value'</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_simple_imputation_string_list</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="punctuation">,</span> <span class="identifier">expected</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">'a', 'b'</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="string-literal">'c'</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">X_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="string-literal">'a', 'b'</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">'c'</span><span class="punctuation">,</span> <span class="identifier">expected</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_true</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"order, idx_order"</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">"ascending"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">"descending"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_imputation_order</span><span class="grouping">(</span><span class="identifier">order</span><span class="punctuation">,</span> <span class="identifier">idx_order</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># regression test for #15393</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">trs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IterativeImputer</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">imputation_order</span><span class="arithmetic-assignment">=</span><span class="identifier">order</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">idx</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">feat_idx</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">trs</span><span class="punctuation">.</span><span class="identifier">imputation_sequence_</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">idx</span> <span class="relational-operator">==</span> <span class="identifier">idx_order</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"missing_value"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_simple_imputation_inverse_transform</span><span class="grouping">(</span><span class="identifier">missing_value</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test inverse_transform feature for np.nan</span>
    <span class="identifier">X_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X_4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'mean'</span><span class="punctuation">,</span>
                            <span class="identifier">add_indicator</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">X_1_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_1</span><span class="grouping">)</span>
    <span class="identifier">X_1_inv_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">X_1_trans</span><span class="grouping">)</span>

    <span class="identifier">X_2_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_2</span><span class="grouping">)</span>  <span class="comment"># test on new data</span>
    <span class="identifier">X_2_inv_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">X_2_trans</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_1_inv_trans</span><span class="punctuation">,</span> <span class="identifier">X_1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_2_inv_trans</span><span class="punctuation">,</span> <span class="identifier">X_2</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">X</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">X_3</span><span class="punctuation">,</span> <span class="identifier">X_4</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">X_inv_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_inv_trans</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"missing_value"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_simple_imputation_inverse_transform_exceptions</span><span class="grouping">(</span><span class="identifier">missing_value</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">imputer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"mean"</span><span class="grouping">)</span>
    <span class="identifier">X_1_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_1</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"Got 'add_indicator={imputer.add_indicator}'"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">imputer</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">X_1_trans</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"expected,array,dtype,extra_value,n_repeat"</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="comment"># array of object dtype</span>
        <span class="grouping">(</span><span class="string-literal">"extra_value", ['a', 'b', 'c'], object, "extra_value"</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="string-literal">"most_frequent_value"</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="string-literal">'most_frequent_value', 'most_frequent_value', 'value'</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="identifier">object</span><span class="punctuation">,</span> <span class="string-literal">"extra_value"</span><span class="punctuation">,</span> <span class="int-literal">1</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">"a", ['min_value', 'min_value' 'value'], object, "a"</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">"min_value", ['min_value', 'min_value', 'value'], object, "z"</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="comment"># array of numeric dtype</span>
        <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_most_frequent</span><span class="grouping">(</span><span class="identifier">expected</span><span class="punctuation">,</span> <span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">extra_value</span><span class="punctuation">,</span> <span class="identifier">n_repeat</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">assert</span> <span class="identifier">expected</span> <span class="relational-operator">==</span> <span class="identifier">_most_frequent</span><span class="grouping">(</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">extra_value</span><span class="punctuation">,</span> <span class="identifier">n_repeat</span>
    <span class="grouping">)</span>

    </pre>
  </body>
</html>