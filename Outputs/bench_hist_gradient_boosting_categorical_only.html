<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">argparse</span>
<span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">time</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">KBinsDiscretizer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">HistGradientBoostingClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">get_equivalent_estimator</span><span class="grouping">)</span>


<span class="identifier">parser</span> <span class="arithmetic-assignment">=</span> <span class="identifier">argparse</span><span class="punctuation">.</span><span class="identifier">ArgumentParser</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--n-leaf-nodes'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">31</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--n-trees'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--n-features'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--n-cats'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--n-samples'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="invalid">_</span><span class="int-literal">000</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--lightgbm'</span><span class="punctuation">,</span> <span class="identifier">action</span><span class="arithmetic-assignment">=</span><span class="string-literal">"store_true"</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--learning-rate'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">float</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="float-literal">.1</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--max-bins'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">255</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--no-predict'</span><span class="punctuation">,</span> <span class="identifier">action</span><span class="arithmetic-assignment">=</span><span class="string-literal">"store_true"</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--verbose'</span><span class="punctuation">,</span> <span class="identifier">action</span><span class="arithmetic-assignment">=</span><span class="string-literal">"store_true"</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
<span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">parse_args</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="identifier">n_leaf_nodes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_leaf_nodes</span>
<span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_features</span>
<span class="identifier">n_categories</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_cats</span>
<span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_samples</span>
<span class="identifier">n_trees</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_trees</span>
<span class="identifier">lr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">learning_rate</span>
<span class="identifier">max_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">max_bins</span>
<span class="identifier">verbose</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">verbose</span>


<span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">data_train</span><span class="punctuation">,</span> <span class="identifier">target_train</span><span class="punctuation">,</span> <span class="identifier">libname</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">fit_params</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"Fitting a {libname} model..."</span><span class="grouping">)</span>
    <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">data_train</span><span class="punctuation">,</span> <span class="identifier">target_train</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">fit_params</span><span class="grouping">)</span>
    <span class="identifier">toc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"fitted in {toc - tic:.3f}s"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">data_test</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># We don't report accuracy or ROC because the dataset doesn't really make</span>
    <span class="comment"># sense: we treat ordered features as un-ordered categories.</span>
    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">no_predict</span><span class="punctuation">:</span>
        <span class="keyword">return</span>
    <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">data_test</span><span class="grouping">)</span>
    <span class="identifier">toc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"predicted in {toc - tic:.3f}s"</span><span class="grouping">)</span>


<span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KBinsDiscretizer</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_categories</span><span class="punctuation">,</span> <span class="identifier">encode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ordinal'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"Number of features: {n_features}"</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"Number of samples: {n_samples}"</span><span class="grouping">)</span>

<span class="identifier">is_categorical</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_features</span>
<span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span>
    <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'binary_crossentropy'</span><span class="punctuation">,</span>
    <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="punctuation">,</span>
    <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">n_trees</span><span class="punctuation">,</span>
    <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">max_bins</span><span class="punctuation">,</span>
    <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_leaf_nodes</span><span class="punctuation">,</span>
    <span class="identifier">categorical_features</span><span class="arithmetic-assignment">=</span><span class="identifier">is_categorical</span><span class="punctuation">,</span>
    <span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
    <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span>
<span class="grouping">)</span>

<span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="string-literal">'sklearn'</span><span class="grouping">)</span>
<span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>

<span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">lightgbm</span><span class="punctuation">:</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_equivalent_estimator</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">lib</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lightgbm'</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_cat_to_onehot</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>  <span class="comment"># dont use OHE</span>
    <span class="identifier">categorical_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="string-literal">'lightgbm'</span><span class="punctuation">,</span>
        <span class="identifier">categorical_feature</span><span class="arithmetic-assignment">=</span><span class="identifier">categorical_features</span><span class="grouping">)</span>
    <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>

    </pre>
  </body>
</html>