<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">sparse</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csgraph</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">linalg</span> <span class="keyword">import</span> <span class="identifier">eigh</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">manifold</span> <span class="keyword">import</span> <span class="identifier">SpectralEmbedding</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">manifold</span><span class="punctuation">.</span><span class="identifier">_spectral_embedding</span> <span class="keyword">import</span> <span class="identifier">_graph_is_connected</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">manifold</span><span class="punctuation">.</span><span class="identifier">_spectral_embedding</span> <span class="keyword">import</span> <span class="identifier">_graph_connected_component</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">manifold</span> <span class="keyword">import</span> <span class="identifier">spectral_embedding</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">rbf_kernel</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">normalized_mutual_info_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">NearestNeighbors</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">KMeans</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_blobs</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">extmath</span> <span class="keyword">import</span> <span class="identifier">_deterministic_vector_sign_flip</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>


<span class="comment"># non centered, sparse centers to check the</span>
<span class="identifier">centers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
    <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">5.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">5.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
<span class="identifier">n_clusters</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">centers</span><span class="punctuation">.</span><span class="identifier">shape</span>
<span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">true_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="identifier">centers</span><span class="punctuation">,</span>
                            <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_assert_equal_with_sign_flipping</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Check array A and B are equal with possible sign flipping on
    each columns"""</span>
    <span class="identifier">tol_squared</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tol</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span>
    <span class="keyword">for</span> <span class="identifier">A_col</span><span class="punctuation">,</span> <span class="identifier">B_col</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">A_col</span> <span class="arithmetic-operator">-</span> <span class="identifier">B_col</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="identifier">tol_squared</span> <span class="logical-operator">or</span>
                <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">A_col</span> <span class="arithmetic-operator">+</span> <span class="identifier">B_col</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="identifier">tol_squared</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sparse_graph_connected_component</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">300</span>
    <span class="identifier">boundaries</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">121</span><span class="punctuation">,</span> <span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">]</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">connections</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">start</span><span class="punctuation">,</span> <span class="identifier">stop</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">boundaries</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">boundaries</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">group</span> <span class="arithmetic-assignment">=</span> <span class="identifier">p</span><span class="grouping">[</span><span class="identifier">start</span><span class="punctuation">:</span><span class="identifier">stop</span><span class="grouping">]</span>
        <span class="comment"># Connect all elements within the group at least once via an</span>
        <span class="comment"># arbitrary path that spans the group.</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">group</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">connections</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">group</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">group</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Add some more random connections within the group</span>
        <span class="identifier">min_idx</span><span class="punctuation">,</span> <span class="identifier">max_idx</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">group</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
        <span class="identifier">n_random_connections</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
        <span class="identifier">source</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">min_idx</span><span class="punctuation">,</span> <span class="identifier">max_idx</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_random_connections</span><span class="grouping">)</span>
        <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">min_idx</span><span class="punctuation">,</span> <span class="identifier">max_idx</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_random_connections</span><span class="grouping">)</span>
        <span class="identifier">connections</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">group</span><span class="grouping">[</span><span class="identifier">source</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">group</span><span class="grouping">[</span><span class="identifier">target</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Build a symmetric affinity matrix</span>
    <span class="identifier">row_idx</span><span class="punctuation">,</span> <span class="identifier">column_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">connections</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">connections</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">affinity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">row_idx</span><span class="punctuation">,</span> <span class="identifier">column_idx</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">affinity</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">affinity</span> <span class="arithmetic-operator">+</span> <span class="identifier">affinity</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">start</span><span class="punctuation">,</span> <span class="identifier">stop</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">boundaries</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">boundaries</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">component_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_graph_connected_component</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">[</span><span class="identifier">start</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">component_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stop</span> <span class="arithmetic-operator">-</span> <span class="identifier">start</span>
        <span class="keyword">assert</span> <span class="identifier">component_1</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">component_size</span>

        <span class="comment"># We should retrieve the same component mask by starting by both ends</span>
        <span class="comment"># of the group</span>
        <span class="identifier">component_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_graph_connected_component</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">[</span><span class="identifier">stop</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">component_2</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">component_size</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">component_1</span><span class="punctuation">,</span> <span class="identifier">component_2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_spectral_embedding_two_components</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test spectral embedding with two components</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">n_sample</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">affinity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">n_sample</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_sample</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="comment"># first component</span>
    <span class="identifier">affinity</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="identifier">n_sample</span><span class="punctuation">,</span>
             <span class="int-literal">0</span><span class="punctuation">:</span><span class="identifier">n_sample</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_sample</span><span class="punctuation">,</span> <span class="identifier">n_sample</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span>
    <span class="comment"># second component</span>
    <span class="identifier">affinity</span><span class="grouping">[</span><span class="identifier">n_sample</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="punctuation">,</span>
             <span class="identifier">n_sample</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_sample</span><span class="punctuation">,</span> <span class="identifier">n_sample</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span>

    <span class="comment"># Test of internal _graph_connected_component before connection</span>
    <span class="identifier">component</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_graph_connected_component</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">component</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_sample</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">component</span><span class="grouping">[</span><span class="identifier">n_sample</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">component</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_graph_connected_component</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">component</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_sample</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">component</span><span class="grouping">[</span><span class="identifier">n_sample</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># connection</span>
    <span class="identifier">affinity</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_sample</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">affinity</span><span class="grouping">[</span><span class="identifier">n_sample</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">affinity</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_sample</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">affinity</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">affinity</span> <span class="arithmetic-operator">+</span> <span class="identifier">affinity</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="identifier">true_label</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_sample</span><span class="grouping">)</span>
    <span class="identifier">true_label</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="identifier">n_sample</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="identifier">se_precomp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"precomputed"</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">embedded_coordinate</span> <span class="arithmetic-assignment">=</span> <span class="identifier">se_precomp</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="grouping">)</span>
    <span class="comment"># Some numpy versions are touchy with types</span>
    <span class="identifier">embedded_coordinate</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="identifier">se_precomp</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># thresholding on the first components using 0.</span>
    <span class="identifier">label_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">embedded_coordinate</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"float"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">normalized_mutual_info_score</span><span class="grouping">(</span>
        <span class="identifier">true_label</span><span class="punctuation">,</span> <span class="identifier">label_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"X"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"dense", "sparse"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spectral_embedding_precomputed_affinity</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test spectral embedding with precomputed kernel</span>
    <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>
    <span class="identifier">se_precomp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"precomputed"</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">se_rbf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"rbf"</span><span class="punctuation">,</span>
                               <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">embed_precomp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">se_precomp</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">embed_rbf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">se_rbf</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">se_precomp</span><span class="punctuation">.</span><span class="identifier">affinity_matrix_</span><span class="punctuation">,</span> <span class="identifier">se_rbf</span><span class="punctuation">.</span><span class="identifier">affinity_matrix_</span><span class="grouping">)</span>
    <span class="identifier">_assert_equal_with_sign_flipping</span><span class="grouping">(</span><span class="identifier">embed_precomp</span><span class="punctuation">,</span> <span class="identifier">embed_rbf</span><span class="punctuation">,</span> <span class="float-literal">0.05</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_precomputed_nearest_neighbors_filtering</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test precomputed graph filtering when containing too many neighbors</span>
    <span class="identifier">n_neighbors</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">additional_neighbors</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NearestNeighbors</span><span class="grouping">(</span>
            <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span> <span class="arithmetic-operator">+</span> <span class="identifier">additional_neighbors</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span>
        <span class="identifier">graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'connectivity'</span><span class="grouping">)</span>
        <span class="identifier">embedding</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                      <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed_nearest_neighbors'</span><span class="punctuation">,</span>
                                      <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span>
                                      <span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">embedding_</span>
        <span class="identifier">results</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">embedding</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">results</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"X"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"dense", "sparse"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spectral_embedding_callable_affinity</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test spectral embedding with callable affinity</span>
    <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.9</span>
    <span class="identifier">kern</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="grouping">)</span>
    <span class="identifier">se_callable</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                    <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span>
                                        <span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                    <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">se_rbf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"rbf"</span><span class="punctuation">,</span>
                               <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">embed_rbf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">se_rbf</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">embed_callable</span> <span class="arithmetic-assignment">=</span> <span class="identifier">se_callable</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">se_callable</span><span class="punctuation">.</span><span class="identifier">affinity_matrix_</span><span class="punctuation">,</span> <span class="identifier">se_rbf</span><span class="punctuation">.</span><span class="identifier">affinity_matrix_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kern</span><span class="punctuation">,</span> <span class="identifier">se_rbf</span><span class="punctuation">.</span><span class="identifier">affinity_matrix_</span><span class="grouping">)</span>
    <span class="identifier">_assert_equal_with_sign_flipping</span><span class="grouping">(</span><span class="identifier">embed_rbf</span><span class="punctuation">,</span> <span class="identifier">embed_callable</span><span class="punctuation">,</span> <span class="float-literal">0.05</span><span class="grouping">)</span>


<span class="comment"># TODO: Remove when pyamg does replaces sp.rand call with np.random.rand</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/15913</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore:scipy.rand is deprecated:DeprecationWarning:pyamg.*"</span><span class="grouping">)</span>
<span class="comment"># TODO: Remove when pyamg removes the use of np.float</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore:`np.float` is a deprecated alias:DeprecationWarning:pyamg.*"</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spectral_embedding_amg_solver</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test spectral embedding with amg solver</span>
    <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pyamg'</span><span class="grouping">)</span>

    <span class="identifier">se_amg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"nearest_neighbors"</span><span class="punctuation">,</span>
                               <span class="identifier">eigen_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"amg"</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">se_arpack</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"nearest_neighbors"</span><span class="punctuation">,</span>
                                  <span class="identifier">eigen_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"arpack"</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                  <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">embed_amg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">se_amg</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span>
    <span class="identifier">embed_arpack</span> <span class="arithmetic-assignment">=</span> <span class="identifier">se_arpack</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span>
    <span class="identifier">_assert_equal_with_sign_flipping</span><span class="grouping">(</span><span class="identifier">embed_amg</span><span class="punctuation">,</span> <span class="identifier">embed_arpack</span><span class="punctuation">,</span> <span class="float-literal">1e-5</span><span class="grouping">)</span>

    <span class="comment"># same with special case in which amg is not actually used</span>
    <span class="comment"># regression test for #10715</span>
    <span class="comment"># affinity between nodes</span>
    <span class="identifier">row</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span>
    <span class="identifier">col</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span>
    <span class="identifier">val</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">]</span>

    <span class="identifier">affinity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">val</span> <span class="arithmetic-operator">+</span> <span class="identifier">val</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">row</span> <span class="arithmetic-operator">+</span> <span class="identifier">col</span><span class="punctuation">,</span> <span class="identifier">col</span> <span class="arithmetic-operator">+</span> <span class="identifier">row</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">se_amg</span><span class="punctuation">.</span><span class="identifier">affinity</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"precomputed"</span>
    <span class="identifier">se_arpack</span><span class="punctuation">.</span><span class="identifier">affinity</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"precomputed"</span>
    <span class="identifier">embed_amg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">se_amg</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="grouping">)</span>
    <span class="identifier">embed_arpack</span> <span class="arithmetic-assignment">=</span> <span class="identifier">se_arpack</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="grouping">)</span>
    <span class="identifier">_assert_equal_with_sign_flipping</span><span class="grouping">(</span><span class="identifier">embed_amg</span><span class="punctuation">,</span> <span class="identifier">embed_arpack</span><span class="punctuation">,</span> <span class="float-literal">1e-5</span><span class="grouping">)</span>


<span class="comment"># TODO: Remove filterwarnings when pyamg does replaces sp.rand call with</span>
<span class="comment"># np.random.rand:</span>
<span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/15913</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore:scipy.rand is deprecated:DeprecationWarning:pyamg.*"</span><span class="grouping">)</span>
<span class="comment"># TODO: Remove when pyamg removes the use of np.float</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore:`np.float` is a deprecated alias:DeprecationWarning:pyamg.*"</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spectral_embedding_amg_solver_failure</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non-regression test for amg solver failure (issue #13393 on github)</span>
    <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pyamg'</span><span class="grouping">)</span>
    <span class="identifier">seed</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">36</span>
    <span class="identifier">num_nodes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">num_nodes</span><span class="punctuation">,</span> <span class="identifier">num_nodes</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">upper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">triu</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">diags</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">diagonal</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">sym_matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">upper</span> <span class="arithmetic-operator">+</span> <span class="identifier">upper</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">embedding</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spectral_embedding</span><span class="grouping">(</span><span class="identifier">sym_matrix</span><span class="punctuation">,</span>
                                   <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                   <span class="identifier">eigen_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'amg'</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Check that the learned embedding is stable w.r.t. random solver init:</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">new_embedding</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spectral_embedding</span><span class="grouping">(</span><span class="identifier">sym_matrix</span><span class="punctuation">,</span>
                                           <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                           <span class="identifier">eigen_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'amg'</span><span class="punctuation">,</span>
                                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">_assert_equal_with_sign_flipping</span><span class="grouping">(</span><span class="identifier">embedding</span><span class="punctuation">,</span> <span class="identifier">new_embedding</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore:the behavior of nmi will "</span>
                            <span class="string-literal">"change in version 0.22"</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pipeline_spectral_clustering</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test using pipeline to do spectral clustering</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">se_rbf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_clusters</span><span class="punctuation">,</span>
                               <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"rbf"</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">se_knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_clusters</span><span class="punctuation">,</span>
                               <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"nearest_neighbors"</span><span class="punctuation">,</span>
                               <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">se</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">se_rbf</span><span class="punctuation">,</span> <span class="identifier">se_knn</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">km</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KMeans</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="identifier">n_clusters</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">km</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">se</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
            <span class="identifier">normalized_mutual_info_score</span><span class="grouping">(</span>
                <span class="identifier">km</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="punctuation">,</span>
                <span class="identifier">true_labels</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_spectral_embedding_unknown_eigensolver</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that SpectralClustering fails with an unknown eigensolver</span>
    <span class="identifier">se</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"precomputed"</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">eigen_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"&lt;unknown&gt;"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">se</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_spectral_embedding_unknown_affinity</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that SpectralClustering fails with an unknown affinity type</span>
    <span class="identifier">se</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"&lt;unknown&gt;"</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">se</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_connectivity</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that graph connectivity test works as expected</span>
    <span class="identifier">graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">_graph_is_connected</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">_graph_is_connected</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">_graph_is_connected</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_graph_is_connected</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_graph_is_connected</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_graph_is_connected</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_spectral_embedding_deterministic</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that Spectral Embedding is deterministic</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">36</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span>
    <span class="identifier">sims</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="identifier">embedding_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spectral_embedding</span><span class="grouping">(</span><span class="identifier">sims</span><span class="grouping">)</span>
    <span class="identifier">embedding_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spectral_embedding</span><span class="grouping">(</span><span class="identifier">sims</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">embedding_1</span><span class="punctuation">,</span> <span class="identifier">embedding_2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_spectral_embedding_unnormalized</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that spectral_embedding is also processing unnormalized laplacian</span>
    <span class="comment"># correctly</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">36</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span>
    <span class="identifier">sims</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">8</span>
    <span class="identifier">embedding_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spectral_embedding</span><span class="grouping">(</span><span class="identifier">sims</span><span class="punctuation">,</span>
                                     <span class="identifier">norm_laplacian</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                     <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                     <span class="identifier">drop_first</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="comment"># Verify using manual computation with dense eigh</span>
    <span class="identifier">laplacian</span><span class="punctuation">,</span> <span class="identifier">dd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csgraph</span><span class="punctuation">.</span><span class="identifier">laplacian</span><span class="grouping">(</span><span class="identifier">sims</span><span class="punctuation">,</span> <span class="identifier">normed</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                      <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">a</span><span class="invalid">g</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">diffusion_map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">eigh</span><span class="grouping">(</span><span class="identifier">laplacian</span><span class="grouping">)</span>
    <span class="identifier">embedding_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diffusion_map</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_components</span><span class="grouping">]</span>
    <span class="identifier">embedding_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_deterministic_vector_sign_flip</span><span class="grouping">(</span><span class="identifier">embedding_2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">embedding_1</span><span class="punctuation">,</span> <span class="identifier">embedding_2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_spectral_embedding_first_eigen_vector</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the first eigenvector of spectral_embedding</span>
    <span class="comment"># is constant and that the second is not (for a connected graph)</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">36</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span>
    <span class="identifier">sims</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>

    <span class="keyword">for</span> <span class="identifier">seed</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">embedding</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spectral_embedding</span><span class="grouping">(</span><span class="identifier">sims</span><span class="punctuation">,</span>
                                       <span class="identifier">norm_laplacian</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                       <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                       <span class="identifier">drop_first</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                       <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">embedding</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">embedding</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">1e-3</span>


<span class="comment"># TODO: Remove in 1.1</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"affinity", ["precomputed"</span><span class="punctuation">,</span>
                                      <span class="string-literal">"precomputed_nearest_neighbors"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spectral_embedding_pairwise_deprecated</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">se</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralEmbedding</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="identifier">affinity</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"Attribute _pairwise was deprecated in version 0\.24"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">se</span><span class="punctuation">.</span><span class="identifier">_pairwise</span>

    </pre>
  </body>
</html>