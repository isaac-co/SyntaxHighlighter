<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Test truncated SVD transformer."""</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">as</span> <span class="identifier">sp</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">TruncatedSVD</span><span class="punctuation">,</span> <span class="identifier">PCA</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>

<span class="identifier">SVD_SOLVERS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'arpack', 'randomized'</span><span class="grouping">]</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">fixture</span><span class="grouping">(</span><span class="identifier">scope</span><span class="arithmetic-assignment">=</span><span class="string-literal">'module'</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">X_sparse</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make an X that looks somewhat like a small tf-idf matrix.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">random</span><span class="grouping">(</span><span class="int-literal">60</span><span class="punctuation">,</span> <span class="int-literal">55</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">"csr"</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">X</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"solver"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'randomized'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kind', ('dense', 'sparse'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_solvers</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span> <span class="keyword">if</span> <span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'sparse'</span> <span class="keyword">else</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">svd_a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">"arpack"</span><span class="grouping">)</span>
    <span class="identifier">svd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">Xa</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd_a</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">6</span><span class="grouping">]</span>
    <span class="identifier">Xr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">6</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">Xa</span><span class="punctuation">,</span> <span class="identifier">Xr</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">2e-3</span><span class="grouping">)</span>

    <span class="identifier">comp_a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">svd_a</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="grouping">)</span>
    <span class="identifier">comp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="grouping">)</span>
    <span class="comment"># All elements are equal, but some elements are more equal than others.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">comp_a</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">comp</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">comp_a</span><span class="grouping">[</span><span class="int-literal">9</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">comp</span><span class="grouping">[</span><span class="int-literal">9</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"n_components"</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">25</span><span class="punctuation">,</span> <span class="int-literal">41</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_attributes</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X_sparse</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">tsvd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">tsvd</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="relational-operator">==</span> <span class="identifier">n_components</span>
    <span class="keyword">assert</span> <span class="identifier">tsvd</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'algorithm'</span><span class="punctuation">,</span> <span class="identifier">SVD_SOLVERS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_too_many_components</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">X_sparse</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">n_components</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">tsvd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">tsvd</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'fmt'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="string-literal">"array", "csr", "csc", "coo", "lil"</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sparse_formats</span><span class="grouping">(</span><span class="identifier">fmt</span><span class="punctuation">,</span> <span class="identifier">X_sparse</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">Xfmt</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">fmt</span> <span class="relational-operator">==</span> <span class="string-literal">"dense" else getattr(X_sparse, "to"</span> <span class="arithmetic-operator">+</span> <span class="identifier">fmt</span><span class="grouping">)</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">tsvd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">11</span><span class="grouping">)</span>
    <span class="identifier">Xtrans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tsvd</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">Xfmt</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">Xtrans</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span>
    <span class="identifier">Xtrans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tsvd</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">Xfmt</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">Xtrans</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'algo'</span><span class="punctuation">,</span> <span class="identifier">SVD_SOLVERS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_inverse_transform</span><span class="grouping">(</span><span class="identifier">algo</span><span class="punctuation">,</span> <span class="identifier">X_sparse</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># We need a lot of components for the reconstruction to be "almost</span>
    <span class="comment"># equal" in all positions. XXX Test means or sums instead?</span>
    <span class="identifier">tsvd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">52</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algo</span><span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tsvd</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="grouping">)</span>
    <span class="identifier">Xinv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tsvd</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">Xinv</span><span class="punctuation">,</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-1</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">2e-1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_integers</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">Xint</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span><span class="grouping">)</span>
    <span class="identifier">tsvd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="grouping">)</span>
    <span class="identifier">Xtrans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tsvd</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">Xint</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">Xtrans</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">tsvd</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kind', ('dense', 'sparse'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_components'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver'</span><span class="punctuation">,</span> <span class="identifier">SVD_SOLVERS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_explained_variance</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span> <span class="keyword">if</span> <span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'sparse'</span> <span class="keyword">else</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">svd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="grouping">)</span>
    <span class="identifier">X_tr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># Assert that all the values are greater than 0</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="grouping">)</span>

    <span class="comment"># Assert that total explained variance is less than 1</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span>

    <span class="comment"># Test that explained_variance is correct</span>
    <span class="identifier">total_variance</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">variances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">X_tr</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">true_explained_variance_ratio</span> <span class="arithmetic-assignment">=</span> <span class="identifier">variances</span> <span class="arithmetic-operator">/</span> <span class="identifier">total_variance</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
        <span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="punctuation">,</span>
        <span class="identifier">true_explained_variance_ratio</span><span class="punctuation">,</span>
    <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kind', ('dense', 'sparse'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver'</span><span class="punctuation">,</span> <span class="identifier">SVD_SOLVERS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_explained_variance_components_10_20</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span> <span class="keyword">if</span> <span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'sparse'</span> <span class="keyword">else</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">svd_10</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">svd_20</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Assert the 1st component is equal</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
        <span class="identifier">svd_10</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="punctuation">,</span>
        <span class="identifier">svd_20</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">5e-3</span><span class="punctuation">,</span>
    <span class="grouping">)</span>

    <span class="comment"># Assert that 20 components has higher explained variance than 10</span>
    <span class="keyword">assert</span> <span class="grouping">(</span>
        <span class="identifier">svd_20</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span>
        <span class="identifier">svd_10</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver'</span><span class="punctuation">,</span> <span class="identifier">SVD_SOLVERS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_singular_values_consistency</span><span class="grouping">(</span><span class="identifier">solver</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that the TruncatedSVD output has the correct singular values</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">80</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                       <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Compare to the Frobenius norm</span>
    <span class="identifier">X_pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">singular_values_</span><span class="arithmetic-operator">**</span><span class="float-literal">2.0</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">X_pca</span><span class="punctuation">,</span> <span class="string-literal">"fro"</span><span class="grouping">)</span><span class="arithmetic-operator">**</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>

    <span class="comment"># Compare to the 2-norms of the score vectors</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">singular_values_</span><span class="punctuation">,</span>
                    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">X_pca</span><span class="arithmetic-operator">**</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver'</span><span class="punctuation">,</span> <span class="identifier">SVD_SOLVERS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_singular_values_expected</span><span class="grouping">(</span><span class="identifier">solver</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Set the singular values and see what we get back</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">110</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                       <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">X_pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">X_pca</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">X_pca</span><span class="arithmetic-operator">**</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_pca</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="float-literal">3.142</span>
    <span class="identifier">X_pca</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="float-literal">2.718</span>

    <span class="identifier">X_hat_pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_pca</span><span class="punctuation">,</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="grouping">)</span>
    <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_hat_pca</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">singular_values_</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">3.142</span><span class="punctuation">,</span> <span class="float-literal">2.718</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-14</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_truncated_svd_eq_pca</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># TruncatedSVD should be equal to PCA on centered data</span>

    <span class="identifier">X_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">X_c</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_dense</span> <span class="arithmetic-operator">-</span> <span class="identifier">X_dense</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">svd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'arpack'</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>
    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">svd_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'arpack'</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>

    <span class="identifier">Xt_svd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_c</span><span class="grouping">)</span>
    <span class="identifier">Xt_pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_c</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">Xt_svd</span><span class="punctuation">,</span> <span class="identifier">Xt_pca</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-9</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">mean_</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-9</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">,</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"algorithm, tol"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="string-literal">'randomized', 0.), ('arpack', 1e-6), ('arpack'</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kind', ('dense', 'sparse'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fit_transform</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># fit_transform(X) should equal fit(X).transform(X)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span> <span class="keyword">if</span> <span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'sparse'</span> <span class="keyword">else</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">svd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span>
                       <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="grouping">)</span>
    <span class="identifier">X_transformed_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_transformed_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_transformed_1</span><span class="punctuation">,</span> <span class="identifier">X_transformed_2</span><span class="grouping">)</span>

    </pre>
  </body>
</html>