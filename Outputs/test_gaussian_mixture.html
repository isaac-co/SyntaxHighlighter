<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Author: Wei Xue &lt;xuewei4d@gmail.com&gt;</span>
<span class="comment">#         Thierry Guillemot &lt;thierry.guillemot.work@gmail.com&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">re</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">copy</span>
<span class="keyword">import</span> <span class="identifier">warnings</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">stats</span><span class="punctuation">,</span> <span class="identifier">linalg</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">covariance</span> <span class="keyword">import</span> <span class="identifier">EmpiricalCovariance</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_spd_matrix</span>
<span class="keyword">from</span> <span class="identifier">io</span> <span class="keyword">import</span> <span class="identifier">StringIO</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">adjusted_rand_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">mixture</span> <span class="keyword">import</span> <span class="identifier">GaussianMixture</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">mixture</span><span class="punctuation">.</span><span class="identifier">_gaussian_mixture</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">_estimate_gaussian_covariances_full</span><span class="punctuation">,</span>
    <span class="identifier">_estimate_gaussian_covariances_tied</span><span class="punctuation">,</span>
    <span class="identifier">_estimate_gaussian_covariances_diag</span><span class="punctuation">,</span>
    <span class="identifier">_estimate_gaussian_covariances_spherical</span><span class="punctuation">,</span>
    <span class="identifier">_compute_precision_cholesky</span><span class="punctuation">,</span>
    <span class="identifier">_compute_log_det_cholesky</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span><span class="punctuation">,</span> <span class="identifier">NotFittedError</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">extmath</span> <span class="keyword">import</span> <span class="identifier">fast_logdet</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>


<span class="identifier">COVARIANCE_TYPE</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'full', 'tied', 'diag', 'spherical'</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">generate_data</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span> <span class="identifier">precisions</span><span class="punctuation">,</span>
                  <span class="identifier">covariance_type</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">covariance_type</span> <span class="relational-operator">==</span> <span class="string-literal">'spherical'</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">c</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span>
                                          <span class="identifier">precisions</span><span class="grouping">[</span><span class="string-literal">'spherical'</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">multivariate_normal</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">c</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">,</span>
                                             <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">w</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">covariance_type</span> <span class="relational-operator">==</span> <span class="string-literal">'diag'</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">c</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span>
                                          <span class="identifier">precisions</span><span class="grouping">[</span><span class="string-literal">'diag'</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">multivariate_normal</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">c</span><span class="grouping">)</span><span class="punctuation">,</span>
                                             <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">w</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">covariance_type</span> <span class="relational-operator">==</span> <span class="string-literal">'tied'</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">multivariate_normal</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">precisions</span><span class="grouping">[</span><span class="string-literal">'tied'</span><span class="grouping">]</span><span class="punctuation">,</span>
                                             <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">w</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">covariance_type</span> <span class="relational-operator">==</span> <span class="string-literal">'full'</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">c</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span>
                                          <span class="identifier">precisions</span><span class="grouping">[</span><span class="string-literal">'full'</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">multivariate_normal</span><span class="grouping">(</span><span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">c</span><span class="punctuation">,</span>
                                             <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">w</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">X</span>


<span class="keyword">class</span> <span class="identifier">RandomData</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                 <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_components</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_features</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weights</span> <span class="arithmetic-operator">/</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weights</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">means</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">covariances</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
            <span class="string-literal">'spherical'</span><span class="punctuation">:</span> <span class="float-literal">.5</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">'diag'</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="float-literal">.5</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="punctuation">,</span>
            <span class="string-literal">'tied'</span><span class="punctuation">:</span> <span class="identifier">make_spd_matrix</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">'full'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
                <span class="identifier">make_spd_matrix</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">.5</span>
                <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">}</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">precisions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
            <span class="string-literal">'spherical': 1. / self.covariances['spherical'</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="string-literal">'diag': 1. / self.covariances['diag'</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="string-literal">'tied': linalg.inv(self.covariances['tied'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">'full'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">covariance</span><span class="grouping">)</span>
                             <span class="keyword">for</span> <span class="identifier">covariance</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">covariances</span><span class="grouping">[</span><span class="string-literal">'full'</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">}</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">generate_data</span><span class="grouping">(</span>
            <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">means</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">covariances</span><span class="punctuation">,</span>
            <span class="identifier">covar_type</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">w</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="punctuation">,</span>
                                    <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span>
                            <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">w</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weights</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_attributes</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test bad parameters</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="identifier">n_components_bad</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components_bad</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Invalid value for 'n_components': {n_components_bad} "</span>
        <span class="string-literal">"Estimation requires at least one component"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># covariance_type should be in [spherical, diag, tied, full]</span>
    <span class="identifier">covariance_type_bad</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'bad_covariance_type'</span>
    <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covariance_type_bad</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Invalid value for 'covariance_type': {covariance_type_bad} "</span>
        <span class="string-literal">"'covariance_type' should be in ['spherical', 'tied', 'diag', 'full']"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">tol_bad</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol_bad</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Invalid value for 'tol': {tol_bad:.5f} "</span>
        <span class="string-literal">"Tolerance used by the EM must be non-negative"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">reg_covar_bad</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="identifier">reg_covar_bad</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Invalid value for 'reg_covar': {reg_covar_bad:.5f} "</span>
        <span class="string-literal">"regularization on covariance must be non-negative"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">max_iter_bad</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter_bad</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Invalid value for 'max_iter': {max_iter_bad} "</span>
        <span class="string-literal">"Estimation requires at least one iteration"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">n_init_bad</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="identifier">n_init_bad</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Invalid value for 'n_init': {n_init_bad} "</span>
        <span class="string-literal">"Estimation requires at least one run"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">init_params_bad</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'bad_method'</span>
    <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">init_params</span><span class="arithmetic-assignment">=</span><span class="identifier">init_params_bad</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Unimplemented initialization method '{init_params_bad}'"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># test good parameters</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="float-literal">1e-4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span>
    <span class="identifier">covariance_type</span><span class="punctuation">,</span> <span class="identifier">init_params</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'full', 'random'</span>
    <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="identifier">n_init</span><span class="punctuation">,</span>
                          <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="identifier">reg_covar</span><span class="punctuation">,</span>
                          <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covariance_type</span><span class="punctuation">,</span>
                          <span class="identifier">init_params</span><span class="arithmetic-assignment">=</span><span class="identifier">init_params</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="relational-operator">==</span> <span class="identifier">n_components</span>
    <span class="keyword">assert</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">covariance_type</span> <span class="relational-operator">==</span> <span class="identifier">covariance_type</span>
    <span class="keyword">assert</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">tol</span> <span class="relational-operator">==</span> <span class="identifier">tol</span>
    <span class="keyword">assert</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">reg_covar</span> <span class="relational-operator">==</span> <span class="identifier">reg_covar</span>
    <span class="keyword">assert</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">max_iter</span> <span class="relational-operator">==</span> <span class="identifier">max_iter</span>
    <span class="keyword">assert</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">n_init</span> <span class="relational-operator">==</span> <span class="identifier">n_init</span>
    <span class="keyword">assert</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">init_params</span> <span class="relational-operator">==</span> <span class="identifier">init_params</span>


<span class="keyword">def</span> <span class="identifier">test_check_weights</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="string-literal">'full'</span><span class="grouping">]</span>

    <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="grouping">)</span>

    <span class="comment"># Check bad shape</span>
    <span class="identifier">weights_bad_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">weights_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">weights_bad_shape</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"The parameter 'weights' should have the shape of "</span>
        <span class="identifier">f</span><span class="string-literal">"({n_components},), but got {str(weights_bad_shape.shape)}"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Check bad range</span>
    <span class="identifier">weights_bad_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">weights_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">weights_bad_range</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"The parameter 'weights' should be in the range [0, 1], but got"</span>
        <span class="identifier">f</span><span class="string-literal">" max value {np.min(weights_bad_range):.5f}, "</span>
        <span class="identifier">f</span><span class="string-literal">"min value {np.max(weights_bad_range):.5f}"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Check bad normalization</span>
    <span class="identifier">weights_bad_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="identifier">weights_bad_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">weights_bad_norm</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">weights_bad_norm</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">weights_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">weights_bad_norm</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"The parameter 'weights' should be normalized, "</span>
        <span class="identifier">f</span><span class="string-literal">"but got sum(weights) = {np.sum(weights_bad_norm):.5f}"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Check good weights matrix</span>
    <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">weights</span>
    <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">weights_init</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">weights_init</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_check_means</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_features</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="string-literal">'full'</span><span class="grouping">]</span>

    <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="grouping">)</span>

    <span class="comment"># Check means bad shape</span>
    <span class="identifier">means_bad_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_components</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">means_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">means_bad_shape</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"The parameter 'means' should have the shape of "</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Check good means matrix</span>
    <span class="identifier">means</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">means</span>
    <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">means_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">means</span>
    <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">means</span><span class="punctuation">,</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">means_init</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_check_precisions</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_features</span>

    <span class="comment"># Define the bad precisions for each covariance_type</span>
    <span class="identifier">precisions_bad_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'full'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_components</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'tied'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'diag'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_components</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'spherical'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_components</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">}</span>

    <span class="comment"># Define not positive-definite precisions</span>
    <span class="identifier">precisions_not_pos</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">precisions_not_pos</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">precisions_not_pos</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span>

    <span class="identifier">precisions_not_positive</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'full'</span><span class="punctuation">:</span> <span class="identifier">precisions_not_pos</span><span class="punctuation">,</span>
        <span class="string-literal">'tied'</span><span class="punctuation">:</span> <span class="identifier">precisions_not_pos</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="string-literal">'diag'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'spherical'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span><span class="grouping">}</span>

    <span class="identifier">not_positive_errors</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'full': 'symmetric, positive-definite'</span><span class="punctuation">,</span>
        <span class="string-literal">'tied': 'symmetric, positive-definite'</span><span class="punctuation">,</span>
        <span class="string-literal">'diag': 'positive'</span><span class="punctuation">,</span>
        <span class="string-literal">'spherical': 'positive'</span><span class="grouping">}</span>

    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                            <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

        <span class="comment"># Check precisions with bad shapes</span>
        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">precisions_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">precisions_bad_shape</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
            <span class="identifier">f</span><span class="string-literal">"The parameter '{covar_type} precision' should have "</span>
            <span class="string-literal">"the shape of"</span>
        <span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="comment"># Check not positive precisions</span>
        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">precisions_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">precisions_not_positive</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
            <span class="identifier">f</span><span class="string-literal">"'{covar_type} precision' should be "</span>
            <span class="identifier">f</span><span class="string-literal">"{not_positive_errors[covar_type]}"</span>
        <span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="comment"># Check the correct init of precisions_init</span>
        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">precisions_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">precisions</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">precisions</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">precisions_init</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_suffstat_sk_full</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># compare the precision matrix compute from the</span>
    <span class="comment"># EmpiricalCovariance.covariance fitted on X*sqrt(resp)</span>
    <span class="comment"># with _sufficient_sk_full, n_components=1</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">2</span>

    <span class="comment"># special case 1, assuming data is "centered"</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">resp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_resp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">resp</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span>
    <span class="identifier">nk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">n_samples</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">xk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">covars_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_estimate_gaussian_covariances_full</span><span class="grouping">(</span><span class="identifier">resp</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">nk</span><span class="punctuation">,</span> <span class="identifier">xk</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">ecov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">EmpiricalCovariance</span><span class="grouping">(</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_resp</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">error_norm</span><span class="grouping">(</span><span class="identifier">covars_pred</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'frobenius'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">error_norm</span><span class="grouping">(</span><span class="identifier">covars_pred</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'spectral'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># check the precision computation</span>
    <span class="identifier">precs_chol_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_compute_precision_cholesky</span><span class="grouping">(</span><span class="identifier">covars_pred</span><span class="punctuation">,</span> <span class="string-literal">'full'</span><span class="grouping">)</span>
    <span class="identifier">precs_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">prec</span><span class="punctuation">,</span> <span class="identifier">prec</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">prec</span> <span class="relational-operator">in</span> <span class="identifier">precs_chol_pred</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">precs_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">cov</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">cov</span> <span class="relational-operator">in</span> <span class="identifier">covars_pred</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">precs_est</span><span class="punctuation">,</span> <span class="identifier">precs_pred</span><span class="grouping">)</span>

    <span class="comment"># special case 2, assuming resp are all ones</span>
    <span class="identifier">resp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">nk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">n_samples</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">xk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">covars_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_estimate_gaussian_covariances_full</span><span class="grouping">(</span><span class="identifier">resp</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">nk</span><span class="punctuation">,</span> <span class="identifier">xk</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">ecov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">EmpiricalCovariance</span><span class="grouping">(</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">error_norm</span><span class="grouping">(</span><span class="identifier">covars_pred</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'frobenius'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">error_norm</span><span class="grouping">(</span><span class="identifier">covars_pred</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'spectral'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># check the precision computation</span>
    <span class="identifier">precs_chol_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_compute_precision_cholesky</span><span class="grouping">(</span><span class="identifier">covars_pred</span><span class="punctuation">,</span> <span class="string-literal">'full'</span><span class="grouping">)</span>
    <span class="identifier">precs_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">prec</span><span class="punctuation">,</span> <span class="identifier">prec</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">prec</span> <span class="relational-operator">in</span> <span class="identifier">precs_chol_pred</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">precs_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">cov</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">cov</span> <span class="relational-operator">in</span> <span class="identifier">covars_pred</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">precs_est</span><span class="punctuation">,</span> <span class="identifier">precs_pred</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_suffstat_sk_tied</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># use equation Nk * Sk / N = S_tied</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span>

    <span class="identifier">resp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="identifier">resp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">resp</span> <span class="arithmetic-operator">/</span> <span class="identifier">resp</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">nk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">resp</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">xk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">resp</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">nk</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>

    <span class="identifier">covars_pred_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_estimate_gaussian_covariances_full</span><span class="grouping">(</span><span class="identifier">resp</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">nk</span><span class="punctuation">,</span> <span class="identifier">xk</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">covars_pred_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">nk</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">covars_pred_full</span><span class="punctuation">,</span>
                              <span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span>

    <span class="identifier">covars_pred_tied</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_estimate_gaussian_covariances_tied</span><span class="grouping">(</span><span class="identifier">resp</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">nk</span><span class="punctuation">,</span> <span class="identifier">xk</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">ecov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">EmpiricalCovariance</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">covariance_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">covars_pred_full</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">error_norm</span><span class="grouping">(</span><span class="identifier">covars_pred_tied</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'frobenius'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">error_norm</span><span class="grouping">(</span><span class="identifier">covars_pred_tied</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'spectral'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># check the precision computation</span>
    <span class="identifier">precs_chol_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_compute_precision_cholesky</span><span class="grouping">(</span><span class="identifier">covars_pred_tied</span><span class="punctuation">,</span> <span class="string-literal">'tied'</span><span class="grouping">)</span>
    <span class="identifier">precs_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">precs_chol_pred</span><span class="punctuation">,</span> <span class="identifier">precs_chol_pred</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">precs_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">covars_pred_tied</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">precs_est</span><span class="punctuation">,</span> <span class="identifier">precs_pred</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_suffstat_sk_diag</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test against 'full' case</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span>

    <span class="identifier">resp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="identifier">resp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">resp</span> <span class="arithmetic-operator">/</span> <span class="identifier">resp</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">nk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">resp</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">xk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">resp</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">nk</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="identifier">covars_pred_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_estimate_gaussian_covariances_full</span><span class="grouping">(</span><span class="identifier">resp</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">nk</span><span class="punctuation">,</span> <span class="identifier">xk</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">covars_pred_diag</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_estimate_gaussian_covariances_diag</span><span class="grouping">(</span><span class="identifier">resp</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">nk</span><span class="punctuation">,</span> <span class="identifier">xk</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">ecov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">EmpiricalCovariance</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">cov_full</span><span class="punctuation">,</span> <span class="identifier">cov_diag</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">covars_pred_full</span><span class="punctuation">,</span> <span class="identifier">covars_pred_diag</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">covariance_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">cov_full</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">cov_diag</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">cov_diag</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">error_norm</span><span class="grouping">(</span><span class="identifier">cov_diag</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'frobenius'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">error_norm</span><span class="grouping">(</span><span class="identifier">cov_diag</span><span class="punctuation">,</span> <span class="identifier">norm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'spectral'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># check the precision computation</span>
    <span class="identifier">precs_chol_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_compute_precision_cholesky</span><span class="grouping">(</span><span class="identifier">covars_pred_diag</span><span class="punctuation">,</span> <span class="string-literal">'diag'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">covars_pred_diag</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">precs_chol_pred</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_suffstat_sk_spherical</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># computing spherical covariance equals to the variance of one-dimension</span>
    <span class="comment"># data after flattening, n_components=1</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">2</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">resp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">nk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">n_samples</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">xk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">covars_pred_spherical</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_estimate_gaussian_covariances_spherical</span><span class="grouping">(</span><span class="identifier">resp</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span>
                                                                     <span class="identifier">nk</span><span class="punctuation">,</span> <span class="identifier">xk</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">covars_pred_spherical2</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span>
                              <span class="grouping">(</span><span class="identifier">n_features</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">covars_pred_spherical</span><span class="punctuation">,</span> <span class="identifier">covars_pred_spherical2</span><span class="grouping">)</span>

    <span class="comment"># check the precision computation</span>
    <span class="identifier">precs_chol_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_compute_precision_cholesky</span><span class="grouping">(</span><span class="identifier">covars_pred_spherical</span><span class="punctuation">,</span>
                                                  <span class="string-literal">'spherical'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">covars_pred_spherical</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">precs_chol_pred</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_compute_log_det_cholesky</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">covariance</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">covariances</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>

        <span class="keyword">if</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'full'</span><span class="punctuation">:</span>
            <span class="identifier">predected_det</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">det</span><span class="grouping">(</span><span class="identifier">cov</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">cov</span> <span class="relational-operator">in</span> <span class="identifier">covariance</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'tied'</span><span class="punctuation">:</span>
            <span class="identifier">predected_det</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">det</span><span class="grouping">(</span><span class="identifier">covariance</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'diag'</span><span class="punctuation">:</span>
            <span class="identifier">predected_det</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">prod</span><span class="grouping">(</span><span class="identifier">cov</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">cov</span> <span class="relational-operator">in</span> <span class="identifier">covariance</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'spherical'</span><span class="punctuation">:</span>
            <span class="identifier">predected_det</span> <span class="arithmetic-assignment">=</span> <span class="identifier">covariance</span> <span class="arithmetic-operator">**</span> <span class="identifier">n_features</span>

        <span class="comment"># We compute the cholesky decomposition of the covariance matrix</span>
        <span class="identifier">expected_det</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_compute_log_det_cholesky</span><span class="grouping">(</span><span class="identifier">_compute_precision_cholesky</span><span class="grouping">(</span>
            <span class="identifier">covariance</span><span class="punctuation">,</span> <span class="identifier">covar_type</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">covar_type</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_det</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span> <span class="float-literal">.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">predected_det</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_naive_lmvnpdf_diag</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span> <span class="identifier">covars</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">resp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">means</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">stds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">covars</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">mean</span><span class="punctuation">,</span> <span class="identifier">std</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">means</span><span class="punctuation">,</span> <span class="identifier">stds</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">resp</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stats</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="punctuation">.</span><span class="identifier">logpdf</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">mean</span><span class="punctuation">,</span> <span class="identifier">std</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">resp</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_log_probabilities</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">mixture</span><span class="punctuation">.</span><span class="identifier">_gaussian_mixture</span> <span class="keyword">import</span> <span class="identifier">_estimate_log_gaussian_prob</span>

    <span class="comment"># test against with _naive_lmvnpdf_diag</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_features</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>

    <span class="identifier">means</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">means</span>
    <span class="identifier">covars_diag</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">log_prob_naive</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_naive_lmvnpdf_diag</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span> <span class="identifier">covars_diag</span><span class="grouping">)</span>

    <span class="comment"># full covariances</span>
    <span class="identifier">precs_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">covars_diag</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">log_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_estimate_log_gaussian_prob</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span> <span class="identifier">precs_full</span><span class="punctuation">,</span> <span class="string-literal">'full'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">log_prob</span><span class="punctuation">,</span> <span class="identifier">log_prob_naive</span><span class="grouping">)</span>

    <span class="comment"># diag covariances</span>
    <span class="identifier">precs_chol_diag</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">covars_diag</span><span class="grouping">)</span>
    <span class="identifier">log_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_estimate_log_gaussian_prob</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span> <span class="identifier">precs_chol_diag</span><span class="punctuation">,</span> <span class="string-literal">'diag'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">log_prob</span><span class="punctuation">,</span> <span class="identifier">log_prob_naive</span><span class="grouping">)</span>

    <span class="comment"># tied</span>
    <span class="identifier">covars_tied</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">covars_diag</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">precs_tied</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">covars_tied</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">log_prob_naive</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_naive_lmvnpdf_diag</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span>
                                         <span class="grouping">[</span><span class="identifier">covars_tied</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="identifier">log_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_estimate_log_gaussian_prob</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span> <span class="identifier">precs_tied</span><span class="punctuation">,</span> <span class="string-literal">'tied'</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">log_prob</span><span class="punctuation">,</span> <span class="identifier">log_prob_naive</span><span class="grouping">)</span>

    <span class="comment"># spherical</span>
    <span class="identifier">covars_spherical</span> <span class="arithmetic-assignment">=</span> <span class="identifier">covars_diag</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">precs_spherical</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">covars_diag</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">log_prob_naive</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_naive_lmvnpdf_diag</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span>
                                         <span class="grouping">[</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_features</span> <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span>
                                          <span class="identifier">covars_spherical</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">log_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_estimate_log_gaussian_prob</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="punctuation">,</span>
                                           <span class="identifier">precs_spherical</span><span class="punctuation">,</span> <span class="string-literal">'spherical'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">log_prob</span><span class="punctuation">,</span> <span class="identifier">log_prob_naive</span><span class="grouping">)</span>

<span class="comment"># skip tests on weighted_log_probabilities, log_weights</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_estimate_log_prob_resp</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test whether responsibilities are normalized</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_samples</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_features</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">weights</span>
        <span class="identifier">means</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">means</span>
        <span class="identifier">precisions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">precisions</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                            <span class="identifier">weights_init</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">means_init</span><span class="arithmetic-assignment">=</span><span class="identifier">means</span><span class="punctuation">,</span>
                            <span class="identifier">precisions_init</span><span class="arithmetic-assignment">=</span><span class="identifier">precisions</span><span class="punctuation">,</span>
                            <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="grouping">)</span>
        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">resp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">resp</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">weights_init</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">means_init</span><span class="punctuation">,</span> <span class="identifier">means</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">precisions_init</span><span class="punctuation">,</span> <span class="identifier">precisions</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_predict_predict_proba</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">Y</span>
        <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">weights_init</span><span class="arithmetic-assignment">=</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">weights</span><span class="punctuation">,</span>
                            <span class="identifier">means_init</span><span class="arithmetic-assignment">=</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">means</span><span class="punctuation">,</span>
                            <span class="identifier">precisions_init</span><span class="arithmetic-assignment">=</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">precisions</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="grouping">)</span>

        <span class="comment"># Check a warning message arrive if we don't do fit</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
            <span class="string-literal">"This GaussianMixture instance is not fitted yet. Call 'fit' "</span>
            <span class="string-literal">"with appropriate arguments before using this estimator."</span>
        <span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">Y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">Y_pred_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Y_pred</span><span class="punctuation">,</span> <span class="identifier">Y_pred_proba</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">adjusted_rand_score</span><span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">Y_pred</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">.95</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore:.*did not converge.*"</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'seed, max_iter, tol'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span>    <span class="comment"># strict non-convergence</span>
    <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">)</span><span class="punctuation">,</span>    <span class="comment"># loose non-convergence</span>
    <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">300</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># strict convergence</span>
    <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">300</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># loose convergence</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_fit_predict</span><span class="grouping">(</span><span class="identifier">seed</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">Y</span>
        <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">weights_init</span><span class="arithmetic-assignment">=</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">weights</span><span class="punctuation">,</span>
                            <span class="identifier">means_init</span><span class="arithmetic-assignment">=</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">means</span><span class="punctuation">,</span>
                            <span class="identifier">precisions_init</span><span class="arithmetic-assignment">=</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">precisions</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="punctuation">,</span>
                            <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="grouping">)</span>

        <span class="comment"># check if fit_predict(X) is equivalent to fit(X).predict(X)</span>
        <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">copy</span><span class="punctuation">.</span><span class="identifier">deepcopy</span><span class="grouping">(</span><span class="identifier">g</span><span class="grouping">)</span>
        <span class="identifier">Y_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">Y_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Y_pred1</span><span class="punctuation">,</span> <span class="identifier">Y_pred2</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">adjusted_rand_score</span><span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">Y_pred2</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">.95</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_fit_predict_n_init</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that fit_predict is equivalent to fit.predict, when n_init &gt; 1</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">gm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gm</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">y_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gm</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred1</span><span class="punctuation">,</span> <span class="identifier">y_pred2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_fit</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># recover the ground truth</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_features</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>

    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                            <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                            <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="grouping">)</span>
        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="comment"># needs more data to pass the test with rtol=1e-7</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">weights_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">weights</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>

        <span class="identifier">arg_idx1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">arg_idx2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">means</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="grouping">[</span><span class="identifier">arg_idx1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">means</span><span class="grouping">[</span><span class="identifier">arg_idx2</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'full'</span><span class="punctuation">:</span>
            <span class="identifier">prec_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">precisions_</span>
            <span class="identifier">prec_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">precisions</span><span class="grouping">[</span><span class="string-literal">'full'</span><span class="grouping">]</span>
        <span class="keyword">elif</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'tied'</span><span class="punctuation">:</span>
            <span class="identifier">prec_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_components</span><span class="grouping">)</span>
            <span class="identifier">prec_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">precisions</span><span class="grouping">[</span><span class="string-literal">'tied'</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_components</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'spherical'</span><span class="punctuation">:</span>
            <span class="identifier">prec_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">c</span>
                                 <span class="keyword">for</span> <span class="identifier">c</span> <span class="relational-operator">in</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">prec_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">c</span> <span class="keyword">for</span> <span class="identifier">c</span> <span class="relational-operator">in</span>
                                 <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">precisions</span><span class="grouping">[</span><span class="string-literal">'spherical'</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'diag'</span><span class="punctuation">:</span>
            <span class="identifier">prec_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">d</span> <span class="relational-operator">in</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">prec_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">d</span> <span class="relational-operator">in</span>
                                 <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">precisions</span><span class="grouping">[</span><span class="string-literal">'diag'</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">arg_idx1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="identifier">prec_pred</span><span class="punctuation">,</span> <span class="identifier">axis1</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">axis2</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">arg_idx2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="identifier">prec_test</span><span class="punctuation">,</span> <span class="identifier">axis1</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">axis2</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">h</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">arg_idx1</span><span class="punctuation">,</span> <span class="identifier">arg_idx2</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">ecov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">EmpiricalCovariance</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">covariance_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">prec_test</span><span class="grouping">[</span><span class="identifier">h</span><span class="grouping">]</span>
            <span class="comment"># the accuracy depends on the number of data and randomness, rng</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">ecov</span><span class="punctuation">.</span><span class="identifier">error_norm</span><span class="grouping">(</span><span class="identifier">prec_pred</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.15</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_fit_best_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>
    <span class="identifier">n_init</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="grouping">)</span>
        <span class="identifier">ll</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_init</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">ll</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">ll</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">ll</span><span class="grouping">)</span>
        <span class="identifier">g_best</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                 <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="identifier">n_init</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                                 <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="grouping">)</span>
        <span class="identifier">g_best</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ll</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">g_best</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_fit_convergence_warning</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>
    <span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                            <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                            <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="grouping">)</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
            <span class="identifier">f</span><span class="string-literal">"Initialization {max_iter} did not converge. Try different init "</span>
            <span class="string-literal">"parameters, or increase max_iter, tol or check for degenerate"</span>
            <span class="string-literal">" data."</span>
        <span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">ConvergenceWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_multiple_init</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that multiple inits does not much worse than a single one</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">cv_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">train1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                 <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">cv_type</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">train2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                 <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">cv_type</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">train2</span> <span class="relational-operator">&gt;=</span> <span class="identifier">train1</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_n_parameters</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the right number of parameters is estimated</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">n_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'spherical': 13, 'diag': 21, 'tied': 26, 'full'</span><span class="punctuation">:</span> <span class="int-literal">41</span><span class="grouping">}</span>
    <span class="keyword">for</span> <span class="identifier">cv_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span>
            <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">cv_type</span><span class="punctuation">,</span>
            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">_n_parameters</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_params</span><span class="grouping">[</span><span class="identifier">cv_type</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_bic_1d_1component</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test all of the covariance_types return the same BIC score for</span>
    <span class="comment"># 1-dimensional, 1 component fits.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_dim</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_dim</span><span class="grouping">)</span>
    <span class="identifier">bic_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                               <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="string-literal">'full'</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">bic</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">covariance_type</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'tied', 'diag', 'spherical'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">bic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                              <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covariance_type</span><span class="punctuation">,</span>
                              <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">bic</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bic_full</span><span class="punctuation">,</span> <span class="identifier">bic</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_aic_bic</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the aic and bic criteria</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="comment"># standard gaussian entropy</span>
    <span class="identifier">sgh</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">fast_logdet</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">bias</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                 <span class="identifier">n_features</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">cv_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span>
            <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">cv_type</span><span class="punctuation">,</span>
            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="grouping">)</span>
        <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">aic</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="identifier">sgh</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">_n_parameters</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">bic</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="identifier">sgh</span> <span class="arithmetic-operator">+</span>
               <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">_n_parameters</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">bound</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">aic</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">aic</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span> <span class="relational-operator">&lt;</span> <span class="identifier">bound</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">bic</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">bic</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span> <span class="relational-operator">&lt;</span> <span class="identifier">bound</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_verbose</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>
    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="punctuation">,</span>
                            <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">h</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="punctuation">,</span>
                            <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">old_stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span>
        <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StringIO</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">h</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">finally</span><span class="punctuation">:</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">old_stdout</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">'ignore:.*did not converge.*'</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"seed"</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_warm_start</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">seed</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="comment"># Assert the warm_start give the same result for the same number of iter</span>
    <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                        <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                        <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">h</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                        <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                        <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">score1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">h</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">h</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">weights_</span><span class="punctuation">,</span> <span class="identifier">h</span><span class="punctuation">.</span><span class="identifier">weights_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="punctuation">,</span> <span class="identifier">h</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="punctuation">,</span> <span class="identifier">h</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score2</span> <span class="relational-operator">&gt;</span> <span class="identifier">score1</span>

    <span class="comment"># Assert that by using warm_start we can converge to a good solution</span>
    <span class="identifier">g</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                        <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                        <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="grouping">)</span>
    <span class="identifier">h</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                        <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                        <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="grouping">)</span>

    <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">g</span><span class="punctuation">.</span><span class="identifier">converged_</span>

    <span class="identifier">h</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># depending on the data there is large variability in the number of</span>
    <span class="comment"># refit necessary to converge due to the complete randomness of the</span>
    <span class="comment"># data</span>
    <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">h</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">h</span><span class="punctuation">.</span><span class="identifier">converged_</span><span class="punctuation">:</span>
            <span class="keyword">break</span>
    <span class="keyword">assert</span> <span class="identifier">h</span><span class="punctuation">.</span><span class="identifier">converged_</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_convergence_detected_with_warm_start</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># We check that convergence is detected when warm_start=True</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="string-literal">'full'</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">max_iter</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                              <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">converged_</span><span class="punctuation">:</span>
                <span class="keyword">break</span>
        <span class="keyword">assert</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">converged_</span>
        <span class="keyword">assert</span> <span class="identifier">max_iter</span> <span class="relational-operator">&gt;=</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">n_iter_</span>


<span class="keyword">def</span> <span class="identifier">test_score</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">covar_type</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'full'</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>

    <span class="comment"># Check the error message if we don't call fit</span>
    <span class="identifier">gmm1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                           <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                           <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"This GaussianMixture instance is not fitted yet. Call 'fit' with "</span>
        <span class="string-literal">"appropriate arguments before using this estimator."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gmm1</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Check score value</span>
    <span class="keyword">with</span> <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">catch_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">simplefilter</span><span class="grouping">(</span><span class="string-literal">"ignore"</span><span class="punctuation">,</span> <span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
        <span class="identifier">gmm1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">gmm_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gmm1</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">gmm_score_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gmm1</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">gmm_score</span><span class="punctuation">,</span> <span class="identifier">gmm_score_proba</span><span class="grouping">)</span>

    <span class="comment"># Check if the score increase</span>
    <span class="identifier">gmm2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                           <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">gmm2</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="identifier">gmm1</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_score_samples</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">covar_type</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'full'</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>

    <span class="comment"># Check the error message if we don't call fit</span>
    <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"This GaussianMixture instance is not fitted yet. Call 'fit' with "</span>
        <span class="string-literal">"appropriate arguments before using this estimator."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">gmm_score_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">gmm_score_samples</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_samples</span>


<span class="keyword">def</span> <span class="identifier">test_monotonic_likelihood</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># We check that each step of the EM without regularization improve</span>
    <span class="comment"># monotonically the training set likelihood</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>

    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                              <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                              <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                              <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="grouping">)</span>
        <span class="identifier">current_log_likelihood</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">infty</span>
        <span class="keyword">with</span> <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">catch_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">simplefilter</span><span class="grouping">(</span><span class="string-literal">"ignore"</span><span class="punctuation">,</span> <span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
            <span class="comment"># Do one training iteration at a time so we can make sure that the</span>
            <span class="comment"># training log likelihood increases after each iteration.</span>
            <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">600</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">prev_log_likelihood</span> <span class="arithmetic-assignment">=</span> <span class="identifier">current_log_likelihood</span>
                <span class="identifier">current_log_likelihood</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
                <span class="keyword">assert</span> <span class="identifier">current_log_likelihood</span> <span class="relational-operator">&gt;=</span> <span class="identifier">prev_log_likelihood</span>

                <span class="keyword">if</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">converged_</span><span class="punctuation">:</span>
                    <span class="keyword">break</span>

            <span class="keyword">assert</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">converged_</span>


<span class="keyword">def</span> <span class="identifier">test_regularisation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># We train the GaussianMixture on degenerate data by defining two clusters</span>
    <span class="comment"># of a 0 covariance.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                   <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                              <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

        <span class="keyword">with</span> <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">catch_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">simplefilter</span><span class="grouping">(</span><span class="string-literal">"ignore"</span><span class="punctuation">,</span> <span class="identifier">RuntimeWarning</span><span class="grouping">)</span>
            <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
                <span class="string-literal">"Fitting the mixture model failed because some components have"</span>
                <span class="string-literal">" ill-defined empirical covariance (for instance caused by "</span>
                <span class="string-literal">"singleton or collapsed samples). Try to decrease the number "</span>
                <span class="string-literal">"of components, or increase reg_covar."</span>
            <span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

            <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_property</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>

    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
        <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                              <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                              <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
        <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'full'</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">prec</span><span class="punctuation">,</span> <span class="identifier">covar</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="punctuation">,</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="grouping">)</span><span class="punctuation">:</span>

                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">prec</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">covar</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'tied'</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sample</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>

    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>

        <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                              <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
        <span class="comment"># To sample we need that GaussianMixture is fitted</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"This GaussianMixture instance is not fitted"</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">sample</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Invalid value for 'n_samples'"</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">sample</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="comment"># Just to make sure the class samples correctly</span>
        <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20000</span>
        <span class="identifier">X_s</span><span class="punctuation">,</span> <span class="identifier">y_s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">sample</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'full'</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span>
                                          <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">X_s</span><span class="grouping">[</span><span class="identifier">y_s</span> <span class="relational-operator">==</span> <span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="keyword">elif</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'tied'</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="punctuation">,</span>
                                          <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">X_s</span><span class="grouping">[</span><span class="identifier">y_s</span> <span class="relational-operator">==</span> <span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="keyword">elif</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'diag'</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span>
                                          <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">X_s</span><span class="grouping">[</span><span class="identifier">y_s</span> <span class="relational-operator">==</span> <span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                          <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                    <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">X_s</span><span class="grouping">[</span><span class="identifier">y_s</span> <span class="relational-operator">==</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">means_s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">X_s</span><span class="grouping">[</span><span class="identifier">y_s</span> <span class="relational-operator">==</span> <span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
                           <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="punctuation">,</span> <span class="identifier">means_s</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="comment"># Check shapes of sampled data, see</span>
        <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/7701</span>
        <span class="keyword">assert</span> <span class="identifier">X_s</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">sample_size</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X_s</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">sample</span><span class="grouping">(</span><span class="identifier">sample_size</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">X_s</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">sample_size</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_init</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># We check that by increasing the n_init number we have a better solution</span>
    <span class="keyword">for</span> <span class="identifier">random_state</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">15</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span><span class="punctuation">,</span>
                               <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="string-literal">'full'</span><span class="grouping">]</span>

        <span class="identifier">gmm1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">gmm2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                               <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">gmm2</span><span class="punctuation">.</span><span class="identifier">lower_bound_</span> <span class="relational-operator">&gt;=</span> <span class="identifier">gmm1</span><span class="punctuation">.</span><span class="identifier">lower_bound_</span>


<span class="keyword">def</span> <span class="identifier">test_gaussian_mixture_setting_best_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""`GaussianMixture`'s best_parameters, `n_iter_` and `lower_bound_`
    must be set appropriately in the case of divergence.

    Non-regression test for:
    https://github.com/scikit-learn/scikit-learn/issues/18216
    """</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">30</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># following initialization parameters were found to lead to divergence</span>
    <span class="identifier">means_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
            <span class="grouping">[</span><span class="float-literal">0.670637869618158</span><span class="punctuation">,</span> <span class="float-literal">0.21038256107384043</span><span class="punctuation">,</span> <span class="float-literal">0.12892629765485303</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.09394051075844147</span><span class="punctuation">,</span> <span class="float-literal">0.5759464955561779</span><span class="punctuation">,</span> <span class="float-literal">0.929296197576212</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.5033230372781258</span><span class="punctuation">,</span> <span class="float-literal">0.9569852381759425</span><span class="punctuation">,</span> <span class="float-literal">0.08654043447295741</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.18578301420435747</span><span class="punctuation">,</span> <span class="float-literal">0.5531158970919143</span><span class="punctuation">,</span> <span class="float-literal">0.19388943970532435</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.4548589928173794</span><span class="punctuation">,</span> <span class="float-literal">0.35182513658825276</span><span class="punctuation">,</span> <span class="float-literal">0.568146063202464</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.609279894978321</span><span class="punctuation">,</span> <span class="float-literal">0.7929063819678847</span><span class="punctuation">,</span> <span class="float-literal">0.9620097270828052</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">precisions_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">999999.999604483</span><span class="punctuation">,</span> <span class="float-literal">999999.9990869573</span><span class="punctuation">,</span>
                                <span class="float-literal">553.7603944542167</span><span class="punctuation">,</span> <span class="float-literal">204.78596008931834</span><span class="punctuation">,</span>
                                <span class="float-literal">15.867423501783637</span><span class="punctuation">,</span> <span class="float-literal">85.4595728389735</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">weights_init</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">0.03333333333333341</span><span class="punctuation">,</span> <span class="float-literal">0.03333333333333341</span><span class="punctuation">,</span>
                    <span class="float-literal">0.06666666666666674</span><span class="punctuation">,</span> <span class="float-literal">0.06666666666666674</span><span class="punctuation">,</span>
                    <span class="float-literal">0.7000000000000001</span><span class="punctuation">,</span> <span class="float-literal">0.10000000000000007</span><span class="grouping">]</span>

    <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="string-literal">"spherical"</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                          <span class="identifier">means_init</span><span class="arithmetic-assignment">=</span><span class="identifier">means_init</span><span class="punctuation">,</span> <span class="identifier">weights_init</span><span class="arithmetic-assignment">=</span><span class="identifier">weights_init</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rnd</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">weights_init</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="identifier">precisions_init</span><span class="arithmetic-assignment">=</span><span class="identifier">precisions_init</span><span class="grouping">)</span>
    <span class="comment"># ensure that no error is thrown during fit</span>
    <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># check that the fit did not converge</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">converged_</span>

    <span class="comment"># check that parameters are set for gmm</span>
    <span class="keyword">for</span> <span class="identifier">attr</span> <span class="relational-operator">in</span> <span class="grouping">[</span>
        <span class="string-literal">"weights_", "means_", "covariances_", "precisions_cholesky_"</span><span class="punctuation">,</span>
        <span class="string-literal">"n_iter_", "lower_bound_"</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">gmm</span><span class="punctuation">,</span> <span class="identifier">attr</span><span class="grouping">)</span>

    </pre>
  </body>
</html>