<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/python</span>

<span class="comment">"""

A Framework of Back Propagation Neural Network（BP） model

Easy to use:
    * add many layers as you want ！！！
    * clearly see how the loss decreasing
Easy to expand:
    * more activation functions
    * more loss functions
    * more optimization method

Author: Stephen Lee
Github : https://github.com/RiptideBo
Date: 2017.11.23

"""</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">matplotlib</span> <span class="keyword">import</span> <span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>


<span class="keyword">def</span> <span class="identifier">sigmoid</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="int-literal">1</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">x</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">DenseLayer</span><span class="punctuation">:</span>
    <span class="comment">"""
    Layers of BP neural network
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span>
        <span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">units</span><span class="punctuation">,</span> <span class="identifier">activation</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">is_input_layer</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span>
    <span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        common connected layer of bp network
        :param units: numbers of neural units
        :param activation: activation function
        :param learning_rate: learning rate for paras
        :param is_input_layer: whether it is input layer or not
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">units</span> <span class="arithmetic-assignment">=</span> <span class="identifier">units</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weight</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bias</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">activation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">activation</span>
        <span class="keyword">if</span> <span class="identifier">learning_rate</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">learning_rate</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.3</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">learn_rate</span> <span class="arithmetic-assignment">=</span> <span class="identifier">learning_rate</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_input_layer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">is_input_layer</span>

    <span class="keyword">def</span> <span class="identifier">initializer</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">back_units</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">units</span><span class="punctuation">,</span> <span class="identifier">back_units</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bias</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">units</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">activation</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">activation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sigmoid</span>

    <span class="keyword">def</span> <span class="identifier">cal_gradient</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># activation function may be sigmoid or linear</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">activation</span> <span class="relational-operator">==</span> <span class="identifier">sigmoid</span><span class="punctuation">:</span>
            <span class="identifier">gradient_mat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
            <span class="identifier">gradient_activation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">gradient_mat</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">gradient_activation</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="keyword">return</span> <span class="identifier">gradient_activation</span>

    <span class="keyword">def</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">w</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">g</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">xdata</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">xdata</span> <span class="arithmetic-assignment">=</span> <span class="identifier">xdata</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_input_layer</span><span class="punctuation">:</span>
            <span class="comment"># input layer</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wx_plus_b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">xdata</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">xdata</span>
            <span class="keyword">return</span> <span class="identifier">xdata</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wx_plus_b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weight</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">xdata</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bias</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">activation</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wx_plus_b</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">output</span>

    <span class="keyword">def</span> <span class="identifier">back_propagation</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">gradient</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gradient_activation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cal_gradient</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># i * i 维</span>
        <span class="identifier">gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">gradient</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">gradient_activation</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_gradient_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">xdata</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_gradient_bias</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_gradient_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weight</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gradient_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">gradient</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_gradient_weight</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gradient_bias</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gradient</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_gradient_bias</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">gradient</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_gradient_x</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="comment"># upgrade: the Negative gradient direction</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">weight</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">learn_rate</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gradient_weight</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bias</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bias</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">learn_rate</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gradient_bias</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="comment"># updates the weights and bias according to learning rate (0.3 if undefined)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gradient</span>


<span class="keyword">class</span> <span class="identifier">BPNN</span><span class="punctuation">:</span>
    <span class="comment">"""
    Back Propagation Neural Network model
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">layers</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_mse</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fig_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">ax_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fig_loss</span><span class="punctuation">.</span><span class="identifier">add_subplot</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">add_layer</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">layer</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">layers</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">layer</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">build</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">layer</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">layers</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">i</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
                <span class="identifier">layer</span><span class="punctuation">.</span><span class="identifier">is_input_layer</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">layer</span><span class="punctuation">.</span><span class="identifier">initializer</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">layers</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">units</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">summary</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">layer</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">layers</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"------- layer %d -------"</span> <span class="arithmetic-operator">%</span> <span class="identifier">i</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"weight.shape "</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">layer</span><span class="punctuation">.</span><span class="identifier">weight</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"bias.shape "</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">layer</span><span class="punctuation">.</span><span class="identifier">bias</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">train</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">xdata</span><span class="punctuation">,</span> <span class="identifier">ydata</span><span class="punctuation">,</span> <span class="identifier">train_round</span><span class="punctuation">,</span> <span class="identifier">accuracy</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_round</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_round</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">accuracy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">accuracy</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">ax_loss</span><span class="punctuation">.</span><span class="identifier">hlines</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">accuracy</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_round</span> <span class="arithmetic-operator">*</span> <span class="float-literal">1.1</span><span class="grouping">)</span>

        <span class="identifier">x_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">xdata</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">round_i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">train_round</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">all_loss</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
            <span class="keyword">for</span> <span class="identifier">row</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">x_shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">_xdata</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="grouping">(</span><span class="identifier">xdata</span><span class="grouping">[</span><span class="identifier">row</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
                <span class="identifier">_ydata</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="grouping">(</span><span class="identifier">ydata</span><span class="grouping">[</span><span class="identifier">row</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

                <span class="comment"># forward propagation</span>
                <span class="keyword">for</span> <span class="identifier">layer</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">layers</span><span class="punctuation">:</span>
                    <span class="identifier">_xdata</span> <span class="arithmetic-assignment">=</span> <span class="identifier">layer</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">w</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">g</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="grouping">(</span><span class="identifier">_xdata</span><span class="grouping">)</span>

                <span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cal_loss</span><span class="grouping">(</span><span class="identifier">_ydata</span><span class="punctuation">,</span> <span class="identifier">_xdata</span><span class="grouping">)</span>
                <span class="identifier">all_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_loss</span> <span class="arithmetic-operator">+</span> <span class="identifier">loss</span>

                <span class="comment"># back propagation: the input_layer does not upgrade</span>
                <span class="keyword">for</span> <span class="identifier">layer</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">layers</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
                    <span class="identifier">gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">layer</span><span class="punctuation">.</span><span class="identifier">back_propagation</span><span class="grouping">(</span><span class="identifier">gradient</span><span class="grouping">)</span>

            <span class="identifier">mse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all_loss</span> <span class="arithmetic-operator">/</span> <span class="identifier">x_shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_mse</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">mse</span><span class="grouping">)</span>

            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">plot_loss</span><span class="grouping">(</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">mse</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">accuracy</span><span class="punctuation">:</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"----达到精度----"</span><span class="grouping">)</span>
                <span class="keyword">return</span> <span class="identifier">mse</span>

    <span class="keyword">def</span> <span class="identifier">cal_loss</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">ydata</span><span class="punctuation">,</span> <span class="identifier">ydata_</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">power</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">ydata</span> <span class="arithmetic-operator">-</span> <span class="identifier">ydata_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss_gradient</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">ydata_</span> <span class="arithmetic-operator">-</span> <span class="identifier">ydata</span><span class="grouping">)</span>
        <span class="comment"># vector (shape is the same as _ydata.shape)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">loss_gradient</span>

    <span class="keyword">def</span> <span class="identifier">plot_loss</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">ax_loss</span><span class="punctuation">.</span><span class="identifier">lines</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">ax_loss</span><span class="punctuation">.</span><span class="identifier">lines</span><span class="punctuation">.</span><span class="identifier">remove</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">ax_loss</span><span class="punctuation">.</span><span class="identifier">lines</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">ax_loss</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_mse</span><span class="punctuation">,</span> <span class="string-literal">"r-"</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ion</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"step"</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"loss"</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">pause</span><span class="grouping">(</span><span class="float-literal">0.1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">example</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span>
        <span class="grouping">[</span>
            <span class="grouping">[</span><span class="float-literal">0.8</span><span class="punctuation">,</span> <span class="float-literal">0.4</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.4</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.34</span><span class="punctuation">,</span> <span class="float-literal">0.45</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.67</span><span class="punctuation">,</span> <span class="float-literal">0.32</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.88</span><span class="punctuation">,</span> <span class="float-literal">0.67</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.78</span><span class="punctuation">,</span> <span class="float-literal">0.77</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.55</span><span class="punctuation">,</span> <span class="float-literal">0.66</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.55</span><span class="punctuation">,</span> <span class="float-literal">0.43</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.54</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">]</span>
    <span class="grouping">)</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BPNN</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">add_layer</span><span class="grouping">(</span><span class="identifier">DenseLayer</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">build</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">summary</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">train</span><span class="grouping">(</span><span class="identifier">xdata</span><span class="arithmetic-assignment">=</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">ydata</span><span class="arithmetic-assignment">=</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">train_round</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">accuracy</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span>


<span class="keyword">if</span> <span class="identifier">__name__</span> <span class="relational-operator">==</span> <span class="string-literal">"__main__"</span><span class="punctuation">:</span>
    <span class="identifier">example</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>