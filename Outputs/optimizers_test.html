<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Tests for Faceswap Initializers.

Adapted from Keras tests.
"""</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">keras</span> <span class="keyword">import</span> <span class="identifier">optimizers</span> <span class="keyword">as</span> <span class="identifier">k_optimizers</span>
<span class="keyword">from</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">layers</span> <span class="keyword">import</span> <span class="identifier">Dense</span><span class="punctuation">,</span> <span class="identifier">Activation</span>
<span class="keyword">from</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">models</span> <span class="keyword">import</span> <span class="identifier">Sequential</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">model</span> <span class="keyword">import</span> <span class="identifier">optimizers</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_backend</span>

<span class="keyword">from</span> <span class="identifier">tests</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">generate_test_data</span><span class="punctuation">,</span> <span class="identifier">to_categorical</span>


<span class="keyword">def</span> <span class="identifier">get_test_data</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Obtain randomized test data for training """</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">seed</span><span class="grouping">(</span><span class="int-literal">1337</span><span class="grouping">)</span>
    <span class="grouping">(</span><span class="identifier">x_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generate_test_data</span><span class="grouping">(</span><span class="identifier">num_train</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span>
                                               <span class="identifier">num_test</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span>
                                               <span class="identifier">input_shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span>
                                               <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                               <span class="identifier">num_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">to_categorical</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">x_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span>


<span class="keyword">def</span> <span class="identifier">_test_optimizer</span><span class="grouping">(</span><span class="identifier">optimizer</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.75</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">x_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_test_data</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Sequential</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">Dense</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">x_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">Activation</span><span class="grouping">(</span><span class="string-literal">"relu"</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">Dense</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">Activation</span><span class="grouping">(</span><span class="string-literal">"softmax"</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">compile</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"categorical_crossentropy"</span><span class="punctuation">,</span>
                  <span class="identifier">optimizer</span><span class="arithmetic-assignment">=</span><span class="identifier">optimizer</span><span class="punctuation">,</span>
                  <span class="identifier">metrics</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"accuracy"</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">history</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">x_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">epochs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">batch_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">accuracy</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"acc" if get_backend() == "amd" else "accuracy"</span>
    <span class="keyword">assert</span> <span class="identifier">history</span><span class="punctuation">.</span><span class="identifier">history</span><span class="grouping">[</span><span class="identifier">accuracy</span><span class="grouping">]</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;=</span> <span class="identifier">target</span>
    <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">k_optimizers</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">optimizer</span><span class="grouping">)</span>
    <span class="identifier">optim</span> <span class="arithmetic-assignment">=</span> <span class="identifier">k_optimizers</span><span class="punctuation">.</span><span class="identifier">deserialize</span><span class="grouping">(</span><span class="identifier">config</span><span class="grouping">)</span>
    <span class="identifier">new_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">k_optimizers</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">optim</span><span class="grouping">)</span>
    <span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"class_name"] = config["class_name"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">new_config</span><span class="grouping">[</span><span class="string-literal">"class_name"] = new_config["class_name"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">config</span> <span class="relational-operator">==</span> <span class="identifier">new_config</span>

    <span class="comment"># Test constraints.</span>
    <span class="keyword">if</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"amd"</span><span class="punctuation">:</span>
        <span class="comment"># NB: PlaidML does not support constraints, so this test skipped for AMD backends</span>
        <span class="keyword">return</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Sequential</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Dense</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span>
                  <span class="identifier">input_shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">x_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="identifier">kernel_constraint</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="int-literal">0</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span>
                  <span class="identifier">bias_constraint</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="int-literal">0</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">dense</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">Activation</span><span class="grouping">(</span><span class="string-literal">"relu"</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">Dense</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">Activation</span><span class="grouping">(</span><span class="string-literal">"softmax"</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">compile</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"categorical_crossentropy"</span><span class="punctuation">,</span>
                  <span class="identifier">optimizer</span><span class="arithmetic-assignment">=</span><span class="identifier">optimizer</span><span class="punctuation">,</span>
                  <span class="identifier">metrics</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"accuracy"</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">train_on_batch</span><span class="grouping">(</span><span class="identifier">x_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">bias</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dense</span><span class="punctuation">.</span><span class="identifier">get_weights</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bias</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dummy"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">upper</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_adam</span><span class="grouping">(</span><span class="identifier">dummy</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
    <span class="comment">""" Test for custom Adam optimizer """</span>
    <span class="identifier">_test_optimizer</span><span class="grouping">(</span><span class="identifier">k_optimizers</span><span class="punctuation">.</span><span class="identifier">Adam</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>
    <span class="identifier">_test_optimizer</span><span class="grouping">(</span><span class="identifier">k_optimizers</span><span class="punctuation">.</span><span class="identifier">Adam</span><span class="grouping">(</span><span class="identifier">decay</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dummy"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">upper</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_adabelief</span><span class="grouping">(</span><span class="identifier">dummy</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
    <span class="comment">""" Test for custom Adam optimizer """</span>
    <span class="identifier">_test_optimizer</span><span class="grouping">(</span><span class="identifier">optimizers</span><span class="punctuation">.</span><span class="identifier">AdaBelief</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>

    </pre>
  </body>
</html>