<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Custom Layers for faceswap.py. """</span>

<span class="keyword">from</span> <span class="identifier">__future__</span> <span class="keyword">import</span> <span class="identifier">absolute_import</span>

<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">inspect</span>

<span class="keyword">import</span> <span class="identifier">tensorflow</span> <span class="keyword">as</span> <span class="identifier">tf</span>
<span class="keyword">import</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">backend</span> <span class="keyword">as</span> <span class="identifier">K</span>

<span class="keyword">from</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">layers</span> <span class="keyword">import</span> <span class="identifier">InputSpec</span><span class="punctuation">,</span> <span class="identifier">Layer</span>
<span class="keyword">from</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_custom_objects</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_backend</span>

<span class="keyword">if</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"amd"</span><span class="punctuation">:</span>
    <span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">plaidml_utils</span> <span class="keyword">import</span> <span class="identifier">pad</span>
    <span class="keyword">from</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">conv_utils</span>  <span class="comment"># pylint:disable=ungrouped-imports</span>
<span class="keyword">else</span><span class="punctuation">:</span>
    <span class="keyword">from</span> <span class="identifier">tensorflow</span> <span class="keyword">import</span> <span class="identifier">pad</span>
    <span class="keyword">from</span> <span class="identifier">tensorflow</span><span class="punctuation">.</span><span class="identifier">python</span><span class="punctuation">.</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">conv_utils</span>


<span class="keyword">class</span> <span class="identifier">PixelShuffler</span><span class="grouping">(</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" PixelShuffler layer for Keras.

    This layer requires a Convolution2D prior to it, having output filters computed according to
    the formula :math:`filters = k * (scale_factor * scale_factor)` where `k` is a user defined
    number of filters (generally larger than 32) and `scale_factor` is the up-scaling factor
    (generally 2).

    This layer performs the depth to space operation on the convolution filters, and returns a
    tensor with the size as defined below.

    Notes
    -----
    In practice, it is useful to have a second convolution layer after the
    :class:`PixelShuffler` layer to speed up the learning process. However, if you are stacking
    multiple :class:`PixelShuffler` blocks, it may increase the number of parameters greatly,
    so the Convolution layer after :class:`PixelShuffler` layer can be removed.

    Example
    -------
    &gt;&gt;&gt; # A standard sub-pixel up-scaling block
    &gt;&gt;&gt; x = Convolution2D(256, 3, 3, padding="same", activation="relu")(...)
    &gt;&gt;&gt; u = PixelShuffler(size=(2, 2))(x)
    [Optional]
    &gt;&gt;&gt; x = Convolution2D(256, 3, 3, padding="same", activation="relu")(u)

    Parameters
    ----------
    size: tuple, optional
        The (`h`, `w`) scaling factor for up-scaling. Default: `(2, 2)`
    data_format: ["channels_first", "channels_last", ``None``], optional
        The data format for the input. Default: ``None``
    kwargs: dict
        The standard Keras Layer keyword arguments (if any)

    References
    ----------
    https://gist.github.com/t-ae/6e1016cc188104d123676ccef3264981
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">data_format</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"amd"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">normalize_data_format</span><span class="grouping">(</span><span class="identifier">data_format</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="arithmetic-assignment">=</span> <span class="identifier">conv_utils</span><span class="punctuation">.</span><span class="identifier">normalize_data_format</span><span class="grouping">(</span><span class="identifier">data_format</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">conv_utils</span><span class="punctuation">.</span><span class="identifier">normalize_tuple</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="string-literal">'size'</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
        <span class="comment">"""This is where the layer's logic lives.

        Parameters
        ----------
        inputs: tensor
            Input tensor, or list/tuple of input tensors
        kwargs: dict
            Additional keyword arguments. Unused

        Returns
        -------
        tensor
            A tensor or list/tuple of tensors
        """</span>
        <span class="identifier">input_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">int_shape</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="int-literal">4</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Inputs should have rank '</span> <span class="arithmetic-operator">+</span>
                             <span class="identifier">str</span><span class="grouping">(</span><span class="int-literal">4</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                             <span class="string-literal">'; Received input shape:'</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_first'</span><span class="punctuation">:</span>
            <span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">channels</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span>
            <span class="keyword">if</span> <span class="identifier">batch_size</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">batch_size</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
            <span class="identifier">r_height</span><span class="punctuation">,</span> <span class="identifier">r_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span>
            <span class="identifier">o_height</span><span class="punctuation">,</span> <span class="identifier">o_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">height</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_height</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_width</span>
            <span class="identifier">o_channels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">channels</span> <span class="arithmetic-operator">//</span> <span class="grouping">(</span><span class="identifier">r_height</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_width</span><span class="grouping">)</span>

            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">r_height</span><span class="punctuation">,</span> <span class="identifier">r_width</span><span class="punctuation">,</span> <span class="identifier">o_channels</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">permute_dimensions</span><span class="grouping">(</span><span class="identifier">out</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">out</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">o_channels</span><span class="punctuation">,</span> <span class="identifier">o_height</span><span class="punctuation">,</span> <span class="identifier">o_width</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_last'</span><span class="punctuation">:</span>
            <span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">channels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span>
            <span class="keyword">if</span> <span class="identifier">batch_size</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">batch_size</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
            <span class="identifier">r_height</span><span class="punctuation">,</span> <span class="identifier">r_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span>
            <span class="identifier">o_height</span><span class="punctuation">,</span> <span class="identifier">o_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">height</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_height</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_width</span>
            <span class="identifier">o_channels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">channels</span> <span class="arithmetic-operator">//</span> <span class="grouping">(</span><span class="identifier">r_height</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_width</span><span class="grouping">)</span>

            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">r_height</span><span class="punctuation">,</span> <span class="identifier">r_width</span><span class="punctuation">,</span> <span class="identifier">o_channels</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">permute_dimensions</span><span class="grouping">(</span><span class="identifier">out</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">out</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">o_height</span><span class="punctuation">,</span> <span class="identifier">o_width</span><span class="punctuation">,</span> <span class="identifier">o_channels</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">out</span>

    <span class="keyword">def</span> <span class="identifier">compute_output_shape</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Computes the output shape of the layer.

        Assumes that the layer will be built to match that input shape provided.

        Parameters
        ----------
        input_shape: tuple or list of tuples
            Shape tuple (tuple of integers) or list of shape tuples (one per output tensor of the
            layer).  Shape tuples can include None for free dimensions, instead of an integer.

        Returns
        -------
        tuple
            An input shape tuple
        """</span>
        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="int-literal">4</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Inputs should have rank '</span> <span class="arithmetic-operator">+</span>
                             <span class="identifier">str</span><span class="grouping">(</span><span class="int-literal">4</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                             <span class="string-literal">'; Received input shape:'</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_first'</span><span class="punctuation">:</span>
            <span class="identifier">height</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="keyword">if</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">channels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

            <span class="keyword">if</span> <span class="identifier">channels</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'channels of input and size are incompatible'</span><span class="grouping">)</span>

            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">channels</span><span class="punctuation">,</span>
                      <span class="identifier">height</span><span class="punctuation">,</span>
                      <span class="identifier">width</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_last'</span><span class="punctuation">:</span>
            <span class="identifier">height</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="keyword">if</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">channels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

            <span class="keyword">if</span> <span class="identifier">channels</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'channels of input and size are incompatible'</span><span class="grouping">)</span>

            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">height</span><span class="punctuation">,</span>
                      <span class="identifier">width</span><span class="punctuation">,</span>
                      <span class="identifier">channels</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns the config of the layer.

        A layer config is a Python dictionary (serializable) containing the configuration of a
        layer. The same layer can be reinstated later (without its trained weights) from this
        configuration.

        The configuration of a layer does not include connectivity information, nor the layer
        class name. These are handled by `Network` (one layer of abstraction above).

        Returns
        --------
        dict
            A python dictionary containing the layer configuration
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'size'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="punctuation">,</span>
                  <span class="string-literal">'data_format'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span><span class="grouping">}</span>
        <span class="identifier">base_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="identifier">PixelShuffler</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">base_config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">KResizeImages</span><span class="grouping">(</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" A custom upscale function that uses :class:`keras.backend.resize_images` to upsample.

    Parameters
    ----------
    size: int or float, optional
        The scale to upsample to. Default: `2`
    interpolation: ["nearest", "bilinear"], optional
        The interpolation to use. Default: `"nearest"`
    kwargs: dict
        The standard Keras Layer keyword arguments (if any)
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"nearest"</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">size</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">interpolation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">interpolation</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
        <span class="comment">""" Call the upsample layer

        Parameters
        ----------
        inputs: tensor
            Input tensor, or list/tuple of input tensors
        kwargs: dict
            Additional keyword arguments. Unused

        Returns
        -------
        tensor
            A tensor or list/tuple of tensors
        """</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">resize_images</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span>
                                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="punctuation">,</span>
                                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="punctuation">,</span>
                                     <span class="string-literal">"channels_last"</span><span class="punctuation">,</span>
                                     <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">interpolation</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="comment"># Arbitrary resizing</span>
            <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">int_shape</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="string-literal">"amd"</span><span class="punctuation">:</span>
                <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">interpolation</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">NotImplementedError</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">compute_output_shape</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Computes the output shape of the layer.

        This is the input shape with size dimensions multiplied by :attr:`size`

        Parameters
        ----------
        input_shape: tuple or list of tuples
            Shape tuple (tuple of integers) or list of shape tuples (one per output tensor of the
            layer).  Shape tuples can include None for free dimensions, instead of an integer.

        Returns
        -------
        tuple
            An input shape tuple
        """</span>
        <span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">channels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">height</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">channels</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns the config of the layer.

        Returns
        --------
        dict
            A python dictionary containing the layer configuration
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">interpolation</span><span class="grouping">)</span>
        <span class="identifier">base_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">base_config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">SubPixelUpscaling</span><span class="grouping">(</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Sub-pixel convolutional up-scaling layer.

    This layer requires a Convolution2D prior to it, having output filters computed according to
    the formula :math:`filters = k * (scale_factor * scale_factor)` where `k` is a user defined
    number of filters (generally larger than 32) and `scale_factor` is the up-scaling factor
    (generally 2).

    This layer performs the depth to space operation on the convolution filters, and returns a
    tensor with the size as defined below.

    Notes
    -----
    This method is deprecated as it just performs the same as :class:`PixelShuffler`
    using explicit Tensorflow ops. The method is kept in the repository to support legacy
    models that have been created with this layer.

    In practice, it is useful to have a second convolution layer after the
    :class:`SubPixelUpscaling` layer to speed up the learning process. However, if you are stacking
    multiple :class:`SubPixelUpscaling` blocks, it may increase the number of parameters greatly,
    so the Convolution layer after :class:`SubPixelUpscaling` layer can be removed.

    Example
    -------
    &gt;&gt;&gt; # A standard sub-pixel up-scaling block
    &gt;&gt;&gt; x = Convolution2D(256, 3, 3, padding="same", activation="relu")(...)
    &gt;&gt;&gt; u = SubPixelUpscaling(scale_factor=2)(x)
    [Optional]
    &gt;&gt;&gt; x = Convolution2D(256, 3, 3, padding="same", activation="relu")(u)

    Parameters
    ----------
    size: int, optional
        The up-scaling factor. Default: `2`
    data_format: ["channels_first", "channels_last", ``None``], optional
        The data format for the input. Default: ``None``
    kwargs: dict
        The standard Keras Layer keyword arguments (if any)

    References
    ----------
    based on the paper "Real-Time Single Image and Video Super-Resolution Using an Efficient
    Sub-Pixel Convolutional Neural Network" (https://arxiv.org/abs/1609.05158).
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">scale_factor</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">data_format</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="identifier">SubPixelUpscaling</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_factor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scale_factor</span>
        <span class="keyword">if</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"amd"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">normalize_data_format</span><span class="grouping">(</span><span class="identifier">data_format</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="arithmetic-assignment">=</span> <span class="identifier">conv_utils</span><span class="punctuation">.</span><span class="identifier">normalize_data_format</span><span class="grouping">(</span><span class="identifier">data_format</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">build</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Creates the layer weights.

        Must be implemented on all layers that have weights.

        Parameters
        ----------
        input_shape: tensor
            Keras tensor (future input to layer) or ``list``/``tuple`` of Keras tensors to
            reference for weight shape computations.
        """</span>
        <span class="keyword">pass</span>  <span class="comment"># pylint: disable=unnecessary-pass</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
        <span class="comment">"""This is where the layer's logic lives.

        Parameters
        ----------
        inputs: tensor
            Input tensor, or list/tuple of input tensors
        kwargs: dict
            Additional keyword arguments. Unused

        Returns
        -------
        tensor
            A tensor or list/tuple of tensors
        """</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_depth_to_space</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_factor</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">compute_output_shape</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Computes the output shape of the layer.

        Assumes that the layer will be built to match that input shape provided.

        Parameters
        ----------
        input_shape: tuple or list of tuples
            Shape tuple (tuple of integers) or list of shape tuples (one per output tensor of the
            layer).  Shape tuples can include None for free dimensions, instead of an integer.

        Returns
        -------
        tuple
            An input shape tuple
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">"channels_first"</span><span class="punctuation">:</span>
            <span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">channels</span><span class="punctuation">,</span> <span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">columns</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span>
            <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span>
                    <span class="identifier">channels</span> <span class="arithmetic-operator">//</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_factor</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">rows</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_factor</span><span class="punctuation">,</span>
                    <span class="identifier">columns</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_factor</span><span class="grouping">)</span>
        <span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">columns</span><span class="punctuation">,</span> <span class="identifier">channels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span>
                <span class="identifier">rows</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_factor</span><span class="punctuation">,</span>
                <span class="identifier">columns</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_factor</span><span class="punctuation">,</span>
                <span class="identifier">channels</span> <span class="arithmetic-operator">//</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_factor</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_depth_to_space</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">ipt</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="punctuation">,</span> <span class="identifier">data_format</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Uses phase shift algorithm to convert channels/depth for spatial resolution """</span>
        <span class="keyword">if</span> <span class="identifier">data_format</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">data_format</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">image_data_format</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">data_format</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data_format</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">ipt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="punctuation">.</span><span class="identifier">_preprocess_conv2d_input</span><span class="grouping">(</span><span class="identifier">ipt</span><span class="punctuation">,</span> <span class="identifier">data_format</span><span class="grouping">)</span>
        <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">depth_to_space</span><span class="grouping">(</span><span class="identifier">ipt</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span>
        <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="punctuation">.</span><span class="identifier">_postprocess_conv2d_output</span><span class="grouping">(</span><span class="identifier">out</span><span class="punctuation">,</span> <span class="identifier">data_format</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">out</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_postprocess_conv2d_output</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">data_format</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Transpose and cast the output from conv2d if needed.

        Parameters
        ----------
        inputs: tensor
            The input that requires transposing and casting
        data_format: str
            `"channels_last"` or `"channels_first"`

        Returns
        -------
        tensor
            The transposed and cast input tensor
        """</span>

        <span class="keyword">if</span> <span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">"channels_first"</span><span class="punctuation">:</span>
            <span class="identifier">inputs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">floatx</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"float64"</span><span class="punctuation">:</span>
            <span class="identifier">inputs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">cast</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="string-literal">"float64"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">inputs</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_preprocess_conv2d_input</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">data_format</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Transpose and cast the input before the conv2d.

        Parameters
        ----------
        inputs: tensor
            The input that requires transposing and casting
        data_format: str
            `"channels_last"` or `"channels_first"`

        Returns
        -------
        tensor
            The transposed and cast input tensor
        """</span>
        <span class="keyword">if</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"float64"</span><span class="punctuation">:</span>
            <span class="identifier">inputs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">cast</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="string-literal">"float32"</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">"channels_first"</span><span class="punctuation">:</span>
            <span class="comment"># Tensorflow uses the last dimension as channel dimension, instead of the 2nd one.</span>
            <span class="comment"># Theano input shape: (samples, input_depth, rows, cols)</span>
            <span class="comment"># Tensorflow input shape: (samples, rows, cols, input_depth)</span>
            <span class="identifier">inputs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">inputs</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns the config of the layer.

        A layer config is a Python dictionary (serializable) containing the configuration of a
        layer. The same layer can be reinstated later (without its trained weights) from this
        configuration.

        The configuration of a layer does not include connectivity information, nor the layer
        class name. These are handled by `Network` (one layer of abstraction above).

        Returns
        --------
        dict
            A python dictionary containing the layer configuration
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"scale_factor"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_factor</span><span class="punctuation">,</span>
                  <span class="string-literal">"data_format"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span><span class="grouping">}</span>
        <span class="identifier">base_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="identifier">SubPixelUpscaling</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">base_config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">ReflectionPadding2D</span><span class="grouping">(</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Reflection-padding layer for 2D input (e.g. picture).

    This layer can add rows and columns at the top, bottom, left and right side of an image tensor.

    Parameters
    ----------
    stride: int, optional
        The stride of the following convolution. Default: `2`
    kernel_size: int, optional
        The kernel size of the following convolution. Default: `5`
    kwargs: dict
        The standard Keras Layer keyword arguments (if any)
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">stride</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">stride</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">tuple</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">stride</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span> <span class="logical-operator">and</span> <span class="identifier">stride</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">stride</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">stride</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stride</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stride</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel_size</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_spec</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">build</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Creates the layer weights.

        Must be implemented on all layers that have weights.

        Parameters
        ----------
        input_shape: tensor
            Keras tensor (future input to layer) or ``list``/``tuple`` of Keras tensors to
            reference for weight shape computations.
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_spec</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">InputSpec</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">input_shape</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">compute_output_shape</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Computes the output shape of the layer.

        Assumes that the layer will be built to match that input shape provided.

        Parameters
        ----------
        input_shape: tuple or list of tuples
            Shape tuple (tuple of integers) or list of shape tuples (one per output tensor of the
            layer).  Shape tuples can include None for free dimensions, instead of an integer.

        Returns
        -------
        tuple
            An input shape tuple
        """</span>
        <span class="identifier">input_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_spec</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="identifier">in_width</span><span class="punctuation">,</span> <span class="identifier">in_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">kernel_width</span><span class="punctuation">,</span> <span class="identifier">kernel_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_size</span>

        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">in_height</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">padding_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">kernel_height</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">padding_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">kernel_height</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">in_height</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">in_width</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">padding_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">kernel_width</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">padding_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">kernel_width</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">in_width</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">padding_height</span><span class="punctuation">,</span>
                <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">padding_width</span><span class="punctuation">,</span>
                <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument,arguments-differ</span>
        <span class="comment">"""This is where the layer's logic lives.

        Parameters
        ----------
        inputs: tensor
            Input tensor, or list/tuple of input tensors
        kwargs: dict
            Additional keyword arguments

        Returns
        -------
        tensor
            A tensor or list/tuple of tensors
        """</span>
        <span class="identifier">input_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_spec</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="identifier">in_width</span><span class="punctuation">,</span> <span class="identifier">in_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">kernel_width</span><span class="punctuation">,</span> <span class="identifier">kernel_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_size</span>

        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">in_height</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">padding_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">kernel_height</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">padding_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">kernel_height</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">in_height</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">in_width</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">padding_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">kernel_width</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">padding_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">kernel_width</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">in_width</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>

        <span class="identifier">padding_top</span> <span class="arithmetic-assignment">=</span> <span class="identifier">padding_height</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>
        <span class="identifier">padding_bot</span> <span class="arithmetic-assignment">=</span> <span class="identifier">padding_height</span> <span class="arithmetic-operator">-</span> <span class="identifier">padding_top</span>
        <span class="identifier">padding_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">padding_width</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>
        <span class="identifier">padding_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">padding_width</span> <span class="arithmetic-operator">-</span> <span class="identifier">padding_left</span>

        <span class="keyword">return</span> <span class="identifier">pad</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span>
                   <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="grouping">[</span><span class="identifier">padding_top</span><span class="punctuation">,</span> <span class="identifier">padding_bot</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="grouping">[</span><span class="identifier">padding_left</span><span class="punctuation">,</span> <span class="identifier">padding_right</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                   <span class="string-literal">'REFLECT'</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns the config of the layer.

        A layer config is a Python dictionary (serializable) containing the configuration of a
        layer. The same layer can be reinstated later (without its trained weights) from this
        configuration.

        The configuration of a layer does not include connectivity information, nor the layer
        class name. These are handled by `Network` (one layer of abstraction above).

        Returns
        --------
        dict
            A python dictionary containing the layer configuration
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'stride'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">stride</span><span class="punctuation">,</span>
                  <span class="string-literal">'kernel_size'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_size</span><span class="grouping">}</span>
        <span class="identifier">base_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="identifier">ReflectionPadding2D</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">base_config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">_GlobalPooling2D</span><span class="grouping">(</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Abstract class for different global pooling 2D layers.

    From keras as access to pooling is trickier in tensorflow.keras
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">data_format</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="identifier">_GlobalPooling2D</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"amd"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">normalize_data_format</span><span class="grouping">(</span><span class="identifier">data_format</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="arithmetic-assignment">=</span> <span class="identifier">conv_utils</span><span class="punctuation">.</span><span class="identifier">normalize_data_format</span><span class="grouping">(</span><span class="identifier">data_format</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_spec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">InputSpec</span><span class="grouping">(</span><span class="identifier">ndim</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">compute_output_shape</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Compute the output shape based on the input shape.

        Parameters
        ----------
        input_shape: tuple
            The input shape to the layer
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_last'</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Override to call the layer.

        Parameters
        ----------
        inputs: Tensor
            The input to the layer
        kwargs: dict
            Additional keyword arguments
        """</span>
        <span class="keyword">raise</span> <span class="identifier">NotImplementedError</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the Keras config """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'data_format'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span><span class="grouping">}</span>
        <span class="identifier">base_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="identifier">_GlobalPooling2D</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">base_config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="invalid">G</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">b</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">M</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">P</span><span class="invalid">o</span><span class="invalid">o</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="int-literal">2</span><span class="invalid">D</span><span class="grouping">(</span><span class="identifier">_GlobalPooling2D</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Global minimum pooling operation for spatial data. """</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""This is where the layer's logic lives.

        Parameters
        ----------
        inputs: tensor
            Input tensor, or list/tuple of input tensors
        kwargs: dict
            Additional keyword arguments

        Returns
        -------
        tensor
            A tensor or list/tuple of tensors
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_last'</span><span class="punctuation">:</span>
            <span class="identifier">pooled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">pooled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">pooled</span>


<span class="keyword">class</span> <span class="invalid">G</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">b</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">S</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">D</span><span class="invalid">e</span><span class="invalid">v</span><span class="invalid">P</span><span class="invalid">o</span><span class="invalid">o</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="int-literal">2</span><span class="invalid">D</span><span class="grouping">(</span><span class="identifier">_GlobalPooling2D</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Global standard deviation pooling operation for spatial data. """</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""This is where the layer's logic lives.

        Parameters
        ----------
        inputs: tensor
            Input tensor, or list/tuple of input tensors
        kwargs: dict
            Additional keyword arguments

        Returns
        -------
        tensor
            A tensor or list/tuple of tensors
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_last'</span><span class="punctuation">:</span>
            <span class="identifier">pooled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">pooled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">pooled</span>


<span class="keyword">class</span> <span class="identifier">L2_normalize</span><span class="grouping">(</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=invalid-name</span>
    <span class="comment">""" Normalizes a tensor w.r.t. the L2 norm alongside the specified axis.

    Parameters
    ----------
    axis: int
        The axis to perform normalization across
    kwargs: dict
        The standard Keras Layer keyword arguments (if any)
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span> <span class="arithmetic-assignment">=</span> <span class="identifier">axis</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="identifier">L2_normalize</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=arguments-differ</span>
        <span class="comment">"""This is where the layer's logic lives.

        Parameters
        ----------
        inputs: tensor
            Input tensor, or list/tuple of input tensors
        kwargs: dict
            Additional keyword arguments

        Returns
        -------
        tensor
            A tensor or list/tuple of tensors
        """</span>
        <span class="keyword">return</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">l2_normalize</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns the config of the layer.

        A layer config is a Python dictionary (serializable) containing the configuration of a
        layer. The same layer can be reinstated later (without its trained weights) from this
        configuration.

        The configuration of a layer does not include connectivity information, nor the layer
        class name. These are handled by `Network` (one layer of abstraction above).

        Returns
        --------
        dict
            A python dictionary containing the layer configuration
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="identifier">L2_normalize</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"axis"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span>
        <span class="keyword">return</span> <span class="identifier">config</span>


<span class="keyword">class</span> <span class="identifier">Swish</span><span class="grouping">(</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Swish Activation Layer implementation for Keras.

    Parameters
    ----------
    beta: float, optional
        The beta value to apply to the activation function. Default: `1.0`
    kwargs: dict
        The standard Keras Layer keyword arguments (if any)

    References
    -----------
    Swish: a Self-Gated Activation Function: https://arxiv.org/abs/1710.05941v1
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">beta</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">beta</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=arguments-differ</span>
        <span class="comment">""" Call the Swish Activation function.

        Parameters
        ----------
        inputs: tensor
            Input tensor, or list/tuple of input tensors
        """</span>
        <span class="keyword">if</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"amd"</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">inputs</span> <span class="arithmetic-operator">*</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">sigmoid</span><span class="grouping">(</span><span class="identifier">inputs</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span><span class="grouping">)</span>
        <span class="comment"># Native TF Implementation has more memory-efficient gradients</span>
        <span class="keyword">return</span> <span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">swish</span><span class="grouping">(</span><span class="identifier">inputs</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns the config of the layer.

        Adds the :attr:`beta` to config.

        Returns
        --------
        dict
            A python dictionary containing the layer configuration
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"beta"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span>
        <span class="keyword">return</span> <span class="identifier">config</span>


<span class="comment"># Update layers into Keras custom objects</span>
<span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">obj</span> <span class="relational-operator">in</span> <span class="identifier">inspect</span><span class="punctuation">.</span><span class="identifier">getmembers</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">modules</span><span class="grouping">[</span><span class="identifier">__name__</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">inspect</span><span class="punctuation">.</span><span class="identifier">isclass</span><span class="grouping">(</span><span class="identifier">obj</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">obj</span><span class="punctuation">.</span><span class="identifier">__module__</span> <span class="relational-operator">==</span> <span class="identifier">__name__</span><span class="punctuation">:</span>
        <span class="identifier">get_custom_objects</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">{</span><span class="identifier">name</span><span class="punctuation">:</span> <span class="identifier">obj</span><span class="grouping">}</span><span class="grouping">)</span>

    </pre>
  </body>
</html>