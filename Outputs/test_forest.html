<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
Testing for the forest module (sklearn.ensemble.forest).
"""</span>

<span class="comment"># Authors: Gilles Louppe,</span>
<span class="comment">#          Brian Holt,</span>
<span class="comment">#          Andreas Mueller,</span>
<span class="comment">#          Arnaud Joly</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">pickle</span>
<span class="keyword">import</span> <span class="identifier">math</span>
<span class="keyword">from</span> <span class="identifier">collections</span> <span class="keyword">import</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span>
<span class="keyword">import</span> <span class="identifier">itertools</span>
<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">combinations</span>
<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">product</span>
<span class="keyword">from</span> <span class="identifier">typing</span> <span class="keyword">import</span> <span class="identifier">Dict</span><span class="punctuation">,</span> <span class="identifier">Any</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csr_matrix</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csc_matrix</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">coo_matrix</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">special</span> <span class="keyword">import</span> <span class="identifier">comb</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">import</span> <span class="identifier">joblib</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">_convert_container</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">skip_if_no_parallel</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="identifier">parse_version</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">NotFittedError</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">datasets</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">TruncatedSVD</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">ExtraTreesClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">ExtraTreesRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">RandomForestClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">RandomForestRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">RandomTreesEmbedding</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GridSearchCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">LinearSVC</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_classes</span> <span class="keyword">import</span> <span class="identifier">SPARSE_SPLITTERS</span>


<span class="comment"># toy sample</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
<span class="identifier">T</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span>
<span class="identifier">true_result</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>

<span class="comment"># Larger classification sample used for testing feature importances</span>
<span class="identifier">X_large</span><span class="punctuation">,</span> <span class="identifier">y_large</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_classification</span><span class="grouping">(</span>
    <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_redundant</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
    <span class="identifier">n_repeated</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="comment"># also load the iris dataset</span>
<span class="comment"># and randomly permute it</span>
<span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">perm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
<span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>
<span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>

<span class="comment"># Make regression dataset</span>
<span class="identifier">X_reg</span><span class="punctuation">,</span> <span class="identifier">y_reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

<span class="comment"># also make a hastie_10_2 dataset</span>
<span class="identifier">hastie_X</span><span class="punctuation">,</span> <span class="identifier">hastie_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
<span class="identifier">hastie_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hastie_X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>

<span class="comment"># Get the default backend in joblib to test parallelism and interaction with</span>
<span class="comment"># different backends</span>
<span class="invalid">D</span><span class="invalid">E</span><span class="invalid">F</span><span class="invalid">A</span><span class="invalid">U</span><span class="invalid">L</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">J</span><span class="invalid">O</span><span class="invalid">B</span><span class="invalid">L</span><span class="invalid">I</span><span class="invalid">B</span><span class="invalid">_</span><span class="invalid">B</span><span class="invalid">A</span><span class="invalid">C</span><span class="invalid">K</span><span class="invalid">E</span><span class="invalid">N</span><span class="invalid">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">parallel</span><span class="punctuation">.</span><span class="identifier">get_active_backend</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">__class__</span>

<span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
    <span class="string-literal">"ExtraTreesClassifier"</span><span class="punctuation">:</span> <span class="identifier">ExtraTreesClassifier</span><span class="punctuation">,</span>
    <span class="string-literal">"RandomForestClassifier"</span><span class="punctuation">:</span> <span class="identifier">RandomForestClassifier</span><span class="punctuation">,</span>
<span class="grouping">}</span>

<span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
    <span class="string-literal">"ExtraTreesRegressor"</span><span class="punctuation">:</span> <span class="identifier">ExtraTreesRegressor</span><span class="punctuation">,</span>
    <span class="string-literal">"RandomForestRegressor"</span><span class="punctuation">:</span> <span class="identifier">RandomForestRegressor</span><span class="punctuation">,</span>
<span class="grouping">}</span>

<span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">T</span><span class="invalid">R</span><span class="invalid">A</span><span class="invalid">N</span><span class="invalid">S</span><span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">M</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
    <span class="string-literal">"RandomTreesEmbedding"</span><span class="punctuation">:</span> <span class="identifier">RandomTreesEmbedding</span><span class="punctuation">,</span>
<span class="grouping">}</span>

<span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">:</span> <span class="identifier">Dict</span><span class="grouping">[</span><span class="identifier">str</span><span class="punctuation">,</span> <span class="identifier">Any</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">T</span><span class="invalid">R</span><span class="invalid">A</span><span class="invalid">N</span><span class="invalid">S</span><span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">M</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>

<span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">:</span> <span class="identifier">Dict</span><span class="grouping">[</span><span class="identifier">str</span><span class="punctuation">,</span> <span class="identifier">Any</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_classification_toy</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check classification on a toy dataset."""</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_result</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="int-literal">10</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_result</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="int-literal">10</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span>

    <span class="comment"># also test apply</span>
    <span class="identifier">leaf_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">leaf_indices</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_estimators</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_classification_toy</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_classification_toy</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_iris_criterion</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check consistency on dataset iris.</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.9</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="string-literal">"Failed with criterion %s and score = %f"</span>
                         <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">score</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="punctuation">,</span>
                           <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="string-literal">"Failed with criterion %s and score = %f"</span>
                         <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">score</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'criterion'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="string-literal">"gini", "entropy"</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_iris</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_iris_criterion</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_regression_criterion</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check consistency on regression dataset.</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">R</span><span class="invalid">e</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">R</span><span class="invalid">e</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_reg</span><span class="punctuation">,</span> <span class="identifier">y_reg</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_reg</span><span class="punctuation">,</span> <span class="identifier">y_reg</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.93</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="string-literal">"Failed with max_features=None, criterion %s "</span>
                          <span class="string-literal">"and score = %f"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">score</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">R</span><span class="invalid">e</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="punctuation">,</span>
                          <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_reg</span><span class="punctuation">,</span> <span class="identifier">y_reg</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_reg</span><span class="punctuation">,</span> <span class="identifier">y_reg</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.92</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="string-literal">"Failed with max_features=6, criterion %s "</span>
                          <span class="string-literal">"and score = %f"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">score</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'criterion'</span><span class="punctuation">,</span> <span class="grouping">(</span>
    <span class="string-literal">"squared_error", "absolute_error", "friedman_mse"</span>
<span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_regression</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_regression_criterion</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_regressor_attributes</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Regression models should not have a classes_ attribute.</span>
    <span class="identifier">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">r</span><span class="punctuation">,</span> <span class="string-literal">"classes_"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">r</span><span class="punctuation">,</span> <span class="string-literal">"n_classes_"</span><span class="grouping">)</span>

    <span class="identifier">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">r</span><span class="punctuation">,</span> <span class="string-literal">"classes_"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">r</span><span class="punctuation">,</span> <span class="string-literal">"n_classes_"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_regressor_attributes</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_regressor_attributes</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_probability</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Predict probabilities.</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="identifier">divide</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ignore"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_probability</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_probability</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_importances</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">tolerance</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># cast as dype</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_large</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_large</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span>

    <span class="comment"># The forest estimator can detect that only the first 3 features of the</span>
    <span class="comment"># dataset are informative:</span>
    <span class="identifier">n_important</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">10</span>
    <span class="keyword">assert</span> <span class="identifier">n_important</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.1</span><span class="grouping">)</span>

    <span class="comment"># Check with parallel</span>
    <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">l</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">l</span><span class="grouping">)</span>

    <span class="comment"># Check with sample weights</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span> <span class="relational-operator">&gt;=</span> <span class="float-literal">0.0</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">scale</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                              <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">scale</span> <span class="arithmetic-operator">*</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>
        <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">b</span><span class="invalid">i</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-operator">-</span> <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">b</span><span class="invalid">i</span><span class="invalid">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">tolerance</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'dtype'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">'name, criterion'</span><span class="punctuation">,</span>
        <span class="identifier">itertools</span><span class="punctuation">.</span><span class="identifier">chain</span><span class="grouping">(</span><span class="identifier">product</span><span class="grouping">(</span><span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">,</span>
                                <span class="grouping">[</span><span class="string-literal">"gini", "entropy"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">product</span><span class="grouping">(</span><span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">,</span>
                                <span class="grouping">[</span>
                                 <span class="string-literal">"squared_error"</span><span class="punctuation">,</span>
                                 <span class="string-literal">"friedman_mse"</span><span class="punctuation">,</span>
                                 <span class="string-literal">"absolute_error"</span>
                                 <span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_importances</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">tolerance</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.01</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span> <span class="logical-operator">and</span> <span class="identifier">criterion</span> <span class="relational-operator">==</span> <span class="string-literal">"absolute_error"</span><span class="punctuation">:</span>
        <span class="identifier">tolerance</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.05</span>
    <span class="identifier">check_importances</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">tolerance</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_importances_asymptotic</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check whether variable importances of totally randomized trees</span>
    <span class="comment"># converge towards their theoretical values (See Louppe et al,</span>
    <span class="comment"># Understanding variable importances in forests of randomized trees, 2013).</span>

    <span class="keyword">def</span> <span class="identifier">binomial</span><span class="grouping">(</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="int-literal">0</span> <span class="keyword">if</span> <span class="identifier">k</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span> <span class="logical-operator">or</span> <span class="identifier">k</span> <span class="relational-operator">&gt;</span> <span class="identifier">n</span> <span class="keyword">else</span> <span class="identifier">comb</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">exact</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">entropy</span><span class="grouping">(</span><span class="identifier">samples</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">samples</span><span class="grouping">)</span>
        <span class="identifier">entropy</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>

        <span class="keyword">for</span> <span class="identifier">count</span> <span class="relational-operator">in</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">samples</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">count</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span>
            <span class="keyword">if</span> <span class="identifier">p</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="identifier">entropy</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">p</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log2</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">entropy</span>

    <span class="keyword">def</span> <span class="identifier">mdi_importance</span><span class="grouping">(</span><span class="identifier">X_m</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>

        <span class="identifier">features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">features</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="identifier">X_m</span><span class="grouping">)</span>
        <span class="identifier">values</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">]</span>

        <span class="identifier">imp</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>

        <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># Weight of each B of size k</span>
            <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">binomial</span><span class="grouping">(</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">n_features</span> <span class="arithmetic-operator">-</span> <span class="identifier">k</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="comment"># For all B of size k</span>
            <span class="keyword">for</span> <span class="identifier">B</span> <span class="relational-operator">in</span> <span class="identifier">combinations</span><span class="grouping">(</span><span class="identifier">features</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># For all values B=b</span>
                <span class="keyword">for</span> <span class="identifier">b</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="grouping">[</span><span class="identifier">values</span><span class="grouping">[</span><span class="identifier">B</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">mask_b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>

                    <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="identifier">mask_b</span> <span class="bitwise-assignment">&=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">b</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span>

                    <span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">mask_b</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">mask_b</span><span class="grouping">]</span>
                    <span class="identifier">n_samples_b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">)</span>

                    <span class="keyword">if</span> <span class="identifier">n_samples_b</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                        <span class="identifier">children</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

                        <span class="keyword">for</span> <span class="identifier">xi</span> <span class="relational-operator">in</span> <span class="identifier">values</span><span class="grouping">[</span><span class="identifier">X_m</span><span class="grouping">]</span><span class="punctuation">:</span>
                            <span class="identifier">mask_xi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">X_m</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">xi</span>
                            <span class="identifier">children</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">y_</span><span class="grouping">[</span><span class="identifier">mask_xi</span><span class="grouping">]</span><span class="grouping">)</span>

                        <span class="identifier">imp</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">(</span><span class="identifier">coef</span>
                                <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples_b</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span><span class="grouping">)</span>  <span class="comment"># P(B=b)</span>
                                <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">entropy</span><span class="grouping">(</span><span class="identifier">y_</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
                                   <span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">entropy</span><span class="grouping">(</span><span class="identifier">c</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">c</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples_b</span>
                                        <span class="keyword">for</span> <span class="identifier">c</span> <span class="relational-operator">in</span> <span class="identifier">children</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">imp</span>

    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="comment"># Compute true importances</span>
    <span class="identifier">true_importances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">true_importances</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mdi_importance</span><span class="grouping">(</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Estimate importances with totally randomized trees</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ExtraTreesClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span>
                               <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">"entropy"</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">compute_feature_importances</span><span class="grouping">(</span><span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
                      <span class="keyword">for</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_estimators</span>

    <span class="comment"># Check correctness</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">entropy</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">true_importances</span> <span class="arithmetic-operator">-</span> <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.01</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_unfitted_feature_importances</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"This {} instance is not fitted yet. Call 'fit' with "</span>
               <span class="string-literal">"appropriate arguments before using this estimator."</span>
               <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">getattr</span><span class="grouping">(</span><span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'feature_importances_'</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"ForestClassifier"</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"X_type", ["array", "sparse_csr", "sparse_csc"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"X, y, lower_bound_accuracy"</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="grouping">(</span>
            <span class="arithmetic-operator">*</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_classification</span><span class="grouping">(</span>
                <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">300</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
            <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="float-literal">0.9</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="arithmetic-operator">*</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_classification</span><span class="grouping">(</span>
                <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
            <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="float-literal">0.65</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">0.65</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="arithmetic-operator">*</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_multilabel_classification</span><span class="grouping">(</span>
                <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">300</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
            <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="float-literal">0.18</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_forest_classifier_oob</span><span class="grouping">(</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">X_type</span><span class="punctuation">,</span> <span class="identifier">lower_bound_accuracy</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that OOB score is close to score on a test set."""</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_convert_container</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">constructor_name</span><span class="arithmetic-assignment">=</span><span class="identifier">X_type</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span>
        <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
    <span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"oob_score_"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"oob_decision_function_"</span><span class="grouping">)</span>

    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">test_score</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">test_score</span> <span class="arithmetic-operator">-</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">oob_score_</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">0.1</span>
    <span class="keyword">assert</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">oob_score_</span> <span class="relational-operator">&gt;=</span> <span class="identifier">lower_bound_accuracy</span>

    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"oob_score_"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"oob_prediction_"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"oob_decision_function_"</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">expected_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">expected_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">oob_decision_function_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">expected_shape</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"ForestRegressor"</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"X_type", ["array", "sparse_csr", "sparse_csc"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"X, y, lower_bound_r2"</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="grouping">(</span>
            <span class="arithmetic-operator">*</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_regression</span><span class="grouping">(</span>
                <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
            <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="float-literal">0.7</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="arithmetic-operator">*</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_regression</span><span class="grouping">(</span>
                <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
            <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="float-literal">0.55</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_forest_regressor_oob</span><span class="grouping">(</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">R</span><span class="invalid">e</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">X_type</span><span class="punctuation">,</span> <span class="identifier">lower_bound_r2</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that forest-based regressor provide an OOB score close to the
    score on a test set."""</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_convert_container</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">constructor_name</span><span class="arithmetic-assignment">=</span><span class="identifier">X_type</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="identifier">regressor</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">R</span><span class="invalid">e</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span>
        <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
    <span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="string-literal">"oob_score_"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="string-literal">"oob_prediction_"</span><span class="grouping">)</span>

    <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">test_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">test_score</span> <span class="arithmetic-operator">-</span> <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">oob_score_</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">0.1</span>
    <span class="keyword">assert</span> <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">oob_score_</span> <span class="relational-operator">&gt;=</span> <span class="identifier">lower_bound_r2</span>

    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="string-literal">"oob_score_"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="string-literal">"oob_prediction_"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="string-literal">"oob_decision_function_"</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">expected_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">expected_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">ndim</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">oob_prediction_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">expected_shape</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"ForestEstimator"</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_forest_oob_warning</span><span class="grouping">(</span><span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that a warning is raised when not enough estimator and the OOB
    estimates will be inacurrate."""</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span>
        <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Some inputs do not have OOB scores"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"ForestEstimator"</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"X, y, params, err_msg"</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">"oob_score": True, "bootstrap"</span><span class="punctuation">:</span> <span class="bool-literal">False</span><span class="grouping">}</span><span class="punctuation">,</span>
         <span class="string-literal">"Out of bag estimation only available if bootstrap=True"</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">{</span><span class="string-literal">"oob_score": True, "bootstrap"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span><span class="punctuation">,</span>
         <span class="string-literal">"The type of target cannot be used to compute OOB estimates"</span><span class="grouping">)</span>
    <span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_forest_oob_error</span><span class="grouping">(</span><span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"oob_score"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_random_trees_embedding_raise_error_oob</span><span class="grouping">(</span><span class="identifier">oob_score</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"got an unexpected keyword argument"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">RandomTreesEmbedding</span><span class="grouping">(</span><span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="identifier">oob_score</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotImplementedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"OOB score not supported"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">RandomTreesEmbedding</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">_set_oob_score_and_attributes</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_gridsearch</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'n_estimators': (1, 2), 'max_depth'</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_gridsearch</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that base trees can be grid-searched.</span>
    <span class="identifier">check_gridsearch</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_parallel</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check parallel computations in classification"""</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">10</span>

    <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y1</span> <span class="arithmetic-assignment">=</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y1</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_parallel</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="keyword">elif</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_reg</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_reg</span>

    <span class="identifier">check_parallel</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_pickle</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check pickability.</span>

    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">obj</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">obj</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">obj</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">pickle_object</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">obj</span><span class="grouping">)</span>

    <span class="identifier">obj2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">pickle_object</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">obj2</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">obj</span><span class="punctuation">.</span><span class="identifier">__class__</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">obj2</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">==</span> <span class="identifier">score2</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pickle</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="keyword">elif</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_reg</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_reg</span>

    <span class="identifier">check_pickle</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_multioutput</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check estimators on multi-output problems.</span>

    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="identifier">divide</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ignore"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">proba</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
            <span class="keyword">assert</span> <span class="identifier">proba</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">proba</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>

            <span class="identifier">log_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">log_proba</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
            <span class="keyword">assert</span> <span class="identifier">log_proba</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">log_proba</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_multioutput</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_multioutput</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_multioutput_string</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check estimators on multi-output problems with string outputs.</span>

    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">"red", "blue"], ["red", "blue"], ["red", "blue"</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="string-literal">"green", "green"], ["green", "green"], ["green", "green"</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="string-literal">"red", "purple"], ["red", "purple"], ["red", "purple"</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="string-literal">"green", "yellow"], ["green", "yellow"], ["green", "yellow"</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">"red", "blue"], ["green", "green"</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="grouping">[</span><span class="string-literal">"red", "purple"], ["green", "yellow"</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="identifier">divide</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ignore"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">proba</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
        <span class="keyword">assert</span> <span class="identifier">proba</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">proba</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>

        <span class="identifier">log_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">log_proba</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
        <span class="keyword">assert</span> <span class="identifier">log_proba</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">log_proba</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_classes_shape</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that n_classes_ and classes_ have proper shape.</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="comment"># Classification, single output</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_classes_</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Classification, multi-output</span>
    <span class="identifier">_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_classes_</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_classes_shape</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_classes_shape</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_random_trees_dense_type</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the `sparse_output` parameter of RandomTreesEmbedding</span>
    <span class="comment"># works by returning a dense array.</span>

    <span class="comment"># Create the RTE with sparse=False</span>
    <span class="identifier">hasher</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomTreesEmbedding</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">sparse_output</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_circles</span><span class="grouping">(</span><span class="identifier">factor</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hasher</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Assert that type is ndarray, not scipy.sparse.csr.csr_matrix</span>
    <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span>


<span class="keyword">def</span> <span class="identifier">test_random_trees_dense_equal</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the `sparse_output` parameter of RandomTreesEmbedding</span>
    <span class="comment"># works by returning the same array for both argument values.</span>

    <span class="comment"># Create the RTEs</span>
    <span class="identifier">hasher_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomTreesEmbedding</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">sparse_output</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">hasher_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomTreesEmbedding</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">sparse_output</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                         <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_circles</span><span class="grouping">(</span><span class="identifier">factor</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>
    <span class="identifier">X_transformed_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hasher_dense</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_transformed_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hasher_sparse</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Assert that dense and sparse hashers have same array.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_transformed_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_transformed_dense</span><span class="grouping">)</span>


<span class="comment"># Ignore warnings from switching to more power iterations in randomized_svd</span>
<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">test_random_hasher</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test random forest hashing on circles dataset</span>
    <span class="comment"># make sure that it is linearly separable.</span>
    <span class="comment"># even after projected to two SVD dimensions</span>
    <span class="comment"># Note: Not all random_states produce perfect results.</span>
    <span class="identifier">hasher</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomTreesEmbedding</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_circles</span><span class="grouping">(</span><span class="identifier">factor</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hasher</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># test fit and transform:</span>
    <span class="identifier">hasher</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomTreesEmbedding</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">hasher</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># one leaf active per data point per forest</span>
    <span class="keyword">assert</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">hasher</span><span class="punctuation">.</span><span class="identifier">n_estimators</span><span class="grouping">)</span>
    <span class="identifier">svd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">X_reduced</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="grouping">)</span>
    <span class="identifier">linear_clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">linear_clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_reduced</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">linear_clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_reduced</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">.</span>


<span class="keyword">def</span> <span class="identifier">test_random_hasher_sparse_data</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_multilabel_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">hasher</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomTreesEmbedding</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hasher</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_transformed_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hasher</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_transformed_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_parallel_train</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">12321</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">80</span><span class="punctuation">,</span> <span class="int-literal">30</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span>

    <span class="identifier">clfs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">n_jobs</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">12345</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">n_jobs</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">32</span><span class="grouping">]</span>
    <span class="grouping">]</span>

    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">probas</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">clf</span> <span class="relational-operator">in</span> <span class="identifier">clfs</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">proba1</span><span class="punctuation">,</span> <span class="identifier">proba2</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">probas</span><span class="punctuation">,</span> <span class="identifier">probas</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">proba1</span><span class="punctuation">,</span> <span class="identifier">proba2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_distribution</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">12321</span><span class="grouping">)</span>

    <span class="comment"># Single variable with 4 values</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="grouping">)</span>
    <span class="identifier">n_trees</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span>

    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ExtraTreesRegressor</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">n_trees</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">uniques</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="punctuation">:</span>
        <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"".join(("%d,%d/" % (f, int(t)) if f &gt;= 0 else "-"</span><span class="grouping">)</span>
                       <span class="keyword">for</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">feature</span><span class="punctuation">,</span>
                                       <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">uniques</span><span class="grouping">[</span><span class="identifier">tree</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

    <span class="identifier">uniques</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">count</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_trees</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="grouping">)</span>
                      <span class="keyword">for</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">count</span> <span class="relational-operator">in</span> <span class="identifier">uniques</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># On a single variable problem where X_0 has 4 equiprobable values, there</span>
    <span class="comment"># are 5 ways to build a random tree. The more compact (0,1/0,0/--0,2/--) of</span>
    <span class="comment"># them has probability 1/3 while the 4 others have probability 1/6.</span>

    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">uniques</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>
    <span class="keyword">assert</span> <span class="float-literal">0.20</span> <span class="relational-operator">&gt;</span> <span class="identifier">uniques</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>  <span class="comment"># Rough approximation of 1/6.</span>
    <span class="keyword">assert</span> <span class="float-literal">0.20</span> <span class="relational-operator">&gt;</span> <span class="identifier">uniques</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="float-literal">0.20</span> <span class="relational-operator">&gt;</span> <span class="identifier">uniques</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="float-literal">0.20</span> <span class="relational-operator">&gt;</span> <span class="identifier">uniques</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">uniques</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.3</span>
    <span class="keyword">assert</span> <span class="identifier">uniques</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="string-literal">"0,1/0,0/--0,2/--"</span>

    <span class="comment"># Two variables, one with 2 values, one with 3 values</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="grouping">)</span>

    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ExtraTreesRegressor</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">uniques</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="punctuation">:</span>
        <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"".join(("%d,%d/" % (f, int(t)) if f &gt;= 0 else "-"</span><span class="grouping">)</span>
                       <span class="keyword">for</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">feature</span><span class="punctuation">,</span>
                                       <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">uniques</span><span class="grouping">[</span><span class="identifier">tree</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

    <span class="identifier">uniques</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">count</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">count</span> <span class="relational-operator">in</span> <span class="identifier">uniques</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">uniques</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">8</span>


<span class="keyword">def</span> <span class="identifier">check_max_leaf_nodes_max_depth</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hastie_X</span><span class="punctuation">,</span> <span class="identifier">hastie_y</span>

    <span class="comment"># Test precedence of max_leaf_nodes over max_depth.</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                          <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_depth</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_depth</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_max_leaf_nodes_max_depth</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_max_leaf_nodes_max_depth</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_min_samples_split</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hastie_X</span><span class="punctuation">,</span> <span class="identifier">hastie_y</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="comment"># test boundary value</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">node_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span> <span class="relational-operator">!=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="identifier">node_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="grouping">[</span><span class="identifier">node_idx</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">node_samples</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">(</span>
        <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">node_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span> <span class="relational-operator">!=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="identifier">node_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="grouping">[</span><span class="identifier">node_idx</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">node_samples</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">(</span>
        <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_min_samples_split</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_min_samples_split</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_min_samples_leaf</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hastie_X</span><span class="punctuation">,</span> <span class="identifier">hastie_y</span>

    <span class="comment"># Test if leaves contain more than leaf_count training examples</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="comment"># test boundary value</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">node_counts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">out</span><span class="grouping">)</span>
    <span class="comment"># drop inner nodes</span>
    <span class="identifier">leaf_count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_counts</span><span class="grouping">[</span><span class="identifier">node_counts</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">leaf_count</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.25</span><span class="punctuation">,</span> <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">node_counts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">out</span><span class="grouping">)</span>
    <span class="comment"># drop inner nodes</span>
    <span class="identifier">leaf_count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_counts</span><span class="grouping">[</span><span class="identifier">node_counts</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">leaf_count</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.25</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">(</span>
        <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_min_samples_leaf</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_min_samples_leaf</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_min_weight_fraction_leaf</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hastie_X</span><span class="punctuation">,</span> <span class="identifier">hastie_y</span>

    <span class="comment"># Test if leaves contain at least min_weight_fraction_leaf of the</span>
    <span class="comment"># training set</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">total_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">weights</span><span class="grouping">)</span>

    <span class="comment"># test both DepthFirstTreeBuilder and BestFirstTreeBuilder</span>
    <span class="comment"># by setting max_leaf_nodes</span>
    <span class="keyword">for</span> <span class="identifier">frac</span> <span class="relational-operator">in</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">min_weight_fraction_leaf</span><span class="arithmetic-assignment">=</span><span class="identifier">frac</span><span class="punctuation">,</span> <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                              <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="string-literal">"RandomForest"</span> <span class="relational-operator">in</span> <span class="identifier">name</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">bootstrap</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>

        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="grouping">)</span>
        <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">node_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">out</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="grouping">)</span>
        <span class="comment"># drop inner nodes</span>
        <span class="identifier">leaf_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_weights</span><span class="grouping">[</span><span class="identifier">node_weights</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">leaf_weights</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span>
            <span class="identifier">total_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_weight_fraction_leaf</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
                <span class="string-literal">"Failed with {0} min_weight_fraction_leaf={1}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                    <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_weight_fraction_leaf</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_min_weight_fraction_leaf</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_min_weight_fraction_leaf</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_sparse_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="identifier">dense</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">sparse</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dense</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span> <span class="logical-operator">or</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dense</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span>
                                  <span class="identifier">dense</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">dense</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">dense</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">T</span><span class="invalid">R</span><span class="invalid">A</span><span class="invalid">N</span><span class="invalid">S</span><span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">M</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">dense</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">dense</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'sparse_matrix'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="identifier">csr_matrix</span><span class="punctuation">,</span> <span class="identifier">csc_matrix</span><span class="punctuation">,</span> <span class="identifier">coo_matrix</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sparse_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">sparse_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_multilabel_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                                   <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="grouping">)</span>

    <span class="identifier">check_sparse_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sparse_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_memory_layout</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that it works no matter the memory layout</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="comment"># Nothing</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># C-order</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"C"</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># F-order</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"F"</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Contiguous</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">u</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">base_estimator</span><span class="punctuation">.</span><span class="identifier">splitter</span> <span class="relational-operator">in</span> <span class="identifier">SPARSE_SPLITTERS</span><span class="punctuation">:</span>
        <span class="comment"># csr matrix</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># csc_matrix</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># coo_matrix</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coo_matrix</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Strided</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'dtype'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_memory_layout</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_memory_layout</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_1d_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_2d</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_2d</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span> <span class="logical-operator">or</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_1d_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">X_2d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_1d_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_2d</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_class_weights</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check class_weights resemble sample_weights behavior.</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="comment"># Iris is balanced, so no effect expected for using 'balanced' weights</span>
    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>

    <span class="comment"># Make a multi-output problem with three copies of Iris</span>
    <span class="identifier">iris_multi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="comment"># Create user-defined weights that should balance over the outputs</span>
    <span class="identifier">clf3</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">}</span><span class="punctuation">,</span>
                                          <span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">}</span><span class="punctuation">,</span>
                                          <span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">}</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris_multi</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span> <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>
    <span class="comment"># Check against multi-output "balanced" which should also have no effect</span>
    <span class="identifier">clf4</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf4</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris_multi</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span> <span class="identifier">clf4</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>

    <span class="comment"># Inflate importance of class 1, check against user-defined weights</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="int-literal">100</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">100</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">}</span>
    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>

    <span class="comment"># Check that sample_weight and class_weight are multiplicative</span>
    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_class_weights</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_class_weights</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_class_weight_balanced_and_bootstrap_multi_output</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test class_weight works for multi-output"""</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">{</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">}</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>
    <span class="comment"># smoke test for balanced subsample</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced_subsample'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_class_weight_balanced_and_bootstrap_multi_output</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_class_weight_balanced_and_bootstrap_multi_output</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_class_weight_errors</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if class_weight raises errors and warnings when expected.</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="comment"># Invalid preset string</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'the larch'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>

    <span class="comment"># Warning warm_start with preset</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">warn_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"Warm-start fitting without increasing n_estimators does not fit new "</span>
        <span class="string-literal">"trees."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warn_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>

    <span class="comment"># Not a list or preset for multi-output</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>

    <span class="comment"># Incorrect length list for multi-output</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">{</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">}</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_class_weight_errors</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_class_weight_errors</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_warm_start</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if fitting incrementally with warm start gives a forest of the</span>
    <span class="comment"># right size and the same results as a normal fit.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hastie_X</span><span class="punctuation">,</span> <span class="identifier">hastie_y</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">est_ws</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="keyword">for</span> <span class="identifier">n_estimators</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">est_ws</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">est_ws</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">n_estimators</span><span class="punctuation">,</span>
                                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                                     <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">est_ws</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">n_estimators</span><span class="grouping">)</span>
        <span class="identifier">est_ws</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">est_ws</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_estimators</span>

    <span class="identifier">est_no_ws</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                                <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">est_no_ws</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="keyword">for</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">est_ws</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span>
            <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="keyword">for</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">est_no_ws</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est_ws</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">est_no_ws</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_warm_start</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_warm_start</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_warm_start_clear</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if fit clears state and grows a new forest when warm_start==False.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hastie_X</span><span class="punctuation">,</span> <span class="identifier">hastie_y</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">est_2</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>  <span class="comment"># inits state</span>
    <span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>  <span class="comment"># clears old state and equals est</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_warm_start_clear</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_warm_start_clear</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_warm_start_smaller_n_estimators</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if warm start second fit with smaller n_estimators raises error.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hastie_X</span><span class="punctuation">,</span> <span class="identifier">hastie_y</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_warm_start_smaller_n_estimators</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_warm_start_smaller_n_estimators</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_warm_start_equal_n_estimators</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if warm start with equal n_estimators does nothing and returns the</span>
    <span class="comment"># same forest and raises a warning.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hastie_X</span><span class="punctuation">,</span> <span class="identifier">hastie_y</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">est_2</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># Now est_2 equals est.</span>

    <span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">warn_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"Warm-start fitting without increasing n_estimators does not fit "</span>
        <span class="string-literal">"new trees."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warn_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># If we had fit the trees again we would have got a different forest as we</span>
    <span class="comment"># changed the random state.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_warm_start_equal_n_estimators</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_warm_start_equal_n_estimators</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_warm_start_oob</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the warm start computes oob score when asked.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hastie_X</span><span class="punctuation">,</span> <span class="identifier">hastie_y</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="comment"># Use 15 estimators to avoid 'some inputs do not have OOB scores' warning.</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">15</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">est_2</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">15</span><span class="grouping">)</span>
    <span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">est_2</span><span class="punctuation">,</span> <span class="string-literal">'oob_score_'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">oob_score_</span> <span class="relational-operator">==</span> <span class="identifier">est_2</span><span class="punctuation">.</span><span class="identifier">oob_score_</span>

    <span class="comment"># Test that oob_score is computed even if we don't need to train</span>
    <span class="comment"># additional trees.</span>
    <span class="identifier">est_3</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">15</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">est_3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">est_3</span><span class="punctuation">,</span> <span class="string-literal">'oob_score_'</span><span class="grouping">)</span>

    <span class="identifier">est_3</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">est_3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">oob_score_</span> <span class="relational-operator">==</span> <span class="identifier">est_3</span><span class="punctuation">.</span><span class="identifier">oob_score_</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_warm_start_oob</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_warm_start_oob</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_dtype_convert</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">15</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">ch</span> <span class="keyword">for</span> <span class="identifier">ch</span> <span class="relational-operator">in</span> <span class="string-literal">'ABCDEFGHIJKLMNOPQRSTU'</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_classes</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">result</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_decision_path</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hastie_X</span><span class="punctuation">,</span> <span class="identifier">hastie_y</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">I</span><span class="invalid">M</span><span class="invalid">A</span><span class="invalid">T</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">indicator</span><span class="punctuation">,</span> <span class="identifier">n_nodes_ptr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">decision_path</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_nodes_ptr</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">indicator</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">n_nodes_ptr</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">node_count</span> <span class="keyword">for</span> <span class="identifier">e</span> <span class="relational-operator">in</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Assert that leaves index are correct</span>
    <span class="identifier">leaves</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">est_id</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">leaves</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">leave_indicator</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">indicator</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">n_nodes_ptr</span><span class="grouping">[</span><span class="identifier">est_id</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">j</span><span class="grouping">]</span>
                           <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">leaves</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">est_id</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">leave_indicator</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_decision_path</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_decision_path</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_min_impurity_split</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if min_impurity_split of base estimators is set</span>
    <span class="comment"># Regression test for #8006</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">all_estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">RandomForestClassifier</span><span class="punctuation">,</span> <span class="identifier">RandomForestRegressor</span><span class="punctuation">,</span>
                      <span class="identifier">ExtraTreesClassifier</span><span class="punctuation">,</span> <span class="identifier">ExtraTreesRegressor</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">Estimator</span> <span class="relational-operator">in</span> <span class="identifier">all_estimators</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">min_impurity_split</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"min_impurity_decrease"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">min_impurity_split</span> <span class="relational-operator">==</span> <span class="float-literal">0.1</span>


<span class="keyword">def</span> <span class="identifier">test_min_impurity_decrease</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">all_estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">RandomForestClassifier</span><span class="punctuation">,</span> <span class="identifier">RandomForestRegressor</span><span class="punctuation">,</span>
                      <span class="identifier">ExtraTreesClassifier</span><span class="punctuation">,</span> <span class="identifier">ExtraTreesRegressor</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">Estimator</span> <span class="relational-operator">in</span> <span class="identifier">all_estimators</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">min_impurity_decrease</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="punctuation">:</span>
            <span class="comment"># Simply check if the parameter is passed on correctly. Tree tests</span>
            <span class="comment"># will suffice for the actual working of this param</span>
            <span class="keyword">assert</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">min_impurity_decrease</span> <span class="relational-operator">==</span> <span class="float-literal">0.1</span>


<span class="comment"># mypy error: Variable "DEFAULT_JOBLIB_BACKEND" is not valid type</span>
<span class="keyword">class</span> <span class="identifier">MyBackend</span><span class="grouping">(</span><span class="invalid">D</span><span class="invalid">E</span><span class="invalid">F</span><span class="invalid">A</span><span class="invalid">U</span><span class="invalid">L</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">J</span><span class="invalid">O</span><span class="invalid">B</span><span class="invalid">L</span><span class="invalid">I</span><span class="invalid">B</span><span class="invalid">_</span><span class="invalid">B</span><span class="invalid">A</span><span class="invalid">C</span><span class="invalid">K</span><span class="invalid">E</span><span class="invalid">N</span><span class="invalid">D</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># type: ignore</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">count</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">start_call</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">count</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
        <span class="keyword">return</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">start_call</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">register_parallel_backend</span><span class="grouping">(</span><span class="string-literal">'testing'</span><span class="punctuation">,</span> <span class="identifier">MyBackend</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">skipif</span><span class="grouping">(</span><span class="identifier">parse_version</span><span class="grouping">(</span><span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">__version__</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">'0.12'</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">reason</span><span class="arithmetic-assignment">=</span><span class="string-literal">'tests not yet supported in joblib &lt;0.12'</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">skip_if_no_parallel</span>
<span class="keyword">def</span> <span class="identifier">test_backend_respected</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">parallel_backend</span><span class="grouping">(</span><span class="string-literal">"testing"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="grouping">(</span><span class="identifier">ba</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">ba</span><span class="punctuation">.</span><span class="identifier">count</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>

    <span class="comment"># predict_proba requires shared memory. Ensure that's honored.</span>
    <span class="keyword">with</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">parallel_backend</span><span class="grouping">(</span><span class="string-literal">"testing"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="grouping">(</span><span class="identifier">ba</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">ba</span><span class="punctuation">.</span><span class="identifier">count</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>


<span class="keyword">def</span> <span class="identifier">test_forest_feature_importances_sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">15</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                               <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span>
                                 <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">math</span><span class="punctuation">.</span><span class="identifier">isclose</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">abs_tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_forest_degenerate_feature_importances</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># build a forest of single node trees. See #13636</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">gbr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestRegressor</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">gbr</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span>
                       <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'max_samples, exc_type, exc_msg'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e9</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="punctuation">,</span>
      <span class="string-literal">"`max_samples` must be in range 1 to 6 but got value 1000000000"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">"`max_samples` must be in range \(0, 1\) but got value 1.0"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">"`max_samples` must be in range \(0, 1\) but got value 2.0"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">"`max_samples` must be in range \(0, 1\) but got value 0.0"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">"`max_samples` must be in range \(0, 1\) but got value nan"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">"`max_samples` must be in range \(0, 1\) but got value inf"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">'str max_samples?!'</span><span class="punctuation">,</span> <span class="identifier">TypeError</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">"`max_samples` should be int or float, but got "</span>
      <span class="identifier">r</span><span class="string-literal">"type '\&lt;class 'str'\&gt;'"</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">TypeError</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">"`max_samples` should be int or float, but got type "</span>
      <span class="identifier">r</span><span class="string-literal">"'\&lt;class 'numpy.ndarray'\&gt;'"</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_max_samples_exceptions</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">max_samples</span><span class="punctuation">,</span> <span class="identifier">exc_type</span><span class="punctuation">,</span> <span class="identifier">exc_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check invalid `max_samples` values</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">I</span><span class="invalid">F</span><span class="invalid">I</span><span class="invalid">E</span><span class="invalid">R</span><span class="invalid">S</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">max_samples</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">exc_type</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">exc_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_forest_y_sparse</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"sparse multilabel-indicator for y is not supported."</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'ForestClass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">RandomForestClassifier</span><span class="punctuation">,</span> <span class="identifier">RandomForestRegressor</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_little_tree_with_small_max_samples</span><span class="grouping">(</span><span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10000</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10000</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>

    <span class="comment"># First fit with no restriction on max samples</span>
    <span class="identifier">est1</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span>
        <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
        <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
    <span class="grouping">)</span>

    <span class="comment"># Second fit with max samples restricted to just 2</span>
    <span class="identifier">est2</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span>
        <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
        <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
    <span class="grouping">)</span>

    <span class="identifier">est1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">tree1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est1</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tree_</span>
    <span class="identifier">tree2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tree_</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Tree without `max_samples` restriction should have more nodes"</span>
    <span class="keyword">assert</span> <span class="identifier">tree1</span><span class="punctuation">.</span><span class="identifier">node_count</span> <span class="relational-operator">&gt;</span> <span class="identifier">tree2</span><span class="punctuation">.</span><span class="identifier">node_count</span><span class="punctuation">,</span> <span class="identifier">msg</span>


<span class="comment"># FIXME: remove in 1.2</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"Estimator"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">ExtraTreesClassifier</span><span class="punctuation">,</span> <span class="identifier">ExtraTreesRegressor</span><span class="punctuation">,</span>
     <span class="identifier">RandomForestClassifier</span><span class="punctuation">,</span> <span class="identifier">RandomForestRegressor</span><span class="punctuation">,</span>
     <span class="identifier">RandomTreesEmbedding</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_n_features_deprecation</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that we raise the proper deprecation warning if accessing</span>
    <span class="comment"># `n_features_`.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"n_features_ was deprecated"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">n_features_</span>


<span class="comment"># TODO: Remove in v1.2</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"old_criterion, new_criterion"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="string-literal">"mse", "squared_error"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">"mae", "absolute_error"</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_criterion_deprecated</span><span class="grouping">(</span><span class="identifier">old_criterion</span><span class="punctuation">,</span> <span class="identifier">new_criterion</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">est1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestRegressor</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">old_criterion</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span>
                      <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"Criterion '{old_criterion}' was deprecated"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">est2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestRegressor</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">new_criterion</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">est1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Forest'</span><span class="punctuation">,</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_mse_criterion_object_segfault_smoke_test</span><span class="grouping">(</span><span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># This is a smoke test to ensure that passing a mutable criterion</span>
    <span class="comment"># does not cause a segfault when fitting with concurrent threads.</span>
    <span class="comment"># Non-regression test for:</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/12623</span>
    <span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_criterion</span> <span class="keyword">import</span> <span class="identifier">MSE</span>

    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_reg</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_outputs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">mse_criterion</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MSE</span><span class="grouping">(</span><span class="identifier">n_outputs</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="invalid">F</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">T</span><span class="invalid">_</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">G</span><span class="invalid">R</span><span class="invalid">E</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">O</span><span class="invalid">R</span><span class="invalid">S</span><span class="grouping">[</span><span class="invalid">F</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="grouping">]</span><span class="grouping">(</span>
        <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">mse_criterion</span>
    <span class="grouping">)</span>

    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_reg</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    </pre>
  </body>
</html>