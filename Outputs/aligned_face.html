<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Aligner for faceswap.py """</span>

<span class="keyword">import</span> <span class="identifier">logging</span>
<span class="keyword">from</span> <span class="identifier">threading</span> <span class="keyword">import</span> <span class="identifier">Lock</span>

<span class="keyword">import</span> <span class="identifier">cv2</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>


<span class="identifier">_MEAN_FACE</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.010086</span><span class="punctuation">,</span> <span class="float-literal">0.106454</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.085135</span><span class="punctuation">,</span> <span class="float-literal">0.038915</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.191003</span><span class="punctuation">,</span> <span class="float-literal">0.018748</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.300643</span><span class="punctuation">,</span> <span class="float-literal">0.034489</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.403270</span><span class="punctuation">,</span> <span class="float-literal">0.077391</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.596729</span><span class="punctuation">,</span> <span class="float-literal">0.077391</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.699356</span><span class="punctuation">,</span> <span class="float-literal">0.034489</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.808997</span><span class="punctuation">,</span> <span class="float-literal">0.018748</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.914864</span><span class="punctuation">,</span> <span class="float-literal">0.038915</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.989913</span><span class="punctuation">,</span> <span class="float-literal">0.106454</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.500000</span><span class="punctuation">,</span> <span class="float-literal">0.203352</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.500000</span><span class="punctuation">,</span> <span class="float-literal">0.307009</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.500000</span><span class="punctuation">,</span> <span class="float-literal">0.409805</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.500000</span><span class="punctuation">,</span> <span class="float-literal">0.515625</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.376753</span><span class="punctuation">,</span> <span class="float-literal">0.587326</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.435909</span><span class="punctuation">,</span> <span class="float-literal">0.609345</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.500000</span><span class="punctuation">,</span> <span class="float-literal">0.628106</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.564090</span><span class="punctuation">,</span> <span class="float-literal">0.609345</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.623246</span><span class="punctuation">,</span> <span class="float-literal">0.587326</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.131610</span><span class="punctuation">,</span> <span class="float-literal">0.216423</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.196995</span><span class="punctuation">,</span> <span class="float-literal">0.178758</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.275698</span><span class="punctuation">,</span> <span class="float-literal">0.179852</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.344479</span><span class="punctuation">,</span> <span class="float-literal">0.231733</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.270791</span><span class="punctuation">,</span> <span class="float-literal">0.245099</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.192616</span><span class="punctuation">,</span> <span class="float-literal">0.244077</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.655520</span><span class="punctuation">,</span> <span class="float-literal">0.231733</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.724301</span><span class="punctuation">,</span> <span class="float-literal">0.179852</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.803005</span><span class="punctuation">,</span> <span class="float-literal">0.178758</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.868389</span><span class="punctuation">,</span> <span class="float-literal">0.216423</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.807383</span><span class="punctuation">,</span> <span class="float-literal">0.244077</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.729208</span><span class="punctuation">,</span> <span class="float-literal">0.245099</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.264022</span><span class="punctuation">,</span> <span class="float-literal">0.780233</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.350858</span><span class="punctuation">,</span> <span class="float-literal">0.745405</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.438731</span><span class="punctuation">,</span> <span class="float-literal">0.727388</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.500000</span><span class="punctuation">,</span> <span class="float-literal">0.742578</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.561268</span><span class="punctuation">,</span> <span class="float-literal">0.727388</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.649141</span><span class="punctuation">,</span> <span class="float-literal">0.745405</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.735977</span><span class="punctuation">,</span> <span class="float-literal">0.780233</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.652032</span><span class="punctuation">,</span> <span class="float-literal">0.864805</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.566594</span><span class="punctuation">,</span> <span class="float-literal">0.902192</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.500000</span><span class="punctuation">,</span> <span class="float-literal">0.909281</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.433405</span><span class="punctuation">,</span> <span class="float-literal">0.902192</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.347967</span><span class="punctuation">,</span> <span class="float-literal">0.864805</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.300252</span><span class="punctuation">,</span> <span class="float-literal">0.784792</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.437969</span><span class="punctuation">,</span> <span class="float-literal">0.778746</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.500000</span><span class="punctuation">,</span> <span class="float-literal">0.785343</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.562030</span><span class="punctuation">,</span> <span class="float-literal">0.778746</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.699747</span><span class="punctuation">,</span> <span class="float-literal">0.784792</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">0.563237</span><span class="punctuation">,</span> <span class="float-literal">0.824182</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.500000</span><span class="punctuation">,</span> <span class="float-literal">0.831803</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.436763</span><span class="punctuation">,</span> <span class="float-literal">0.824182</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="identifier">_MEAN_FACE_3D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">4.056931</span><span class="punctuation">,</span> <span class="float-literal">-11.432347</span><span class="punctuation">,</span> <span class="float-literal">1.636229</span><span class="grouping">]</span><span class="punctuation">,</span>   <span class="comment"># 8 chin LL</span>
                          <span class="grouping">[</span><span class="float-literal">1.833492</span><span class="punctuation">,</span> <span class="float-literal">-12.542305</span><span class="punctuation">,</span> <span class="float-literal">4.061275</span><span class="grouping">]</span><span class="punctuation">,</span>   <span class="comment"># 7 chin L</span>
                          <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">-12.901019</span><span class="punctuation">,</span> <span class="float-literal">4.070434</span><span class="grouping">]</span><span class="punctuation">,</span>        <span class="comment"># 6 chin C</span>
                          <span class="grouping">[</span><span class="float-literal">-1.833492</span><span class="punctuation">,</span> <span class="float-literal">-12.542305</span><span class="punctuation">,</span> <span class="float-literal">4.061275</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 5 chin R</span>
                          <span class="grouping">[</span><span class="float-literal">-4.056931</span><span class="punctuation">,</span> <span class="float-literal">-11.432347</span><span class="punctuation">,</span> <span class="float-literal">1.636229</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 4 chin RR</span>
                          <span class="grouping">[</span><span class="float-literal">6.825897</span><span class="punctuation">,</span> <span class="float-literal">1.275284</span><span class="punctuation">,</span> <span class="float-literal">4.402142</span><span class="grouping">]</span><span class="punctuation">,</span>     <span class="comment"># 33 L eyebrow L</span>
                          <span class="grouping">[</span><span class="float-literal">1.330353</span><span class="punctuation">,</span> <span class="float-literal">1.636816</span><span class="punctuation">,</span> <span class="float-literal">6.903745</span><span class="grouping">]</span><span class="punctuation">,</span>     <span class="comment"># 29 L eyebrow R</span>
                          <span class="grouping">[</span><span class="float-literal">-1.330353</span><span class="punctuation">,</span> <span class="float-literal">1.636816</span><span class="punctuation">,</span> <span class="float-literal">6.903745</span><span class="grouping">]</span><span class="punctuation">,</span>    <span class="comment"># 34 R eyebrow L</span>
                          <span class="grouping">[</span><span class="float-literal">-6.825897</span><span class="punctuation">,</span> <span class="float-literal">1.275284</span><span class="punctuation">,</span> <span class="float-literal">4.402142</span><span class="grouping">]</span><span class="punctuation">,</span>    <span class="comment"># 38 R eyebrow R</span>
                          <span class="grouping">[</span><span class="float-literal">1.930245</span><span class="punctuation">,</span> <span class="float-literal">-5.060977</span><span class="punctuation">,</span> <span class="float-literal">5.914376</span><span class="grouping">]</span><span class="punctuation">,</span>    <span class="comment"># 54 nose LL</span>
                          <span class="grouping">[</span><span class="float-literal">0.746313</span><span class="punctuation">,</span> <span class="float-literal">-5.136947</span><span class="punctuation">,</span> <span class="float-literal">6.263227</span><span class="grouping">]</span><span class="punctuation">,</span>    <span class="comment"># 53 nose L</span>
                          <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">-5.485328</span><span class="punctuation">,</span> <span class="float-literal">6.76343</span><span class="grouping">]</span><span class="punctuation">,</span>          <span class="comment"># 52 nose C</span>
                          <span class="grouping">[</span><span class="float-literal">-0.746313</span><span class="punctuation">,</span> <span class="float-literal">-5.136947</span><span class="punctuation">,</span> <span class="float-literal">6.263227</span><span class="grouping">]</span><span class="punctuation">,</span>   <span class="comment"># 51 nose R</span>
                          <span class="grouping">[</span><span class="float-literal">-1.930245</span><span class="punctuation">,</span> <span class="float-literal">-5.060977</span><span class="punctuation">,</span> <span class="float-literal">5.914376</span><span class="grouping">]</span><span class="punctuation">,</span>   <span class="comment"># 50 nose RR</span>
                          <span class="grouping">[</span><span class="float-literal">5.311432</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">3.987654</span><span class="grouping">]</span><span class="punctuation">,</span>          <span class="comment"># 13 L eye L</span>
                          <span class="grouping">[</span><span class="float-literal">1.78993</span><span class="punctuation">,</span> <span class="float-literal">-0.091703</span><span class="punctuation">,</span> <span class="float-literal">4.413414</span><span class="grouping">]</span><span class="punctuation">,</span>     <span class="comment"># 17 L eye R</span>
                          <span class="grouping">[</span><span class="float-literal">-1.78993</span><span class="punctuation">,</span> <span class="float-literal">-0.091703</span><span class="punctuation">,</span> <span class="float-literal">4.413414</span><span class="grouping">]</span><span class="punctuation">,</span>    <span class="comment"># 25 R eye L</span>
                          <span class="grouping">[</span><span class="float-literal">-5.311432</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">3.987654</span><span class="grouping">]</span><span class="punctuation">,</span>         <span class="comment"># 21 R eye R</span>
                          <span class="grouping">[</span><span class="float-literal">2.774015</span><span class="punctuation">,</span> <span class="float-literal">-7.566103</span><span class="punctuation">,</span> <span class="float-literal">5.048531</span><span class="grouping">]</span><span class="punctuation">,</span>    <span class="comment"># 43 mouth L</span>
                          <span class="grouping">[</span><span class="float-literal">0.509714</span><span class="punctuation">,</span> <span class="float-literal">-7.056507</span><span class="punctuation">,</span> <span class="float-literal">6.566167</span><span class="grouping">]</span><span class="punctuation">,</span>    <span class="comment"># 42 mouth top L</span>
                          <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">-7.131772</span><span class="punctuation">,</span> <span class="float-literal">6.704956</span><span class="grouping">]</span><span class="punctuation">,</span>         <span class="comment"># 41 mouth top C</span>
                          <span class="grouping">[</span><span class="float-literal">-0.509714</span><span class="punctuation">,</span> <span class="float-literal">-7.056507</span><span class="punctuation">,</span> <span class="float-literal">6.566167</span><span class="grouping">]</span><span class="punctuation">,</span>   <span class="comment"># 40 mouth top R</span>
                          <span class="grouping">[</span><span class="float-literal">-2.774015</span><span class="punctuation">,</span> <span class="float-literal">-7.566103</span><span class="punctuation">,</span> <span class="float-literal">5.048531</span><span class="grouping">]</span><span class="punctuation">,</span>   <span class="comment"># 39 mouth R</span>
                          <span class="grouping">[</span><span class="float-literal">-0.589441</span><span class="punctuation">,</span> <span class="float-literal">-8.443925</span><span class="punctuation">,</span> <span class="float-literal">6.109526</span><span class="grouping">]</span><span class="punctuation">,</span>   <span class="comment"># 46 mouth bottom R</span>
                          <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">-8.601736</span><span class="punctuation">,</span> <span class="float-literal">6.097667</span><span class="grouping">]</span><span class="punctuation">,</span>         <span class="comment"># 45 mouth bottom C</span>
                          <span class="grouping">[</span><span class="float-literal">0.589441</span><span class="punctuation">,</span> <span class="float-literal">-8.443925</span><span class="punctuation">,</span> <span class="float-literal">6.109526</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>   <span class="comment"># 44 mouth bottom L</span>

<span class="identifier">_EXTRACT_RATIOS</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">legacy</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.375</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">head</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.625</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">get_matrix_scaling</span><span class="grouping">(</span><span class="identifier">matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Given a matrix, return the cv2 Interpolation method and inverse interpolation method for
    applying the matrix on an image.

    Parameters
    ----------
    matrix: :class:`numpy.ndarray`
        The transform matrix to return the interpolator for

    Returns
    -------
    tuple
        The interpolator and inverse interpolator for the given matrix. This will be (Cubic, Area)
        for an upscale matrix and (Area, Cubic) for a downscale matrix
    """</span>
    <span class="identifier">x_scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">matrix</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">matrix</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">matrix</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">matrix</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y_scale</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">matrix</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">matrix</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">matrix</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">matrix</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">x_scale</span>
    <span class="identifier">avg_scale</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">x_scale</span> <span class="arithmetic-operator">+</span> <span class="identifier">y_scale</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span>
    <span class="keyword">if</span> <span class="identifier">avg_scale</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">:</span>
        <span class="identifier">interpolators</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">interpolators</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span>
    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"interpolator: %s, inverse interpolator: %s"</span><span class="punctuation">,</span> <span class="identifier">interpolators</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">interpolators</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">interpolators</span>


<span class="keyword">def</span> <span class="identifier">transform_image</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">matrix</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Perform transformation on an image, applying the given size and padding to the matrix.

    Parameters
    ----------
    image: :class:`numpy.ndarray`
        The image to transform
    matrix: :class:`numpy.ndarray`
        The transformation matrix to apply to the image
    size: int
        The final size of the transformed image
    padding: int, optional
        The amount of padding to apply to the final image. Default: `0`

    Returns
    -------
    :class:`numpy.ndarray`
        The transformed image
    """</span>
    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"image shape: %s, matrix: %s, size: %s. padding: %s"</span><span class="punctuation">,</span>
                 <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">matrix</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="grouping">)</span>
    <span class="comment"># transform the matrix for size and padding</span>
    <span class="identifier">mat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">matrix</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">size</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">padding</span><span class="grouping">)</span>
    <span class="identifier">mat</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">padding</span>

    <span class="comment"># transform image</span>
    <span class="identifier">interpolators</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_matrix_scaling</span><span class="grouping">(</span><span class="identifier">mat</span><span class="grouping">)</span>
    <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">warpAffine</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">mat</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">flags</span><span class="arithmetic-assignment">=</span><span class="identifier">interpolators</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"transformed matrix: %s, final image shape: %s"</span><span class="punctuation">,</span> <span class="identifier">mat</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">retval</span>


<span class="keyword">class</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Class to align a face.

    Holds the aligned landmarks and face image, as well as associated matrices and information
    about an aligned face.

    Parameters
    ----------
    landmarks: :class:`numpy.ndarray`
        The original 68 point landmarks that pertain to the given image for this face
    image: :class:`numpy.ndarray`, optional
        The original frame that contains the face that is to be aligned. Pass `None` if the aligned
        face is not to be generated, and just the co-ordinates should be calculated.
    centering: ["legacy", "face", "head"], optional
        The type of extracted face that should be loaded. "legacy" places the nose in the center of
        the image (the original method for aligning). "face" aligns for the nose to be in the
        center of the face (top to bottom) but the center of the skull for left to right. "head"
        aligns for the center of the skull (in 3D space) being the center of the extracted image,
        with the crop holding the full head. Default: `"face"`
    size: int, optional
        The size in pixels, of each edge of the final aligned face. Default: `64`
    coverage_ratio: float, optional
        The amount of the aligned image to return. A ratio of 1.0 will return the full contents of
        the aligned image. A ratio of 0.5 will return an image of the given size, but will crop to
        the central 50%% of the image.
    dtype: str, optional
        Set a data type for the final face to be returned as. Passing ``None`` will return a face
        with the same data type as the original :attr:`image`. Default: ``None``
    is_aligned_face: bool, optional
        Indicates that the :attr:`image` is an aligned face rather than a frame.
        Default: ``False``
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"face"</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">64</span><span class="punctuation">,</span> <span class="identifier">coverage_ratio</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span>
                 <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">is_aligned</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Initializing: %s (image shape: %s, centering: '%s', size: %s, "</span>
                     <span class="string-literal">"coverage_ratio: %s, dtype: %s, is_aligned: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span>
                     <span class="identifier">image</span> <span class="keyword">if</span> <span class="identifier">image</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">centering</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">coverage_ratio</span><span class="punctuation">,</span>
                     <span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">is_aligned</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">landmarks</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">centering</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">size</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dtype</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_aligned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">is_aligned</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_matrices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">legacy</span><span class="arithmetic-assignment">=</span><span class="identifier">_umeyama</span><span class="grouping">(</span><span class="identifier">landmarks</span><span class="grouping">[</span><span class="int-literal">17</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">_MEAN_FACE</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                              <span class="identifier">face</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                              <span class="identifier">head</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_padding</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_padding_from_coverage</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">coverage_ratio</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_cache</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extract_face</span><span class="grouping">(</span><span class="identifier">image</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Initialized: %s (matrix: %s, padding: %s, face shape: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_matrices</span><span class="grouping">[</span><span class="string-literal">"legacy"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_padding</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">size</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The size (in pixels) of one side of the square extracted face image. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">padding</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The amount of padding (in pixels) that is applied to each side of the
        extracted face image for the selected extract type. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_padding</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">matrix</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray`: The 3x2 transformation matrix for extracting and aligning the
        core face area out of the original frame, with no padding or sizing applied. The returned
        matrix is offset for the given :attr:`centering`. """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_matrices</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_matrices</span><span class="grouping">[</span><span class="string-literal">"legacy"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">matrix</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pose</span><span class="punctuation">.</span><span class="identifier">offset</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">]</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_matrices</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">matrix</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"original matrix: %s, new matrix: %s", self._matrices["legacy"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">matrix</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_matrices</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_head_size</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The size of the full head extract image calculated from the required
        centering. """</span>
        <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"head_size"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"head_size"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"head_size"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_centered_size</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="punctuation">,</span>
                                                                                 <span class="string-literal">"head"</span><span class="punctuation">,</span>
                                                                                 <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"head_size"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">pose</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`lib.align.PoseEstimate`: The estimated pose in 3D space. """</span>
        <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"pose"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"pose"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">lms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">expand_dims</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_landmarks</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_matrices</span><span class="grouping">[</span><span class="string-literal">"legacy"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"pose"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PoseEstimate</span><span class="grouping">(</span><span class="identifier">lms</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"pose"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">adjusted_matrix</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray`: The 3x2 transformation matrix for extracting and aligning the
        core face area out of the original frame with padding and sizing applied. """</span>
        <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"adjusted_matrix"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"adjusted_matrix"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">matrix</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
                <span class="identifier">mat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">matrix</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">padding</span><span class="grouping">)</span>
                <span class="identifier">mat</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">padding</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"adjusted_matrix: %s"</span><span class="punctuation">,</span> <span class="identifier">mat</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"adjusted_matrix"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mat</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"adjusted_matrix"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">face</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray`: The aligned face at the given :attr:`size` at the specified
        :attr:`coverage` in the given :attr:`dtype`. If an :attr:`image` has not been provided
        then an the attribute will return ``None``. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">original_roi</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray`: The location of the extracted face box within the original
        frame. """</span>
        <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"original_roi"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"original_roi"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_points</span><span class="grouping">(</span><span class="identifier">roi</span><span class="punctuation">,</span> <span class="identifier">invert</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"int32"</span><span class="grouping">)</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"original roi: %s"</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"original_roi"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"original_roi"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">landmarks</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray`: The 68 point facial landmarks aligned to the extracted face
        box. """</span>
        <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"landmarks"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"landmarks"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">lms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_points</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_landmarks</span><span class="grouping">)</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"aligned landmarks: %s"</span><span class="punctuation">,</span> <span class="identifier">lms</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"landmarks"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lms</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"landmarks"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">interpolators</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" tuple: (`interpolator` and `reverse interpolator`) for the :attr:`adjusted matrix`. """</span>
        <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"interpolators"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"interpolators"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">interpolators</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_matrix_scaling</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">adjusted_matrix</span><span class="grouping">)</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"interpolators: %s"</span><span class="punctuation">,</span> <span class="identifier">interpolators</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"interpolators"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">interpolators</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"interpolators"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_set_cache</span><span class="grouping">(</span><span class="identifier">cls</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the cache items.

        Items are cached so that they are only created the first time they are called.
        Each item includes a threading lock to make cache creation thread safe.

        Returns
        -------
        dict
            The Aligned Face cache
        """</span>
        <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">pose</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">Lock</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">original_roi</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">Lock</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">landmarks</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">Lock</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">adjusted_matrix</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">Lock</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">interpolators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">Lock</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">head_size</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Lock</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">cropped_roi</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Lock</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">cropped_size</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Lock</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">cropped_slices</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Lock</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">transform_points</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">points</span><span class="punctuation">,</span> <span class="identifier">invert</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Perform transformation on a series of (x, y) co-ordinates in world space into
        aligned face space.

        Parameters
        ----------
        points: :class:`numpy.ndarray`
            The points to transform
        invert: bool, optional
            ``True`` to reverse the transformation (i.e. transform the points into world space from
            aligned face space). Default: ``False``

        Returns
        -------
        :class:`numpy.ndarray`
            The transformed points
        """</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">expand_dims</span><span class="grouping">(</span><span class="identifier">points</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">mat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">invertAffineTransform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">adjusted_matrix</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">invert</span> <span class="keyword">else</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">adjusted_matrix</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">retval</span><span class="punctuation">,</span> <span class="identifier">mat</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"invert: %s, Original points: %s, transformed points: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">invert</span><span class="punctuation">,</span> <span class="identifier">points</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">extract_face</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Extract the face from a source image and populate :attr:`face`. If an image is not
        provided then ``None`` is returned.

        Parameters
        ----------
        image: :class:`numpy.ndarray` or ``None``
            The original frame to extract the face from. ``None`` if the face should not be
            extracted

        Returns
        -------
        :class:`numpy.ndarray` or ``None``
            The extracted face at the given size, with the given coverage of the given dtype or
            ``None`` if no image has been provided.
        """</span>
        <span class="keyword">if</span> <span class="identifier">image</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"_extract_face called without a loaded image. Returning empty face."</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="none-literal">None</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_aligned</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span> <span class="relational-operator">!=</span> <span class="string-literal">"head"</span><span class="punctuation">:</span>  <span class="comment"># Crop out the sub face from full head</span>
            <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_convert_centering</span><span class="grouping">(</span><span class="identifier">image</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_aligned</span> <span class="logical-operator">and</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">:</span>  <span class="comment"># Resize the given aligned face</span>
            <span class="identifier">interp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span> <span class="keyword">if</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="keyword">else</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="identifier">interp</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_aligned</span><span class="punctuation">:</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transform_image</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">matrix</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">padding</span><span class="grouping">)</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">retval</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_dtype</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">retval</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_dtype</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">_convert_centering</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" When the face being loaded is pre-aligned, the loaded image will have 'head' centering
        so it needs to be cropped out to the appropriate centering.

        This function temporarily converts this object to a full head aligned face, extracts the
        sub-cropped face to the correct centering, reverse the sub crop and returns the cropped
        face.

        Parameters
        ----------
        image: :class:`numpy.ndarray`
            The original head-centered aligned image

        Returns
        -------
        :class:`numpy.ndarray`
            The aligned image with the correct centering
        """</span>
        <span class="comment"># Input image is sized up because of integer rounding</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"head_size: %s, image_size: %s, target_size: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_head_size</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_head_size</span> <span class="relational-operator">!=</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">interp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span> <span class="keyword">if</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_head_size</span> <span class="keyword">else</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span>
            <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_head_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_head_size</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="identifier">interp</span><span class="grouping">)</span>

        <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">slices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_cropped_slices</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">out</span><span class="grouping">[</span><span class="identifier">slices</span><span class="grouping">[</span><span class="string-literal">"out"][0], slices["out"][1], :] = image[slices["in"][0], slices["in"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Cropped from aligned extract: (centering: %s, in shape: %s, out shape: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">out</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_padding_from_coverage</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">coverage_ratio</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return the image padding for a face from coverage_ratio set against a
            pre-padded training image.

        Parameters
        ----------
        size: int
            The final size of the aligned image in pixels
        coverage_ratio: float
            The ratio of the final image to pad to

        Returns
        -------
        dict
            The padding required, in pixels for 'head', 'face' and 'legacy' face types
        """</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="identifier">_type</span><span class="punctuation">:</span> <span class="identifier">round</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">size</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">coverage_ratio</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">_EXTRACT_RATIOS</span><span class="grouping">[</span><span class="identifier">_type</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span>
                  <span class="keyword">for</span> <span class="identifier">_type</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"legacy", "face", "head"</span><span class="grouping">)</span><span class="grouping">}</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="identifier">retval</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">get_cropped_roi</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">centering</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain the region of interest within an aligned face set to centered coverage for
        an alternative centering

        Parameters
        ----------
        centering: ["legacy", "face"]
            The type of centering to obtain the region of interest for. "legacy" places the nose
            in the center of the image (the original method for aligning). "face" aligns for the
            nose to be in the center of the face (top to bottom) but the center of the skull for
            left to right.

        Returns
        -------
        :class:`numpy.ndarray`
            The (`left`, `top`, `right`, `bottom` location of the region of interest within an
            aligned face centered on the head for the given centering
        """</span>
        <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"cropped_roi"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">centering</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"cropped_roi"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="identifier">offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pose</span><span class="punctuation">.</span><span class="identifier">offset</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">centering</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>  <span class="comment"># legacy = 0.0</span>
                <span class="identifier">offset</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pose</span><span class="punctuation">.</span><span class="identifier">offset</span><span class="grouping">[</span><span class="string-literal">"head"</span><span class="grouping">]</span>
                <span class="identifier">offset</span> <span class="arithmetic-assignment">*=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_head_size</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_head_size</span> <span class="arithmetic-operator">*</span> <span class="identifier">_EXTRACT_RATIOS</span><span class="grouping">[</span><span class="string-literal">"head"</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

                <span class="identifier">center</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="identifier">offset</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_head_size</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"int32"</span><span class="grouping">)</span>
                <span class="identifier">padding</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>
                <span class="identifier">roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">center</span> <span class="arithmetic-operator">-</span> <span class="identifier">padding</span><span class="punctuation">,</span> <span class="identifier">center</span> <span class="arithmetic-operator">+</span> <span class="identifier">padding</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"centering: '%s', center: %s, padding: %s, sub roi: %s"</span><span class="punctuation">,</span>
                             <span class="identifier">centering</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"cropped_roi"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">centering</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"cropped_roi"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">centering</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">_get_cropped_slices</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain the slices to turn a full head extract into an alternatively centered extract.

        Returns
        -------
        dict
            The slices for an input full head image and output cropped image
        """</span>
        <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"cropped_slices"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"cropped_slices"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">get_cropped_roi</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">)</span>
                <span class="identifier">slice_in</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
                <span class="identifier">slice_out</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                                   <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">-</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">,</span> <span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_head_size</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                             <span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                                   <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">-</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">,</span> <span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_head_size</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"cropped_slices"][0][self._centering] = {"in"</span><span class="punctuation">:</span> <span class="identifier">slice_in</span><span class="punctuation">,</span>
                                                                     <span class="string-literal">"out"</span><span class="punctuation">:</span> <span class="identifier">slice_out</span><span class="grouping">}</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"centering: %s, cropped_slices: %s"</span><span class="punctuation">,</span>
                             <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"cropped_slices"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cache</span><span class="grouping">[</span><span class="string-literal">"cropped_slices"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">]</span>


<span class="keyword">class</span> <span class="identifier">PoseEstimate</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Estimates pose from a generic 3D head model for the given 2D face landmarks.

    Parameters
    ----------
    landmarks: :class:`numpy.ndarry`
        The original 68 point landmarks aligned to 0.0 - 1.0 range

    References
    ----------
    Head Pose Estimation using OpenCV and Dlib - https://www.learnopencv.com/tag/solvepnp/
    3D Model points - http://aifi.isr.uc.pt/Downloads/OpenGL/glAnthropometric3DModel.cpp
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_distortion_coefficients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>  <span class="comment"># Assuming no lens distortion</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_xyz_2d</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_camera_matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_camera_matrix</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_rotation</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_translation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_solve_pnp</span><span class="grouping">(</span><span class="identifier">landmarks</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_offset</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pitch_yaw</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">xyz_2d</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`numpy.ndarray` projected (x, y) coordinates for each x, y, z point at a
        constant distance from adjusted center of the skull (0.5, 0.5) in the 2D space. """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_xyz_2d</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">xyz</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">projectPoints</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-2.3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">-2.3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">3.7</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_rotation</span><span class="punctuation">,</span>
                                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_translation</span><span class="punctuation">,</span>
                                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_camera_matrix</span><span class="punctuation">,</span>
                                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_distortion_coefficients</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_xyz_2d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">xyz</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_offset</span><span class="grouping">[</span><span class="string-literal">"head"</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_xyz_2d</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">offset</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: The amount to offset a standard 0.0 - 1.0 umeyama transformation matrix for a
        from the center of the face (between the eyes) or center of the head (middle of skull)
        rather than the nose area. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_offset</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">pitch</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" float: The pitch of the aligned face in eular angles """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pitch_yaw</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_pitch_yaw</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pitch_yaw</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">yaw</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" float: The yaw of the aligned face in eular angles """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pitch_yaw</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_pitch_yaw</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pitch_yaw</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">_get_pitch_yaw</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain the yaw and pitch from the :attr:`_rotation` in eular angles. """</span>
        <span class="identifier">proj_matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
        <span class="identifier">proj_matrix</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">Rodrigues</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_rotation</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">euler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">decomposeProjectionMatrix</span><span class="grouping">(</span><span class="identifier">proj_matrix</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pitch_yaw</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">euler</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">euler</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"yaw_pitch: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pitch_yaw</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_get_camera_matrix</span><span class="grouping">(</span><span class="identifier">cls</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain an estimate of the camera matrix based off the original frame dimensions.

        Returns
        -------
        :class:`numpy.ndarray`
            An estimated camera matrix
        """</span>
        <span class="identifier">focal_length</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>
        <span class="identifier">camera_matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">focal_length</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">focal_length</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"double"</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"camera_matrix: %s"</span><span class="punctuation">,</span> <span class="identifier">camera_matrix</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">camera_matrix</span>

    <span class="keyword">def</span> <span class="identifier">_solve_pnp</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Solve the Perspective-n-Point for the given landmarks.

        Takes 2D landmarks in world space and estimates the rotation and translation vectors
        in 3D space.

        Parameters
        ----------
        landmarks: :class:`numpy.ndarry`
            The original 68 point landmark co-ordinates relating to the original frame

        Returns
        -------
        rotation: :class:`numpy.ndarray`
            The solved rotation vector
        translation: :class:`numpy.ndarray`
            The solved translation vector
        """</span>
        <span class="identifier">points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">landmarks</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">17</span><span class="punctuation">,</span> <span class="int-literal">21</span><span class="punctuation">,</span> <span class="int-literal">22</span><span class="punctuation">,</span> <span class="int-literal">26</span><span class="punctuation">,</span> <span class="int-literal">31</span><span class="punctuation">,</span> <span class="int-literal">32</span><span class="punctuation">,</span> <span class="int-literal">33</span><span class="punctuation">,</span> <span class="int-literal">34</span><span class="punctuation">,</span>
                            <span class="int-literal">35</span><span class="punctuation">,</span> <span class="int-literal">36</span><span class="punctuation">,</span> <span class="int-literal">39</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">45</span><span class="punctuation">,</span> <span class="int-literal">48</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">51</span><span class="punctuation">,</span> <span class="int-literal">52</span><span class="punctuation">,</span> <span class="int-literal">54</span><span class="punctuation">,</span> <span class="int-literal">56</span><span class="punctuation">,</span> <span class="int-literal">57</span><span class="punctuation">,</span> <span class="int-literal">58</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">rotation</span><span class="punctuation">,</span> <span class="identifier">translation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">solvePnP</span><span class="grouping">(</span><span class="identifier">_MEAN_FACE_3D</span><span class="punctuation">,</span>
                                                <span class="identifier">points</span><span class="punctuation">,</span>
                                                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_camera_matrix</span><span class="punctuation">,</span>
                                                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_distortion_coefficients</span><span class="punctuation">,</span>
                                                <span class="identifier">flags</span><span class="arithmetic-assignment">=</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">SOLVEPNP_ITERATIVE</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"points: %s, rotation: %s, translation: %s"</span><span class="punctuation">,</span> <span class="identifier">points</span><span class="punctuation">,</span> <span class="identifier">rotation</span><span class="punctuation">,</span> <span class="identifier">translation</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">rotation</span><span class="punctuation">,</span> <span class="identifier">translation</span>

    <span class="keyword">def</span> <span class="identifier">_get_offset</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain the offset between the original center of the extracted face to the new center
        of the head in 2D space.

        Returns
        -------
        :class:`numpy.ndarray`
            The x, y offset of the new center from the old center.
        """</span>
        <span class="identifier">offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">legacy</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">head</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-2.3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-1.5</span><span class="punctuation">,</span> <span class="float-literal">4.2</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">pnts</span> <span class="relational-operator">in</span> <span class="identifier">points</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">center</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">projectPoints</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">pnts</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                       <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_rotation</span><span class="punctuation">,</span>
                                       <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_translation</span><span class="punctuation">,</span>
                                       <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_camera_matrix</span><span class="punctuation">,</span>
                                       <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_distortion_coefficients</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"center %s: %s"</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="grouping">)</span>
            <span class="identifier">offset</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">center</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"offset: %s"</span><span class="punctuation">,</span> <span class="identifier">offset</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">offset</span>


<span class="keyword">def</span> <span class="identifier">get_centered_size</span><span class="grouping">(</span><span class="identifier">source_centering</span><span class="punctuation">,</span> <span class="identifier">target_centering</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Obtain the size of a cropped face from an aligned image.

    Given an image of a certain dimensions, returns the dimensions of the sub-crop within that
    image for the requested centering.

    Notes
    -----
    `"legacy"` places the nose in the center of the image (the original method for aligning).
    `"face"` aligns for the nose to be in the center of the face (top to bottom) but the center
    of the skull for left to right. `"head"` places the center in the middle of the skull in 3D
    space.

    The ROI in relation to the source image is calculated by rounding the padding of one side
    to the nearest integer then applying this padding to the center of the crop, to ensure that
    any dimensions always have an even number of pixels.

    Parameters
    ----------
    source_centering: ["head", "face", "legacy"]
        The centering that the original image is aligned at
    target_centering: ["head", "face", "legacy"]
        The centering that the sub-crop size should be obtained for
    size: int
        The size of the source image to obtain the cropped size for

    Returns
    -------
    int
        The pixel size of a sub-crop image from a full head aligned image
    """</span>
    <span class="keyword">if</span> <span class="identifier">source_centering</span> <span class="relational-operator">==</span> <span class="identifier">target_centering</span><span class="punctuation">:</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">size</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">src_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">size</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">size</span> <span class="arithmetic-operator">*</span> <span class="identifier">_EXTRACT_RATIOS</span><span class="grouping">[</span><span class="identifier">source_centering</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="identifier">src_size</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">_EXTRACT_RATIOS</span><span class="grouping">[</span><span class="identifier">target_centering</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"source_centering: %s, target_centering: %s, size: %s, crop_size: %s"</span><span class="punctuation">,</span>
                 <span class="identifier">source_centering</span><span class="punctuation">,</span> <span class="identifier">target_centering</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">retval</span>


<span class="keyword">def</span> <span class="identifier">_umeyama</span><span class="grouping">(</span><span class="identifier">source</span><span class="punctuation">,</span> <span class="identifier">destination</span><span class="punctuation">,</span> <span class="identifier">estimate_scale</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Estimate N-D similarity transformation with or without scaling.

    Imported, and slightly adapted, directly from:
    https://github.com/scikit-image/scikit-image/blob/master/skimage/transform/_geometric.py


    Parameters
    ----------
    source: :class:`numpy.ndarray`
        (M, N) array source coordinates.
    destination: :class:`numpy.ndarray`
        (M, N) array destination coordinates.
    estimate_scale: bool
        Whether to estimate scaling factor.

    Returns
    -------
    :class:`numpy.ndarray`
        (N + 1, N + 1) The homogeneous similarity transformation matrix. The matrix contains
        NaN values only if the problem is not well-conditioned.

    References
    ----------
    .. [1] "Least-squares estimation of transformation parameters between two
            point patterns", Shinji Umeyama, PAMI 1991, :DOI:`10.1109/34.88573`
    """</span>
    <span class="comment"># pylint:disable=invalid-name,too-many-locals</span>
    <span class="identifier">num</span> <span class="arithmetic-assignment">=</span> <span class="identifier">source</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">dim</span> <span class="arithmetic-assignment">=</span> <span class="identifier">source</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="comment"># Compute mean of source and destination.</span>
    <span class="identifier">src_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">source</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">dst_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">destination</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Subtract mean from source and destination.</span>
    <span class="identifier">src_demean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">source</span> <span class="arithmetic-operator">-</span> <span class="identifier">src_mean</span>
    <span class="identifier">dst_demean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">destination</span> <span class="arithmetic-operator">-</span> <span class="identifier">dst_mean</span>

    <span class="comment"># Eq. (38).</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dst_demean</span><span class="punctuation">.</span><span class="identifier">T</span> <span class="punctuation">@</span> <span class="identifier">src_demean</span> <span class="arithmetic-operator">/</span> <span class="identifier">num</span>

    <span class="comment"># Eq. (39).</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">dim</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">double</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">det</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">d</span><span class="grouping">[</span><span class="identifier">dim</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>

    <span class="identifier">T</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">dim</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">double</span><span class="grouping">)</span>

    <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">V</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">svd</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>

    <span class="comment"># Eq. (40) and (43).</span>
    <span class="identifier">rank</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">matrix_rank</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">rank</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span> <span class="arithmetic-operator">*</span> <span class="identifier">T</span>
    <span class="keyword">if</span> <span class="identifier">rank</span> <span class="relational-operator">==</span> <span class="identifier">dim</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">det</span><span class="grouping">(</span><span class="identifier">U</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">det</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">T</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">dim</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">dim</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span> <span class="punctuation">@</span> <span class="identifier">V</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="grouping">[</span><span class="identifier">dim</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">d</span><span class="grouping">[</span><span class="identifier">dim</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
            <span class="identifier">T</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">dim</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">dim</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span> <span class="punctuation">@</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">)</span> <span class="punctuation">@</span> <span class="identifier">V</span>
            <span class="identifier">d</span><span class="grouping">[</span><span class="identifier">dim</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">T</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">dim</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">dim</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span> <span class="punctuation">@</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">)</span> <span class="punctuation">@</span> <span class="identifier">V</span>

    <span class="keyword">if</span> <span class="identifier">estimate_scale</span><span class="punctuation">:</span>
        <span class="comment"># Eq. (41) and (42).</span>
        <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span> <span class="arithmetic-operator">/</span> <span class="identifier">src_demean</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">S</span> <span class="punctuation">@</span> <span class="identifier">d</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>

    <span class="identifier">T</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">dim</span><span class="punctuation">,</span> <span class="identifier">dim</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dst_mean</span> <span class="arithmetic-operator">-</span> <span class="identifier">scale</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">T</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">dim</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">dim</span><span class="grouping">]</span> <span class="punctuation">@</span> <span class="identifier">src_mean</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">T</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">dim</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">dim</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">scale</span>

    <span class="keyword">return</span> <span class="identifier">T</span>

    </pre>
  </body>
</html>