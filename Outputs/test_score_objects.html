<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">from</span> <span class="identifier">copy</span> <span class="keyword">import</span> <span class="identifier">deepcopy</span>
<span class="keyword">import</span> <span class="identifier">pickle</span>
<span class="keyword">import</span> <span class="identifier">tempfile</span>
<span class="keyword">import</span> <span class="identifier">shutil</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">numbers</span>
<span class="keyword">from</span> <span class="identifier">unittest</span><span class="punctuation">.</span><span class="identifier">mock</span> <span class="keyword">import</span> <span class="identifier">Mock</span>
<span class="keyword">from</span> <span class="identifier">functools</span> <span class="keyword">import</span> <span class="identifier">partial</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">import</span> <span class="identifier">joblib</span>

<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">accuracy_score</span><span class="punctuation">,</span>
    <span class="identifier">balanced_accuracy_score</span><span class="punctuation">,</span>
    <span class="identifier">average_precision_score</span><span class="punctuation">,</span>
    <span class="identifier">brier_score_loss</span><span class="punctuation">,</span>
    <span class="identifier">f1_score</span><span class="punctuation">,</span>
    <span class="identifier">fbeta_score</span><span class="punctuation">,</span>
    <span class="identifier">jaccard_score</span><span class="punctuation">,</span>
    <span class="identifier">log_loss</span><span class="punctuation">,</span>
    <span class="identifier">precision_score</span><span class="punctuation">,</span>
    <span class="identifier">r2_score</span><span class="punctuation">,</span>
    <span class="identifier">recall_score</span><span class="punctuation">,</span>
    <span class="identifier">roc_auc_score</span><span class="punctuation">,</span>
    <span class="identifier">top_k_accuracy_score</span>
<span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">cluster</span> <span class="keyword">as</span> <span class="identifier">cluster_module</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">check_scoring</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">_scorer</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">_PredictScorer</span><span class="punctuation">,</span> <span class="identifier">_passthrough_scorer</span><span class="punctuation">,</span>
                                     <span class="identifier">_MultimetricScorer</span><span class="punctuation">,</span>
                                     <span class="identifier">_check_multimetric_scoring</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">make_scorer</span><span class="punctuation">,</span> <span class="identifier">get_scorer</span><span class="punctuation">,</span> <span class="identifier">SCORERS</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">KNeighborsClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">LinearSVC</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">KMeans</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">Ridge</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="punctuation">,</span> <span class="identifier">Perceptron</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span> <span class="keyword">import</span> <span class="identifier">DecisionTreeClassifier</span><span class="punctuation">,</span> <span class="identifier">DecisionTreeRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_blobs</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span><span class="punctuation">,</span> <span class="identifier">make_regression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_multilabel_classification</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_diabetes</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span><span class="punctuation">,</span> <span class="identifier">cross_val_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GridSearchCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">multiclass</span> <span class="keyword">import</span> <span class="identifier">OneVsRestClassifier</span>


<span class="identifier">REGRESSION_SCORERS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'explained_variance', 'r2'</span><span class="punctuation">,</span>
                      <span class="string-literal">'neg_mean_absolute_error', 'neg_mean_squared_error'</span><span class="punctuation">,</span>
                      <span class="string-literal">'neg_mean_absolute_percentage_error'</span><span class="punctuation">,</span>
                      <span class="string-literal">'neg_mean_squared_log_error'</span><span class="punctuation">,</span>
                      <span class="string-literal">'neg_median_absolute_error'</span><span class="punctuation">,</span>
                      <span class="string-literal">'neg_root_mean_squared_error'</span><span class="punctuation">,</span>
                      <span class="string-literal">'mean_absolute_error'</span><span class="punctuation">,</span>
                      <span class="string-literal">'mean_absolute_percentage_error'</span><span class="punctuation">,</span>
                      <span class="string-literal">'mean_squared_error', 'median_absolute_error'</span><span class="punctuation">,</span>
                      <span class="string-literal">'max_error', 'neg_mean_poisson_deviance'</span><span class="punctuation">,</span>
                      <span class="string-literal">'neg_mean_gamma_deviance'</span><span class="grouping">]</span>

<span class="identifier">CLF_SCORERS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'accuracy', 'balanced_accuracy', 'top_k_accuracy'</span><span class="punctuation">,</span>
               <span class="string-literal">'f1', 'f1_weighted', 'f1_macro', 'f1_micro'</span><span class="punctuation">,</span>
               <span class="string-literal">'roc_auc', 'average_precision', 'precision'</span><span class="punctuation">,</span>
               <span class="string-literal">'precision_weighted', 'precision_macro', 'precision_micro'</span><span class="punctuation">,</span>
               <span class="string-literal">'recall', 'recall_weighted', 'recall_macro', 'recall_micro'</span><span class="punctuation">,</span>
               <span class="string-literal">'neg_log_loss', 'neg_brier_score'</span><span class="punctuation">,</span>
               <span class="string-literal">'jaccard', 'jaccard_weighted', 'jaccard_macro'</span><span class="punctuation">,</span>
               <span class="string-literal">'jaccard_micro', 'roc_auc_ovr', 'roc_auc_ovo'</span><span class="punctuation">,</span>
               <span class="string-literal">'roc_auc_ovr_weighted', 'roc_auc_ovo_weighted'</span><span class="grouping">]</span>

<span class="comment"># All supervised cluster scorers (They behave like classification metric)</span>
<span class="identifier">CLUSTER_SCORERS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"adjusted_rand_score"</span><span class="punctuation">,</span>
                   <span class="string-literal">"rand_score"</span><span class="punctuation">,</span>
                   <span class="string-literal">"homogeneity_score"</span><span class="punctuation">,</span>
                   <span class="string-literal">"completeness_score"</span><span class="punctuation">,</span>
                   <span class="string-literal">"v_measure_score"</span><span class="punctuation">,</span>
                   <span class="string-literal">"mutual_info_score"</span><span class="punctuation">,</span>
                   <span class="string-literal">"adjusted_mutual_info_score"</span><span class="punctuation">,</span>
                   <span class="string-literal">"normalized_mutual_info_score"</span><span class="punctuation">,</span>
                   <span class="string-literal">"fowlkes_mallows_score"</span><span class="grouping">]</span>

<span class="identifier">MULTILABEL_ONLY_SCORERS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'precision_samples', 'recall_samples', 'f1_samples'</span><span class="punctuation">,</span>
                           <span class="string-literal">'jaccard_samples'</span><span class="grouping">]</span>

<span class="identifier">REQUIRE_POSITIVE_Y_SCORERS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'neg_mean_poisson_deviance'</span><span class="punctuation">,</span>
                              <span class="string-literal">'neg_mean_gamma_deviance'</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">_require_positive_y</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Make targets strictly positive"""</span>
    <span class="identifier">offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="identifier">offset</span>
    <span class="keyword">return</span> <span class="identifier">y</span>


<span class="keyword">def</span> <span class="identifier">_make_estimators</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_ml_train</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make estimators that make sense to test various scoring methods</span>
    <span class="identifier">sensible_regr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># some of the regressions scorers require strictly positive input.</span>
    <span class="identifier">sensible_regr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">_require_positive_y</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">sensible_clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">sensible_clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">sensible_ml_clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">sensible_ml_clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_ml_train</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">sensible_regr</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">REGRESSION_SCORERS</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span>
        <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">sensible_clf</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">CLF_SCORERS</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span>
        <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">sensible_clf</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">CLUSTER_SCORERS</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span>
        <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">sensible_ml_clf</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">MULTILABEL_ONLY_SCORERS</span><span class="grouping">]</span>
    <span class="grouping">)</span>


<span class="identifier">X_mm</span><span class="punctuation">,</span> <span class="identifier">y_mm</span><span class="punctuation">,</span> <span class="identifier">y_ml_mm</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span>
<span class="identifier">ESTIMATORS</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
<span class="identifier">TEMP_FOLDER</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>


<span class="keyword">def</span> <span class="identifier">setup_module</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Create some memory mapped data</span>
    <span class="keyword">global</span> <span class="identifier">X_mm</span><span class="punctuation">,</span> <span class="identifier">y_mm</span><span class="punctuation">,</span> <span class="identifier">y_ml_mm</span><span class="punctuation">,</span> <span class="identifier">TEMP_FOLDER</span><span class="punctuation">,</span> <span class="identifier">ESTIMATORS</span>
    <span class="identifier">TEMP_FOLDER</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tempfile</span><span class="punctuation">.</span><span class="identifier">mkdtemp</span><span class="grouping">(</span><span class="identifier">prefix</span><span class="arithmetic-assignment">=</span><span class="string-literal">'sklearn_test_score_objects_'</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_ml</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_multilabel_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                             <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">filename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">TEMP_FOLDER</span><span class="punctuation">,</span> <span class="string-literal">'test_data.pkl'</span><span class="grouping">)</span>
    <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">dump</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_ml</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
    <span class="identifier">X_mm</span><span class="punctuation">,</span> <span class="identifier">y_mm</span><span class="punctuation">,</span> <span class="identifier">y_ml_mm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">mmap_mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'r'</span><span class="grouping">)</span>
    <span class="identifier">ESTIMATORS</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_estimators</span><span class="grouping">(</span><span class="identifier">X_mm</span><span class="punctuation">,</span> <span class="identifier">y_mm</span><span class="punctuation">,</span> <span class="identifier">y_ml_mm</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">teardown_module</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">global</span> <span class="identifier">X_mm</span><span class="punctuation">,</span> <span class="identifier">y_mm</span><span class="punctuation">,</span> <span class="identifier">y_ml_mm</span><span class="punctuation">,</span> <span class="identifier">TEMP_FOLDER</span><span class="punctuation">,</span> <span class="identifier">ESTIMATORS</span>
    <span class="comment"># GC closes the mmap file descriptors</span>
    <span class="identifier">X_mm</span><span class="punctuation">,</span> <span class="identifier">y_mm</span><span class="punctuation">,</span> <span class="identifier">y_ml_mm</span><span class="punctuation">,</span> <span class="identifier">ESTIMATORS</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span>
    <span class="identifier">shutil</span><span class="punctuation">.</span><span class="identifier">rmtree</span><span class="grouping">(</span><span class="identifier">TEMP_FOLDER</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">EstimatorWithoutFit</span><span class="punctuation">:</span>
    <span class="comment">"""Dummy estimator to test scoring validators"""</span>
    <span class="keyword">pass</span>


<span class="keyword">class</span> <span class="identifier">EstimatorWithFit</span><span class="grouping">(</span><span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Dummy estimator to test scoring validators"""</span>
    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span>


<span class="keyword">class</span> <span class="identifier">EstimatorWithFitAndScore</span><span class="punctuation">:</span>
    <span class="comment">"""Dummy estimator to test scoring validators"""</span>
    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">score</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="float-literal">1.0</span>


<span class="keyword">class</span> <span class="identifier">EstimatorWithFitAndPredict</span><span class="punctuation">:</span>
    <span class="comment">"""Dummy estimator to test scoring validators"""</span>
    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y</span>


<span class="keyword">class</span> <span class="identifier">DummyScorer</span><span class="punctuation">:</span>
    <span class="comment">"""Dummy scorer that always returns 1."""</span>
    <span class="keyword">def</span> <span class="identifier">__call__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="int-literal">1</span>


<span class="keyword">def</span> <span class="identifier">test_all_scorers_repr</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that all scorers have a working repr</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">scorer</span> <span class="relational-operator">in</span> <span class="identifier">SCORERS</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">repr</span><span class="grouping">(</span><span class="identifier">scorer</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_scoring_validator_for_single_metric_usecases</span><span class="grouping">(</span><span class="identifier">scoring_validator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test all branches of single metric usecases</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">EstimatorWithoutFit</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pattern</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"estimator should be an estimator implementing 'fit' method,"</span>
               <span class="identifier">r</span><span class="string-literal">" .* was passed"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">pattern</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">scoring_validator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">EstimatorWithFitAndScore</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scoring_validator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">scorer</span> <span class="relational-operator">is</span> <span class="identifier">_passthrough_scorer</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">EstimatorWithFitAndPredict</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pattern</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"If no scoring is specified, the estimator passed should have"</span>
               <span class="identifier">r</span><span class="string-literal">" a 'score' method\. The estimator .* does not\."</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">pattern</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">scoring_validator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>

    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scoring_validator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">"accuracy"</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">EstimatorWithFit</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scoring_validator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">"accuracy"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">scorer</span><span class="punctuation">,</span> <span class="identifier">_PredictScorer</span><span class="grouping">)</span>

    <span class="comment"># Test the allow_none parameter for check_scoring alone</span>
    <span class="keyword">if</span> <span class="identifier">scoring_validator</span> <span class="relational-operator">is</span> <span class="identifier">check_scoring</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">EstimatorWithFit</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scoring_validator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">allow_none</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">scorer</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"scoring"</span><span class="punctuation">,</span>
    <span class="grouping">(</span>
        <span class="grouping">(</span><span class="string-literal">'accuracy', ), ['precision'</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">{</span><span class="string-literal">'acc': 'accuracy', 'precision': 'precision'</span><span class="grouping">}</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'accuracy', 'precision'</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">'precision', 'accuracy'</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">{</span><span class="string-literal">'accuracy'</span><span class="punctuation">:</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">accuracy_score</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="string-literal">'precision'</span><span class="punctuation">:</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">precision_score</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"single_tuple", "single_list", "dict_str"</span><span class="punctuation">,</span>
            <span class="string-literal">"multi_tuple", "multi_list", "dict_callable"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_check_scoring_and_check_multimetric_scoring</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_scoring_validator_for_single_metric_usecases</span><span class="grouping">(</span><span class="identifier">check_scoring</span><span class="grouping">)</span>
    <span class="comment"># To make sure the check_scoring is correctly applied to the constituent</span>
    <span class="comment"># scorers</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">scorers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_check_multimetric_scoring</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">scorers</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">scorers</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">scorer</span><span class="punctuation">,</span> <span class="identifier">_PredictScorer</span><span class="grouping">)</span>
                <span class="keyword">for</span> <span class="identifier">scorer</span> <span class="relational-operator">in</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">scorers</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="string-literal">'acc'</span> <span class="relational-operator">in</span> <span class="identifier">scoring</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">scorers</span><span class="grouping">[</span><span class="string-literal">'acc'</span><span class="grouping">]</span><span class="grouping">(</span>
            <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">'accuracy'</span> <span class="relational-operator">in</span> <span class="identifier">scoring</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">scorers</span><span class="grouping">[</span><span class="string-literal">'accuracy'</span><span class="grouping">]</span><span class="grouping">(</span>
            <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">'precision'</span> <span class="relational-operator">in</span> <span class="identifier">scoring</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">scorers</span><span class="grouping">[</span><span class="string-literal">'precision'</span><span class="grouping">]</span><span class="grouping">(</span>
            <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"scoring"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">precision_score</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">accuracy_score</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="string-literal">"One or more of the elements were callables"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">"Non-string types were found"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">precision_score</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="punctuation">,</span>
     <span class="string-literal">"One of mor eof the elements were callables"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">"Empty list was given"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">'f1', 'f1'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">"Duplicate elements were found"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="int-literal">4</span><span class="punctuation">:</span> <span class="string-literal">'accuracy'</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="string-literal">"Non-string types were found in the keys"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="string-literal">"An empty dict was passed"</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span>
    <span class="string-literal">"tuple of callables", "list of int"</span><span class="punctuation">,</span>
    <span class="string-literal">"tuple of one callable", "empty tuple"</span><span class="punctuation">,</span>
    <span class="string-literal">"non-unique str", "non-string key dict"</span><span class="punctuation">,</span>
    <span class="string-literal">"empty dict"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_check_scoring_and_check_multimetric_scoring_errors</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure it raises errors when scoring parameter is not valid.</span>
    <span class="comment"># More weird corner cases are tested at test_validation.py</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">EstimatorWithFitAndPredict</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">error_message_regexp</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">".*must be unique strings.*"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_message_regexp</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_check_multimetric_scoring</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_check_scoring_gridsearchcv</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that check_scoring works on GridSearchCV and pipeline.</span>
    <span class="comment"># slightly redundant non-regression test.</span>

    <span class="identifier">grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_scoring</span><span class="grouping">(</span><span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">"f1"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">scorer</span><span class="punctuation">,</span> <span class="identifier">_PredictScorer</span><span class="grouping">)</span>

    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_scoring</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">"f1"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">scorer</span><span class="punctuation">,</span> <span class="identifier">_PredictScorer</span><span class="grouping">)</span>

    <span class="comment"># check that cross_val_score definitely calls the scorer</span>
    <span class="comment"># and doesn't make any assumptions about the estimator apart from having a</span>
    <span class="comment"># fit.</span>
    <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">EstimatorWithFit</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                             <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">DummyScorer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">scores</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_make_scorer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Sanity check on the make_scorer factory function.</span>
    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">:</span> <span class="int-literal">0</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">needs_threshold</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">needs_proba</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'scorer_name, metric'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="string-literal">'f1'</span><span class="punctuation">,</span> <span class="identifier">f1_score</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'f1_weighted', partial(f1_score, average='weighted'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'f1_macro', partial(f1_score, average='macro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'f1_micro', partial(f1_score, average='micro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'precision'</span><span class="punctuation">,</span> <span class="identifier">precision_score</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'precision_weighted', partial(precision_score, average='weighted'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'precision_macro', partial(precision_score, average='macro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'precision_micro', partial(precision_score, average='micro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'recall'</span><span class="punctuation">,</span> <span class="identifier">recall_score</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'recall_weighted', partial(recall_score, average='weighted'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'recall_macro', partial(recall_score, average='macro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'recall_micro', partial(recall_score, average='micro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'jaccard'</span><span class="punctuation">,</span> <span class="identifier">jaccard_score</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'jaccard_weighted', partial(jaccard_score, average='weighted'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'jaccard_macro', partial(jaccard_score, average='macro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'jaccard_micro', partial(jaccard_score, average='micro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'top_k_accuracy'</span><span class="punctuation">,</span> <span class="identifier">top_k_accuracy_score</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_classification_binary_scores</span><span class="grouping">(</span><span class="identifier">scorer_name</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check consistency between score and scorer for scores supporting</span>
    <span class="comment"># binary classification.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SCORERS</span><span class="grouping">[</span><span class="identifier">scorer_name</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">expected_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metric</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score</span><span class="punctuation">,</span> <span class="identifier">expected_score</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'scorer_name, metric'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="string-literal">'accuracy'</span><span class="punctuation">,</span> <span class="identifier">accuracy_score</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'balanced_accuracy'</span><span class="punctuation">,</span> <span class="identifier">balanced_accuracy_score</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'f1_weighted', partial(f1_score, average='weighted'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'f1_macro', partial(f1_score, average='macro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'f1_micro', partial(f1_score, average='micro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'precision_weighted', partial(precision_score, average='weighted'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'precision_macro', partial(precision_score, average='macro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'precision_micro', partial(precision_score, average='micro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'recall_weighted', partial(recall_score, average='weighted'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'recall_macro', partial(recall_score, average='macro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'recall_micro', partial(recall_score, average='micro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'jaccard_weighted', partial(jaccard_score, average='weighted'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'jaccard_macro', partial(jaccard_score, average='macro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'jaccard_micro', partial(jaccard_score, average='micro'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_classification_multiclass_scores</span><span class="grouping">(</span><span class="identifier">scorer_name</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check consistency between score and scorer for scores supporting</span>
    <span class="comment"># multiclass classification.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span>
        <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>

    <span class="comment"># use `stratify` = y to ensure train and test sets capture all classes</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">stratify</span><span class="arithmetic-assignment">=</span><span class="identifier">y</span>
    <span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SCORERS</span><span class="grouping">[</span><span class="identifier">scorer_name</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">expected_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metric</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">expected_score</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_custom_scorer_pickling</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that custom scorer can be pickled</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">fbeta_score</span><span class="punctuation">,</span> <span class="identifier">beta</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">score1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">unpickled_scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">scorer</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">unpickled_scorer</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score1</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">score2</span><span class="grouping">)</span>

    <span class="comment"># smoke test the repr:</span>
    <span class="identifier">repr</span><span class="grouping">(</span><span class="identifier">fbeta_score</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_regression_scorers</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test regression scorers.</span>
    <span class="identifier">diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_diabetes</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">score1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'r2'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r2_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score1</span><span class="punctuation">,</span> <span class="identifier">score2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_thresholded_scorers</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test scorers that take thresholds.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">score1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'roc_auc'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_auc_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">score3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_auc_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score1</span><span class="punctuation">,</span> <span class="identifier">score2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score1</span><span class="punctuation">,</span> <span class="identifier">score3</span><span class="grouping">)</span>

    <span class="identifier">logscore</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'neg_log_loss'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">logloss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">log_loss</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">logscore</span><span class="punctuation">,</span> <span class="identifier">logloss</span><span class="grouping">)</span>

    <span class="comment"># same for an estimator without decision_function</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">score1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'roc_auc'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_auc_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score1</span><span class="punctuation">,</span> <span class="identifier">score2</span><span class="grouping">)</span>

    <span class="comment"># test with a regressor (no decision_function)</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">score1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'roc_auc'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_auc_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score1</span><span class="punctuation">,</span> <span class="identifier">score2</span><span class="grouping">)</span>

    <span class="comment"># Test that an exception is raised on more than two classes</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"multiclass format is not supported"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'roc_auc'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

    <span class="comment"># test error is raised with a single class present in model</span>
    <span class="comment"># (predict_proba shape is not suitable for binary auc)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"need classifier with two classes"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'roc_auc'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

    <span class="comment"># for proba scorers</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"need classifier with two classes"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'neg_log_loss'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_thresholded_scorers_multilabel_indicator_data</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the scorer work with multilabel-indicator format</span>
    <span class="comment"># for multilabel and multi-output multi-class classifier</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_multilabel_classification</span><span class="grouping">(</span><span class="identifier">allow_unlabeled</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Multi-output multi-class predict_proba</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">y_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">score1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'roc_auc'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_auc_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">p</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">y_proba</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score1</span><span class="punctuation">,</span> <span class="identifier">score2</span><span class="grouping">)</span>

    <span class="comment"># Multi-output multi-class decision_function</span>
    <span class="comment"># TODO Is there any yet?</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">_predict_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span> <span class="identifier">X</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="identifier">p</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">_predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">y_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">score1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'roc_auc'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_auc_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">p</span> <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">y_proba</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score1</span><span class="punctuation">,</span> <span class="identifier">score2</span><span class="grouping">)</span>

    <span class="comment"># Multilabel predict_proba</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">OneVsRestClassifier</span><span class="grouping">(</span><span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">score1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'roc_auc'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_auc_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score1</span><span class="punctuation">,</span> <span class="identifier">score2</span><span class="grouping">)</span>

    <span class="comment"># Multilabel decision function</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">OneVsRestClassifier</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">score1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'roc_auc'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_auc_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score1</span><span class="punctuation">,</span> <span class="identifier">score2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_supervised_cluster_scorers</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test clustering scorers against gold standard labeling.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">km</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KMeans</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">km</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">CLUSTER_SCORERS</span><span class="punctuation">:</span>
        <span class="identifier">score1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">km</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
        <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">cluster_module</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">km</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">score1</span><span class="punctuation">,</span> <span class="identifier">score2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">test_raises_on_score_list</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that when a list of scores is returned, we raise proper errors.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">f1_scorer_no_average</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">f1_score</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">f1_scorer_no_average</span><span class="grouping">)</span>
    <span class="identifier">grid_search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">f1_scorer_no_average</span><span class="punctuation">,</span>
                               <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'max_depth'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">grid_search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">test_classification_scorer_sample_weight</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that classification scorers support sample_weight or raise sensible</span>
    <span class="comment"># errors</span>

    <span class="comment"># Unlike the metrics invariance test, in the scorer case it's harder</span>
    <span class="comment"># to ensure that, on the classifier output, weighted and unweighted</span>
    <span class="comment"># scores really should be unequal.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_ml</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_multilabel_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                             <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">split</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_ml</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_ml_train</span><span class="punctuation">,</span> <span class="identifier">y_ml_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">split</span>

    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones_like</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">10</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="comment"># get sensible estimators for each metric</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_estimators</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_ml_train</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">scorer</span> <span class="relational-operator">in</span> <span class="identifier">SCORERS</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">REGRESSION_SCORERS</span><span class="punctuation">:</span>
            <span class="comment"># skip the regression scores</span>
            <span class="keyword">continue</span>
        <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'top_k_accuracy'</span><span class="punctuation">:</span>
            <span class="comment"># in the binary case k &gt; 1 will always lead to a perfect score</span>
            <span class="identifier">scorer</span><span class="punctuation">.</span><span class="identifier">_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'k'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span>
        <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">MULTILABEL_ONLY_SCORERS</span><span class="punctuation">:</span>
            <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_ml_test</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_test</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">weighted</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="punctuation">,</span>
                              <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
            <span class="identifier">ignored</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">unweighted</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">weighted</span> <span class="relational-operator">!=</span> <span class="identifier">unweighted</span><span class="punctuation">,</span> <span class="grouping">(</span>
                <span class="identifier">f</span><span class="string-literal">"scorer {name} behaves identically when called with "</span>
                <span class="identifier">f</span><span class="string-literal">"sample weights: {weighted} vs {unweighted}"</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">weighted</span><span class="punctuation">,</span> <span class="identifier">ignored</span><span class="punctuation">,</span>
                                <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"scorer {name} behaves differently "</span>
                                <span class="identifier">f</span><span class="string-literal">"when ignoring samples and setting "</span>
                                <span class="identifier">f</span><span class="string-literal">"sample_weight to 0: {weighted} vs {ignored}"</span><span class="grouping">)</span>

        <span class="keyword">except</span> <span class="identifier">TypeError</span> <span class="keyword">as</span> <span class="identifier">e</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="string-literal">"sample_weight"</span> <span class="relational-operator">in</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">e</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
                   <span class="identifier">f</span><span class="string-literal">"scorer {name} raises unhelpful exception when called "</span>
                   <span class="identifier">f</span><span class="string-literal">"with sample weights: {str(e)}"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">test_regression_scorer_sample_weight</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that regression scorers support sample_weight or raise sensible</span>
    <span class="comment"># errors</span>

    <span class="comment"># Odd number of test samples req for neg_median_absolute_error</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">101</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_require_positive_y</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones_like</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="comment"># Odd number req for neg_median_absolute_error</span>
    <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">11</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">scorer</span> <span class="relational-operator">in</span> <span class="identifier">SCORERS</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">name</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">REGRESSION_SCORERS</span><span class="punctuation">:</span>
            <span class="comment"># skip classification scorers</span>
            <span class="keyword">continue</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">weighted</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="punctuation">,</span>
                              <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
            <span class="identifier">ignored</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="grouping">[</span><span class="int-literal">11</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">[</span><span class="int-literal">11</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">unweighted</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">weighted</span> <span class="relational-operator">!=</span> <span class="identifier">unweighted</span><span class="punctuation">,</span> <span class="grouping">(</span>
                <span class="identifier">f</span><span class="string-literal">"scorer {name} behaves identically when called with "</span>
                <span class="identifier">f</span><span class="string-literal">"sample weights: {weighted} vs {unweighted}"</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">weighted</span><span class="punctuation">,</span> <span class="identifier">ignored</span><span class="punctuation">,</span>
                                <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"scorer {name} behaves differently "</span>
                                <span class="identifier">f</span><span class="string-literal">"when ignoring samples and setting "</span>
                                <span class="identifier">f</span><span class="string-literal">"sample_weight to 0: {weighted} vs {ignored}"</span><span class="grouping">)</span>

        <span class="keyword">except</span> <span class="identifier">TypeError</span> <span class="keyword">as</span> <span class="identifier">e</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="string-literal">"sample_weight"</span> <span class="relational-operator">in</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">e</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
                   <span class="identifier">f</span><span class="string-literal">"scorer {name} raises unhelpful exception when called "</span>
                   <span class="identifier">f</span><span class="string-literal">"with sample weights: {str(e)}"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'name'</span><span class="punctuation">,</span> <span class="identifier">SCORERS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_scorer_memmap_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non-regression test for #6147: some score functions would</span>
    <span class="comment"># return singleton memmap when computed on memmap data instead of scalar</span>
    <span class="comment"># float values.</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">REQUIRE_POSITIVE_Y_SCORERS</span><span class="punctuation">:</span>
        <span class="identifier">y_mm_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_require_positive_y</span><span class="grouping">(</span><span class="identifier">y_mm</span><span class="grouping">)</span>
        <span class="identifier">y_ml_mm_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_require_positive_y</span><span class="grouping">(</span><span class="identifier">y_ml_mm</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">y_mm_1</span><span class="punctuation">,</span> <span class="identifier">y_ml_mm_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_mm</span><span class="punctuation">,</span> <span class="identifier">y_ml_mm</span>

    <span class="comment"># UndefinedMetricWarning for P / R scores</span>
    <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">scorer</span><span class="punctuation">,</span> <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SCORERS</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ESTIMATORS</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">MULTILABEL_ONLY_SCORERS</span><span class="punctuation">:</span>
            <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X_mm</span><span class="punctuation">,</span> <span class="identifier">y_ml_mm_1</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X_mm</span><span class="punctuation">,</span> <span class="identifier">y_mm_1</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">score</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Number</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">name</span>


<span class="keyword">def</span> <span class="identifier">test_scoring_is_not_metric</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'make_scorer'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_scoring</span><span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">f1_score</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'make_scorer'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_scoring</span><span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">roc_auc_score</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'make_scorer'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_scoring</span><span class="grouping">(</span><span class="identifier">Ridge</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">r2_score</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'make_scorer'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_scoring</span><span class="grouping">(</span><span class="identifier">KMeans</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">cluster_module</span><span class="punctuation">.</span><span class="identifier">adjusted_rand_score</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'make_scorer'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_scoring</span><span class="grouping">(</span><span class="identifier">KMeans</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">cluster_module</span><span class="punctuation">.</span><span class="identifier">rand_score</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="grouping">(</span><span class="string-literal">"scorers,expected_predict_count,"</span>
     <span class="string-literal">"expected_predict_proba_count,expected_decision_func_count"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'a1': 'accuracy', 'a2': 'accuracy'</span><span class="punctuation">,</span>
       <span class="string-literal">'ll1': 'neg_log_loss', 'll2': 'neg_log_loss'</span><span class="punctuation">,</span>
        <span class="string-literal">'ra1': 'roc_auc', 'ra2': 'roc_auc'</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'roc_auc', 'accuracy'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'neg_log_loss', 'accuracy'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_multimetric_scorer_calls_method_once</span><span class="grouping">(</span><span class="identifier">scorers</span><span class="punctuation">,</span> <span class="identifier">expected_predict_count</span><span class="punctuation">,</span>
                                              <span class="identifier">expected_predict_proba_count</span><span class="punctuation">,</span>
                                              <span class="identifier">expected_decision_func_count</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">mock_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mock</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">fit_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mock</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">v</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">u</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="identifier">mock_est</span><span class="grouping">)</span>
    <span class="identifier">predict_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mock</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">v</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">u</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">pos_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">pos_proba</span><span class="punctuation">,</span> <span class="identifier">pos_proba</span><span class="grouping">]</span>
    <span class="identifier">predict_proba_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mock</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">v</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">u</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="identifier">proba</span><span class="grouping">)</span>
    <span class="identifier">decision_function_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mock</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">v</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">u</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="identifier">pos_proba</span><span class="grouping">)</span>

    <span class="identifier">mock_est</span><span class="punctuation">.</span><span class="identifier">fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fit_func</span>
    <span class="identifier">mock_est</span><span class="punctuation">.</span><span class="identifier">predict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predict_func</span>
    <span class="identifier">mock_est</span><span class="punctuation">.</span><span class="identifier">predict_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predict_proba_func</span>
    <span class="identifier">mock_est</span><span class="punctuation">.</span><span class="identifier">decision_function</span> <span class="arithmetic-assignment">=</span> <span class="identifier">decision_function_func</span>
    <span class="comment"># add the classes that would be found during fit</span>
    <span class="identifier">mock_est</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">scorer_dict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_check_multimetric_scoring</span><span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">scorers</span><span class="grouping">)</span>
    <span class="identifier">multi_scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_MultimetricScorer</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">scorer_dict</span><span class="grouping">)</span>
    <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">multi_scorer</span><span class="grouping">(</span><span class="identifier">mock_est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">scorers</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">)</span>  <span class="comment"># compare dict keys</span>

    <span class="keyword">assert</span> <span class="identifier">predict_func</span><span class="punctuation">.</span><span class="identifier">call_count</span> <span class="relational-operator">==</span> <span class="identifier">expected_predict_count</span>
    <span class="keyword">assert</span> <span class="identifier">predict_proba_func</span><span class="punctuation">.</span><span class="identifier">call_count</span> <span class="relational-operator">==</span> <span class="identifier">expected_predict_proba_count</span>
    <span class="keyword">assert</span> <span class="identifier">decision_function_func</span><span class="punctuation">.</span><span class="identifier">call_count</span> <span class="relational-operator">==</span> <span class="identifier">expected_decision_func_count</span>


<span class="keyword">def</span> <span class="identifier">test_multimetric_scorer_calls_method_once_classifier_no_decision</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">predict_proba_call_cnt</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="keyword">class</span> <span class="identifier">MockKNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">nonlocal</span> <span class="identifier">predict_proba_call_cnt</span>
            <span class="identifier">predict_proba_call_cnt</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
            <span class="keyword">return</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># no decision function</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MockKNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">scorers</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'roc_auc', 'neg_log_loss'</span><span class="grouping">]</span>
    <span class="identifier">scorer_dict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_check_multimetric_scoring</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">scorers</span><span class="grouping">)</span>
    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_MultimetricScorer</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">scorer_dict</span><span class="grouping">)</span>
    <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">predict_proba_call_cnt</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="keyword">def</span> <span class="identifier">test_multimetric_scorer_calls_method_once_regressor_threshold</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">predict_called_cnt</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="keyword">class</span> <span class="identifier">MockDecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">nonlocal</span> <span class="identifier">predict_called_cnt</span>
            <span class="identifier">predict_called_cnt</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
            <span class="keyword">return</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># no decision function</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MockDecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">scorers</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'neg_mse': 'neg_mean_squared_error', 'r2': 'roc_auc'</span><span class="grouping">}</span>
    <span class="identifier">scorer_dict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_check_multimetric_scoring</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">scorers</span><span class="grouping">)</span>
    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_MultimetricScorer</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">scorer_dict</span><span class="grouping">)</span>
    <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">predict_called_cnt</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="keyword">def</span> <span class="identifier">test_multimetric_scorer_sanity_check</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># scoring dictionary returned is the same as calling each scorer separately</span>
    <span class="identifier">scorers</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a1': 'accuracy', 'a2': 'accuracy'</span><span class="punctuation">,</span>
               <span class="string-literal">'ll1': 'neg_log_loss', 'll2': 'neg_log_loss'</span><span class="punctuation">,</span>
               <span class="string-literal">'ra1': 'roc_auc', 'ra2': 'roc_auc'</span><span class="grouping">}</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">scorer_dict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_check_multimetric_scoring</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">scorers</span><span class="grouping">)</span>
    <span class="identifier">multi_scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_MultimetricScorer</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">scorer_dict</span><span class="grouping">)</span>

    <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">multi_scorer</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">separate_scores</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="identifier">name</span><span class="punctuation">:</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'accuracy', 'neg_log_loss', 'roc_auc'</span><span class="grouping">]</span><span class="grouping">}</span>

    <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">value</span> <span class="relational-operator">in</span> <span class="identifier">result</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">score_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scorers</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">value</span><span class="punctuation">,</span> <span class="identifier">separate_scores</span><span class="grouping">[</span><span class="identifier">score_name</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'scorer_name, metric'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="string-literal">'roc_auc_ovr', partial(roc_auc_score, multi_class='ovr'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'roc_auc_ovo', partial(roc_auc_score, multi_class='ovo'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'roc_auc_ovr_weighted', partial(roc_auc_score, multi_class='ovr'</span><span class="punctuation">,</span>
                                     <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="string-literal">'weighted'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">'roc_auc_ovo_weighted', partial(roc_auc_score, multi_class='ovo'</span><span class="punctuation">,</span>
                                     <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="string-literal">'weighted'</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_multiclass_roc_proba_scorer</span><span class="grouping">(</span><span class="identifier">scorer_name</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="identifier">scorer_name</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">lr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">multi_class</span><span class="arithmetic-assignment">=</span><span class="string-literal">"multinomial"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lr</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">expected_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metric</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_proba</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">lr</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">expected_score</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_multiclass_roc_proba_scorer_label</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">roc_auc_score</span><span class="punctuation">,</span> <span class="identifier">multi_class</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ovo'</span><span class="punctuation">,</span>
                         <span class="identifier">labels</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">needs_proba</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">lr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">multi_class</span><span class="arithmetic-assignment">=</span><span class="string-literal">"multinomial"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lr</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">y_binary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="identifier">expected_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_auc_score</span><span class="grouping">(</span><span class="identifier">y_binary</span><span class="punctuation">,</span> <span class="identifier">y_proba</span><span class="punctuation">,</span>
                                   <span class="identifier">multi_class</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ovo'</span><span class="punctuation">,</span>
                                   <span class="identifier">labels</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">lr</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_binary</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">expected_score</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'scorer_name'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="string-literal">'roc_auc_ovr', 'roc_auc_ovo'</span><span class="punctuation">,</span>
    <span class="string-literal">'roc_auc_ovr_weighted', 'roc_auc_ovo_weighted'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_multiclass_roc_no_proba_scorer_errors</span><span class="grouping">(</span><span class="identifier">scorer_name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Perceptron has no predict_proba</span>
    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="identifier">scorer_name</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">lr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Perceptron</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"'Perceptron' object has no attribute 'predict_proba'"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">lr</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">fixture</span>
<span class="keyword">def</span> <span class="identifier">string_labeled_classification_problem</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Train a classifier on binary problem with string target.

    The classifier is trained on a binary classification problem where the
    minority class of interest has a string label that is intentionally not the
    greatest class label using the lexicographic order. In this case, "cancer"
    is the positive label, and `classifier.classes_` is
    `["cancer", "not cancer"]`.

    In addition, the dataset is imbalanced to better identify problems when
    using non-symmetric performance metrics such as f1-score, average precision
    and so on.

    Returns
    -------
    classifier : estimator object
        Trained classifier on the binary problem.
    X_test : ndarray of shape (n_samples, n_features)
        Data to be used as testing set in tests.
    y_test : ndarray of shape (n_samples,), dtype=object
        Binary target where labels are strings.
    y_pred : ndarray of shape (n_samples,), dtype=object
        Prediction of `classifier` when predicting for `X_test`.
    y_pred_proba : ndarray of shape (n_samples, 2), dtype=np.float64
        Probabilities of `classifier` when predicting for `X_test`.
    y_pred_decision : ndarray of shape (n_samples,), dtype=np.float64
        Decision function values of `classifier` when predicting on `X_test`.
    """</span>
    <span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_breast_cancer</span>
    <span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">shuffle</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_breast_cancer</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="comment"># create an highly imbalanced classification task</span>
    <span class="identifier">idx_positive</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">flatnonzero</span><span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">idx_negative</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">flatnonzero</span><span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">idx_selected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">idx_negative</span><span class="punctuation">,</span> <span class="identifier">idx_positive</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">25</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">idx_selected</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">idx_selected</span><span class="grouping">]</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="comment"># only use 2 features to make the problem even harder</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="string-literal">"cancer" if c == 1 else "not cancer"</span> <span class="keyword">for</span> <span class="identifier">c</span> <span class="relational-operator">in</span> <span class="identifier">y</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span>
    <span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">stratify</span><span class="arithmetic-assignment">=</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">y_pred_proba</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">y_pred_decision</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred_proba</span><span class="punctuation">,</span> <span class="identifier">y_pred_decision</span>


<span class="keyword">def</span> <span class="identifier">test_average_precision_pos_label</span><span class="grouping">(</span><span class="identifier">string_labeled_classification_problem</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that _ThresholdScorer will lead to the right score when passing</span>
    <span class="comment"># `pos_label`. Currently, only `average_precision_score` is defined to</span>
    <span class="comment"># be such a scorer.</span>
    <span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_pred_proba</span><span class="punctuation">,</span> <span class="identifier">y_pred_decision</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="identifier">string_labeled_classification_problem</span>

    <span class="identifier">pos_label</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"cancer"</span>
    <span class="comment"># we need to select the positive column or reverse the decision values</span>
    <span class="identifier">y_pred_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_pred_proba</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">y_pred_decision</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_pred_decision</span> <span class="arithmetic-operator">*</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">pos_label</span>

    <span class="comment"># check that when calling the scoring function, probability estimates and</span>
    <span class="comment"># decision values lead to the same results</span>
    <span class="identifier">ap_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">average_precision_score</span><span class="grouping">(</span>
        <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred_proba</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="identifier">pos_label</span>
    <span class="grouping">)</span>
    <span class="identifier">ap_decision_function</span> <span class="arithmetic-assignment">=</span> <span class="identifier">average_precision_score</span><span class="grouping">(</span>
        <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred_decision</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="identifier">pos_label</span>
    <span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ap_proba</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">ap_decision_function</span><span class="grouping">)</span>

    <span class="comment"># create a scorer which would require to pass a `pos_label`</span>
    <span class="comment"># check that it fails if `pos_label` is not provided</span>
    <span class="identifier">average_precision_scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span>
        <span class="identifier">average_precision_score</span><span class="punctuation">,</span> <span class="identifier">needs_threshold</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"pos_label=1 is not a valid label. It should be one of "</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">average_precision_scorer</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

    <span class="comment"># otherwise, the scorer should give the same results than calling the</span>
    <span class="comment"># scoring function</span>
    <span class="identifier">average_precision_scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span>
        <span class="identifier">average_precision_score</span><span class="punctuation">,</span> <span class="identifier">needs_threshold</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="identifier">pos_label</span>
    <span class="grouping">)</span>
    <span class="identifier">ap_scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">average_precision_scorer</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">ap_scorer</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">ap_proba</span><span class="grouping">)</span>

    <span class="comment"># The above scorer call is using `clf.decision_function`. We will force</span>
    <span class="comment"># it to use `clf.predict_proba`.</span>
    <span class="identifier">clf_without_predict_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">deepcopy</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_predict_proba</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">NotImplementedError</span>

    <span class="identifier">clf_without_predict_proba</span><span class="punctuation">.</span><span class="identifier">predict_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial</span><span class="grouping">(</span>
        <span class="identifier">_predict_proba</span><span class="punctuation">,</span> <span class="identifier">clf_without_predict_proba</span>
    <span class="grouping">)</span>
    <span class="comment"># sanity check</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotImplementedError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf_without_predict_proba</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="identifier">ap_scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">average_precision_scorer</span><span class="grouping">(</span>
        <span class="identifier">clf_without_predict_proba</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span>
    <span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ap_scorer</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">ap_proba</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_brier_score_loss_pos_label</span><span class="grouping">(</span><span class="identifier">string_labeled_classification_problem</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that _ProbaScorer leads to the right score when `pos_label` is</span>
    <span class="comment"># provided. Currently only the `brier_score_loss` is defined to be such</span>
    <span class="comment"># a scorer.</span>
    <span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_pred_proba</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="identifier">string_labeled_classification_problem</span>

    <span class="identifier">pos_label</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"cancer"</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">pos_label</span>

    <span class="comment"># brier score loss is symmetric</span>
    <span class="identifier">brier_pos_cancer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">brier_score_loss</span><span class="grouping">(</span>
        <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred_proba</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"cancer"</span>
    <span class="grouping">)</span>
    <span class="identifier">brier_pos_not_cancer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">brier_score_loss</span><span class="grouping">(</span>
        <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred_proba</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"not cancer"</span>
    <span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">brier_pos_cancer</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">brier_pos_not_cancer</span><span class="grouping">)</span>

    <span class="identifier">brier_scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span>
        <span class="identifier">brier_score_loss</span><span class="punctuation">,</span> <span class="identifier">needs_proba</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="identifier">pos_label</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">brier_scorer</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">brier_pos_cancer</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"score_func"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">f1_score</span><span class="punctuation">,</span> <span class="identifier">precision_score</span><span class="punctuation">,</span> <span class="identifier">recall_score</span><span class="punctuation">,</span> <span class="identifier">jaccard_score</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_non_symmetric_metric_pos_label</span><span class="grouping">(</span>
    <span class="identifier">score_func</span><span class="punctuation">,</span> <span class="identifier">string_labeled_classification_problem</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that _PredictScorer leads to the right score when `pos_label` is</span>
    <span class="comment"># provided. We check for all possible metric supported.</span>
    <span class="comment"># Note: At some point we may end up having "scorer tags".</span>
    <span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">string_labeled_classification_problem</span>

    <span class="identifier">pos_label</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"cancer"</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">pos_label</span>

    <span class="identifier">score_pos_cancer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">score_func</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"cancer"</span><span class="grouping">)</span>
    <span class="identifier">score_pos_not_cancer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">score_func</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"not cancer"</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">score_pos_cancer</span> <span class="relational-operator">!=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">score_pos_not_cancer</span><span class="grouping">)</span>

    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">score_func</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="identifier">pos_label</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">score_pos_cancer</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"scorer"</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="identifier">make_scorer</span><span class="grouping">(</span>
            <span class="identifier">average_precision_score</span><span class="punctuation">,</span> <span class="identifier">needs_threshold</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"xxx"</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">brier_score_loss</span><span class="punctuation">,</span> <span class="identifier">needs_proba</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"xxx"</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">f1_score</span><span class="punctuation">,</span> <span class="identifier">pos_label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"xxx"</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"ThresholdScorer", "ProbaScorer", "PredictScorer"</span><span class="grouping">]</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_scorer_select_proba_error</span><span class="grouping">(</span><span class="identifier">scorer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that we raise the the proper error when passing an unknown</span>
    <span class="comment"># pos_label</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span>
        <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="identifier">lr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">scorer</span><span class="punctuation">.</span><span class="identifier">_kwargs</span><span class="grouping">[</span><span class="string-literal">"pos_label"</span><span class="grouping">]</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"is not a valid label"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">lr</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_scorer_no_op_multiclass_select_proba</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that calling a ProbaScorer on a multiclass problem do not raise</span>
    <span class="comment"># even if `y_true` would be binary during the scoring.</span>
    <span class="comment"># `_select_proba_binary` should not be called in this case.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span>
        <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="identifier">lr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">mask_last_class</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="relational-operator">==</span> <span class="identifier">lr</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">mask_last_class</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">mask_last_class</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">lr</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span>
        <span class="identifier">roc_auc_score</span><span class="punctuation">,</span> <span class="identifier">needs_proba</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">multi_class</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ovo"</span><span class="punctuation">,</span> <span class="identifier">labels</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">lr</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

    </pre>
  </body>
</html>