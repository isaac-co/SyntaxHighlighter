<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
============================
LocalOutlierFactor benchmark
============================

A test of LocalOutlierFactor on classical anomaly detection datasets.

Note that LocalOutlierFactor is not meant to predict on a test set and its
performance is assessed in an outlier detection context:
1. The model is trained on the whole dataset which is assumed to contain
outliers.
2. The ROC curve is computed on the same dataset using the knowledge of the
labels.
In this context there is no need to shuffle the dataset because the model
is trained and tested on the whole dataset. The randomness of this benchmark
is only caused by the random selection of anomalies in the SA dataset.

"""</span>

<span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">time</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">LocalOutlierFactor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">roc_curve</span><span class="punctuation">,</span> <span class="identifier">auc</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">fetch_kddcup99</span><span class="punctuation">,</span> <span class="identifier">fetch_covtype</span><span class="punctuation">,</span> <span class="identifier">fetch_openml</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">LabelBinarizer</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>

<span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>  <span class="comment"># to control the random selection of anomalies in SA</span>

<span class="comment"># datasets available: ['http', 'smtp', 'SA', 'SF', 'shuttle', 'forestcover']</span>
<span class="identifier">datasets</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'http', 'smtp', 'SA', 'SF', 'shuttle', 'forestcover'</span><span class="grouping">]</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">dataset_name</span> <span class="relational-operator">in</span> <span class="identifier">datasets</span><span class="punctuation">:</span>
    <span class="comment"># loading and vectorization</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'loading data'</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">dataset_name</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'http', 'smtp', 'SA', 'SF'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">dataset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_kddcup99</span><span class="grouping">(</span><span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="identifier">dataset_name</span><span class="punctuation">,</span> <span class="identifier">percent10</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">data</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="keyword">if</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'shuttle'</span><span class="punctuation">:</span>
        <span class="identifier">dataset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="string-literal">'shuttle'</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">data</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="comment"># we remove data with label 4</span>
        <span class="comment"># normal data are then those of class 1</span>
        <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="int-literal">4</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">s</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">s</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'forestcover'</span><span class="punctuation">:</span>
        <span class="identifier">dataset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_covtype</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">data</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="comment"># normal data are those with attribute 2</span>
        <span class="comment"># abnormal those with attribute 4</span>
        <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">4</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">s</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">s</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'vectorizing data'</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'SF'</span><span class="punctuation">:</span>
        <span class="identifier">lb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LabelBinarizer</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">x1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lb</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">x1</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="identifier">b</span><span class="string-literal">'normal.'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'SA'</span><span class="punctuation">:</span>
        <span class="identifier">lb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LabelBinarizer</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">x1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lb</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">x2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lb</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">x3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lb</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">x1</span><span class="punctuation">,</span> <span class="identifier">x2</span><span class="punctuation">,</span> <span class="identifier">x3</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="identifier">b</span><span class="string-literal">'normal.'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">dataset_name</span> <span class="relational-operator">==</span> <span class="string-literal">'http' or dataset_name == 'smtp'</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="identifier">b</span><span class="string-literal">'normal.'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">float</span><span class="grouping">)</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'LocalOutlierFactor processing...'</span><span class="grouping">)</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LocalOutlierFactor</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
    <span class="identifier">tstart</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">fit_time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">tstart</span>
    <span class="identifier">scoring</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">negative_outlier_factor_</span>  <span class="comment"># the lower, the more normal</span>
    <span class="identifier">fpr</span><span class="punctuation">,</span> <span class="identifier">tpr</span><span class="punctuation">,</span> <span class="identifier">thresholds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_curve</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="grouping">)</span>
    <span class="identifier">AUC</span> <span class="arithmetic-assignment">=</span> <span class="identifier">auc</span><span class="grouping">(</span><span class="identifier">fpr</span><span class="punctuation">,</span> <span class="identifier">tpr</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">fpr</span><span class="punctuation">,</span> <span class="identifier">tpr</span><span class="punctuation">,</span> <span class="identifier">lw</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
             <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">'ROC for %s (area = %0.3f, train-time: %0.2fs)'</span>
                    <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">dataset_name</span><span class="punctuation">,</span> <span class="identifier">AUC</span><span class="punctuation">,</span> <span class="identifier">fit_time</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlim</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">-0.05</span><span class="punctuation">,</span> <span class="float-literal">1.05</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylim</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">-0.05</span><span class="punctuation">,</span> <span class="float-literal">1.05</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">'False Positive Rate'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">'True Positive Rate'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">'Receiver operating characteristic'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lower right"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>