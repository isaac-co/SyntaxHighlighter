<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
===========================================
Sparse coding with a precomputed dictionary
===========================================

Transform a signal as a sparse combination of Ricker wavelets. This example
visually compares different sparse coding methods using the
:class:`~sklearn.decomposition.SparseCoder` estimator. The Ricker (also known
as Mexican hat or the second derivative of a Gaussian) is not a particularly
good kernel to represent piecewise constant signals like this one. It can
therefore be seen how much adding different widths of atoms matters and it
therefore motivates learning the dictionary to best fit your type of signals.

The richer dictionary on the right is not larger in size, heavier subsampling
is performed in order to stay on the same order of magnitude.
"""</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">SparseCoder</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="identifier">np_version</span><span class="punctuation">,</span> <span class="identifier">parse_version</span>


<span class="keyword">def</span> <span class="identifier">ricker_function</span><span class="grouping">(</span><span class="identifier">resolution</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Discrete sub-sampled Ricker (Mexican hat) wavelet"""</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">resolution</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">resolution</span><span class="grouping">)</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">width</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span> <span class="arithmetic-operator">**</span> <span class="float-literal">.25</span><span class="grouping">)</span><span class="grouping">)</span>
         <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">x</span> <span class="arithmetic-operator">-</span> <span class="identifier">center</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">/</span> <span class="identifier">width</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
         <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="grouping">(</span><span class="identifier">x</span> <span class="arithmetic-operator">-</span> <span class="identifier">center</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">width</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">x</span>


<span class="keyword">def</span> <span class="identifier">ricker_matrix</span><span class="grouping">(</span><span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">resolution</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Dictionary of Ricker (Mexican hat) wavelets"""</span>
    <span class="identifier">centers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">resolution</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">resolution</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">center</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">centers</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">D</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ricker_function</span><span class="grouping">(</span><span class="identifier">resolution</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="grouping">)</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">D</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="keyword">return</span> <span class="identifier">D</span>


<span class="identifier">resolution</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1024</span>
<span class="identifier">subsampling</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>  <span class="comment"># subsampling factor</span>
<span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
<span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">resolution</span> <span class="arithmetic-operator">//</span> <span class="identifier">subsampling</span>

<span class="comment"># Compute a wavelet dictionary</span>
<span class="identifier">D_fixed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ricker_matrix</span><span class="grouping">(</span><span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">resolution</span><span class="arithmetic-assignment">=</span><span class="identifier">resolution</span><span class="punctuation">,</span>
                        <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="grouping">)</span>
<span class="identifier">D_multi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">ricker_matrix</span><span class="grouping">(</span><span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">resolution</span><span class="arithmetic-assignment">=</span><span class="identifier">resolution</span><span class="punctuation">,</span>
                      <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span> <span class="arithmetic-operator">//</span> <span class="int-literal">5</span><span class="grouping">)</span>
                <span class="keyword">for</span> <span class="identifier">w</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>

<span class="comment"># Generate a signal</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">resolution</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">resolution</span><span class="grouping">)</span>
<span class="identifier">first_quarter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="relational-operator">&lt;</span> <span class="identifier">resolution</span> <span class="arithmetic-operator">/</span> <span class="int-literal">4</span>
<span class="identifier">y</span><span class="grouping">[</span><span class="identifier">first_quarter</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span><span class="punctuation">.</span>
<span class="identifier">y</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logical_not</span><span class="grouping">(</span><span class="identifier">first_quarter</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span>

<span class="comment"># List the different sparse coding methods in the following format:</span>
<span class="comment"># (title, transform_algorithm, transform_alpha,</span>
<span class="comment">#  transform_n_nozero_coefs, color)</span>
<span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'OMP', 'omp', None, 15, 'navy'</span><span class="grouping">)</span><span class="punctuation">,</span>
              <span class="grouping">(</span><span class="string-literal">'Lasso', 'lasso_lars', 2, None, 'turquoise'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">]</span>
<span class="identifier">lw</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
<span class="comment"># Avoid FutureWarning about default value change when numpy &gt;= 1.14</span>
<span class="identifier">lstsq_rcond</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span> <span class="keyword">if</span> <span class="identifier">np_version</span> <span class="relational-operator">&gt;=</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">'1.14'</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">13</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">subplot</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">title</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">D_fixed</span><span class="punctuation">,</span> <span class="identifier">D_multi</span><span class="grouping">)</span><span class="punctuation">,</span>
                                         <span class="grouping">(</span><span class="string-literal">'fixed width', 'multiple widths'</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">subplot</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">'Sparse coding against %s dictionary'</span> <span class="arithmetic-operator">%</span> <span class="identifier">title</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">lw</span><span class="arithmetic-assignment">=</span><span class="identifier">lw</span><span class="punctuation">,</span> <span class="identifier">linestyle</span><span class="arithmetic-assignment">=</span><span class="string-literal">'--', label='Original signal'</span><span class="grouping">)</span>
    <span class="comment"># Do a wavelet approximation</span>
    <span class="keyword">for</span> <span class="identifier">title</span><span class="punctuation">,</span> <span class="identifier">algo</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">n_nonzero</span><span class="punctuation">,</span> <span class="identifier">color</span> <span class="relational-operator">in</span> <span class="identifier">estimators</span><span class="punctuation">:</span>
        <span class="identifier">coder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SparseCoder</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="arithmetic-assignment">=</span><span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">transform_n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="identifier">n_nonzero</span><span class="punctuation">,</span>
                            <span class="identifier">transform_alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">transform_algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algo</span><span class="grouping">)</span>
        <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coder</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">density</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">flatnonzero</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">D</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">squared_error</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">x</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">lw</span><span class="arithmetic-assignment">=</span><span class="identifier">lw</span><span class="punctuation">,</span>
                 <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">'%s: %s nonzero coefs,\n%.2f error'</span>
                 <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">title</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="punctuation">,</span> <span class="identifier">squared_error</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Soft thresholding debiasing</span>
    <span class="identifier">coder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SparseCoder</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="arithmetic-assignment">=</span><span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">transform_algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'threshold'</span><span class="punctuation">,</span>
                        <span class="identifier">transform_alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coder</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">x</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">lstsq</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">rcond</span><span class="arithmetic-assignment">=</span><span class="identifier">lstsq_rcond</span><span class="grouping">)</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">D</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">squared_error</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">x</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'darkorange'</span><span class="punctuation">,</span> <span class="identifier">lw</span><span class="arithmetic-assignment">=</span><span class="identifier">lw</span><span class="punctuation">,</span>
             <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Thresholding w/ debiasing:\n%d nonzero coefs, %.2f error'</span>
             <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">squared_error</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="grouping">(</span><span class="string-literal">'tight'</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">shadow</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">'best'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots_adjust</span><span class="grouping">(</span><span class="float-literal">.04</span><span class="punctuation">,</span> <span class="float-literal">.07</span><span class="punctuation">,</span> <span class="float-literal">.97</span><span class="punctuation">,</span> <span class="float-literal">.90</span><span class="punctuation">,</span> <span class="float-literal">.09</span><span class="punctuation">,</span> <span class="float-literal">.2</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>