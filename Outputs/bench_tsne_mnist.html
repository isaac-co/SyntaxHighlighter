<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
=============================
MNIST dataset T-SNE benchmark
=============================

"""</span>

<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span> <span class="keyword">as</span> <span class="identifier">op</span>
<span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">time</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">json</span>
<span class="keyword">import</span> <span class="identifier">argparse</span>
<span class="keyword">from</span> <span class="identifier">joblib</span> <span class="keyword">import</span> <span class="identifier">Memory</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">fetch_openml</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">manifold</span> <span class="keyword">import</span> <span class="identifier">TSNE</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">NearestNeighbors</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">PCA</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_array</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">shuffle</span> <span class="keyword">as</span> <span class="identifier">_shuffle</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_openmp_helpers</span> <span class="keyword">import</span> <span class="identifier">_openmp_effective_n_threads</span>

<span class="identifier">LOG_DIR</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"mnist_tsne_output"</span>
<span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">LOG_DIR</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">mkdir</span><span class="grouping">(</span><span class="identifier">LOG_DIR</span><span class="grouping">)</span>


<span class="identifier">memory</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">LOG_DIR</span><span class="punctuation">,</span> <span class="string-literal">'mnist_tsne_benchmark_data'</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">mmap_mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'r'</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">memory</span><span class="punctuation">.</span><span class="identifier">cache</span>
<span class="keyword">def</span> <span class="identifier">load_data</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'C'</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Load the data, then cache and memmap the train/test split"""</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Loading dataset..."</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="string-literal">'mnist_784'</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">[</span><span class="string-literal">'data'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="identifier">order</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="grouping">[</span><span class="string-literal">"target"</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="identifier">shuffle</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_shuffle</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>

    <span class="comment"># Normalize features</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">/=</span> <span class="int-literal">255</span>
    <span class="keyword">return</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span>


<span class="keyword">def</span> <span class="identifier">nn_accuracy</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_embedded</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Accuracy of the first nearest neighbor"""</span>
    <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">neighbors_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">neighbors_X_embedded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_embedded</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">neighbors_X</span> <span class="relational-operator">==</span> <span class="identifier">neighbors_X_embedded</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">tsne_fit_transform</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">transformed</span><span class="punctuation">,</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">n_iter_</span>


<span class="keyword">def</span> <span class="identifier">sanitize</span><span class="grouping">(</span><span class="identifier">filename</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="identifier">filename</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">"/", '-').replace(" ", "_"</span><span class="grouping">)</span>


<span class="keyword">if</span> <span class="identifier">__name__</span> <span class="relational-operator">==</span> <span class="string-literal">"__main__"</span><span class="punctuation">:</span>
    <span class="identifier">parser</span> <span class="arithmetic-assignment">=</span> <span class="identifier">argparse</span><span class="punctuation">.</span><span class="identifier">ArgumentParser</span><span class="grouping">(</span><span class="string-literal">'Benchmark for t-SNE'</span><span class="grouping">)</span>
    <span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--order', type=str, default='C'</span><span class="punctuation">,</span>
                        <span class="identifier">help</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Order of the input data'</span><span class="grouping">)</span>
    <span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--perplexity'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">float</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="grouping">)</span>
    <span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--bhtsne', action='store_true'</span><span class="punctuation">,</span>
                        <span class="identifier">help</span><span class="arithmetic-assignment">=</span><span class="string-literal">"if set and the reference bhtsne code is "</span>
                        <span class="string-literal">"correctly installed, run it in the benchmark."</span><span class="grouping">)</span>
    <span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--all', action='store_true'</span><span class="punctuation">,</span>
                        <span class="identifier">help</span><span class="arithmetic-assignment">=</span><span class="string-literal">"if set, run the benchmark with the whole MNIST."</span>
                             <span class="string-literal">"dataset. Note that it will take up to 1 hour."</span><span class="grouping">)</span>
    <span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--profile', action='store_true'</span><span class="punctuation">,</span>
                        <span class="identifier">help</span><span class="arithmetic-assignment">=</span><span class="string-literal">"if set, run the benchmark with a memory "</span>
                             <span class="string-literal">"profiler."</span><span class="grouping">)</span>
    <span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--verbose'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--pca-components'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span>
                        <span class="identifier">help</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Number of principal components for "</span>
                             <span class="string-literal">"preprocessing."</span><span class="grouping">)</span>
    <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">parse_args</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Used number of threads: {}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">_openmp_effective_n_threads</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_data</span><span class="grouping">(</span><span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">order</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">pca_components</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">pca_components</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"PCA preprocessing down to {} dimensions took {:0.3f}s"</span>
              <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">pca_components</span><span class="punctuation">,</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">methods</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

    <span class="comment"># Put TSNE in methods</span>
    <span class="identifier">tsne</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TSNE</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'pca'</span><span class="punctuation">,</span> <span class="identifier">perplexity</span><span class="arithmetic-assignment">=</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="punctuation">,</span>
                <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span>
    <span class="identifier">methods</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">"sklearn TSNE"</span><span class="punctuation">,</span>
                    <span class="keyword">lambda</span> <span class="identifier">data</span><span class="punctuation">:</span> <span class="identifier">tsne_fit_transform</span><span class="grouping">(</span><span class="identifier">tsne</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">bhtsne</span><span class="punctuation">:</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="keyword">from</span> <span class="identifier">bhtsne</span><span class="punctuation">.</span><span class="identifier">bhtsne</span> <span class="keyword">import</span> <span class="identifier">run_bh_tsne</span>
        <span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span> <span class="keyword">as</span> <span class="identifier">e</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="comment">"""\
If you want comparison with the reference implementation, build the
binary from source (https://github.com/lvdmaaten/bhtsne) in the folder
benchmarks/bhtsne and add an empty `__init__.py` file in the folder:

$ git clone git@github.com:lvdmaaten/bhtsne.git
$ cd bhtsne
$ g++ sptree.cpp tsne.cpp tsne_main.cpp -o bh_tsne -O2
$ touch __init__.py
$ cd ..
"""</span><span class="grouping">)</span> <span class="keyword">from</span> <span class="identifier">e</span>

        <span class="keyword">def</span> <span class="identifier">bhtsne</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment">"""Wrapper for the reference lvdmaaten/bhtsne implementation."""</span>
            <span class="comment"># PCA preprocessing is done elsewhere in the benchmark script</span>
            <span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>  <span class="comment"># TODO find a way to report the number of iterations</span>
            <span class="keyword">return</span> <span class="identifier">run_bh_tsne</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">use_pca</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">perplexity</span><span class="arithmetic-assignment">=</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="punctuation">,</span>
                               <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_iter</span>
        <span class="identifier">methods</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">"lvdmaaten/bhtsne"</span><span class="punctuation">,</span> <span class="identifier">bhtsne</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">profile</span><span class="punctuation">:</span>

        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="keyword">from</span> <span class="identifier">memory_profiler</span> <span class="keyword">import</span> <span class="identifier">profile</span>
        <span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span> <span class="keyword">as</span> <span class="identifier">e</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="string-literal">"To run the benchmark with `--profile`, you "</span>
                              <span class="string-literal">"need to install `memory_profiler`. Please "</span>
                              <span class="string-literal">"run `pip install memory_profiler`."</span><span class="grouping">)</span> <span class="keyword">from</span> <span class="identifier">e</span>
        <span class="identifier">methods</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">profile</span><span class="grouping">(</span><span class="identifier">m</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">m</span> <span class="relational-operator">in</span> <span class="identifier">methods</span><span class="grouping">]</span>

    <span class="identifier">data_size</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">5000</span><span class="punctuation">,</span> <span class="int-literal">10000</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">all</span><span class="punctuation">:</span>
        <span class="identifier">data_size</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="int-literal">70000</span><span class="grouping">)</span>

    <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="identifier">basename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">basename</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">splitext</span><span class="grouping">(</span><span class="identifier">__file__</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">log_filename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">LOG_DIR</span><span class="punctuation">,</span> <span class="identifier">basename</span> <span class="arithmetic-operator">+</span> <span class="string-literal">'.json'</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">n</span> <span class="relational-operator">in</span> <span class="identifier">data_size</span><span class="punctuation">:</span>
        <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n</span><span class="grouping">]</span>
        <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n</span><span class="grouping">]</span>
        <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="identifier">methods</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Fitting {} on {} samples..."</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">save</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">LOG_DIR</span><span class="punctuation">,</span> <span class="string-literal">'mnist_{}_{}.npy'</span>
                                 <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="string-literal">'original'</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_train</span><span class="grouping">)</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">save</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">LOG_DIR</span><span class="punctuation">,</span> <span class="string-literal">'mnist_{}_{}.npy'</span>
                                 <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="string-literal">'original_labels'</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
            <span class="identifier">X_embedded</span><span class="punctuation">,</span> <span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">method</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
            <span class="identifier">duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span>
            <span class="identifier">precision_5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn_accuracy</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_embedded</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Fitting {} on {} samples took {:.3f}s in {:d} iterations, "</span>
                  <span class="string-literal">"nn accuracy: {:0.3f}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                      <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">duration</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="punctuation">,</span> <span class="identifier">precision_5</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">results</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">duration</span><span class="arithmetic-assignment">=</span><span class="identifier">duration</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">log_filename</span><span class="punctuation">,</span> <span class="string-literal">'w', encoding='utf-8'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
                <span class="identifier">json</span><span class="punctuation">.</span><span class="identifier">dump</span><span class="grouping">(</span><span class="identifier">results</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">)</span>
            <span class="identifier">method_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sanitize</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">save</span><span class="grouping">(</span><span class="identifier">op</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">LOG_DIR</span><span class="punctuation">,</span> <span class="string-literal">'mnist_{}_{}.npy'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">method_name</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">X_embedded</span><span class="grouping">)</span>

    </pre>
  </body>
</html>