<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
Several basic tests for hierarchical clustering procedures

"""</span>
<span class="comment"># Authors: Vincent Michel, 2010, Gael Varoquaux 2012,</span>
<span class="comment">#          Matteo Visconti di Oleggio Castello 2014</span>
<span class="comment"># License: BSD 3 clause</span>
<span class="keyword">import</span> <span class="identifier">itertools</span>
<span class="keyword">from</span> <span class="identifier">tempfile</span> <span class="keyword">import</span> <span class="identifier">mkdtemp</span>
<span class="keyword">import</span> <span class="identifier">shutil</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">from</span> <span class="identifier">functools</span> <span class="keyword">import</span> <span class="identifier">partial</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">sparse</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">hierarchy</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">adjusted_rand_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">tests</span><span class="punctuation">.</span><span class="identifier">test_dist_metrics</span> <span class="keyword">import</span> <span class="identifier">METRICS_DEFAULT_PARAMS</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
    <span class="identifier">create_memmap_backed_data</span>
<span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">ward_tree</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">AgglomerativeClustering</span><span class="punctuation">,</span> <span class="identifier">FeatureAgglomeration</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span><span class="punctuation">.</span><span class="identifier">_agglomerative</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">_hc_cut</span><span class="punctuation">,</span> <span class="identifier">_TREE_BUILDERS</span><span class="punctuation">,</span>
                                            <span class="identifier">linkage_tree</span><span class="punctuation">,</span>
                                            <span class="identifier">_fix_connectivity</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">image</span> <span class="keyword">import</span> <span class="identifier">grid_to_graph</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">PAIRED_DISTANCES</span><span class="punctuation">,</span> <span class="identifier">cosine_distances</span><span class="punctuation">,</span><span class="invalid">\</span>
    <span class="identifier">manhattan_distances</span><span class="punctuation">,</span> <span class="identifier">pairwise_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">normalized_mutual_info_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">kneighbors_graph</span><span class="punctuation">,</span> <span class="identifier">DistanceMetric</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span><span class="punctuation">.</span><span class="identifier">_hierarchical_fast</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">average_merge</span><span class="punctuation">,</span>
    <span class="identifier">max_merge</span><span class="punctuation">,</span>
    <span class="identifier">mst_linkage_core</span>
<span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_fast_dict</span> <span class="keyword">import</span> <span class="identifier">IntFloatDict</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_moons</span><span class="punctuation">,</span> <span class="identifier">make_circles</span>


<span class="keyword">def</span> <span class="identifier">test_linkage_misc</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Misc tests on linkage</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">'foo'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">linkage_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">'foo'</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">linkage_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Smoke test FeatureAgglomeration</span>
    <span class="identifier">FeatureAgglomeration</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># test hierarchical clustering on a precomputed distances matrix</span>
    <span class="identifier">dis</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cosine_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">res</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linkage_tree</span><span class="grouping">(</span><span class="identifier">dis</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"precomputed"</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">res</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">linkage_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"cosine"</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># test hierarchical clustering on a precomputed distances matrix</span>
    <span class="identifier">res</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linkage_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="identifier">manhattan_distances</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">res</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">linkage_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"manhattan"</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_structured_linkage_tree</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that we obtain the correct solution for structured linkage trees.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="comment"># Avoiding a mask with only 'True' entries</span>
    <span class="identifier">mask</span><span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">:</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">:</span><span class="int-literal">7</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">tree_builder</span> <span class="relational-operator">in</span> <span class="identifier">_TREE_BUILDERS</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="punctuation">,</span> <span class="identifier">parent</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
            <span class="identifier">tree_builder</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span>
        <span class="identifier">n_nodes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">children</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_leaves</span> <span class="relational-operator">==</span> <span class="identifier">n_nodes</span>
        <span class="comment"># Check that ward_tree raises a ValueError with a connectivity matrix</span>
        <span class="comment"># of the wrong shape</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">tree_builder</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># Check that fitting with no samples raises an error</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">tree_builder</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_unstructured_linkage_tree</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that we obtain the correct solution for unstructured linkage trees.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">this_X</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># With specified a number of clusters just for the sake of</span>
        <span class="comment"># raising a warning and testing the warning code</span>
        <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">n_nodes</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="punctuation">,</span> <span class="identifier">parent</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ward_tree</span><span class="grouping">(</span>
                    <span class="identifier">this_X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
        <span class="identifier">n_nodes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">children</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_leaves</span> <span class="relational-operator">==</span> <span class="identifier">n_nodes</span>

    <span class="keyword">for</span> <span class="identifier">tree_builder</span> <span class="relational-operator">in</span> <span class="identifier">_TREE_BUILDERS</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">this_X</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">n_nodes</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="punctuation">,</span> <span class="identifier">parent</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree_builder</span><span class="grouping">(</span>
                        <span class="identifier">this_X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
            <span class="identifier">n_nodes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
            <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">children</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_leaves</span> <span class="relational-operator">==</span> <span class="identifier">n_nodes</span>


<span class="keyword">def</span> <span class="identifier">test_height_linkage_tree</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that the height of the results of linkage tree is sorted.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">linkage_func</span> <span class="relational-operator">in</span> <span class="identifier">_TREE_BUILDERS</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">n_nodes</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="punctuation">,</span> <span class="identifier">parent</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linkage_func</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span>
        <span class="identifier">n_nodes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">children</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_leaves</span> <span class="relational-operator">==</span> <span class="identifier">n_nodes</span>


<span class="keyword">def</span> <span class="identifier">test_agglomerative_clustering_wrong_arg_memory</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test either if an error is raised when memory is not</span>
    <span class="comment"># either a str or a joblib.Memory instance</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span>
    <span class="identifier">memory</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">memory</span><span class="arithmetic-assignment">=</span><span class="identifier">memory</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_zero_cosine_linkage_tree</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that zero vectors in X produce an error when</span>
    <span class="comment"># 'cosine' affinity is used</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Cosine affinity cannot be used when X contains zero vectors'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">linkage_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cosine'</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_clusters, distance_threshold'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'compute_distances'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'linkage'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">"ward", "complete", "average", "single"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_agglomerative_clustering_distances</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="punctuation">,</span>
                                            <span class="identifier">compute_distances</span><span class="punctuation">,</span>
                                            <span class="identifier">distance_threshold</span><span class="punctuation">,</span>
                                            <span class="identifier">linkage</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that when `compute_distances` is True or `distance_threshold` is</span>
    <span class="comment"># given, the fitted model has an attribute `distances_`.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>

    <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="identifier">n_clusters</span><span class="punctuation">,</span>
                                         <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">,</span>
                                         <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="punctuation">,</span>
                                         <span class="identifier">distance_threshold</span><span class="arithmetic-assignment">=</span><span class="identifier">distance_threshold</span><span class="punctuation">,</span>
                                         <span class="identifier">compute_distances</span><span class="arithmetic-assignment">=</span><span class="identifier">compute_distances</span><span class="grouping">)</span>
    <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">compute_distances</span> <span class="logical-operator">or</span> <span class="grouping">(</span><span class="identifier">distance_threshold</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clustering</span><span class="punctuation">,</span> <span class="string-literal">'distances_'</span><span class="grouping">)</span>
        <span class="identifier">n_children</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">children_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">n_nodes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_children</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="keyword">assert</span> <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">distances_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_nodes</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clustering</span><span class="punctuation">,</span> <span class="string-literal">'distances_'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_agglomerative_clustering</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that we obtain the correct number of clusters with</span>
    <span class="comment"># agglomerative clustering.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">linkage</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"ward", "complete", "average", "single"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                             <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">,</span>
                                             <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="grouping">)</span>
        <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="comment"># test caching</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">tempdir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mkdtemp</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
                <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">,</span>
                <span class="identifier">memory</span><span class="arithmetic-assignment">=</span><span class="identifier">tempdir</span><span class="punctuation">,</span>
                <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="grouping">)</span>
            <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">labels_</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">labels</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">10</span>
        <span class="keyword">finally</span><span class="punctuation">:</span>
            <span class="identifier">shutil</span><span class="punctuation">.</span><span class="identifier">rmtree</span><span class="grouping">(</span><span class="identifier">tempdir</span><span class="grouping">)</span>
        <span class="comment"># Turn caching off now</span>
        <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
            <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">,</span> <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="grouping">)</span>
        <span class="comment"># Check that we obtain the same solution with early-stopping of the</span>
        <span class="comment"># tree building</span>
        <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">compute_full_tree</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">normalized_mutual_info_score</span><span class="grouping">(</span><span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="punctuation">,</span>
                                                         <span class="identifier">labels</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">10</span>
        <span class="comment"># Check that we raise a TypeError on dense matrices</span>
        <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
            <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
            <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">lil_matrix</span><span class="grouping">(</span>
                <span class="identifier">connectivity</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Test that using ward with another metric than euclidean raises an</span>
    <span class="comment"># exception</span>
    <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
        <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
        <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"manhattan"</span><span class="punctuation">,</span>
        <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ward"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Test using another metric than euclidean works with linkage complete</span>
    <span class="keyword">for</span> <span class="identifier">affinity</span> <span class="relational-operator">in</span> <span class="identifier">PAIRED_DISTANCES</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Compare our (structured) implementation to scipy</span>
        <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
            <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
            <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="identifier">affinity</span><span class="punctuation">,</span>
            <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">"complete"</span><span class="grouping">)</span>
        <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">clustering2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
            <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
            <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
            <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="identifier">affinity</span><span class="punctuation">,</span>
            <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">"complete"</span><span class="grouping">)</span>
        <span class="identifier">clustering2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">normalized_mutual_info_score</span><span class="grouping">(</span><span class="identifier">clustering2</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="punctuation">,</span>
                                                         <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># Test that using a distance matrix (affinity = 'precomputed') has same</span>
    <span class="comment"># results (with connectivity constraints)</span>
    <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                         <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">,</span>
                                         <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">"complete"</span><span class="grouping">)</span>
    <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">clustering2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                          <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">,</span>
                                          <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="punctuation">,</span>
                                          <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">"complete"</span><span class="grouping">)</span>
    <span class="identifier">clustering2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_dist</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="punctuation">,</span> <span class="identifier">clustering2</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_agglomerative_clustering_memory_mapped</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""AgglomerativeClustering must work on mem-mapped dataset.

    Non-regression test for issue #19875.
    """</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">Xmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">create_memmap_backed_data</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">"euclidean", linkage="single"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">Xmm</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ward_agglomeration</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that we obtain the correct solution in a simplistic case</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="identifier">agglo</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureAgglomeration</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span>
    <span class="identifier">agglo</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">agglo</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>

    <span class="identifier">X_red</span> <span class="arithmetic-assignment">=</span> <span class="identifier">agglo</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_red</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>
    <span class="identifier">X_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">agglo</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">X_red</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">X_full</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">agglo</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_full</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_red</span><span class="grouping">)</span>

    <span class="comment"># Check that fitting with no samples raises a ValueError</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">agglo</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_single_linkage_clustering</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that we get the correct result in two emblematic cases</span>
    <span class="identifier">moons</span><span class="punctuation">,</span> <span class="identifier">moon_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_moons</span><span class="grouping">(</span><span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">'single'</span><span class="grouping">)</span>
    <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">moons</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">normalized_mutual_info_score</span><span class="grouping">(</span><span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="punctuation">,</span>
                                                     <span class="identifier">moon_labels</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">circles</span><span class="punctuation">,</span> <span class="identifier">circle_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_circles</span><span class="grouping">(</span><span class="identifier">factor</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.025</span><span class="punctuation">,</span>
                                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">'single'</span><span class="grouping">)</span>
    <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">circles</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">normalized_mutual_info_score</span><span class="grouping">(</span><span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="punctuation">,</span>
                                                     <span class="identifier">circle_labels</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="grouping">(</span><span class="identifier">cut1</span><span class="punctuation">,</span> <span class="identifier">cut2</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Util for comparison with scipy"""</span>
    <span class="identifier">co_clust</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">cut</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">cut1</span><span class="punctuation">,</span> <span class="identifier">cut2</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">cut</span><span class="grouping">)</span>
        <span class="identifier">k</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cut</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="identifier">ecut</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">ecut</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cut</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">co_clust</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">ecut</span><span class="punctuation">,</span> <span class="identifier">ecut</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">co_clust</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">co_clust</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sparse_scikit_vs_scipy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test scikit linkage with full connectivity (i.e. unstructured) vs scipy</span>
    <span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="punctuation">,</span> <span class="identifier">k</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Not using a lil_matrix here, just to check that non sparse</span>
    <span class="comment"># matrices are well handled</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">linkage</span> <span class="relational-operator">in</span> <span class="identifier">_TREE_BUILDERS</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="int-literal">4</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>

            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hierarchy</span><span class="punctuation">.</span><span class="identifier">linkage</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="grouping">)</span>

            <span class="identifier">children_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_TREE_BUILDERS</span><span class="grouping">[</span><span class="identifier">linkage</span><span class="grouping">]</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span>

            <span class="comment"># Sort the order of child nodes per row for consistency</span>
            <span class="identifier">children</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">children_</span><span class="punctuation">,</span> <span class="string-literal">'linkage tree differs'</span>
                                                    <span class="string-literal">' from scipy impl for'</span>
                                                    <span class="string-literal">' linkage: '</span> <span class="arithmetic-operator">+</span> <span class="identifier">linkage</span><span class="grouping">)</span>

            <span class="identifier">cut</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_hc_cut</span><span class="grouping">(</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="grouping">)</span>
            <span class="identifier">cut_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_hc_cut</span><span class="grouping">(</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">children_</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="grouping">(</span><span class="identifier">cut</span><span class="punctuation">,</span> <span class="identifier">cut_</span><span class="grouping">)</span>

    <span class="comment"># Test error management in _hc_cut</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_hc_cut</span><span class="grouping">(</span><span class="identifier">n_leaves</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="grouping">)</span>


<span class="comment"># Make sure our custom mst_linkage_core gives</span>
<span class="comment"># the same results as scipy's builtin</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'seed'</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_vector_scikit_single_vs_scipy_single</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="int-literal">4</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>

    <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hierarchy</span><span class="punctuation">.</span><span class="identifier">linkage</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'single'</span><span class="grouping">)</span>
    <span class="identifier">children_scipy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_TREE_BUILDERS</span><span class="grouping">[</span><span class="string-literal">'single'</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Sort the order of child nodes per row for consistency</span>
    <span class="identifier">children</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">children_scipy</span><span class="punctuation">,</span>
                       <span class="string-literal">'linkage tree differs'</span>
                       <span class="string-literal">' from scipy impl for'</span>
                       <span class="string-literal">' single linkage.'</span><span class="grouping">)</span>

    <span class="identifier">cut</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_hc_cut</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="punctuation">,</span> <span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="grouping">)</span>
    <span class="identifier">cut_scipy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_hc_cut</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="punctuation">,</span> <span class="identifier">children_scipy</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="grouping">(</span><span class="identifier">cut</span><span class="punctuation">,</span> <span class="identifier">cut_scipy</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'metric'</span><span class="punctuation">,</span> <span class="identifier">METRICS_DEFAULT_PARAMS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_mst_linkage_core_memory_mapped</span><span class="grouping">(</span><span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""The MST-LINKAGE-CORE algorithm must work on mem-mapped dataset.

    Non-regression test for issue #19875.
    """</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Xmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">create_memmap_backed_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">argdict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">METRICS_DEFAULT_PARAMS</span><span class="grouping">[</span><span class="identifier">metric</span><span class="grouping">]</span>
    <span class="identifier">keys</span> <span class="arithmetic-assignment">=</span> <span class="identifier">argdict</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">vals</span> <span class="relational-operator">in</span> <span class="identifier">itertools</span><span class="punctuation">.</span><span class="identifier">product</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">argdict</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">keys</span><span class="punctuation">,</span> <span class="identifier">vals</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">distance_metric</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DistanceMetric</span><span class="punctuation">.</span><span class="identifier">get_metric</span><span class="grouping">(</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">mst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mst_linkage_core</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">distance_metric</span><span class="grouping">)</span>
        <span class="identifier">mst_mm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mst_linkage_core</span><span class="grouping">(</span><span class="identifier">Xmm</span><span class="punctuation">,</span> <span class="identifier">distance_metric</span><span class="grouping">)</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">mst</span><span class="punctuation">,</span> <span class="identifier">mst_mm</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_identical_points</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensure identical points are handled correctly when using mst with</span>
    <span class="comment"># a sparse connectivity matrix</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">true_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">connectivity</span> <span class="arithmetic-operator">+</span> <span class="identifier">connectivity</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_fix_connectivity</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span>
                                                   <span class="identifier">connectivity</span><span class="punctuation">,</span>
                                                   <span class="string-literal">'euclidean'</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">linkage</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'single', 'average', 'average', 'ward'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                             <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="punctuation">,</span>
                                             <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span>
        <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">normalized_mutual_info_score</span><span class="grouping">(</span><span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="punctuation">,</span>
                                                         <span class="identifier">true_labels</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_connectivity_propagation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that connectivity in the ward tree is propagated correctly during</span>
    <span class="comment"># merging.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="float-literal">.014</span><span class="punctuation">,</span> <span class="float-literal">.120</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.014</span><span class="punctuation">,</span> <span class="float-literal">.099</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.014</span><span class="punctuation">,</span> <span class="float-literal">.097</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="grouping">(</span><span class="float-literal">.017</span><span class="punctuation">,</span> <span class="float-literal">.153</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.017</span><span class="punctuation">,</span> <span class="float-literal">.153</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.018</span><span class="punctuation">,</span> <span class="float-literal">.153</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="grouping">(</span><span class="float-literal">.018</span><span class="punctuation">,</span> <span class="float-literal">.153</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.018</span><span class="punctuation">,</span> <span class="float-literal">.153</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.018</span><span class="punctuation">,</span> <span class="float-literal">.153</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="grouping">(</span><span class="float-literal">.018</span><span class="punctuation">,</span> <span class="float-literal">.153</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.018</span><span class="punctuation">,</span> <span class="float-literal">.153</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.018</span><span class="punctuation">,</span> <span class="float-literal">.153</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="grouping">(</span><span class="float-literal">.018</span><span class="punctuation">,</span> <span class="float-literal">.152</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.018</span><span class="punctuation">,</span> <span class="float-literal">.149</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">.018</span><span class="punctuation">,</span> <span class="float-literal">.144</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">ward</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
        <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">,</span> <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ward'</span><span class="grouping">)</span>
    <span class="comment"># If changes are not propagated correctly, fit crashes with an</span>
    <span class="comment"># IndexError</span>
    <span class="identifier">ward</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ward_tree_children_order</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that children are ordered in the same way for both structured and</span>
    <span class="comment"># unstructured versions of ward_tree.</span>

    <span class="comment"># test on five random datasets</span>
    <span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="int-literal">4</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>

        <span class="identifier">out_unstructured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ward_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">out_structured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ward_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">out_unstructured</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">out_structured</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ward_linkage_tree_return_distance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test return_distance option on linkage and ward trees</span>

    <span class="comment"># test that return_distance when set true, gives same</span>
    <span class="comment"># output on both structured and unstructured clustering.</span>
    <span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="int-literal">4</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>

        <span class="identifier">out_unstructured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ward_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">out_structured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ward_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">,</span>
                                   <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

        <span class="comment"># get children</span>
        <span class="identifier">children_unstructured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out_unstructured</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">children_structured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out_structured</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

        <span class="comment"># check if we got the same clusters</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">children_unstructured</span><span class="punctuation">,</span> <span class="identifier">children_structured</span><span class="grouping">)</span>

        <span class="comment"># check if the distances are the same</span>
        <span class="identifier">dist_unstructured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out_unstructured</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">dist_structured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out_structured</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist_unstructured</span><span class="punctuation">,</span> <span class="identifier">dist_structured</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">linkage</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'average', 'complete', 'single'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">structured_items</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linkage_tree</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">,</span> <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="punctuation">,</span>
                <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">unstructured_items</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linkage_tree</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">structured_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">structured_items</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">unstructured_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">unstructured_items</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">structured_children</span> <span class="arithmetic-assignment">=</span> <span class="identifier">structured_items</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">unstructured_children</span> <span class="arithmetic-assignment">=</span> <span class="identifier">unstructured_items</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">structured_dist</span><span class="punctuation">,</span> <span class="identifier">unstructured_dist</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                <span class="identifier">structured_children</span><span class="punctuation">,</span> <span class="identifier">unstructured_children</span><span class="grouping">)</span>

    <span class="comment"># test on the following dataset where we know the truth</span>
    <span class="comment"># taken from scipy/cluster/tests/hierarchy_test_data.py</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.43054825</span><span class="punctuation">,</span> <span class="float-literal">-7.5693489</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">6.95887839</span><span class="punctuation">,</span> <span class="float-literal">6.82293382</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">2.87137846</span><span class="punctuation">,</span> <span class="float-literal">-9.68248579</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">7.87974764</span><span class="punctuation">,</span> <span class="float-literal">-6.05485803</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">8.24018364</span><span class="punctuation">,</span> <span class="float-literal">-6.09495602</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">7.39020262</span><span class="punctuation">,</span> <span class="float-literal">8.54004355</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="comment"># truth</span>
    <span class="identifier">linkage_X_ward</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">0.36265956</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1.77045373</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">2.55760419</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">9.10208346</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="grouping">[</span><span class="int-literal">7</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">24.7784379</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">linkage_X_complete</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">0.36265956</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1.77045373</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">2.55760419</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">6.96742194</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">7</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">18.77445997</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">linkage_X_average</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">0.36265956</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1.77045373</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">2.55760419</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">6.55832839</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">7</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">15.44089605</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">connectivity_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">out_X_unstructured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ward_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">out_X_structured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ward_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity_X</span><span class="punctuation">,</span>
                                 <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="comment"># check that the labels are the same</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">linkage_X_ward</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">out_X_unstructured</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">linkage_X_ward</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">out_X_structured</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># check that the distances are correct</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">linkage_X_ward</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">out_X_unstructured</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">linkage_X_ward</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">out_X_structured</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">linkage_options</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'complete', 'average', 'single'</span><span class="grouping">]</span>
    <span class="identifier">X_linkage_truth</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">linkage_X_complete</span><span class="punctuation">,</span> <span class="identifier">linkage_X_average</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">linkage</span><span class="punctuation">,</span> <span class="identifier">X_truth</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">linkage_options</span><span class="punctuation">,</span> <span class="identifier">X_linkage_truth</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">out_X_unstructured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linkage_tree</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="grouping">)</span>
        <span class="identifier">out_X_structured</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linkage_tree</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity_X</span><span class="punctuation">,</span> <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="punctuation">,</span>
            <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

        <span class="comment"># check that the labels are the same</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_truth</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">out_X_unstructured</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_truth</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">out_X_structured</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># check that the distances are correct</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_truth</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">out_X_unstructured</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_truth</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">out_X_structured</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_connectivity_fixing_non_lil</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check non regression of a bug if a non item assignable connectivity is</span>
    <span class="comment"># provided with more than one component.</span>
    <span class="comment"># create dummy data</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="comment"># create a mask with several components to force connectivity fixing</span>
    <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">c</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">m</span><span class="grouping">)</span>
    <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">c</span><span class="punctuation">,</span> <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ward'</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">w</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_int_float_dict</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">keys</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">intp</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">keys</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IntFloatDict</span><span class="grouping">(</span><span class="identifier">keys</span><span class="punctuation">,</span> <span class="identifier">values</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">value</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">keys</span><span class="punctuation">,</span> <span class="identifier">values</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">d</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">value</span>

    <span class="identifier">other_keys</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">intp</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">other_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">other</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IntFloatDict</span><span class="grouping">(</span><span class="identifier">other_keys</span><span class="punctuation">,</span> <span class="identifier">other_values</span><span class="grouping">)</span>
    <span class="comment"># Complete smoke test</span>
    <span class="identifier">max_merge</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">other</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">intp</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_a</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_b</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">average_merge</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">other</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">intp</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_a</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_b</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_connectivity_callable</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">aglc1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span>
    <span class="identifier">aglc2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
        <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">kneighbors_graph</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                             <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">aglc1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">aglc2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">aglc1</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="punctuation">,</span> <span class="identifier">aglc2</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_connectivity_ignores_diagonal</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">connectivity_include_self</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">aglc1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span>
    <span class="identifier">aglc2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity_include_self</span><span class="grouping">)</span>
    <span class="identifier">aglc1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">aglc2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">aglc1</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="punctuation">,</span> <span class="identifier">aglc2</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_compute_full_tree</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the full tree is computed if n_clusters is small</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="comment"># When n_clusters is less, the full tree should be built</span>
    <span class="comment"># that is the number of merges should be n_samples - 1</span>
    <span class="identifier">agc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span>
    <span class="identifier">agc</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">n_nodes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">agc</span><span class="punctuation">.</span><span class="identifier">children_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">n_nodes</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

    <span class="comment"># When n_clusters is large, greater than max of 100 and 0.02 * n_samples.</span>
    <span class="comment"># we should stop when there are n_clusters.</span>
    <span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">101</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">agc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="identifier">n_clusters</span><span class="punctuation">,</span>
                                  <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span>
    <span class="identifier">agc</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">n_nodes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">agc</span><span class="punctuation">.</span><span class="identifier">children_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">n_nodes</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_clusters</span>


<span class="keyword">def</span> <span class="identifier">test_n_components</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test n_components returned by linkage, average and ward tree</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>

    <span class="comment"># Connectivity matrix having five components.</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">linkage_func</span> <span class="relational-operator">in</span> <span class="identifier">_TREE_BUILDERS</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">linkage_func</span><span class="grouping">)</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>


<span class="keyword">def</span> <span class="identifier">test_agg_n_clusters</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that an error is raised when n_clusters &lt;= 0</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">n_clus</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">agc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="identifier">n_clus</span><span class="grouping">)</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"n_clusters should be an integer greater than 0."</span>
               <span class="string-literal">" %s was provided."</span> <span class="arithmetic-operator">%</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">agc</span><span class="punctuation">.</span><span class="identifier">n_clusters</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">agc</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_affinity_passed_to_fix_connectivity</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the affinity parameter is actually passed to the pairwise</span>
    <span class="comment"># function</span>

    <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span>
                                 <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>

    <span class="keyword">class</span> <span class="identifier">FakeAffinity</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">counter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

        <span class="keyword">def</span> <span class="identifier">increment</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">counter</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
            <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">counter</span>

    <span class="identifier">fa</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FakeAffinity</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">linkage_tree</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">connectivity</span><span class="punctuation">,</span> <span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">increment</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">counter</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'linkage', ['ward', 'complete', 'average'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_agglomerative_clustering_with_distance_threshold</span><span class="grouping">(</span><span class="identifier">linkage</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that we obtain the correct number of clusters with</span>
    <span class="comment"># agglomerative clustering with distance_threshold.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span>
    <span class="identifier">connectivity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="comment"># test when distance threshold is set to 10</span>
    <span class="identifier">distance_threshold</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="keyword">for</span> <span class="identifier">conn</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
            <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
            <span class="identifier">distance_threshold</span><span class="arithmetic-assignment">=</span><span class="identifier">distance_threshold</span><span class="punctuation">,</span>
            <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">conn</span><span class="punctuation">,</span> <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="grouping">)</span>
        <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">clusters_produced</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">labels_</span>
        <span class="identifier">num_clusters_produced</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">labels_</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># test if the clusters produced match the point in the linkage tree</span>
        <span class="comment"># where the distance exceeds the threshold</span>
        <span class="identifier">tree_builder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_TREE_BUILDERS</span><span class="grouping">[</span><span class="identifier">linkage</span><span class="grouping">]</span>
        <span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_leaves</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
            <span class="identifier">tree_builder</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">connectivity</span><span class="arithmetic-assignment">=</span><span class="identifier">conn</span><span class="punctuation">,</span> <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                         <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">num_clusters_at_threshold</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">count_nonzero</span><span class="grouping">(</span>
            <span class="identifier">distances</span> <span class="relational-operator">&gt;=</span> <span class="identifier">distance_threshold</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="comment"># test number of clusters produced</span>
        <span class="keyword">assert</span> <span class="identifier">num_clusters_at_threshold</span> <span class="relational-operator">==</span> <span class="identifier">num_clusters_produced</span>
        <span class="comment"># test clusters produced</span>
        <span class="identifier">clusters_at_threshold</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_hc_cut</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="identifier">num_clusters_produced</span><span class="punctuation">,</span>
                                        <span class="identifier">children</span><span class="arithmetic-assignment">=</span><span class="identifier">children</span><span class="punctuation">,</span>
                                        <span class="identifier">n_leaves</span><span class="arithmetic-assignment">=</span><span class="identifier">n_leaves</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array_equiv</span><span class="grouping">(</span><span class="identifier">clusters_produced</span><span class="punctuation">,</span>
                              <span class="identifier">clusters_at_threshold</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_small_distance_threshold</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">300</span><span class="punctuation">,</span> <span class="int-literal">300</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># this should result in all data in their own clusters, given that</span>
    <span class="comment"># their pairwise distances are bigger than .1 (which may not be the case</span>
    <span class="comment"># with a different random seed).</span>
    <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
        <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
        <span class="identifier">distance_threshold</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span>
        <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">"single"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># check that the pairwise distances are indeed all larger than .1</span>
    <span class="identifier">all_distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'minkowski'</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fill_diagonal</span><span class="grouping">(</span><span class="identifier">all_distances</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">all_distances</span> <span class="relational-operator">&gt;</span> <span class="float-literal">.1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">n_clusters_</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span>


<span class="keyword">def</span> <span class="identifier">test_cluster_distances_with_distance_threshold</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># check the distances within the clusters and with other clusters</span>
    <span class="identifier">distance_threshold</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>
    <span class="identifier">clustering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
        <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
        <span class="identifier">distance_threshold</span><span class="arithmetic-assignment">=</span><span class="identifier">distance_threshold</span><span class="punctuation">,</span>
        <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">"single"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clustering</span><span class="punctuation">.</span><span class="identifier">labels_</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"minkowski"</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="comment"># to avoid taking the 0 diagonal in min()</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fill_diagonal</span><span class="grouping">(</span><span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">label</span> <span class="relational-operator">in</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">labels</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">in_cluster_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">labels</span> <span class="relational-operator">==</span> <span class="identifier">label</span>
        <span class="identifier">max_in_cluster_distance</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">D</span><span class="grouping">[</span><span class="identifier">in_cluster_mask</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">in_cluster_mask</span><span class="grouping">]</span>
                                   <span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">min_out_cluster_distance</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">D</span><span class="grouping">[</span><span class="identifier">in_cluster_mask</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="bitwise-operator">~</span><span class="identifier">in_cluster_mask</span><span class="grouping">]</span>
                                    <span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># single data point clusters only have that inf diagonal here</span>
        <span class="keyword">if</span> <span class="identifier">in_cluster_mask</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">max_in_cluster_distance</span> <span class="relational-operator">&lt;</span> <span class="identifier">distance_threshold</span>
        <span class="keyword">assert</span> <span class="identifier">min_out_cluster_distance</span> <span class="relational-operator">&gt;=</span> <span class="identifier">distance_threshold</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'linkage', ['ward', 'complete', 'average'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">'threshold', 'y_true'</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_agglomerative_clustering_with_distance_threshold_edge_case</span><span class="grouping">(</span>
        <span class="identifier">linkage</span><span class="punctuation">,</span> <span class="identifier">threshold</span><span class="punctuation">,</span> <span class="identifier">y_true</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test boundary case of distance_threshold matching the distance</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">clusterer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span>
        <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
        <span class="identifier">distance_threshold</span><span class="arithmetic-assignment">=</span><span class="identifier">threshold</span><span class="punctuation">,</span>
        <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="identifier">linkage</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">adjusted_rand_score</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="keyword">def</span> <span class="identifier">test_dist_threshold_invalid_parameters</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Exactly one of "</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                <span class="identifier">distance_threshold</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Exactly one of "</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                <span class="identifier">distance_threshold</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"compute_full_tree must be True if"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                <span class="identifier">distance_threshold</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                <span class="identifier">compute_full_tree</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_invalid_shape_precomputed_dist_matrix</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that an error is raised when affinity='precomputed'</span>
    <span class="comment"># and a non square matrix is passed (PR #16257).</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Distance matrix should be square, "</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">affinity</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="punctuation">,</span>
                                <span class="identifier">linkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">'complete'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    </pre>
  </body>
</html>