<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Testing for Gaussian process regression """</span>

<span class="comment"># Author: Jan Hendrik Metzen &lt;jhm@informatik.uni-bremen.de&gt;</span>
<span class="comment"># Modified by: Pete Green &lt;p.l.green@liverpool.ac.uk&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">re</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">warnings</span>

<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">optimize</span> <span class="keyword">import</span> <span class="identifier">approx_fprime</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">gaussian_process</span> <span class="keyword">import</span> <span class="identifier">GaussianProcessRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">gaussian_process</span><span class="punctuation">.</span><span class="identifier">kernels</span> <span class="invalid">\</span>
    <span class="keyword">import</span> <span class="identifier">RBF</span><span class="punctuation">,</span> <span class="identifier">ConstantKernel</span> <span class="keyword">as</span> <span class="identifier">C</span><span class="punctuation">,</span> <span class="identifier">WhiteKernel</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">gaussian_process</span><span class="punctuation">.</span><span class="identifier">kernels</span> <span class="keyword">import</span> <span class="identifier">DotProduct</span><span class="punctuation">,</span> <span class="identifier">ExpSineSquared</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">gaussian_process</span><span class="punctuation">.</span><span class="identifier">tests</span><span class="punctuation">.</span><span class="identifier">_mini_sequence_kernel</span> <span class="keyword">import</span> <span class="identifier">MiniSeqKernel</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="punctuation">,</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="identifier">x</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>


<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">atleast_2d</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
<span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">atleast_2d</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">5.5</span><span class="punctuation">,</span> <span class="float-literal">6.5</span><span class="punctuation">,</span> <span class="float-literal">7.5</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="identifier">fixed_kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fixed"</span><span class="grouping">)</span>
<span class="identifier">kernels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">fixed_kernel</span><span class="punctuation">,</span>
           <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="float-literal">1e3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="identifier">C</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1e-2</span><span class="punctuation">,</span> <span class="float-literal">1e2</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span>
           <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="float-literal">1e3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="identifier">C</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1e-2</span><span class="punctuation">,</span> <span class="float-literal">1e2</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span>
           <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="float-literal">1e3</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
           <span class="identifier">C</span><span class="grouping">(</span><span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="float-literal">1e2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="identifier">C</span><span class="grouping">(</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1e-2</span><span class="punctuation">,</span> <span class="float-literal">1e2</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span>
           <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="float-literal">1e3</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
           <span class="identifier">C</span><span class="grouping">(</span><span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="float-literal">1e2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="identifier">non_fixed_kernels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">kernel</span> <span class="keyword">for</span> <span class="identifier">kernel</span> <span class="relational-operator">in</span> <span class="identifier">kernels</span>
                     <span class="keyword">if</span> <span class="identifier">kernel</span> <span class="relational-operator">!=</span> <span class="identifier">fixed_kernel</span><span class="grouping">]</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_gpr_interpolation</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">maxsize</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">32</span> <span class="logical-operator">and</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">version_info</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">xfail</span><span class="grouping">(</span><span class="string-literal">"This test may fail on 32bit Py3.6"</span><span class="grouping">)</span>

    <span class="comment"># Test the interpolating property for different kernels.</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">y_cov</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gpr_interpolation_structured</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the interpolating property for different kernels.</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MiniSeqKernel</span><span class="grouping">(</span><span class="identifier">baseline_similarity_bounds</span><span class="arithmetic-assignment">=</span><span class="string-literal">'fixed'</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'A', 'B', 'C'</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">eval_gradient</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">y_cov</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">non_fixed_kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lml_improving</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">maxsize</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">32</span> <span class="logical-operator">and</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">version_info</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">xfail</span><span class="grouping">(</span><span class="string-literal">"This test may fail on 32bit Py3.6"</span><span class="grouping">)</span>

    <span class="comment"># Test that hyperparameter-tuning improves log-marginal likelihood.</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span>
            <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lml_precomputed</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that lml of optimized kernel is stored correctly.</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">)</span> <span class="relational-operator">==</span>
            <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lml_without_cloning_kernel</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that lml of optimized kernel is stored correctly.</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">input_theta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>

    <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">input_theta</span><span class="punctuation">,</span> <span class="identifier">clone_kernel</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">,</span> <span class="identifier">input_theta</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">non_fixed_kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_converged_to_local_maximum</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that we are in local maximum after hyperparameter-optimization.</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">lml</span><span class="punctuation">,</span> <span class="identifier">lml_gradient</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">lml_gradient</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">1e-4</span><span class="grouping">)</span> <span class="bitwise-operator">|</span>
                  <span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span> <span class="relational-operator">==</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">bounds</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="bitwise-operator">|</span>
                  <span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span> <span class="relational-operator">==</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">bounds</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">non_fixed_kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_solution_inside_bounds</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that hyperparameter-optimization remains in bounds#</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">bounds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">bounds</span>
    <span class="identifier">max_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span>
    <span class="identifier">tiny</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-10</span>
    <span class="identifier">bounds</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">bounds</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">bounds</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span> <span class="arithmetic-operator">+</span> <span class="identifier">tiny</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">,</span> <span class="identifier">bounds</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">tiny</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lml_gradient</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Compare analytic and numeric gradient of log marginal likelihood.</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">lml</span><span class="punctuation">,</span> <span class="identifier">lml_gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">lml_gradient_approx</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="identifier">approx_fprime</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">,</span>
                      <span class="keyword">lambda</span> <span class="identifier">theta</span><span class="punctuation">:</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">theta</span><span class="punctuation">,</span>
                                                                <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="float-literal">1e-10</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">lml_gradient</span><span class="punctuation">,</span> <span class="identifier">lml_gradient_approx</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_prior</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that GP prior has mean 0 and identical variances.</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span>

    <span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="comment"># XXX: quite hacky, works only for current kernels</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">y_cov</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">y_cov</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sample_statistics</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that statistics of samples drawn from GP are correct.</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">sample_y</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="int-literal">300000</span><span class="grouping">)</span>

    <span class="comment"># More digits accuracy would require many more samples</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">y_cov</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">y_cov</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">y_cov</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_no_optimizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that kernel parameters are unmodified when optimizer is None.</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="grouping">)</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">optimizer</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="float-literal">1.0</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"target"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_predict_cov_vs_std</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">maxsize</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">32</span> <span class="logical-operator">and</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">version_info</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">xfail</span><span class="grouping">(</span><span class="string-literal">"This test may fail on 32bit Py3.6"</span><span class="grouping">)</span>

    <span class="comment"># Test that predicted std.-dev. is consistent with cov's diagonal.</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">y_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">y_cov</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_std</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_anisotropic_kernel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that GPR can identify meaningful anisotropic length-scales.</span>
    <span class="comment"># We learn a function which varies in one dimension ten-times slower</span>
    <span class="comment"># than in the other. The corresponding length-scales should differ by at</span>
    <span class="comment"># least a factor 5</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>

    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_random_starts</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that an increasing number of random-starts of GP fitting only</span>
    <span class="comment"># increases the log marginal likelihood of the chosen theta.</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">25</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="invalid">\</span>
        <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>

    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">C</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1e-2</span><span class="punctuation">,</span> <span class="float-literal">1e2</span><span class="grouping">)</span><span class="grouping">)</span> <span class="invalid">\</span>
        <span class="arithmetic-operator">*</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_features</span><span class="punctuation">,</span>
              <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="float-literal">1e-4</span><span class="punctuation">,</span> <span class="float-literal">1e+2</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="invalid">\</span>
        <span class="arithmetic-operator">+</span> <span class="identifier">WhiteKernel</span><span class="grouping">(</span><span class="identifier">noise_level</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="identifier">noise_level_bounds</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="float-literal">1e1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">last_lml</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span>
    <span class="keyword">for</span> <span class="identifier">n_restarts_optimizer</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span>
            <span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">n_restarts_optimizer</span><span class="arithmetic-assignment">=</span><span class="identifier">n_restarts_optimizer</span><span class="punctuation">,</span>
            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">lml</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gp</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">gp</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">lml</span> <span class="relational-operator">&gt;</span> <span class="identifier">last_lml</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span>
        <span class="identifier">last_lml</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lml</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_y_normalization</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Test normalization of the target values in GP

    Fitting non-normalizing GP on normalized y and fitting normalizing GP
    on unnormalized y should yield identical results. Note that, here,
    'normalized y' refers to y that has been made zero mean and unit
    variance.

    """</span>

    <span class="identifier">y_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_norm</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_mean</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">y_std</span>

    <span class="comment"># Fit non-normalizing GP on normalized y</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span>
    <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_norm</span><span class="grouping">)</span>

    <span class="comment"># Fit normalizing GP on unnormalized y</span>
    <span class="identifier">gpr_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">normalize_y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">gpr_norm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Compare predicted mean, std-devs and covariances</span>
    <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_pred</span> <span class="arithmetic-operator">*</span> <span class="identifier">y_std</span> <span class="arithmetic-operator">+</span> <span class="identifier">y_mean</span>
    <span class="identifier">y_pred_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_pred_std</span> <span class="arithmetic-operator">*</span> <span class="identifier">y_std</span>
    <span class="identifier">y_pred_norm</span><span class="punctuation">,</span> <span class="identifier">y_pred_std_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr_norm</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred_norm</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred_std</span><span class="punctuation">,</span> <span class="identifier">y_pred_std_norm</span><span class="grouping">)</span>

    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_cov</span> <span class="arithmetic-operator">*</span> <span class="identifier">y_std</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_cov_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr_norm</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_cov</span><span class="punctuation">,</span> <span class="identifier">y_cov_norm</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_large_variance_y</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Here we test that, when noramlize_y=True, our GP can produce a
    sensible fit to training data whose variance is significantly
    larger than unity. This test was made in response to issue #15612.

    GP predictions are verified against predictions that were made
    using GPy which, here, is treated as the 'gold standard'. Note that we
    only investigate the RBF kernel here, as that is what was used in the
    GPy implementation.

    The following code can be used to recreate the GPy data:

    --------------------------------------------------------------------------
    import GPy

    kernel_gpy = GPy.kern.RBF(input_dim=1, lengthscale=1.)
    gpy = GPy.models.GPRegression(X, np.vstack(y_large), kernel_gpy)
    gpy.optimize()
    y_pred_gpy, y_var_gpy = gpy.predict(X2)
    y_pred_std_gpy = np.sqrt(y_var_gpy)
    --------------------------------------------------------------------------
    """</span>

    <span class="comment"># Here we utilise a larger variance version of the training data</span>
    <span class="identifier">y_large</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span> <span class="arithmetic-operator">*</span> <span class="identifier">y</span>

    <span class="comment"># Standard GP with normalize_y=True</span>
    <span class="identifier">RBF_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'length_scale'</span><span class="punctuation">:</span> <span class="float-literal">1.0</span><span class="grouping">}</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">RBF_params</span><span class="grouping">)</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">normalize_y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_large</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="comment"># 'Gold standard' mean predictions from GPy</span>
    <span class="identifier">y_pred_gpy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">15.16918303</span><span class="punctuation">,</span>
                           <span class="float-literal">-27.98707845</span><span class="punctuation">,</span>
                           <span class="float-literal">-39.31636019</span><span class="punctuation">,</span>
                           <span class="float-literal">14.52605515</span><span class="punctuation">,</span>
                           <span class="float-literal">69.18503589</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># 'Gold standard' std predictions from GPy</span>
    <span class="identifier">y_pred_std_gpy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">7.78860962</span><span class="punctuation">,</span>
                               <span class="float-literal">3.83179178</span><span class="punctuation">,</span>
                               <span class="float-literal">0.63149951</span><span class="punctuation">,</span>
                               <span class="float-literal">0.52745188</span><span class="punctuation">,</span>
                               <span class="float-literal">0.86170042</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Based on numerical experiments, it's reasonable to expect our</span>
    <span class="comment"># GP's mean predictions to get within 7% of predictions of those</span>
    <span class="comment"># made by GPy.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred_gpy</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.07</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Based on numerical experiments, it's reasonable to expect our</span>
    <span class="comment"># GP's std predictions to get within 15% of predictions of those</span>
    <span class="comment"># made by GPy.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_pred_std</span><span class="punctuation">,</span> <span class="identifier">y_pred_std_gpy</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.15</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_y_multioutput</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that GPR can deal with multi-dimensional target values</span>
    <span class="identifier">y_2d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="comment"># Test for fixed kernel that first dimension of 2d GP equals the output</span>
    <span class="comment"># of 1d GP and that second dimension is twice as large</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span>

    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">optimizer</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                   <span class="identifier">normalize_y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">gpr_2d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">optimizer</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                      <span class="identifier">normalize_y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">gpr_2d</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_2d</span><span class="grouping">)</span>

    <span class="identifier">y_pred_1d</span><span class="punctuation">,</span> <span class="identifier">y_std_1d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">y_pred_2d</span><span class="punctuation">,</span> <span class="identifier">y_std_2d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr_2d</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_cov_1d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_cov_2d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr_2d</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred_1d</span><span class="punctuation">,</span> <span class="identifier">y_pred_2d</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred_1d</span><span class="punctuation">,</span> <span class="identifier">y_pred_2d</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="comment"># Standard deviation and covariance do not depend on output</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_std_1d</span><span class="punctuation">,</span> <span class="identifier">y_std_2d</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_cov_1d</span><span class="punctuation">,</span> <span class="identifier">y_cov_2d</span><span class="grouping">)</span>

    <span class="identifier">y_sample_1d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">sample_y</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y_sample_2d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr_2d</span><span class="punctuation">.</span><span class="identifier">sample_y</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_sample_1d</span><span class="punctuation">,</span> <span class="identifier">y_sample_2d</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Test hyperparameter optimization</span>
    <span class="keyword">for</span> <span class="identifier">kernel</span> <span class="relational-operator">in</span> <span class="identifier">kernels</span><span class="punctuation">:</span>
        <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">normalize_y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">gpr_2d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">normalize_y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">gpr_2d</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">,</span> <span class="identifier">gpr_2d</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">non_fixed_kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_custom_optimizer</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that GPR can use externally defined optimizers.</span>
    <span class="comment"># Define a dummy optimizer that simply tests 50 random hyperparameters</span>
    <span class="keyword">def</span> <span class="identifier">optimizer</span><span class="grouping">(</span><span class="identifier">obj_func</span><span class="punctuation">,</span> <span class="identifier">initial_theta</span><span class="punctuation">,</span> <span class="identifier">bounds</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">theta_opt</span><span class="punctuation">,</span> <span class="identifier">func_min</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
            <span class="identifier">initial_theta</span><span class="punctuation">,</span> <span class="identifier">obj_func</span><span class="grouping">(</span><span class="identifier">initial_theta</span><span class="punctuation">,</span> <span class="identifier">eval_gradient</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">50</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">theta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">atleast_1d</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">bounds</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">bounds</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">obj_func</span><span class="grouping">(</span><span class="identifier">theta</span><span class="punctuation">,</span> <span class="identifier">eval_gradient</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">f</span> <span class="relational-operator">&lt;</span> <span class="identifier">func_min</span><span class="punctuation">:</span>
                <span class="identifier">theta_opt</span><span class="punctuation">,</span> <span class="identifier">func_min</span> <span class="arithmetic-assignment">=</span> <span class="identifier">theta</span><span class="punctuation">,</span> <span class="identifier">f</span>
        <span class="keyword">return</span> <span class="identifier">theta_opt</span><span class="punctuation">,</span> <span class="identifier">func_min</span>

    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">optimizer</span><span class="arithmetic-assignment">=</span><span class="identifier">optimizer</span><span class="grouping">)</span>
    <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># Checks that optimizer improved marginal likelihood</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel_</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span>
            <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">log_marginal_likelihood</span><span class="grouping">(</span><span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gpr_correct_error_message</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">12</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">6</span><span class="grouping">)</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DotProduct</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="grouping">)</span>
    <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"The kernel, %s, is not returning a "</span>
        <span class="string-literal">"positive definite matrix. Try gradually increasing "</span>
        <span class="string-literal">"the 'alpha' parameter of your "</span>
        <span class="string-literal">"GaussianProcessRegressor estimator."</span>
        <span class="arithmetic-operator">%</span> <span class="identifier">kernel</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">LinAlgError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span><span class="identifier">message</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_duplicate_input</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test GPR can handle two different output-values for the same input.</span>
    <span class="identifier">gpr_equal_inputs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>
    <span class="identifier">gpr_similar_inputs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>

    <span class="identifier">X_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">gpr_equal_inputs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>

    <span class="identifier">X_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1e-15</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">gpr_similar_inputs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>

    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
    <span class="identifier">y_pred_equal</span><span class="punctuation">,</span> <span class="identifier">y_std_equal</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="identifier">gpr_equal_inputs</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">y_pred_similar</span><span class="punctuation">,</span> <span class="identifier">y_std_similar</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="identifier">gpr_similar_inputs</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred_equal</span><span class="punctuation">,</span> <span class="identifier">y_pred_similar</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_std_equal</span><span class="punctuation">,</span> <span class="identifier">y_std_similar</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_no_fit_default_predict</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that GPR predictions without fit does not break by default.</span>
    <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">k</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">l</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">C</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">constant_value_bounds</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fixed"</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span>
                      <span class="identifier">RBF</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fixed"</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">gpr1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_std1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_cov1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">gpr2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">k</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">l</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_std2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_cov2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_std1</span><span class="punctuation">,</span> <span class="identifier">y_std2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_cov1</span><span class="punctuation">,</span> <span class="identifier">y_cov2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_warning_bounds</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="float-literal">1e-3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span>
    <span class="identifier">warning_message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"The optimal value found for dimension 0 of parameter "</span>
        <span class="string-literal">"length_scale is close to the specified upper bound "</span>
        <span class="string-literal">"0.001. Increasing the bound and calling fit again may "</span>
        <span class="string-literal">"find a better value."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">ConvergenceWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warning_message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">kernel_sum</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">WhiteKernel</span><span class="grouping">(</span><span class="identifier">noise_level_bounds</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="float-literal">1e-3</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                  <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">1e3</span><span class="punctuation">,</span> <span class="float-literal">1e5</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">gpr_sum</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel_sum</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">catch_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># scipy 1.3.0 uses tostring which is deprecated in numpy</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore", "tostring"</span><span class="punctuation">,</span> <span class="identifier">DeprecationWarning</span><span class="grouping">)</span>
            <span class="identifier">gpr_sum</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">record</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
    <span class="keyword">assert</span> <span class="identifier">record</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">message</span><span class="punctuation">.</span><span class="identifier">args</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="string-literal">"The optimal value found for "</span>
                                         <span class="string-literal">"dimension 0 of parameter "</span>
                                         <span class="string-literal">"k1__noise_level is close to the "</span>
                                         <span class="string-literal">"specified upper bound 0.001. "</span>
                                         <span class="string-literal">"Increasing the bound and calling "</span>
                                         <span class="string-literal">"fit again may find a better value."</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">record</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">message</span><span class="punctuation">.</span><span class="identifier">args</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="string-literal">"The optimal value found for "</span>
                                         <span class="string-literal">"dimension 0 of parameter "</span>
                                         <span class="string-literal">"k2__length_scale is close to the "</span>
                                         <span class="string-literal">"specified lower bound 1000.0. "</span>
                                         <span class="string-literal">"Decreasing the bound and calling "</span>
                                         <span class="string-literal">"fit again may find a better value."</span><span class="grouping">)</span>

    <span class="identifier">X_tile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">kernel_dims</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">1e1</span><span class="punctuation">,</span> <span class="float-literal">1e2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">gpr_dims</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel_dims</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">catch_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># scipy 1.3.0 uses tostring which is deprecated in numpy</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore", "tostring"</span><span class="punctuation">,</span> <span class="identifier">DeprecationWarning</span><span class="grouping">)</span>
            <span class="identifier">gpr_dims</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_tile</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">record</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
    <span class="keyword">assert</span> <span class="identifier">record</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">message</span><span class="punctuation">.</span><span class="identifier">args</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="string-literal">"The optimal value found for "</span>
                                         <span class="string-literal">"dimension 0 of parameter "</span>
                                         <span class="string-literal">"length_scale is close to the "</span>
                                         <span class="string-literal">"specified lower bound 10.0. "</span>
                                         <span class="string-literal">"Decreasing the bound and calling "</span>
                                         <span class="string-literal">"fit again may find a better value."</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">record</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">message</span><span class="punctuation">.</span><span class="identifier">args</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="string-literal">"The optimal value found for "</span>
                                         <span class="string-literal">"dimension 1 of parameter "</span>
                                         <span class="string-literal">"length_scale is close to the "</span>
                                         <span class="string-literal">"specified lower bound 10.0. "</span>
                                         <span class="string-literal">"Decreasing the bound and calling "</span>
                                         <span class="string-literal">"fit again may find a better value."</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bound_check_fixed_hyperparameter</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Regression test for issue #17943</span>
    <span class="comment"># Check that having a hyperparameter with fixed bounds doesn't cause an</span>
    <span class="comment"># error</span>
    <span class="identifier">k1</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">50.0</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">50.0</span><span class="grouping">)</span>  <span class="comment"># long term smooth rising trend</span>
    <span class="identifier">k2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ExpSineSquared</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">periodicity</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span>
                        <span class="identifier">periodicity_bounds</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fixed"</span><span class="grouping">)</span>  <span class="comment"># seasonal component</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">k1</span> <span class="arithmetic-operator">+</span> <span class="identifier">k2</span>
    <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="comment"># FIXME: we should test for multitargets as well. However, GPR is broken:</span>
<span class="comment"># see: https://github.com/scikit-learn/scikit-learn/pull/19706</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_constant_target</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that the std. dev. is affected to 1 when normalizing a constant
    feature.
    Non-regression test for:
    https://github.com/scikit-learn/scikit-learn/issues/18318
    NaN where affected to the target when scaling due to null std. dev. with
    constant target.
    """</span>
    <span class="identifier">y_constant</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>

    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">normalize_y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_constant</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">_y_train_std</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="grouping">)</span>

    <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_constant</span><span class="grouping">)</span>
    <span class="comment"># set atol because we compare to zero</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">y_cov</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-9</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gpr_consistency_std_cov_non_invertible_kernel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check the consistency between the returned std. dev. and the covariance.
    Non-regression test for:
    https://github.com/scikit-learn/scikit-learn/issues/19936
    Inconsistencies were observed when the kernel cannot be inverted (or
    numerically stable).
    """</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">C</span><span class="grouping">(</span><span class="float-literal">8.98576054e+05</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1e-12</span><span class="punctuation">,</span> <span class="float-literal">1e12</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span>
              <span class="identifier">RBF</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">5.91326520e+02</span><span class="punctuation">,</span> <span class="float-literal">1.32584051e+03</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1e-12</span><span class="punctuation">,</span> <span class="float-literal">1e12</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
              <span class="identifier">WhiteKernel</span><span class="grouping">(</span><span class="identifier">noise_level</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">gpr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">optimizer</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.54919334</span><span class="punctuation">,</span> <span class="float-literal">-0.77459667</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.54919334</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">-1.54919334</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.77459667</span><span class="punctuation">,</span> <span class="float-literal">0.77459667</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="float-literal">-0.77459667</span><span class="punctuation">,</span> <span class="float-literal">1.54919334</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-2.14882017e-10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-4.66975823e+00</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">4.01823986e+00</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="float-literal">-1.30303674e+00</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.35760156e+00</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="float-literal">3.31215668e+00</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.93649167</span><span class="punctuation">,</span> <span class="float-literal">-1.93649167</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.93649167</span><span class="punctuation">,</span> <span class="float-literal">-1.93649167</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="grouping">[</span><span class="float-literal">-1.93649167</span><span class="punctuation">,</span> <span class="float-literal">1.93649167</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.93649167</span><span class="punctuation">,</span> <span class="float-literal">1.93649167</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pred1</span><span class="punctuation">,</span> <span class="identifier">std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">pred2</span><span class="punctuation">,</span> <span class="identifier">cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gpr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">v</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">std</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diagonal</span><span class="grouping">(</span><span class="identifier">cov</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-5</span><span class="grouping">)</span>

    </pre>
  </body>
</html>