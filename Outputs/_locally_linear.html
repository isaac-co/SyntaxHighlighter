<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Locally Linear Embedding"""</span>

<span class="comment"># Author: Fabian Pedregosa -- &lt;fabian.pedregosa@inria.fr&gt;</span>
<span class="comment">#         Jake Vanderplas  -- &lt;vanderplas@astro.washington.edu&gt;</span>
<span class="comment"># License: BSD 3 clause (C) INRIA 2011</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">linalg</span> <span class="keyword">import</span> <span class="identifier">eigh</span><span class="punctuation">,</span> <span class="identifier">svd</span><span class="punctuation">,</span> <span class="identifier">qr</span><span class="punctuation">,</span> <span class="identifier">solve</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">eye</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">linalg</span> <span class="keyword">import</span> <span class="identifier">eigsh</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="identifier">TransformerMixin</span><span class="punctuation">,</span> <span class="identifier">_UnstableArchMixin</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span><span class="punctuation">,</span> <span class="identifier">check_array</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_arpack</span> <span class="keyword">import</span> <span class="identifier">_init_arpack_v0</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">extmath</span> <span class="keyword">import</span> <span class="identifier">stable_cumsum</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_is_fitted</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">FLOAT_DTYPES</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">NearestNeighbors</span>


<span class="keyword">def</span> <span class="identifier">barycenter_weights</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute barycenter weights of X from Y along the first axis

    We estimate the weights to assign to each point in Y[indices] to recover
    the point X[i]. The barycenter weights sum to 1.

    Parameters
    ----------
    X : array-like, shape (n_samples, n_dim)

    Y : array-like, shape (n_samples, n_dim)

    indices : array-like, shape (n_samples, n_dim)
            Indices of the points in Y used to compute the barycenter

    reg : float, default=1e-3
        amount of regularization to add for the problem to be
        well-posed in the case of n_neighbors &gt; n_dim

    Returns
    -------
    B : array-like, shape (n_samples, n_neighbors)

    Notes
    -----
    See developers note for more information.
    """</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">FLOAT_DTYPES</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">FLOAT_DTYPES</span><span class="grouping">)</span>
    <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indices</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span>

    <span class="identifier">B</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="comment"># this might raise a LinalgError if G is singular and has trace</span>
    <span class="comment"># zero</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">ind</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">indices</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="identifier">ind</span><span class="grouping">]</span>
        <span class="identifier">C</span> <span class="arithmetic-assignment">=</span> <span class="identifier">A</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span>  <span class="comment"># broadcasting</span>
        <span class="identifier">G</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">C</span><span class="punctuation">,</span> <span class="identifier">C</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
        <span class="identifier">trace</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="identifier">G</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">trace</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">R</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span> <span class="arithmetic-operator">*</span> <span class="identifier">trace</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">R</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span>
        <span class="identifier">G</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="identifier">n_neighbors</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">R</span>
        <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">solve</span><span class="grouping">(</span><span class="identifier">G</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">sym_pos</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">B</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">w</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">w</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">B</span>

<span class="keyword">def</span> <span class="identifier">barycenter_kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Computes the barycenter weighted graph of k-Neighbors for points in X

    Parameters
    ----------
    X : {array-like, NearestNeighbors}
        Sample data, shape = (n_samples, n_features), in the form of a
        numpy array or a NearestNeighbors object.

    n_neighbors : int
        Number of neighbors for each sample.

    reg : float, default=1e-3
        Amount of regularization when solving the least-squares
        problem. Only relevant if mode='barycenter'. If None, use the
        default.

    n_jobs : int or None, default=None
        The number of parallel jobs to run for neighbors search.
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

    Returns
    -------
    A : sparse matrix in CSR format, shape = [n_samples, n_samples]
        A[i, j] is assigned the weight of edge that connects i to j.

    See Also
    --------
    sklearn.neighbors.kneighbors_graph
    sklearn.neighbors.radius_neighbors_graph
    """</span>
    <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">n_jobs</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">_fit_X</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">n_samples_fit_</span>
    <span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">barycenter_weights</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">ind</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="arithmetic-assignment">=</span><span class="identifier">reg</span><span class="grouping">)</span>
    <span class="identifier">indptr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_neighbors</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ind</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">indptr</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">null_space</span><span class="grouping">(</span><span class="identifier">M</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">k_skip</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">eigen_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'arpack'</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1E-6</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span>
               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Find the null space of a matrix M.

    Parameters
    ----------
    M : {array, matrix, sparse matrix, LinearOperator}
        Input covariance matrix: should be symmetric positive semi-definite

    k : int
        Number of eigenvalues/vectors to return

    k_skip : int, default=1
        Number of low eigenvalues to skip.

    eigen_solver : {'auto', 'arpack', 'dense'}, default='arpack'
        auto : algorithm will attempt to choose the best method for input data
        arpack : use arnoldi iteration in shift-invert mode.
                    For this method, M may be a dense matrix, sparse matrix,
                    or general linear operator.
                    Warning: ARPACK can be unstable for some problems.  It is
                    best to try several random seeds in order to check results.
        dense  : use standard dense matrix operations for the eigenvalue
                    decomposition.  For this method, M must be an array
                    or matrix type.  This method should be avoided for
                    large problems.

    tol : float, default=1e-6
        Tolerance for 'arpack' method.
        Not used if eigen_solver=='dense'.

    max_iter : int, default=100
        Maximum number of iterations for 'arpack' method.
        Not used if eigen_solver=='dense'

    random_state : int, RandomState instance, default=None
        Determines the random number generator when ``solver`` == 'arpack'.
        Pass an int for reproducible results across multiple function calls.
        See :term: `Glossary &lt;random_state&gt;`.
    """</span>
    <span class="keyword">if</span> <span class="identifier">eigen_solver</span> <span class="relational-operator">==</span> <span class="string-literal">'auto'</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">M</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="int-literal">200</span> <span class="logical-operator">and</span> <span class="identifier">k</span> <span class="arithmetic-operator">+</span> <span class="identifier">k_skip</span> <span class="relational-operator">&lt;</span> <span class="int-literal">10</span><span class="punctuation">:</span>
            <span class="identifier">eigen_solver</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'arpack'</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">eigen_solver</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'dense'</span>

    <span class="keyword">if</span> <span class="identifier">eigen_solver</span> <span class="relational-operator">==</span> <span class="string-literal">'arpack'</span><span class="punctuation">:</span>
        <span class="identifier">v0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_init_arpack_v0</span><span class="grouping">(</span><span class="identifier">M</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">eigen_values</span><span class="punctuation">,</span> <span class="identifier">eigen_vectors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">eigsh</span><span class="grouping">(</span><span class="identifier">M</span><span class="punctuation">,</span> <span class="identifier">k</span> <span class="arithmetic-operator">+</span> <span class="identifier">k_skip</span><span class="punctuation">,</span> <span class="identifier">sigma</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="punctuation">,</span>
                                                <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">maxiter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span>
                                                <span class="identifier">v0</span><span class="arithmetic-assignment">=</span><span class="identifier">v0</span><span class="grouping">)</span>
        <span class="keyword">except</span> <span class="identifier">RuntimeError</span> <span class="keyword">as</span> <span class="identifier">e</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                <span class="string-literal">"Error in determining null-space with ARPACK. Error message: "</span>
                <span class="string-literal">"'%s'. Note that eigen_solver='arpack' can fail when the "</span>
                <span class="string-literal">"weight matrix is singular or otherwise ill-behaved. In that "</span>
                <span class="string-literal">"case, eigen_solver='dense' is recommended. See online "</span>
                <span class="string-literal">"documentation for more information."</span> <span class="arithmetic-operator">%</span> <span class="identifier">e</span>
            <span class="grouping">)</span> <span class="keyword">from</span> <span class="identifier">e</span>

        <span class="keyword">return</span> <span class="identifier">eigen_vectors</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k_skip</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">eigen_values</span><span class="grouping">[</span><span class="identifier">k_skip</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">eigen_solver</span> <span class="relational-operator">==</span> <span class="string-literal">'dense'</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">M</span><span class="punctuation">,</span> <span class="string-literal">'toarray'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="identifier">M</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">eigen_values</span><span class="punctuation">,</span> <span class="identifier">eigen_vectors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">eigh</span><span class="grouping">(</span>
            <span class="identifier">M</span><span class="punctuation">,</span> <span class="identifier">eigvals</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">k_skip</span><span class="punctuation">,</span> <span class="identifier">k</span> <span class="arithmetic-operator">+</span> <span class="identifier">k_skip</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">overwrite_a</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">eigen_values</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">eigen_vectors</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">index</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">eigen_values</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Unrecognized eigen_solver '%s'"</span> <span class="arithmetic-operator">%</span> <span class="identifier">eigen_solver</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">locally_linear_embedding</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">eigen_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span>
        <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'standard'</span><span class="punctuation">,</span> <span class="identifier">hessian_tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1E-4</span><span class="punctuation">,</span>
        <span class="identifier">modified_tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1E-12</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Perform a Locally Linear Embedding analysis on the data.

    Read more in the :ref:`User Guide &lt;locally_linear_embedding&gt;`.

    Parameters
    ----------
    X : {array-like, NearestNeighbors}
        Sample data, shape = (n_samples, n_features), in the form of a
        numpy array or a NearestNeighbors object.

    n_neighbors : int
        number of neighbors to consider for each point.

    n_components : int
        number of coordinates for the manifold.

    reg : float, default=1e-3
        regularization constant, multiplies the trace of the local covariance
        matrix of the distances.

    eigen_solver : {'auto', 'arpack', 'dense'}, default='auto'
        auto : algorithm will attempt to choose the best method for input data

        arpack : use arnoldi iteration in shift-invert mode.
                    For this method, M may be a dense matrix, sparse matrix,
                    or general linear operator.
                    Warning: ARPACK can be unstable for some problems.  It is
                    best to try several random seeds in order to check results.

        dense  : use standard dense matrix operations for the eigenvalue
                    decomposition.  For this method, M must be an array
                    or matrix type.  This method should be avoided for
                    large problems.

    tol : float, default=1e-6
        Tolerance for 'arpack' method
        Not used if eigen_solver=='dense'.

    max_iter : int, default=100
        maximum number of iterations for the arpack solver.

    method : {'standard', 'hessian', 'modified', 'ltsa'}, default='standard'
        standard : use the standard locally linear embedding algorithm.
                   see reference [1]_
        hessian  : use the Hessian eigenmap method.  This method requires
                   n_neighbors &gt; n_components * (1 + (n_components + 1) / 2.
                   see reference [2]_
        modified : use the modified locally linear embedding algorithm.
                   see reference [3]_
        ltsa     : use local tangent space alignment algorithm
                   see reference [4]_

    hessian_tol : float, default=1e-4
        Tolerance for Hessian eigenmapping method.
        Only used if method == 'hessian'

    modified_tol : float, default=1e-12
        Tolerance for modified LLE method.
        Only used if method == 'modified'

    random_state : int, RandomState instance, default=None
        Determines the random number generator when ``solver`` == 'arpack'.
        Pass an int for reproducible results across multiple function calls.
        See :term: `Glossary &lt;random_state&gt;`.

    n_jobs : int or None, default=None
        The number of parallel jobs to run for neighbors search.
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

    Returns
    -------
    Y : array-like, shape [n_samples, n_components]
        Embedding vectors.

    squared_error : float
        Reconstruction error for the embedding vectors. Equivalent to
        ``norm(Y - W Y, 'fro')**2``, where W are the reconstruction weights.

    References
    ----------

    .. [1] Roweis, S. & Saul, L. Nonlinear dimensionality reduction
        by locally linear embedding.  Science 290:2323 (2000).
    .. [2] Donoho, D. & Grimes, C. Hessian eigenmaps: Locally
        linear embedding techniques for high-dimensional data.
        Proc Natl Acad Sci U S A.  100:5591 (2003).
    .. [3] Zhang, Z. & Wang, J. MLLE: Modified Locally Linear
        Embedding Using Multiple Weights.
        http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.70.382
    .. [4] Zhang, Z. & Zha, H. Principal manifolds and nonlinear
        dimensionality reduction via tangent space alignment.
        Journal of Shanghai Univ.  8:406 (2004)
    """</span>
    <span class="keyword">if</span> <span class="identifier">eigen_solver</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'auto', 'arpack', 'dense'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"unrecognized eigen_solver '%s'"</span> <span class="arithmetic-operator">%</span> <span class="identifier">eigen_solver</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">method</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'standard', 'hessian', 'modified', 'ltsa'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"unrecognized method '%s'"</span> <span class="arithmetic-operator">%</span> <span class="identifier">method</span><span class="grouping">)</span>

    <span class="identifier">nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">n_jobs</span><span class="grouping">)</span>
    <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">_fit_X</span>

    <span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">d_in</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>

    <span class="keyword">if</span> <span class="identifier">n_components</span> <span class="relational-operator">&gt;</span> <span class="identifier">d_in</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"output dimension must be less than or equal "</span>
                         <span class="string-literal">"to input dimension"</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">n_neighbors</span> <span class="relational-operator">&gt;=</span> <span class="identifier">N</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
            <span class="string-literal">"Expected n_neighbors &lt;= n_samples, "</span>
            <span class="string-literal">" but n_samples = %d, n_neighbors = %d"</span> <span class="arithmetic-operator">%</span>
            <span class="grouping">(</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="grouping">)</span>
        <span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">n_neighbors</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"n_neighbors must be positive"</span><span class="grouping">)</span>

    <span class="identifier">M_sparse</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">eigen_solver</span> <span class="relational-operator">!=</span> <span class="string-literal">'dense'</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'standard'</span><span class="punctuation">:</span>
        <span class="identifier">W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">barycenter_kneighbors_graph</span><span class="grouping">(</span>
            <span class="identifier">nbrs</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="arithmetic-assignment">=</span><span class="identifier">reg</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">n_jobs</span><span class="grouping">)</span>

        <span class="comment"># we'll compute M = (I-W)'(I-W)</span>
        <span class="comment"># depending on the solver, we'll do this differently</span>
        <span class="keyword">if</span> <span class="identifier">M_sparse</span><span class="punctuation">:</span>
            <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="identifier">eye</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="identifier">W</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">W</span>
            <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">M</span><span class="punctuation">.</span><span class="identifier">T</span> <span class="arithmetic-operator">*</span> <span class="identifier">M</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">T</span> <span class="arithmetic-operator">*</span> <span class="identifier">W</span> <span class="arithmetic-operator">-</span> <span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">T</span> <span class="arithmetic-operator">-</span> <span class="identifier">W</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">M</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="identifier">M</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>  <span class="comment"># W = W - I = W - I</span>

    <span class="keyword">elif</span> <span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'hessian'</span><span class="punctuation">:</span>
        <span class="identifier">dp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_components</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">n_components</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>

        <span class="keyword">if</span> <span class="identifier">n_neighbors</span> <span class="relational-operator">&lt;=</span> <span class="identifier">n_components</span> <span class="arithmetic-operator">+</span> <span class="identifier">dp</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"for method='hessian', n_neighbors must be "</span>
                             <span class="string-literal">"greater than "</span>
                             <span class="string-literal">"[n_components * (n_components + 3) / 2]"</span><span class="grouping">)</span>

        <span class="identifier">neighbors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span>
                                    <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">neighbors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>

        <span class="identifier">Yi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span> <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_components</span> <span class="arithmetic-operator">+</span> <span class="identifier">dp</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
        <span class="identifier">Yi</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

        <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">N</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>

        <span class="identifier">use_svd</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">n_neighbors</span> <span class="relational-operator">&gt;</span> <span class="identifier">d_in</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">N</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">Gi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">]</span>
            <span class="identifier">Gi</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">Gi</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

            <span class="comment"># build Hessian estimator</span>
            <span class="keyword">if</span> <span class="identifier">use_svd</span><span class="punctuation">:</span>
                <span class="identifier">U</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd</span><span class="grouping">(</span><span class="identifier">Gi</span><span class="punctuation">,</span> <span class="identifier">full_matrices</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">Ci</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">Gi</span><span class="punctuation">,</span> <span class="identifier">Gi</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
                <span class="identifier">U</span> <span class="arithmetic-assignment">=</span> <span class="identifier">eigh</span><span class="grouping">(</span><span class="identifier">Ci</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

            <span class="identifier">Yi</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_components</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_components</span><span class="grouping">]</span>

            <span class="identifier">j</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_components</span>
            <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">Yi</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="punctuation">:</span><span class="identifier">j</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_components</span> <span class="arithmetic-operator">-</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">U</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="punctuation">:</span><span class="identifier">k</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span>
                                                 <span class="identifier">U</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="punctuation">:</span><span class="identifier">n_components</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">j</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">n_components</span> <span class="arithmetic-operator">-</span> <span class="identifier">k</span>

            <span class="identifier">Q</span><span class="punctuation">,</span> <span class="identifier">R</span> <span class="arithmetic-assignment">=</span> <span class="identifier">qr</span><span class="grouping">(</span><span class="identifier">Yi</span><span class="grouping">)</span>

            <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Q</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>
            <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">w</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

            <span class="identifier">S</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">hessian_tol</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
            <span class="identifier">w</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">S</span>

            <span class="identifier">nbrs_x</span><span class="punctuation">,</span> <span class="identifier">nbrs_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">meshgrid</span><span class="grouping">(</span><span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">M</span><span class="grouping">[</span><span class="identifier">nbrs_x</span><span class="punctuation">,</span> <span class="identifier">nbrs_y</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">M_sparse</span><span class="punctuation">:</span>
            <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">M</span><span class="grouping">)</span>

    <span class="keyword">elif</span> <span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'modified'</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">n_neighbors</span> <span class="relational-operator">&lt;</span> <span class="identifier">n_components</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"modified LLE requires "</span>
                             <span class="string-literal">"n_neighbors &gt;= n_components"</span><span class="grouping">)</span>

        <span class="identifier">neighbors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span>
                                    <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">neighbors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>

        <span class="comment"># find the eigenvectors and eigenvalues of each local covariance</span>
        <span class="comment"># matrix. We want V[i] to be a [n_neighbors x n_neighbors] matrix,</span>
        <span class="comment"># where the columns are eigenvectors</span>
        <span class="identifier">V</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">nev</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">d_in</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="grouping">)</span>
        <span class="identifier">evals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">nev</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># choose the most efficient way to find the eigenvectors</span>
        <span class="identifier">use_svd</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">n_neighbors</span> <span class="relational-operator">&gt;</span> <span class="identifier">d_in</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">use_svd</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">N</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">X_nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span>
                <span class="identifier">V</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">evals</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd</span><span class="grouping">(</span><span class="identifier">X_nbrs</span><span class="punctuation">,</span>
                                        <span class="identifier">full_matrices</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
            <span class="identifier">evals</span> <span class="arithmetic-assignment">**=</span> <span class="int-literal">2</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">N</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">X_nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span>
                <span class="identifier">C_nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_nbrs</span><span class="punctuation">,</span> <span class="identifier">X_nbrs</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
                <span class="identifier">evi</span><span class="punctuation">,</span> <span class="identifier">vi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">eigh</span><span class="grouping">(</span><span class="identifier">C_nbrs</span><span class="grouping">)</span>
                <span class="identifier">evals</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">evi</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
                <span class="identifier">V</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vi</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

        <span class="comment"># find regularized weights: this is like normal LLE.</span>
        <span class="comment"># because we've already computed the SVD of each covariance matrix,</span>
        <span class="comment"># it's faster to use this rather than np.linalg.solve</span>
        <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1E-3</span> <span class="arithmetic-operator">*</span> <span class="identifier">evals</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">tmp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">V</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">tmp</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">nev</span><span class="grouping">]</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">evals</span> <span class="arithmetic-operator">+</span> <span class="identifier">reg</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
        <span class="identifier">tmp</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">nev</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">reg</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>

        <span class="identifier">w_reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">N</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">w_reg</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">tmp</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">w_reg</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">w_reg</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>

        <span class="comment"># calculate eta: the median of the ratio of small to large eigenvalues</span>
        <span class="comment"># across the points.  This is used to determine s_i, below</span>
        <span class="identifier">rho</span> <span class="arithmetic-assignment">=</span> <span class="identifier">evals</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">evals</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_components</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">eta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">median</span><span class="grouping">(</span><span class="identifier">rho</span><span class="grouping">)</span>

        <span class="comment"># find s_i, the size of the "almost null space" for each point:</span>
        <span class="comment"># this is the size of the largest set of eigenvalues</span>
        <span class="comment"># such that Sum[v; v in set]/Sum[v; v not in set] &lt; eta</span>
        <span class="identifier">s_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span>
        <span class="identifier">evals_cumsum</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stable_cumsum</span><span class="grouping">(</span><span class="identifier">evals</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">eta_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">evals_cumsum</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">evals_cumsum</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">N</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">s_range</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">searchsorted</span><span class="grouping">(</span><span class="identifier">eta_range</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="grouping">)</span>
        <span class="identifier">s_range</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">n_neighbors</span> <span class="arithmetic-operator">-</span> <span class="identifier">nev</span>  <span class="comment"># number of zero eigenvalues</span>

        <span class="comment"># Now calculate M.</span>
        <span class="comment"># This is the [N x N] matrix whose null space is the desired embedding</span>
        <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">N</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">N</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">s_i</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s_range</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span>

            <span class="comment"># select bottom s_i eigenvectors and calculate alpha</span>
            <span class="identifier">Vi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">V</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span> <span class="arithmetic-operator">-</span> <span class="identifier">s_i</span><span class="punctuation">:</span><span class="grouping">]</span>
            <span class="identifier">alpha_i</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">Vi</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">s_i</span><span class="grouping">)</span>

            <span class="comment"># compute Householder matrix which satisfies</span>
            <span class="comment">#  Hi*Vi.T*ones(n_neighbors) = alpha_i*ones(s)</span>
            <span class="comment"># using prescription from paper</span>
            <span class="identifier">h</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">s_i</span><span class="punctuation">,</span> <span class="identifier">alpha_i</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">Vi</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="identifier">norm_h</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">h</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">norm_h</span> <span class="relational-operator">&lt;</span> <span class="identifier">modified_tol</span><span class="punctuation">:</span>
                <span class="identifier">h</span> <span class="arithmetic-assignment">*=</span> <span class="int-literal">0</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">h</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">norm_h</span>

            <span class="comment"># Householder matrix is</span>
            <span class="comment">#  &gt;&gt; Hi = np.identity(s_i) - 2*np.outer(h,h)</span>
            <span class="comment"># Then the weight matrix is</span>
            <span class="comment">#  &gt;&gt; Wi = np.dot(Vi,Hi) + (1-alpha_i) * w_reg[i,:,None]</span>
            <span class="comment"># We do this much more efficiently:</span>
            <span class="identifier">Wi</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">Vi</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">outer</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">Vi</span><span class="punctuation">,</span> <span class="identifier">h</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">h</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                  <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">alpha_i</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">w_reg</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span>

            <span class="comment"># Update M as follows:</span>
            <span class="comment"># &gt;&gt; W_hat = np.zeros( (N,s_i) )</span>
            <span class="comment"># &gt;&gt; W_hat[neighbors[i],:] = Wi</span>
            <span class="comment"># &gt;&gt; W_hat[i] -= 1</span>
            <span class="comment"># &gt;&gt; M += np.dot(W_hat,W_hat.T)</span>
            <span class="comment"># We can do this much more efficiently:</span>
            <span class="identifier">nbrs_x</span><span class="punctuation">,</span> <span class="identifier">nbrs_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">meshgrid</span><span class="grouping">(</span><span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">M</span><span class="grouping">[</span><span class="identifier">nbrs_x</span><span class="punctuation">,</span> <span class="identifier">nbrs_y</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">Wi</span><span class="punctuation">,</span> <span class="identifier">Wi</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
            <span class="identifier">Wi_sum1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Wi</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">M</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">Wi_sum1</span>
            <span class="identifier">M</span><span class="grouping">[</span><span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">Wi_sum1</span>
            <span class="identifier">M</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">s_i</span>

        <span class="keyword">if</span> <span class="identifier">M_sparse</span><span class="punctuation">:</span>
            <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">M</span><span class="grouping">)</span>

    <span class="keyword">elif</span> <span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'ltsa'</span><span class="punctuation">:</span>
        <span class="identifier">neighbors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span>
                                    <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">neighbors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>

        <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">N</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">use_svd</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">n_neighbors</span> <span class="relational-operator">&gt;</span> <span class="identifier">d_in</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">N</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">Xi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">]</span>
            <span class="identifier">Xi</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">Xi</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

            <span class="comment"># compute n_components largest eigenvalues of Xi * Xi^T</span>
            <span class="keyword">if</span> <span class="identifier">use_svd</span><span class="punctuation">:</span>
                <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd</span><span class="grouping">(</span><span class="identifier">Xi</span><span class="punctuation">,</span> <span class="identifier">full_matrices</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">Ci</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">Xi</span><span class="punctuation">,</span> <span class="identifier">Xi</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
                <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">eigh</span><span class="grouping">(</span><span class="identifier">Ci</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

            <span class="identifier">Gi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">Gi</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_components</span><span class="grouping">]</span>
            <span class="identifier">Gi</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="grouping">)</span>

            <span class="identifier">GiGiT</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">Gi</span><span class="punctuation">,</span> <span class="identifier">Gi</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

            <span class="identifier">nbrs_x</span><span class="punctuation">,</span> <span class="identifier">nbrs_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">meshgrid</span><span class="grouping">(</span><span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">M</span><span class="grouping">[</span><span class="identifier">nbrs_x</span><span class="punctuation">,</span> <span class="identifier">nbrs_y</span><span class="grouping">]</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">GiGiT</span>
            <span class="identifier">M</span><span class="grouping">[</span><span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

    <span class="keyword">return</span> <span class="identifier">null_space</span><span class="grouping">(</span><span class="identifier">M</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">k_skip</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">eigen_solver</span><span class="arithmetic-assignment">=</span><span class="identifier">eigen_solver</span><span class="punctuation">,</span>
                      <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">LocallyLinearEmbedding</span><span class="grouping">(</span><span class="identifier">TransformerMixin</span><span class="punctuation">,</span>
                             <span class="identifier">_UnstableArchMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Locally Linear Embedding

    Read more in the :ref:`User Guide &lt;locally_linear_embedding&gt;`.

    Parameters
    ----------
    n_neighbors : int, default=5
        number of neighbors to consider for each point.

    n_components : int, default=2
        number of coordinates for the manifold

    reg : float, default=1e-3
        regularization constant, multiplies the trace of the local covariance
        matrix of the distances.

    eigen_solver : {'auto', 'arpack', 'dense'}, default='auto'
        auto : algorithm will attempt to choose the best method for input data

        arpack : use arnoldi iteration in shift-invert mode.
                    For this method, M may be a dense matrix, sparse matrix,
                    or general linear operator.
                    Warning: ARPACK can be unstable for some problems.  It is
                    best to try several random seeds in order to check results.

        dense  : use standard dense matrix operations for the eigenvalue
                    decomposition.  For this method, M must be an array
                    or matrix type.  This method should be avoided for
                    large problems.

    tol : float, default=1e-6
        Tolerance for 'arpack' method
        Not used if eigen_solver=='dense'.

    max_iter : int, default=100
        maximum number of iterations for the arpack solver.
        Not used if eigen_solver=='dense'.

    method : {'standard', 'hessian', 'modified', 'ltsa'}, default='standard'
        - `standard`: use the standard locally linear embedding algorithm. see
          reference [1]_
        - `hessian`: use the Hessian eigenmap method. This method requires
          ``n_neighbors &gt; n_components * (1 + (n_components + 1) / 2``. see
          reference [2]_
        - `modified`: use the modified locally linear embedding algorithm.
          see reference [3]_
        - `ltsa`: use local tangent space alignment algorithm. see
          reference [4]_

    hessian_tol : float, default=1e-4
        Tolerance for Hessian eigenmapping method.
        Only used if ``method == 'hessian'``

    modified_tol : float, default=1e-12
        Tolerance for modified LLE method.
        Only used if ``method == 'modified'``

    neighbors_algorithm : {'auto', 'brute', 'kd_tree', 'ball_tree'}, \
                          default='auto'
        algorithm to use for nearest neighbors search,
        passed to neighbors.NearestNeighbors instance

    random_state : int, RandomState instance, default=None
        Determines the random number generator when
        ``eigen_solver`` == 'arpack'. Pass an int for reproducible results
        across multiple function calls. See :term: `Glossary &lt;random_state&gt;`.

    n_jobs : int or None, default=None
        The number of parallel jobs to run.
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

    Attributes
    ----------
    embedding_ : array-like, shape [n_samples, n_components]
        Stores the embedding vectors

    reconstruction_error_ : float
        Reconstruction error associated with `embedding_`

    nbrs_ : NearestNeighbors object
        Stores nearest neighbors instance, including BallTree or KDtree
        if applicable.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.datasets import load_digits
    &gt;&gt;&gt; from sklearn.manifold import LocallyLinearEmbedding
    &gt;&gt;&gt; X, _ = load_digits(return_X_y=True)
    &gt;&gt;&gt; X.shape
    (1797, 64)
    &gt;&gt;&gt; embedding = LocallyLinearEmbedding(n_components=2)
    &gt;&gt;&gt; X_transformed = embedding.fit_transform(X[:100])
    &gt;&gt;&gt; X_transformed.shape
    (100, 2)

    References
    ----------

    .. [1] Roweis, S. & Saul, L. Nonlinear dimensionality reduction
        by locally linear embedding.  Science 290:2323 (2000).
    .. [2] Donoho, D. & Grimes, C. Hessian eigenmaps: Locally
        linear embedding techniques for high-dimensional data.
        Proc Natl Acad Sci U S A.  100:5591 (2003).
    .. [3] Zhang, Z. & Wang, J. MLLE: Modified Locally Linear
        Embedding Using Multiple Weights.
        http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.70.382
    .. [4] Zhang, Z. & Zha, H. Principal manifolds and nonlinear
        dimensionality reduction via tangent space alignment.
        Journal of Shanghai Univ.  8:406 (2004)
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="arithmetic-assignment">=</span><span class="float-literal">1E-3</span><span class="punctuation">,</span>
                 <span class="identifier">eigen_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1E-6</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span>
                 <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'standard'</span><span class="punctuation">,</span> <span class="identifier">hessian_tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1E-4</span><span class="punctuation">,</span> <span class="identifier">modified_tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1E-12</span><span class="punctuation">,</span>
                 <span class="identifier">neighbors_algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_neighbors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_neighbors</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_components</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">eigen_solver</span> <span class="arithmetic-assignment">=</span> <span class="identifier">eigen_solver</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tol</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_iter</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">method</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">hessian_tol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hessian_tol</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">modified_tol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">modified_tol</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">neighbors_algorithm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors_algorithm</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_jobs</span>

    <span class="keyword">def</span> <span class="identifier">_fit_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">nbrs_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                      <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">neighbors_algorithm</span><span class="punctuation">,</span>
                                      <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span><span class="grouping">)</span>

        <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">float</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">nbrs_</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">embedding_</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">reconstruction_error_</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
            <span class="identifier">locally_linear_embedding</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">nbrs_</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                <span class="identifier">eigen_solver</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">eigen_solver</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span>
                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">method</span><span class="punctuation">,</span>
                <span class="identifier">hessian_tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">hessian_tol</span><span class="punctuation">,</span> <span class="identifier">modified_tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">modified_tol</span><span class="punctuation">,</span>
                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">reg</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the embedding vectors for data X

        Parameters
        ----------
        X : array-like of shape [n_samples, n_features]
            training set.

        y : Ignored

        Returns
        -------
        self : returns an instance of self.
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the embedding vectors for data X and transform X.

        Parameters
        ----------
        X : array-like of shape [n_samples, n_features]
            training set.

        y : Ignored

        Returns
        -------
        X_new : array-like, shape (n_samples, n_components)
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">embedding_</span>

    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        Transform new points into embedding space.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)

        Returns
        -------
        X_new : array, shape = [n_samples, n_components]

        Notes
        -----
        Because of scaling performed by this method, it is discouraged to use
        it together with methods that are not scale-invariant (like SVMs)
        """</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">nbrs_</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                    <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">barycenter_weights</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">nbrs_</span><span class="punctuation">.</span><span class="identifier">_fit_X</span><span class="punctuation">,</span> <span class="identifier">ind</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">reg</span><span class="grouping">)</span>
        <span class="identifier">X_new</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X_new</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">embedding_</span><span class="grouping">[</span><span class="identifier">ind</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">X_new</span>

    </pre>
  </body>
</html>