<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Author: Wei Xue &lt;xuewei4d@gmail.com&gt;</span>
<span class="comment">#         Thierry Guillemot &lt;thierry.guillemot.work@gmail.com&gt;</span>
<span class="comment"># License: BSD 3 clause</span>
<span class="keyword">import</span> <span class="identifier">copy</span>
<span class="keyword">import</span> <span class="identifier">re</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">special</span> <span class="keyword">import</span> <span class="identifier">gammaln</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">adjusted_rand_score</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">mixture</span><span class="punctuation">.</span><span class="identifier">_bayesian_mixture</span> <span class="keyword">import</span> <span class="identifier">_log_dirichlet_norm</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">mixture</span><span class="punctuation">.</span><span class="identifier">_bayesian_mixture</span> <span class="keyword">import</span> <span class="identifier">_log_wishart_norm</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">mixture</span> <span class="keyword">import</span> <span class="identifier">BayesianGaussianMixture</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">mixture</span><span class="punctuation">.</span><span class="identifier">tests</span><span class="punctuation">.</span><span class="identifier">test_gaussian_mixture</span> <span class="keyword">import</span> <span class="identifier">RandomData</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span><span class="punctuation">,</span> <span class="identifier">NotFittedError</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>


<span class="identifier">COVARIANCE_TYPE</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'full', 'tied', 'diag', 'spherical'</span><span class="grouping">]</span>
<span class="identifier">PRIOR_TYPE</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'dirichlet_process', 'dirichlet_distribution'</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_log_dirichlet_norm</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">weight_concentration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">expected_norm</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">gammaln</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">weight_concentration</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
                     <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">gammaln</span><span class="grouping">(</span><span class="identifier">weight_concentration</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">predected_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_log_dirichlet_norm</span><span class="grouping">(</span><span class="identifier">weight_concentration</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_norm</span><span class="punctuation">,</span> <span class="identifier">predected_norm</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_log_wishart_norm</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">degrees_of_freedom</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">.</span>
    <span class="identifier">log_det_precisions_chol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">expected_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">degrees_of_freedom_k</span><span class="punctuation">,</span> <span class="identifier">log_det_k</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span>
            <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">degrees_of_freedom</span><span class="punctuation">,</span> <span class="identifier">log_det_precisions_chol</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">expected_norm</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="grouping">(</span>
            <span class="identifier">degrees_of_freedom_k</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">log_det_k</span> <span class="arithmetic-operator">+</span> <span class="float-literal">.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">gammaln</span><span class="grouping">(</span><span class="float-literal">.5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">degrees_of_freedom_k</span> <span class="arithmetic-operator">-</span>
                                 <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">predected_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_log_wishart_norm</span><span class="grouping">(</span><span class="identifier">degrees_of_freedom</span><span class="punctuation">,</span>
                                       <span class="identifier">log_det_precisions_chol</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_norm</span><span class="punctuation">,</span> <span class="identifier">predected_norm</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_mixture_covariance_type</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">covariance_type</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'bad_covariance_type'</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covariance_type</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Invalid value for 'covariance_type': {covariance_type} "</span>
        <span class="string-literal">"'covariance_type' should be in ['spherical', 'tied', 'diag', 'full']"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_mixture_weight_concentration_prior_type</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">bad_prior_type</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'bad_prior_type'</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
        <span class="identifier">weight_concentration_prior_type</span><span class="arithmetic-assignment">=</span><span class="identifier">bad_prior_type</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"Invalid value for 'weight_concentration_prior_type':"</span>
        <span class="identifier">f</span><span class="string-literal">" {bad_prior_type} 'weight_concentration_prior_type' should be in "</span>
        <span class="string-literal">"['dirichlet_process', 'dirichlet_distribution']"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_mixture_weights_prior_initialisation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="comment"># Check raise message for a bad value of weight_concentration_prior</span>
    <span class="identifier">bad_weight_concentration_prior_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
        <span class="identifier">weight_concentration_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">bad_weight_concentration_prior_</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"The parameter 'weight_concentration_prior' should be greater "</span>
        <span class="identifier">f</span><span class="string-literal">"than 0., but got {bad_weight_concentration_prior_:.3f}."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Check correct init for a given value of weight_concentration_prior</span>
    <span class="identifier">weight_concentration_prior</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
        <span class="identifier">weight_concentration_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">weight_concentration_prior</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">weight_concentration_prior</span><span class="punctuation">,</span>
                        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">weight_concentration_prior_</span><span class="grouping">)</span>

    <span class="comment"># Check correct init for the default value of weight_concentration_prior</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">weight_concentration_prior_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_mixture_mean_prior_initialisation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="comment"># Check raise message for a bad value of mean_precision_prior</span>
    <span class="identifier">bad_mean_precision_prior_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
        <span class="identifier">mean_precision_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">bad_mean_precision_prior_</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"The parameter 'mean_precision_prior' "</span>
        <span class="identifier">f</span><span class="string-literal">"should be greater than 0., but got {bad_mean_precision_prior_:.3f}."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Check correct init for a given value of mean_precision_prior</span>
    <span class="identifier">mean_precision_prior</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
        <span class="identifier">mean_precision_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">mean_precision_prior</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">mean_precision_prior</span><span class="punctuation">,</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">mean_precision_prior_</span><span class="grouping">)</span>

    <span class="comment"># Check correct init for the default value of mean_precision_prior</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">mean_precision_prior_</span><span class="grouping">)</span>

    <span class="comment"># Check raise message for a bad shape of mean_prior</span>
    <span class="identifier">mean_prior</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                   <span class="identifier">mean_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">mean_prior</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"The parameter 'means' should have the shape of "</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Check correct init for a given value of mean_prior</span>
    <span class="identifier">mean_prior</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                   <span class="identifier">mean_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">mean_prior</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">mean_prior</span><span class="punctuation">,</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">mean_prior_</span><span class="grouping">)</span>

    <span class="comment"># Check correct init for the default value of bemean_priorta</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">mean_prior_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_mixture_precisions_prior_initialisation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="comment"># Check raise message for a bad value of degrees_of_freedom_prior</span>
    <span class="identifier">bad_degrees_of_freedom_prior_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">.</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
        <span class="identifier">degrees_of_freedom_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">bad_degrees_of_freedom_prior_</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"The parameter 'degrees_of_freedom_prior' should be greater than"</span>
        <span class="identifier">f</span><span class="string-literal">" {n_features -1}, but got {bad_degrees_of_freedom_prior_:.3f}."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Check correct init for a given value of degrees_of_freedom_prior</span>
    <span class="identifier">degrees_of_freedom_prior</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">.</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
        <span class="identifier">degrees_of_freedom_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">degrees_of_freedom_prior</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">degrees_of_freedom_prior</span><span class="punctuation">,</span>
                        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">degrees_of_freedom_prior_</span><span class="grouping">)</span>

    <span class="comment"># Check correct init for the default value of degrees_of_freedom_prior</span>
    <span class="identifier">degrees_of_freedom_prior_default</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_features</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
        <span class="identifier">degrees_of_freedom_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">degrees_of_freedom_prior_default</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">degrees_of_freedom_prior_default</span><span class="punctuation">,</span>
                        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">degrees_of_freedom_prior_</span><span class="grouping">)</span>

    <span class="comment"># Check correct init for a given value of covariance_prior</span>
    <span class="identifier">covariance_prior</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'full'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">bias</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">10</span><span class="punctuation">,</span>
        <span class="string-literal">'tied'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">bias</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">5</span><span class="punctuation">,</span>
        <span class="string-literal">'diag'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">atleast_2d</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">bias</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">3</span><span class="punctuation">,</span>
        <span class="string-literal">'spherical'</span><span class="punctuation">:</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span>

    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">cov_type</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'full', 'tied', 'diag', 'spherical'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariance_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cov_type</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariance_prior</span> <span class="arithmetic-assignment">=</span> <span class="identifier">covariance_prior</span><span class="grouping">[</span><span class="identifier">cov_type</span><span class="grouping">]</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">covariance_prior</span><span class="grouping">[</span><span class="identifier">cov_type</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariance_prior_</span><span class="grouping">)</span>

    <span class="comment"># Check raise message for a bad spherical value of covariance_prior</span>
    <span class="identifier">bad_covariance_prior_</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="string-literal">'spherical'</span><span class="punctuation">,</span>
                                   <span class="identifier">covariance_prior</span><span class="arithmetic-assignment">=</span><span class="identifier">bad_covariance_prior_</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"The parameter 'spherical covariance_prior' "</span>
        <span class="identifier">f</span><span class="string-literal">"should be greater than 0., but got {bad_covariance_prior_:.3f}."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Check correct init for the default value of covariance_prior</span>
    <span class="identifier">covariance_prior_default</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'full'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">atleast_2d</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'tied'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">atleast_2d</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'diag'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">ddof</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'spherical'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">ddof</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span>

    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">cov_type</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'full', 'tied', 'diag', 'spherical'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariance_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cov_type</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">covariance_prior_default</span><span class="grouping">[</span><span class="identifier">cov_type</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariance_prior_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_mixture_check_is_fitted</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span>

    <span class="comment"># Check raise message</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"This BayesianGaussianMixture instance is not fitted yet."</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_mixture_weights</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="comment"># Case Dirichlet distribution for the weight concentration prior type</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
        <span class="identifier">weight_concentration_prior_type</span><span class="arithmetic-assignment">=</span><span class="string-literal">"dirichlet_distribution"</span><span class="punctuation">,</span>
        <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">expected_weights</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">weight_concentration_</span> <span class="arithmetic-operator">/</span>
                        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">weight_concentration_</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_weights</span><span class="punctuation">,</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">weights_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">weights_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span>

    <span class="comment"># Case Dirichlet process for the weight concentration prior type</span>
    <span class="identifier">dpgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
        <span class="identifier">weight_concentration_prior_type</span><span class="arithmetic-assignment">=</span><span class="string-literal">"dirichlet_process"</span><span class="punctuation">,</span>
        <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">weight_dirichlet_sum</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">dpgmm</span><span class="punctuation">.</span><span class="identifier">weight_concentration_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span>
                            <span class="identifier">dpgmm</span><span class="punctuation">.</span><span class="identifier">weight_concentration_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">tmp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dpgmm</span><span class="punctuation">.</span><span class="identifier">weight_concentration_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">weight_dirichlet_sum</span>
    <span class="identifier">expected_weights</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">dpgmm</span><span class="punctuation">.</span><span class="identifier">weight_concentration_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">weight_dirichlet_sum</span> <span class="arithmetic-operator">*</span>
                        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cumprod</span><span class="grouping">(</span><span class="identifier">tmp</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">expected_weights</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">expected_weights</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_weights</span><span class="punctuation">,</span> <span class="identifier">dpgmm</span><span class="punctuation">.</span><span class="identifier">weights_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">dpgmm</span><span class="punctuation">.</span><span class="identifier">weights_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_monotonic_likelihood</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># We check that each step of the each step of variational inference without</span>
    <span class="comment"># regularization improve monotonically the training set of the bound</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>

    <span class="keyword">for</span> <span class="identifier">prior_type</span> <span class="relational-operator">in</span> <span class="identifier">PRIOR_TYPE</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
            <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
                <span class="identifier">weight_concentration_prior_type</span><span class="arithmetic-assignment">=</span><span class="identifier">prior_type</span><span class="punctuation">,</span>
                <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="punctuation">,</span>
                <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>
            <span class="identifier">current_lower_bound</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">infty</span>
            <span class="comment"># Do one training iteration at a time so we can make sure that the</span>
            <span class="comment"># training log likelihood increases after each iteration.</span>
            <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">600</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">prev_lower_bound</span> <span class="arithmetic-assignment">=</span> <span class="identifier">current_lower_bound</span>
                <span class="identifier">current_lower_bound</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower_bound_</span>
                <span class="keyword">assert</span> <span class="identifier">current_lower_bound</span> <span class="relational-operator">&gt;=</span> <span class="identifier">prev_lower_bound</span>

                <span class="keyword">if</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">converged_</span><span class="punctuation">:</span>
                    <span class="keyword">break</span>
            <span class="keyword">assert</span><span class="grouping">(</span><span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">converged_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_compare_covar_type</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># We can compare the 'full' precision with the other cov_type if we apply</span>
    <span class="comment"># 1 iter of the M-step (done during _initialize_parameters).</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="string-literal">'full'</span><span class="grouping">]</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>

    <span class="keyword">for</span> <span class="identifier">prior_type</span> <span class="relational-operator">in</span> <span class="identifier">PRIOR_TYPE</span><span class="punctuation">:</span>
        <span class="comment"># Computation of the full_covariance</span>
        <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
            <span class="identifier">weight_concentration_prior_type</span><span class="arithmetic-assignment">=</span><span class="identifier">prior_type</span><span class="punctuation">,</span>
            <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="string-literal">'full'</span><span class="punctuation">,</span>
            <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="grouping">)</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">_check_initial_parameters</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">_initialize_parameters</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">full_covariances</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
            <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span> <span class="arithmetic-operator">*</span>
            <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">degrees_of_freedom_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Check tied_covariance = mean(full_covariances, 0)</span>
        <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
            <span class="identifier">weight_concentration_prior_type</span><span class="arithmetic-assignment">=</span><span class="identifier">prior_type</span><span class="punctuation">,</span>
            <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="string-literal">'tied'</span><span class="punctuation">,</span>
            <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="grouping">)</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">_check_initial_parameters</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">_initialize_parameters</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">tied_covariance</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span> <span class="arithmetic-operator">*</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">degrees_of_freedom_</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">tied_covariance</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">full_covariances</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Check diag_covariance = diag(full_covariances)</span>
        <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
            <span class="identifier">weight_concentration_prior_type</span><span class="arithmetic-assignment">=</span><span class="identifier">prior_type</span><span class="punctuation">,</span>
            <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="string-literal">'diag'</span><span class="punctuation">,</span>
            <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="grouping">)</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">_check_initial_parameters</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">_initialize_parameters</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">diag_covariances</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span> <span class="arithmetic-operator">*</span>
                            <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">degrees_of_freedom_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">diag_covariances</span><span class="punctuation">,</span>
                            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">cov</span><span class="grouping">)</span>
                                     <span class="keyword">for</span> <span class="identifier">cov</span> <span class="relational-operator">in</span> <span class="identifier">full_covariances</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Check spherical_covariance = np.mean(diag_covariances, 0)</span>
        <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
            <span class="identifier">weight_concentration_prior_type</span><span class="arithmetic-assignment">=</span><span class="identifier">prior_type</span><span class="punctuation">,</span>
            <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="string-literal">'spherical'</span><span class="punctuation">,</span>
            <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="grouping">)</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">_check_initial_parameters</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">_initialize_parameters</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">spherical_covariances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span> <span class="arithmetic-operator">*</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">degrees_of_freedom_</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
            <span class="identifier">spherical_covariances</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">diag_covariances</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_check_covariance_precision</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># We check that the dot product of the covariance and the precision</span>
    <span class="comment"># matrices is identity.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="int-literal">2</span>

    <span class="comment"># Computation of the full_covariance</span>
    <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                   <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span>
                                   <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariance_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">covar_type</span>
        <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'full'</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">covar</span><span class="punctuation">,</span> <span class="identifier">precision</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="punctuation">,</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">covar</span><span class="punctuation">,</span> <span class="identifier">precision</span><span class="grouping">)</span><span class="punctuation">,</span>
                                    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'tied'</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="punctuation">,</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">elif</span> <span class="identifier">covar_type</span> <span class="relational-operator">==</span> <span class="string-literal">'diag'</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span> <span class="arithmetic-operator">*</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="punctuation">,</span>
                                <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">covariances_</span> <span class="arithmetic-operator">*</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">precisions_</span><span class="punctuation">,</span>
                                <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_invariant_translation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># We check here that adding a constant in the data change correctly the</span>
    <span class="comment"># parameters of the mixture</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>

    <span class="keyword">for</span> <span class="identifier">prior_type</span> <span class="relational-operator">in</span> <span class="identifier">PRIOR_TYPE</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
            <span class="identifier">bgmm1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
                <span class="identifier">weight_concentration_prior_type</span><span class="arithmetic-assignment">=</span><span class="identifier">prior_type</span><span class="punctuation">,</span>
                <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">bgmm2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
                <span class="identifier">weight_concentration_prior_type</span><span class="arithmetic-assignment">=</span><span class="identifier">prior_type</span><span class="punctuation">,</span>
                <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">+</span> <span class="int-literal">100</span><span class="grouping">)</span>

            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bgmm1</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="punctuation">,</span> <span class="identifier">bgmm2</span><span class="punctuation">.</span><span class="identifier">means_</span> <span class="arithmetic-operator">-</span> <span class="int-literal">100</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bgmm1</span><span class="punctuation">.</span><span class="identifier">weights_</span><span class="punctuation">,</span> <span class="identifier">bgmm2</span><span class="punctuation">.</span><span class="identifier">weights_</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bgmm1</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="punctuation">,</span> <span class="identifier">bgmm2</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore:.*did not converge.*"</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'seed, max_iter, tol'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span>    <span class="comment"># strict non-convergence</span>
    <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">)</span><span class="punctuation">,</span>    <span class="comment"># loose non-convergence</span>
    <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">300</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># strict convergence</span>
    <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">300</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># loose convergence</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_bayesian_mixture_fit_predict</span><span class="grouping">(</span><span class="identifier">seed</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span>

    <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
        <span class="identifier">bgmm1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                        <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                                        <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">reg_covar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">bgmm1</span><span class="punctuation">.</span><span class="identifier">covariance_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">covar_type</span>
        <span class="identifier">bgmm2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">copy</span><span class="punctuation">.</span><span class="identifier">deepcopy</span><span class="grouping">(</span><span class="identifier">bgmm1</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>

        <span class="identifier">Y_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bgmm1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">Y_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bgmm2</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Y_pred1</span><span class="punctuation">,</span> <span class="identifier">Y_pred2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_mixture_fit_predict_n_init</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that fit_predict is equivalent to fit.predict, when n_init &gt; 1</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">gm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gm</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">y_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gm</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred1</span><span class="punctuation">,</span> <span class="identifier">y_pred2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_mixture_predict_predict_proba</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># this is the same test as test_gaussian_mixture_predict_predict_proba()</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">rand_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomData</span><span class="grouping">(</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">prior_type</span> <span class="relational-operator">in</span> <span class="identifier">PRIOR_TYPE</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">covar_type</span> <span class="relational-operator">in</span> <span class="identifier">COVARIANCE_TYPE</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">covar_type</span><span class="grouping">]</span>
            <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">Y</span>
            <span class="identifier">bgmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianGaussianMixture</span><span class="grouping">(</span>
                <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">rand_data</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                <span class="identifier">weight_concentration_prior_type</span><span class="arithmetic-assignment">=</span><span class="identifier">prior_type</span><span class="punctuation">,</span>
                <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">covar_type</span><span class="grouping">)</span>

            <span class="comment"># Check a warning message arrive if we don't do fit</span>
            <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                <span class="string-literal">"This BayesianGaussianMixture instance is not fitted yet. "</span>
                <span class="string-literal">"Call 'fit' with appropriate arguments before using this "</span>
                <span class="string-literal">"estimator."</span>
            <span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

            <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">Y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">Y_pred_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bgmm</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Y_pred</span><span class="punctuation">,</span> <span class="identifier">Y_pred_proba</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">adjusted_rand_score</span><span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">Y_pred</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="float-literal">.95</span>

    </pre>
  </body>
</html>