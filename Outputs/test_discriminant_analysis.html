<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">linalg</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_blobs</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">discriminant_analysis</span> <span class="keyword">import</span> <span class="identifier">LinearDiscriminantAnalysis</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">discriminant_analysis</span> <span class="keyword">import</span> <span class="identifier">QuadraticDiscriminantAnalysis</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">discriminant_analysis</span> <span class="keyword">import</span> <span class="identifier">_cov</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">covariance</span> <span class="keyword">import</span> <span class="identifier">ledoit_wolf</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">KMeans</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">covariance</span> <span class="keyword">import</span> <span class="identifier">ShrunkCovariance</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">covariance</span> <span class="keyword">import</span> <span class="identifier">LedoitWolf</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">StandardScaler</span>

<span class="comment"># Data is just 6 separable points in the plane</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'f'</span><span class="grouping">)</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">y3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="comment"># Degenerate data with only one feature (still should be separable)</span>
<span class="identifier">X1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'f'</span><span class="grouping">)</span>

<span class="comment"># Data is just 9 separable points in the plane</span>
<span class="identifier">X6</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">y6</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">y7</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="comment"># Degenerate data with 1 feature (still should be separable)</span>
<span class="identifier">X7</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="comment"># Data that has zero variance in one dimension and needs regularization</span>
<span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="comment"># One element class</span>
<span class="identifier">y4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="comment"># Data with less samples in a class than n_features</span>
<span class="identifier">X5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="identifier">y5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="identifier">solver_shrinkage</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'svd', None), ('lsqr', None), ('eigen'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">(</span><span class="string-literal">'lsqr', 'auto'), ('lsqr', 0), ('lsqr'</span><span class="punctuation">,</span> <span class="float-literal">0.43</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">(</span><span class="string-literal">'eigen', 'auto'), ('eigen', 0), ('eigen'</span><span class="punctuation">,</span> <span class="float-literal">0.43</span><span class="grouping">)</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_lda_predict</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA classification.</span>
    <span class="comment"># This checks that LDA implements fit and predict and returns correct</span>
    <span class="comment"># values for simple toy data.</span>
    <span class="keyword">for</span> <span class="identifier">test_case</span> <span class="relational-operator">in</span> <span class="identifier">solver_shrinkage</span><span class="punctuation">:</span>
        <span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span> <span class="arithmetic-assignment">=</span> <span class="identifier">test_case</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="identifier">shrinkage</span><span class="grouping">)</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="string-literal">'solver %s'</span> <span class="arithmetic-operator">%</span> <span class="identifier">solver</span><span class="grouping">)</span>

        <span class="comment"># Assert that it works with 1D data</span>
        <span class="identifier">y_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred1</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="string-literal">'solver %s'</span> <span class="arithmetic-operator">%</span> <span class="identifier">solver</span><span class="grouping">)</span>

        <span class="comment"># Test probability estimates</span>
        <span class="identifier">y_proba_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y_proba_pred1</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.5</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                           <span class="string-literal">'solver %s'</span> <span class="arithmetic-operator">%</span> <span class="identifier">solver</span><span class="grouping">)</span>
        <span class="identifier">y_log_proba_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">y_log_proba_pred1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_proba_pred1</span><span class="punctuation">,</span>
                        <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">'solver %s'</span> <span class="arithmetic-operator">%</span> <span class="identifier">solver</span><span class="grouping">)</span>

        <span class="comment"># Primarily test for commit 2f34950 -- "reuse" of priors</span>
        <span class="identifier">y_pred3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y3</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="comment"># LDA shouldn't be able to separate those</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">y_pred3</span> <span class="relational-operator">!=</span> <span class="identifier">y3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'solver %s'</span> <span class="arithmetic-operator">%</span> <span class="identifier">solver</span>

    <span class="comment"># Test invalid shrinkages</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lsqr"</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="float-literal">-0.2231</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"eigen", shrinkage="dummy"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"svd", shrinkage="auto"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotImplementedError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lsqr"</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"shrinkage must be a float or a string"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lsqr"</span><span class="punctuation">,</span>
                                     <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span>
                                     <span class="identifier">covariance_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">ShrunkCovariance</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">"covariance_estimator and shrinkage "</span>
                              <span class="string-literal">"parameters are not None. "</span>
                              <span class="string-literal">"Only one of the two can be set."</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Test unknown solver</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"dummy"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># test bad solver with covariance_estimator</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"svd"</span><span class="punctuation">,</span>
                                     <span class="identifier">covariance_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">LedoitWolf</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"covariance estimator is not supported with svd"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># test bad covariance estimator</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lsqr"</span><span class="punctuation">,</span>
                                     <span class="identifier">covariance_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">KMeans</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"KMeans does not have a covariance_ attribute"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"n_classes"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"solver", ["svd", "lsqr", "eigen"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lda_predict_proba</span><span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">generate_dataset</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="punctuation">,</span> <span class="identifier">covariances</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Generate a multivariate normal data given some centers and
        covariances"""</span>
        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">multivariate_normal</span><span class="grouping">(</span><span class="identifier">mean</span><span class="punctuation">,</span> <span class="identifier">cov</span><span class="punctuation">,</span>
                                               <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">//</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">centers</span><span class="grouping">)</span><span class="grouping">)</span>
                       <span class="keyword">for</span> <span class="identifier">mean</span><span class="punctuation">,</span> <span class="identifier">cov</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">centers</span><span class="punctuation">,</span> <span class="identifier">covariances</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">clazz</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">//</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">centers</span><span class="grouping">)</span><span class="grouping">)</span>
                       <span class="keyword">for</span> <span class="identifier">clazz</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">centers</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span>

    <span class="identifier">blob_centers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">40</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_classes</span><span class="grouping">]</span>
    <span class="identifier">blob_stds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">blob_centers</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generate_dataset</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">90000</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="identifier">blob_centers</span><span class="punctuation">,</span> <span class="identifier">covariances</span><span class="arithmetic-assignment">=</span><span class="identifier">blob_stds</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span>
    <span class="grouping">)</span>
    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">store_covariance</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                     <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># check that the empirical means and covariances are close enough to the</span>
    <span class="comment"># one used to generate the data</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="punctuation">,</span> <span class="identifier">blob_centers</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">blob_stds</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># implement the method to compute the probability given in The Elements</span>
    <span class="comment"># of Statistical Learning (cf. p.127, Sect. 4.4.5 "Logistic Regression</span>
    <span class="comment"># or LDA?")</span>
    <span class="identifier">precision</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">blob_stds</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">alpha_k</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="identifier">alpha_k_0</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">clazz</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">blob_centers</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">alpha_k</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">precision</span><span class="punctuation">,</span>
                   <span class="grouping">(</span><span class="identifier">blob_centers</span><span class="grouping">[</span><span class="identifier">clazz</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">blob_centers</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">alpha_k_0</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="arithmetic-operator">-</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">blob_centers</span><span class="grouping">[</span><span class="identifier">clazz</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span>
                            <span class="identifier">blob_centers</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">alpha_k</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">sample</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">22</span><span class="punctuation">,</span> <span class="int-literal">22</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">discriminant_func</span><span class="grouping">(</span><span class="identifier">sample</span><span class="punctuation">,</span> <span class="identifier">coef</span><span class="punctuation">,</span> <span class="identifier">intercept</span><span class="punctuation">,</span> <span class="identifier">clazz</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">intercept</span><span class="grouping">[</span><span class="identifier">clazz</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">sample</span><span class="punctuation">,</span> <span class="identifier">coef</span><span class="grouping">[</span><span class="identifier">clazz</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">float</span><span class="grouping">(</span>
        <span class="identifier">discriminant_func</span><span class="grouping">(</span><span class="identifier">sample</span><span class="punctuation">,</span> <span class="identifier">alpha_k</span><span class="punctuation">,</span> <span class="identifier">alpha_k_0</span><span class="punctuation">,</span> <span class="identifier">clazz</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span>
        <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">discriminant_func</span><span class="grouping">(</span><span class="identifier">sample</span><span class="punctuation">,</span> <span class="identifier">alpha_k</span><span class="punctuation">,</span> <span class="identifier">alpha_k_0</span><span class="punctuation">,</span> <span class="identifier">clazz</span><span class="grouping">)</span>
                  <span class="keyword">for</span> <span class="identifier">clazz</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">clazz</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span>
                      <span class="identifier">n_classes</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">prob_ref</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">prob</span><span class="grouping">)</span>

    <span class="comment"># check the consistency of the computed probability</span>
    <span class="comment"># all probabilities should sum to one</span>
    <span class="identifier">prob_ref_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span>
        <span class="int-literal">1</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">discriminant_func</span><span class="grouping">(</span><span class="identifier">sample</span><span class="punctuation">,</span> <span class="identifier">alpha_k</span><span class="punctuation">,</span> <span class="identifier">alpha_k_0</span><span class="punctuation">,</span> <span class="identifier">clazz</span><span class="grouping">)</span>
                      <span class="keyword">for</span> <span class="identifier">clazz</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">prob_ref</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">prob_ref_2</span><span class="grouping">)</span>
    <span class="comment"># check that the probability of LDA are close to the theoretical</span>
    <span class="comment"># probabilties</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">sample</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">prob</span><span class="punctuation">,</span> <span class="identifier">prob_ref</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_priors</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test priors (negative priors)</span>
    <span class="identifier">priors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">-0.5</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">priors</span><span class="arithmetic-assignment">=</span><span class="identifier">priors</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"priors must be non-negative"</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Test that priors passed as a list are correctly handled (run to see if</span>
    <span class="comment"># failure)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">priors</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Test that priors always sum to 1</span>
    <span class="identifier">priors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.6</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">prior_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.45</span><span class="punctuation">,</span> <span class="float-literal">0.55</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">priors</span><span class="arithmetic-assignment">=</span><span class="identifier">priors</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">priors_</span><span class="punctuation">,</span> <span class="identifier">prior_norm</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_coefs</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if the coefficients of the solvers are approximately the same.</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                      <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">11</span><span class="grouping">)</span>

    <span class="identifier">clf_lda_svd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"svd"</span><span class="grouping">)</span>
    <span class="identifier">clf_lda_lsqr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lsqr"</span><span class="grouping">)</span>
    <span class="identifier">clf_lda_eigen</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"eigen"</span><span class="grouping">)</span>

    <span class="identifier">clf_lda_svd</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">clf_lda_lsqr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">clf_lda_eigen</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf_lda_svd</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf_lda_lsqr</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf_lda_svd</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf_lda_eigen</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf_lda_eigen</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf_lda_lsqr</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_transform</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test LDA transform.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"svd"</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"eigen"</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lsqr"</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"transform not implemented for 'lsqr'"</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotImplementedError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_explained_variance_ratio</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if the sum of the normalized eigen vectors values equals 1,</span>
    <span class="comment"># Also tests whether the explained_variance_ratio_ formed by the</span>
    <span class="comment"># eigen solver is the same as the explained_variance_ratio_ formed</span>
    <span class="comment"># by the svd solver</span>

    <span class="identifier">state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">state</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">state</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">40</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">clf_lda_eigen</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"eigen"</span><span class="grouping">)</span>
    <span class="identifier">clf_lda_eigen</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf_lda_eigen</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf_lda_eigen</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
        <span class="string-literal">"Unexpected length for explained_variance_ratio_"</span><span class="grouping">)</span>

    <span class="identifier">clf_lda_svd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"svd"</span><span class="grouping">)</span>
    <span class="identifier">clf_lda_svd</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf_lda_svd</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf_lda_svd</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
        <span class="string-literal">"Unexpected length for explained_variance_ratio_"</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf_lda_svd</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="punctuation">,</span>
                              <span class="identifier">clf_lda_eigen</span><span class="punctuation">.</span><span class="identifier">explained_variance_ratio_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_orthogonality</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># arrange four classes with their means in a kite-shaped pattern</span>
    <span class="comment"># the longer distance should be transformed to the first component, and</span>
    <span class="comment"># the shorter distance to the second component.</span>
    <span class="identifier">means</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># We construct perfectly symmetric distributions, so the LDA can estimate</span>
    <span class="comment"># precise means.</span>
    <span class="identifier">scatter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-0.1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-0.1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-0.1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">means</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">scatter</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">means</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">scatter</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Fit LDA and transform the means</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"svd"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">means_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">means</span><span class="grouping">)</span>

    <span class="identifier">d1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">means_transformed</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">means_transformed</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">d2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">means_transformed</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">means_transformed</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">d1</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">d1</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">d2</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">d2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># the transformed within-class covariance should be the identity matrix</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">scatter</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># the means of classes 0 and 3 should lie on the first component</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">d1</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span>

    <span class="comment"># the means of classes 1 and 2 should lie on the second component</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">d2</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_scaling</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if classification works correctly with differently scaled features.</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">1234</span><span class="grouping">)</span>
    <span class="comment"># use uniform distribution of features to make sure there is absolutely no</span>
    <span class="comment"># overlap between classes.</span>
    <span class="identifier">x1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">x2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">x1</span><span class="punctuation">,</span> <span class="identifier">x2</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10000</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n</span>

    <span class="keyword">for</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'svd', 'lsqr', 'eigen'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="grouping">)</span>
        <span class="comment"># should be able to separate the data perfectly</span>
        <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="grouping">(</span>
            <span class="string-literal">'using covariance: %s'</span> <span class="arithmetic-operator">%</span> <span class="identifier">solver</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_store_covariance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test for solver 'lsqr' and 'eigen'</span>
    <span class="comment"># 'store_covariance' has no effect on 'lsqr' and 'eigen' solvers</span>
    <span class="keyword">for</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'lsqr', 'eigen'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X6</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'covariance_'</span><span class="grouping">)</span>

        <span class="comment"># Test the actual attribute:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                                         <span class="identifier">store_covariance</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X6</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'covariance_'</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
            <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="punctuation">,</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.422222</span><span class="punctuation">,</span> <span class="float-literal">0.088889</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.088889</span><span class="punctuation">,</span> <span class="float-literal">0.533333</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="grouping">)</span>

    <span class="comment"># Test for SVD solver, the default is to not set the covariances_ attribute</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'svd'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X6</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'covariance_'</span><span class="grouping">)</span>

    <span class="comment"># Test the actual attribute:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                                     <span class="identifier">store_covariance</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X6</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'covariance_'</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="punctuation">,</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.422222</span><span class="punctuation">,</span> <span class="float-literal">0.088889</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.088889</span><span class="punctuation">,</span> <span class="float-literal">0.533333</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'seed'</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lda_shrinkage</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that shrunk covariance estimator and shrinkage parameter behave the</span>
    <span class="comment"># same</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">c1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">store_covariance</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                                    <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lsqr"</span><span class="grouping">)</span>
    <span class="identifier">c2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span>
            <span class="identifier">store_covariance</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="identifier">covariance_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">ShrunkCovariance</span><span class="grouping">(</span><span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lsqr"</span><span class="grouping">)</span>
    <span class="identifier">c1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">c2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">c1</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="punctuation">,</span> <span class="identifier">c2</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">c1</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">c2</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_lda_ledoitwolf</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># When shrinkage="auto" current implementation uses ledoitwolf estimation</span>
    <span class="comment"># of covariance after standardizing the data. This checks that it is indeed</span>
    <span class="comment"># the case</span>
    <span class="keyword">class</span> <span class="identifier">StandardizedLedoitWolf</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">sc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># standardize features</span>
            <span class="identifier">X_sc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sc</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ledoit_wolf</span><span class="grouping">(</span><span class="identifier">X_sc</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="comment"># rescale</span>
            <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sc</span><span class="punctuation">.</span><span class="identifier">scale_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">s</span> <span class="arithmetic-operator">*</span> <span class="identifier">sc</span><span class="punctuation">.</span><span class="identifier">scale_</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">covariance_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">c1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span>
        <span class="identifier">store_covariance</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
        <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="string-literal">"auto"</span><span class="punctuation">,</span>
        <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lsqr"</span>
    <span class="grouping">)</span>
    <span class="identifier">c2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span>
        <span class="identifier">store_covariance</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
        <span class="identifier">covariance_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">StandardizedLedoitWolf</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lsqr"</span>
    <span class="grouping">)</span>
    <span class="identifier">c1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">c2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">c1</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="punctuation">,</span> <span class="identifier">c2</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">c1</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">c2</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_features'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_classes'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lda_dimension_warning</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="comment"># we create n_classes labels by repeating and truncating a</span>
    <span class="comment"># range(n_classes) until n_samples</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">//</span> <span class="identifier">n_classes</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="grouping">]</span>
    <span class="identifier">max_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_classes</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">n_components</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">max_components</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_components</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="comment"># if n_components &lt;= min(n_classes - 1, n_features), no warning</span>
        <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">n_components</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">max_components</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span>
                         <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_classes</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="comment"># if n_components &gt; min(n_classes - 1, n_features), raise error.</span>
        <span class="comment"># We test one unit higher than max_components, and then something</span>
        <span class="comment"># larger than both n_features and n_classes - 1 to ensure the test</span>
        <span class="comment"># works for any value of n_component</span>
        <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="grouping">)</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"n_components cannot be larger than "</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"data_type, expected_type"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_lda_dtype_match</span><span class="grouping">(</span><span class="identifier">data_type</span><span class="punctuation">,</span> <span class="identifier">expected_type</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">solver_shrinkage</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="identifier">shrinkage</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">data_type</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">data_type</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">expected_type</span>


<span class="keyword">def</span> <span class="identifier">test_lda_numeric_consistency_float32_float64</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">solver_shrinkage</span><span class="punctuation">:</span>
        <span class="identifier">clf_32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="identifier">shrinkage</span><span class="grouping">)</span>
        <span class="identifier">clf_32</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">clf_64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="identifier">shrinkage</span><span class="grouping">)</span>
        <span class="identifier">clf_64</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Check value consistency between types</span>
        <span class="identifier">rtol</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-6</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf_32</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf_64</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="identifier">rtol</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_qda</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># QDA classification.</span>
    <span class="comment"># This checks that QDA implements fit and predict and returns</span>
    <span class="comment"># correct values for a simple toy dataset.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuadraticDiscriminantAnalysis</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X6</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X6</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>

    <span class="comment"># Assure that it works with 1D data</span>
    <span class="identifier">y_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X7</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X7</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred1</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>

    <span class="comment"># Test probas estimates</span>
    <span class="identifier">y_proba_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X7</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y_proba_pred1</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.5</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>
    <span class="identifier">y_log_proba_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X7</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">y_log_proba_pred1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_proba_pred1</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span>

    <span class="identifier">y_pred3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X6</span><span class="punctuation">,</span> <span class="identifier">y7</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X6</span><span class="grouping">)</span>
    <span class="comment"># QDA shouldn't be able to separate those</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">y_pred3</span> <span class="relational-operator">!=</span> <span class="identifier">y7</span><span class="grouping">)</span>

    <span class="comment"># Classes should have at least 2 elements</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X6</span><span class="punctuation">,</span> <span class="identifier">y4</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_qda_priors</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuadraticDiscriminantAnalysis</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X6</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X6</span><span class="grouping">)</span>
    <span class="identifier">n_pos</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="identifier">neg</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-10</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuadraticDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">priors</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">neg</span><span class="punctuation">,</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">neg</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X6</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X6</span><span class="grouping">)</span>
    <span class="identifier">n_pos2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">n_pos2</span> <span class="relational-operator">&gt;</span> <span class="identifier">n_pos</span>


<span class="keyword">def</span> <span class="identifier">test_qda_store_covariance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># The default is to not set the covariances_ attribute</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuadraticDiscriminantAnalysis</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X6</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'covariance_'</span><span class="grouping">)</span>

    <span class="comment"># Test the actual attribute:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuadraticDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">store_covariance</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X6</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'covariance_'</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.7</span><span class="punctuation">,</span> <span class="float-literal">0.45</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.45</span><span class="punctuation">,</span> <span class="float-literal">0.7</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.33333333</span><span class="punctuation">,</span> <span class="float-literal">-0.33333333</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-0.33333333</span><span class="punctuation">,</span> <span class="float-literal">0.66666667</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_qda_regularization</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># The default is reg_param=0. and will cause issues when there is a</span>
    <span class="comment"># constant variable.</span>

    <span class="comment"># Fitting on data with constant variable triggers an UserWarning.</span>
    <span class="identifier">collinear_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Variables are collinear"</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuadraticDiscriminantAnalysis</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">collinear_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>

    <span class="comment"># XXX: RuntimeWarning is also raised at predict time because of divisions</span>
    <span class="comment"># by zero when the model is fit with a constant feature and without</span>
    <span class="comment"># regularization: should this be considered a bug? Either by the fit-time</span>
    <span class="comment"># message more informative, raising and exception instead of a warning in</span>
    <span class="comment"># this case or somehow changing predict to avoid division by zero.</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">RuntimeWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"divide by zero"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="relational-operator">!=</span> <span class="identifier">y6</span><span class="grouping">)</span>

    <span class="comment"># Adding a little regularization fixes the division by zero at predict</span>
    <span class="comment"># time. But UserWarning will persist at fit time.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuadraticDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">reg_param</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">collinear_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y6</span><span class="grouping">)</span>

    <span class="comment"># UserWarning should also be there for the n_samples_in_a_class &lt;</span>
    <span class="comment"># n_features case.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuadraticDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">reg_param</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">collinear_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X5</span><span class="punctuation">,</span> <span class="identifier">y5</span><span class="grouping">)</span>
    <span class="identifier">y_pred5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X5</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred5</span><span class="punctuation">,</span> <span class="identifier">y5</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_covariance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                      <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="comment"># make features correlated</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">c_e</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_cov</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="string-literal">'empirical'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">c_e</span><span class="punctuation">,</span> <span class="identifier">c_e</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="identifier">c_s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_cov</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="string-literal">'auto'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">c_s</span><span class="punctuation">,</span> <span class="identifier">c_s</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"solver"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'svd, lsqr', 'eigen'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_raises_value_error_on_same_number_of_classes_and_samples</span><span class="grouping">(</span><span class="identifier">solver</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Tests that if the number of samples equals the number
    of classes, a ValueError is raised.
    """</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.6</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"a", "b"</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"The number of samples must be more"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    </pre>
  </body>
</html>